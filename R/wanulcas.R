# WANULCAS MODULE ####################
#
# evapotranspiration:
# Protocol: SFTP | Host: sftp://hydras.ugent.be | Port: 2225 | Username: gleamuser | Password: GLEAM4#h-cel_924
#

# Crop Data
# https://dssat.net/
#
# Soil Data
# https://app.soilhive.ag/availability

# TO CHECK?:
#
# line 11613: W_V3Drain[Zone] =
# * missing 0
#


options("warnPartialMatchDollar" = TRUE)

library(lubridate)
library(openxlsx2)
library(yaml)
library(progress)
library(data.table)

source("utils.R")
source("wanulcas_rain.R")
source("wanulcas_lib.R")

outvars_df <- read.csv("output_vars.csv")
outvars_df[outvars_df$arr == "", "arr"] <- "single_df"


n_iteration <- 1
xls_input_file <- "Wanulcas.xlsm"
output_vars <- NULL

## RUN #####################
run_wanulcas <- function(n_iteration,
                         xls_input_file = "Wanulcas.xlsm",
                         output_vars = NULL) {

  
  print("Running WaNuLCAS")
  
  if (is.null(output_vars)) {
    output_vars <- default_output_vars
  }
  ov_df <- outvars_df[outvars_df$var %in% output_vars, ]
  output <- list()
  class(output) <- "wanulcas"
  
  
  for (v in names(wanulcas_arr_dim)) {
    assign(v, wanulcas_arr_dim[[v]])
  }
  
  arr_init <- get_wanulcas_def_arr()
  for (v in names(arr_init)) {
    assign(v, arr_init[[v]])
  }
  
  assign_vars <- function(var_list) {
    for (p in names(var_list)) {
      if (p == "single_vars") {
        vars <- var_list[[p]]
        for (v in names(vars)) {
          assign(v, vars[[v]], envir = parent.frame())
        }
      } else {
        df <- get(p)
        x_df <- var_list[[p]]
        vars <- setdiff(names(x_df), names(arr_init[[p]]))
        df[vars] <- x_df[vars]
        assign(p, df, envir = parent.frame())
      }
    }
  }
  
  pars <- get_wanulcas_def_inp()
  for (p in pars) {
    assign_vars(p)
  }
  
  assign_vars(get_wanulcas_stock_vars())
  
  angle_df$TanAngles <- tan(angle_df$LightAngles * pi / 180)
  
  
  ### XLS Input Data #############
  
  xls_pars <- get_xls_params(xls_input_file)
  for (p in names(xls_pars)) {
    assign(p, xls_pars[[p]])
  }
  
  AF_Circ <- AF_System_par$`Parkland?`
  AF_ZoneTot <- AF_System_par$AFTotZn
  
  zw <- unlist(AF_System_par[c("AFZn1", "AFZn2", "AFZn3")])
  zone_df$AF_ZoneWidth <- c(zw, AF_ZoneTot - sum(zw))
  zone_df$AF_SlopeSurfInit <- AF_SlopeSurfInit
  zone_df$AF_ZWcum <- cumsum(zone_df$AF_ZoneWidth)
  
  if (AF_Circ == 0) {
    zone_df$AF_ZoneFrac <- zone_df$AF_ZoneWidth / AF_ZoneTot
  } else {
    zone_df$AF_ZWcum_0 <- c(0, head(zone_df$AF_ZWcum, -1))
    zone_df$AF_ZoneFrac <- (zone_df$AF_ZWcum^2 -  zone_df$AF_ZWcum_0^2) / AF_ZoneTot^2
  }
  
  # AF_DepthLay1 = AF_System[SL1]
  # AF_DepthLay2 = AF_System[SL2]
  # AF_DepthLay3 = AF_System[SL3]
  # AF_DepthLay4 = AF_System[SL1]
  layer_df$AF_DepthLay <- unlist(AF_System_par[c("SL1", "SL2", "SL3", "SL4")])
  # AF_TreePosit[Sp1] = AF_System[TSp1]
  # AF_TreePosit[Sp2] = AF_System[TSp2]
  # AF_TreePosit[Sp3] = AF_System[TSp3]
  tree_df$AF_TreePosit <- unlist(AF_System_par[c("TSp1", "TSp2", "TSp3")])
  # T_RelPosinZone[Sp1] = AF_System[TRelSp1]
  # T_RelPosinZone[Sp2] = AF_System[TRelSp2]
  # T_RelPosinZone[Sp3] = AF_System[TRelSp3]
  tree_df$T_RelPosinZone <- unlist(AF_System_par[c("TRelSp1", "TRelSp2", "TRelSp3")])
  # T_TreesperHa[Sp1] = AF_System[TDensSp1]
  # T_TreesperHa[Sp2] = AF_System[TDensSp2]
  # T_TreesperHa[Sp3] = AF_System[TDensSp3]
  tree_df$T_Treesperha <- unlist(AF_System_par[c("TDensSp1", "TDensSp2", "TDensSp3")])
  
  zone_df$RT_ZoneRight <- ifelse(zone_df$AF_ZoneWidth > 0, zone_df$AF_ZWcum, 0)
  zone_df$RT_ZoneLeft <- ifelse(zone_df$AF_ZoneWidth > 0, c(0, head(zone_df$AF_ZWcum, -1)), 0)
  
  
  CQ_var_par <- CQ_df$CQ_var[nzchar(CQ_df$CQ_var)]
  
  update_CQ_par <- function() {
    zone_df[CQ_var_par] <<- t(CQ_df[CQ_df$CQ_var %in% CQ_var_par, zone_df$CQ_CType])
    
    zonenut_df$CQ_NConcYoungCurr <<-
      unlist(c(CQ_df[CQ_df$CQ_Unit == "ConcYN", zone_df$CQ_CType], CQ_df[CQ_df$CQ_Unit == "ConcYP", zone_df$CQ_CType]))
    
    zonenut_df$CQ_NConcOldCurr <<-
      unlist(c(CQ_df[CQ_df$CQ_Unit == "ConcOldN", zone_df$CQ_CType], CQ_df[CQ_df$CQ_Unit == "ConcOldP", zone_df$CQ_CType]))
    
    zonenut_df$N_CNutMob <<-
      unlist(c(CQ_df[CQ_df$CQ_Unit == "NutMobN", zone_df$CQ_CType], CQ_df[CQ_df$CQ_Unit == "NutMobP", zone_df$CQ_CType]))
    
    zoneanimal_df$PD_CropsEaten_is <<- as.vector(t(CQ_df[CQ_df$CQ_Unit %in% Eatenby_params, zone_df$CQ_CType]))
    
    zonelayer_df$Lrvm <<- unlist(c(CQ_df[CQ_df$CQ_Unit == "Lrvm1", zone_df$CQ_CType], CQ_df[CQ_df$CQ_Unit == "Lrvm2", zone_df$CQ_CType], CQ_df[CQ_df$CQ_Unit == "Lrvm3", zone_df$CQ_CType], CQ_df[CQ_df$CQ_Unit == "Lrvm4", zone_df$CQ_CType]))
    
  }
  
  zone_stage_col_df <- data.frame(
    CQ_CType = rep(1:5, each = 4),
    zone = rep(1:4, 5),
    coln = CQ_CType_params
  )
  
  get_zone_stage_par <- function(zone, CQ_Stage, CQ_CType, par) {
    df <- zone_stage_par[[par]]
    cn <- zone_stage_col_df[zone_stage_col_df$zone == zone &
                              zone_stage_col_df$CQ_CType == CQ_CType, "coln"]
    get_graph_y(
      df,
      CQ_Stage,
      x_column = "CQ_Stage",
      y_column = cn,
      mode = "continues"
    )
  }
  
  get_val_by_CA_ComplCrop <- function(df, CA_ComplCrop, zone) {
    mapply(function(x, z) {
      df[df$CA_ComplCrop == x, z]
    }, CA_ComplCrop, zone)
  }
  
  tree_df[names(tree_par_df)] <- tree_par_df
  #TODO: remove the vars below from tree_df, and assign directly to specific df
  treefruit_df$TF_StageAbortSens <- unlist(tree_df[TF_StageAbortSens_params])
  treefruit_df$TF_TargetOilperBunch <- unlist(tree_df[TF_TargetOilperBunch_params])
  
  # T_TreeinZone?[Zone,Tree] = if AF_TreePosit[Tree] = AF_ZoneTree[Zone] then 1 else 0
  zone_df$T_TreeinZone <- 0
  tp <- tree_df$AF_TreePosit[tree_df$AF_TreePosit > 0]
  zone_df$T_TreeinZone[tp] <- 1
  
  # INIT MC_LAIperNecmss[Zone] = T_LWR[Sp1]*T_SLA[Sp1]
  zone_df$MC_LAIperNecmss <- tree_df$T_LWR[1] * tree_df$T_SLA[1]
  
  # INIT RT_TDistShapeAct[Tree] = RT_TDistShapeC[Tree]
  tree_df$RT_TDistShapeAct <- tree_df$RT_TDistShapeC
  # INIT RT_TDecDepthAct[Tree] = RT_TDecDepthC[Tree]
  tree_df$RT_TDecDepthAct <- tree_df$RT_TDecDepthC
  # AF_TreePosit2Q[Tree] = IF AF_TreePosit[Tree] = 2 then 1 else 0
  # AF_TreePosit3Q[Tree] = IF AF_TreePosit[Tree] = 3 then 1 else 0
  # AF_TreePosit4Q[Tree] = IF AF_TreePosit[Tree] = 4 then 1 else 0
  tree_df$AF_TreePosit2Q <- ifelse(tree_df$AF_TreePosit == 2, 1, 0)
  tree_df$AF_TreePosit3Q <- ifelse(tree_df$AF_TreePosit == 3, 1, 0)
  tree_df$AF_TreePosit4Q <- ifelse(tree_df$AF_TreePosit == 4, 1, 0)
  # INIT TW_DryFactPower[Tree] = TW_DryFactPowerInit[Tree]
  tree_df$TW_DryFactPower <- tree_df$TW_DryFactPowerInit
  # INIT TF_CurrentLeafNo[Tree] = TF_LeafCumInit[Tree]
  tree_df$TF_CurrentLeafNo <- tree_df$TF_LeafCumInit
  
  
  RT_TLrvL_df <- tree_df[RT_TLrvL_params]
  zonelayertree_df$RT_TLrvL_par <- unlist(c(RT_TLrvL_df[1, ], RT_TLrvL_df[2, ], RT_TLrvL_df[3, ]))
  zonelayertree_df$RT_ATType <- rep(tree_df$RT_ATType, each = nrow(zonelayer_df))
  
  treeanimal_df$PD_TEatenBy_is <- unlist(tree_df[PD_TEatenBy_params])
  treefruit_df$TF_FemSinkperFruit <- unlist(tree_df[TF_FemSinkperFruit_params])
  treefruit_df$TF_MaleSinkperBunch <- unlist(tree_df[TF_MaleSinkperBunch_params])
  treenut_df$T_NutMob <- unlist(tree_df[c("T_NutMobT_N", "T_NutMobT_P")])
  
  # T_PrunOption_par <- get_par_xls_list(T_PrunUnit, "T_PrunOption")
  C_BiomHarv_is <- T_PrunOption_par$`CropHarv?`
  
  get_T_PrunFracD <- function(T_PrunPast) {
    unlist(lapply(tree_df$tree_id, function(x) {
      get_graph_y(
        T_PrunFracD_df,
        T_PrunPast,
        x_column = "T_PrunPast",
        y_column = names(T_PrunFracD_df)[x],
        mode = "continues"
      )
    }))
  }
  
  get_T_PrunHarvFracD <- function(T_PrunPast) {
    unlist(lapply(tree_df$tree_id, function(x) {
      get_graph_y(
        T_PrunHarvFracD_df,
        T_PrunPast,
        x_column = "T_PrunPast",
        y_column = names(T_PrunHarvFracD_df)[x],
        mode = "continues"
      )
    }))
  }
  
  # T_LfConc[DW,Sp1] = 0*(T_Par1[LfN]+T_Par2[LfN]+T_Par3[LfN])+1
  # T_LfConc[DW,Sp2] = 0*(T_Par1[LfN]+T_Par2[LfN]+T_Par3[LfN])+1
  # T_LfConc[DW,Sp3] = 0*(T_Par1[LfN]+T_Par2[LfN]+T_Par3[LfN])+1
  # T_LfConc[N,Sp1] = (T_Par1[LfN]+0*T_Par2[LfN]+0*T_Par3[LfN])
  # T_LfConc[N,Sp2] = (0*T_Par1[LfN]+T_Par2[LfN]+0*T_Par3[LfN])
  # T_LfConc[N,Sp3] = (0*T_Par1[LfN]+0*T_Par2[LfN]+T_Par3[LfN])
  # T_LfConc[P,Sp1] = (T_Par1[LfP]+0*T_Par2[LfP]+0*T_Par3[LfP])
  # T_LfConc[P,Sp2] = (0*T_Par1[LfP]+T_Par2[LfP]+0*T_Par3[LfP])
  # T_LfConc[P,Sp3] = (0*T_Par1[LfP]+0*T_Par2[LfP]+T_Par3[LfP])
  treepcomp_df$T_LfConc <- 1
  treepcomp_df[treepcomp_df$PlantComp == "N", ]$T_LfConc <- tree_df$T_LfConc_N
  treepcomp_df[treepcomp_df$PlantComp == "P", ]$T_LfConc <- tree_df$T_LfConc_P
  
  # T_TwigConc[DW,Sp1] = 0*(T_Par1[TwigN]+T_Par2[TwigN]+T_Par3[TwigN])+1
  # T_TwigConc[DW,Sp2] = 0*(T_Par1[TwigN]+T_Par2[TwigN]+T_Par3[TwigN])+1
  # T_TwigConc[DW,Sp3] = 0*(T_Par1[TwigN]+T_Par2[TwigN]+T_Par3[TwigN])+1
  # T_TwigConc[N,Sp1] = T_Par1[TwigN]+0*T_Par2[TwigN]+0*T_Par3[TwigN]
  # T_TwigConc[N,Sp2] = 0*T_Par1[TwigN]+T_Par2[TwigN]+0*T_Par3[TwigN]
  # T_TwigConc[N,Sp3] = 0*T_Par1[TwigN]+0*T_Par2[TwigN]+T_Par3[TwigN]
  # T_TwigConc[P,Sp1] = T_Par1[TwigP]+0*T_Par2[TwigP]+0*T_Par3[TwigP]
  # T_TwigConc[P,Sp2] = 0*T_Par1[TwigP]+T_Par2[TwigP]+0*T_Par3[TwigP]
  # T_TwigConc[P,Sp3] = 0*T_Par1[TwigP]+0*T_Par2[TwigP]+T_Par3[TwigP]
  treepcomp_df$T_TwigConc <- 1
  treepcomp_df[treepcomp_df$PlantComp == "N", ]$T_TwigConc <- tree_df$T_ConcTwig_N
  treepcomp_df[treepcomp_df$PlantComp == "P", ]$T_TwigConc <- tree_df$T_ConcTwig_P
  
  # T_FruitConc[DW,Sp1] = 0*(T_Par1[FruitN]+T_Par2[FruitN]+T_Par3[FruitN])+1
  # T_FruitConc[DW,Sp2] = 0*(T_Par1[FruitN]+T_Par2[FruitN]+T_Par3[FruitN])+1
  # T_FruitConc[DW,Sp3] = 0*(T_Par1[FruitN]+T_Par2[FruitN]+T_Par3[FruitN])+1
  # T_FruitConc[N,Sp1] = T_Par1[FruitN]+0*T_Par2[FruitN]+0*T_Par3[FruitN]
  # T_FruitConc[N,Sp2] = 0*T_Par1[FruitN]+T_Par2[FruitN]+0*T_Par3[FruitN]
  # T_FruitConc[N,Sp3] = 0*T_Par1[FruitN]+0*T_Par2[FruitN]+T_Par3[FruitN]
  # T_FruitConc[P,Sp1] = T_Par1[FruitP]+0*T_Par2[FruitP]+0*T_Par3[FruitP]
  # T_FruitConc[P,Sp2] = 0*T_Par1[FruitP]+T_Par2[FruitP]+0*T_Par3[FruitP]
  # T_FruitConc[P,Sp3] = 0*T_Par1[FruitP]+0*T_Par2[FruitP]+T_Par3[FruitP]
  treepcomp_df$T_FruitConc <- 1
  treepcomp_df[treepcomp_df$PlantComp == "N", ]$T_FruitConc <- tree_df$T_ConcFruit_N
  treepcomp_df[treepcomp_df$PlantComp == "P", ]$T_FruitConc <- tree_df$T_ConcFruit_P
  
  # T_GroResConc[DW,Sp1] = 0*(T_Par1[GroResN]+T_Par2[GroResN]+T_Par3[GroResN])+1
  # T_GroResConc[DW,Sp2] = 0*(T_Par1[GroResN]+T_Par2[GroResN]+T_Par3[GroResN])+1
  # T_GroResConc[DW,Sp3] = 0*(T_Par1[GroResN]+T_Par2[GroResN]+T_Par3[GroResN])+1
  # T_GroResConc[N,Sp1] = T_Par1[GroResN]+0*T_Par2[GroResN]+0*T_Par3[GroResN]
  # T_GroResConc[N,Sp2] = 0*T_Par1[GroResN]+T_Par2[GroResN]+0*T_Par3[GroResN]
  # T_GroResConc[N,Sp3] = 0*T_Par1[GroResN]+0*T_Par2[GroResN]+T_Par3[GroResN]
  # T_GroResConc[P,Sp1] = T_Par1[GroResP]+0*T_Par2[GroResP]+0*T_Par3[GroResP]
  # T_GroResConc[P,Sp2] = 0*T_Par1[GroResP]+T_Par2[GroResP]+0*T_Par3[GroResP]
  # T_GroResConc[P,Sp3] = 0*T_Par1[GroResP]+0*T_Par2[GroResP]+T_Par3[GroResP]
  treepcomp_df$T_GroResConc <- 1
  treepcomp_df[treepcomp_df$PlantComp == "N", ]$T_GroResConc <- tree_df$T_ConcGroRes_N
  treepcomp_df[treepcomp_df$PlantComp == "P", ]$T_GroResConc <- tree_df$T_ConcGroRes_P
  
  # T_RtConc[DW,Sp1] = 0*(T_Par1[RtN]+T_Par2[RtN]+T_Par3[RtN])+1
  # T_RtConc[DW,Sp2] = 0*(T_Par1[RtN]+T_Par2[RtN]+T_Par3[RtN])+1
  # T_RtConc[DW,Sp3] = 0*(T_Par1[RtN]+T_Par2[RtN]+T_Par3[RtN])+1
  # T_RtConc[N,Sp1] = T_Par1[RtN]+0*T_Par2[RtN]+0*T_Par3[RtN]
  # T_RtConc[N,Sp2] = 0*T_Par1[RtN]+T_Par2[RtN]+0*T_Par3[RtN]
  # T_RtConc[N,Sp3] = 0*T_Par1[RtN]+0*T_Par2[RtN]+T_Par3[RtN]
  # T_RtConc[P,Sp1] = T_Par1[RtP]+0*T_Par2[RtP]+0*T_Par3[RtP]
  # T_RtConc[P,Sp2] = 0*T_Par1[RtP]+T_Par2[RtP]+0*T_Par3[RtP]
  # T_RtConc[P,Sp3] = 0*T_Par1[RtP]+0*T_Par2[RtP]+T_Par3[RtP]
  
  treepcomp_df$T_RtConc <- 1
  treepcomp_df[treepcomp_df$PlantComp == "N", ]$T_RtConc <- tree_df$T_ConcRT_N
  treepcomp_df[treepcomp_df$PlantComp == "P", ]$T_RtConc <- tree_df$T_ConcRT_P
  
  # T_WoodConc[DW,Sp1] = 0*(T_Par1[WoodN]+T_Par2[WoodN]+T_Par3[WoodN])+1
  # T_WoodConc[DW,Sp2] = 0*(T_Par1[WoodN]+T_Par2[WoodN]+T_Par3[WoodN])+1
  # T_WoodConc[DW,Sp3] = 0*(T_Par1[WoodN]+T_Par2[WoodN]+T_Par3[WoodN])+1
  # T_WoodConc[N,Sp1] = T_Par1[WoodN]+0*T_Par2[WoodN]+0*T_Par3[WoodN]
  # T_WoodConc[N,Sp2] = 0*T_Par1[WoodN]+T_Par2[WoodN]+0*T_Par3[WoodN]
  # T_WoodConc[N,Sp3] = 0*T_Par1[WoodN]+0*T_Par2[WoodN]+T_Par3[WoodN]
  # T_WoodConc[P,Sp1] = T_Par1[WoodP]+0*T_Par2[WoodP]+0*T_Par3[WoodP]
  # T_WoodConc[P,Sp2] = 0*T_Par1[WoodP]+T_Par2[WoodP]+0*T_Par3[WoodP]
  # T_WoodConc[P,Sp3] = 0*T_Par1[WoodP]+0*T_Par2[WoodP]+T_Par3[WoodP]
  
  treepcomp_df$T_WoodConc <- 1
  treepcomp_df[treepcomp_df$PlantComp == "N", ]$T_WoodConc <- tree_df$T_ConcWood_N
  treepcomp_df[treepcomp_df$PlantComp == "P", ]$T_WoodConc <- tree_df$T_ConcWood_P
  
  
  # TW_DryFactRangeInit[BufValues] = CW_DryFactRangeInit[BufValues]
  buf_df$TW_DryFactRangeInit <- buf_df$CW_DryFactRangeInit
  
  treebuf_df$TW_DryFactRangeInit <- rep(buf_df$TW_DryFactRangeInit, each = nrow(tree_df))
  treebuf_df$TW_DemActSubtract <- rep(buf_df$TW_DemActSubtract, each = nrow(tree_df))
  
  
  layer_df[names(soil_df)] <- soil_df
  layer_df$S_KsatInitV <- layer_df$S_KsatInitV * 10
  layer_df$S_KsatDefV <- layer_df$S_KsatDefV * 10
  
  S_zl_df <- layer_df[c("S_KsatInitV",
                        "S_KsatDefV",
                        "W_FieldCapKcrit",
                        "W_ThetaInacc")]
  S_zl_df <- S_zl_df[rep(seq_len(nrow(S_zl_df)), each = nzone), ]
  zonelayer_df[names(S_zl_df)] <- S_zl_df
  
  get_TW_PhiPot <- function(TW_pFPotRhizOpt, layer, tree_id) {
    varcol <- TW_PhiPot_meta_df[TW_PhiPot_meta_df$layer == layer &
                                  TW_PhiPot_meta_df$tree_id == tree_id, ]$varcol
    get_graph_y(
      TW_PhiPot_df,
      TW_pFPotRhizOpt,
      x_column = "TW_pFPotRhizOpt",
      y_column = varcol,
      mode = "continues"
    )
  }
  
  zone_df$CW_DryFactRangePower <- CW_DryFactRangePowerStart
  
  irrigation_df = data.frame(day = c(1:365), irrigation = rep(0, 365))
  
  calendar_df <- data.frame(month = c(1:12))
  calendar_df$EVAP_MonthlyMean_DayLength <- c(12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12)
  calendar_df$RAIN_Numberof_DaysperMonth <- days_in_month(calendar_df$month)
  calendar_df$cumsum_days <- cumsum(calendar_df$RAIN_Numberof_DaysperMonth)
  calendar_df$EVAP_MonthlyMean_AirTemp <- c(25.8, 26.3, 26.9, 27.5, 27.6, 27.1, 26.7, 27, 27.6, 27.4, 26, 26.4)
  
  # INIT RAIN_WeightTot = RAIN_Weight[Zn1]*AF_ZoneFrac[Zn1]+RAIN_Weight[Zn2]*AF_ZoneFrac[Zn2]+RAIN_Weight[Zn3]*AF_ZoneFrac[Zn3]+RAIN_Weight[Zn4]*AF_ZoneFrac[Zn4]
  RAIN_WeightTot <- sum(zone_df$RAIN_Weight * zone_df$AF_ZoneFrac)
  zone_df$RAIN_WeightAct <- zone_df$RAIN_Weight / RAIN_WeightTot
  
  #TODO: this was double declaration.. to be fixed
  RAIN_pars <- get_rain_pars()
  set.seed(RAIN_pars$RAIN_par$RAIN_GenSeed)
  
  
  
  #TODO: validate parameter here
  zonelayer_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nlayer)
  
  # soil zones
  AF_ZoneFrac_1 <- zone_df$AF_ZoneFrac[-1]
  AF_ZoneFrac_1 <- c(AF_ZoneFrac_1, zone_df$AF_ZoneFrac[1])
  zone_df$AF_LatInFlowRatio <- AF_ZoneFrac_1 / zone_df$AF_ZoneFrac
  
  # AF_Depth1[Zone] = AF_DepthLay1
  # AF_Depth2[Zone] = AF_DepthLay2*(1-AF_StoneFrac[Zone,2])
  # AF_Depth3[Zone] = AF_DepthLay3*(1-AF_StoneFrac[Zone,3])
  # AF_Depth4[Zone] = AF_DepthLay4*(1-AF_StoneFrac[Zone,4])
  zonelayer_df$AF_DepthLay <- rep(layer_df$AF_DepthLay, each = nzone)
  zonelayer_df$AF_Depth <- zonelayer_df$AF_DepthLay * (1 - zonelayer_df$AF_StoneFrac)
  
  # RT3_DepthZone[Zn1,1] = AF_DepthAct1[Zn1]+0*(AF_Depth2[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
  # RT3_DepthZone[Zn1,2] = AF_Depth2[Zn1]+0*(AF_DepthAct1[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
  # RT3_DepthZone[Zn1,3] = AF_Depth3[Zn1]+0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth4[Zn1])
  # RT3_DepthZone[Zn1,4] = AF_Depth4[Zn1]+0*(AF_DepthAct1[Zn4]+AF_Depth2[Zn4]+AF_Depth3[Zn4])
  # RT3_DepthZone[Zn2,1] = AF_DepthAct1[Zn2]+0*(AF_Depth2[Zn2]+AF_Depth3[Zn2]+AF_Depth4[Zn2])
  # RT3_DepthZone[Zn2,2] = AF_Depth2[Zn2]+0*(AF_DepthAct1[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
  # RT3_DepthZone[Zn2,3] = AF_Depth3[Zn2]+0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth4[Zn1])
  # RT3_DepthZone[Zn2,4] = AF_Depth4[Zn2]+0*(AF_DepthAct1[Zn4]+AF_Depth2[Zn4]+AF_Depth3[Zn4])
  zonelayer_df$RT3_DepthZone <- zonelayer_df$AF_Depth
  
  zonelayer_df$AF_ZoneWidth <- rep(zone_df$AF_ZoneWidth, nlayer)
  # RT3_VoxVol[Zone,SoilLayer] = AF_ZoneWidth[Zone]*100*RT3_DepthZone[Zone,SoilLayer]*100
  zonelayer_df$RT3_VoxVol <- zonelayer_df$AF_ZoneWidth * 100 * zonelayer_df$RT3_DepthZone *
    100
  
  # initiate the top layer
  zone_df$AF_SlopeCurr <- zone_df$AF_SlopeSurfInit
  zone_df$AF_DepthLay1 <- layer_df[layer_df$layer == 1, ]$AF_DepthLay
  
  # AF_DepthSlope1[Zn1] = if AF_DepthDynamic? = 0 then AF_DepthLay1 else
  #   (AF_DepthLay1/COS(ARCTAN(AF_SlopeSoilHoriz/100))+(0.5-AF_ZoneFrac[Zn1]/2)*(TAN(ARCTAN(AF_SlopeSoilHoriz/100))-TAN(ARCTAN(AF_SlopeCurr[Zn1]/100))))
  
  # AF_DepthSlope1[Zn1] = if AF_DepthDynamic? = 0 then AF_DepthLay1 else (AF_DepthLay1/COS(ARCTAN(AF_SlopeSoilHoriz/100))+(0.5-AF_ZoneFrac[Zn1]/2)*(TAN(ARCTAN(AF_SlopeSoilHoriz/100))-TAN(ARCTAN(AF_SlopeCurr[Zn1]/100))))
  # AF_DepthSlope1[Zn2] = if AF_DepthDynamic? = 0 then AF_DepthLay1 else mAX((AF_DepthLay1/COS(ARCTAN(AF_SlopeSoilHoriz/100))+(0.5-AF_ZoneFrac[Zn1]-AF_ZoneFrac[Zn2]/2)*(TAN(ARCTAN(AF_SlopeSoilHoriz/100))-TAN(ARCTAN(AF_SlopeCurr[Zn2]/100)))),0.0001)
  # AF_DepthSlope1[Zn3] = if AF_DepthDynamic? = 0 then AF_DepthLay1 else max((AF_DepthLay1/COS(ARCTAN(AF_SlopeSoilHoriz/100))+(0.5-AF_ZoneFrac[Zn1]-AF_ZoneFrac[Zn2]-AF_ZoneFrac[Zn3]/2)*(TAN(ARCTAN(AF_SlopeSoilHoriz/100))-TAN(ARCTAN(AF_SlopeCurr[Zn3]/100)))),0.0001)
  # AF_DepthSlope1[Zn4] = if AF_DepthDynamic? = 0 then AF_DepthLay1 else max((AF_DepthLay1/COS(ARCTAN(AF_SlopeSoilHoriz/100))+(0.5-AF_ZoneFrac[Zn1]-AF_ZoneFrac[Zn2]-AF_ZoneFrac[Zn3]-AF_ZoneFrac[Zn4]/2)*(TAN(ARCTAN(AF_SlopeSoilHoriz/100))-TAN(ARCTAN(AF_SlopeCurr[Zn4]/100)))),0.0001)
  zone_df$AF_DepthDynamic_is <-  AF_DepthDynamic_is
  zone_df$AF_SlopeSoilHoriz <- AF_SlopeSoilHoriz
  zone_df$AF_DepthSlope1_a <- zone_df$AF_DepthLay1 / cos(atan(zone_df$AF_SlopeSoilHoriz / 100))
  zone_df$AF_DepthSlope1_b <- tan(atan(zone_df$AF_SlopeSoilHoriz / 100)) - tan(atan(zone_df$AF_SlopeCurr / 100))
  z1 <- zone_df[zone_df$zone == 1, ]
  z2 <- zone_df[zone_df$zone == 2, ]
  z3 <- zone_df[zone_df$zone == 3, ]
  z4 <- zone_df[zone_df$zone == 4, ]
  zone_df$AF_DepthSlope1 <- zone_df$AF_DepthLay1
  zone_df[zone_df$zone == 1, ]$AF_DepthSlope1 <- ifelse(
    z1$AF_DepthDynamic_is == 0,
    z1$AF_DepthLay1,
    z1$AF_DepthSlope1_a + (0.5 - z1$AF_ZoneFrac / 2) * z1$AF_DepthSlope1_b
  )
  zone_df[zone_df$zone == 2, ]$AF_DepthSlope1 <- ifelse(
    z2$AF_DepthDynamic_is == 0,
    z2$AF_DepthLay1,
    pmax(
      z2$AF_DepthSlope1_a + (0.5 - z1$AF_ZoneFrac - z2$AF_ZoneFrac / 2) * z2$AF_DepthSlope1_b,
      0.0001
    )
  )
  zone_df[zone_df$zone == 3, ]$AF_DepthSlope1 <- ifelse(
    z3$AF_DepthDynamic_is == 0,
    z3$AF_DepthLay1,
    pmax(
      z3$AF_DepthSlope1_a + (0.5 - z1$AF_ZoneFrac - z2$AF_ZoneFrac - z3$AF_ZoneFrac / 2) * z3$AF_DepthSlope1_b,
      0.0001
    )
  )
  zone_df[zone_df$zone == 4, ]$AF_DepthSlope1 <- ifelse(
    z4$AF_DepthDynamic_is == 0,
    z4$AF_DepthLay1,
    pmax(
      z4$AF_DepthSlope1_a + (
        0.5 - z1$AF_ZoneFrac - z2$AF_ZoneFrac - z3$AF_ZoneFrac - z4$AF_ZoneFrac / 2
      ) * z4$AF_DepthSlope1_b,
      0.0001
    )
  )
  
  # AF_DepthAct1[Zone] = IF(AF_SlopeCurr[Zone]<>AF_SlopeSurfInit)THEN(AF_Depth1[Zone])*(1-AF_StoneFrac[Zone,1])
  # ELSE(AF_DepthSlope1[Zone])*(1-AF_StoneFrac[Zone,1])
  zone_df$AF_DepthAct1 <- ifelse(
    zone_df$AF_SlopeCurr != zone_df$AF_SlopeSurfInit,
    zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth * (1 - zonelayer_df[zonelayer_df$layer == 1, ]$AF_StoneFrac),
    zone_df$AF_DepthSlope1 * (1 - zonelayer_df[zonelayer_df$layer == 1, ]$AF_StoneFrac)
  )
  
  #NOTE: Layer 1 AF_Depth is equal to AF_DepthAct1, the original ia copied to AF_Depth_original
  zonelayer_df$AF_Depth_original <- zonelayer_df$AF_Depth
  zonelayer_df[layer_df$layer == 1, ]$AF_Depth <- zone_df$AF_DepthAct1
  
  # AF_Depths[1] = AF_DepthAct1[Zn1]+0*(AF_Depth2[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
  # AF_Depths[2] = AF_Depth2[Zn1]+  +0*(AF_DepthAct1[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
  # AF_Depths[3] = AF_Depth3[Zn1]+  +0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth4[Zn1])
  # AF_Depths[4] = AF_Depth4[Zn1]+  +0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth3[Zn1])
  layer_df$AF_Depths <- zonelayer_df[zonelayer_df$zone == 1, ]$AF_Depth
  
  # RT_Depth1[Zone] = AF_Depths[1]
  # RT_Depth2[Zone] = AF_Depths[1]+AF_Depths[2]
  # RT_Depth3[Zone] = AF_Depths[1]+AF_Depths[2]+AF_Depths[3]
  # RT_Depth4[Zone] = ARRAYSUM(AF_Depths[*])
  zonelayer_df$RT_Depth <- layer_df$AF_Depths[1]
  zonelayer_df[zonelayer_df$layer == 2, ]$RT_Depth <- sum(layer_df$AF_Depths[1:2])
  zonelayer_df[zonelayer_df$layer == 3, ]$RT_Depth <- sum(layer_df$AF_Depths[1:3])
  zonelayer_df[zonelayer_df$layer == 4, ]$RT_Depth <- sum(layer_df$AF_Depths)
  
  # RT_Depth = RT_Depth4[Zn1]
  RT_Depth <- zonelayer_df[zonelayer_df$zone == 1 &
                             zonelayer_df$layer == 4, ]$RT_Depth
  
  # INIT RT_TLraCD[Tree] = RT_TDecDepthC[Tree]*EXP(-0.25*RT_TDecDepthC[Tree]*(SQRT(RT_TDistShapeC[Tree]*AF_ZoneTot^2)+SQRT(RT_Depth^2)+SQRT(RT_TDistShapeC[Tree]*AF_ZoneTot^2+RT_Depth^2)))
  tree_df$RT_TLraCD <- tree_df$RT_TDecDepthC * exp(-0.25 * tree_df$RT_TDecDepthC *
                                                     (
                                                       sqrt(tree_df$RT_TDistShapeC * AF_ZoneTot^2) + sqrt(RT_Depth^2) + sqrt(tree_df$RT_TDistShapeC *
                                                                                                                               AF_ZoneTot^2 + RT_Depth^2)
                                                     ))
  
  # INIT S_BDActOverBDRefInfiltr[Zone] = (0.69-SQRT(-0.69^2-4*-0.52*(1.21-(LOG10(S_RelSurfInfiltrInit[Zone])))))/(2*-0.52)
  zone_df$S_BDActOverBDRefInfiltr <- (0.69 - sqrt((-0.69)^2 - 4 * (-0.52 *
                                                                     (
                                                                       1.21 -
                                                                         log10(zone_df$S_RelSurfInfiltrInit)
                                                                     )))) / (2 * (-0.52))
  
  # TODO: is this dynamic variable?
  # INIT S_BDActOverBDRefKsatV1[Zone] = (0.69-SQRT(-0.69^2-4*-0.52*(1.21-(LOG10(S_KsatInitV1[Zone]/S_KsatDefV1[Zone])))))/(2*-0.52)
  zonelayer_df$S_BDActOverBDRefKsatV <- (0.69 - sqrt(-0.69^2 - 4 * -0.52 * (1.21 -
                                                                              (
                                                                                log10(zonelayer_df$S_KsatInitV / zonelayer_df$S_KsatDefV)
                                                                              )))) / (2 * -0.52)
  
  # S_KsatV1Act[Zone] = S_KsatDefV1[Zone]*10^((-0.52*(S_BDActOverBDRefKsatV1[Zone]^2)-0.69*S_BDActOverBDRefKsatV1[Zone]+1.21))
  zonelayer_df$S_KsatVAct <- zonelayer_df$S_KsatDefV * 10^((
    -0.52 * (zonelayer_df$S_BDActOverBDRefKsatV^2) - 0.69 * zonelayer_df$S_BDActOverBDRefKsatV +
      1.21
  ))
  
  # W_KSatH1[Zone] = S_KsatV1Act[Zone]*S_KSatHperV1[Zone]
  # W_KSatH2[Zone] = S_KsatV2Act[Zone]*S_KsatHperV2[Zone]
  # W_KSatH3[Zone] = S_KsatV3Act[Zone]*S_KsatHperV3[Zone]
  # W_KSatH4[Zone] = S_KsatV4Act[Zone]*S_KsatHperV4[Zone]
  zonelayer_df$W_KSatH <- zonelayer_df$S_KsatVAct * zonelayer_df$S_KSatHperV
  
  # S_RelBD[Zn1,1] = S_BDActOverBDRefKsatV1[Zn1]+0*(S_BDActOverBDRefKsatV1[Zn1]+S_BDActOverBDRefKsatV2[Zn1]+S_BDActOverBDRefKsatV3[Zn1]+S_BDActOverBDRefKsatV4[Zn1])
  zonelayer_df$S_RelBD <- zonelayer_df$S_BDActOverBDRefKsatV
  
  zonelayer_df$W_BDLayer <- rep(layer_df$W_BDLayer, each = nzone)
  # W_PoreVol[Zone,SoilLayer] = (1-W_BDLayer[SoilLayer]*S_RelBD[Zone,SoilLayer]/2.5)
  zonelayer_df$W_PoreVol <- (1 - zonelayer_df$W_BDLayer * zonelayer_df$S_RelBD / 2.5)
  # W_ThetaI1[Zone] = W_ThetaInit1[Zone]*W_PoreVol[Zone,1]
  zonelayer_df$W_ThetaI <- zonelayer_df$W_ThetaInit * zonelayer_df$W_PoreVol
  
  # INIT W_Stock1[Zone] = W_ThetaI1[Zone]*AF_DepthAct1[Zone]*1000
  zonelayer_df$W_Stock <- zonelayer_df$W_ThetaI * zonelayer_df$AF_Depth * 1000
  
  # layer height above ground water table (cm)
  # INIT AF_HGW1[Zone] = (.5*AF_Depth1[Zone]+AF_Depth2[Zone]+AF_Depth3[Zone]+AF_Depth4[Zone] + AF_DepthGroundWater_Table  )*100
  # INIT AF_HGW2[Zone] = (.5*AF_Depth2[Zone]+AF_Depth3[Zone]+AF_Depth4[Zone] + AF_DepthGroundWater_Table  )*100
  # INIT AF_HGW3[Zone] = (.5*AF_Depth3[Zone]+AF_Depth4[Zone] + AF_DepthGroundWater_Table  )*100
  # INIT AF_HGW4[Zone] = (.5*AF_Depth4[Zone] + AF_DepthGroundWater_Table  )*100
  l1 <- zonelayer_df[zonelayer_df$layer == 1, ]
  l2 <- zonelayer_df[zonelayer_df$layer == 2, ]
  l3 <- zonelayer_df[zonelayer_df$layer == 3, ]
  l4 <- zonelayer_df[zonelayer_df$layer == 4, ]
  
  zonelayer_df$AF_HGW <- NA
  zonelayer_df[zonelayer_df$layer == 1, ]$AF_HGW <- (
    0.5 * l1$AF_Depth_original + l2$AF_Depth + l3$AF_Depth + l4$AF_Depth +  AF_DepthGroundWater_Table
  ) * 100
  zonelayer_df[zonelayer_df$layer == 2, ]$AF_HGW <- (0.5 * l2$AF_Depth + l3$AF_Depth +
                                                       l4$AF_Depth +  AF_DepthGroundWater_Table) * 100
  zonelayer_df[zonelayer_df$layer == 3, ]$AF_HGW <- (0.5 * l3$AF_Depth +
                                                       l4$AF_Depth +  AF_DepthGroundWater_Table) * 100
  zonelayer_df[zonelayer_df$layer == 4, ]$AF_HGW <- (0.5 * l4$AF_Depth +  AF_DepthGroundWater_Table) * 100
  
  zonelayer_df$W_ThetaP <- NA
  for (i in c(1:nlayer)) {
    gr_df <- W_ThetaP_df[c(1, i + 1)]
    AF_HGW <- zonelayer_df[zonelayer_df$layer == i &
                             zonelayer_df$zone == 1, ]$AF_HGW
    zonelayer_df[zonelayer_df$layer == i, ]$W_ThetaP <- get_graph_y(gr_df, x = -AF_HGW, mode = "continues")
  }
  
  # LF_V1MaxDailyFlow[Zone] = (AF_DepthAct1[Zone]*S_KsatV1Act[Zone]+AF_Depth2[Zone]*S_KsatV2Act[Zone])/(AF_DepthAct1[Zone]+AF_Depth2[Zone])
  # LF_V2MaxDailyFlow[Zone] = (AF_Depth2[Zone]*S_KsatV2Act[Zone]+AF_Depth3[Zone]*S_KsatV3Act[Zone])/(AF_Depth2[Zone]+AF_Depth3[Zone])
  # LF_V3MaxDailyFlow[Zone] = (AF_Depth3[Zone]*S_KsatV3Act[Zone]+AF_Depth4[Zone]*S_KsatV4Act[Zone])/(AF_Depth3[Zone]+AF_Depth4[Zone])
  # LF_V4MaxDailyFlow[Zone] = (AF_Depth4[Zone]*S_KsatV4Act[Zone]+AF_DeepSubSoil*S_KsatVDeepSub)/(AF_Depth4[Zone]+AF_DeepSubSoil)
  zonelayer_df$AF_Depth_down <- c(zonelayer_df[zonelayer_df$layer %in% c(2:4), ]$AF_Depth, rep(AF_DeepSubSoil, nzone))
  zonelayer_df$S_KsatVAct_down <- c(zonelayer_df[zonelayer_df$layer %in% c(2:4), ]$S_KsatVAct, rep(S_KsatVDeepSub, nzone))
  
  zonelayer_df$LF_VMaxDailyFlow <-  (
    zonelayer_df$AF_Depth * zonelayer_df$S_KsatVAct  + zonelayer_df$AF_Depth_down * zonelayer_df$S_KsatVAct_down
  ) / (zonelayer_df$AF_Depth + zonelayer_df$AF_Depth_down)
  
  zonenut_df$MN_NutRatStruc <- rep(nut_df$MN_NutRatStruc, each = nzone)
  zonenut_df$MN_InitStruc <- rep(zone_df$MN_InitStruc, nrow(nut_df))
  zonenut_df$AF_Depth1 <- rep(zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth, nrow(nut_df))
  
  # INIT MN_Struc[Zone,SlNut] = MN_InitStruc[Zone]/MN_NutRatStruc[SlNut]*AF_DepthAct1[Zone]*1000
  zonenut_df$MN_Struc <- zonenut_df$MN_InitStruc / zonenut_df$MN_NutRatStruc * zonenut_df$AF_Depth1 *
    1000
  
  # INIT MC_Struc[Zone] = MN_Struc[Zone,N]*MN_CNStruc
  zone_df$MC_Struc <- zonenut_df[zonenut_df$SlNut == "N", ]$MN_Struc * MN_CNStruc
  
  # INIT MN_Metab[Zone,SlNut] = MN_InitMetab[Zone]/MN_NutRatMetab[SlNut]*AF_DepthAct1[Zone]*1000
  zonenut_df$MN_InitMetab <- rep(zone_df$MN_InitMetab, nrow(nut_df))
  zonenut_df$MN_NutRatMetab <- rep(nut_df$MN_NutRatMetab, each = nzone)
  zonenut_df$AF_DepthAct1 <- rep(zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth, nrow(nut_df))
  zonenut_df$MN_Metab <- zonenut_df$MN_InitMetab / zonenut_df$MN_NutRatMetab * zonenut_df$AF_DepthAct1 *
    1000
  
  # INIT MC_Metab[Zone] = MC_CNRatInitMet[Zone]*MN_Metab[Zone,N]
  zone_df$MC_Metab <- zone_df$MC_CNRatInitMet * zonenut_df[zonenut_df$SlNut == "N", ]$MN_Metab
  
  # INIT MN_Act[Zone,SlNut] = MN_InitAct[Zone]/MN_NutRatAct[SlNut]*AF_DepthAct1[Zone]*1000
  zonenut_df$MN_InitAct <- rep(zone_df$MN_InitAct, nrow(nut_df))
  zonenut_df$MN_NutRatAct <- rep(nut_df$MN_NutRatAct, each = nzone)
  zonenut_df$MN_Act <- zonenut_df$MN_InitAct / zonenut_df$MN_NutRatAct * zonenut_df$AF_DepthAct1 *
    1000
  
  # INIT MC_Act[Zone] = MN_Act[Zone,N]*MN_CNAct
  zone_df$MC_Act <- zonenut_df[zonenut_df$SlNut == "N", ]$MN_Act * MN_CNAct
  
  
  # INIT MN_Slw[Zone,SlNut] = MN_InitSlw[Zone]/MN_NutRatSlw[SlNut]*AF_DepthAct1[Zone]*1000
  zonenut_df$MN_InitSlw <- rep(zone_df$MN_InitSlw, nrow(nut_df))
  zonenut_df$MN_NutRatSlw <- rep(nut_df$MN_NutRatSlw, each = nzone)
  zonenut_df$MN_Slw <- zonenut_df$MN_InitSlw / zonenut_df$MN_NutRatSlw * zonenut_df$AF_DepthAct1 *
    1000
  
  # INIT MC_Slw[Zone] = MN_Slw[Zone,N]*MN_CNSlw
  zone_df$MC_Slw <- zonenut_df[zonenut_df$SlNut == "N", ]$MN_Slw * MN_CNSlw
  
  # INIT MN_Pass[Zone,SlNut] = MN_InitPass[Zone]/MN_NutRatPas[SlNut]*AF_DepthAct1[Zone]*1000
  zonenut_df$MN_InitPass <- rep(zone_df$MN_InitPass, nrow(nut_df))
  zonenut_df$MN_NutRatPas <- rep(nut_df$MN_NutRatPas, each = nzone)
  zonenut_df$MN_Pass <- zonenut_df$MN_InitPass / zonenut_df$MN_NutRatPas *
    zonenut_df$AF_DepthAct1 * 1000
  
  # INIT MC_Pass[Zone] = MN_Pass[Zone,N]*MN_CNPass
  zone_df$MC_Pass <- zonenut_df[zonenut_df$SlNut == "N", ]$MN_Pass * MN_CNPass
  
  # MC2_RelImpDeno[Zone] = AF_DepthAct1[Zone]*MC2_SOMDist[1]+AF_Depth2[Zone]*MC2_SOMDist[2]+AF_Depth3[Zone]*MC2_SOMDist[3]+AF_Depth4[Zone]*MC2_SOMDist[4]
  zonelayer_df$MC2_SOMDist <- rep(layer_df$MC2_SOMDist, each = nzone)
  zonelayer_df$MC2_RelImpDeno_a <- zonelayer_df$AF_Depth * zonelayer_df$MC2_SOMDist
  zone_df$MC2_RelImpDeno <- aggregate(zonelayer_df["MC2_RelImpDeno_a"], zonelayer_df["zone"], sum)$MC2_RelImpDeno_a
  
  # MC2_ClayperZone[Zone] = (S_SoilProp[ClayLayer1]*AF_DepthAct1[Zone]+S_SoilProp[ClayLayer2]*AF_Depth2[Zone])/(AF_DepthAct1[Zone]+AF_Depth2[Zone])
  zone_df$MC2_ClayperZone <- (
    layer_df$ClayLayer[1] * zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth +
      layer_df$ClayLayer[2] * zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth
  ) / (zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth + zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth)
  
  # MC2_Clay = (MC2_ClayperZone[Zn1]*AF_ZoneWidth[Zn1]+MC2_ClayperZone[Zn2]*AF_ZoneWidth[Zn2]+MC2_ClayperZone[Zn3]*AF_ZoneWidth[Zn3]+MC2_ClayperZone[Zn4]*AF_ZoneWidth[Zn4])/ARRAYSUM(AF_ZoneWidth[*])/100
  MC2_Clay <- sum(zone_df$MC2_ClayperZone * zone_df$AF_ZoneWidth) / sum(zone_df$AF_ZoneWidth) /
    100
  
  # MC2_SiltperZone[Zone] = (S_SoilProp[SiltLayer1]*AF_DepthAct1[Zone]+S_SoilProp[SiltLayer2]*AF_Depth2[Zone])/(AF_DepthAct1[Zone]+AF_Depth2[Zone])
  zone_df$MC2_SiltperZone <- (
    layer_df$SiltLayer[1] * zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth +
      layer_df$SiltLayer[2] * zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth
  ) / (zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth + zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth)
  
  # MC2_Silt = (MC2_SiltperZone[Zn1]*AF_ZoneWidth[Zn1]+MC2_SiltperZone[Zn2]*AF_ZoneWidth[Zn2]+MC2_SiltperZone[Zn3]*AF_ZoneWidth[Zn3]+MC2_SiltperZone[Zn4]*AF_ZoneWidth[Zn4])/ARRAYSUM(AF_ZoneWidth[*])/100
  MC2_Silt <- sum(zone_df$MC2_SiltperZone * zone_df$AF_ZoneWidth) / sum(zone_df$AF_ZoneWidth) /
    100
  
  # MC2_CrefMeth2 = exp(MC2_CrefOffset+MC2_ClayCoeffCref*(MC2_Clay+MC2_SiltClayCoeffCref*MC2_Silt)+MC2_pHCoeffCref*MC2_pH)
  MC2_CrefMeth2 <- exp(
    MC2_CrefOffset + MC2_ClayCoeffCref * (MC2_Clay + MC2_SiltClayCoeffCref *
                                            MC2_Silt) + MC2_pHCoeffCref * MC2_pH
  )
  
  # MC2_CorgInit = if MC2_SomInitType = 2 then MC2_CorgpCref*MC2_CrefMeth2 else MC2_CorgInitMeth3
  MC2_CorgInit <- ifelse(MC2_SomInitType == 2,
                         MC2_CorgpCref * MC2_CrefMeth2,
                         MC2_CorgInitMeth3)
  
  
  # INIT MC2_Metab[Zone,SoilLayer] = if MC2_SomInitType = 1 then (MN2_InitMetab[Zone]*1000*MC2_RelImpDeno[Zone]/(MC2_SOMDist[1]))*MC2_CNRatInitMet[Zone] else 0.01 * 10000*MC2_CorgInit*MC2_RelImpDeno[Zone]/MC2_SOMDist[1]
  zonelayer_df$MN2_InitMetab <- rep(zone_df$MN2_InitMetab, nlayer)
  zonelayer_df$MC2_RelImpDeno <- rep(zone_df$MC2_RelImpDeno, nlayer)
  zonelayer_df$MC2_CNRatInitMet <- rep(zone_df$MC2_CNRatInitMet, nlayer)
  zonelayer_df$MC2_Metab <- ifelse(
    MC2_SomInitType == 1,
    (
      zonelayer_df$MN2_InitMetab * 1000 * zonelayer_df$MC2_RelImpDeno / (layer_df$MC2_SOMDist[1])
    ) * zonelayer_df$MC2_CNRatInitMet,
    0.01 * 10000 * MC2_CorgInit * zonelayer_df$MC2_RelImpDeno /
      layer_df$MC2_SOMDist[1]
  )
  
  # INIT MN2_ActInit[Zone] = MN2_InitAct[Zone]*1000*MC2_RelImpDeno[Zone]
  zone_df$MN2_ActInit <- zone_df$MN2_InitAct * 1000 * zone_df$MC2_RelImpDeno
  
  # MN2_ActInitF[Zone] = MN2_ActInit[Zone]
  zone_df$MN2_ActInitF <- zone_df$MN2_ActInit
  
  # INIT MN2_SlwInit[Zone] = MN2_InitSlw[Zone]*1000*MC2_RelImpDeno[Zone]
  zone_df$MN2_SlwInit <- zone_df$MN2_InitSlw * 1000 * zone_df$MC2_RelImpDeno
  
  # MN2_SlwInitF[Zone] = MN2_SlwInit[Zone]
  zone_df$MN2_SlwInitF <- zone_df$MN2_SlwInit
  
  # INIT MN2_PassInit[Zone] = MN2_InitPassx[Zone]*1000*MC2_RelImpDeno[Zone]
  zone_df$MN2_PassInit <- zone_df$MN2_InitPassx * 1000 * zone_df$MC2_RelImpDeno
  
  # MN2_PassInitF[Zone] = MN2_PassInit[Zone]
  zone_df$MN2_PassInitF <- zone_df$MN2_PassInit
  
  # MN2_PassInitLayer[Zn1,1] = MN2_PassInitF[Zn1]*AF_DepthAct1[Zn1]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn1]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
  # MN2_PassInitLayer[Zn1,2] = MN2_PassInitF[Zn1]*AF_Depth2[Zn1]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn1]+0*(AF_Depth4[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn1,3] = MN2_PassInitF[Zn1]*AF_Depth3[Zn1]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn1]+0*(AF_Depth2[Zn4]+AF_Depth4[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn1,4] = MN2_PassInitF[Zn1]*AF_Depth4[Zn1]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn1]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn2,1] = MN2_PassInitF[Zn2]*AF_DepthAct1[Zn2]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn2]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
  # MN2_PassInitLayer[Zn2,2] = MN2_PassInitF[Zn2]*AF_Depth2[Zn2]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn2]+0*(AF_Depth4[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn2,3] = MN2_PassInitF[Zn2]*AF_Depth3[Zn2]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn2]+0*(AF_Depth4[Zn4]+AF_Depth2[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn2,4] = MN2_PassInitF[Zn2]*AF_Depth4[Zn2]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn2]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn3,1] = MN2_PassInitF[Zn3]*AF_DepthAct1[Zn3]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn3]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
  # MN2_PassInitLayer[Zn3,2] = MN2_PassInitF[Zn3]*AF_Depth2[Zn3]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn3]+0*(AF_Depth4[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn3,3] = MN2_PassInitF[Zn3]*AF_Depth3[Zn3]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn3]+0*(AF_Depth2[Zn4]+AF_Depth4[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn3,4] = MN2_PassInitF[Zn3]*AF_Depth4[Zn3]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn3]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn4,1] = MN2_PassInitF[Zn4]*AF_DepthAct1[Zn4]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn4]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
  # MN2_PassInitLayer[Zn4,2] = MN2_PassInitF[Zn4]*AF_Depth2[Zn4]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn4]+0*(AF_Depth4[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn4,3] = MN2_PassInitF[Zn4]*AF_Depth3[Zn4]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn4]+0*(AF_Depth2[Zn4]+AF_Depth4[Zn4]+AF_DepthAct1[Zn4])
  # MN2_PassInitLayer[Zn4,4] = MN2_PassInitF[Zn4]*AF_Depth4[Zn4]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn4]+0*(AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_DepthAct1[Zn4])
  zonelayer_df$MN2_PassInitF <- rep(zone_df$MN2_PassInitF, nlayer)
  zonelayer_df$MC2_RelImpDeno <- rep(zone_df$MC2_RelImpDeno, nlayer)
  zonelayer_df$MC2_SOMDist <- rep(layer_df$MC2_SOMDist, each = nzone)
  zonelayer_df$MN2_PassInitLayer <- zonelayer_df$MN2_PassInitF * zonelayer_df$AF_Depth * zonelayer_df$MC2_SOMDist /
    zonelayer_df$MC2_RelImpDeno
  
  # MN2_PassCorrectedLayer[Zone,SoilLayer] = MN2_PassInitLayer[Zone,SoilLayer]*MN2_PassRelLayer[SoilLayer]
  zonelayer_df$MN2_PassRelLayer <- rep(layer_df$MN2_PassRelLayer, each = nzone)
  zonelayer_df$MN2_PassCorrectedLayer <- zonelayer_df$MN2_PassInitLayer * zonelayer_df$MN2_PassRelLayer
  
  # MN2_DeltaPassSum[Zone] = ARRAYSUM(MN2_PassCorrectedLayer[Zone,*])-ARRAYSUM(MN2_PassInitLayer[Zone,*])
  zone_df$MN2_DeltaPassSum <- aggregate(zonelayer_df["MN2_PassCorrectedLayer"], zonelayer_df["zone"], sum)$MN2_PassCorrectedLayer -
    aggregate(zonelayer_df["MN2_PassInitLayer"], zonelayer_df["zone"], sum)$MN2_PassInitLayer
  
  
  # MN2_ActCorrectedInit[Zone] = if MN2_ActInitF[Zone] and MN2_SlwInitF[Zone] > 0 then MN2_ActInitF[Zone]-(MN2_DeltaPassSum[Zone]*MN2_ActInitF[Zone]/(MN2_ActInitF[Zone]+MN2_SlwInitF[Zone])) else 0
  zone_df$MN2_ActCorrectedInit <- ifelse(
    zone_df$MN2_ActInitF & zone_df$MN2_SlwInitF > 0,
    zone_df$MN2_ActInitF - (
      zone_df$MN2_DeltaPassSum * zone_df$MN2_ActInitF / (zone_df$MN2_ActInitF + zone_df$MN2_SlwInitF)
    ),
    0
  )
  
  # INIT MC2_Act[Zone,SoilLayer] = if MC2_SomInitType = 1 then (MN2_ActCorrectedInit[Zone])*MN_CNAct else 0.03 * 10000*MC2_CorgInit*MC2_RelImpDeno[Zone]/MC2_SOMDist[1]
  zonelayer_df$MC2_Act <- ifelse(
    MC2_SomInitType == 1,
    (zone_df$MN2_ActCorrectedInit) * MN_CNAct,
    0.03 * 10000 * MC2_CorgInit * zonelayer_df$MC2_RelImpDeno /
      layer_df$MC2_SOMDist[1]
  )
  
  # MN2_SlwCorrectedInit[Zone] = if MN2_SlwInitF[Zone] and MN2_ActInitF[Zone] > 0 then MN2_SlwInitF[Zone]-(MN2_DeltaPassSum[Zone]*MN2_SlwInitF[Zone]/(MN2_SlwInitF[Zone]+MN2_ActInitF[Zone])) else 0
  zone_df$MN2_SlwCorrectedInit <- ifelse(
    zone_df$MN2_SlwInitF &
      zone_df$MN2_ActInitF > 0,
    zone_df$MN2_SlwInitF - (
      zone_df$MN2_DeltaPassSum * zone_df$MN2_SlwInitF / (zone_df$MN2_SlwInitF + zone_df$MN2_ActInitF)
    ),
    0
  )
  
  # MC2_CSlowFrac = GRAPH(if MC2_SomInitType= 3 then MC2_CorgInitMeth3/MC2_CrefMeth3 else MC2_CorgpCref)
  MC2_x <- ifelse(MC2_SomInitType == 3,
                  MC2_CorgInitMeth3 / MC2_CrefMeth3,
                  MC2_CorgpCref)
  MC2_CSlowFrac <- get_y_df(MC2_x, "MC2_CSlowFrac")
  
  # INIT MC2_Slw[Zone,SoilLayer] = if MC2_SomInitType = 1 then (MN2_SlwCorrectedInit[Zone])*MN_CNSlw else (MC2_CSlowFrac )* 10000*MC2_CorgInit*MC2_RelImpDeno[Zone]/MC2_SOMDist[1]
  zone_df$MC2_Slw <- ifelse(
    MC2_SomInitType == 1,
    zone_df$MN2_SlwCorrectedInit * MN_CNSlw,
    (MC2_CSlowFrac) * 10000 * MC2_CorgInit *
      zone_df$MC2_RelImpDeno / layer_df$MC2_SOMDist[1]
  )
  zonelayer_df$MC2_Slw <- rep(zone_df$MC2_Slw, nlayer)
  
  # MC2_Struc[Zone,SoilLayer] = if MC2_SomInitType = 1 then (MN2_InitStruc[Zone]*1000*MC2_RelImpDeno[Zone]/(MC2_SOMDist[1]))*MN_CNStruc  else 0.01 * 10000*MC2_CorgInit*MC2_RelImpDeno[Zone]/MC2_SOMDist[1]
  zone_df$MC2_Struc <- ifelse(
    MC2_SomInitType == 1,
    (
      zone_df$MN2_InitStruc * 1000 * zone_df$MC2_RelImpDeno / layer_df$MC2_SOMDist[1]
    ) * MN_CNStruc,
    0.01 * 10000 * MC2_CorgInit * zone_df$MC2_RelImpDeno /
      layer_df$MC2_SOMDist[1]
  )
  zonelayer_df$MC2_Struc <- rep(zone_df$MC2_Struc, nlayer)
  
  # MN2_PassCorrectedSumInit[Zone] = ARRAYSUM(MN2_PassCorrectedLayer[Zone,*])
  zone_df$MN2_PassCorrectedSumInit <- aggregate(zonelayer_df["MN2_PassCorrectedLayer"], zonelayer_df["zone"], sum)$MN2_PassCorrectedLayer
  
  # INIT MC2_Pass[Zone,SoilLayer] = if MC2_SomInitType = 1 then (MN2_PassCorrectedSumInit[Zone])*MN_CNPass else (1-0.05-MC2_CSlowFrac )* 10000*MC2_CorgInit*MC2_RelImpDeno[Zone]/MC2_SOMDist[1]
  zonelayer_df$MN2_PassCorrectedSumInit <- rep(zone_df$MN2_PassCorrectedSumInit, nlayer)
  zonelayer_df$MC2_RelImpDeno <- rep(zone_df$MC2_RelImpDeno, nlayer)
  zonelayer_df$MC2_Pass <- ifelse(
    MC2_SomInitType == 1,
    zonelayer_df$MN2_PassCorrectedSumInit * MN_CNPass,
    (1 - 0.05 - MC2_CSlowFrac) * 10000 * MC2_CorgInit *
      MC2_RelImpDeno[Zone] / layer_df$MC2_SOMDist[1]
  )
  
  # N_Unit[L1Zn1] = 1
  # N_Unit[L1Zn2] = 2
  # N_Unit[L1Zn3] = 3
  # N_Unit[L1Zn4] = 4
  # N_Unit[L2Zn1] = 5
  # N_Unit[L2Zn2] = 6
  # N_Unit[L2Zn3] = 7
  # N_Unit[L2Zn4] = 8
  # N_Unit[L3Zn1] = 9
  # N_Unit[L3Zn2] = 10
  # N_Unit[L3Zn3] = 11
  # N_Unit[L3Zn4] = 12
  # N_Unit[L4Zn1] = 13
  # N_Unit[L4Zn2] = 14
  # N_Unit[L4Zn3] = 15
  # N_Unit[L4Zn4] = 16
  zonelayer_df$N_Unit <- c(1:16)
  
  # N_Init[Init_N] = GRAPH(N_Unit[Init_N])
  # (1.00, 0.06), (2.00, 0.06), (3.00, 0.06), (4.00, 0.06), (5.00, 0.08), (6.00, 0.08), (7.00, 0.08), (8.00, 0.08), (9.00, 0.08), (10.0, 0.08), (11.0, 0.08), (12.0, 0.08), (13.0, 0.08), (14.0, 0.08), (15.0, 0.08), (16.0, 0.08)
  N_Init_df <- data.frame(
    N_Unit = c(1:16),
    N_Init = c(
      0.06,
      0.06,
      0.06,
      0.06,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08,
      0.08
    )
  )
  
  # N_NInit1[Zn1] = N_Init[L1Zn1]
  # N_NInit1[Zn2] = N_Init[L1Zn2]
  # N_NInit1[Zn3] = N_Init[L1Zn3]
  # N_NInit1[Zn4] = N_Init[L1Zn4]
  # N_Ninit2[Zn1] = N_Init[L2Zn1]
  # N_Ninit2[Zn2] = N_Init[L2Zn2]
  # N_Ninit2[Zn3] = N_Init[L2Zn3]
  # N_Ninit2[Zn4] = N_Init[L2Zn4]
  # N_NInit3[Zn1] = N_Init[L3Zn1]
  # N_NInit3[Zn2] = N_Init[L3Zn2]
  # N_NInit3[Zn3] = N_Init[L3Zn3]
  # N_NInit3[Zn4] = N_Init[L3Zn4]
  # N_NInit4[Zn1] = N_Init[L4Zn1]
  # N_NInit4[Zn2] = N_Init[L4Zn2]
  # N_NInit4[Zn3] = N_Init[L4Zn3]
  # N_NInit4[Zn4] = N_Init[L4Zn4]
  zonelayer_df$N_NInit <- N_Init_df$N_Init
  
  # N_PStParam[P_Param] = GRAPH(N_One[P_Param])
  # (1.00, 0.234), (2.00, 0.243), (3.00, 0.238), (4.00, 0.238), (5.00, 0.234), (6.00, 0.243), (7.00, 0.238), (8.00, 0.238), (9.00, 0.234), (10.0, 0.243), (11.0, 0.238), (12.0, 0.238), (13.0, 0.234), (14.0, 0.243), (15.0, 0.238), (16.0, 0.238), (17.0, 0.0005), (18.0, 0.0005), (19.0, 0.0005), (20.0, 0.0005), (21.0, 8.39), (22.0, 8.39), (23.0, 8.39), (24.0, 8.39)
  
  # N_PStParam_df <- data.frame(
  #   N_One = c(1:24),
  #   N_PStParam = c(0.234,0.243,0.238,0.238,0.234,0.243,0.238,0.238,0.234,0.243,0.238,0.238,0.234,0.243,0.238,0.238,5e-04,5e-04,5e-04,5e-04,8.39,8.39,8.39,8.39)
  # )
  
  N_PStParam_list <- as.list(
    c(
      0.234,
      0.243,
      0.238,
      0.238,
      0.234,
      0.243,
      0.238,
      0.238,
      0.234,
      0.243,
      0.238,
      0.238,
      0.234,
      0.243,
      0.238,
      0.238,
      5e-04,
      5e-04,
      5e-04,
      5e-04,
      8.39,
      8.39,
      8.39,
      8.39
    )
  )
  names(N_PStParam_list) <- Pinit_params
  
  zonelayer_df$N_PStParam <- unlist(N_PStParam_list[c(
    "Pinit11",
    "Pinit21",
    "Pinit31",
    "Pinit41",
    "Pinit12",
    "Pinit22",
    "Pinit32",
    "Pinit42",
    "Pinit13",
    "Pinit23",
    "Pinit33",
    "Pinit43",
    "Pinit14",
    "Pinit24",
    "Pinit34",
    "Pinit44"
  )])
  layer_df$PStMin <- unlist(N_PStParam_list[c("PStMin_1", "PStMin_2", "PStMin_3", "PStMin_4")])
  layer_df$PStMax <- unlist(N_PStParam_list[c("PStMax1", "PStMax2", "PStMax3", "PStMax4")])
  
  
  # N_Init1[Zn1,N] = N_NInit1[Zn1] + 0*N_PStParam[Pinit14]
  # N_Init1[Zn1,P] = 0*N_NInit1[Zn1]+N_PStParam[Pinit11]
  # N_Init1[Zn2,N] = N_NInit1[Zn2] + 0*N_PStParam[Pinit14]
  # N_Init1[Zn2,P] = 0*N_NInit1[Zn1]+N_PStParam[Pinit21]
  # N_Init1[Zn3,N] = N_NInit1[Zn3] + 0*N_PStParam[Pinit14]
  # N_Init1[Zn3,P] = 0*N_NInit1[Zn1]+N_PStParam[Pinit31]
  # N_Init1[Zn4,N] = N_NInit1[Zn2]+ 0*N_PStParam[Pinit14]
  # N_Init1[Zn4,P] = 0*N_NInit1[Zn1]+N_PStParam[Pinit41]
  # N_Init2[Zn1,N] = N_Ninit2[Zn1] + 0*N_PStParam[Pinit23]
  # N_Init2[Zn1,P] = N_PStParam[Pinit12]+0*N_Ninit2[Zn1]
  # N_Init2[Zn2,N] = N_Ninit2[Zn2] + 0*N_PStParam[Pinit23]
  # N_Init2[Zn2,P] = N_PStParam[Pinit22]+0*N_Ninit2[Zn1]
  # N_Init2[Zn3,N] = N_Ninit2[Zn3] + 0*N_PStParam[Pinit23]
  # N_Init2[Zn3,P] = N_PStParam[Pinit32]+0*N_Ninit2[Zn1]
  # N_Init2[Zn4,N] = N_Ninit2[Zn4] + 0*N_PStParam[Pinit23]
  # N_Init2[Zn4,P] = N_PStParam[Pinit42]+0*N_Ninit2[Zn1]
  # N_Init3[Zn1,N] = N_NInit3[Zn1]+ 0*N_PStParam[Pinit31]
  # N_Init3[Zn1,P] = N_PStParam[Pinit13]+0*N_NInit3[Zn4]
  # N_Init3[Zn2,N] = N_NInit3[Zn2] + 0*N_PStParam[Pinit31]
  # N_Init3[Zn2,P] = N_PStParam[Pinit23]+0*N_NInit3[Zn4]
  # N_Init3[Zn3,N] = N_NInit3[Zn3] + 0*N_PStParam[Pinit31]
  # N_Init3[Zn3,P] = N_PStParam[Pinit33]+0*N_NInit3[Zn4]
  # N_Init3[Zn4,N] = N_NInit3[Zn4]+ 0*N_PStParam[Pinit31]
  # N_Init3[Zn4,P] = N_PStParam[Pinit43]+0*N_NInit3[Zn4]
  # N_Init4[Zn1,N] = N_NInit4[Zn1]+0*N_PStParam[Pinit41]
  # N_Init4[Zn1,P] = N_PStParam[Pinit14]+0*N_NInit4[Zn1]
  # N_Init4[Zn2,N] = N_NInit4[Zn2]+0*N_PStParam[Pinit41]
  # N_Init4[Zn2,P] = N_PStParam[Pinit24]+0*N_NInit4[Zn1]
  # N_Init4[Zn3,N] = N_NInit4[Zn3]+0*N_PStParam[Pinit41]
  # N_Init4[Zn3,P] = 0*N_NInit4[Zn4]+N_PStParam[Pinit43]
  # N_Init4[Zn4,N] = N_NInit4[Zn4]+0*N_PStParam[Pinit41]
  # N_Init4[Zn4,P] = N_PStParam[Pinit44]+0*N_NInit4[Zn1]
  zonelayernut_df$N_Init <- NA
  zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Init"] <- zonelayer_df$N_NInit
  zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Init"] <- zonelayer_df$N_PStParam
  
  # INIT N_Stock1[Zone,SlNut] = N_Init1[Zone,SlNut]*AF_DepthAct1[Zone]*1000
  # INIT N_Stock2[Zone,SlNut] = max(0,N_Init2[Zone,SlNut]*AF_Depth2[Zone]*1000)
  # INIT N_Stock3[Zone,SlNut] = max(0,N_Init3[Zone,SlNut]*AF_Depth3[Zone]*1000)
  # INIT N_Stock4[Zone,SlNut] = N_Init4[Zone,SlNut]*AF_Depth4[Zone]*1000
  zonelayernut_df$AF_Depth <- rep(zonelayer_df$AF_Depth, nrow(nut_df))
  zonelayernut_df$N_Stock <- zonelayernut_df$N_Init * zonelayernut_df$AF_Depth *
    1000
  
  zonelayernut_df[zonelayernut_df$layer %in% c(2, 3), "N_Stock"] <- pmax(0, zonelayernut_df[zonelayernut_df$layer %in% c(2, 3), "N_Stock"])
  
  # INIT S&B_Topsoil_pH[Zone] = S&B_InitialpH
  zone_df$SB_Topsoil_pH <- SB_InitialpH
  
  # INIT RT_L1FRLength[Zone,Tree] = RT3_TL1FRInit[Zone,Tree]
  zonelayertree_df$RT_FRLength <- zonelayertree_df$RT3_TFRInit
  
  # INIT AF_DepthAvg1 = AF_ZoneFrac[Zn1]*AF_DepthAct1[Zn1]+AF_ZoneFrac[Zn2]*AF_DepthAct1[Zn2]+AF_ZoneFrac[Zn3]*AF_DepthAct1[Zn3]+AF_ZoneFrac[Zn4]*AF_DepthAct1[Zn4]
  # INIT AF_DepthAvg2 = AF_ZoneFrac[Zn1]*AF_Depth2[Zn1]+AF_ZoneFrac[Zn2]*AF_Depth2[Zn2]+AF_ZoneFrac[Zn3]*AF_Depth2[Zn3]+AF_ZoneFrac[Zn4]*AF_Depth2[Zn4]
  # INIT AF_DepthAvg3 = AF_ZoneFrac[Zn1]*AF_Depth3[Zn1]+AF_ZoneFrac[Zn2]*AF_Depth3[Zn2]+AF_ZoneFrac[Zn3]*AF_Depth3[Zn3]+AF_ZoneFrac[Zn4]*AF_Depth3[Zn4]
  # INIT AF_DepthAvg4 = AF_ZoneFrac[Zn1]*AF_Depth4[Zn1]+AF_ZoneFrac[Zn2]*AF_Depth4[Zn2]+AF_ZoneFrac[Zn3]*AF_Depth4[Zn3]+AF_ZoneFrac[Zn4]*AF_Depth4[Zn4]
  zonelayer_df$AF_Depth_Frac <- zonelayer_df$AF_ZoneFrac * zonelayer_df$AF_Depth
  layer_df$AF_DepthAvg <- aggregate(zonelayer_df["AF_Depth_Frac"], zonelayer_df["layer"], sum)$AF_Depth_Frac
  
  
  # INIT C_WeedSeedBank[Zone,PlantComp] = if AF_SimulateWeeds? = 1 then C_WeedSeedBankInit*C_UnitConv[PlantComp]*C_SeedConc[PlantComp] else 0
  zonepcomp_df$C_UnitConv <- rep(pcomp_df$C_UnitConv, each = nzone)
  zonepcomp_df$C_SeedConc <- rep(pcomp_df$C_SeedConc, each = nzone)
  zonepcomp_df$C_WeedSeedBank <- ifelse(
    AF_SimulateWeeds_is == 1,
    C_WeedSeedBankInit * zonepcomp_df$C_UnitConv * zonepcomp_df$C_SeedConc,
    0
  )
  
  
  # MC_ActResp = 0.85 - 0.68*MC_TextLitLayer
  MC_ActResp <- 0.85 - 0.68 * MC_TextLitLayer
  
  # MC_EffActSlw = (1-MC_ActResp-0.004)
  MC_EffActSlw <- (1 - MC_ActResp - 0.004)
  
  # INIT T_ExpRetToLab[Tree] = T_ExpRetThresh*1.5
  tree_df$T_ExpRetToLab <- T_ExpRetThresh * 1.5
  
  # INIT N_ImmobileNut1[Zone,SlNut] = N_ImInit1[Zone,SlNut]*AF_DepthAct1[Zone]*1000
  # INIT N_ImmobileNut2[Zone,SlNut] = N_ImInit2[Zone,SlNut]*AF_Depth2[Zone]*1000
  # INIT N_ImmobileNut3[Zone,SlNut] = N_ImInit3[Zone,SlNut]*AF_Depth3[Zone]*1000
  # INIT N_ImmobileNut4[Zone,SlNut] = N_ImInit4[Zone,SlNut]*AF_Depth4[Zone]*1000
  zonelayernut_df$N_ImmobileNut <- zonelayernut_df$N_ImInit * zonelayernut_df$AF_Depth *
    1000
  
  # RT3_Voxel_Tree_DistZn[Zn1,Sp1] = 0.5*AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn1,Sp2] = 0.5*AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn1,Sp3] = 0.5*AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn2,Sp1] = 0.5*AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn2,Sp2] = 0.5*AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn2,Sp3] = 0.5*AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn3,Sp1] = 0.5*AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn3,Sp2] = 0.5*AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn3,Sp3] = 0.5*AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn4,Sp1] = 0.5*AF_ZoneWidth[Zn4]+AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn4,Sp2] = 0.5*AF_ZoneWidth[Zn4]+AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  # RT3_Voxel_Tree_DistZn[Zn4,Sp3] = 0.5*AF_ZoneWidth[Zn4]+AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn1]
  RT3_Voxel_Tree_DistZn_Zn1 <- 0.5 * zone_df[zone_df$zone == 1, ]$AF_ZoneWidth
  RT3_Voxel_Tree_DistZn_Zn2 <- 0.5 * zone_df[zone_df$zone == 2, ]$AF_ZoneWidth + zone_df[zone_df$zone == 1, ]$AF_ZoneWidth
  RT3_Voxel_Tree_DistZn_Zn3 <- 0.5 * zone_df[zone_df$zone == 3, ]$AF_ZoneWidth + zone_df[zone_df$zone == 1, ]$AF_ZoneWidth + zone_df[zone_df$zone == 2, ]$AF_ZoneWidth
  RT3_Voxel_Tree_DistZn_Zn4 <- 0.5 * zone_df[zone_df$zone == 4, ]$AF_ZoneWidth + zone_df[zone_df$zone == 1, ]$AF_ZoneWidth + zone_df[zone_df$zone == 2, ]$AF_ZoneWidth + zone_df[zone_df$zone == 3, ]$AF_ZoneWidth
  
  # RT3_VoxTreeDist1[Tree,Zone] = ((                                                   0.5*AF_DepthAct1[Zone])^2+RT3_Voxel_Tree_DistZn[Zone,Tree]^2)^0.5
  # RT3_VoxTreeDist2[Tree,Zone] = ((AF_DepthAct1[Zone]+                                0.5*AF_Depth2[Zone])^2+RT3_Voxel_Tree_DistZn[Zone,Tree]^2)^0.5
  # RT3_VoxTreeDist3[Tree,Zone] = ((AF_DepthAct1[Zone]+AF_Depth2[Zone]+                0.5*AF_Depth3[Zone])^2+RT3_Voxel_Tree_DistZn[Zone,Tree]^2)^0.5
  # RT3_VoxTreeDist4[Tree,Zone] = ((AF_DepthAct1[Zone]+AF_Depth2[Zone]+AF_Depth3[Zone]+0.5*AF_Depth4[Zone])^2+RT3_Voxel_Tree_DistZn[Zone,Tree]^2)^0.5
  zonelayer_df$AF_Depth_cum <- 0
  zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth_cum <- zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth
  zonelayer_df[zonelayer_df$layer == 3, ]$AF_Depth_cum <- zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth + zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth
  zonelayer_df[zonelayer_df$layer == 4, ]$AF_Depth_cum <- zonelayer_df[zonelayer_df$layer == 1, ]$AF_Depth + zonelayer_df[zonelayer_df$layer == 2, ]$AF_Depth + zonelayer_df[zonelayer_df$layer == 3, ]$AF_Depth
  
  zonelayertree_df$RT3_Voxel_Tree_DistZn <- rep(
    c(
      RT3_Voxel_Tree_DistZn_Zn1,
      RT3_Voxel_Tree_DistZn_Zn2,
      RT3_Voxel_Tree_DistZn_Zn3,
      RT3_Voxel_Tree_DistZn_Zn4
    ),
    nlayer * ntree
  )
  
  zonelayertree_df$RT3_VoxTreeDist <- (rep((zonelayer_df$AF_Depth_cum + 0.5 * zonelayer_df$AF_Depth)^2,
                                           ntree
  ) + zonelayertree_df$RT3_Voxel_Tree_DistZn^2)^0.5
  
  # RT3_SumTransp1[Zone,Tree] = RT_L1FRLength[Zone,Tree]*RT3_VoxTreeDist1[Tree,Zone]*100
  # RT3_SumTransp2[Zone,Tree] = RT_L2FRLength[Zone,Tree]*RT3_VoxTreeDist2[Tree,Zone]*100
  # RT3_SumTransp3[Zone,Tree] = RT_L3FRLength[Zone,Tree]*RT3_VoxTreeDist3[Tree,Zone]*100
  # RT3_SumTransp4[Zone,Tree] = RT_L4FRLength[Zone,Tree]*RT3_VoxTreeDist4[Tree,Zone]*100
  zonelayertree_df$RT3_SumTransp <- zonelayertree_df$RT_FRLength * zonelayertree_df$RT3_VoxTreeDist *
    100
  
  # RT3_CRTarget[Tree] = (ARRAYSUM(RT3_SumTransp1[*,Tree])+ARRAYSUM(RT3_SumTransp2[*,Tree])+ARRAYSUM(RT3_SumTransp3[*,Tree])+ARRAYSUM(RT3_SumTransp4[*,Tree]))*RT3_CR_TargFac[Tree]
  tree_df$RT3_CRTarget <- aggregate(zonelayertree_df["RT3_SumTransp"], zonelayertree_df["tree_id"], sum)$RT3_SumTransp * tree_df$RT3_CR_TargFac
  
  # INIT RT3_CoarseRt[Tree] = RT3_CRTarget[Tree]
  tree_df$RT3_CoarseRt <- tree_df$RT3_CRTarget
  
  # INIT MN2_Metab[Zone,SoilLayer] = (MC2_Metab[Zone,SoilLayer]/MC2_CNRatInitMet[Zone])/MN_NutRatMetab[N]
  zonelayer_df$MN2_Metab <- (zonelayer_df$MC2_Metab / zonelayer_df$MC2_CNRatInitMet) /
    nut_df[nut_df$SlNut == "N", ]$MN_NutRatMetab
  
  # INIT MN2_Struc[Zone,SoilLayer] = (MC2_Struc[Zone,SoilLayer]/MN_CNStruc)/MN_NutRatStruc[N]
  zonelayer_df$MN2_Struc <- (zonelayer_df$MC2_Struc / MN_CNStruc) /
    nut_df[nut_df$SlNut == "N", "MN_NutRatStruc"]
  
  # INIT MN2_Act[Zone,SoilLayer] = MN2_ActCorrectedInit[Zone]/MN_NutRatAct[N]
  zonelayer_df$MN2_ActCorrectedInit <- rep(zone_df$MN2_ActCorrectedInit, nlayer)
  zonelayer_df$MN2_Act <- zonelayer_df$MN2_ActCorrectedInit / nut_df[nut_df$SlNut == "N", "MN_NutRatAct"]
  
  # INIT MN2_Slw[Zone,SoilLayer] = MN2_SlwCorrectedInit[Zone]/MN_NutRatSlw[N]
  zonelayer_df$MN2_SlwCorrectedInit <- rep(zone_df$MN2_SlwCorrectedInit, nlayer)
  zonelayer_df$MN2_Slw <- zonelayer_df$MN2_SlwCorrectedInit / nut_df[nut_df$SlNut == "N", "MN_NutRatSlw"]
  
  # INIT MN2_Pass[Zone,SoilLayer] = MN2_PassCorrectedSumInit[Zone]/MN_NutRatPas[N]
  zonelayer_df$MN2_Pass <- zonelayer_df$MN2_PassCorrectedSumInit / nut_df[nut_df$SlNut == "N", "MN_NutRatPas"]
  
  # INIT BC_SOMInit = (AF_ZoneFrac[Zn1]*
  #                      (MC_Act[Zn1]+MC_Metab[Zn1]+MC_Pass[Zn1]+MC_Slw[Zn1]+MC_Struc[Zn1]+ MC2_Act[Zn1,1]+
  #                         MC2_Metab[Zn1,1]+MC2_Pass[Zn1,1]+MC2_Slw[Zn1,1]+MC2_Struc[Zn1,1]+
  #                         MC2_Act[Zn1,2]+MC2_Metab[Zn1,2]+MC2_Pass[Zn1,2]+MC2_Slw[Zn1,2]+MC2_Struc[Zn1,2]+
  #                         MC2_Act[Zn1,3]+MC2_Metab[Zn1,3]+MC2_Pass[Zn1,3]+MC2_Slw[Zn1,3]+MC2_Struc[Zn1,3]+
  #                         MC2_Act[Zn1,4]+MC2_Metab[Zn1,4]+MC2_Pass[Zn1,4]+MC2_Slw[Zn1,4]+MC2_Struc[Zn1,4])+
  #                      AF_ZoneFrac[Zn2]*
  #                      (MC_Act[Zn2]+MC_Metab[Zn2]+MC_Pass[Zn2]+MC_Slw[Zn2]+MC_Struc[Zn2]+
  #                         MC2_Act[Zn2,1]+MC2_Metab[Zn2,1]+MC2_Pass[Zn2,1]+MC2_Slw[Zn2,1]+MC2_Struc[Zn2,1]+
  #                         MC2_Act[Zn2,2]+MC2_Metab[Zn2,2]+MC2_Pass[Zn2,2]+MC2_Slw[Zn2,2]+MC2_Struc[Zn2,2]+
  #                         MC2_Act[Zn2,3]+MC2_Metab[Zn2,3]+MC2_Pass[Zn2,3]+MC2_Slw[Zn2,3]+MC2_Struc[Zn2,3]+
  #                         MC2_Act[Zn2,4]+MC2_Metab[Zn2,4]+MC2_Pass[Zn2,4]+MC2_Slw[Zn2,4]+MC2_Struc[Zn2,4])+
  #                      AF_ZoneFrac[Zn3]*
  #                      (MC_Act[Zn3]+MC_Metab[Zn3]+MC_Pass[Zn3]+MC_Slw[Zn3]+MC_Struc[Zn3]+
  #                         MC2_Act[Zn3,1]+MC2_Metab[Zn3,1]+MC2_Pass[Zn3,1]+MC2_Slw[Zn3,1]+MC2_Struc[Zn3,1]+
  #                         MC2_Act[Zn3,2]+MC2_Metab[Zn3,2]+MC2_Pass[Zn3,2]+MC2_Slw[Zn3,2]+MC2_Struc[Zn3,2]+
  #                         MC2_Act[Zn3,3]+MC2_Metab[Zn3,3]+MC2_Pass[Zn3,3]+MC2_Slw[Zn3,3]+MC2_Struc[Zn3,3]+
  #                         MC2_Act[Zn3,4]+MC2_Metab[Zn3,4]+MC2_Pass[Zn3,4]+MC2_Slw[Zn3,4]+MC2_Struc[Zn3,4])+
  #                      AF_ZoneFrac[Zn4]*
  #                      (MC_Act[Zn4]+MC_Metab[Zn4]+MC_Pass[Zn4]+MC_Slw[Zn4]+MC_Struc[Zn4]+
  #                         MC2_Act[Zn4,1]+MC2_Metab[Zn4,1]+MC2_Pass[Zn4,1]+MC2_Slw[Zn4,1]+MC2_Struc[Zn4,1]+
  #                         MC2_Act[Zn4,2]+MC2_Metab[Zn4,2]+MC2_Pass[Zn4,2]+MC2_Slw[Zn4,2]+MC2_Struc[Zn4,2]+
  #                         MC2_Act[Zn4,3]+MC2_Metab[Zn4,3]+MC2_Pass[Zn4,3]+MC2_Slw[Zn4,3]+MC2_Struc[Zn4,3]+
  #                         MC2_Act[Zn4,4]+MC2_Metab[Zn4,4]+MC2_Pass[Zn4,4]+MC2_Slw[Zn4,4]+MC2_Struc[Zn4,4]))
  zonelayer_df$MC2_sum <- zonelayer_df$MC2_Act + zonelayer_df$MC2_Metab +
    zonelayer_df$MC2_Pass + zonelayer_df$MC2_Slw + zonelayer_df$MC2_Struc
  BC_SOMInit <- sum(
    zone_df$AF_ZoneFrac * (
      zone_df$MC_Act + zone_df$MC_Metab + zone_df$MC_Pass + zone_df$MC_Slw + zone_df$MC_Struc + aggregate(zonelayer_df["MC2_sum"], zonelayer_df["zone"], sum)$MC2_sum
    )
  )
  
  # INIT BC_TreeInit = 1000*MC_Carbon*(T_LfTwig[DW,Sp1]+T_GroRes[DW,Sp1]+T_SapWood[DW,Sp1]+T_LfTwig[DW,Sp2]+T_GroRes[DW,Sp2]+T_SapWood[DW,Sp2]+T_LfTwig[DW,Sp3]+T_GroRes[DW,Sp3]+T_SapWood[DW,Sp3])
  t_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", ]
  BC_TreeInit <- 1000 * MC_Carbon * sum(t_DW$T_LfTwig + t_DW$T_GroRes +
                                          t_DW$T_SapWood)
  
  # INIT BC_TimeAvg_CStock = (BC_SOMInit+BC_TreeInit)
  BC_TimeAvg_CStock <- (BC_SOMInit + BC_TreeInit)
  
  # INIT BC_WeedSeedIn = if AF_SimulateWeeds? = 1 then 1000*MC_Carbon*C_WeedSeedBankInit else 0
  BC_WeedSeedIn <- ifelse(AF_SimulateWeeds_is == 1,
                          1000 * MC_Carbon * C_WeedSeedBankInit,
                          0)
  
  # C_RootPlComp[Zn1,DW] = ARRAYSUM(C_Root_DW[Zn1,*])+0*ARRAYSUM(C_Root_N[Zn1,*])+0*ARRAYSUM(C_Root_P[Zn1,*])
  # C_RootPlComp[Zn1,N] = 0*ARRAYSUM(C_Root_DW[Zn1,*])+ARRAYSUM(C_Root_N[Zn1,*])+0*ARRAYSUM(C_Root_P[Zn1,*])
  # C_RootPlComp[Zn1,P] = 0*ARRAYSUM(C_Root_DW[Zn1,*])+0*ARRAYSUM(C_Root_N[Zn1,*])+ARRAYSUM(C_Root_P[Zn1,*])
  # C_RootPlComp[Zn2,DW] = ARRAYSUM(C_Root_DW[Zn2,*])+0*ARRAYSUM(C_Root_N[Zn2,*])+0*ARRAYSUM(C_Root_P[Zn2,*])
  # C_RootPlComp[Zn2,N] = 0*ARRAYSUM(C_Root_DW[Zn2,*])+ARRAYSUM(C_Root_N[Zn2,*])+0*ARRAYSUM(C_Root_P[Zn2,*])
  # C_RootPlComp[Zn2,P] = 0*ARRAYSUM(C_Root_DW[Zn2,*])+0*ARRAYSUM(C_Root_N[Zn2,*])+ARRAYSUM(C_Root_P[Zn2,*])
  # C_RootPlComp[Zn3,DW] = ARRAYSUM(C_Root_DW[Zn3,*])+0*ARRAYSUM(C_Root_N[Zn3,*])+0*ARRAYSUM(C_Root_P[Zn3,*])
  # C_RootPlComp[Zn3,N] = 0*ARRAYSUM(C_Root_DW[Zn3,*])+ARRAYSUM(C_Root_N[Zn3,*])+0*ARRAYSUM(C_Root_P[Zn3,*])
  # C_RootPlComp[Zn3,P] = 0*ARRAYSUM(C_Root_DW[Zn3,*])+0*ARRAYSUM(C_Root_N[Zn3,*])+ARRAYSUM(C_Root_P[Zn3,*])
  # C_RootPlComp[Zn4,DW] = ARRAYSUM(C_Root_DW[Zn4,*])+0*ARRAYSUM(C_Root_N[Zn4,*])+0*ARRAYSUM(C_Root_P[Zn4,*])
  # C_RootPlComp[Zn4,N] = 0*ARRAYSUM(C_Root_DW[Zn4,*])+ARRAYSUM(C_Root_N[Zn4,*])+0*ARRAYSUM(C_Root_P[Zn4,*])
  # C_RootPlComp[Zn4,P] = 0*ARRAYSUM(C_Root_DW[Zn4,*])+0*ARRAYSUM(C_Root_N[Zn4,*])+ARRAYSUM(C_Root_P[Zn4,*])
  zonepcomp_df$C_RootPlComp <- aggregate(zonelayerpcomp_df["C_Root"], zonelayerpcomp_df[c("zone", "PlantComp")], sum)$C_Root
  
  # C_NRoot[Zn1,N] = C_RootPlComp[Zn1,N]
  # C_NRoot[Zn1,P] = C_RootPlComp[Zn1,P]
  # C_NRoot[Zn2,N] = C_RootPlComp[Zn2,N]
  # C_NRoot[Zn2,P] = C_RootPlComp[Zn2,P]
  # C_NRoot[Zn3,N] = C_RootPlComp[Zn3,N]
  # C_NRoot[Zn3,P] = C_RootPlComp[Zn3,P]
  # C_NRoot[Zn4,N] = C_RootPlComp[Zn4,N]
  # C_NRoot[Zn4,P] = C_RootPlComp[Zn4,P]
  zonenut_df$C_NRoot <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_RootPlComp"]
  
  # INIT BN_CBiomInit[SlNut] = AF_ZoneFrac[Zn1]*C_NRoot[Zn1,SlNut]+AF_ZoneFrac[Zn2]*C_NRoot[Zn2,SlNut]+AF_ZoneFrac[Zn3]*C_NRoot[Zn3,SlNut]+AF_ZoneFrac[Zn4]*C_NRoot[Zn4,SlNut]
  zonenut_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nrow(nut_df))
  nut_df$BN_CBiomInit <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$C_NRoot,
                                   zonenut_df["SlNut"],
                                   sum)[[2]]
  
  # INIT BN_ImmInit[SlNut] = AF_ZoneFrac[Zn1]*(N_ImmobileNut1[Zn1,SlNut]+N_ImmobileNut2[Zn1,SlNut]+N_ImmobileNut3[Zn1,SlNut]+N_ImmobileNut4[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(N_ImmobileNut1[Zn2,SlNut]+N_ImmobileNut2[Zn2,SlNut]+N_ImmobileNut3[Zn2,SlNut]+N_ImmobileNut4[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(N_ImmobileNut1[Zn3,SlNut]+N_ImmobileNut2[Zn3,SlNut]+N_ImmobileNut3[Zn3,SlNut]+N_ImmobileNut4[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(N_ImmobileNut1[Zn4,SlNut]+N_ImmobileNut2[Zn4,SlNut]+N_ImmobileNut3[Zn4,SlNut]+N_ImmobileNut4[Zn4,SlNut])
  zonenut_df$N_ImmobileNut_sum <- aggregate(zonelayernut_df["N_ImmobileNut"], zonelayernut_df[c("zone", "SlNut")], sum)$N_ImmobileNut
  nut_df$BN_ImmInit <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$N_ImmobileNut_sum,
                                 zonenut_df["SlNut"],
                                 sum)[[2]]
  
  # INIT BN_ImmPool[SlNut] = AF_ZoneFrac[Zn1]*(N_ImmobileNut1[Zn1,SlNut]+N_ImmobileNut2[Zn1,SlNut]+N_ImmobileNut3[Zn1,SlNut]+N_ImmobileNut4[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(N_ImmobileNut1[Zn2,SlNut]+N_ImmobileNut2[Zn2,SlNut]+N_ImmobileNut3[Zn2,SlNut]+N_ImmobileNut4[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(N_ImmobileNut1[Zn3,SlNut]+N_ImmobileNut2[Zn3,SlNut]+N_ImmobileNut3[Zn3,SlNut]+N_ImmobileNut4[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(N_ImmobileNut1[Zn4,SlNut]+N_ImmobileNut2[Zn4,SlNut]+N_ImmobileNut3[Zn4,SlNut]+N_ImmobileNut4[Zn4,SlNut])
  nut_df$BN_ImmPool <- nut_df$BN_ImmInit
  
  # INIT CENT2_LitMetStrInit[SlNut] = (MN_Struc[Zn1,SlNut]+MN_Metab[Zn1,SlNut])*AF_ZoneFrac[Zn1]+(MN_Struc[Zn2,SlNut]+MN_Metab[Zn2,SlNut])*AF_ZoneFrac[Zn2]+(MN_Struc[Zn3,SlNut]+MN_Metab[Zn3,SlNut])*AF_ZoneFrac[Zn3]+(MN_Struc[Zn4,SlNut]+MN_Metab[Zn4,SlNut])*AF_ZoneFrac[Zn4]
  nut_df$CENT2_LitMetStrInit <- aggregate(
    zonenut_df$AF_ZoneFrac * (zonenut_df$MN_Struc + zonenut_df$MN_Metab),
    zonenut_df["SlNut"],
    sum
  )[[2]]
  
  # INIT CENT2_LittPoolsInit[SlNut] = (MN_Act[Zn1,SlNut]+MN_Slw[Zn1,SlNut]+MN_Pass[Zn1,SlNut])*AF_ZoneFrac[Zn1]+(MN_Act[Zn2,SlNut]+MN_Slw[Zn2,SlNut]+MN_Pass[Zn2,SlNut])*AF_ZoneFrac[Zn2]+(MN_Act[Zn3,SlNut]+MN_Slw[Zn3,SlNut]+MN_Pass[Zn3,SlNut])*AF_ZoneFrac[Zn3]+(MN_Act[Zn4,SlNut]+MN_Slw[Zn4,SlNut]+MN_Pass[Zn4,SlNut])*AF_ZoneFrac[Zn4]
  nut_df$CENT2_LittPoolsInit <-  aggregate(
    zonenut_df$AF_ZoneFrac * (zonenut_df$MN_Act + zonenut_df$MN_Slw + zonenut_df$MN_Pass),
    zonenut_df["SlNut"],
    sum
  )[[2]]
  
  # INIT BN_LitInit[SlNut] = CENT2_LitMetStrInit[SlNut]+CENT2_LittPoolsInit[SlNut]
  nut_df$BN_LitInit <- nut_df$CENT2_LitMetStrInit + nut_df$CENT2_LittPoolsInit
  
  # INIT CENT2_SOMMetStrInit[N] = (MN2_Struc[Zn1,1]+MN2_Metab[Zn1,1]+MN2_Struc[Zn1,2]+MN2_Metab[Zn1,2]+MN2_Struc[Zn1,3]+MN2_Metab[Zn1,3]+MN2_Struc[Zn1,4]+MN2_Metab[Zn1,4])*AF_ZoneFrac[Zn1]+(MN2_Struc[Zn2,1]+MN2_Metab[Zn2,1]+MN2_Struc[Zn2,2]+MN2_Metab[Zn2,2]+MN2_Struc[Zn2,3]+MN2_Metab[Zn2,3]+MN2_Struc[Zn2,4]+MN2_Metab[Zn2,4])*AF_ZoneFrac[Zn2]+(MN2_Struc[Zn3,1]+MN2_Metab[Zn3,1]+MN2_Struc[Zn3,2]+MN2_Metab[Zn3,2]+MN2_Struc[Zn3,3]+MN2_Metab[Zn3,3]+MN2_Struc[Zn3,4]+MN2_Metab[Zn3,4])*AF_ZoneFrac[Zn3]+(MN2_Struc[Zn4,1]+MN2_Metab[Zn4,1]+MN2_Struc[Zn4,2]+MN2_Metab[Zn4,2]+MN2_Struc[Zn4,3]+MN2_Metab[Zn4,3]+MN2_Struc[Zn4,4]+MN2_Metab[Zn4,4])*AF_ZoneFrac[Zn4]
  # INIT CENT2_SOMMetStrInit[P] = ((MN2_Struc[Zn1,1]+MN2_Metab[Zn1,1]+ MN2_Struc[Zn1,2]+MN2_Metab[Zn1,2]+ MN2_Struc[Zn1,3]+MN2_Metab[Zn1,3]+ MN2_Struc[Zn1,4]+MN2_Metab[Zn1,4])*AF_ZoneFrac[Zn1]+(MN2_Struc[Zn2,1]+MN2_Metab[Zn2,1]+MN2_Struc[Zn2,2]+MN2_Metab[Zn2,2]+MN2_Struc[Zn2,3]+MN2_Metab[Zn2,3]+MN2_Struc[Zn2,4]+MN2_Metab[Zn2,4])*AF_ZoneFrac[Zn2]+(MN2_Struc[Zn3,1]+MN2_Metab[Zn3,1]+MN2_Struc[Zn3,2]+MN2_Metab[Zn3,2]+MN2_Struc[Zn3,3]+MN2_Metab[Zn3,3]+MN2_Struc[Zn3,4]+MN2_Metab[Zn3,4])*AF_ZoneFrac[Zn3]+(MN2_Struc[Zn4,1]+MN2_Metab[Zn4,1]+MN2_Struc[Zn4,2]+MN2_Metab[Zn4,2]+MN2_Struc[Zn4,3]+MN2_Metab[Zn4,3]+MN2_Struc[Zn4,4]+MN2_Metab[Zn4,4])*AF_ZoneFrac[Zn4])/10
  nut_df$CENT2_SOMMetStrInit <- sum(
    zone_df$AF_ZoneFrac * aggregate(
      zonelayer_df$MN2_Struc + zonelayer_df$MN2_Metab,
      zonelayer_df["zone"],
      sum
    )[[2]]
  )
  nut_df[nut_df$SlNut == "P", ]$CENT2_SOMMetStrInit <- nut_df[nut_df$SlNut == "N", ]$CENT2_SOMMetStrInit /
    10
  
  
  # INIT CENT2_SOMPoolsInit[N] = ((MN2_Act[Zn1,1]+MN2_Slw[Zn1,1]+MN2_Pass[Zn1,1] +MN2_Act[Zn1,2]+MN2_Slw[Zn1,2]+MN2_Pass[Zn1,2] +MN2_Act[Zn1,3]+MN2_Slw[Zn1,3]+MN2_Pass[Zn1,3] +MN2_Act[Zn1,4]+MN2_Slw[Zn1,4]+MN2_Pass[Zn1,4])*AF_ZoneFrac[Zn1]+(MN2_Act[Zn2,1]+MN2_Slw[Zn2,1]+MN2_Pass[Zn2,1] + MN2_Act[Zn2,2]+MN2_Slw[Zn2,2]+MN2_Pass[Zn2,2] + MN2_Act[Zn2,3]+MN2_Slw[Zn2,3]+MN2_Pass[Zn2,3] + MN2_Act[Zn2,4]+MN2_Slw[Zn2,4]+MN2_Pass[Zn2,4])*AF_ZoneFrac[Zn2]+(MN2_Act[Zn3,1]+MN2_Slw[Zn3,1]+MN2_Pass[Zn3,1] + MN2_Act[Zn3,2]+MN2_Slw[Zn3,2]+MN2_Pass[Zn3,2] + MN2_Act[Zn3,3]+MN2_Slw[Zn3,3]+MN2_Pass[Zn3,3] + MN2_Act[Zn3,4]+MN2_Slw[Zn3,4]+MN2_Pass[Zn3,4])*AF_ZoneFrac[Zn3]+(MN2_Act[Zn4,1]+MN2_Slw[Zn4,1]+MN2_Pass[Zn4,1] + MN2_Act[Zn4,2]+MN2_Slw[Zn4,2]+MN2_Pass[Zn4,2] + MN2_Act[Zn4,3]+MN2_Slw[Zn4,3]+MN2_Pass[Zn4,3]+ MN2_Act[Zn4,4]+MN2_Slw[Zn4,4]+MN2_Pass[Zn4,4])*AF_ZoneFrac[Zn4])
  # INIT CENT2_SOMPoolsInit[P] = ((MN2_Act[Zn1,1]+MN2_Slw[Zn1,1]+MN2_Pass[Zn1,1] +MN2_Act[Zn1,2]+MN2_Slw[Zn1,2]+MN2_Pass[Zn1,2] +MN2_Act[Zn1,3]+MN2_Slw[Zn1,3]+MN2_Pass[Zn1,3] +MN2_Act[Zn1,4]+MN2_Slw[Zn1,4]+MN2_Pass[Zn1,4])*AF_ZoneFrac[Zn1]+(MN2_Act[Zn2,1]+MN2_Slw[Zn2,1]+MN2_Pass[Zn2,1] + MN2_Act[Zn2,2]+MN2_Slw[Zn2,2]+MN2_Pass[Zn2,2] + MN2_Act[Zn2,3]+MN2_Slw[Zn2,3]+MN2_Pass[Zn2,3] + MN2_Act[Zn2,4]+MN2_Slw[Zn2,4]+MN2_Pass[Zn2,4])*AF_ZoneFrac[Zn2]+(MN2_Act[Zn3,1]+MN2_Slw[Zn3,1]+MN2_Pass[Zn3,1] + MN2_Act[Zn3,2]+MN2_Slw[Zn3,2]+MN2_Pass[Zn3,2] + MN2_Act[Zn3,3]+MN2_Slw[Zn3,3]+MN2_Pass[Zn3,3] + MN2_Act[Zn3,4]+MN2_Slw[Zn3,4]+MN2_Pass[Zn3,4])*AF_ZoneFrac[Zn3]+(MN2_Act[Zn4,1]+MN2_Slw[Zn4,1]+MN2_Pass[Zn4,1] + MN2_Act[Zn4,2]+MN2_Slw[Zn4,2]+MN2_Pass[Zn4,2] + MN2_Act[Zn4,3]+MN2_Slw[Zn4,3]+MN2_Pass[Zn4,3]+ MN2_Act[Zn4,4]+MN2_Slw[Zn4,4]+MN2_Pass[Zn4,4])*AF_ZoneFrac[Zn4])/10
  
  nut_df$CENT2_SOMPoolsInit <- sum(
    zone_df$AF_ZoneFrac * aggregate(
      zonelayer_df$MN2_Act + zonelayer_df$MN2_Slw + zonelayer_df$MN2_Pass,
      zonelayer_df["zone"],
      sum
    )[[2]]
  )
  nut_df[nut_df$SlNut == "P", ]$CENT2_SOMPoolsInit <- nut_df[nut_df$SlNut == "N", ]$CENT2_SOMPoolsInit /
    10
  
  # INIT BN_SOMInit[SlNut] = CENT2_SOMMetStrInit[SlNut]+CENT2_SOMPoolsInit[SlNut]
  nut_df$BN_SOMInit <- nut_df$CENT2_SOMMetStrInit + nut_df$CENT2_SOMPoolsInit
  
  # INIT BN_StockInit[N] = (1000*(N_Init1[Zn1,N]*AF_DepthAct1[Zn1]+N_Init2[Zn1,N]*AF_Depth2[Zn1]+N_Init3[Zn1,N]*AF_Depth3[Zn1]+N_Init4[Zn1,N]*AF_Depth4[Zn1])+MN_MinNutpool[Zn1,N]+MN2_MinNutpool[Zn1,1])*AF_ZoneFrac[Zn1]+
  #   (1000*(N_Init1[Zn2,N]*AF_DepthAct1[Zn2]+
  #            N_Init2[Zn2,N]*AF_Depth2[Zn2]+
  #            N_Init3[Zn2,N]*AF_Depth3[Zn2]+
  #            N_Init4[Zn2,N]*AF_Depth4[Zn2])+MN_MinNutpool[Zn2,N]+ MN2_MinNutpool[Zn2,1])*AF_ZoneFrac[Zn2]+
  #   (1000*(N_Init1[Zn3,N]*AF_DepthAct1[Zn3]+
  #            N_Init2[Zn3,N]*AF_Depth2[Zn3]+
  #            N_Init3[Zn3,N]*AF_Depth3[Zn3]+
  #            N_Init4[Zn3,N]*AF_Depth4[Zn3])+MN_MinNutpool[Zn3,N]+ MN2_MinNutpool[Zn3,1])*AF_ZoneFrac[Zn3]+
  #   (1000*(N_Init1[Zn4,N]*AF_DepthAct1[Zn4]+
  #            N_Init2[Zn4,N]*AF_Depth2[Zn4]+
  #            N_Init3[Zn4,N]*AF_Depth3[Zn4]+
  #            N_Init4[Zn4,N]*AF_Depth4[Zn4])+
  #      MN_MinNutpool[Zn4,N]+ MN2_MinNutpool[Zn4,1])*AF_ZoneFrac[Zn4]
  # INIT BN_StockInit[P] = (1000*(N_Init1[Zn1,P]*AF_DepthAct1[Zn1]+N_Init2[Zn1,P]*AF_Depth2[Zn1]+N_Init3[Zn1,P]*AF_Depth3[Zn1]+N_Init4[Zn1,P]*AF_Depth4[Zn1])+MN_MinNutpool[Zn1,P]+MP2_MinNutpool[Zn1,1])*AF_ZoneFrac[Zn1]+
  #   (1000*(N_Init1[Zn2,P]*AF_DepthAct1[Zn2]+
  #            N_Init2[Zn2,P]*AF_Depth2[Zn2]+
  #            N_Init3[Zn2,P]*AF_Depth3[Zn2]+
  #            N_Init4[Zn2,P]*AF_Depth4[Zn2])+MN_MinNutpool[Zn2,P]+ MP2_MinNutpool[Zn2,1])*AF_ZoneFrac[Zn2]+
  #   (1000*(N_Init1[Zn3,P]*AF_DepthAct1[Zn3]+
  #            N_Init2[Zn3,P]*AF_Depth2[Zn3]+
  #            N_Init3[Zn3,P]*AF_Depth3[Zn3]+
  #            N_Init4[Zn3,P]*AF_Depth4[Zn3])+MN_MinNutpool[Zn3,P]+ MP2_MinNutpool[Zn3,1])*AF_ZoneFrac[Zn3]+
  #   (1000*(N_Init1[Zn4,P]*AF_DepthAct1[Zn4]+
  #            N_Init2[Zn4,P]*AF_Depth2[Zn4]+
  #            N_Init3[Zn4,P]*AF_Depth3[Zn4]+
  #            N_Init4[Zn4,P]*AF_Depth4[Zn4])+
  #      MN_MinNutpool[Zn4,P]+ MP2_MinNutpool[Zn4,1])*AF_ZoneFrac[Zn4]
  zonelayernut_df$N_Init_depth <- (zonelayernut_df$N_Init * zonelayernut_df$AF_Depth)
  zonenut_df$N_Init_depth <- aggregate(zonelayernut_df["N_Init_depth"], zonelayernut_df[c("zone", "SlNut")], sum)$N_Init_depth
  zonenut_df$BN_StockInit_a <- (
    1000 * zonenut_df$N_Init_depth + zonenut_df$MN_MinNutpool +
      c(
        zonelayer_df[zonelayer_df$layer == 1, ]$MN2_MinNutpool,
        zonelayer_df[zonelayer_df$layer == 1, ]$MP2_MinNutpool
      )
  ) * zonenut_df$AF_ZoneFrac
  nut_df$BN_StockInit <- aggregate(zonenut_df["BN_StockInit_a"], zonenut_df["SlNut"], sum)$BN_StockInit_a
  
  # INIT BN_WeedSeedInit[N] = if AF_SimulateWeeds? = 1 then C_SeedConc[N]*C_UnitConv[N]*C_WeedSeedBankInit else 0
  # INIT BN_WeedSeedInit[P] = if AF_SimulateWeeds? = 1 then C_SeedConc[P]*C_UnitConv[P]*C_WeedSeedBankInit else 0
  nut_df$AF_SimulateWeeds_is <- AF_SimulateWeeds_is
  p_NP <- pcomp_df[pcomp_df$PlantComp %in% c("N", "P"), ]
  nut_df$BN_WeedSeedInit <- ifelse(
    nut_df$AF_SimulateWeeds_is == 1,
    p_NP$C_SeedConc * p_NP$C_UnitConv * C_WeedSeedBankInit,
    0
  )
  
  # E_BulkDens = S_SoilProp[BDLayer1]*1000
  E_BulkDens <- layer_df$W_BDLayer[1] * 1000
  
  # INIT BS_SoilCurrZn[Zone] = E_BulkDens*AF_DepthAct1[Zone]
  zone_df$BS_SoilCurrZn <- E_BulkDens * zone_df$AF_DepthAct1
  
  # INIT BS_SoilInitZn[Zone] = E_BulkDens*AF_DepthAct1[Zone]
  zone_df$BS_SoilInitZn <- E_BulkDens * zone_df$AF_DepthAct1
  
  # INIT BW_StockInit = (W_Stock1[Zn1]+W_Stock2[Zn1]+W_Stock3[Zn1]+W_Stock4[Zn1])*AF_ZoneFrac[Zn1]+(W_Stock1[Zn2]+W_Stock2[Zn2]+W_Stock3[Zn2]+W_Stock4[Zn2])*AF_ZoneFrac[Zn2]+(W_Stock1[Zn3]+W_Stock2[Zn3]+W_Stock3[Zn3]+W_Stock4[Zn3])*AF_ZoneFrac[Zn3]+(W_Stock1[Zn4]+W_Stock2[Zn4]+W_Stock3[Zn4]+W_Stock4[Zn4])*AF_ZoneFrac[Zn4]
  BW_StockInit <- sum(aggregate(zonelayer_df$W_Stock, zonelayer_df["zone"], sum)[[2]] * zone_df$AF_ZoneFrac)
  
  # INIT CENT_StockInit[SlNut] = N_Stock1[Zn1,SlNut]*AF_ZoneFrac[Zn1]+N_Stock1[Zn2,SlNut]*AF_ZoneFrac[Zn2]+N_Stock1[Zn3,SlNut]*AF_ZoneFrac[Zn3]+N_Stock1[Zn4,SlNut]*AF_ZoneFrac[Zn4]
  nut_df$CENT_StockInit <- aggregate(zonenut_df$AF_ZoneFrac * zonelayernut_df[zonelayernut_df$layer == 1, "N_Stock"],
                                     zonenut_df["SlNut"],
                                     sum)[[2]]
  
  # INIT MP2_Act[Zone,SoilLayer] = MN2_ActCorrectedInit[Zone]/MN_NutRatAct[P]
  zonelayer_df$MP2_Act <- rep(zone_df$MN2_ActCorrectedInit / nut_df[nut_df$SlNut == "P", "MN_NutRatAct"], nlayer)
  
  # INIT MP2_Metab[Zone,SoilLayer] = (MC2_Metab[Zone,SoilLayer]/MC2_CNRatInitMet[Zone])/MN_NutRatMetab[P]
  zonelayer_df$MP2_Metab <- (zonelayer_df$MC2_Metab / zonelayer_df$MC2_CNRatInitMet) /
    nut_df[nut_df$SlNut == "P", ]$MN_NutRatMetab
  
  # INIT MP2_Pass[Zone,SoilLayer] = MN2_PassCorrectedSumInit[Zone]/MN_NutRatPas[P]
  zonelayer_df$MP2_Pass <- rep(zone_df$MN2_PassCorrectedSumInit / nut_df[nut_df$SlNut == "P", "MN_NutRatPas"],
                               nlayer)
  
  # INIT MP2_Slw[Zone,SoilLayer] = MN2_SlwCorrectedInit[Zone]/MN_NutRatSlw[P]
  zonelayer_df$MP2_Slw <- rep(zone_df$MN2_SlwCorrectedInit / nut_df[nut_df$SlNut == "P", "MN_NutRatSlw"], nlayer)
  
  # INIT MP2_Struc[Zone,SoilLayer] = (MC2_Struc[Zone,SoilLayer]/MN_CNStruc)/MN_NutRatStruc[P]
  zonelayer_df$MP2_Struc <- (zonelayer_df$MC2_Struc / MN_CNStruc) /
    nut_df[nut_df$SlNut == "P", "MN_NutRatStruc"]
  
  # INIT P_NPV[PriceType] = P_Initial_NPV
  price_df$P_NPV <- price_df$P_Initial_NPV
  
  PFAll <- as.list(get_y_df(1:length(PF_UnitAll), "PFAll"))
  names(PFAll) <- PF_UnitAll
  
  # P_PriceFert[N,Private] = P_ParamAll[FertNP]
  # P_PriceFert[N,Social] = P_ParamAll[FertNS]
  # P_PriceFert[P,Private] = P_ParamAll[FertPP]
  # P_PriceFert[P,Social] = P_ParamAll[FertPS
  nutprice_df$P_PriceFert <- c(PFAll$FertNP, PFAll$FertPP, PFAll$FertNS, PFAll$FertPS)
  
  # P_CPestContPrice[Private] = P_ParamAll[PestP]
  # P_CPestContPrice[Social] = P_ParamAll[PestS]
  price_df$P_CPestContPrice <- c(PFAll$PestP, PFAll$PestS)
  
  PF_UnitCrop_df <- as.data.frame(t(matrix(
    get_y_df(1:length(PF_UnitCrop), "PFCrop"), nrow = length(PF_UnitCrop)
  )))
  names(PF_UnitCrop_df) <- PF_UnitCrop
  PF_UnitCrop_df$crop_id <- 1:5
  
  PF_UnitTree_df <- as.data.frame(t(matrix(
    get_y_df(1:length(PF_UnitTree), "PFTree"), nrow = length(PF_UnitTree)
  )))
  names(PF_UnitTree_df) <- PF_UnitTree
  PF_UnitTree_df$tree_id <- 1:3
  
  
  # P_UnitLabCost[Private] = P_ParamAll[UnitLabP]
  # P_UnitLabCost[Social] = P_ParamAll[LabUnitS]
  price_df$P_UnitLabCost <- c(PFAll$UnitLabP, PFAll$LabUnitS)
  
  P_2DayAfterCropharv <- P_CropHarvMarker
  
  # P_TPlantLab[Sp1] = P_ParamT1[Plantlab]+0*P_ParamT2[Plantlab]+0*P_ParamT3[Plantlab]
  # P_TPlantLab[Sp2] = 0*P_ParamT1[Plantlab]+P_ParamT2[Plantlab]+0*P_ParamT3[Plantlab]
  # P_TPlantLab[Sp3] = 0*P_ParamT1[Plantlab]+0*P_ParamT2[Plantlab]+P_ParamT3[Plantlab]
  tree_df$P_TPlantLab <- PF_UnitTree_df$Plantlab
  
  # P_TPrunLab[Sp1] = P_ParamT1[PrunLab]+0*P_ParamT2[PrunLab]+0*P_ParamT3[PrunLab]
  # P_TPrunLab[Sp2] = 0*P_ParamT1[PrunLab]+P_ParamT2[PrunLab]+0*P_ParamT3[PrunLab]
  # P_TPrunLab[Sp3] = 0*P_ParamT1[PrunLab]+0*P_ParamT2[PrunLab]+P_ParamT3[PrunLab]
  tree_df$P_TPrunLab <- PF_UnitTree_df$PrunLab
  
  # P_TWoodHarvLab[Sp1] = P_ParamT1[Woodlab]+0*P_ParamT2[Woodlab]+0*P_ParamT3[Woodlab]
  # P_TWoodHarvLab[Sp2] = 0*P_ParamT1[Woodlab]+P_ParamT2[Woodlab]+0*P_ParamT3[Woodlab]
  # P_TWoodHarvLab[Sp3] = 0*P_ParamT1[Woodlab]+0*P_ParamT2[Woodlab]+P_ParamT3[Woodlab]
  tree_df$P_TWoodHarvLab <- PF_UnitTree_df$Woodlab
  
  # P_TFruitHarvLab[Sp1] = P_ParamT1[FruitLab]+0*P_ParamT2[FruitLab]+0*P_ParamT3[FruitLab]
  # P_TFruitHarvLab[Sp2] = 0*P_ParamT1[FruitLab]+P_ParamT2[FruitLab]+0*P_ParamT3[FruitLab]
  # P_TFruitHarvLab[Sp3] = 0*P_ParamT1[FruitLab]+0*P_ParamT2[FruitLab]+P_ParamT3[FruitLab]
  tree_df$P_TFruitHarvLab <- PF_UnitTree_df$FruitLab
  
  # P_BurnLab = P_ParamAll[BurnLab]
  P_BurnLab <- PFAll$BurnLab
  
  # P_TLatexHarvLab[Sp1] = P_ParamT1[LatexLab]+0*P_ParamT2[LatexLab]+0*P_ParamT3[LatexLab]
  # P_TLatexHarvLab[Sp2] = 0*P_ParamT1[LatexLab]+P_ParamT2[LatexLab]+0*P_ParamT3[LatexLab]
  # P_TLatexHarvLab[Sp3] = 0*P_ParamT1[LatexLab]+0*P_ParamT2[LatexLab]+P_ParamT3[LatexLab]
  tree_df$P_TLatexHarvLab <- PF_UnitTree_df$LatexLab
  
  # P_TFertLab[Sp1] = P_ParamT1[FertLab]+0*(P_ParamT2[FertLab]+P_ParamT3[FertLab])
  # P_TFertLab[Sp2] = P_ParamT2[FertLab]+0*(P_ParamT1[FertLab]+P_ParamT3[FertLab])
  # P_TFertLab[Sp3] = P_ParamT3[FertLab]+0*(P_ParamT2[FertLab]+P_ParamT1[FertLab])
  tree_df$P_TFertLab <- PF_UnitTree_df$FertLab
  
  # P_DiscountRate = P_ParamAll[Discrate]
  P_DiscountRate <- PFAll$Discrate
  
  # P_FenceMatCost[Private] = P_ParamAll[FenceP]
  # P_FenceMatCost[Social] = P_ParamAll[FenceS]
  price_df$P_FenceMatCost <- c(PFAll$FenceP, PFAll$FenceS)
  
  # P_TFruitPrice[Private,Sp1] = P_ParamT1[FruitP]+0*P_ParamT2[FruitP]+0*P_ParamT3[FruitP]
  # P_TFruitPrice[Private,Sp2] = 0*P_ParamT1[FruitP]+P_ParamT2[FruitP]+0*P_ParamT3[FruitP]
  # P_TFruitPrice[Private,Sp3] = 0*P_ParamT1[FruitP]+0*P_ParamT2[FruitP]+P_ParamT3[FruitP]
  # P_TFruitPrice[Social,Sp1] = P_ParamT1[FruitS]+0*P_ParamT2[FruitS]+0*P_ParamT3[FruitS]
  # P_TFruitPrice[Social,Sp2] = 0*P_ParamT1[FruitS]+P_ParamT2[FruitS]+0*P_ParamT3[FruitS]
  # P_TFruitPrice[Social,Sp3] = 0*P_ParamT1[FruitS]+0*P_ParamT2[FruitS]+P_ParamT3[FruitS]
  treeprice_df$P_TFruitPrice <- c(PF_UnitTree_df$FruitP, PF_UnitTree_df$FruitS)
  
  # P_TLatexPrice[Private,Sp1] = P_ParamT1[LatexP]+0*P_ParamT2[LatexP]+0*P_ParamT3[LatexP]
  # P_TLatexPrice[Private,Sp2] = 0*P_ParamT1[LatexP]+P_ParamT2[LatexP]+0*P_ParamT3[LatexP]
  # P_TLatexPrice[Private,Sp3] = 0*P_ParamT1[LatexP]+0*P_ParamT2[LatexP]+P_ParamT3[LatexP]
  # P_TLatexPrice[Social,Sp1] = P_ParamT1[LatexS]+0*P_ParamT2[LatexS]+0*P_ParamT3[LatexS]
  # P_TLatexPrice[Social,Sp2] = 0*P_ParamT1[LatexS]+P_ParamT2[LatexS]+0*P_ParamT3[LatexS]
  # P_TLatexPrice[Social,Sp3] = 0*P_ParamT1[LatexS]+0*P_ParamT2[LatexS]+P_ParamT3[LatexS]
  treeprice_df$P_TLatexPrice <- c(PF_UnitTree_df$LatexP, PF_UnitTree_df$LatexS)
  
  # P_TPrunPrice[Private,Sp1] = P_ParamT1[PrunP]+0*P_ParamT2[PrunP]+0*P_ParamT3[PrunP]
  # P_TPrunPrice[Private,Sp2] = 0*P_ParamT1[PrunP]+P_ParamT2[PrunP]+0*P_ParamT3[PrunP]
  # P_TPrunPrice[Private,Sp3] = 0*P_ParamT1[PrunP]+0*P_ParamT2[PrunP]+P_ParamT3[PrunP]
  # P_TPrunPrice[Social,Sp1] = P_ParamT1[PrunS]+0*P_ParamT2[PrunS]+0*P_ParamT3[PrunS]
  # P_TPrunPrice[Social,Sp2] = 0*P_ParamT1[PrunS]+P_ParamT2[PrunS]+0*P_ParamT3[PrunS]
  # P_TPrunPrice[Social,Sp3] = 0*P_ParamT1[PrunS]+0*P_ParamT2[PrunS]+P_ParamT3[PrunS]
  treeprice_df$P_TPrunPrice <- c(PF_UnitTree_df$PrunP, PF_UnitTree_df$PrunS)
  
  # P_TWoodPrice[Private,Sp1] = P_ParamT1[WoodP]+0*P_ParamT2[WoodP]+0*P_ParamT3[WoodP]
  # P_TWoodPrice[Private,Sp2] = 0*P_ParamT1[WoodP]+P_ParamT2[WoodP]+0*P_ParamT3[WoodP]
  # P_TWoodPrice[Private,Sp3] = 0*P_ParamT1[WoodP]+0*P_ParamT2[WoodP]+P_ParamT3[WoodP]
  # P_TWoodPrice[Social,Sp1] = P_ParamT1[WoodS]+0*P_ParamT2[WoodS]+0*P_ParamT3[WoodS]
  # P_TWoodPrice[Social,Sp2] = 0*P_ParamT1[WoodS]+P_ParamT2[WoodS]+0*P_ParamT3[WoodS]
  # P_TWoodPrice[Social,Sp3] = 0*P_ParamT1[WoodS]+0*P_ParamT2[WoodS]+P_ParamT3[WoodS]
  treeprice_df$P_TWoodPrice <- c(PF_UnitTree_df$WoodP, PF_UnitTree_df$WoodS)
  
  # P_TSeedPrice[Private,Sp1] = P_ParamT1[SeedP]+0*P_ParamT2[SeedP]+0*P_ParamT3[SeedP]
  # P_TSeedPrice[Private,Sp2] = 0*P_ParamT1[SeedP]+P_ParamT2[SeedP]+0*P_ParamT3[SeedP]
  # P_TSeedPrice[Private,Sp3] = 0*P_ParamT1[SeedP]+0*P_ParamT2[SeedP]+P_ParamT3[SeedP]
  # P_TSeedPrice[Social,Sp1] = P_ParamT1[SeedS]+0*P_ParamT2[SeedS]+0*P_ParamT3[SeedS]
  # P_TSeedPrice[Social,Sp2] = 0*P_ParamT1[SeedS]+P_ParamT2[SeedS]+0*P_ParamT3[SeedS]
  # P_TSeedPrice[Social,Sp3] = 0*P_ParamT1[SeedS]+0*P_ParamT2[SeedS]+P_ParamT3[SeedS]
  treeprice_df$P_TSeedPrice <- c(PF_UnitTree_df$SeedP, PF_UnitTree_df$SeedS)
  
  
  zonetree_df$AF_ZoneTree <- rep(zone_df$AF_ZoneTree, nrow(tree_df))
  zonetree_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nrow(tree_df))
  zonetree_df$T_TreeinZone <- rep(zone_df$T_TreeinZone, nrow(tree_df))
  zonetree_df$AF_TreePosit <- rep(tree_df$AF_TreePosit, each = nzone)
  zonetree_df$T_RelPosinZone <- rep(tree_df$T_RelPosinZone, each = nzone)
  
  
  # INIT T_PrunWeighTot[Tree] = T_PrunWeight[Zn1,Tree]*AF_ZoneFrac[Zn1]+T_PrunWeight[Zn2,Tree]*AF_ZoneFrac[Zn2]+T_PrunWeight[Zn3,Tree]*AF_ZoneFrac[Zn3]+T_PrunWeight[Zn4,Tree]*AF_ZoneFrac[Zn4]
  zonetree_df$T_PrunWeighTot_a <- zonetree_df$T_PrunWeight * zonetree_df$AF_ZoneFrac
  tree_df$T_PrunWeighTot <- aggregate(zonetree_df["T_PrunWeighTot_a"], zonetree_df["tree_id"], sum)$T_PrunWeighTot_a
  tree_df$T_PrunWeigh_sum <- aggregate(zonetree_df["T_PrunWeight"], zonetree_df["tree_id"], sum)$T_PrunWeight
  zonetree_df$T_PrunWeighTot <- rep(tree_df$T_PrunWeighTot, each = nzone)
  zonetree_df$T_PrunWeigh_sum <- rep(tree_df$T_PrunWeigh_sum, each = nzone)
  
  # INIT T_LifallWeightTot[Zone,Tree] = T_LifallWeight[Zn1,Tree]*AF_ZoneFrac[Zn1]+T_LifallWeight[Zn2,Tree]*AF_ZoneFrac[Zn2]+T_LifallWeight[Zn3,Tree]*AF_ZoneFrac[Zn3]+T_LifallWeight[Zn4,Tree]*AF_ZoneFrac[Zn4]
  zonetree_df$T_LifallWeightTot_a <- zonetree_df$T_LifallWeight * zonetree_df$AF_ZoneFrac
  tree_df$T_LifallWeightTot <- aggregate(zonetree_df["T_LifallWeightTot_a"], zonetree_df["tree_id"], sum)$T_LifallWeightTot_a
  zonetree_df$T_LifallWeightTot <- rep(tree_df$T_LifallWeightTot, each = nzone)
  
  # T_BiomAG[PlantComp,Tree] = T_LfTwig[PlantComp,Tree]+T_SapWood[PlantComp,Tree]+T_GroRes[PlantComp,Tree]
  treepcomp_df$T_BiomAG <- treepcomp_df$T_LfTwig + treepcomp_df$T_SapWood + treepcomp_df$T_GroRes
  
  # INIT T_SapWoodEqDiam[Tree] = if (T_DiamSlopeBiom[Tree]>0  and T_Treesperha[Tree]*T_DiamBiom1[Tree]>0  )then (T_BiomAG[DW,Tree]*10000/(T_Treesperha[Tree]*T_DiamBiom1[Tree]))^(1/T_DiamSlopeBiom[Tree]) else 0
  tree_df$T_SapWoodEqDiam <- ifelse(
    tree_df$T_DiamSlopeBiom > 0  &
      tree_df$T_Treesperha * tree_df$T_DiamBiom1 > 0 ,
    (
      treepcomp_df[treepcomp_df$PlantComp == "DW", "T_BiomAG"] * 10000 / (tree_df$T_Treesperha * tree_df$T_DiamBiom1)
    )^(1 / tree_df$T_DiamSlopeBiom),
    0
  )
  
  tree_df$T_PlantY <- apply(tree_df[c("T_Compl", "tree_id")], 1, function(x) {
    get_graph_y(T_PlantY_df,
                x["T_Compl"],
                y_column = names(T_PlantY_df)[x["tree_id"]],
                mode = "discrete")
  })
  
  tree_df$T_PlantDoY <- apply(tree_df[c("T_Compl", "tree_id")], 1, function(x) {
    get_graph_y(T_PlantDoY_df,
                x["T_Compl"],
                y_column = names(T_PlantDoY_df)[x["tree_id"]],
                mode = "discrete")
  })
  
  
  CA_DOYStart <- 1
  
  # T_PlantTime[Tree] = T_PlantDoY[Tree] + 365* (T_PlantY[Tree])-CA_DOYStart
  tree_df$T_PlantTime <- tree_df$T_PlantDoY + 365 * (tree_df$T_PlantY) -   CA_DOYStart
  
  # INIT TF_LeafTime[Tree] = T_PlantTime[Tree]
  tree_df$TF_LeafTime <- tree_df$T_PlantTime
  
  # INIT TF_LeaffallTime[Tree] = T_PlantTime[Tree]
  tree_df$TF_LeaffallTime <- tree_df$T_PlantTime
  
  RAIN_Yesterday <- 0
  
  ## LOOP ##########################
  time <- 366
  pb <- progress_bar$new(format = "[:bar] :percent [Elapsed: :elapsedfull | Eta: :eta]",
                         total = n_iteration, clear = F)
                         # complete = "=",   # Completion bar character
                         # incomplete = "-", # Incomplete bar character
                         # current = ">",    # Current bar character
                         # clear = FALSE,    # If TRUE, clears the bar when finish
                         # width = 100)      # Width of the progress bar
  
  
  for (time in 1:n_iteration) {

    pb$tick()
    
    Rain <- get_rain(
      time,
      RAIN_pars$RAIN_par,
      RAIN_pars$RAIN_month_par,
      RAIN_pars$RAIN_graph,
      rain_df,
      RAIN_Yesterday,
      CA_DOYStart = CA_DOYStart
    )
    RAIN_Yesterday <- Rain > 0
    W_Irrigation_Data <- irrigation_df[irrigation_df$day == (time %% 365 + 1), ]$irrigation
    
    # LF_H2MaxDailyFlow[Zone] = W_KSatH2[Zone]*(AF_SlopeSoilHoriz/100)*AF_Depth2[Zone]
    # LF_H3MaxDailyFlow[Zone] = W_KSatH3[Zone]*(AF_SlopeSoilHoriz/100)*AF_Depth3[Zone]
    # LF_H4MaxDailyFlow[Zone] = W_KSatH4[Zone]*(AF_SlopeSoilHoriz/100)*AF_Depth4[Zone]
    zonelayer_df$LF_HMaxDailyFlow <- zonelayer_df$W_KSatH * (AF_SlopeSoilHoriz /
                                                               100) * zonelayer_df$AF_Depth
    
    # LF_H1MaxMailyFlow[Zn1] = (W_KSatH1[Zn1]*AF_DepthAct1[Zn4]*AF_SlopeSoilHoriz/100)
    # LF_H1MaxMailyFlow[Zn2] = (W_KSatH1[Zn2]*(AF_DepthAct1[Zn2]+AF_DepthAct1[Zn1])/2*AF_SlopeSoilHoriz/100)
    # LF_H1MaxMailyFlow[Zn3] = (W_KSatH1[Zn3]*(AF_DepthAct1[Zn3]+AF_DepthAct1[Zn2])/2*AF_SlopeSoilHoriz/100)
    # LF_H1MaxMailyFlow[Zn4] = (W_KSatH1[Zn4]*(AF_DepthAct1[Zn4]+AF_DepthAct1[Zn3])/2*AF_SlopeSoilHoriz/100)
    
    l1 <- zonelayer_df[zonelayer_df$layer == 1, c("zone", "AF_Depth", "W_KSatH")]
    a <- c(l1[l1$zone == 4, "AF_Depth"], tail(l1$AF_Depth, -1))
    b <- c(l1[l1$zone == 4, "AF_Depth"], head(l1$AF_Depth, -1))
    zone_df$LF_H1MaxMailyFlow <- l1$W_KSatH * (a + b) /
      2 * AF_SlopeSoilHoriz / 100
    
    #TODO: assuming LF_H1MaxMailyFlow == LF_HMaxDailyFlow?
    zonelayer_df[zonelayer_df$layer == 1, "LF_HMaxDailyFlow"] <- zone_df$LF_H1MaxMailyFlow
    
    
    # LF_MaxProfHOutflow = (LF_H1MaxMailyFlow[Zn1]+LF_H2MaxDailyFlow[Zn1]+LF_H3MaxDailyFlow[Zn1]+LF_H4MaxDailyFlow[Zn1])
    LF_MaxProfHOutflow <- zone_df[zone_df$zone == 1, "LF_H1MaxMailyFlow"] + sum(zonelayer_df[zonelayer_df$zone == 1 &
                                                                                              zonelayer_df$layer %in% c(2:4), "LF_HMaxDailyFlow"])
    
    # W_FieldCap1[Zone] = max(W_FieldCapKcrit1[Zone],W_ThetaP1[Zone])
    # W_FieldCap2[Zone] = max(W_FieldCapKcrit2[Zone],W_ThetaP2[Zone])
    # W_FieldCap3[Zone] = max(W_ThetaP3[Zone],W_FieldCapKcrit3[Zone])
    # W_FieldCap4[Zone] = max(W_FieldCapKcrit4[Zone],W_ThetaP4[Zone])
    zonelayer_df$W_FieldCap <- pmax(zonelayer_df$W_FieldCapKcrit, zonelayer_df$W_ThetaP)
    zonelayer_df$W_WatDef <- zonelayer_df$W_FieldCap * zonelayer_df$AF_Depth * 1000 - zonelayer_df$W_Stock
    
    # W_WatDefLog1[Zone] = W_PoreVol[Zone,1]*AF_DepthAct1[Zone]*1000-W_Stock1[Zone]
    # W_WatDefLog2[Zone] = W_PoreVol[Zone,2]*AF_Depth2[Zone]*1000-W_Stock2[Zone]
    # W_WatDefLog3[Zone] = W_PoreVol[Zone,3]*AF_Depth3[Zone]*1000-W_Stock3[Zone]
    # W_WatDefLog4[Zone] = W_PoreVol[Zone,4]*AF_Depth4[Zone]*1000-W_Stock4[Zone]
    zonelayer_df$W_WatDefLog <- zonelayer_df$W_PoreVol * zonelayer_df$AF_Depth * 1000 - zonelayer_df$W_Stock
    
    # LF_MaxVInflow1[Zone] = IF W_WaterLog? = 0 THEN max(W_WatDef1[Zone]+min(LF_V1MaxDailyFlow[Zone],LF_MaxVInflow2[Zone]),0) ELSE max(W_WatDefLog1[Zone]+min(LF_V1MaxDailyFlow[Zone],LF_MaxVInflow2[Zone]),0)
    # LF_MaxVInflow2[Zone] = IF W_WaterLog? = 0 then max(W_WatDef2[Zone]+min(LF_V2MaxDailyFlow[Zone],LF_MaxVInflow3[Zone]),0) else max(W_WatDefLog2[Zone]+min(LF_V2MaxDailyFlow[Zone],LF_MaxVInflow3[Zone]),0)
    # LF_MaxVInflow3[Zone] = IF W_WaterLog? = 0 then max(W_WatDef3[Zone]+min(LF_V3MaxDailyFlow[Zone],LF_MaxVInflow4[Zone]),0) else max(W_WatDefLog3[Zone]+min(LF_V3MaxDailyFlow[Zone],LF_MaxVInflow4[Zone]),0)
    # LF_MaxVInflow4[Zone] = IF W_WaterLog? = 0 then max(W_WatDef4[Zone]+LF_V4MaxDailyFlow[Zone],0)
    
    zonelayer_df$LF_MaxVInflow <- 0
    if (W_WaterLog_is == 0) {
      zonelayer_df$W_WatDef_calc <- zonelayer_df$W_WatDef
    } else {
      zonelayer_df$W_WatDef_calc <- zonelayer_df$W_WatDefLog
    }
    
    zonelayer_df[zonelayer_df$layer == 4, "LF_MaxVInflow"] <- pmax(zonelayer_df[zonelayer_df$layer == 4, "W_WatDef_calc"] + zonelayer_df[zonelayer_df$layer == 4, "LF_VMaxDailyFlow"],
                                                                 0)
    
    zonelayer_df[zonelayer_df$layer == 3, "LF_MaxVInflow"] <- pmax(
      zonelayer_df[zonelayer_df$layer == 3, "W_WatDef_calc"] + pmin(
        zonelayer_df[zonelayer_df$layer ==
                       3, "LF_VMaxDailyFlow"],
        zonelayer_df[zonelayer_df$layer == 4, "LF_MaxVInflow"]
      ),
      0
    )
    zonelayer_df[zonelayer_df$layer == 2, "LF_MaxVInflow"] <- pmax(
      zonelayer_df[zonelayer_df$layer == 2, "W_WatDef_calc"] + pmin(
        zonelayer_df[zonelayer_df$layer ==
                       2, "LF_VMaxDailyFlow"],
        zonelayer_df[zonelayer_df$layer == 3, "LF_MaxVInflow"]
      ),
      0
    )
    zonelayer_df[zonelayer_df$layer == 1, "LF_MaxVInflow"] <- pmax(
      zonelayer_df[zonelayer_df$layer == 1, "W_WatDef_calc"] + pmin(
        zonelayer_df[zonelayer_df$layer ==
                       1, "LF_VMaxDailyFlow"],
        zonelayer_df[zonelayer_df$layer == 2, "LF_MaxVInflow"]
      ),
      0
    )
    
    # LF_MVI1ZF[Zone] = AF_ZoneFrac[Zone]*LF_MaxVInflow1[Zone]
    zonelayer_df$LF_MVIZF <- zonelayer_df$AF_ZoneFrac * zonelayer_df$LF_MaxVInflow
    
    # LF_MaxProfVAbsorption = ARRAYSUM(LF_MVI1ZF[*])
    LF_MaxProfVAbsorption <- sum(zonelayer_df[zonelayer_df$layer == 1, "LF_MVIZF"])
    
    # S_SurfInfiltrAct[Zone] = S_SurfInfiltrPerKsatDef[Zone]*S_KsatInitV1[Zone]*10^((-0.52*(S_BDActOverBDRefInfiltr[Zone]^2)-0.69*S_BDActOverBDRefInfiltr[Zone]+1.21))
    zone_df$S_SurfInfiltrAct <- zone_df$S_SurfInfiltrPerKsatDef * zonelayer_df[zonelayer_df$layer == 1, "S_KsatInitV"] *
      10^((
        -0.52 * (zone_df$S_BDActOverBDRefInfiltr^2) - 0.69 * zone_df$S_BDActOverBDRefInfiltr +
          1.21
      ))
    # LF_SICZF[Zone] = AF_ZoneFrac[Zone]*S_SurfInfiltrAct[Zone]
    zone_df$LF_SICZF <- zone_df$AF_ZoneFrac * zone_df$S_SurfInfiltrAct
    
    #TODO: this code below is still incorrect?
    zone_df$CQ_CType <- zone_df$CQ_CropWeedSwitch
    zone_df$CQ_CType <- ifelse(zone_df$CQ_CType %in% c(1:4), zone_df$CQ_CType, 5)
    
    #### Crop par curr ################################
    update_CQ_par()
    zone_df$CQ_StageAfterHarvest <- ifelse(zone_df$CQ_SingleCycle_is_Cur == 1, 0, 0.7)
    
    # CQ_CLWRCurr[Zone] = If(CQ_CType[Zone]=1)then(CQ_CLWR[Type1, Zone]) else if(CQ_CType[Zone]=2)then(CQ_CLWR[Type2, Zone]) else if(CQ_CType[Zone]=3)then(CQ_CLWR[Type3, Zone]) else
    #   if(CQ_CType[Zone]=4)then(CQ_CLWR[Type4, Zone]) else (CQ_CLWR[Type5, Zone])
    zone_df$CQ_CRelLUECurr <- apply(zone_df[c("zone", "CQ_Stage", "CQ_CType")], 1, function(x) {
      get_zone_stage_par(x["zone"], x["CQ_Stage"], x["CQ_CType"], "CQ_CRelLUE")
    })
    
    zone_df$CQ_CLWRCurr <- apply(zone_df[c("zone", "CQ_Stage", "CQ_CType")], 1, function(x) {
      get_zone_stage_par(x["zone"], x["CQ_Stage"], x["CQ_CType"], "CQ_CLWR")
    })
    
    zone_df$CQ_CHarvAllocCurr <- apply(zone_df[c("zone", "CQ_Stage", "CQ_CType")], 1, function(x) {
      get_zone_stage_par(x["zone"], x["CQ_Stage"], x["CQ_CType"], "CQ_CHarvAlloc")
    })
    
    zone_df$CQ_CSLACurr <- apply(zone_df[c("zone", "CQ_Stage", "CQ_CType")], 1, function(x) {
      get_zone_stage_par(x["zone"], x["CQ_Stage"], x["CQ_CType"], "CQ_CSLA")
    })
    
    zone_df$CQ_CRtAllocCurr <- apply(zone_df[c("zone", "CQ_Stage", "CQ_CType")], 1, function(x) {
      get_zone_stage_par(x["zone"], x["CQ_Stage"], x["CQ_CType"], "CQ_CRtAlloc")
    })
    
    # C_LAI[Zone] = CQ_CLWRCurr[Zone]*CQ_CSLACurr[Zone]*C_BiomStLv[Zone,DW]
    zone_df$C_LAI <- zone_df$CQ_CLWRCurr * zone_df$CQ_CSLACurr * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomStLv"]
    
    # T_LeavesPotPresent?[Tree] = if (T_DOY_Compl_1_LfFall[Tree] < T_DOY_1_LfFlush[Tree]) or (T_DOY_Compl_2_LfFall[Tree] < T_DOY_2_LfFlush[Tree]) then 1 + Max(0,min(1,(mod(time,365) - T_DOY_1_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_1_LfFall[Tree]))) + Max(0,min(1,(mod(time,365) - T_DOY_2_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_2_LfFall[Tree])))
    # else
    #   Max(0,min(1,(mod(time,365) - T_DOY_1_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_1_LfFall[Tree]))) + Max(0,min(1,(mod(time,365) - T_DOY_2_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_2_LfFall[Tree])))
    tree_df$T_LeavesPotPresent_f <- pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_1_LfFlush
    ))) -
      pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_Compl_1_LfFall
      ))) +
      pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_2_LfFlush
      ))) -
      pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_Compl_2_LfFall
      )))
    
    tree_df$T_LeavesPotPresent <- ifelse((tree_df$T_DOY_Compl_1_LfFall < tree_df$T_DOY_1_LfFlush) |
                                           (tree_df$T_DOY_Compl_2_LfFall < tree_df$T_DOY_2_LfFlush),
                                         1 + tree_df$T_LeavesPotPresent_f,
                                         tree_df$T_LeavesPotPresent_f
    )
    
    
    # T_LAI[Tree] = min(T_LAIMax[Tree], (T_LfTwig[DW, Tree])*T_LWR[Tree]*T_SLA[Tree] * T_LeavesPotPresent?[Tree])
    tree_df$T_LAI <- pmin(
      tree_df$T_LAIMax,
      treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LfTwig"] * tree_df$T_LWR * tree_df$T_SLA *  tree_df$T_LeavesPotPresent
    )
    
    # T_LAIMin[Tree] = T_LAIMinMaxRatio[Tree]*T_LAIMax[Tree]
    tree_df$T_LAIMin <- tree_df$T_LAIMinMaxRatio * tree_df$T_LAIMax
    
    # TF_CrownRadius[Tree] = (TF_RecentFrondLength[Tree]*TF_RadiometricFraction[Tree])+(TF_TrunkDiam[Tree]*10^-2)/2
    tree_df$TF_CrownRadius <- (tree_df$TF_RecentFrondLength * tree_df$TF_RadiometricFraction) +
      (tree_df$TF_TrunkDiam * 10^-2) / 2
    
    # T_StemDiam[Tree] = (T_HeartWoodDiam[Tree]^2+T_SapWoodEqDiam[Tree]^2)^0.5
    tree_df$T_StemDiam <- (tree_df$T_HeartWoodDiam^2 + tree_df$T_SapWoodEqDiam^2)^0.5
    
    # T_CanWidthD[Tree] = if T_ApplyPalm?[Tree]=1 then TF_CrownRadius[Tree] else 0.05*T_CanWidthMax[Tree]+0.95*min(T_StemDiam[Tree]/T_DCanWidthMax,1)*T_CanWidthMax[Tree]
    tree_df$T_CanWidthD <- ifelse(
      tree_df$T_ApplyPalm_is == 1,
      tree_df$TF_CrownRadius,
      0.05 * tree_df$T_CanWidthMax +
        0.95 * pmin(tree_df$T_StemDiam / T_DCanWidthMax, 1) *
        tree_df$T_CanWidthMax
    )
    # T_CanWidthMaxRel[Tree] = MIN(T_CanWidthD[Tree]/AF_ZoneTot,1)
    tree_df$T_CanWidthMaxRel <- pmin(tree_df$T_CanWidthD / AF_ZoneTot, 1)
    # T_CanWidthRel[Tree] = MIN(T_LAI[Tree]/T_LAIMin[Tree],T_CanWidthMaxRel[Tree])
    tree_df$T_CanWidthRel <- pmin(tree_df$T_LAI / tree_df$T_LAIMin,
                                  tree_df$T_CanWidthMaxRel)
    
    zonetree_df$T_CanWidthRel <- rep(tree_df$T_CanWidthRel, each = nzone)
    zonetree_df$T_klight <- rep(tree_df$T_klight, each = nzone)
    zonetree_df$T_LAI <- rep(tree_df$T_LAI, each = nzone)
    zonetree_df$T_RainWStorCap <- rep(tree_df$T_RainWStorCap, each = nzone)
    
    
    
    # T_Tree1ToTheLeft?[Zone,Tree] = if AF_TreePosit[Tree]<AF_ZoneTree[Zone] then 1 else 0
    # T_Tree1ToTheRight?[Zone,Tree] = if AF_TreePosit[Tree]>AF_ZoneTree[Zone] then 1 else 0
    # T_Tree2ToTheLeft?[Zone,Tree] = if AF_TreePosit[Tree] < AF_ZoneTree[Zone]-1 then 1 else 0
    # T_Tree2ToTheRight?[Zone,Tree] = if AF_TreePosit[Tree] > AF_ZoneTree[Zone]+1 then 1 else 0
    # T_Tree3ToTheLeft?[Zone,Tree] = if AF_TreePosit[Tree] < AF_ZoneTree[Zone]-2 then 1 else 0
    # T_Tree3ToTheRight?[Zone,Tree] = if AF_TreePosit[Tree] > AF_ZoneTree[Zone]+2 then 1 else 0
    zonetree_df$T_Tree1ToTheLeft <- ifelse(zonetree_df$AF_TreePosit < zonetree_df$AF_ZoneTree, 1, 0)
    zonetree_df$T_Tree1ToTheRight <- ifelse(zonetree_df$AF_TreePosit > zonetree_df$AF_ZoneTree, 1, 0)
    zonetree_df$T_Tree2ToTheLeft <- ifelse(zonetree_df$AF_TreePosit < zonetree_df$AF_ZoneTree -
                                             1, 1, 0)
    zonetree_df$T_Tree2ToTheRight <- ifelse(zonetree_df$AF_TreePosit > zonetree_df$AF_ZoneTree +
                                              1, 1, 0)
    zonetree_df$T_Tree3ToTheLeft <- ifelse(zonetree_df$AF_TreePosit < zonetree_df$AF_ZoneTree -
                                             2, 1, 0)
    zonetree_df$T_Tree3ToTheRight <- ifelse(zonetree_df$AF_TreePosit > zonetree_df$AF_ZoneTree +
                                              2, 1, 0)
    
    # AF_ZoneTreeLeftRight[Zone,Tree] = if AF_TreePosit[Tree] = AF_ZoneTree[Zn1] then AF_ZoneFrac[Zn1] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn2] then AF_ZoneFrac[Zn2] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn3] then AF_ZoneFrac[Zn3] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn4] then AF_ZoneFrac[Zn4] else 0
    zonetree_df$AF_ZoneTreeLeftRight <- zonetree_df$AF_ZoneFrac
    
    # AF_RelZoneTreeLeft[Zone,Tree] = (1-T_RelPosinZone[Tree])*AF_ZoneTreeLeftRight[Zone,Tree]
    # AF_RelZoneTreeNext2Left[Zone,Tree] = if AF_TreePosit[Tree] = AF_ZoneTree[Zn1]-2 then AF_ZoneFrac[Zn1] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn2]-2 then AF_ZoneFrac[Zn2] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn3]-2 then AF_ZoneFrac[Zn3] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn4] -2 then AF_ZoneFrac[Zn4] else 0
    # AF_RelZoneTreeNext2Right[Zone,Tree] = if AF_TreePosit[Tree] = AF_ZoneTree[Zn1]+2 then AF_ZoneFrac[Zn1] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn2]+2 then AF_ZoneFrac[Zn2] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn3]+2 then AF_ZoneFrac[Zn3] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn4] +2 then AF_ZoneFrac[Zn4] else 0
    # AF_RelZoneTreeNextLeft[Zone,Tree] = if AF_TreePosit[Tree] = AF_ZoneTree[Zn1]-1 then AF_ZoneFrac[Zn1] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn2]-1 then AF_ZoneFrac[Zn2] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn3]-1 then AF_ZoneFrac[Zn3] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn4] -1 then AF_ZoneFrac[Zn4] else 0
    # AF_RelZoneTreeNextRight[Zone,Tree] = if AF_TreePosit[Tree] = AF_ZoneTree[Zn1]+1 then AF_ZoneFrac[Zn1] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn2]+1 then AF_ZoneFrac[Zn2] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn3]+1 then AF_ZoneFrac[Zn3] else if AF_TreePosit[Tree] = AF_ZoneTree[Zn4] +1 then AF_ZoneFrac[Zn4] else 0
    # AF_RelZoneTreeRight[Zone,Tree] = T_RelPosinZone[Tree]*AF_ZoneTreeLeftRight[Zone,Tree]
    zonetree_df$AF_RelZoneTreeLeft <- (1 - zonetree_df$T_RelPosinZone) *
      zonetree_df$AF_ZoneTreeLeftRight
    zonetree_df$AF_RelZoneTreeNext2Left <- ifelse(
      zonetree_df$AF_TreePosit == zonetree_df$AF_ZoneTree - 2,
      zonetree_df$AF_ZoneFrac,
      0
    )
    zonetree_df$AF_RelZoneTreeNext2Right <-  ifelse(
      zonetree_df$AF_TreePosit == zonetree_df$AF_ZoneTree + 2,
      zonetree_df$AF_ZoneFrac,
      0
    )
    zonetree_df$AF_RelZoneTreeNextLeft <- ifelse(
      zonetree_df$AF_TreePosit == zonetree_df$AF_ZoneTree - 1,
      zonetree_df$AF_ZoneFrac,
      0
    )
    zonetree_df$AF_RelZoneTreeNextRight <- ifelse(
      zonetree_df$AF_TreePosit ==  zonetree_df$AF_ZoneTree + 1,
      zonetree_df$AF_ZoneFrac,
      0
    )
    zonetree_df$AF_RelZoneTreeRight <- zonetree_df$T_RelPosinZone * zonetree_df$AF_ZoneTreeLeftRight
    
    # T_RelCanWidthZn[Zone,Tree] = if AF_ZoneFrac[Zone] = 0 then 0 else if T_TreeinZone?[Zone,Tree]=1 then min (1,(max(0,min(T_RelPosinZone[Tree]*AF_ZoneFrac[Zone],T_CanWidthRel[Tree]))+max(0,min((1-T_RelPosinZone[Tree])*AF_ZoneFrac[Zone],T_CanWidthRel[Tree])))/AF_ZoneFrac[Zone]) else max(0,min(1,(T_CanWidthRel[Tree]-(T_Tree1ToTheLeft?[Zone,Tree]*AF_RelZoneTreeLeft[Zone,Tree]+T_Tree2ToTheLeft?[Zone,Tree]*AF_RelZoneTreeNextleft[Zone,Tree]+T_Tree3ToTheLeft?[Zone,Tree]*AF_RelZoneTreeNext2Left[Zone,Tree]+T_Tree1ToTheRight?[Zone,Tree]*AF_RelZoneTreeRight[Zone,Tree]+T_Tree2ToTheRight?[Zone,Tree]*AF_RelZoneTreeNextRight[Zone,Tree]+T_Tree3ToTheRight?[Zone,Tree]*AF_RelZoneTreeNext2Right[Zone,Tree]))/AF_ZoneFrac[Zone]))
    zonetree_df$T_RelCanWidthZn <-
      ifelse (
        zonetree_df$AF_ZoneFrac == 0,
        0,
        ifelse (
          zonetree_df$T_TreeinZone == 1,
          pmin(1, (pmax(
            0,
            pmin(
              zonetree_df$T_RelPosinZone * zonetree_df$AF_ZoneFrac,
              zonetree_df$T_CanWidthRel
            )
          ) +
            pmax(
              0,
              pmin((1 - zonetree_df$T_RelPosinZone) * zonetree_df$AF_ZoneFrac,
                  zonetree_df$T_CanWidthRel
              )
            )) / zonetree_df$AF_ZoneFrac)
          ,
          pmax(0, pmin(
            1,
            (
              zonetree_df$T_CanWidthRel -
                (
                  zonetree_df$T_Tree1ToTheLeft * zonetree_df$AF_RelZoneTreeLeft +
                    zonetree_df$T_Tree2ToTheLeft * zonetree_df$AF_RelZoneTreeNextLeft +
                    zonetree_df$T_Tree3ToTheLeft * zonetree_df$AF_RelZoneTreeNext2Left +
                    zonetree_df$T_Tree1ToTheRight * zonetree_df$AF_RelZoneTreeRight +
                    zonetree_df$T_Tree2ToTheRight * zonetree_df$AF_RelZoneTreeNextRight +
                    zonetree_df$T_Tree3ToTheRight * zonetree_df$AF_RelZoneTreeNext2Right
                )
            ) / zonetree_df$AF_ZoneFrac
          ))
        )
      )
    
    # T_LAICan[Tree] = IF(T_CanWidthRel[Tree]>0)THEN(MAX(T_LAI[Tree]/T_CanWidthRel[Tree],0))ELSE(0)
    zonetree_df$T_LAICan <- ifelse(
      zonetree_df$T_CanWidthRel > 0,
      pmax(zonetree_df$T_LAI / zonetree_df$T_CanWidthRel, 0),
      0
    )
    
    # T_LAIEff[Zone,Tree] = IF T_klight[Tree]>0 AND (1-T_RelCanWidthZn[Zone,Tree]*(1-exp(-T_klight[Tree]*T_LAICan[Tree])))>0 THEN -LOGN(1-T_RelCanWidthZn[Zone,Tree]*(1-exp(-T_klight[Tree]*T_LAICan[Tree])))/T_klight[Tree] ELSE 0
    zonetree_df$T_LAIEff <-
      ifelse(
        zonetree_df$T_klight > 0 &
          (1 - zonetree_df$T_RelCanWidthZn * (
            1 - exp(-zonetree_df$T_klight * zonetree_df$T_LAICan)
          )) > 0,
        -log(1 - zonetree_df$T_RelCanWidthZn * (
          1 - exp(-zonetree_df$T_klight * zonetree_df$T_LAICan)
        )) / zonetree_df$T_klight
        ,
        0
      )
    
    # RAIN_WatStorTTot[Zone] = T_LAIEff[Zone,Sp1]*T_RainWStorCap[Sp1]+T_LAIEff[Zone,Sp2]*T_RainWStorCap[Sp2]+T_LAIEff[Zone,Sp3]*T_RainWStorCap[Sp3]
    zonetree_df$RAIN_WatStorTTot_sp <- zonetree_df$T_LAIEff * zonetree_df$T_RainWStorCap
    df <- zonetree_df[c("zone", "RAIN_WatStorTTot_sp")]
    zdf <- aggregate(zonetree_df$RAIN_WatStorTTot_sp,
                     by = list(zone = zonetree_df$zone),
                     sum)
    zdf <- zdf[order(zdf$zone), ]
    zone_df$RAIN_WatStorTTot <- zdf[[2]]
    
    # RAIN_WatStorCap[Zone] = C_LAI[Zone]*CQ_RainWStorCapCurr[Zone]+RAIN_WatStorTTot[Zone]+S&B_FineNecromass[Zone,DW]*MC_LAIperNecmss[Zone]*ARRAYMEAN(T_RainWStorCap[*])
    zone_df$RAIN_WatStorCap <- zone_df$C_LAI * zone_df$CQ_RainWStorCapCurr +
      zone_df$RAIN_WatStorTTot + zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_FineNecromass"] * zone_df$MC_LAIperNecmss * mean(tree_df$T_RainWStorCap)
    
    # INFLOWS:
    #   RAIN_Interception[Zone] = IF RAIN_WatStorCap[Zone]-RAIN_CanopyWater[Zone]>0 THEN
    # (RAIN_WatStorCap[Zone]-RAIN_CanopyWater[Zone])*(1-exp(-Rain*RAIN_WeightAct[Zone]/(RAIN_WatStorCap[Zone]-RAIN_CanopyWater[Zone]))) ELSE 0
    zone_df$RAIN_Interception <- ifelse(
      zone_df$RAIN_WatStorCap - zone_df$RAIN_CanopyWater > 0,
      (zone_df$RAIN_WatStorCap - zone_df$RAIN_CanopyWater) * (1 - exp(
        -Rain * zone_df$RAIN_WeightAct / (zone_df$RAIN_WatStorCap - zone_df$RAIN_CanopyWater)
      )),
      0
    )
    
    # RAIN_IntercDelay[Zone] = min(RAIN_Max_IntDripDur, RAIN_IntMult*RAIN_Interception[Zone]/RAIN_IntercDripRt)
    zone_df$RAIN_IntercDelay <- pmin(
      RAIN_Max_IntDripDur,
      RAIN_IntMult * zone_df$RAIN_Interception / RAIN_IntercDripRt
    )
    
    # RAIN_Duration = (Rain/RAIN_IntensMean)*MIN(MAX (0,1-3*RAIN_IntensCoefVar, NORMAL(1,RAIN_IntensCoefVar,RAIN_GenSeed+11250)), 1+3*RAIN_IntensCoefVar)
    RAIN_Duration <- (Rain / RAIN_IntensMean) *
      min(max (0, 1 - 3 * RAIN_IntensCoefVar, rnorm(1, 1, RAIN_IntensCoefVar)),
          1 + 3 * RAIN_IntensCoefVar)
    
    # RAIN_SurfPondDelay[Zone] = if AF_SlopeCurr[Zone]*RAIN_PondFlwRt*AF_ZoneWidth[Zone] = 0 then 24 else
    #   RAIN_PondStoreCp/(AF_SlopeCurr[Zone]*RAIN_PondFlwRt*AF_ZoneWidth[Zone])
    zone_df$RAIN_SurfPondDelay <- ifelse(
      zone_df$AF_SlopeCurr * RAIN_PondFlwRt * zone_df$AF_ZoneWidth == 0,
      24,
      RAIN_PondStoreCp / (
        zone_df$AF_SlopeCurr * RAIN_PondFlwRt * zone_df$AF_ZoneWidth
      )
    )

    # RAIN_TimeAvForInf[Zone] = min(24,RAIN_Duration+RAIN_IntercDelay[Zone]+RAIN_SurfPondDelay[Zone] )
    zone_df$RAIN_TimeAvForInf <- pmin(24,
                                     RAIN_Duration + zone_df$RAIN_IntercDelay + zone_df$RAIN_SurfPondDelay)
    
    # RAIN_InfilAct = (AF_PlotNumberUphill*ARRAYSUM(LF_SICZF[*]))*ARRAYMEAN(RAIN_TimeAvForInf[*])
    RAIN_InfilAct <- (AF_PlotNumberUphill * sum(zone_df$LF_SICZF)) * mean(zone_df$RAIN_TimeAvForInf)
    
    # LF_UpHillRainIn = max(min(AF_PlotNumberUphill*Rain,min(RAIN_InfilAct,
    #  AF_PlotNumberUphill*(LF_MaxProfVAbsorption+LF_MaxProfHOutflow))),0)
    LF_UpHillRainIn <- max(min(
      AF_PlotNumberUphill * Rain,
      min(
        RAIN_InfilAct,
        AF_PlotNumberUphill *
          (LF_MaxProfVAbsorption + LF_MaxProfHOutflow)
      )
    ), 0)
    
    # LF_AvgWatDef1 = IF W_WaterLog? = 0 then AF_ZoneFrac[Zn1]*W_WatDef1[Zn1]+AF_ZoneFrac[Zn2]*W_WatDef1[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDef1[Zn3]+AF_ZoneFrac[Zn4]*W_WatDef1[Zn4] ELSE AF_ZoneFrac[Zn1]*W_WatDefLog1[Zn1]+AF_ZoneFrac[Zn2]*W_WatDefLog1[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDefLog1[Zn3]+AF_ZoneFrac[Zn4]*W_WatDefLog1[Zn4]
    # LF_AvgWatDef2 = IF W_WaterLog? = 0 then AF_ZoneFrac[Zn1]*W_WatDef2[Zn1]+AF_ZoneFrac[Zn2]*W_WatDef2[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDef2[Zn3]+AF_ZoneFrac[Zn4]*W_WatDef2[Zn4]
    # else
    #   AF_ZoneFrac[Zn1]*W_WatDefLog2[Zn1]+AF_ZoneFrac[Zn2]*W_WatDefLog2[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDefLog2[Zn3]+AF_ZoneFrac[Zn4]*W_WatDefLog2[Zn4]
    # LF_AvgWatDef3 = IF W_WaterLog? = 0 then
    # AF_ZoneFrac[Zn1]*W_WatDef3[Zn1]+AF_ZoneFrac[Zn2]*W_WatDef3[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDef3[Zn3]+AF_ZoneFrac[Zn4]*W_WatDef3[Zn4]
    # ELSE
    # AF_ZoneFrac[Zn1]*W_WatDefLog3[Zn1]+AF_ZoneFrac[Zn2]*W_WatDefLog3[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDefLog3[Zn3]+AF_ZoneFrac[Zn4]*W_WatDefLog3[Zn4]
    # LF_AvgWatDef4 = IF W_WaterLog? = 0 then AF_ZoneFrac[Zn1]*W_WatDef4[Zn1]+AF_ZoneFrac[Zn2]*W_WatDef4[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDef4[Zn3]+AF_ZoneFrac[Zn4]*W_WatDef4[Zn4]
    # ELSE
    # AF_ZoneFrac[Zn1]*W_WatDefLog4[Zn1]+AF_ZoneFrac[Zn2]*W_WatDefLog4[Zn2]+
    #   AF_ZoneFrac[Zn3]*W_WatDefLog4[Zn3]+AF_ZoneFrac[Zn4]*W_WatDefLog4[Zn4]
    
    zonelayer_df$W_WatDef_ZF <- zonelayer_df$W_WatDef * zonelayer_df$AF_ZoneFrac
    df <- aggregate(zonelayer_df$W_WatDef_ZF,
                    by = list(layer = zonelayer_df$layer),
                    sum)
    df <- df[order(df$layer), ]
    layer_df$W_WatDef <- df[[2]]
    
    # zonelayer_df$W_WatDefLog <- rep(layer_df$W_WatDefLog, each = nzone)
    zonelayer_df$W_WatDefLog_ZF <- zonelayer_df$W_WatDefLog * zonelayer_df$AF_ZoneFrac
    df <- aggregate(zonelayer_df$W_WatDefLog_ZF,
                    by = list(layer = zonelayer_df$layer),
                    sum)
    df <- df[order(df$layer), ]
    layer_df$W_WatDefLog <- df[[2]]
    
    layer_df$W_WaterLog_is <- W_WaterLog_is
    
    layer_df$LF_AvgWatDef <- ifelse(layer_df$W_WaterLog_is == 0,
                                    layer_df$W_WatDef,
                                    layer_df$W_WatDefLog)
    
    #TODO: inconsistent W_H1RelDrain on LF_H1MaxMailyFlow[Zn2] -> confirmed!
    # W_H1RelDrain[Zone] = max(0,LF_H1MaxMailyFlow[Zone]/(LF_H1MaxMailyFlow[Zn2]+LF_V1MaxDailyFlow[Zone]))
    # W_H2RelDrain[Zone] = max(0,LF_H2MaxDailyFlow[Zone]/(LF_H2MaxDailyFlow[Zone]+LF_V2MaxDailyFlow[Zone]))
    # W_H3RelDrain[Zone] = max(0,LF_H3MaxDailyFlow[Zone]/(LF_H3MaxDailyFlow[Zone]+LF_V3MaxDailyFlow[Zone]))
    # W_H4RelDrain[Zone] = max(0,LF_H4MaxDailyFlow[Zone]/(LF_H4MaxDailyFlow[Zone]+LF_V4MaxDailyFlow[Zone]))
    zonelayer_df$W_HRelDrain <- pmax(
      0,
      zonelayer_df$LF_HMaxDailyFlow / (
        zonelayer_df$LF_HMaxDailyFlow + zonelayer_df$LF_VMaxDailyFlow
      )
    )
    # zl1 <- zonelayer_df[zonelayer_df$layer == 1, ]
    zonelayer_df[zonelayer_df$layer == 1, "W_HRelDrain"] <- pmax(
      0,
      zone_df$LF_H1MaxMailyFlow / (
        zone_df[zone_df$zone == 2, "LF_H1MaxMailyFlow"] + zonelayer_df[zonelayer_df$layer == 1, "LF_VMaxDailyFlow"]
      )
    )
    
    # W_H1RelDrZoneWid[Zone] = AF_ZoneFrac[Zone]*W_H1RelDrain[Zone]
    # W_H2RelDrZoneWid[Zone] = AF_ZoneFrac[Zone]*W_H2RelDrain[Zone]
    # W_H3RelDrZoneWid[Zone] = AF_ZoneFrac[Zone]*W_H3RelDrain[Zone]
    # W_H4RelDrZoneWid[Zone] = AF_ZoneFrac[Zone]*W_H4RelDrain[Zone]
    zonelayer_df$W_HRelDrZoneWid <- zonelayer_df$AF_ZoneFrac * zonelayer_df$W_HRelDrain
    
    # W_Avg1RelHDrain = ARRAYSUM(W_H1RelDrZoneWid[*])
    # W_Avg2RelHDrain = ARRAYSUM(W_H2RelDrZoneWid[*])
    # W_Avg3RelHDrain = ARRAYSUM(W_H3RelDrZoneWid[*])
    # W_Avg4RelHDrain = ARRAYSUM(W_H4RelDrZoneWid[*])
    df <- aggregate(zonelayer_df$W_HRelDrZoneWid,
                    by = list(layer = zonelayer_df$layer),
                    sum)
    df <- df[order(df$layer), ]
    layer_df$W_AvgRelHDrain <- df[[2]]
    
    # LF_VertFlow1 = min(min((max(0,LF_UpHillRainIn - AF_PlotNumberUphill*LF_AvgWatDef1))*(1-W_Avg1RelHDrain),
    #ARRAYSUM(LF_MVI2ZF[*])),
    #  (AF_ZoneFrac[Zn1]*LF_V1MaxDailyFlow[Zn1]+AF_ZoneFrac[Zn2]*LF_V1MaxDailyFlow[Zn2]+AF_ZoneFrac[Zn3]*LF_V1MaxDailyFlow[Zn3]+AF_ZoneFrac[Zn4]*LF_V1MaxDailyFlow[Zn4]))
    # LF_VertFlow2 = min(min((max(0,LF_VertFlow1 - AF_PlotNumberUphill*LF_AvgWatDef2))*(1-W_Avg2RelHDrain),
    #ARRAYSUM(LF_MVI3ZF[*])),
    #  (AF_ZoneFrac[Zn1]*LF_V2MaxDailyFlow[Zn1]+AF_ZoneFrac[Zn2]*LF_V2MaxDailyFlow[Zn2]+AF_ZoneFrac[Zn3]*LF_V2MaxDailyFlow[Zn3]+AF_ZoneFrac[Zn4]*LF_V2MaxDailyFlow[Zn4]))
    # LF_VertFlow3 = min(min((max(0,LF_VertFlow2 - AF_PlotNumberUphill*LF_AvgWatDef3))*(1-W_Avg3RelHDrain),
    #ARRAYSUM(LF_MVI4ZF[*])),
    #  (AF_ZoneFrac[Zn1]*LF_V3MaxDailyFlow[Zn1]+AF_ZoneFrac[Zn2]*LF_V3MaxDailyFlow[Zn2]+AF_ZoneFrac[Zn3]*LF_V3MaxDailyFlow[Zn3]+AF_ZoneFrac[Zn4]*LF_V3MaxDailyFlow[Zn4]))
    # LF_VertFlow4 = min((max(0,LF_VertFlow3 - AF_PlotNumberUphill*LF_AvgWatDef4))*(1-W_Avg4RelHDrain),
    #  (AF_ZoneFrac[Zn1]*LF_V4MaxDailyFlow[Zn1]+AF_ZoneFrac[Zn2]*LF_V4MaxDailyFlow[Zn2]+AF_ZoneFrac[Zn3]*LF_V4MaxDailyFlow[Zn3]+AF_ZoneFrac[Zn4]*LF_V4MaxDailyFlow[Zn4]))
    
    zonelayer_df$fv <- zonelayer_df$AF_ZoneFrac *  zonelayer_df$LF_VMaxDailyFlow
    df <- aggregate(zonelayer_df[c("fv", "LF_MVIZF")], list(layer = zonelayer_df$layer), sum)
    df <- df[order(df$layer), ]
    layer_df$LF_VMaxDailyFlow_ZF <- df$fv
    layer_df$LF_MVIZF_sum <- df$LF_MVIZF
    
    l1 <- layer_df[layer_df$layer == 1, ]
    LF_VertFlow1 <- min(min((
      max(0, LF_UpHillRainIn - AF_PlotNumberUphill * l1$LF_AvgWatDef)
    ) * (1 - l1$W_AvgRelHDrain), l1$LF_MVIZF_sum), l1$LF_VMaxDailyFlow_ZF)
    l2 <- layer_df[layer_df$layer == 2, ]
    LF_VertFlow2 <- min(min((
      max(0, LF_VertFlow1 - AF_PlotNumberUphill * l2$LF_AvgWatDef)
    ) * (1 - l2$W_AvgRelHDrain), l2$LF_MVIZF_sum), l2$LF_MVIZF_sum)
    
    l3 <- layer_df[layer_df$layer == 3, ]
    LF_VertFlow3 <- min(min((
      max(0, LF_VertFlow2 - AF_PlotNumberUphill * l3$LF_AvgWatDef)
    ) * (1 - l3$W_AvgRelHDrain), l3$LF_MVIZF_sum), l3$LF_MVIZF_sum)
    
    l4 <- layer_df[layer_df$layer == 4, ]
    LF_VertFlow4 <- min((
      max(0, LF_VertFlow3 - AF_PlotNumberUphill * l4$LF_AvgWatDef)
    ) * (1 - l4$W_AvgRelHDrain), l4$LF_MVIZF_sum)
    
    layer_df$LF_VertFlow <- c(LF_VertFlow1, LF_VertFlow2, LF_VertFlow3, LF_VertFlow4)
    
    # AF_AccLatInflowratio[Zn1] = AF_LatInFlowRatio[Zn1]*AF_LatInFlowRatio[Zn2]*AF_LatInFlowRatio[Zn3]*AF_LatInFlowRatio[Zn4]
    # AF_AccLatInflowratio[Zn2] = AF_LatInFlowRatio[Zn2]*AF_LatInFlowRatio[Zn3]*AF_LatInFlowRatio[Zn4]
    # AF_AccLatInflowratio[Zn3] = AF_LatInFlowRatio[Zn3]*AF_LatInFlowRatio[Zn4]
    # AF_AccLatInflowratio[Zn4] = AF_LatInFlowRatio[Zn4]
    zone_df$AF_AccLatInFlowRatio <- zone_df$AF_LatInFlowRatio
    for (z in 1:(nzone - 1)) {
      zone_df$AF_AccLatInFlowRatio <- zone_df$AF_AccLatInFlowRatio * c(tail(zone_df$AF_LatInFlowRatio, -z), rep(1, z))
    }
    zonelayer_df$AF_AccLatInFlowRatio <- rep(zone_df$AF_AccLatInFlowRatio, nlayer)
    
    # LF_UphillGWRelease = LF_UphillGWStore*LF_GW_ReleaseFraction
    LF_UphillGWRelease <- LF_UphillGWStore * LF_GW_ReleaseFraction
    
    # W_Theta1[Zone] = min((max(0,W_Stock1[Zone]))/(AF_DepthAct1[Zone]*1000),1)
    # W_Theta2[Zone] = min(max(0,W_Stock2[Zone])/(AF_Depth2[Zone]*1000),1)
    # W_Theta3[Zone] = min(max(0,W_Stock3[Zone])/(AF_Depth3[Zone]*1000),1)
    # W_Theta4[Zone] = min(max(0,W_Stock4[Zone])/(AF_Depth4[Zone]*1000),1)
    zonelayer_df$W_Theta <- pmin((pmax(0, zonelayer_df$W_Stock)) / (zonelayer_df$AF_Depth *
                                                                      1000), 1)
    
    # W_WaterfilledPoreF1[Zone] = W_Theta1[Zone]/W_PoreVol[Zone,1]
    # W_WaterfilledPoreF2[Zone] = W_Theta2[Zone]/W_PoreVol[Zone,2]
    # W_WaterfilledPoreF3[Zone] = W_Theta3[Zone]/W_PoreVol[Zone,3]
    # W_WaterfilledPoreF4[Zone] = W_Theta4[Zone]/W_PoreVol[Zone,4]
    zonelayer_df$W_WaterfilledPoreF <- zonelayer_df$W_Theta / zonelayer_df$W_PoreVol
    if(any(is.na(zonelayer_df$W_WaterfilledPoreF))) {
      print(time)
      print(zonelayer_df[c("layer", "W_WaterfilledPoreF", "W_Theta", "W_PoreVol", "W_Stock")])
    }
    
    # LF_RelDistInflowFromGW[1] = if (W_WaterfilledPoreF4[Zn4] = 1 and W_WaterfilledPoreF3[Zn4] = 1 and W_WaterfilledPoreF2[Zn4] = 1 and W_WaterfilledPoreF1[Zn4] < 1)  then 1 else 0*(W_WaterfilledPoreF4[Zn4]+W_WaterfilledPoreF3[Zn4]+W_WaterfilledPoreF2[Zn4]+W_WaterfilledPoreF1[Zn4])
    # LF_RelDistInflowFromGW[2] = if(W_WaterfilledPoreF4[Zn4] = 1 and W_WaterfilledPoreF3[Zn4] = 1 and W_WaterfilledPoreF2[Zn4] < 1) then 1 else 0*(W_WaterfilledPoreF4[Zn4]+W_WaterfilledPoreF3[Zn4]+W_WaterfilledPoreF2[Zn4]+W_WaterfilledPoreF1[Zn4])
    # LF_RelDistInflowFromGW[3] = if (W_WaterfilledPoreF4[Zn4] = 1 and W_WaterfilledPoreF3[Zn4] < 1) then 1 else 0*(W_WaterfilledPoreF4[Zn4]+W_WaterfilledPoreF3[Zn4]+W_WaterfilledPoreF2[Zn4]+W_WaterfilledPoreF1[Zn4])
    # LF_RelDistInflowFromGW[4] = if W_WaterfilledPoreF4[Zn4] < 1 then 1 else 0*(W_WaterfilledPoreF4[Zn4]+W_WaterfilledPoreF3[Zn4]+W_WaterfilledPoreF2[Zn4]+W_WaterfilledPoreF1[Zn4])
    layer_df$LF_RelDistInflowFromGW <- sum(layer_df$W_WaterfilledPoreF)
    wfp <- zonelayer_df[zonelayer_df$zone == 4, "W_WaterfilledPoreF"]
    
    if (wfp[4] == 1 && wfp[3] == 1 && wfp[2] == 1 && wfp[1] < 1) {
      layer_df[layer_df$layer == 1, "LF_RelDistInflowFromGW"] <- 1
    }
    if (wfp[4] == 1 && wfp[3] == 1 && wfp[2] < 1) {
      layer_df[layer_df$layer == 2, "LF_RelDistInflowFromGW"] <- 1
    }
    if (wfp[4] == 1 && wfp[3] < 1) {
      layer_df[layer_df$layer == 3, "LF_RelDistInflowFromGW"] <- 1
    }
    if (wfp[4] < 1) {
      layer_df[layer_df$layer == 4, "LF_RelDistInflowFromGW"] <- 1
    }
    
    # LF_InflowFromGW[SoilLayer] = LF_UphillGWRelease*LF_FracGWReleaseAsInflow*LF_RelDistInflowFromGW[SoilLayer]
    layer_df$LF_InflowFromGW <- LF_UphillGWRelease *  LF_FracGWReleaseAsInflow * layer_df$LF_RelDistInflowFromGW
    
    # LF_Lat4Inflow1 = min(max((LF_UpHillRainIn-AF_PlotNumberUphill*LF_AvgWatDef1-LF_VertFlow1),0),LF_H1MaxMailyFlow[Zn1])+LF_InflowFromGW[1]
    # LF_Lat4Inflow2 = min((max(0,LF_VertFlow1-AF_PlotNumberUphill*LF_AvgWatDef2-LF_VertFlow2)),LF_H2MaxDailyFlow[Zn1])+LF_InflowFromGW[2]
    # LF_Lat4Inflow3 = min((max(0,LF_VertFlow2-AF_PlotNumberUphill*LF_AvgWatDef3-LF_VertFlow3)),LF_H3MaxDailyFlow[Zn1])+LF_InflowFromGW[3]
    # LF_Lat4Inflow4 = min((max(0,LF_VertFlow3-AF_PlotNumberUphill*LF_AvgWatDef4-LF_VertFlow4)),LF_H4MaxDailyFlow[Zn1])+LF_SubSurfInflowAdd4 +LF_InflowFromGW[4]
    LF_VertFlow_up <- c(LF_UpHillRainIn, LF_VertFlow1, LF_VertFlow2, LF_VertFlow3)
    layer_df$LF_Lat4Inflow <- pmin(
      pmax(
        0,
        LF_VertFlow_up - AF_PlotNumberUphill * layer_df$LF_AvgWatDef - layer_df$LF_VertFlow
      ),
      zonelayer_df[zonelayer_df$zone == 1, "LF_HMaxDailyFlow"]
    ) + layer_df$LF_InflowFromGW
    layer_df[layer_df$layer == 4, "LF_Lat4Inflow"] <- layer_df[layer_df$layer == 4, "LF_Lat4Inflow"] + LF_SubSurfInflowAdd4
    zonelayer_df$LF_Lat4Inflow <- rep(layer_df$LF_Lat4Inflow, each = nzone)
    
    # LF_MaxVInflow1[Zone] = IF W_WaterLog? = 0 THEN max(W_WatDef1[Zone]+min(LF_V1MaxDailyFlow[Zone],LF_MaxVInflow2[Zone]),0) ELSE max(W_WatDefLog1[Zone]+min(LF_V1MaxDailyFlow[Zone],LF_MaxVInflow2[Zone]),0)
    zl1 <- zonelayer_df[zonelayer_df$layer == 1, c("W_WatDef", "W_WatDefLog", "LF_VMaxDailyFlow")]
    zl2_LF_MaxVInflow <- zonelayer_df[zonelayer_df$layer == 2, c("LF_MaxVInflow")]
    
    zone_df$W_WaterLog_is <- W_WaterLog_is
    
    zone_df$LF_MaxVInflow1 <- ifelse(
      zone_df$W_WaterLog_is == 0,
      pmax(
        zl1$W_WatDef + pmin(zl1$LF_VMaxDailyFlow, zl2_LF_MaxVInflow),
        0
      ),
      pmax(
        zl1$W_WatDefLog + pmin(zl1$LF_VMaxDailyFlow, zl2_LF_MaxVInflow),
        0
      )
    )
    
    # RAIN_InfConstr[Zone] = min(LF_MaxVInflow1[Zone],S_SurfInfiltrAct[Zone]*RAIN_TimeAvForInf[Zone]/24)
    zone_df$RAIN_InfConstr <- pmin(
      zone_df$LF_MaxVInflow1,
      zone_df$S_SurfInfiltrAct * zone_df$RAIN_TimeAvForInf / 24
    )
    
    # RAIN_In[Zone] = max(0,Rain*RAIN_WeightAct[Zone]-RAIN_Interception[Zone])
    zone_df$RAIN_In <- pmax(0,
                           Rain * zone_df$RAIN_WeightAct - zone_df$RAIN_Interception)
    
    # LF_RunOn = (AF_PlotNumberUphill*Rain-LF_UpHillRainIn)*AF_RunOnFrac
    LF_RunOn <- (AF_PlotNumberUphill * Rain - LF_UpHillRainIn) *
      AF_RunOnFrac
    
    # RAIN_Inf4 = min(RAIN_InfConstr[Zn4],RAIN_In[Zn4]+LF_RunOn*AF_LatInFlowRatio[Zn4])
    # RAIN_Runoff43 = max(0,RAIN_In[Zn4]+AF_LatInFlowRatio[Zn4]*LF_RunOn - RAIN_Inf4)
    # RAIN_Inf3 = min(RAIN_InfConstr[Zn3],RAIN_In[Zn3]+AF_LatInFlowRatio[Zn3]*RAIN_Runoff43)
    # RAIN_Runoff32 = max(0,RAIN_In[Zn3]+AF_LatInFlowRatio[Zn3]*RAIN_Runoff43 - RAIN_Inf3)
    # RAIN_Inf2 = min(RAIN_InfConstr[Zn2],RAIN_In[Zn2]+AF_LatInFlowRatio[Zn2]*RAIN_Runoff32)
    # RAIN_Runoff21 = max(RAIN_In[Zn2]+AF_LatInFlowRatio[Zn2]*RAIN_Runoff32-RAIN_Inf2,0)
    # RAIN_Inf1 = min(RAIN_InfConstr[Zn1],RAIN_In[Zn1]+AF_LatInFlowRatio[Zn1]*RAIN_Runoff21)
    # RAIN_Runoff10 = max(0,RAIN_In[Zn1]+AF_LatInFlowRatio[Zn1]*RAIN_Runoff21-RAIN_Inf1)
    # RAIN_RunOff = AF_ZoneFrac[Zn1]*RAIN_Runoff10
    
    z4 <- zone_df[zone_df$zone == 4, c("RAIN_InfConstr", "RAIN_In", "AF_LatInFlowRatio")]
    RAIN_Inf4 <- min(z4$RAIN_InfConstr,
                     z4$RAIN_In + LF_RunOn * z4$AF_LatInFlowRatio)
    RAIN_Runoff43 <- max(0, z4$RAIN_In + z4$AF_LatInFlowRatio * LF_RunOn - RAIN_Inf4)
    
    z3 <- zone_df[zone_df$zone == 3, c("RAIN_InfConstr", "RAIN_In", "AF_LatInFlowRatio")]
    RAIN_Inf3 <- min(z3$RAIN_InfConstr,
                     z3$RAIN_In + z3$AF_LatInFlowRatio * RAIN_Runoff43)
    RAIN_Runoff32 <- max(0,
                         z3$RAIN_In + z3$AF_LatInFlowRatio * RAIN_Runoff43 - RAIN_Inf3)
    
    z2 <- zone_df[zone_df$zone == 2, c("RAIN_InfConstr", "RAIN_In", "AF_LatInFlowRatio")]
    RAIN_Inf2 <- min(z2$RAIN_InfConstr,
                     z2$RAIN_In + z2$AF_LatInFlowRatio * RAIN_Runoff32)
    RAIN_Runoff21 <- max(0,
                         z2$RAIN_In + z2$AF_LatInFlowRatio * RAIN_Runoff32 - RAIN_Inf2)
    
    z1 <- zone_df[zone_df$zone == 1, c("RAIN_InfConstr", "RAIN_In", "AF_LatInFlowRatio", "AF_ZoneFrac")]
    RAIN_Inf1 <- min(z1$RAIN_InfConstr,
                     z1$RAIN_In + z1$AF_LatInFlowRatio * RAIN_Runoff21)
    RAIN_Runoff10 <- max(0,
                         z1$RAIN_In + z1$AF_LatInFlowRatio * RAIN_Runoff21 - RAIN_Inf1)
    RAIN_RunOff <- z1$AF_ZoneFrac * RAIN_Runoff10
    
    # RAIN_Infiltr[Zn1] = RAIN_Inf1+0*(RAIN_Inf2+RAIN_Inf3+RAIN_Inf4)
    # RAIN_Infiltr[Zn2] = RAIN_Inf2+0*(RAIN_Inf1+RAIN_Inf3+RAIN_Inf4)
    # RAIN_Infiltr[Zn3] = RAIN_Inf3+0*(RAIN_Inf1+RAIN_Inf2+RAIN_Inf4)
    # RAIN_Infiltr[Zn4] = 0*(RAIN_Inf1+RAIN_Inf2+RAIN_Inf3)+RAIN_Inf4
    zone_df$RAIN_Infiltr <- c(RAIN_Inf1 , RAIN_Inf2 , RAIN_Inf3 , RAIN_Inf4)
    
    # W_Drain Calculation
    
    # W_EstDrain1[Zone] = if W_WaterLog? = 0 then max(0,RAIN_Infiltr[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow1-W_WatDef1[Zone]) else max(0,RAIN_Infiltr[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow1-W_WatDefLog1[Zone])
    zl1 <- zonelayer_df[zonelayer_df$layer == 1, c("LF_MaxVInflow", "LF_Lat4Inflow", "S_KsatVAct", "W_WatDef", "W_WatDefLog", "W_HRelDrain", "LF_VMaxDailyFlow")]
    zl2 <- zonelayer_df[zonelayer_df$layer == 2, c("LF_MaxVInflow", "LF_Lat4Inflow", "S_KsatVAct", "W_WatDef", "W_WatDefLog", "W_HRelDrain", "LF_VMaxDailyFlow")]
    zl3 <- zonelayer_df[zonelayer_df$layer == 3, c("LF_MaxVInflow", "LF_Lat4Inflow", "S_KsatVAct", "W_WatDef", "W_WatDefLog", "W_HRelDrain", "LF_VMaxDailyFlow")]
    zl4 <- zonelayer_df[zonelayer_df$layer == 4, c("LF_MaxVInflow", "LF_Lat4Inflow", "S_KsatVAct", "W_WatDef", "W_WatDefLog", "W_HRelDrain", "LF_VMaxDailyFlow")]
    
    zone_df$W_EstDrain1_a <- zone_df$RAIN_Infiltr + zone_df$AF_AccLatInFlowRatio * zl1$LF_Lat4Inflow
    zone_df$W_EstDrain1 <- ifelse(
      zone_df$W_WaterLog_is == 0,
      pmax(0, zone_df$W_EstDrain1_a - zl1$W_WatDef),
      pmax(0, zone_df$W_EstDrain1_a - zl1$W_WatDefLog)
    )
    
    # W_Drain1[Zn1] = MAX(0,W_EstDrain1[Zn1]+AF_LatInFlowRatio[Zn1]*W_H1RelDrain[Zn2]*(W_EstDrain1[Zn2]+AF_LatInFlowRatio[Zn2]*W_H1RelDrain[Zn3]*(W_EstDrain1[Zn3]+AF_LatInFlowRatio[Zn3]*W_H1RelDrain[Zn4]*W_EstDrain1[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow1)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow1)-AF_AccLatInflowratio[Zn1]*LF_Lat4Inflow1)
    # W_Drain1[Zn2] = MAX(0,W_EstDrain1[Zn2]+AF_LatInFlowRatio[Zn2]*W_H1RelDrain[Zn3]*(W_EstDrain1[Zn3]+AF_LatInFlowRatio[Zn3]*W_H1RelDrain[Zn4]*W_EstDrain1[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow1)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow1)
    # W_Drain1[Zn3] = MAX(0,W_EstDrain1[Zn3]+AF_LatInFlowRatio[Zn3]*W_H1RelDrain[Zn4]*W_EstDrain1[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow1)
    # W_Drain1[Zn4] = MAX(0,W_EstDrain1[Zn4]+0 *(LF_Lat4Inflow1+W_H1RelDrain[Zn4]+AF_LatInFlowRatio[Zn4]+AF_AccLatInflowratio[Zn4]))
    calc_W_Drain <- function(W_EstDrain,
                             W_HRelDrain,
                             AF_LatInFlowRatio,
                             AF_AccLatInFlowRatio,
                             LF_Lat4Inflow) {
      W_Drain <- W_EstDrain
      W_Drain[3] <- W_EstDrain[3] + AF_LatInFlowRatio[3] * W_HRelDrain[4] * W_Drain[4] - AF_AccLatInFlowRatio[3] * LF_Lat4Inflow
      W_Drain[2] <- W_EstDrain[2] + AF_LatInFlowRatio[2] * W_HRelDrain[3] * W_Drain[3] - AF_AccLatInFlowRatio[2] * LF_Lat4Inflow
      W_Drain[1] <- W_EstDrain[1] + AF_LatInFlowRatio[1] * W_HRelDrain[2] * W_Drain[2] - AF_AccLatInFlowRatio[1] * LF_Lat4Inflow
      return(pmax(0, W_Drain))
    }
    zone_df$W_Drain1 <- calc_W_Drain(
      zone_df$W_EstDrain1,
      zl1$W_HRelDrain,
      zone_df$AF_LatInFlowRatio,
      zone_df$AF_AccLatInFlowRatio,
      layer_df[layer_df$layer == 1, ]$LF_Lat4Inflow
    )
    
    # W_V1Drain[Zone] = MAX(0,MIN(min(W_Drain1[Zone]*(1-W_H1RelDrain[Zone]),LF_V1MaxDailyFlow[Zone]),LF_MaxVInflow2[Zone]),0)
    zone_df$W_V1Drain <- pmax(0, pmin(
      pmin(
        zone_df$W_Drain1 * (1 - zl1$W_HRelDrain),
        zl1$LF_VMaxDailyFlow
      ),
      zl2$LF_MaxVInflow
    ))
    
    # W_EstDrain2[Zone] = IF W_WaterLog? = 0 then max(0,W_V1Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow2-W_WatDef2[Zone]) ELSE IF (W_V1Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow2) < S_KsatV2Act[Zone] then max(0,W_V1Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow2-W_WatDef2[Zone]) ELSE max(0,W_V1Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow2-W_WatDefLog2[Zone])
    calc_W_EstDrain <- function(W_WaterLog_is,
                                W_VDrain,
                                AF_AccLatInFlowRatio,
                                LF_Lat4Inflow,
                                S_KsatVAct,
                                W_WatDef,
                                W_WatDefLog) {
      W_EstDRAIN_a <- W_VDrain + AF_AccLatInFlowRatio * LF_Lat4Inflow
      W_EstDrain <- ifelse(
        W_WaterLog_is == 0,
        pmax(0, W_EstDRAIN_a - W_WatDef),
        ifelse(
          W_EstDRAIN_a < S_KsatVAct,
          pmax(0, W_EstDRAIN_a - W_WatDef),
          pmax(0, W_EstDRAIN_a - W_WatDefLog)
        )
      )
      return(W_EstDrain)
    }
    
    zone_df$W_EstDrain2 <- calc_W_EstDrain(
      zone_df$W_WaterLog_is,
      zone_df$W_V1Drain,
      zone_df$AF_AccLatInFlowRatio,
      zl2$LF_Lat4Inflow,
      zl2$S_KsatVAct,
      zl2$W_WatDef,
      zl2$W_WatDefLog
    )
    
    # W_Drain2[Zn1] = MAX(0,W_EstDrain2[Zn1]+AF_LatInFlowRatio[Zn1]*W_H2RelDrain[Zn2]*(W_EstDrain2[Zn2]+AF_LatInFlowRatio[Zn2]*W_H2RelDrain[Zn3]*(W_EstDrain2[Zn3]+AF_LatInFlowRatio[Zn3]*W_H2RelDrain[Zn4]*W_EstDrain2[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow2)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow2)-AF_AccLatInflowratio[Zn1]*LF_Lat4Inflow2)
    # W_Drain2[Zn2] = MAX(0,W_EstDrain2[Zn2]+AF_LatInFlowRatio[Zn2]*W_H2RelDrain[Zn3]*(W_EstDrain2[Zn3]+AF_LatInFlowRatio[Zn3]*W_H2RelDrain[Zn4]*W_EstDrain2[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow2)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow2)
    # W_Drain2[Zn3] = MAX(0,W_EstDrain2[Zn3]+AF_LatInFlowRatio[Zn3]*W_H2RelDrain[Zn4]*W_EstDrain2[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow2)
    # W_Drain2[Zn4] = MAX(0,W_EstDrain2[Zn4]+0 *(LF_Lat4Inflow2+W_H2RelDrain[Zn4] + AF_LatInFlowRatio[Zn4]+AF_AccLatInflowratio[Zn4]))
    zone_df$W_Drain2 <- calc_W_Drain(
      zone_df$W_EstDrain2,
      zl2$W_HRelDrain,
      zone_df$AF_LatInFlowRatio,
      zone_df$AF_AccLatInFlowRatio,
      layer_df[layer_df$layer == 2, ]$LF_Lat4Inflow
    )
    
    # W_V2Drain[Zone] = MAX(0,MIN(min(W_Drain2[Zone]*(1-W_H2RelDrain[Zone]),LF_V2MaxDailyFlow[Zone]),LF_MaxVInflow3[Zone]),0)
    zone_df$W_V2Drain <- pmax(0, pmin(
      pmin(
        zone_df$W_Drain2 * (1 - zl2$W_HRelDrain),
        zl2$LF_VMaxDailyFlow
      ),
      zl3$LF_MaxVInflow
    ))
    
    # W_EstDrain3[Zone] = if W_WaterLog? = 0 then max(0,W_V2Drain[Zone]+AF_AccLatInflowratio[Zone]*LF_Lat4Inflow3-W_WatDef3[Zone]) else if (W_V2Drain[Zone]+AF_AccLatInflowratio[Zone]*LF_Lat4Inflow3) < S_KsatV3Act[Zone] then max(0,W_V2Drain[Zone]+AF_AccLatInflowratio[Zone]*LF_Lat4Inflow3-W_WatDef3[Zone]) else max(0,W_V2Drain[Zone]+AF_AccLatInflowratio[Zone]*LF_Lat4Inflow3-W_WatDefLog3[Zone])
    zone_df$W_EstDrain3 <- calc_W_EstDrain(
      zone_df$W_WaterLog_is,
      zone_df$W_V2Drain,
      zone_df$AF_AccLatInFlowRatio,
      zl3$LF_Lat4Inflow,
      zl3$S_KsatVAct,
      zl3$W_WatDef,
      zl3$W_WatDefLog
    )
    
    # W_Drain3[Zn1] = MAX(0,W_EstDrain3[Zn1]+AF_LatInFlowRatio[Zn1]*W_H3RelDrain[Zn2]*(W_EstDrain3[Zn2]+AF_LatInFlowRatio[Zn2]*W_H3RelDrain[Zn3]*(W_EstDrain3[Zn3]+AF_LatInFlowRatio[Zn3]*W_H3RelDrain[Zn4]*W_EstDrain3[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow3)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow3)-AF_AccLatInflowratio[Zn1]*LF_Lat4Inflow3)
    # W_Drain3[Zn2] = MAX(0,W_EstDrain3[Zn2]+AF_LatInFlowRatio[Zn2]*W_H3RelDrain[Zn3]*(W_EstDrain3[Zn3]+AF_LatInFlowRatio[Zn3]*W_H3RelDrain[Zn4]*W_EstDrain3[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow3)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow3)
    # W_Drain3[Zn3] = MAX(0,W_EstDrain3[Zn3]+AF_LatInFlowRatio[Zn3]*W_H3RelDrain[Zn4]*W_EstDrain3[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow3)
    # W_Drain3[Zn4] = MAX(0,W_EstDrain3[Zn4]+0 *(LF_Lat4Inflow3+W_H3RelDrain[Zn4]+AF_LatInFlowRatio[Zn4]+AF_AccLatInflowratio[Zn4]))
    zone_df$W_Drain3 <- calc_W_Drain(
      zone_df$W_EstDrain3,
      zl3$W_HRelDrain,
      zone_df$AF_LatInFlowRatio,
      zone_df$AF_AccLatInFlowRatio,
      layer_df[layer_df$layer == 3, ]$LF_Lat4Inflow
    )
    
    # W_V3Drain[Zone] = MAX(0,MIN(min(W_Drain3[Zone]*(1-W_H3RelDrain[Zone]),LF_V3MaxDailyFlow[Zone]),LF_MaxVInflow4[Zone]))
    zone_df$W_V3Drain <- pmax(0, pmin(
      pmin(
        zone_df$W_Drain3 * (1 - zl3$W_HRelDrain),
        zl3$LF_VMaxDailyFlow
      ),
      zl4$LF_MaxVInflow
    ))
    
    # W_EstDrain4[Zone] = if W_WaterLog? = 0 then max(0,W_V3Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow4-W_WatDef4[Zone]) else if (W_V3Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow4) < S_KsatV4Act[Zone] then max(0,W_V3Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow4-W_WatDef4[Zone]) else max(0,W_V3Drain[Zone]+AF_AccLatInFlowRatio[Zone]*LF_Lat4Inflow4-W_WatDefLog4[Zone])
    zone_df$W_EstDrain4 <- calc_W_EstDrain(
      zone_df$W_WaterLog_is,
      zone_df$W_V3Drain,
      zone_df$AF_AccLatInFlowRatio,
      zl4$LF_Lat4Inflow,
      zl4$S_KsatVAct,
      zl4$W_WatDef,
      zl4$W_WatDefLog
    )
    
    # W_Drain4[Zn1] = MAX(0,W_EstDrain4[Zn1]+AF_LatInFlowRatio[Zn1]*W_H4RelDrain[Zn2]*(W_EstDrain4[Zn2]+AF_LatInFlowRatio[Zn2]*W_H4RelDrain[Zn3]*(W_EstDrain4[Zn3]+AF_LatInFlowRatio[Zn3]*W_H4RelDrain[Zn4]*W_EstDrain4[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow4)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow4)-AF_AccLatInflowratio[Zn1]*LF_Lat4Inflow4)
    # W_Drain4[Zn2] = MAX(0,W_EstDrain4[Zn2]+AF_LatInFlowRatio[Zn2]*W_H4RelDrain[Zn3]*(W_EstDrain4[Zn3]+AF_LatInFlowRatio[Zn3]*W_H4RelDrain[Zn4]*W_EstDrain4[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow4)-AF_AccLatInflowratio[Zn2]*LF_Lat4Inflow4)
    # W_Drain4[Zn3] = MAX(0,W_EstDrain4[Zn3]+AF_LatInFlowRatio[Zn3]*W_H4RelDrain[Zn4]*W_EstDrain4[Zn4]-AF_AccLatInflowratio[Zn3]*LF_Lat4Inflow4)
    # W_Drain4[Zn4] = MAX(0,W_EstDrain4[Zn4]+0 *(LF_Lat4Inflow4+W_H4RelDrain[Zn4]+AF_LatInFlowRatio[Zn4]+AF_AccLatInflowratio[Zn4]))
    zone_df$W_Drain4 <- calc_W_Drain(
      zone_df$W_EstDrain4,
      zl4$W_HRelDrain,
      zone_df$AF_LatInFlowRatio,
      zone_df$AF_AccLatInFlowRatio,
      layer_df[layer_df$layer == 4, ]$LF_Lat4Inflow
    )
    
    # W_V4Drain[Zone] = MAX(0, min(W_Drain4[Zone]*(1-W_H4RelDrain[Zone]),LF_V4MaxDailyFlow[Zone]))
    zone_df$W_V4Drain <- pmax(0, pmin(
      zone_df$W_Drain4 * (1 - zl4$W_HRelDrain),
      zl4$LF_VMaxDailyFlow
    ))
    
    zonelayer_df$W_Drain <- c(zone_df$W_Drain1,
                              zone_df$W_Drain2,
                              zone_df$W_Drain3,
                              zone_df$W_Drain4)
    zonelayer_df$W_VDrain <- c(zone_df$W_V1Drain,
                               zone_df$W_V2Drain,
                               zone_df$W_V3Drain,
                               zone_df$W_V4Drain)
    
    # W_H1Drain[Zone] = if AF_ZoneFrac[Zone] > 0 then min(W_Drain1[Zone]-W_V1Drain[Zone],LF_H1MaxMailyFlow[Zone]/AF_ZoneFrac[Zone]) else 0
    # W_H2Drain[Zone] = if AF_ZoneFrac[Zone]> 0 then min(W_Drain2[Zone]-W_V2Drain[Zone],LF_H2MaxDailyFlow[Zone]/AF_ZoneFrac[Zone]) else 0
    # W_H3Drain[Zone] = if AF_ZoneFrac[Zone]>0 then min(W_Drain3[Zone]-W_V3Drain[Zone],LF_H3MaxDailyFlow[Zone]/AF_ZoneFrac[Zone]) else 0
    # W_H4Drain[Zone] = if AF_ZoneFrac[Zone] > 0 then min(W_Drain4[Zone]-W_V4Drain[Zone],LF_H4MaxDailyFlow[Zone]/AF_ZoneFrac[Zone]) else 0
    zonelayer_df$W_HDrain <- ifelse(
      zonelayer_df$AF_ZoneFrac > 0,
      pmin(
        zonelayer_df$W_Drain - zonelayer_df$W_VDrain,
        zonelayer_df$LF_HMaxDailyFlow / zonelayer_df$AF_ZoneFrac
      ),
      0
    )
    
    # W_LatRecharge1[Zn1] = AF_LatInFlowRatio[Zn1]*W_H1Drain[Zn2]-W_H1Drain[Zn1]+0*LF_Lat4Inflow1
    # W_LatRecharge1[Zn2] = AF_LatInFlowRatio[Zn2]*W_H1Drain[Zn3]-W_H1Drain[Zn2]+0*LF_Lat4Inflow1
    # W_LatRecharge1[Zn3] = AF_LatInFlowRatio[Zn3]*W_H1Drain[Zn4]-W_H1Drain[Zn3]+0*LF_Lat4Inflow1
    # W_LatRecharge1[Zn4] = AF_LatInFlowRatio[Zn4]*LF_Lat4Inflow1 - W_H1Drain[Zn4]
    
    # W_LatRecharge2[Zn1] = AF_LatInFlowRatio[Zn1]*W_H2Drain[Zn2]-W_H2Drain[Zn1]+0*LF_Lat4Inflow2
    # W_LatRecharge2[Zn2] = AF_LatInFlowRatio[Zn2]*W_H2Drain[Zn3]-W_H2Drain[Zn2]+0*LF_Lat4Inflow2
    # W_LatRecharge2[Zn3] = AF_LatInFlowRatio[Zn3]*W_H2Drain[Zn4]-W_H2Drain[Zn3]+0*LF_Lat4Inflow2
    # W_LatRecharge2[Zn4] = AF_LatInFlowRatio[Zn4]*LF_Lat4Inflow2-W_H2Drain[Zn4]
    
    # W_LatRecharge3[Zn1] = AF_LatInFlowRatio[Zn1]*W_H3Drain[Zn2]-W_H3Drain[Zn1]+0*LF_Lat4Inflow3
    # W_LatRecharge3[Zn2] = AF_LatInFlowRatio[Zn2]*W_H3Drain[Zn3]+0*LF_Lat4Inflow3-W_H3Drain[Zn2]
    # W_LatRecharge3[Zn3] = AF_LatInFlowRatio[Zn3]*W_H3Drain[Zn4]+0*LF_Lat4Inflow3-W_H3Drain[Zn3]
    # W_LatRecharge3[Zn4] = AF_LatInFlowRatio[Zn4]*LF_Lat4Inflow3-W_H3Drain[Zn4]
    
    # W_LatRecharge4[Zn1] = AF_LatInFlowRatio[Zn1]*W_H4Drain[Zn2]-W_H4Drain[Zn1]+0*LF_Lat4Inflow4
    # W_LatRecharge4[Zn2] = AF_LatInFlowRatio[Zn2]*W_H4Drain[Zn3]+0*LF_Lat4Inflow4-W_H4Drain[Zn2]
    # W_LatRecharge4[Zn3] = AF_LatInFlowRatio[Zn3]*W_H4Drain[Zn4]+0*LF_Lat4Inflow4-W_H4Drain[Zn3]
    # W_LatRecharge4[Zn4] = AF_LatInFlowRatio[Zn4]*LF_Lat4Inflow4-W_H4Drain[Zn4]
    
    # zonelayer_df$W_HDRAIN_right <- 0
    # for (i in 1:nlayer) {
    #   zonelayer_df[zonelayer_df$layer == i, ]$W_HDRAIN_right <- c(tail(zonelayer_df[zonelayer_df$layer == i, ]$W_HDrain, -1),
    #                                                               layer_df[layer_df$layer == i, ]$LF_Lat4Inflow)
    # }
    
    zonelayer_df$W_HDRAIN_right <- NA
    zonelayer_df[zonelayer_df$zone != 4, "W_HDRAIN_right"] <- zonelayer_df[zonelayer_df$zone != 1, "W_HDrain"]
    zonelayer_df[zonelayer_df$zone == 4, "W_HDRAIN_right"] <- layer_df$LF_Lat4Inflow
    
    zonelayer_df$AF_LatInFlowRatio <- rep(zone_df$AF_LatInFlowRatio, nlayer)
    zonelayer_df$W_LatRecharge <- zonelayer_df$AF_LatInFlowRatio * zonelayer_df$W_HDRAIN_right - zonelayer_df$W_HDrain
    
    
    
    
    # Rt3_LRV1[Zone,Tree] = if RT3_VoxVol[Zone,1]>0 then (10^-4)*RT_L1FRLength[Zone,Tree]/RT3_VoxVol[Zone,1] else 0
    # Rt3_LRV2[Zone,Tree] = if RT3_VoxVol[Zone,2]>0 then (10^-4)*RT_L2FRLength[Zone,Tree]/RT3_VoxVol[Zone,2] else 0
    # Rt3_LRV3[Zone,Tree] = if RT3_VoxVol[Zone,3]>0 then (10^-4)*RT_L3FRLength[Zone,Tree]/RT3_VoxVol[Zone,3] else 0
    # Rt3_LRV4[Zone,Tree] = if RT3_VoxVol[Zone,4]>0 then (10^-4)*RT_L4FRLength[Zone,Tree]/RT3_VoxVol[Zone,4] else 0
    zonelayertree_df$RT3_VoxVol <- rep(zonelayer_df$RT3_VoxVol, ntree)
    
    zonelayertree_df$Rt3_LRV <- ifelse(
      zonelayertree_df$RT3_VoxVol > 0,
      (10^-4) * zonelayertree_df$RT_FRLength / zonelayertree_df$RT3_VoxVol,
      0
    )
    
    
    
    
    # T_Root_DWtot[Sp1] = AF_ZoneFrac[Zn1]*(T_RootT1DW[Zn1,1]+T_RootT1DW[Zn1,2]+T_RootT1DW[Zn1,3]+T_RootT3DW[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT1DW[Zn2,1]+T_RootT1DW[Zn2,2]+T_RootT1DW[Zn2,3]+T_RootT1DW[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT1DW[Zn3,1]+T_RootT1DW[Zn3,2]+T_RootT1DW[Zn3,3]+T_RootT1DW[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT1DW[Zn4,1]+T_RootT1DW[Zn4,2]+T_RootT1DW[Zn4,3]+T_RootT1DW[Zn4,4])+
    #   0*(T_RootT1DW[Zn1,1]+T_RootT2DW[Zn1,1]+T_RootT3DW[Zn1,1])
    # T_Root_DWtot[Sp2] = AF_ZoneFrac[Zn1]*(T_RootT2DW[Zn1,1]+T_RootT2DW[Zn1,2]+T_RootT2DW[Zn1,3]+T_RootT2DW[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT2DW[Zn2,1]+T_RootT2DW[Zn2,2]+T_RootT2DW[Zn2,3]+T_RootT2DW[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT2DW[Zn3,1]+T_RootT2DW[Zn3,2]+T_RootT2DW[Zn3,3]+T_RootT2DW[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT2DW[Zn4,1]+T_RootT2DW[Zn4,2]+T_RootT2DW[Zn4,3]+T_RootT2DW[Zn4,4])+
    #   0*(T_RootT1DW[Zn1,1]+T_RootT2DW[Zn1,1]+T_RootT3DW[Zn1,1])
    # T_Root_DWtot[Sp3] = AF_ZoneFrac[Zn1]*(T_RootT3DW[Zn1,1]+T_RootT3DW[Zn1,2]+T_RootT3DW[Zn1,3]+T_RootT3DW[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT3DW[Zn2,1]+T_RootT3DW[Zn2,2]+T_RootT3DW[Zn2,3]+T_RootT3DW[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT3DW[Zn3,1]+T_RootT3DW[Zn3,2]+T_RootT3DW[Zn3,3]+T_RootT3DW[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT3DW[Zn4,1]+T_RootT3DW[Zn4,2]+T_RootT3DW[Zn4,3]+T_RootT3DW[Zn4,4])+
    #   0*(T_RootT1DW[Zn1,1]+T_RootT2DW[Zn1,1]+T_RootT3DW[Zn1,1])
    
    T_RootTDW_byzone_df <- aggregate(list(T_Root = zonelayertreepcomp_df[zonelayertreepcomp_df$PlantComp == "DW", "T_Root"]), by = zonelayertree_df[c("zone", "tree_id")], sum)
    T_RootTDW_byzone_df <- merge(T_RootTDW_byzone_df, zone_df[c("zone", "AF_ZoneFrac")], by = "zone")
    T_RootTDW_byzone_df$T_RootTDW_frac <- T_RootTDW_byzone_df$AF_ZoneFrac * T_RootTDW_byzone_df$T_Root
    T_Root_DWtot_df <- aggregate(T_RootTDW_byzone_df[c("T_RootTDW_frac")], by = T_RootTDW_byzone_df[c("tree_id")], sum)
    T_Root_DWtot_df <- T_Root_DWtot_df[order(T_Root_DWtot_df$tree_id), ]
    tree_df$T_Root_DWtot <- T_Root_DWtot_df$T_RootTDW_frac
    
    # T_ProxRootSumDiamSq[Tree] = IF (RT_TProxGini[Tree]>0 AND T_DiamRtWght1[Tree]>0 and T_Treesperha[Tree]>0) THEN (RT_TProxGini[Tree]/(2+RT_TProxGini[Tree]))*(T_Root_DWtot[Tree]*(10000/T_Treesperha[Tree])*(T_DiamSlopeRtWght[Tree]+RT_TProxGini[Tree])/(RT_TProxGini[Tree]*T_DiamRtWght1[Tree]))^(2/T_DiamSlopeRtWght[Tree]) ELSE 0
    tree_df$T_ProxRootSumDiamSq <- ifelse(
      tree_df$RT_TProxGini > 0 &
        tree_df$T_DiamRtWght1 > 0 & tree_df$T_Treesperha > 0,
      (tree_df$RT_TProxGini / (2 + tree_df$RT_TProxGini)) *
        (
          tree_df$T_Root_DWtot * (10000 / tree_df$T_Treesperha) *
            (tree_df$T_DiamSlopeRtWght +
               tree_df$RT_TProxGini) / (tree_df$RT_TProxGini * tree_df$T_DiamRtWght1)
        )^(2 / tree_df$T_DiamSlopeRtWght),
      0
    )
    
    
    # RT_TTotLength[Tree] = IF T_DiamSlopeRtLeng[Tree]>0 AND RT_TProxGini[Tree] >0 THEN (T_Treesperha[Tree]/10000)*(T_DiamRtLeng1[Tree]*RT_TProxGini[Tree]/(T_DiamSlopeRtLeng[Tree]+RT_TProxGini[Tree]))*(T_ProxRootSumDiamSq[Tree]*(RT_TProxGini[Tree]+2)/RT_TProxGini[Tree])^(T_DiamSlopeRtLeng[Tree]/2) ELSE 0
    tree_df$RT_TTotLength <- ifelse(
      tree_df$T_DiamSlopeRtLeng > 0 & tree_df$RT_TProxGini > 0,
      (tree_df$T_Treesperha / 10000) * (
        tree_df$T_DiamRtLeng1 * tree_df$RT_TProxGini / (tree_df$T_DiamSlopeRtLeng +
                                                          tree_df$RT_TProxGini)
      ) * (
        tree_df$T_ProxRootSumDiamSq * (tree_df$RT_TProxGini + 2) / tree_df$RT_TProxGini
      )^(tree_df$T_DiamSlopeRtLeng / 2),
      0
    )
    
    
    
    # RT_TSRL[Tree] = if RT_T_UseFBASRL? then (if T_Root_DWtot[Tree]>0 then (RT_TTotLength[Tree]/T_Root_DWtot[Tree])*10^-5 else RT_T_FixedSRL) else RT_T_FixedSRL
    tree_df$RT_T_UseFBASRL_is <- RT_T_UseFBASRL_is
    
    tree_df$RT_TSRL <- ifelse(
      tree_df$RT_T_UseFBASRL_is == 1,
      ifelse(
        tree_df$T_Root_DWtot > 0,
        (tree_df$RT_TTotLength / tree_df$T_Root_DWtot) * 10^-5,
        RT_T_FixedSRL
      ),
      RT_T_FixedSRL
    )
    
    #TODO: RT_TLraCD is dynamic but seems static here
    
    # RT_TLraX0D[Tree] = IF(RT_TLraCD[Tree]>0)THEN(1000*T_Root_DWtot[Tree]*RT_TSRL[Tree]/RT_TLraCD[Tree])ELSE(0)
    tree_df$RT_TLraX0D <- ifelse(
      tree_df$RT_TLraCD > 0,
      1000 * tree_df$T_Root_DWtot * tree_df$RT_TSRL / tree_df$RT_TLraCD,
      0
    )
    
    # RT_TlraX0Curr[Tree] = IF(RT_ATType[Tree]=1)THEN(RT_TLraX0[Tree])ELSE IF RT_ATType[Tree]=2 THEN RT_TLraX0D[Tree] ELSE (0)
    tree_df$RT_TlraX0Curr <- ifelse(
      tree_df$RT_ATType == 1 ,
      tree_df$RT_TLraX0,
      ifelse(tree_df$RT_ATType == 2, tree_df$RT_TLraX0D, 0)
    )
    
    
    #TODO: this can be moved to init
    zonelayertree_df$RT_ZoneLeft <- rep(zone_df$RT_ZoneLeft, nlayer * ntree)
    zonelayertree_df$RT_ZoneRight <- rep(zone_df$RT_ZoneRight, nlayer * ntree)
    zonelayertree_df$RT_Depth <- rep(zonelayer_df$RT_Depth, ntree)
    zonelayertree_df$RT_Depth_up <- 0
    zonelayertree_df[zonelayertree_df$layer %in% 2:4, "RT_Depth_up"] <- zonelayertree_df[zonelayertree_df$layer %in% 1:3, "RT_Depth"]
    zonelayertree_df$AF_TreePosit2Q <- rep(tree_df$AF_TreePosit2Q, each = nzone *
                                             nlayer)
    zonelayertree_df$AF_TreePosit3Q <- rep(tree_df$AF_TreePosit3Q, each = nzone *
                                             nlayer)
    zonelayertree_df$AF_TreePosit4Q <- rep(tree_df$AF_TreePosit4Q, each = nzone *
                                             nlayer)
    
    
    #### up
    
    
    zonelayertree_df$RT_TDistShapeAct <- rep(tree_df$RT_TDistShapeAct, each = nzone *
                                               nlayer)
    zonelayertree_df$RT_TlraX0Curr <- rep(tree_df$RT_TlraX0Curr, each = nzone *
                                            nlayer)
    zonelayertree_df$RT_TDecDepthAct <- rep(tree_df$RT_TDecDepthAct, each = nzone *
                                              nlayer)
    
    # RT_TLrvEllip1[Zone,Tree] = RT_TlraX0Curr[Tree]*RT_TDecDepthAct[Tree]*EXP(-0.25*RT_TDecDepthAct[Tree]*((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])+(RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth1[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth1[Zone]^2)))/10000
    # RT_TLrvEllip2[Zone,Tree] = RT_TlraX0Curr[Tree]*RT_TDecDepthAct[Tree]*EXP(-0.25*RT_TDecDepthAct[Tree]*(SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth1[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth1[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth2[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth2[Zone]^2)))/10000
    # RT_TLrvEllip3[Zone,Tree] = RT_TlraX0Curr[Tree]*RT_TDecDepthAct[Tree]*EXP(-0.25*RT_TDecDepthAct[Tree]*(SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth2[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth2[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth3[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth3[Zone]^2)))/10000
    # RT_TLrvEllip4[Zone,Tree] = RT_TlraX0Curr[Tree]*RT_TDecDepthAct[Tree]*EXP(-0.25*RT_TDecDepthAct[Tree]*(SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth3[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth3[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneLeft[Zone])^2+RT_Depth4[Zone]^2)+SQRT((RT_TDistShapeAct[Tree]*RT_ZoneRight[Zone])^2+RT_Depth4[Zone]^2)))/10000
    
    
    zonelayertree_df$RT_TDecDepthAct_a <- sqrt((
      zonelayertree_df$RT_TDistShapeAct * zonelayertree_df$RT_ZoneLeft
    )^2 + zonelayertree_df$RT_Depth_up^2
    ) +
      sqrt((
        zonelayertree_df$RT_TDistShapeAct * zonelayertree_df$RT_ZoneRight
      )^2 + zonelayertree_df$RT_Depth_up^2
      )
    zonelayertree_df$RT_TDecDepthAct_b <- sqrt((
      zonelayertree_df$RT_TDistShapeAct * zonelayertree_df$RT_ZoneLeft
    )^2 + zonelayertree_df$RT_Depth^2
    ) +
      sqrt((
        zonelayertree_df$RT_TDistShapeAct * zonelayertree_df$RT_ZoneRight
      )^2 + zonelayertree_df$RT_Depth^2
      )
    
    zl1t <- zonelayertree_df[zonelayertree_df$layer == 1, ]
    zonelayertree_df[zonelayertree_df$layer == 1, "RT_TDecDepthAct_a"] <- (zl1t$RT_TDistShapeAct * zl1t$RT_ZoneLeft) + (zl1t$RT_TDistShapeAct * zl1t$RT_ZoneRight)
    
    zonelayertree_df$RT_TLrvEllip <- zonelayertree_df$RT_TlraX0Curr * zonelayertree_df$RT_TDecDepthAct *
      exp(
        -0.25 * zonelayertree_df$RT_TDecDepthAct *  (
          zonelayertree_df$RT_TDecDepthAct_a + zonelayertree_df$RT_TDecDepthAct_b
        )
      ) / 10000
    
    
    
    
    
    # RT_TLrvEllipAct1[Zn1,Sp1] = RT_TLrvEllip1[Zn1,Sp1]*(1-AF_TreePosit4Q[Sp1]) + AF_TreePosit4Q[Sp1]*RT_TLrvEllip1[Zn4,Sp1]
    # RT_TLrvEllipAct1[Zn1,Sp2] = RT_TLrvEllip1[Zn1,Sp2]*(1-AF_TreePosit4Q[Sp2]) + AF_TreePosit4Q[Sp2]*RT_TLrvEllip1[Zn4,Sp2]
    # RT_TLrvEllipAct1[Zn1,Sp3] = RT_TLrvEllip1[Zn1,Sp3]*(1-AF_TreePosit4Q[Sp3]) + AF_TreePosit4Q[Sp3]*RT_TLrvEllip1[Zn4,Sp3]
    # RT_TLrvEllipAct1[Zn2,Sp1] = RT_TLrvEllip1[Zn2,Sp1]*(1-AF_TreePosit4Q[Sp1]) + AF_TreePosit4Q[Sp1]*RT_TLrvEllip1[Zn3,Sp1]
    # RT_TLrvEllipAct1[Zn2,Sp2] = RT_TLrvEllip1[Zn2,Sp2]*(1-AF_TreePosit4Q[Sp2]) + AF_TreePosit4Q[Sp2]*RT_TLrvEllip1[Zn3,Sp2]
    # RT_TLrvEllipAct1[Zn2,Sp3] = RT_TLrvEllip1[Zn2,Sp3]*(1-AF_TreePosit4Q[Sp3]) + AF_TreePosit4Q[Sp3]*RT_TLrvEllip1[Zn3,Sp3]
    zonelayertree_df$RT_TLrvEllipAct <- zonelayertree_df$RT_TLrvEllip * (1 - zonelayertree_df$AF_TreePosit4Q) + zonelayertree_df$AF_TreePosit4Q * zonelayertree_df$RT_TLrvEllip
    
    
    
    
    
    # RT_TPresence[Tree] = IF (TIME = (T_PlantTime[Tree]-1) OR T_GroRes[DW,Tree]>0) THEN 1 ELSE 0
    tree_df$time <- time
    tree_df$RT_TPresence <- ifelse(tree_df$time == (tree_df$T_PlantTime - 1) |
                                     treepcomp_df[treepcomp_df$PlantComp == "DW", "T_GroRes"] > 0,
                                   1,
                                   0)
    
    zonelayertree_df$RT_TPresence <- rep(tree_df$RT_TPresence, each = nzone * nlayer)
    
    
    
    
    
    
    # RT_TLrvL1[Zn1,Sp1] = IF AF_TreePosit4Q[Sp1]=0 AND AF_TreePosit2Q[Sp1]=0 AND AF_TreePosit3Q[Sp1]=0 THEN 0*T_Par2[Lrv31]+T_Par1[Lrv11]*RT_TMultiplier+0*T_Par3[Lrv24]
    # ELSE IF AF_TreePosit2Q[Sp1]=1 THEN T_Par1[Lrv13]*RT_TMultiplier
    # ELSE IF AF_TreePosit3Q[Sp1]=1 THEN T_Par1[Lrv14]*RT_TMultiplier
    # ELSE T_Par2[Lrv14]*RT_TMultiplier
    # RT_TLrvL1[Zn1,Sp2] =  IF AF_TreePosit4Q[Sp2]=0 AND AF_TreePosit2Q[Sp2]=0 AND AF_TreePosit3Q[Sp2]=0 THEN 0*T_Par1[Lrv31]+T_Par2[Lrv11]*RT_TMultiplier+0*T_Par3[Lrv24]
    # ELSE IF AF_TreePosit2Q[Sp2]=1 THEN T_Par2[Lrv13]*RT_TMultiplier
    # ELSE IF AF_TreePosit3Q[Sp2]=1 THEN T_Par2[Lrv14]*RT_TMultiplier
    # ELSE T_Par2[Lrv14]*RT_TMultiplier
    # RT_TLrvL1[Zn1,Sp3] =  IF AF_TreePosit4Q[Sp3]=0 AND AF_TreePosit2Q[Sp3]=0 AND AF_TreePosit3Q[Sp3]=0 THEN 0*T_Par1[Lrv31]+0*T_Par2[Lrv14]+T_Par3[Lrv11]*RT_TMultiplier
    # ELSE IF AF_TreePosit2Q[Sp3]=1 THEN T_Par3[Lrv13]*RT_TMultiplier
    # ELSE IF AF_TreePosit3Q[Sp3]=1 THEN T_Par3[Lrv14]*RT_TMultiplier
    # ELSE T_Par3[Lrv14]*RT_TMultiplier
    # RT_TLrvL1[Zn2,Sp1] =  IF AF_TreePosit4Q[Sp1]=0 AND AF_TreePosit2Q[Sp1]=0 AND AF_TreePosit3Q[Sp1]=0 THEN T_Par1[Lrv12]*RT_TMultiplier+0*T_Par2[Lrv14]+0*T_Par3[Lrv14]
    # ELSE IF AF_TreePosit2Q[Sp1]=1 THEN T_Par1[Lrv11]*RT_TMultiplier
    # ELSE IF AF_TreePosit3Q[Sp1]=1 THEN T_Par1[Lrv13]*RT_TMultiplier
    # ELSE T_Par1[Lrv13]*RT_TMultiplier
    # RT_TLrvL1[Zn2,Sp2] =  IF AF_TreePosit4Q[Sp2]=0 AND AF_TreePosit2Q[Sp2]=0 AND AF_TreePosit3Q[Sp2]=0 THEN 0*T_Par1[Lrv31]+T_Par2[Lrv12]*RT_TMultiplier+0*T_Par3[Lrv24]
    # ELSE IF AF_TreePosit2Q[Sp2]=1 THEN T_Par2[Lrv11]*RT_TMultiplier
    # ELSE IF AF_TreePosit3Q[Sp2]=1 THEN T_Par2[Lrv13]*RT_TMultiplier
    # ELSE T_Par2[Lrv13]*RT_TMultiplier
    # RT_TLrvL1[Zn2,Sp3] =  IF AF_TreePosit4Q[Sp3]=0 AND AF_TreePosit2Q[Sp3]=0 AND AF_TreePosit3Q[Sp3]=0 THEN 0*T_Par1[Lrv31]+0*T_Par2[Lrv14]+T_Par3[Lrv12]*RT_TMultiplier
    # ELSE IF AF_TreePosit2Q[Sp3]=1 THEN T_Par3[Lrv11]*RT_TMultiplier
    # ELSE IF AF_TreePosit3Q[Sp3]=1 THEN T_Par3[Lrv13]*RT_TMultiplier
    # ELSE T_Par3[Lrv13]*RT_TMultiplier
    # ...
    
    
    
    zonelayertree_df$RT_TLrvL_2Q <- 0
    zonelayertree_df$RT_TLrvL_3Q <- 0
    zonelayertree_df$RT_TLrvL_def <- 0
    
    zonelayertree_df[zonelayertree_df$zone == 1, "RT_TLrvL_2Q"] <- zonelayertree_df[zonelayertree_df$zone == 3, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 2, "RT_TLrvL_2Q"] <- zonelayertree_df[zonelayertree_df$zone == 1, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 3, "RT_TLrvL_2Q"] <- zonelayertree_df[zonelayertree_df$zone == 2, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 4, "RT_TLrvL_2Q"] <- zonelayertree_df[zonelayertree_df$zone == 4, "RT_TLrvL_par"]
    
    zonelayertree_df[zonelayertree_df$zone == 1, "RT_TLrvL_3Q"] <- zonelayertree_df[zonelayertree_df$zone == 4, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 2, "RT_TLrvL_3Q"] <- zonelayertree_df[zonelayertree_df$zone == 3, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 3, "RT_TLrvL_3Q"] <- zonelayertree_df[zonelayertree_df$zone == 1, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 4, "RT_TLrvL_3Q"] <- zonelayertree_df[zonelayertree_df$zone == 2, "RT_TLrvL_par"]
    
    zonelayertree_df[zonelayertree_df$zone == 1, "RT_TLrvL_def"] <- zonelayertree_df[zonelayertree_df$zone == 4, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 2, "RT_TLrvL_def"] <- zonelayertree_df[zonelayertree_df$zone == 3, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 3, "RT_TLrvL_def"] <- zonelayertree_df[zonelayertree_df$zone == 2, "RT_TLrvL_par"]
    zonelayertree_df[zonelayertree_df$zone == 4, "RT_TLrvL_def"] <- zonelayertree_df[zonelayertree_df$zone == 1, "RT_TLrvL_par"]
    
    
    zonelayertree_df$RT_TLrvL <- ifelse(
      zonelayertree_df$AF_TreePosit4Q == 0 &
        zonelayertree_df$AF_TreePosit2Q == 0 &
        zonelayertree_df$AF_TreePosit3Q == 0,
      zonelayertree_df$RT_TLrvL_par * RT_TMultiplier,
      ifelse(
        zonelayertree_df$AF_TreePosit2Q == 1,
        zonelayertree_df$RT_TLrvL_2Q * RT_TMultiplier,
        ifelse(
          zonelayertree_df$AF_TreePosit3Q == 1,
          zonelayertree_df$RT_TLrvL_3Q * RT_TMultiplier,
          zonelayertree_df$RT_TLrvL_def * RT_TMultiplier
        )
      )
    )
    
    
    # W_PoreVol[Zone,SoilLayer] = (1-W_BDLayer[SoilLayer]*S_RelBD[Zone,SoilLayer]/2.5)
    zonelayer_df$W_PoreVol <- (1 - zonelayer_df$W_BDLayer * zonelayer_df$S_RelBD / 2.5)
    
    
    
    # W_PoreVolAbFC[Zn1,1] = W_PoreVol[Zn1,1]-W_FieldCap1[Zn1]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn1,2] = W_PoreVol[Zn1,2]-W_FieldCap2[Zn1]+(0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn1,3] = W_PoreVol[Zn1,3]-W_FieldCap3[Zn1]+(0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn1,4] = W_PoreVol[Zn1,4]-W_FieldCap4[Zn1]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]))
    # W_PoreVolAbFC[Zn2,1] = W_PoreVol[Zn2,1]-W_FieldCap1[Zn2]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn2,2] = W_PoreVol[Zn2,2]-W_FieldCap2[Zn2]+(0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn2,3] = W_PoreVol[Zn2,3]-W_FieldCap3[Zn2]+(0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn2,4] = W_PoreVol[Zn2,4]-W_FieldCap4[Zn2]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]))
    # W_PoreVolAbFC[Zn3,1] = W_PoreVol[Zn3,1]-W_FieldCap1[Zn3]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn3,2] = W_PoreVol[Zn3,2]-W_FieldCap2[Zn3]+(0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn3,3] = W_PoreVol[Zn3,3]-W_FieldCap3[Zn3]+(0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn3,4] = W_PoreVol[Zn3,4]-W_FieldCap4[Zn3]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]))
    # W_PoreVolAbFC[Zn4,1] = W_PoreVol[Zn4,1]-W_FieldCap1[Zn4]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn4,2] = W_PoreVol[Zn4,2]-W_FieldCap2[Zn4]+(0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn4,3] = W_PoreVol[Zn4,3]-W_FieldCap3[Zn4]+(0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]))
    # W_PoreVolAbFC[Zn4,4] = W_PoreVol[Zn4,4]-W_FieldCap4[Zn4]+(0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]))
    
    zonelayer_df$W_PoreVolAbFC <- zonelayer_df$W_PoreVol - zonelayer_df$W_FieldCap
    
    
    # W_WaterLog[Zn1,1] = if (W_WaterfilledPoreF1[Zn1]*W_PoreVol[Zn1,1])-W_FieldCap1[Zn1] < 0 then 0 else (W_WaterfilledPoreF1[Zn1]*W_PoreVol[Zn1,1])-W_FieldCap1[Zn1] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn1,2] = if (W_WaterfilledPoreF2[Zn1]*W_PoreVol[Zn1,2])-W_FieldCap2[Zn1] < 0 then 0 else (W_WaterfilledPoreF2[Zn1]*W_PoreVol[Zn1,2])-W_FieldCap2[Zn1] + (0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn1,3] = if (W_WaterfilledPoreF3[Zn1]*W_PoreVol[Zn1,3])-W_FieldCap3[Zn1] < 0 then 0 else (W_WaterfilledPoreF3[Zn1]*W_PoreVol[Zn1,3])-W_FieldCap3[Zn1] + (0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn1,4] = if (W_WaterfilledPoreF4[Zn1]*W_PoreVol[Zn1,4])-W_FieldCap4[Zn1] < 0 then 0 else (W_WaterfilledPoreF4[Zn1]*W_PoreVol[Zn1,4])-W_FieldCap4[Zn1] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF1[Zn1]))
    # W_WaterLog[Zn2,1] = if (W_WaterfilledPoreF1[Zn2]*W_PoreVol[Zn2,1])-W_FieldCap1[Zn2] < 0 then 0 else (W_WaterfilledPoreF1[Zn2]*W_PoreVol[Zn2,1])-W_FieldCap1[Zn2] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn2,2] = if (W_WaterfilledPoreF2[Zn2]*W_PoreVol[Zn2,2])-W_FieldCap2[Zn2] < 0 then 0 else (W_WaterfilledPoreF2[Zn2]*W_PoreVol[Zn2,2])-W_FieldCap2[Zn2] + (0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn2,3] = if (W_WaterfilledPoreF3[Zn2]*W_PoreVol[Zn2,3])-W_FieldCap3[Zn2] < 0 then 0 else (W_WaterfilledPoreF3[Zn2]*W_PoreVol[Zn2,3])-W_FieldCap3[Zn2] + (0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn2,4] = if (W_WaterfilledPoreF4[Zn2]*W_PoreVol[Zn2,4])-W_FieldCap4[Zn2] < 0 then 0 else (W_WaterfilledPoreF4[Zn2]*W_PoreVol[Zn2,4])-W_FieldCap4[Zn2] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF1[Zn1]))
    # W_WaterLog[Zn3,1] = if (W_WaterfilledPoreF1[Zn3]*W_PoreVol[Zn3,1])-W_FieldCap1[Zn3] < 0 then 0 else (W_WaterfilledPoreF1[Zn3]*W_PoreVol[Zn3,1])-W_FieldCap1[Zn3] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn3,2] = if (W_WaterfilledPoreF2[Zn3]*W_PoreVol[Zn3,2])-W_FieldCap2[Zn3] < 0 then 0 else (W_WaterfilledPoreF2[Zn3]*W_PoreVol[Zn3,2])-W_FieldCap2[Zn3] + (0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn3,3] = if (W_WaterfilledPoreF3[Zn3]*W_PoreVol[Zn3,3])-W_FieldCap3[Zn3] < 0 then 0 else (W_WaterfilledPoreF3[Zn3]*W_PoreVol[Zn3,3])-W_FieldCap3[Zn3] + (0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn3,4] = if (W_WaterfilledPoreF4[Zn3]*W_PoreVol[Zn3,4])-W_FieldCap4[Zn3] < 0 then 0 else (W_WaterfilledPoreF4[Zn3]*W_PoreVol[Zn3,4])-W_FieldCap4[Zn3] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF1[Zn1]))
    # W_WaterLog[Zn4,1] = if (W_WaterfilledPoreF1[Zn4]*W_PoreVol[Zn4,1])-W_FieldCap1[Zn4] < 0 then 0 else (W_WaterfilledPoreF1[Zn4]*W_PoreVol[Zn4,1])-W_FieldCap1[Zn4] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn4,2] = if (W_WaterfilledPoreF2[Zn4]*W_PoreVol[Zn4,2])-W_FieldCap2[Zn4] < 0 then 0 else (W_WaterfilledPoreF2[Zn4]*W_PoreVol[Zn4,2])-W_FieldCap2[Zn4] + (0*(W_FieldCap1[Zn1]+W_FieldCap3[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn4,3] = if (W_WaterfilledPoreF3[Zn4]*W_PoreVol[Zn4,3])-W_FieldCap3[Zn4] < 0 then 0 else (W_WaterfilledPoreF3[Zn4]*W_PoreVol[Zn4,3])-W_FieldCap3[Zn4] + (0*(W_FieldCap2[Zn1]+W_FieldCap1[Zn1]+W_FieldCap4[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF1[Zn1]+W_WaterfilledPoreF4[Zn1]))
    # W_WaterLog[Zn4,4] = if (W_WaterfilledPoreF4[Zn4]*W_PoreVol[Zn4,4])-W_FieldCap4[Zn4] < 0 then 0 else (W_WaterfilledPoreF4[Zn4]*W_PoreVol[Zn4,4])-W_FieldCap4[Zn4] + (0*(W_FieldCap2[Zn1]+W_FieldCap3[Zn1]+W_FieldCap1[Zn1]+W_WaterfilledPoreF2[Zn1]+W_WaterfilledPoreF3[Zn1]+W_WaterfilledPoreF1[Zn1]))
    
    zonelayer_df$W_WaterLog <- ifelse(
      (zonelayer_df$W_WaterfilledPoreF * zonelayer_df$W_PoreVol) - zonelayer_df$W_FieldCap < 0,
      0,
      (zonelayer_df$W_WaterfilledPoreF * zonelayer_df$W_PoreVol) - zonelayer_df$W_FieldCap
    )
    
    
    # W_AnaerobiosisIndex[Zone,SoilLayer] = if W_WaterLog[Zone,SoilLayer]/W_PoreVolAbFC[Zone,SoilLayer] < 0 then 0 else W_WaterLog[Zone,SoilLayer]/W_PoreVolAbFC[Zone,SoilLayer]
    zonelayer_df$W_AnaerobiosisIndex <- ifelse(
      zonelayer_df$W_WaterLog / zonelayer_df$W_PoreVolAbFC < 0,
      0,
      zonelayer_df$W_WaterLog / zonelayer_df$W_PoreVolAbFC
    )
    
    zonelayertree_df$W_AnaerobiosisIndex <- rep(zonelayer_df$W_AnaerobiosisIndex, nrow(tree_df))
    
    # RT_TLrvEff1[Zone,Tree] = RT_TLrvL1[Zone,Tree]*(1-W_AnaerobiosisIndex1[Zone])
    # RT_TLrvEff2[Zone,Tree] = RT_TLrvL2[Zone,Tree]*(1-W_AnaerobiosisIndex2[Zone])
    # RT_TLrvEff3[Zone,Tree] = RT_TLrvL3[Zone,Tree]*(1-W_AnaerobiosisIndex3[Zone])
    # RT_TLrvEff4[Zone,Tree] = RT_TLrvL4[Zone,Tree]*(1-W_AnaerobiosisIndex4[Zone])
    zonelayertree_df$RT_TLrvEff <- zonelayertree_df$RT_TLrvL * (1 - zonelayertree_df$W_AnaerobiosisIndex)
    
    
    
    
    
    
    # RT_TLrvMinM1[Zone,Tree] = if AF_AnyTrees? < 0.5 then 0 else IF(RT_ATType[Tree]=3) THEN (Rt3_LRV1[Zone,Tree]) else IF(RT_ATType[Tree]=2)THEN (RT_TLrvEllipAct1[Zone,Tree]) else IF(RT_ATType[Tree]=1)THEN (RT_TLrvEllipAct1[Zone,Tree]) ELSE if W_WaterLog? = 1 then (RT_TPresence[Tree]*RT_TLrvEff1[Zone,Tree]) else (RT_TPresence[Tree]*RT_TLrvL1[Zone,Tree])
    # RT_TLrvMinM2[Zone,Tree] = if AF_AnyTrees? < 0.5 then 0 else IF(RT_ATType[Tree]=3) THEN (Rt3_LRV2[Zone,Tree]) else IF(RT_ATType[Tree]=2)THEN (RT_TLrvEllipAct2[Zone,Tree]) else IF(RT_ATType[Tree]=1)THEN (RT_TLrvEllipAct2[Zone,Tree]) ELSE if W_WaterLog? = 1 then (RT_TPresence[Tree]*RT_TLrvEff2[Zone,Tree]) else (RT_TPresence[Tree]*RT_TLrvL2[Zone,Tree])
    # RT_TLrvMinM3[Zone,Tree] = if AF_AnyTrees? < 0.5 then 0 else IF(RT_ATType[Tree]=3) THEN (Rt3_LRV3[Zone,Tree]) else IF(RT_ATType[Tree]=2)THEN (RT_TLrvEllipAct3[Zone,Tree]) else IF(RT_ATType[Tree]=1)THEN (RT_TLrvEllipAct3[Zone,Tree]) ELSE if W_WaterLog? = 1 then (RT_TPresence[Tree]*RT_TLrvEff3[Zone,Tree]) else (RT_TPresence[Tree]*RT_TLrvL3[Zone,Tree])
    # RT_TLrvMinM4[Zone,Tree] = if AF_AnyTrees? < 0.5 then 0 else IF(RT_ATType[Tree]=3) THEN (Rt3_LRV3[Zone,Tree]) else IF(RT_ATType[Tree]=2)THEN (RT_TLrvEllipAct4[Zone,Tree]) else IF(RT_ATType[Tree]=1)THEN (RT_TLrvEllipAct4[Zone,Tree]) ELSE if W_WaterLog? = 1 then (RT_TPresence[Tree]*RT_TLrvEff4[Zone,Tree]) else (RT_TPresence[Tree]*RT_TLrvL4[Zone,Tree])
    zonelayertree_df$AF_AnyTrees_is <- AF_AnyTrees_is
    zonelayertree_df$W_WaterLog_is <- W_WaterLog_is
    
    zonelayertree_df$RT_TLrvMinM <- ifelse(
      zonelayertree_df$AF_AnyTrees_is < 0.5,
      0,
      ifelse(
        zonelayertree_df$RT_ATType == 3,
        zonelayertree_df$Rt3_LRV,
        ifelse(
          zonelayertree_df$RT_ATType == 2,
          zonelayertree_df$RT_TLrvEllipAct,
          ifelse(
            zonelayertree_df$RT_ATType == 1,
            zonelayertree_df$RT_TLrvEllipAct,
            ifelse(
              zonelayertree_df$W_WaterLog_is == 1,
              zonelayertree_df$RT_TPresence * zonelayertree_df$RT_TLrvEff,
              zonelayertree_df$RT_TPresence * zonelayertree_df$RT_TLrvL
            )
          )
        )
      )
    )
    
    # RT_TLrvM1[Zone,Tree] = if RT_TDiam[Tree]>0 then RT_TLrvMinM1[Zone,Tree]*(1+RT_MTInfFrac1*T_MycMaxInf[Tree]*RT_MTHypL[Tree]*SQRT(RT_MTHypDiam[Tree])/SQRT(RT_TDiam[Tree])) ELSE 0
    # RT_TLrvM2[Zone,Tree] = if RT_TDiam[Tree]>0 then RT_TLrvMinM2[Zone,Tree]*(1+RT_MTInfFrac2*T_MycMaxInf[Tree]*RT_MTHypL[Tree]*SQRT(RT_MTHypDiam[Tree])/SQRT(RT_TDiam[Tree])) ELSE 0
    # RT_TLrvM3[Zone,Tree] = if RT_TDiam[Tree]>0 then RT_TLrvMinM3[Zone,Tree]*(1+RT_MTInfFrac3*T_MycMaxInf[Tree]*RT_MTHypL[Tree]*SQRT(RT_MTHypDiam[Tree])/SQRT(RT_TDiam[Tree])) ELSE 0
    # RT_TLrvM4[Zone,Tree] = if RT_TDiam[Tree]>0 then RT_TLrvMinM4[Zone,Tree]*(1+RT_MTInfFrac4*T_MycMaxInf[Tree]*RT_MTHypL[Tree]*SQRT(RT_MTHypDiam[Tree])/SQRT(RT_TDiam[Tree])) ELSE 0
    
    zonelayertree_df$RT_TDiam <- rep(tree_df$RT_TDiam, each = nrow(zone_df) * nrow(layer_df))
    zonelayertree_df$T_MycMaxInf <- rep(tree_df$T_MycMaxInf, each = nrow(zone_df) * nrow(layer_df))
    zonelayertree_df$RT_MTHypL <- rep(tree_df$RT_MTHypL, each = nrow(zone_df) * nrow(layer_df))
    zonelayertree_df$RT_MTHypDiam <- rep(tree_df$RT_MTHypDiam, each = nrow(zone_df) * nrow(layer_df))
    zonelayertree_df$RT_MTInfFrac <- rep(rep(layer_df$RT_MTInfFrac, each = nrow(zone_df)), nrow(tree_df))
    
    zonelayertree_df$RT_TLrvM <- ifelse(
      zonelayertree_df$RT_TDiam > 0,
      zonelayertree_df$RT_TLrvMinM * (
        1 + zonelayertree_df$RT_MTInfFrac * zonelayertree_df$T_MycMaxInf * zonelayertree_df$RT_MTHypL *
          sqrt(zonelayertree_df$RT_MTHypDiam) /
          sqrt(zonelayertree_df$RT_TDiam)
      ),
      0
    )
    
    
    # CQ_C_HostEffForT1[Zone] = if CQ_CType[Zone]=1 then C_HostEffForT1[Type1] else
    #   if CQ_CType[Zone]=2 then C_HostEffForT1[Type2] else
    # if CQ_CType[Zone]=3 then C_HostEffForT1[Type3] else
    # if CQ_CType[Zone]=4 then C_HostEffForT1[Type4] else
    #   if CQ_CType[Zone]=5 then C_HostEffForT1[Type5] else 0
    
    # TODO: to be revised
    zone_df$CQ_C_HostEffForT1 <- crop_df$C_HostEffForT1[zone_df$CQ_CType]
    
    
    
    # zonelayer_df$Lrvm <- 0
    # zonelayer_df[zonelayer_df$layer == 1, "Lrvm"] <- unlist(lapply(zone_df$crop_type, function(x) {
    #   get_var(plant_data$crop_pars_df, "RT_CLrvm1", x)
    # }))
    # zonelayer_df[zonelayer_df$layer == 2, "Lrvm"] <- unlist(lapply(zone_df$crop_type, function(x) {
    #   get_var(plant_data$crop_pars_df, "RT_CLrvm2", x)
    # }))
    # zonelayer_df[zonelayer_df$layer == 3, "Lrvm"] <- unlist(lapply(zone_df$crop_type, function(x) {
    #   get_var(plant_data$crop_pars_df, "RT_CLrvm3", x)
    # }))
    # zonelayer_df[zonelayer_df$layer == 4, "Lrvm"] <- unlist(lapply(zone_df$crop_type, function(x) {
    #   get_var(plant_data$crop_pars_df, "RT_CLrvm4", x)
    # }))
    
    
    # RT_CLrvM1Curr[Zone] = CQ_ParametersCurr[Zone,Lrvm1]*RT_CMultiplier
    # RT_CLrvM2Curr[Zone] = CQ_ParametersCurr[Zone,Lrvm2]*RT_CMultiplier
    # RT_CLrvM3Curr[Zone] = CQ_ParametersCurr[Zone,Lrvm3]*RT_CMultiplier
    # RT_CLrvM4Curr[Zone] = CQ_ParametersCurr[Zone,Lrvm4]*RT_CMultiplier
    zonelayer_df$RT_CLrvMCurr <- zonelayer_df$Lrvm * RT_CMultiplier
    
    # RT_CLrvt[Zone] = GRAPH(CQ_Stage[Zone])
    zone_df$RT_CLrvt <- get_y_df(zone_df$CQ_Stage, "RT_CLrvt")
    zonelayer_df$RT_CLrvt <- rep(zone_df$RT_CLrvt, nlayer)
    
    zone_df$RT_ACType <- RT_ACType
    
    # RT_CLraC[Zone] = CQ_ParametersCurr[Zone,LraConst]
    # zone_df$RT_CLraC <- unlist(lapply(zone_df$crop_type, function(x) {
    #   get_var(plant_data$crop_pars_df, "RT_CLraConst", x)
    # }))
    
    
    
    C_Root_DW_zone_df <- aggregate(list(C_Root_sum = zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "DW", "C_Root"]), by = zonelayer_df[c("zone")], sum)
    zone_df$C_Root_DW_zone <- C_Root_DW_zone_df$C_Root_sum
    
    # RT_CLraDyn[Zone] = 1000*ARRAYSUM(C_Root_DW[Zone,*])*RT_CSRLCurr[Zone]
    zone_df$RT_CLraDyn <- 1000 * zone_df$C_Root_DW_zone * zone_df$RT_CSRLCurr
    
    # RT_CLraCurr[Zone] = IF(RT_ACType=1)THEN(RT_CLraC[Zone])ELSE(IF(RT_ACType>1)THEN(RT_CLraDyn[Zone])ELSE(0))
    zone_df$RT_CLraCurr <- ifelse(
      zone_df$RT_ACType == 1,
      zone_df$RT_CLraC,
      ifelse(zone_df$RT_ACType > 1, zone_df$RT_CLraDyn, 0)
    )
    
    
    zonelayer_df$RT_CDecDepthAct <- rep(zone_df$RT_CDecDepthAct, nlayer)
    zonelayer_df$RT_CLraCurr <- rep(zone_df$RT_CLraCurr, nlayer)
    # zonelayer_df$RT_Depth <- rep(layer_df$RT_Depth, each = nzone)
    # zonelayer_df$RT_Depth_down <- rep(c(0, head(layer_df$RT_Depth, -1)), each = nzone)
    zonelayer_df$RT_Depth_up <- 0
    zonelayer_df[zonelayer_df$layer %in% 2:4, "RT_Depth_up"] <- zonelayer_df[zonelayer_df$layer %in% 1:3, "RT_Depth"]
    
    
    # RT_CLrvExp1[Zone] = RT_CLraCurr[Zone]*RT_CDecDepthAct[Zone]/((RT_CLrvPlatDep+1)*EXP(-RT_CDecDepthAct[Zone]*RT_CLrvPlatDep))*EXP(-RT_CDecDepthAct[Zone]*MAX(RT_CLrvPlatDep,(RT_Depth1[Zone]/2)))/100
    # RT_CLrvExp2[Zone] = RT_CLraCurr[Zone]*RT_CDecDepthAct[Zone]/((RT_CLrvPlatDep+1)*EXP(-RT_CDecDepthAct[Zone]*RT_CLrvPlatDep))*EXP(-RT_CDecDepthAct[Zone]*MAX(RT_CLrvPlatDep,(RT_Depth1[Zone]+RT_Depth2[Zone]/2)))/100
    # RT_CLrvExp3[Zone] = RT_CLraCurr[Zone]*RT_CDecDepthAct[Zone]/((RT_CLrvPlatDep+1)*EXP(-RT_CDecDepthAct[Zone]*RT_CLrvPlatDep))*EXP(-RT_CDecDepthAct[Zone]*MAX(RT_CLrvPlatDep,(RT_Depth2[Zone]+RT_Depth3[Zone]/2)))/100
    # RT_CLrvExp4[Zone] = RT_CLraCurr[Zone]*RT_CDecDepthAct[Zone]/((RT_CLrvPlatDep+1)*EXP(-RT_CDecDepthAct[Zone]*RT_CLrvPlatDep))*EXP(-RT_CDecDepthAct[Zone]*MAX(RT_CLrvPlatDep,(RT_Depth3[Zone]+RT_Depth4[Zone]/2)))/100
    
    zonelayer_df$RT_CLrvExp <- zonelayer_df$RT_CLraCurr * zonelayer_df$RT_CDecDepthAct /
      ((RT_CLrvPlatDep + 1) * exp(-zonelayer_df$RT_CDecDepthAct * RT_CLrvPlatDep)) *
      exp(-zonelayer_df$RT_CDecDepthAct * pmax(RT_CLrvPlatDep, ((zonelayer_df$RT_Depth +
                                                                   zonelayer_df$RT_Depth_up) / 2
      ))) / 100
    
    
    
    # RT_CLrvMinM1[Zone] = IF(RT_ACType=0)THEN(RT_CLrvM1Curr[Zone]*RT_CLrvt[Zone])ELSE IF(RT_ACType=1) THEN (RT_CLrvExp1[Zone]*RT_CLrvt[Zone])ELSE (RT_CLrvExp1[Zone])
    # RT_CLrvMinM2[Zone] = IF(RT_ACType=0)THEN(RT_CLrvM2Curr[Zone]*RT_CLrvt[Zone])ELSE IF(RT_ACType=1) THEN (RT_CLrvExp2[Zone]*RT_CLrvt[Zone])ELSE (RT_CLrvExp2[Zone])
    # RT_CLrvMinM3[Zone] = IF(RT_ACType=0)THEN(RT_CLrvM3Curr[Zone]*RT_CLrvt[Zone])ELSE IF(RT_ACType=1) THEN (RT_CLrvExp3[Zone]*RT_CLrvt[Zone])ELSE (RT_CLrvExp3[Zone])
    # RT_CLrvMinM4[Zone] = IF(RT_ACType=0)THEN(RT_CLrvM4Curr[Zone]*RT_CLrvt[Zone])ELSE IF(RT_ACType=1) THEN (RT_CLrvExp4[Zone]*RT_CLrvt[Zone])ELSE (RT_CLrvExp4[Zone])
    zonelayer_df$RT_ACType <- RT_ACType
    
    zonelayer_df$RT_CLrvMinM <- ifelse(
      zonelayer_df$RT_ACType == 0,
      zonelayer_df$RT_CLrvMCurr * zonelayer_df$RT_CLrvt,
      ifelse(
        zonelayer_df$RT_ACType == 1 ,
        zonelayer_df$RT_CLrvExp * zonelayer_df$RT_CLrvt,
        zonelayer_df$RT_CLrvExp
      )
    )
    
    
    zonelayer_df$CQ_MaxMycInf <- rep(zone_df$CQ_MaxMycInf, nlayer)
    zonelayer_df$CQ_RtDiam <- rep(zone_df$CQ_RtDiam, nlayer)
    zonelayer_df$RT_MCInfFrac <- rep(layer_df$RT_MCInfFrac, each = nzone)
    
    
    # RT_CLrvM1[Zone] = RT_CLrvMinM1[Zone]*(1+CQ_MaxMycInf[Zone]*RT_MCInfFrac1*RT_MCHypL*SQRT(RT_MCHypDiam)/SQRT(CQ_RtDiam[Zone]))
    # RT_CLrvM2[Zone] = RT_CLrvMinM2[Zone]*(1+CQ_MaxMycInf[Zone]*RT_MCInfFrac2*RT_MCHypL*SQRT(RT_MCHypDiam)/SQRT(CQ_RtDiam[Zone]))
    # RT_CLrvM3[Zone] = RT_CLrvMinM3[Zone]*(1+CQ_MaxMycInf[Zone]*RT_MCInfFrac3*RT_MCHypL*SQRT(RT_MCHypDiam)/SQRT(CQ_RtDiam[Zone]))
    # RT_CLrvM4[Zone] = RT_CLrvMinM4[Zone]*(1+CQ_MaxMycInf[Zone]*RT_MCInfFrac4*RT_MCHypL*SQRT(RT_MCHypDiam)/SQRT(CQ_RtDiam[Zone]))
    zonelayer_df$RT_CLrvM <- zonelayer_df$RT_CLrvMinM * (
      1 + zonelayer_df$CQ_MaxMycInf * zonelayer_df$RT_MCInfFrac *
        RT_MCHypL *
        sqrt(RT_MCHypDiam) / sqrt(zonelayer_df$CQ_RtDiam)
    )
    
    zone_df$RT_TLrvM1 <- zonelayertree_df[zonelayertree_df$layer == 1 &
                                            zonelayertree_df$tree_id == 1, "RT_TLrvM"]
    zone_df$RT_TLrvM2 <- zonelayertree_df[zonelayertree_df$layer == 2 &
                                            zonelayertree_df$tree_id == 1, "RT_TLrvM"]
    zone_df$RT_CLrvM1 <- zonelayer_df[zonelayer_df$layer == 1, "RT_CLrvM"]
    zone_df$RT_CLrvM2 <- zonelayer_df[zonelayer_df$layer == 2, "RT_CLrvM"]
    
    # RT_CParasitFrac[Zone] = min(1,CQ_C_HostEffForT1[Zone]*(RT_TLrvM1[Zone,Sp1]*RT_CLrvM1[Zone]+RT_TLrvM2[Zone,Sp1]*RT_CLrvM2[Zone]))
    zone_df$RT_CParasitFrac <- pmin(
      1,
      zone_df$CQ_C_HostEffForT1 * (
        zone_df$RT_TLrvM1 * zone_df$RT_CLrvM1 + zone_df$RT_TLrvM2 * zone_df$RT_CLrvM2
      )
    )
    
    
    
    zonetree_df$RT_T_HostEffForT1 <- rep(tree_df$RT_T_HostEffForT1, each = nzone)
    
    zonetree_df$RT_TLrvM1 <- zonelayertree_df[zonelayertree_df$layer == 1, "RT_TLrvM"]
    zonetree_df$RT_TLrvM2 <- zonelayertree_df[zonelayertree_df$layer == 2, "RT_TLrvM"]
    
    # RT_TParasitFrac[Zone,Tree] = min(1,RT_T_HostEffForT1[Tree]*(RT_TLrvM1[Zone,Tree]*RT_TLrvM1[Zone,Tree]+RT_TLrvM2[Zone,Tree]*RT_TLrvM2[Zone,Tree]))
    zonetree_df$RT_TParasitFrac <- pmin(
      1,
      zonetree_df$RT_T_HostEffForT1 *
        (zonetree_df$RT_TLrvM1^2 +
           zonetree_df$RT_TLrvM2^2)
    )
    
    
    # RT_TLrv1[Zn1,Sp1] = RT_TLrvM1[Zn1,Sp1]+RT_CParasitFrac[Zn1]*RT_CLrvM1[Zn1]+RT_TParasitFrac[Zn1,Sp2]*RT_TLrvM1[Zn1,Sp2]+RT_TParasitFrac[Zn1,Sp3]*RT_TLrvM1[Zn1,Sp3]
    # RT_TLrv1[Zn1,Sp2] = RT_TLrvM1[Zn1,Sp2]*(1-RT_TParasitFrac[Zn1,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM1[Zn1])
    # RT_TLrv1[Zn1,Sp3] = RT_TLrvM1[Zn1,Sp3]*(1-RT_TParasitFrac[Zn1,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM1[Zn1])
    # RT_TLrv1[Zn2,Sp1] = RT_TLrvM1[Zn2,Sp1]+RT_TParasitFrac[Zn2,Sp2]*RT_TLrvM1[Zn2,Sp2]+RT_TParasitFrac[Zn2,Sp3]*RT_TLrvM1[Zn2,Sp3]+RT_CParasitFrac[Zn2]*RT_CLrvM1[Zn2]
    # RT_TLrv1[Zn2,Sp2] = RT_TLrvM1[Zn2,Sp2]*(1-RT_TParasitFrac[Zn2,Sp2])+0*(RT_CParasitFrac[Zn2]+RT_CLrvM1[Zn2])
    # RT_TLrv1[Zn2,Sp3] = RT_TLrvM1[Zn2,Sp3]*(1-RT_TParasitFrac[Zn2,Sp3])+0*(RT_CParasitFrac[Zn2]+RT_CLrvM1[Zn2])
    # RT_TLrv1[Zn3,Sp1] = RT_TLrvM1[Zn3,Sp1]+RT_TParasitFrac[Zn3,Sp2]*RT_TLrvM1[Zn3,Sp2]+RT_TParasitFrac[Zn3,Sp3]*RT_TLrvM1[Zn3,Sp3]+RT_CParasitFrac[Zn3]*RT_CLrvM1[Zn3]
    # RT_TLrv1[Zn3,Sp2] = RT_TLrvM1[Zn3,Sp2]*(1-RT_TParasitFrac[Zn3,Sp2])+0*(RT_CParasitFrac[Zn3]+RT_CLrvM1[Zn3])
    # RT_TLrv1[Zn3,Sp3] = RT_TLrvM1[Zn3,Sp3]*(1-RT_TParasitFrac[Zn3,Sp3])+0*(RT_CParasitFrac[Zn3]+RT_CLrvM1[Zn3])
    # RT_TLrv1[Zn4,Sp1] = RT_TLrvM1[Zn4,Sp1]+RT_TParasitFrac[Zn4,Sp2]*RT_TLrvM1[Zn4,Sp2]+ RT_TParasitFrac[Zn4,Sp3]*RT_TLrvM1[Zn4,Sp3]+RT_CParasitFrac[Zn4]*RT_CLrvM1[Zn4]
    # RT_TLrv1[Zn4,Sp2] = RT_TLrvM1[Zn4,Sp2]*(1-RT_TParasitFrac[Zn4,Sp2])+0*(RT_CParasitFrac[Zn4]+RT_CLrvM1[Zn4])
    # RT_TLrv1[Zn4,Sp3] = RT_TLrvM1[Zn4,Sp3]*(1-RT_TParasitFrac[Zn4,Sp3])+0*(RT_CParasitFrac[Zn4]+RT_CLrvM1[Zn4])
    # RT_TLrv2[Zn1,Sp1] = RT_TLrvM2[Zn1,Sp1]+RT_CParasitFrac[Zn1]*RT_CLrvM2[Zn1]+RT_TParasitFrac[Zn1,Sp2]*RT_TLrvM2[Zn1,Sp2]+RT_TParasitFrac[Zn1,Sp3]*RT_TLrvM2[Zn1,Sp3]
    # RT_TLrv2[Zn1,Sp2] = RT_TLrvM2[Zn1,Sp2]*(1-RT_TParasitFrac[Zn1,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn1,Sp3] = RT_TLrvM2[Zn1,Sp3]*(1-RT_TParasitFrac[Zn1,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn2,Sp1] = RT_TLrvM2[Zn2,Sp1]+RT_CParasitFrac[Zn2]*RT_CLrvM2[Zn2]+RT_TParasitFrac[Zn2,Sp2]*RT_TLrvM2[Zn2,Sp2]+RT_TParasitFrac[Zn2,Sp3]*RT_TLrvM2[Zn2,Sp3]
    # RT_TLrv2[Zn2,Sp2] = RT_TLrvM2[Zn2,Sp2]*(1-RT_TParasitFrac[Zn2,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn2,Sp3] = RT_TLrvM2[Zn2,Sp3]*(1-RT_TParasitFrac[Zn2,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn3,Sp1] = RT_TLrvM2[Zn3,Sp1]+RT_CParasitFrac[Zn3]*RT_CLrvM2[Zn3]+RT_TParasitFrac[Zn3,Sp2]*RT_TLrvM2[Zn3,Sp2]+RT_TParasitFrac[Zn3,Sp3]*RT_TLrvM2[Zn3,Sp3]
    # RT_TLrv2[Zn3,Sp2] = RT_TLrvM2[Zn3,Sp2]*(1-RT_TParasitFrac[Zn3,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn3,Sp3] = RT_TLrvM2[Zn3,Sp3]*(1-RT_TParasitFrac[Zn3,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn4,Sp1] = RT_TLrvM2[Zn4,Sp1]+RT_CParasitFrac[Zn4]*RT_CLrvM2[Zn4]+RT_TParasitFrac[Zn4,Sp2]*RT_TLrvM2[Zn4,Sp2]+RT_TParasitFrac[Zn4,Sp3]*RT_TLrvM2[Zn4,Sp3]
    # RT_TLrv2[Zn4,Sp2] = RT_TLrvM2[Zn4,Sp2]*(1-RT_TParasitFrac[Zn4,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv2[Zn4,Sp3] = RT_TLrvM2[Zn4,Sp3]*(1-RT_TParasitFrac[Zn4,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM2[Zn1])
    # RT_TLrv3[Zn1,Sp1] = RT_TLrvM3[Zn1,Sp1]+RT_CParasitFrac[Zn1]*RT_CLrvM3[Zn1]+RT_TParasitFrac[Zn1,Sp2]*RT_TLrvM3[Zn1,Sp2]+RT_TParasitFrac[Zn1,Sp3]*RT_TLrvM3[Zn1,Sp3]
    # RT_TLrv3[Zn1,Sp2] = RT_TLrvM3[Zn1,Sp2]*(1-RT_TParasitFrac[Zn1,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn1,Sp3] = RT_TLrvM3[Zn1,Sp3]*(1-RT_TParasitFrac[Zn1,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn2,Sp1] = RT_TLrvM3[Zn2,Sp1]+RT_CParasitFrac[Zn2]*RT_CLrvM3[Zn2]+RT_TParasitFrac[Zn2,Sp2]*RT_TLrvM3[Zn2,Sp2]+RT_TParasitFrac[Zn2,Sp3]*RT_TLrvM3[Zn2,Sp3]
    # RT_TLrv3[Zn2,Sp2] = RT_TLrvM3[Zn2,Sp2]*(1-RT_TParasitFrac[Zn2,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn2,Sp3] = RT_TLrvM3[Zn2,Sp3]*(1-RT_TParasitFrac[Zn2,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn3,Sp1] = RT_TLrvM3[Zn3,Sp1]+RT_CParasitFrac[Zn3]*RT_CLrvM3[Zn3]+RT_TParasitFrac[Zn3,Sp2]*RT_TLrvM3[Zn3,Sp2]+RT_TParasitFrac[Zn3,Sp3]*RT_TLrvM3[Zn3,Sp3]
    # RT_TLrv3[Zn3,Sp2] = RT_TLrvM3[Zn3,Sp2]*(1-RT_TParasitFrac[Zn3,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn3,Sp3] = RT_TLrvM3[Zn3,Sp3]*(1-RT_TParasitFrac[Zn3,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn4,Sp1] = RT_TLrvM3[Zn4,Sp1]+RT_CParasitFrac[Zn4]*RT_CLrvM3[Zn4]+RT_TParasitFrac[Zn4,Sp2]*RT_TLrvM3[Zn4,Sp2]+RT_TParasitFrac[Zn4,Sp3]*RT_TLrvM3[Zn4,Sp3]
    # RT_TLrv3[Zn4,Sp2] = RT_TLrvM3[Zn4,Sp2]*(1-RT_TParasitFrac[Zn4,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv3[Zn4,Sp3] = RT_TLrvM3[Zn4,Sp3]*(1-RT_TParasitFrac[Zn4,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM3[Zn1])
    # RT_TLrv4[Zn1,Sp1] = RT_TLrvM4[Zn1,Sp1]+RT_CParasitFrac[Zn1]*RT_CLrvM4[Zn1]+RT_TParasitFrac[Zn1,Sp2]*RT_TLrvM4[Zn1,Sp2]+RT_TParasitFrac[Zn1,Sp3]*RT_TLrvM4[Zn1,Sp3]
    # RT_TLrv4[Zn1,Sp2] = RT_TLrvM4[Zn1,Sp2]*(1-RT_TParasitFrac[Zn1,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn1,Sp3] = RT_TLrvM4[Zn1,Sp3]*(1-RT_TParasitFrac[Zn1,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn2,Sp1] = RT_TLrvM4[Zn2,Sp1]+RT_CParasitFrac[Zn2]*RT_CLrvM4[Zn2]+RT_TParasitFrac[Zn2,Sp2]*RT_TLrvM4[Zn2,Sp2]+RT_TParasitFrac[Zn2,Sp3]*RT_TLrvM4[Zn2,Sp3]
    # RT_TLrv4[Zn2,Sp2] = RT_TLrvM4[Zn2,Sp2]*(1-RT_TParasitFrac[Zn2,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn2,Sp3] = RT_TLrvM4[Zn2,Sp3]*(1-RT_TParasitFrac[Zn2,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn3,Sp1] = RT_TLrvM4[Zn3,Sp1]+RT_CParasitFrac[Zn3]*RT_CLrvM4[Zn3]+RT_TParasitFrac[Zn3,Sp2]*RT_TLrvM4[Zn3,Sp2]+RT_TParasitFrac[Zn3,Sp3]*RT_TLrvM4[Zn3,Sp3]
    # RT_TLrv4[Zn3,Sp2] = RT_TLrvM4[Zn3,Sp2]*(1-RT_TParasitFrac[Zn3,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn3,Sp3] = RT_TLrvM4[Zn3,Sp3]*(1-RT_TParasitFrac[Zn3,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn4,Sp1] = RT_TLrvM4[Zn4,Sp1]+RT_CParasitFrac[Zn4]*RT_CLrvM4[Zn4]+RT_TParasitFrac[Zn4,Sp2]*RT_TLrvM4[Zn4,Sp2]+RT_TParasitFrac[Zn4,Sp3]*RT_TLrvM4[Zn4,Sp3]
    # RT_TLrv4[Zn4,Sp2] = RT_TLrvM4[Zn4,Sp2]*(1-RT_TParasitFrac[Zn4,Sp2])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    # RT_TLrv4[Zn4,Sp3] = RT_TLrvM4[Zn4,Sp3]*(1-RT_TParasitFrac[Zn4,Sp3])+0*(RT_CParasitFrac[Zn1]+RT_CLrvM4[Zn1])
    
    zonelayertree_df$RT_CParasitFrac <- rep(zone_df$RT_CParasitFrac, nrow(zone_df) * nrow(tree_df))
    
    RT_df <- zonetree_df[c("zone", "tree_id", "RT_TParasitFrac")]
    rt2_df <- RT_df[rep(row.names(RT_df), times = rep(nlayer, nrow(RT_df))), ]
    rt2_df$layer <- rep(c(1:nlayer), nrow(RT_df))
    rt2_df <- rt2_df[order(rt2_df$tree_id, rt2_df$layer, rt2_df$zone), ]
    zonelayertree_df$RT_TParasitFrac <- rt2_df$RT_TParasitFrac
    
    zonelayertree_df$RT_TLrv <- zonelayertree_df$RT_TLrvM * (1 - zonelayertree_df$RT_TParasitFrac)
    sp1_df <- zonelayertree_df[zonelayertree_df$tree_id == 1, c("RT_TLrvM", "RT_CParasitFrac")]
    sp2_df <- zonelayertree_df[zonelayertree_df$tree_id == 2, c("RT_TLrvM", "RT_TParasitFrac")]
    sp3_df <- zonelayertree_df[zonelayertree_df$tree_id == 3, c("RT_TLrvM", "RT_TParasitFrac")]
    zonelayertree_df[zonelayertree_df$tree_id == 1, "RT_TLrv"] <- sp1_df$RT_TLrvM * sp1_df$RT_CParasitFrac + sp2_df$RT_TLrvM * sp2_df$RT_TParasitFrac + sp3_df$RT_TLrvM * sp3_df$RT_TParasitFrac
    
    
    
    # TW_Condutc1[Zone,Tree] = AF_ZoneFrac[Zone]*AF_DepthAct1[Zone]*RT_TLrv1[Zone,Tree]
    # TW_Condutc2[Zone,Tree] = AF_ZoneFrac[Zone]*AF_Depth2[Zone]*RT_TLrv2[Zone,Tree]
    # TW_Condutc3[Zone,Tree] = AF_ZoneFrac[Zone]*AF_Depth3[Zone]*RT_TLrv3[Zone,Tree]
    # TW_Condutc4[Zone,Tree] = AF_ZoneFrac[Zone]*AF_Depth4[Zone]*RT_TLrv4[Zone,Tree]
    zonelayertree_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nrow(zone_df) * nrow(tree_df))
    zonelayertree_df$AF_Depth <- rep(zonelayer_df$AF_Depth, nrow(tree_df))
    zonelayertree_df$TW_Condutc <- zonelayertree_df$AF_ZoneFrac * zonelayertree_df$AF_Depth *
      zonelayertree_df$RT_TLrv
    
    # TW_ConductanceSum[Tree] = ARRAYSUM(TW_Condutc1[*,Tree])+ARRAYSUM(TW_Condutc2[*,Tree])+ARRAYSUM(TW_Condutc3[*,Tree])+ARRAYSUM(TW_Condutc4[*,Tree])
    tree_df$TW_ConductanceSum <- aggregate(zonelayertree_df["TW_Condutc"], by = zonelayertree_df["tree_id"], sum)$TW_Condutc
    
    
    # W_PTheta1[Zone] = GRAPH(W_Theta1[Zone])
    # W_PTheta2[Zone] = GRAPH(W_Theta2[Zone])
    # W_PTheta3[Zone] = GRAPH(W_Theta3[Zone])
    # W_PTheta4[Zone] = GRAPH(W_Theta4[Zone])
    layer_df$W_Theta <- zonelayer_df[zonelayer_df$zone == 1, "W_Theta"]
    layer_df$W_PTheta <- apply(layer_df[c("layer", "W_Theta")], 1, function(x){
      get_graph_y(
        W_PTheta_df,
        x[["W_Theta"]],
        x_column = "Theta",
        y_column = names(W_PTheta_df)[x[["layer"]]],
        mode = "continues"
      )
    })
    zonelayer_df$W_PTheta <- rep(layer_df$W_PTheta, each = nzone)
    
    # zonelayer_df$W_PTheta <- NA
    # for (i in 1:nrow(zonelayer_df)) {
    #   zonelayer_df[i, "W_PTheta"] <- get_graph_y(
    #     W_PTheta_df,
    #     zonelayer_df[i, ]$W_Theta,
    #     x_column = "Theta",
    #     y_column = names(W_PTheta_df)[zonelayer_df[i, ]$layer],
    #     mode = "continues"
    #   )
    # }
    
    # TW_PStem1[Tree] = W_PTheta1[Zn1]*TW_Condutc1[Zn1,Tree]+ W_PTheta1[Zn2]*TW_Condutc1[Zn2,Tree]+ W_PTheta1[Zn3]*TW_Condutc1[Zn3,Tree]+ W_PTheta1[Zn4]*TW_Condutc1[Zn4,Tree]
    # TW_PStem2[Tree] = W_PTheta2[Zn1]*TW_Condutc2[Zn1,Tree]+ W_PTheta2[Zn2]*TW_Condutc2[Zn2,Tree]+ W_PTheta2[Zn3]*TW_Condutc2[Zn3,Tree]+ W_PTheta2[Zn4]*TW_Condutc2[Zn4,Tree]
    # TW_PStem3[Tree] = W_PTheta3[Zn1]*TW_Condutc3[Zn1,Tree]+ W_PTheta3[Zn2]*TW_Condutc3[Zn2,Tree]+ W_PTheta3[Zn3]*TW_Condutc3[Zn3,Tree]+ W_PTheta3[Zn4]*TW_Condutc3[Zn4,Tree]
    # TW_PStem4[Tree] = W_PTheta4[Zn1]*TW_Condutc4[Zn1,Tree]+ W_PTheta4[Zn2]*TW_Condutc4[Zn2,Tree]+ W_PTheta4[Zn3]*TW_Condutc4[Zn3,Tree]+ W_PTheta4[Zn4]*TW_Condutc4[Zn4,Tree]
    zonelayertree_df$W_PTheta <- rep(zonelayer_df$W_PTheta, ntree)
    zonelayertree_df$TW_PStem <- zonelayertree_df$W_PTheta * zonelayertree_df$TW_Condutc
    
    # TW_PStemSum[Tree] = TW_PStem1[Tree]+TW_PStem2[Tree]+TW_PStem3[Tree]+TW_PStem4[Tree]
    tree_df$TW_PStemSum <- aggregate(zonelayertree_df["TW_PStem"], by = zonelayertree_df["tree_id"], sum)$TW_PStem
    
    # TW_PStem[Tree] = if TW_ConductanceSum[Tree] > 0 then TW_PStemSum[Tree]/TW_ConductanceSum[Tree] else 0
    tree_df$TW_PStem <- ifelse(
      tree_df$TW_ConductanceSum > 0,
      tree_df$TW_PStemSum / tree_df$TW_ConductanceSum,
      0
    )
    
    
    zonelayertree_df$W_ThetaSat <- rep(rep(layer_df$W_ThetaSat, each = nrow(zone_df)), nrow(tree_df))
    zonelayertree_df$W_Alpha <- rep(rep(layer_df$W_Alpha, each = nrow(zone_df)), nrow(tree_df))
    zonelayertree_df$W_n <- rep(rep(layer_df$W_n, each = nrow(zone_df)), nrow(tree_df))
    zonelayertree_df$TW_PStem <- rep(tree_df$TW_PStem, each = nrow(zone_df) * nrow(layer_df))
    
    # TW_EqTheta1[Zone,Tree] = W_ThetaSat1/(1+(ABS(W_Alpha1*TW_PStem[Tree]))^W_n1)^(1-1/W_n1)
    # TW_EqTheta2[Zone,Tree] = W_ThetaSat2/(1+(ABS(W_Alpha2*TW_PStem[Tree]))^W_n2)^(1-1/W_n2)
    # TW_EqTheta3[Zone,Tree] = W_ThetaSat3/(1+(ABS(W_Alpha3*TW_PStem[Tree]))^W_n3)^(1-1/W_n3)
    # TW_EqTheta4[Zone,Tree] = W_ThetaSat4/(1+(ABS(W_Alpha4*TW_PStem[Tree]))^W_n4)^(1-1/W_n4)
    zonelayertree_df$TW_EqTheta <- zonelayertree_df$W_ThetaSat / (1 + (
      abs(zonelayertree_df$W_Alpha * zonelayertree_df$TW_PStem)
    )^zonelayertree_df$W_n)^(1 - 1 / zonelayertree_df$W_n)
    
    
    
    # W_TCW_Constant = W_Hyd?*W_HydEqFraction
    W_TCW_Constant <- W_Hyd_is * W_HydEqFraction
    
    
    # TW_PotSuctHalf[Tree] = -((TW_PotSuctAlphMax[Tree]*TW_PotSuctAlphMin[Tree])^0.5)
    tree_df$TW_PotSuctHalf <- -((tree_df$TW_PotSuctAlphMax * tree_df$TW_PotSuctAlphMin)^0.5)
    
    
    
    
    # RAIN_DoY = IF (RAIN_AType=1 AND RAIN_Cycle?= 0) THEN (TIME+CA_DOYStart-365*RAIN_YearStart) ELSE
    # if (MOD(TIME+CA_DOYStart-365*RAIN_YearStart,365)) = 0 then 365 else (MOD(TIME+CA_DOYStart-365*RAIN_YearStart,366))
    RAIN_DoY <- ifelse (
      RAIN_AType == 1 &
        RAIN_Cycle_is == 0,
      time + CA_DOYStart - 365 * RAIN_YearStart,
      ifelse (
        (time + CA_DOYStart - 365 * RAIN_YearStart %% 365) == 0 ,
        365,
        time + CA_DOYStart - 365 * RAIN_YearStart %% 366
      )
    )
    
    
    
    # EVAP_SumAirTemp[Calender] = (EVAP_MonthlyMean_AirTemp[Calender]/5)^1.514
    calendar_df$EVAP_SumAirTemp <- (calendar_df$EVAP_MonthlyMean_AirTemp /
                                      5)^1.514
    
    # E_Heat_Index = ARRAYSUM(EVAP_SumAirTemp[*])
    E_Heat_Index <- sum(calendar_df$EVAP_SumAirTemp)
    
    # E_Alpha = (6.75*10^-7)*E_Heat_Index^3-(7.71*10^-5)*E_Heat_Index^2+(1.792*10^-2)*E_Heat_Index+0.49239
    E_Alpha <- (6.75 * 10^-7) * E_Heat_Index^3 - (7.71 * 10^-5) * E_Heat_Index^2 +
      (1.792 * 10^-2) * E_Heat_Index + 0.49239
    
    # EVAP_Monthly_PotThornthwaite[Calender] = 1.6*(EVAP_MonthlyMean_DayLength[Calender]/12)*(RAIN_Numberof_DaysperMonth[Calender]/30)*(10*EVAP_MonthlyMean_AirTemp[Calender]/E_Heat_Index)^E_Alpha
    calendar_df$EVAP_Monthly_PotThornthwaite <- 1.6 * (calendar_df$EVAP_MonthlyMean_DayLength /
                                                         12) * (calendar_df$RAIN_Numberof_DaysperMonth / 30) * (10 * calendar_df$EVAP_MonthlyMean_AirTemp /
                                                                                                                  E_Heat_Index)^E_Alpha
    
    # EVAP_DailyPot_Thornthwaite = 10*(if RAIN_DoY <= 31 then EVAP_Monthly_PotThornthwaite[january]/RAIN_Numberof_DaysperMonth[january] else
    #   if RAIN_DoY <= 59 then EVAP_Monthly_PotThornthwaite[february]/RAIN_Numberof_DaysperMonth[february] else
    # if RAIN_DoY <= 90 then EVAP_Monthly_PotThornthwaite[march]/RAIN_Numberof_DaysperMonth[march] else
    # if RAIN_DoY <= 120 then EVAP_Monthly_PotThornthwaite[april]/RAIN_Numberof_DaysperMonth[april] else
    #   if RAIN_DoY <= 151 then EVAP_Monthly_PotThornthwaite[may]/RAIN_Numberof_DaysperMonth[may] else
    # if RAIN_DoY <= 181 then EVAP_Monthly_PotThornthwaite[june]/RAIN_Numberof_DaysperMonth[june] else
    # if RAIN_DoY <= 212 then EVAP_Monthly_PotThornthwaite[july]/RAIN_Numberof_DaysperMonth[july] else
    #   if RAIN_DoY <= 243 then EVAP_Monthly_PotThornthwaite[august]/RAIN_Numberof_DaysperMonth[august] else
    # if RAIN_DoY <= 273 then EVAP_Monthly_PotThornthwaite[september]/RAIN_Numberof_DaysperMonth[september] else
    # if RAIN_DoY <= 304 then EVAP_Monthly_PotThornthwaite[october]/RAIN_Numberof_DaysperMonth[october] else
    #   if RAIN_DoY <= 334 then EVAP_Monthly_PotThornthwaite[november]/RAIN_Numberof_DaysperMonth[november] else EVAP_Monthly_PotThornthwaite[december]/RAIN_Numberof_DaysperMonth[december])
    
    i_month <- min(max(which(
      c(0, calendar_df$cumsum_days) < RAIN_DoY, arr.ind = TRUE
    )), 12)
    cdf <- calendar_df[i_month, ]
    EVAP_DailyPot_Thornthwaite <- 10 * cdf$EVAP_Monthly_PotThornthwaite /
      cdf$RAIN_Numberof_DaysperMonth
    
    
    TEMP_DailyPotEvap <- get_graph_y(evap_df, time %% 365, y_column = "TEMP_DailyPotEvap", mode = "continues")
    
    # EVAP_Pot = if TEMP_PotEvapConst? = 1 then TEMP_PotEvapConst else if EVAP_Pot_Thornthwaite? = 2 then EVAP_DailyPot_Thornthwaite else TEMP_DailyPotEvap
    EVAP_Pot <- ifelse(
      TEMP_PotEvapConst_is == 1,
      TEMP_PotEvapConst,
      ifelse(
        EVAP_Pot_Thornthwaite_is == 2,
        EVAP_DailyPot_Thornthwaite,
        TEMP_DailyPotEvap
      )
    )
    
    
    # RAIN_InterceptEvap[Zone] = min(EVAP_Pot,RAIN_CanopyWater[Zone])
    zone_df$RAIN_InterceptEvap <- pmin(EVAP_Pot, zone_df$RAIN_CanopyWater)
    
    # RAIN_InterceptEvapAvg = AF_ZoneFrac[Zn1]*RAIN_InterceptEvap[Zn1]+AF_ZoneFrac[Zn2]*RAIN_InterceptEvap[Zn2]+AF_ZoneFrac[Zn3]*RAIN_InterceptEvap[Zn3]+AF_ZoneFrac[Zn4]*RAIN_InterceptEvap[Zn4]
    RAIN_InterceptEvapAvg <- sum(zone_df$AF_ZoneFrac * zone_df$RAIN_InterceptEvap)
    
    # EVAP_EpotDemandNotMetBy_CanInterc = EVAP_Pot-RAIN_InterceptEvapAvg*EVAP_TranspRedFractrionBy_Can_Intercepted_Water
    EVAP_EpotDemandNotMetBy_CanInterc <- EVAP_Pot - RAIN_InterceptEvapAvg * EVAP_TranspRedFractrionBy_Can_Intercepted_Water
    
    
    
    # T_LAICan[Tree] = IF(T_CanWidthRel[Tree]>0)THEN(MAX(T_LAI[Tree]/T_CanWidthRel[Tree],0))ELSE(0)
    tree_df$T_LAICan <- ifelse(tree_df$T_CanWidthRel > 0,
                               pmax(tree_df$T_LAI / tree_df$T_CanWidthRel, 0),
                               0)
    
    
    zonetree_df$T_klight <- rep(tree_df$T_klight, each = nzone)
    zonetree_df$T_LAICan <- rep(tree_df$T_LAICan, each = nzone)
    
    # T_LAIEff[Zone,Tree] = IF T_klight[Tree]>0 AND (1-T_RelCanWidthZn[Zone,Tree]*(1-exp(-T_klight[Tree]*T_LAICan[Tree])))>0 THEN -LOGN(1-T_RelCanWidthZn[Zone,Tree]*(1-exp(-T_klight[Tree]*T_LAICan[Tree])))/T_klight[Tree] ELSE 0
    zonetree_df$T_LAIEff_a <- 1 - zonetree_df$T_RelCanWidthZn * (1 - exp(-zonetree_df$T_klight * zonetree_df$T_LAICan))
    zonetree_df$T_LAIEff <- ifelse(
      zonetree_df$T_klight > 0 &
        zonetree_df$T_LAIEff_a > 0,
      -log(zonetree_df$T_LAIEff_a) / zonetree_df$T_klight,
      0
    )
    
    
    # T_CanWidth[Tree] = T_CanWidthRel[Tree]*AF_ZoneTot
    tree_df$T_CanWidth <- tree_df$T_CanWidthRel * AF_ZoneTot
    
    # T_CanH[Tree] = if (T_CanShape[Tree])>0 THEN T_CanWidth[Tree]/T_CanShape[Tree] ELSE 0
    tree_df$T_CanH <- ifelse(tree_df$T_CanShape > 0,
                             tree_df$T_CanWidth / tree_df$T_CanShape,
                             0)
    
    # T_CanUp[Tree] = T_WoodH[Tree]+T_CanH[Tree]
    tree_df$T_CanUp <- tree_df$T_WoodH + tree_df$T_CanH
    
    
    
    # C_CanUp[Zone] = C_Height[Zone]
    zone_df$C_CanUp <- zone_df$C_Height
    
    # T_CanUpZn[Zone,Tree] = if T_LAIEff[Zone,Tree] > 0 then T_CanUp[Tree] else 0
    zonetree_df$T_CanUp <- rep(tree_df$T_CanUp, each = nzone)
    zonetree_df$T_CanUpZn <- ifelse(zonetree_df$T_LAIEff > 0, zonetree_df$T_CanUp, 0)
    
    sp1_df <- zonetree_df[zonetree_df$tree_id == 1, ]
    sp2_df <- zonetree_df[zonetree_df$tree_id == 2, ]
    sp3_df <- zonetree_df[zonetree_df$tree_id == 3, ]
    # L_Top[Zone] = MAX(C_CanUp[Zone],T_CanUpZn[Zone,Sp1],T_CanUpZn[Zone,Sp2],T_CanUpZn[Zone,Sp3])
    zone_df$L_Top <- pmax(zone_df$C_CanUp,
                          sp1_df$T_CanUpZn,
                          sp2_df$T_CanUpZn,
                          sp3_df$T_CanUpZn)
    
    # L_Bottom[Zone] = MIN(C_CanUp[Zone],T_CanUpZn[Zone,Sp1],T_CanUpZn[Zone,Sp2],T_CanUpZn[Zone,Sp3])
    zone_df$L_Bottom <- pmin(zone_df$C_CanUp,
                             sp1_df$T_CanUpZn,
                             sp2_df$T_CanUpZn,
                             sp3_df$T_CanUpZn)
    
    # L_Mid1[Zone] = IF (C_CanUp[Zone]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-C_CanUp[Zone])>0.0001 THEN C_CanUp[Zone] ELSE IF (T_CanUpZn[Zone,Sp1]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-T_CanUpZn[Zone,Sp1])>0.0001 THEN T_CanUpZn[Zone,Sp1] ELSE  IF (T_CanUpZn[Zone,Sp2]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-T_CanUpZn[Zone,Sp2])>0.0001 THEN T_CanUpZn[Zone,Sp2] ELSE if (T_CanUpZn[Zone,Sp3]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-T_CanUpZn[Zone,Sp3])>0.0001 THEN T_CanUpZn[Zone,Sp3] else 0
    zone_df$L_Mid1 <- ifelse(
      (zone_df$C_CanUp - zone_df$L_Bottom) > 0.0001 &
        (zone_df$L_Top - zone_df$C_CanUp) > 0.0001,
      zone_df$C_CanUp,
      ifelse(
        (sp1_df$T_CanUpZn - zone_df$L_Bottom) > 0.0001 &
          (zone_df$L_Top - sp1_df$T_CanUpZn) > 0.0001,
        sp1_df$T_CanUpZn,
        ifelse((sp2_df$T_CanUpZn - zone_df$L_Bottom) > 0.0001 &
                 (zone_df$L_Top - sp2_df$T_CanUpZn) > 0.0001,
               sp2_df$T_CanUpZn,
               ifelse((sp3_df$T_CanUpZn - zone_df$L_Bottom) > 0.0001 &
                        (zone_df$L_Top - sp3_df$T_CanUpZn) > 0.0001,
                      sp3_df$T_CanUpZn,
                      0
               )
        )
      )
    )
    
    # L_Mid2[Zone] = IF (C_CanUp[Zone]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-C_CanUp[Zone])>0.0001 AND (L_Mid1[Zone]-C_CanUp[Zone])>0.0001 THEN C_CanUp[Zone] ELSE IF (T_CanUpZn[Zone,Sp1]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-T_CanUpZn[Zone,Sp1])>0.0001 THEN T_CanUpZn[Zone,Sp1] ELSE  IF (T_CanUpZn[Zone,Sp2]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-T_CanUpZn[Zone,Sp2])>0.0001 THEN T_CanUpZn[Zone,Sp2] ELSE if (T_CanUpZn[Zone,Sp3]-L_Bottom[Zone])>0.0001 AND (L_Top[Zone]-T_CanUpZn[Zone,Sp3])>0.0001 THEN T_CanUpZn[Zone,Sp3] else 0
    zone_df$L_Mid2 <- ifelse(
      (zone_df$C_CanUp - zone_df$L_Bottom) > 0.0001 &
        (zone_df$L_Top - zone_df$C_CanUp) > 0.0001 &
        (zone_df$L_Mid1 - zone_df$C_CanUp) > 0.0001,
      zone_df$C_CanUp,
      ifelse(
        (sp1_df$T_CanUpZn - zone_df$L_Bottom) > 0.0001 &
          (zone_df$L_Top - sp1_df$T_CanUpZn) > 0.0001,
        sp1_df$T_CanUpZn,
        ifelse((sp2_df$T_CanUpZn - zone_df$L_Bottom) > 0.0001 &
                 (zone_df$L_Top - sp2_df$T_CanUpZn) > 0.0001,
               sp2_df$T_CanUpZn,
               ifelse((sp3_df$T_CanUpZn -
                         zone_df$L_Bottom) > 0.0001 &
                        (zone_df$L_Top - sp3_df$T_CanUpZn) > 0.0001,
                      sp3_df$T_CanUpZn,
                      0
               )
        )
      )
    )
    
    # L_MidTop[Zone] = MAX(L_Mid1[Zone],L_Mid2[Zone])
    zone_df$L_MidTop <- pmax(zone_df$L_Mid1, zone_df$L_Mid2)
    
    # L_MidBot[Zone] = MIN(L_Mid1[Zone],L_Mid2[Zone])
    zone_df$L_MidBot <- pmin(zone_df$L_Mid1, zone_df$L_Mid2)
    
    
    zonelayer_df$L_Can <- 0
    zonelayer_df[zonelayer_df$layer == 1, "L_Can"] <- zone_df$L_Top
    zonelayer_df[zonelayer_df$layer == 2, "L_Can"] <- zone_df$L_MidTop
    zonelayer_df[zonelayer_df$layer == 3, "L_Can"] <- zone_df$L_MidBot
    zonelayer_df[zonelayer_df$layer == 4, "L_Can"] <- zone_df$L_Bottom
    
    zonelayer_df$L_Can_down <- 0
    zonelayer_df[zonelayer_df$layer == 1, "L_Can_down"] <- zone_df$L_MidTop
    zonelayer_df[zonelayer_df$layer == 2, "L_Can_down"] <- zone_df$L_MidBot
    zonelayer_df[zonelayer_df$layer == 3, "L_Can_down"] <- zone_df$L_Bottom
    zonelayer_df[zonelayer_df$layer == 4, "L_Can_down"] <- 0
    
    zonelayertree_df$L_Can <- rep(zonelayer_df$L_Can, nrow(tree_df))
    zonelayertree_df$L_Can_down <- rep(zonelayer_df$L_Can_down, nrow(tree_df))
    
    
    zonetree_to_zonelayertree <- function(x) {
      df <- zonelayertree_df["zone"]
      df$x <- rep(x, nlayer)
      df$tree_id <- rep(zonetree_df$tree_id, nlayer)
      df$layer <- rep(layer_df$layer, each = nzone * nrow(tree_df))
      df <- df[order(df$tree_id, df$layer, df$zone), ]
      return(df$x)
    }
    
    # df <- zonelayertree_df["zone"]
    # df$T_LAIEff <- rep(zonetree_df$T_LAIEff, nlayer)
    # df$tree_id <- rep(zonetree_df$tree_id, nlayer)
    # df$layer <- rep(layer_df$layer, each = nzone * nrow(tree_df))
    # df <- df[order(df$tree_id, df$layer, df$zone),]
    # zonelayertree_df$T_LAIEff <- df$T_LAIEff
    
    zonelayertree_df$T_LAIEff <- zonetree_to_zonelayertree(zonetree_df$T_LAIEff)
    zonelayertree_df$T_CanUp <- zonetree_to_zonelayertree(zonetree_df$T_CanUp)
    
    # T_CanLow[Tree] = T_WoodH[Tree]
    tree_df$T_CanLow <- tree_df$T_WoodH
    zonelayertree_df$T_CanLow <- rep(tree_df$T_CanLow, each = nrow(zone_df) * nrow(layer_df))
    
    # LIGHT_LAIT1[Zone,Tree] = IF(T_LAIEff[Zone,Tree]>0)THEN(T_LAIEff[Zone,Tree]*MAX(0, (MIN(T_CanUp[Tree],L_Top[Zone]) -MAX(L_MidTop[Zone],T_CanLow[Tree]))/(T_CanUp[Tree]-T_CanLow[Tree])))ELSE(0)
    # LIGHT_LAIT2[Zone,Tree] = IF(T_LAIEff[Zone,Tree]>0)THEN(T_LAIEff[Zone,Tree]*MAX(0, (MIN(T_CanUp[Tree],L_MidTop[Zone]) -MAX(L_MidBot[Zone],T_CanLow[Tree]))/(T_CanUp[Tree]-T_CanLow[Tree])))ELSE(0)
    # LIGHT_LAIT3[Zone,Tree] = IF(T_LAIEff[Zone,Tree]>0)THEN(T_LAIEff[Zone,Tree]*MAX(0, (MIN(T_CanUp[Tree],L_MidBot[Zone]) -MAX(L_Bottom[Zone],T_CanLow[Tree]))/(T_CanUp[Tree]-T_CanLow[Tree])))ELSE(0)
    # LIGHT_LAIT4[Zone,Tree] = IF(T_LAIEff[Zone,Tree]>0)THEN(T_LAIEff[Zone,Tree]*MAX(0, (MIN(T_CanUp[Tree],L_Bottom[Zone]) -T_CanLow[Tree])/(T_CanUp[Tree]-T_CanLow[Tree])))ELSE(0)
    
    zonelayertree_df$LIGHT_LAIT <- ifelse(zonelayertree_df$T_LAIEff > 0,
                                          zonelayertree_df$T_LAIEff * pmax(
                                            0,
                                            (
                                              pmin(zonelayertree_df$T_CanUp, zonelayertree_df$L_Can) -
                                                pmax(zonelayertree_df$L_Can_down, zonelayertree_df$T_CanLow)
                                            ) / (zonelayertree_df$T_CanUp - zonelayertree_df$T_CanLow)
                                          ),
                                          0)
    
    
    # LIGHT_TBAI[Zone,Tree] = 0
    zonetree_df$LIGHT_TBAI <- 0
    
    # LIGHT_TBAI1[Zone,Tree] = 0
    # LIGHT_TBAI2[Zone,Tree] = IF LIGHT_LAIT3[Zone,Tree]>0 THEN 0 ELSE LIGHT_TBAI[Zone,Tree]
    # LIGHT_TBAI3[Zone,Tree] = IF LIGHT_LAIT3[Zone,Tree]>0 THEN LIGHT_TBAI[Zone,Tree] ELSE 0
    # LIGHT_TBAI4[Zone,Tree] = IF LIGHT_LAIT3[Zone,Tree]>0 THEN LIGHT_TBAI[Zone,Tree] ELSE 0
    
    l3_df <- zonelayertree_df[zonelayertree_df$layer == 3, ]
    
    zonelayertree_df$LIGHT_TBAI <- 0
    zonelayertree_df[zonelayertree_df$layer == 2, "LIGHT_TBAI"] <- ifelse(l3_df$LIGHT_LAIT > 0, 0, zonetree_df$LIGHT_TBAI)
    zonelayertree_df[zonelayertree_df$layer == 3, "LIGHT_TBAI"] <- ifelse(l3_df$LIGHT_LAIT > 0, zonetree_df$LIGHT_TBAI, 0)
    zonelayertree_df[zonelayertree_df$layer == 4, "LIGHT_TBAI"] <- ifelse(l3_df$LIGHT_LAIT > 0, zonetree_df$LIGHT_TBAI, 0)
    
    
    zonelayer_df$CQ_kLightCurr <- rep(zone_df$CQ_kLightCurr, nlayer)
    
    
    
    # LIGHT_LAIC[Zn1,L1] = IF(C_LAI[Zn1]>0)THEN(C_LAI[Zn1]*MAX(0, (MIN(C_CanUp[Zn1],L_Top[Zn1]) -MAX(L_MidTop[Zn1],C_CanLow[Zn1]))/(C_CanUp[Zn1]-C_CanLow[Zn1])))ELSE(0)*L_MidBot[Zn1]*L_Bottom[Zn1]
    # LIGHT_LAIC[Zn1,L2] = IF(C_LAI[Zn1]>0)THEN(C_LAI[Zn1]*MAX(0, (MIN(C_CanUp[Zn1],L_MidTop[Zn1]) -MAX(L_MidBot[Zn1],C_CanLow[Zn1]))/(C_CanUp[Zn1]-C_CanLow[Zn1])))ELSE(0)*L_Bottom[Zn1]*L_Top[Zn1]
    # LIGHT_LAIC[Zn1,L3] = IF(C_LAI[Zn1]>0)THEN(C_LAI[Zn1]*MAX(0, (MIN(C_CanUp[Zn1],L_MidBot[Zn1]) -MAX(L_Bottom[Zn1],C_CanLow[Zn1]))/(C_CanUp[Zn1]-C_CanLow[Zn1])))ELSE(0)*L_MidTop[Zn1]*L_Top[Zn1]
    # LIGHT_LAIC[Zn1,L4] = IF(C_LAI[Zn1]>0)THEN(C_LAI[Zn1]*MAX(0, (MIN(C_CanUp[Zn1],L_Bottom[Zn1]) -MAX(0,C_CanLow[Zn1]))/(C_CanUp[Zn1]-C_CanLow[Zn1])))ELSE(0)*L_MidBot[Zn1]*L_Top[Zn1]*L_MidTop[Zn1]
    # LIGHT_LAIC[Zn2,L1] = IF(C_LAI[Zn2]>0)THEN(C_LAI[Zn2]*MAX(0, (MIN(C_CanUp[Zn2],L_Top[Zn2]) -MAX(L_MidTop[Zn2],C_CanLow[Zn2]))/(C_CanUp[Zn2]-C_CanLow[Zn2])))ELSE(0)*L_MidBot[Zn2]*L_Bottom[Zn2]
    # LIGHT_LAIC[Zn2,L2] = IF(C_LAI[Zn2]>0)THEN(C_LAI[Zn2]*MAX(0, (MIN(C_CanUp[Zn2],L_MidTop[Zn2]) -MAX(L_MidBot[Zn2],C_CanLow[Zn2]))/(C_CanUp[Zn2]-C_CanLow[Zn2])))ELSE(0)*L_Bottom[Zn2]*L_Top[Zn2]
    # LIGHT_LAIC[Zn2,L3] = IF(C_LAI[Zn2]>0)THEN(C_LAI[Zn2]*MAX(0, (MIN(C_CanUp[Zn2],L_MidBot[Zn2]) -MAX(L_Bottom[Zn2],C_CanLow[Zn2]))/(C_CanUp[Zn2]-C_CanLow[Zn2])))ELSE(0)*L_Top[Zn2]*L_MidTop[Zn2]
    # LIGHT_LAIC[Zn2,L4] = IF(C_LAI[Zn2]>0)THEN(C_LAI[Zn2]*MAX(0, (MIN(C_CanUp[Zn2],L_Bottom[Zn2]) -MAX(0,C_CanLow[Zn2]))/(C_CanUp[Zn2]-C_CanLow[Zn2])))ELSE(0)*L_MidBot[Zn2]*L_Top[Zn2]*L_MidTop[Zn2]
    # LIGHT_LAIC[Zn3,L1] = IF(C_LAI[Zn3]>0)THEN(C_LAI[Zn3]*MAX(0, (MIN(C_CanUp[Zn3],L_Top[Zn3]) -MAX(L_MidTop[Zn3],C_CanLow[Zn3]))/(C_CanUp[Zn3]-C_CanLow[Zn3])))ELSE(0)*L_MidBot[Zn3]*L_Bottom[Zn3]
    # LIGHT_LAIC[Zn3,L2] = IF(C_LAI[Zn3]>0)THEN(C_LAI[Zn3]*MAX(0, (MIN(C_CanUp[Zn3],L_MidTop[Zn3]) -MAX(L_MidBot[Zn3],C_CanLow[Zn3]))/(C_CanUp[Zn3]-C_CanLow[Zn3])))ELSE(0)*L_Bottom[Zn3]*L_Top[Zn3]
    # LIGHT_LAIC[Zn3,L3] = IF(C_LAI[Zn3]>0)THEN(C_LAI[Zn3]*MAX(0, (MIN(C_CanUp[Zn3],L_MidBot[Zn3]) -MAX(L_Bottom[Zn3],C_CanLow[Zn3]))/(C_CanUp[Zn3]-C_CanLow[Zn3])))ELSE(0)*L_Top[Zn3]*L_MidTop[Zn3]
    # LIGHT_LAIC[Zn3,L4] = IF(C_LAI[Zn3]>0)THEN(C_LAI[Zn3]*MAX(0, (MIN(C_CanUp[Zn3],L_Bottom[Zn3]) -MAX(0,C_CanLow[Zn3]))/(C_CanUp[Zn3]-C_CanLow[Zn3])))ELSE(0)*L_MidBot[Zn3]*L_Top[Zn3]*L_MidTop[Zn3]
    # LIGHT_LAIC[Zn4,L1] = IF(C_LAI[Zn4]>0)THEN(C_LAI[Zn4]*MAX(0, (MIN(C_CanUp[Zn4],L_Top[Zn4]) -MAX(L_MidTop[Zn4],C_CanLow[Zn4]))/(C_CanUp[Zn4]-C_CanLow[Zn4])))ELSE(0)*L_MidBot[Zn4]*L_Bottom[Zn4]
    # LIGHT_LAIC[Zn4,L2] = IF(C_LAI[Zn4]>0)THEN(C_LAI[Zn4]*MAX(0, (MIN(C_CanUp[Zn4],L_MidTop[Zn4]) -MAX(L_MidBot[Zn4],C_CanLow[Zn4]))/(C_CanUp[Zn4]-C_CanLow[Zn4])))ELSE(0)*L_Top[Zn4]*L_Bottom[Zn4]
    # LIGHT_LAIC[Zn4,L3] = IF(C_LAI[Zn4]>0)THEN(C_LAI[Zn4]*MAX(0, (MIN(C_CanUp[Zn4],L_MidBot[Zn4]) -MAX(L_Bottom[Zn4],C_CanLow[Zn4]))/(C_CanUp[Zn4]-C_CanLow[Zn4])))ELSE(0)*L_Top[Zn4]*L_MidTop[Zn4]
    # LIGHT_LAIC[Zn4,L4] = IF(C_LAI[Zn4]>0)THEN(C_LAI[Zn4]*MAX(0, (MIN(C_CanUp[Zn4],L_Bottom[Zn4]) -MAX(0,C_CanLow[Zn4]))/(C_CanUp[Zn4]-C_CanLow[Zn4])))ELSE(0)*L_MidBot[Zn4]*L_Top[Zn4]*L_MidTop[Zn4]
    
    zonelayer_df$C_LAI <- rep(zone_df$C_LAI, nlayer)
    zonelayer_df$C_CanUp <- rep(zone_df$C_CanUp, nlayer)
    zonelayer_df$C_CanLow <- rep(zone_df$C_CanLow, nlayer)
    
    zonelayer_df$L_fac <- 0
    zonelayer_df[zonelayer_df$layer == 1, "L_fac"] <- zone_df$L_MidBot * zone_df$L_Bottom
    zonelayer_df[zonelayer_df$layer == 2, "L_fac"] <- zone_df$L_Bottom * zone_df$L_Top
    zonelayer_df[zonelayer_df$layer == 3, "L_fac"] <- zone_df$L_MidTop * zone_df$L_Top
    zonelayer_df[zonelayer_df$layer == 4, "L_fac"] <- zone_df$L_MidBot * zone_df$L_Top * zone_df$L_MidTop
    
    zonelayer_df$LIGHT_LAIC <- ifelse(zonelayer_df$C_LAI > 0, zonelayer_df$C_LAI * pmax(
      0,
      (
        pmin(zonelayer_df$C_CanUp, zonelayer_df$L_Can) -
          pmax(zonelayer_df$L_Can_down, zonelayer_df$C_CanLow)
      ) / (zonelayer_df$C_CanUp - zonelayer_df$C_CanLow)
    ), 0) * zonelayer_df$L_fac
    
    
    # LIGHT_TCCap1[Zone] = 1-EXP(-T_klight[Sp1]*LIGHT_LAIT1[Zone,Sp1]-T_klight[Sp2]*LIGHT_LAIT1[Zone,Sp2]-T_klight[Sp3]*LIGHT_LAIT1[Zone,Sp3]-LIGHT_kTB[Sp1]*LIGHT_TBAI1[Zone,Sp1]-LIGHT_kTB[Sp2]*LIGHT_TBAI1[Zone,Sp2]-LIGHT_kTB[Sp3]*LIGHT_TBAI1[Zone,Sp3]-CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L1])
    # LIGHT_TCCap2[Zone] = (1-LIGHT_TCCap1[Zone])*(1-EXP(-T_klight[Sp1]*LIGHT_LAIT2[Zone,Sp1]-T_klight[Sp2]*LIGHT_LAIT2[Zone,Sp2]-T_klight[Sp3]*LIGHT_LAIT2[Zone,Sp3]-LIGHT_kTB[Sp1]*LIGHT_TBAI2[Zone,Sp1]-LIGHT_kTB[Sp2]*LIGHT_TBAI2[Zone,Sp2]-LIGHT_kTB[Sp3]*LIGHT_TBAI2[Zone,Sp3]-CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L2]))
    # LIGHT_TCCap3[Zone] = (1-LIGHT_TCCap1[Zone])*(1-LIGHT_TCCap2[Zone])* (1-EXP(-T_klight[Sp1]*LIGHT_LAIT3[Zone,Sp1]-T_klight[Sp2]*LIGHT_LAIT3[Zone,Sp2]-T_klight[Sp3]*LIGHT_LAIT3[Zone,Sp3]-LIGHT_kTB[Sp1]*LIGHT_TBAI3[Zone,Sp1]-LIGHT_kTB[Sp2]*LIGHT_TBAI3[Zone,Sp2]-LIGHT_kTB[Sp3]*LIGHT_TBAI3[Zone,Sp3]-CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L3]))
    # LIGHT_TCCap4[Zone] = (1-LIGHT_TCCap1[Zone])*(1-LIGHT_TCCap2[Zone])*(1-LIGHT_TCCap3[Zone])*(1-EXP(-T_klight[Sp1]*LIGHT_LAIT4[Zone,Sp1]-T_klight[Sp2]*LIGHT_LAIT4[Zone,Sp2]-T_klight[Sp3]*LIGHT_LAIT4[Zone,Sp3]-LIGHT_kTB[Sp1]*LIGHT_TBAI4[Zone,Sp1]-LIGHT_kTB[Sp2]*LIGHT_TBAI4[Zone,Sp2]-LIGHT_kTB[Sp3]*LIGHT_TBAI4[Zone,Sp3]-CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L4]))
    
    zlt_sp1_df <- zonelayertree_df[zonelayertree_df$tree_id == 1, c("LIGHT_LAIT", "LIGHT_TBAI")]
    zlt_sp2_df <- zonelayertree_df[zonelayertree_df$tree_id == 2, c("LIGHT_LAIT", "LIGHT_TBAI")]
    zlt_sp3_df <- zonelayertree_df[zonelayertree_df$tree_id == 3, c("LIGHT_LAIT", "LIGHT_TBAI")]
    t_sp1_df <- tree_df[tree_df$tree_id == 1, c("T_klight", "LIGHT_kTB")]
    t_sp2_df <- tree_df[tree_df$tree_id == 2,  c("T_klight", "LIGHT_kTB")]
    t_sp3_df <- tree_df[tree_df$tree_id == 3,  c("T_klight", "LIGHT_kTB")]
    
    zonelayer_df$LIGHT_TCCap <- 1 - exp(
      -t_sp1_df$T_klight * zlt_sp1_df$LIGHT_LAIT -
        t_sp2_df$T_klight * zlt_sp1_df$LIGHT_LAIT -
        t_sp3_df$T_klight * zlt_sp1_df$LIGHT_LAIT -
        t_sp1_df$LIGHT_kTB * zlt_sp1_df$LIGHT_TBAI -
        t_sp2_df$LIGHT_kTB * zlt_sp2_df$LIGHT_TBAI -
        t_sp3_df$LIGHT_kTB * zlt_sp3_df$LIGHT_TBAI -
        zonelayer_df$CQ_kLightCurr * zonelayer_df$LIGHT_LAIC
    )
    zl1_df_LIGHT_TCCap <-  zonelayer_df[zonelayer_df$layer == 1, "LIGHT_TCCap"]
    zonelayer_df[zonelayer_df$layer == 2, "LIGHT_TCCap"] <- (1 - zl1_df_LIGHT_TCCap) * zonelayer_df[zonelayer_df$layer == 2, "LIGHT_TCCap"]
    zl2_df_LIGHT_TCCap <-  zonelayer_df[zonelayer_df$layer == 2, "LIGHT_TCCap"]
    zonelayer_df[zonelayer_df$layer == 3, "LIGHT_TCCap"] <- (1 - zl1_df_LIGHT_TCCap) * (1 - zl2_df_LIGHT_TCCap) * zonelayer_df[zonelayer_df$layer == 3, "LIGHT_TCCap"]
    zl3_df_LIGHT_TCCap <-  zonelayer_df[zonelayer_df$layer == 3, "LIGHT_TCCap"]
    zonelayer_df[zonelayer_df$layer == 4, "LIGHT_TCCap"] <- (1 - zl1_df_LIGHT_TCCap) * (1 - zl2_df_LIGHT_TCCap) * (1 - zl3_df_LIGHT_TCCap) * zonelayer_df[zonelayer_df$layer == 4, "LIGHT_TCCap"]
    
    
    
    # LIGHT_TCap1[Zone,Tree] = IF(T_klight[Sp1]*LIGHT_LAIT1[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT1[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT1[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L2]+LIGHT_kTB[Sp1]*LIGHT_TBAI1[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI1[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI1[Zone,Sp3])>0 THEN(LIGHT_TCCap1[Zone]*(T_klight[Tree]*LIGHT_LAIT1[Zone,Tree])/(T_klight[Sp1]*LIGHT_LAIT1[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT1[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT1[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L2]+LIGHT_kTB[Sp1]*LIGHT_TBAI1[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI1[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI1[Zone,Sp3]))ELSE(0)
    # LIGHT_TCap2[Zone,Tree] = IF(LIGHT_TCCap2[Zone]>0)THEN(LIGHT_TCCap2[Zone]*(T_klight[Tree]*LIGHT_LAIT2[Zone,Tree])/(T_klight[Sp1]*LIGHT_LAIT2[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT2[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT2[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L2]+LIGHT_kTB[Sp1]*LIGHT_TBAI2[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI2[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI2[Zone,Sp3]))ELSE(0)
    # LIGHT_TCap3[Zone,Tree] = IF(LIGHT_TCCap3[Zone]>0)THEN(LIGHT_TCCap3[Zone]*T_klight[Tree]*LIGHT_LAIT3[Zone,Tree]/(T_klight[Sp1]*LIGHT_LAIT3[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT3[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT3[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L3]+LIGHT_kTB[Sp1]*LIGHT_TBAI3[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI3[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI3[Zone,Sp3]))ELSE(0)
    # LIGHT_TCap4[Zone,Tree] = IF(LIGHT_TCCap4[Zone]>0)THEN(LIGHT_TCCap4[Zone]*T_klight[Tree]*LIGHT_LAIT4[Zone,Tree]/(T_klight[Sp1]*LIGHT_LAIT4[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT4[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT4[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L4]+LIGHT_kTB[Sp1]*LIGHT_TBAI4[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI4[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI4[Zone,Sp3]))ELSE(0)
    
    zonelayertree_df$LIGHT_TCCap <- rep(zonelayer_df$LIGHT_TCCap, nrow(tree_df))
    zonelayertree_df$T_klight <- rep(tree_df$T_klight, each = nzone * nlayer)
    
    zonelayer_df$LIGHT_sp <- t_sp1_df$T_klight * zlt_sp1_df$LIGHT_LAIT +
      t_sp2_df$T_klight * zlt_sp2_df$LIGHT_LAIT +
      t_sp3_df$T_klight * zlt_sp3_df$LIGHT_LAIT +
      zonelayer_df$CQ_kLightCurr * zonelayer_df$LIGHT_LAIC +
      t_sp1_df$LIGHT_kTB * zlt_sp1_df$LIGHT_TBAI +
      t_sp2_df$LIGHT_kTB * zlt_sp2_df$LIGHT_TBAI +
      t_sp3_df$LIGHT_kTB * zlt_sp3_df$LIGHT_TBAI
    zonelayertree_df$LIGHT_sp <- rep(zonelayer_df$LIGHT_sp, nrow(tree_df))
    
    zonelayertree_df$LIGHT_TCap <- ifelse(
      zonelayertree_df$LIGHT_TCCap > 0,
      zonelayertree_df$LIGHT_TCCap * (zonelayertree_df$T_klight * zonelayertree_df$LIGHT_LAIT) / zonelayertree_df$LIGHT_sp,
      0
    )
    
    zl1t_df <- zonelayertree_df[zonelayertree_df$layer == 1, c("LIGHT_TCCap", "T_klight", "LIGHT_LAIT", "LIGHT_sp")]
    zonelayertree_df[zonelayertree_df$layer == 1, "LIGHT_TCap"] <- ifelse(
      zl1t_df$LIGHT_sp > 0,
      zl1t_df$LIGHT_TCCap * (zl1t_df$T_klight * zl1t_df$LIGHT_LAIT) /
        zl1t_df$LIGHT_sp ,
      0
    )
    
    
    # angle_df <- data.frame(LightAngles = LightAngles)
    #
    # # TanAngles[LightAngle] = tan(LightAngles[LightAngle]*PI/180)
    # angle_df$TanAngles <- tan(angle_df$LightAngles * pi / 180)
    
    # LightCapPerAngleZn1[LightAngle] = AF_Zonewidth[Zn1]+
    #   (min(AF_Zonewidth[Zn2],max(0,(L_Top[Zn1]-L_Top[Zn2]))*max(0,TanAngles[LightAngle]))-
    #min(AF_Zonewidth[Zn1],max(0,(L_Top[Zn2]-L_Top[Zn1]))*max(0,TanAngles[LightAngle])))/2
    # LightCapPerAngleZn2[LightAngle] = AF_Zonewidth[Zn2]+
    #   (min(AF_Zonewidth[Zn1],max(0,(L_Top[Zn2]-L_Top[Zn1]))*max(0,TanAngles[LightAngle]))+
    #min(AF_Zonewidth[Zn3],max(0,(L_Top[Zn2]-L_Top[Zn3]))*max(0,TanAngles[LightAngle]))-
    #min(AF_Zonewidth[Zn2],max(0,(L_Top[Zn1]-L_Top[Zn2]))*max(0,TanAngles[LightAngle]))-
    #min(AF_Zonewidth[Zn2],max(0,(L_Top[Zn3]-L_Top[Zn2]))*max(0,TanAngles[LightAngle])))/2
    # LightCapPerAngleZn3[LightAngle] = AF_Zonewidth[Zn3]+
    #   (min(AF_Zonewidth[Zn2],max(0,(L_Top[Zn3]-L_Top[Zn2]))*max(0,TanAngles[LightAngle]))+
    #min(AF_Zonewidth[Zn4],max(0,(L_Top[Zn3]-L_Top[Zn4]))*max(0,TanAngles[LightAngle]))-
    #min(AF_Zonewidth[Zn3],max(0,(L_Top[Zn2]-L_Top[Zn3]))*max(0,TanAngles[LightAngle]))-
    #min(AF_Zonewidth[Zn3],max(0,(L_Top[Zn4]-L_Top[Zn3]))*max(0,TanAngles[LightAngle])))/2
    # LightCapPerAngleZn4[LightAngle] = AF_Zonewidth[Zn4]+
    #   (min(AF_Zonewidth[Zn3],max(0,(L_Top[Zn4]-L_Top[Zn3]))*max(0,TanAngles[LightAngle]))+
    #min(AF_Zonewidth[Zn4],max(0,(L_Top[Zn3]-L_Top[Zn4]))*max(0,TanAngles[LightAngle])))/2
    
    
    z1 <- zone_df[zone_df$zone == 1, c("AF_ZoneWidth", "L_Top")]
    z2 <- zone_df[zone_df$zone == 2, c("AF_ZoneWidth", "L_Top")]
    z3 <- zone_df[zone_df$zone == 3, c("AF_ZoneWidth", "L_Top")]
    z4 <- zone_df[zone_df$zone == 4, c("AF_ZoneWidth", "L_Top")]
    
    angle_df$LightCapPerAngleZn1 <- z1$AF_ZoneWidth +
      (pmin(z2$AF_ZoneWidth, pmax(0, (
        z1$L_Top - z2$L_Top
      )) * pmax(0, angle_df$TanAngles)) -
        pmin(z1$AF_ZoneWidth, pmax(0, (
          z2$L_Top - z1$L_Top
        )) * pmax(0, angle_df$TanAngles))) /
      2
    
    angle_df$LightCapPerAngleZn2 <- z2$AF_ZoneWidth +
      (
        pmin(z1$AF_ZoneWidth, pmax(0, (
          z2$L_Top - z1$L_Top
        )) * pmax(0, angle_df$TanAngles)) +
          pmin(z3$AF_ZoneWidth, pmax(0, (
            z2$L_Top - z3$L_Top
          )) * pmax(0, angle_df$TanAngles)) -
          pmin(z2$AF_ZoneWidth, pmax(0, (
            z1$L_Top - z2$L_Top
          )) * pmax(0, angle_df$TanAngles)) -
          pmin(z2$AF_ZoneWidth, pmax(0, (
            z3$L_Top - z2$L_Top
          )) * pmax(0, angle_df$TanAngles))
      ) / 2
    
    angle_df$LightCapPerAngleZn3 <- z3$AF_ZoneWidth +
      (
        pmin(z2$AF_ZoneWidth, pmax(0, (
          z3$L_Top - z2$L_Top
        )) * pmax(0, angle_df$TanAngles)) +
          pmin(z4$AF_ZoneWidth, pmax(0, (
            z3$L_Top - z4$L_Top
          )) * pmax(0, angle_df$TanAngles)) -
          pmin(z3$AF_ZoneWidth, pmax(0, (
            z2$L_Top - z3$L_Top
          )) * pmax(0, angle_df$TanAngles)) -
          pmin(z3$AF_ZoneWidth, pmax(0, (
            z4$L_Top - z3$L_Top
          )) * pmax(0, angle_df$TanAngles))
      ) / 2
    
    angle_df$LightCapPerAngleZn4 <- z4$AF_ZoneWidth +
      (pmin(z3$AF_ZoneWidth, pmax(0, (
        z4$L_Top - z3$L_Top
      )) * pmax(0, angle_df$TanAngles)) +
        pmin(z4$AF_ZoneWidth, pmax(0, (
          z3$L_Top - z4$L_Top
        )) * pmax(0, angle_df$TanAngles))) /
      2
    
    angle_df$LightSwitch <- LightSwitch
    
    # LightPerAngle[LightAngle] = if(LightSwitch=1) then Ligh1tPerAngleUniform[LightAngle] else
    #   if(LightSwitch=2) then Light2PerAngleSkewed[LightAngle] else
    # if(LightSwitch=3) then Light3PerAngleVertical[LightAngle] else 0
    angle_df$LightPerAngle <- ifelse(
      angle_df$LightSwitch == 1,
      Ligh1tPerAngleUniform,
      ifelse(
        angle_df$LightSwitch == 2,
        Light2PerAngleSkewed,
        ifelse(angle_df$LightSwitch == 3, Light3PerAngleVertical, 0)
      )
    )
    
    # TotLight = ARRAYSUM(LightPerAngle[*])
    angle_df$TotLight <- sum(angle_df$LightPerAngle)
    
    # RelLightEnergyPerAngle[LightAngle] = if TotLight=0 then 0 else LightPerAngle[LightAngle]/TotLight
    angle_df$RelLightEnergyPerAngle <- ifelse(angle_df$TotLight == 0,
                                              0,
                                              angle_df$LightPerAngle / angle_df$TotLight)
    
    # ZoneIdentity[Zn1] = 1
    # ZoneIdentity[Zn2] = 2
    # ZoneIdentity[Zn3] = 3
    # ZoneIdentity[Zn4] = 4
    
    # RelLightCapPerAnglePerZone[LightAngle,Zone] = if ZoneIdentity[Zone] = 1 then LightCapPerAngleZn1[LightAngle] *AF_ZoneTot/(LightCapPerAngleZn1[LightAngle]+LightCapPerAngleZn2[LightAngle]+LightCapPerAngleZn3[LightAngle]+LightCapPerAngleZn4[LightAngle])   else
    #   if ZoneIdentity[Zone] = 2 then LightCapPerAngleZn2[LightAngle] *AF_ZoneTot/(LightCapPerAngleZn1[LightAngle]+LightCapPerAngleZn2[LightAngle]+LightCapPerAngleZn3[LightAngle]+LightCapPerAngleZn4[LightAngle]) else
    # if ZoneIdentity[Zone] = 3 then LightCapPerAngleZn3[LightAngle] *AF_ZoneTot/(LightCapPerAngleZn1[LightAngle]+LightCapPerAngleZn2[LightAngle]+LightCapPerAngleZn3[LightAngle]+LightCapPerAngleZn4[LightAngle]) else
    # if ZoneIdentity[Zone] = 4 then LightCapPerAngleZn4[LightAngle] *AF_ZoneTot/(LightCapPerAngleZn1[LightAngle]+LightCapPerAngleZn2[LightAngle]+LightCapPerAngleZn3[LightAngle]+LightCapPerAngleZn4[LightAngle]) else 0
    
    # LightEnergyPerAnglePerZone[LightAngle,Zone] = RelLightCapPerAnglePerZone[LightAngle,Zone]*RelLightEnergyPerAngle[LightAngle]
    
    angle_df$LightCapPerAngle_sum <- angle_df$LightCapPerAngleZn1 + angle_df$LightCapPerAngleZn2 + angle_df$LightCapPerAngleZn3 + angle_df$LightCapPerAngleZn4
    
    angle_df$LightEnergyPerAnglePerZone1 <- angle_df$RelLightEnergyPerAngle * angle_df$LightCapPerAngleZn1 * AF_ZoneTot /
      angle_df$LightCapPerAngle_sum
    angle_df$LightEnergyPerAnglePerZone2 <- angle_df$RelLightEnergyPerAngle * angle_df$LightCapPerAngleZn2 * AF_ZoneTot /
      angle_df$LightCapPerAngle_sum
    angle_df$LightEnergyPerAnglePerZone3 <- angle_df$RelLightEnergyPerAngle * angle_df$LightCapPerAngleZn3 * AF_ZoneTot /
      angle_df$LightCapPerAngle_sum
    angle_df$LightEnergyPerAnglePerZone4 <- angle_df$RelLightEnergyPerAngle * angle_df$LightCapPerAngleZn4 * AF_ZoneTot /
      angle_df$LightCapPerAngle_sum
    
    # LightCapPerZone[Zone] = ARRAYSUM(LightEnergyPerAnglePerZone[*,Zone])
    zone_df$LightCapPerZone <- 0
    zone_df[zone_df$zone == 1, "LightCapPerZone"] <- sum(angle_df$LightEnergyPerAnglePerZone1)
    zone_df[zone_df$zone == 2, "LightCapPerZone"] <- sum(angle_df$LightEnergyPerAnglePerZone2)
    zone_df[zone_df$zone == 3, "LightCapPerZone"] <- sum(angle_df$LightEnergyPerAnglePerZone3)
    zone_df[zone_df$zone == 4, "LightCapPerZone"] <- sum(angle_df$LightEnergyPerAnglePerZone4)
    
    # RelLightCapPerZone[Zone] = if AF_Zonewidth[Zone]= 0 then 0 else LightCapPerZone[Zone]/AF_Zonewidth[Zone]
    zone_df$RelLightCapPerZone <- ifelse(zone_df$AF_ZoneWidth == 0,
                                         0,
                                         zone_df$LightCapPerZone / zone_df$AF_ZoneWidth)
    zonetree_df$RelLightCapPerZone <- rep(zone_df$RelLightCapPerZone, nrow(tree_df))
    
    zonetree_df$LightSwitch <- LightSwitch
    
    LIGHT_TCap_sum_df <- aggregate(zonelayertree_df["LIGHT_TCap"], by = zonelayertree_df[c("zone", "tree_id")], sum)
    # LIGHT_TCap1234[Zone,Tree] = if LightSwitch = 1 or LightSwitch = 2 then
    # (LIGHT_TCap1[Zone,Tree]+LIGHT_TCap2[Zone,Tree]+LIGHT_TCap3[Zone,Tree]+LIGHT_TCap4[Zone,Tree])*RelLightCapPerZone[Zone]
    # else (LIGHT_TCap1[Zone,Tree]+LIGHT_TCap2[Zone,Tree]+LIGHT_TCap3[Zone,Tree]+LIGHT_TCap4[Zone,Tree])
    zonetree_df$LIGHT_TCap1234 <- ifelse(
      zonetree_df$LightSwitch == 1 | zonetree_df$LightSwitch == 2,
      LIGHT_TCap_sum_df$LIGHT_TCap * zonetree_df$RelLightCapPerZone,
      LIGHT_TCap_sum_df$LIGHT_TCap
    )
    
    
    z1_df <- zonetree_df[zonetree_df$zone == 1, c("LIGHT_TCap1234", "AF_ZoneFrac")]
    z2_df <- zonetree_df[zonetree_df$zone == 2, c("LIGHT_TCap1234", "AF_ZoneFrac")]
    z3_df <- zonetree_df[zonetree_df$zone == 3, c("LIGHT_TCap1234", "AF_ZoneFrac")]
    z4_df <- zonetree_df[zonetree_df$zone == 4, c("LIGHT_TCap1234", "AF_ZoneFrac")]
    
    # EVAP_TreeWatDem[Tree] = EVAP_EpotDemandNotMetBy_CanInterc*(LIGHT_TCap1234[Zn1,Tree]*AF_ZoneFrac[Zn1]+LIGHT_TCap1234[Zn2,Tree]*AF_ZoneFrac[Zn2]+LIGHT_TCap1234[Zn3,Tree]*AF_ZoneFrac[Zn3]+LIGHT_TCap1234[Zn4,Tree]*AF_ZoneFrac[Zn4])
    tree_df$LIGHT_TCap1234_sumf <- z1_df$LIGHT_TCap1234 * z1_df$AF_ZoneFrac + z2_df$LIGHT_TCap1234 * z2_df$AF_ZoneFrac + z3_df$LIGHT_TCap1234 * z3_df$AF_ZoneFrac + z4_df$LIGHT_TCap1234 * z4_df$AF_ZoneFrac
    tree_df$EVAP_TreeWatDem <- EVAP_EpotDemandNotMetBy_CanInterc * tree_df$LIGHT_TCap1234_sumf
    
    # T_Light[Tree] =  MIN(1,(LIGHT_TCap1234[Zn1, Tree]*AF_ZoneFrac[Zn1]+ LIGHT_TCap1234[Zn2, Tree]*AF_ZoneFrac[Zn2]+
    #   LIGHT_TCap1234[Zn3, Tree]*AF_ZoneFrac[Zn3]+
    #   LIGHT_TCap1234[Zn4, Tree]*AF_ZoneFrac[Zn4]))
    tree_df$T_Light <-  pmin(1, tree_df$LIGHT_TCap1234_sumf)
    
    tree_df$TW_EnergyDrivenEpot_is <- TW_EnergyDrivenEpot_is
    
    # TP_WaterDemand[Tree] = TP_ParasiteBiomass[Tree,DW]*TP_SLA_LWR*TP_WaterDemandperLeafArea
    tree_df$TP_WaterDemand <- treepcomp_df[treepcomp_df$PlantComp == "DW", "TP_ParasiteBiomass"] * TP_SLA_LWR * TP_WaterDemandperLeafArea
    
    
    
    
    # T_TranspRatioTime[Tree] = GRAPH(T_Stage[Tree,LeafAge])
    tree_df$T_TranspRatioTime <- get_y_df(treestage_df[treestage_df$Tree_Stage == "LeafAge", "T_Stage"], "T_TranspRatioTime")
    # tree_df$T_TranspRatioTime <- unlist(lapply(treestage_df[treestage_df$Tree_Stage == "LeafAge", "T_Stage"], get_T_TranspRatioTime))
    
    # TW_DemandPot[Tree] = If TW_EnergyDrivenEpot? = 1 then EVAP_TreeWatDem[Tree] + TP_WaterDemand[Tree] else if T_TranspRatioConstant? = 1 then
    # T_Light[Tree]*T_GroMax[Tree]*T_TranspRatio[Tree] + TP_WaterDemand[Tree] else T_Light[Tree]*T_GroMax[Tree]*T_TranspRatio[Tree]/T_TranspRatioTime[Tree] + TP_WaterDemand[Tree]
    tree_df$T_TranspRatioConstant_is <-  T_TranspRatioConstant_is
    
    tree_df$TW_DemandPot <- ifelse(
      tree_df$TW_EnergyDrivenEpot_is == 1,
      tree_df$EVAP_TreeWatDem + tree_df$TP_WaterDemand,
      ifelse(
        tree_df$T_TranspRatioConstant_is == 1,
        tree_df$T_Light * tree_df$T_GroMax * tree_df$T_TranspRatio + tree_df$TP_WaterDemand,
        tree_df$T_Light * tree_df$T_GroMax * tree_df$T_TranspRatio /
          tree_df$T_TranspRatioTime + tree_df$TP_WaterDemand
      )
    )
    
    # TW_PotSuctHalf[Tree] = -((TW_PotSuctAlphMax[Tree]*TW_PotSuctAlphMin[Tree])^0.5)
    tree_df$TW_PotSuctHalf <- -((tree_df$TW_PotSuctAlphMax * tree_df$TW_PotSuctAlphMin)^0.5)
    
    # TW_DrySoilWeightFac[Tree,BufValues] = TW_DryFactRangeInit[BufValues]^TW_DryFactPower[Tree]
    treebuf_df$TW_DryFactPower <- rep(tree_df$TW_DryFactPower, nrow(buf_df))
    treebuf_df$TW_DrySoilWeightFac <- treebuf_df$TW_DryFactRangeInit^treebuf_df$TW_DryFactPower
    
    
    
    
    
    # TW_PotSoilStep1_Sp1[Zone,BufValues] = 100*AF_ZoneFrac[Zone]*(AF_DepthAct1[Zone]*RT_TLrv1[Zone,Sp1]/ABS(W_PTheta1[Zone])^TW_DrySoilWeightFac[Sp1,BufValues]+AF_Depth2[Zone]*RT_TLrv2[Zone,Sp1]/ABS(W_PTheta2[Zone])^TW_DrySoilWeightFac[Sp1,BufValues]+AF_Depth3[Zone]*RT_TLrv3[Zone,Sp1]/ABS(W_PTheta3[Zone])^TW_DrySoilWeightFac[Sp1,BufValues]+AF_Depth4[Zone]*RT_TLrv4[Zone,Sp1]/ABS(W_PTheta4[Zone])^TW_DrySoilWeightFac[Sp1,BufValues])
    # TW_PotSoilStep1_Sp2[Zone,BufValues] = 100*AF_ZoneFrac[Zone]*(AF_DepthAct1[Zone]*RT_TLrv1[Zone,Sp2]/ABS(W_PTheta1[Zone])^TW_DrySoilWeightFac[Sp2,BufValues]+AF_Depth2[Zone]*RT_TLrv2[Zone,Sp2]/ABS(W_PTheta2[Zone])^TW_DrySoilWeightFac[Sp2,BufValues]+AF_Depth3[Zone]*RT_TLrv3[Zone,Sp2]/ABS(W_PTheta3[Zone])^TW_DrySoilWeightFac[Sp2,BufValues]+AF_Depth4[Zone]*RT_TLrv4[Zone,Sp2]/ABS(W_PTheta4[Zone])^TW_DrySoilWeightFac[Sp2,BufValues])
    # TW_PotSoilStep1_Sp3[Zone,BufValues] = 100*AF_ZoneFrac[Zone]*(AF_DepthAct1[Zone]*RT_TLrv1[Zone,Sp3]/ABS(W_PTheta1[Zone])^TW_DrySoilWeightFac[Sp3,BufValues]+AF_Depth2[Zone]*RT_TLrv2[Zone,Sp3]/ABS(W_PTheta2[Zone])^TW_DrySoilWeightFac[Sp3,BufValues]+AF_Depth3[Zone]*RT_TLrv3[Zone,Sp3]/ABS(W_PTheta3[Zone])^TW_DrySoilWeightFac[Sp3,BufValues]+AF_Depth4[Zone]*RT_TLrv4[Zone,Sp3]/ABS(W_PTheta4[Zone])^TW_DrySoilWeightFac[Sp3,BufValues])
    
    zonetreebuf_df$AF_ZoneFrac <- rep(zonetree_df$AF_ZoneFrac, nrow(buf_df))
    zonetreebuf_df$W_PTheta1 <- zonelayer_df[zonelayer_df$layer == 1, "W_PTheta"]
    zonetreebuf_df$W_PTheta2 <- zonelayer_df[zonelayer_df$layer == 2, "W_PTheta"]
    zonetreebuf_df$W_PTheta3 <- zonelayer_df[zonelayer_df$layer == 3, "W_PTheta"]
    zonetreebuf_df$W_PTheta4 <- zonelayer_df[zonelayer_df$layer == 4, "W_PTheta"]
    
    zonelayertree_df$RT_TLrv_depth <- zonelayertree_df$AF_Depth * zonelayertree_df$RT_TLrv
    zonetreebuf_df$RT_TLrv_d1 <- rep(zonelayertree_df[zonelayertree_df$layer == 1, "RT_TLrv_depth"], nrow(buf_df))
    zonetreebuf_df$RT_TLrv_d2 <- rep(zonelayertree_df[zonelayertree_df$layer == 2, "RT_TLrv_depth"], nrow(buf_df))
    zonetreebuf_df$RT_TLrv_d3 <- rep(zonelayertree_df[zonelayertree_df$layer == 3, "RT_TLrv_depth"], nrow(buf_df))
    zonetreebuf_df$RT_TLrv_d4 <- rep(zonelayertree_df[zonelayertree_df$layer == 4, "RT_TLrv_depth"], nrow(buf_df))
    
    df <- treebuf_df[c("tree_id", "buf_id", "TW_DrySoilWeightFac")]
    df <- df[rep(seq_len(nrow(df)), nzone), ]
    df$zone <- rep(zone_df$zone, each = nrow(treebuf_df))
    df <- df[order(df$buf_id, df$tree_id, df$zone), ]
    zonetreebuf_df$TW_DrySoilWeightFac <- df$TW_DrySoilWeightFac
    
    zonetreebuf_df$TW_PotSoilStep1 <- 100 * zonetreebuf_df$AF_ZoneFrac * (
      zonetreebuf_df$RT_TLrv_d1 / abs(zonetreebuf_df$W_PTheta1)^zonetreebuf_df$TW_DrySoilWeightFac +
        zonetreebuf_df$RT_TLrv_d2 /
        abs(zonetreebuf_df$W_PTheta2)^zonetreebuf_df$TW_DrySoilWeightFac +
        zonetreebuf_df$RT_TLrv_d3 /
        abs(zonetreebuf_df$W_PTheta3)^zonetreebuf_df$TW_DrySoilWeightFac +
        zonetreebuf_df$RT_TLrv_d4 /
        abs(zonetreebuf_df$W_PTheta4)^zonetreebuf_df$TW_DrySoilWeightFac
    )
    
    # RT_TLra[Zone,Tree] = (RT_TLrv1[Zone,Tree]*AF_DepthAct1[Zone]+RT_TLrv2[Zone,Tree]*AF_Depth2[Zone]+RT_TLrv3[Zone,Tree]*AF_Depth3[Zone]+RT_TLrv4[Zone,Tree]*AF_Depth4[Zone])*100
    zonetree_df$RT_TLra <- aggregate(zonelayertree_df["RT_TLrv_depth"], zonelayertree_df[c("zone", "tree_id")], sum)$RT_TLrv_depth *
      100
    
    # RT_TField[Tree] = AF_ZoneFrac[Zn1]*RT_TLra[Zn1, Tree]+AF_ZoneFrac[Zn2]*RT_TLra[Zn2, Tree]+AF_ZoneFrac[Zn3]*RT_TLra[Zn3, Tree]+RT_TLra[Zn4, Tree]*AF_ZoneFrac[Zn4]
    zonetree_df$RT_TLra_act <- zonetree_df$AF_ZoneFrac * zonetree_df$RT_TLra
    tree_df$RT_TField <- aggregate(zonetree_df["RT_TLra_act"], zonetree_df[c("tree_id")], sum)$RT_TLra_act
    
    
    # TW_PotSoilMeanPerceived[Tree,BufValues] = If T_TreeSpId[Tree] = 1 then
    # IF RT_TField[Sp1]>0 and ARRAYSUM(TW_PotSoilStep1_Sp1[*,BufValues]) <>0 THEN -TW_RangeToppingUp[BufValues]*((RT_TField[Sp1]/ARRAYSUM(TW_PotSoilStep1_Sp1[*,BufValues]) )^(1/TW_DrySoilWeightFac[Sp1,BufValues])) ELSE 0
    # Else If T_TreeSpId[Tree] = 2 then
    # IF RT_TField[Sp2]>0 and ARRAYSUM(TW_PotSoilStep1_Sp2[*,BufValues]) <>0 THEN -TW_RangeToppingUp[BufValues]*((RT_TField[Sp2]/ARRAYSUM(TW_PotSoilStep1_Sp2[*,BufValues]) )^(1/TW_DrySoilWeightFac[Sp2,BufValues])) ELSE 0
    # Else If T_TreeSpId[Tree] = 3 then
    # IF RT_TField[Sp3]>0 and ARRAYSUM(TW_PotSoilStep1_Sp3[*,BufValues]) <>0 THEN -TW_RangeToppingUp[BufValues]*((RT_TField[Sp3]/ARRAYSUM(TW_PotSoilStep1_Sp3[*,BufValues]) )^(1/TW_DrySoilWeightFac[Sp3,BufValues])) ELSE 0 Else 0
    treebuf_df$RT_TField <- rep(tree_df$RT_TField, nrow(buf_df))
    treebuf_df$TW_PotSoilStep1 <- aggregate(zonetreebuf_df["TW_PotSoilStep1"], zonetreebuf_df[c("tree_id", "buf_id")], sum)$TW_PotSoilStep1
    treebuf_df$TW_RangeToppingUp <- rep(buf_df$TW_RangeToppingUp, each = nrow(tree_df))
    
    treebuf_df$TW_PotSoilMeanPerceived <- ifelse(
      treebuf_df$RT_TField > 0 & treebuf_df$TW_PotSoilStep1 != 0,
      -treebuf_df$TW_RangeToppingUp *
        ((treebuf_df$RT_TField / treebuf_df$TW_PotSoilStep1)^(1 / treebuf_df$TW_DrySoilWeightFac)
        ),
      0
    )
    
    # TW_PotRadial[Tree] = IF(RT_TField[Tree]>0 AND T_RootConductivity[Tree]>0)THEN(-TW_DemandPot[Tree]*0.1/(T_RootConductivity[Tree]*(RT_TField[Tree])))ELSE(0)
    tree_df$TW_PotRadial <- ifelse(
      tree_df$RT_TField > 0 &
        tree_df$T_RootConductivity > 0,
      -tree_df$TW_DemandPot * 0.1 / (tree_df$T_RootConductivity * tree_df$RT_TField),
      0
    )
    
    
    
    zonetree_df$AF_TreePosit4Q <- rep(tree_df$AF_TreePosit4Q, each = nzone)
    zonetree_df$RT_ZoneLeft <- rep(zone_df$RT_ZoneLeft, nrow(tree_df))
    zonetree_df$RT_ZoneRight <- rep(zone_df$RT_ZoneRight, nrow(tree_df))
    
    # TW_DistAxialTransp[Tree,Zone] = if AF_TreePosit4Q[Tree] = 0 then (RT_ZoneLeft[Zone]+RT_ZoneRight[Zone])/2 else AF_ZoneTot-(RT_ZoneLeft[Zone]+RT_ZoneRight[Zone])/2
    zonetree_df$TW_DistAxialTransp <- ifelse(
      zonetree_df$AF_TreePosit4Q == 0,
      (zonetree_df$RT_ZoneLeft + zonetree_df$RT_ZoneRight) / 2,
      AF_ZoneTot - (zonetree_df$RT_ZoneLeft + zonetree_df$RT_ZoneRight) / 2
    )
    
    # TW_MeanDist[Tree] = if ARRAYSUM(RT_TLra[*,Tree])>0 then
    # (RT_TLra[Zn1,Tree]*TW_DistAxialTransp[Tree,Zn1]+
    # RT_TLra[Zn2,Tree]*TW_DistAxialTransp[Tree,Zn2]+
    # RT_TLra[Zn3,Tree]*TW_DistAxialTransp[Tree,Zn3]+
    # RT_TLra[Zn4,Tree]*TW_DistAxialTransp[Tree,Zn4])/ARRAYSUM(RT_TLra[*,Tree]) else 0
    
    
    zonetree_df$RT_TLra_tw <- zonetree_df$RT_TLra * zonetree_df$TW_DistAxialTransp
    tree_df$RT_TLra <- aggregate(zonetree_df["RT_TLra"], zonetree_df["tree_id"], sum)$RT_TLra
    tree_df$RT_TLra_tw <- aggregate(zonetree_df["RT_TLra_tw"], zonetree_df["tree_id"], sum)$RT_TLra_tw
    tree_df$TW_MeanDist <- ifelse(tree_df$RT_TLra > 0, tree_df$RT_TLra_tw /
                                    tree_df$RT_TLra, 0)
    
    # TW_PotLongitudinal[Tree] = if TW_MeanDist[Tree]>0 then -TW_DemandPot[Tree]/(TW_MeanDist[Tree]*TW_ResistFact[Tree]) else 0
    tree_df$TW_PotLongitudinal <- ifelse(
      tree_df$TW_MeanDist > 0,
      -tree_df$TW_DemandPot / (tree_df$TW_MeanDist * tree_df$TW_ResistFact),
      0
    )
    
    treebuf_df$TW_PotRadial <- rep(tree_df$TW_PotRadial, nrow(buf_df))
    treebuf_df$TW_PotLongitudinal <- rep(tree_df$TW_PotLongitudinal, nrow(buf_df))
    
    # TW_PotRange[Tree,BufValues] = TW_PotSoilMeanPerceived[Tree,BufValues]+TW_PotRadial[Tree]+TW_PotLongitudinal[Tree]
    treebuf_df$TW_PotRange <- treebuf_df$TW_PotSoilMeanPerceived + treebuf_df$TW_PotRadial + treebuf_df$TW_PotLongitudinal
    
    # TW_m[Tree] = IF((TW_PotSuctAlphMin[Tree] <>0) AND(1-TW_Alpha)>0 AND TW_Alpha/(1-TW_Alpha)>0 AND (TW_PotSuctAlphMax[Tree]/TW_PotSuctAlphMin[Tree])>0 )  THEN  (2*LOGN(TW_Alpha/(1-TW_Alpha))/LOGN(TW_PotSuctAlphMax[Tree]/TW_PotSuctAlphMin[Tree]))ELSE(0)
    tree_df$TW_m <- ifelse(
      tree_df$TW_PotSuctAlphMin != 0 &
        (1 - TW_Alpha) > 0 &
        TW_Alpha / (1 - TW_Alpha) > 0 &
        (tree_df$TW_PotSuctAlphMax / tree_df$TW_PotSuctAlphMin) >
        0,
      2 * log(TW_Alpha / (1 - TW_Alpha)) /
        log(tree_df$TW_PotSuctAlphMax / tree_df$TW_PotSuctAlphMin),
      0
    )
    
    
    treebuf_df$TW_m <- rep(tree_df$TW_m, nrow(buf_df))
    treebuf_df$TW_PotSuctHalf <- rep(tree_df$TW_PotSuctHalf, nrow(buf_df))
    treebuf_df$TW_DemandPot <- rep(tree_df$TW_DemandPot, nrow(buf_df))
    
    # TW_DemandRedFacRange[Tree,BufValues] = IF(TW_PotSuctHalf[Tree]<>0) and (TW_PotRange[Tree,BufValues]<>0 and (1+(min(0,(TW_PotRange[Tree,BufValues]))/TW_PotSuctHalf[Tree])^TW_m[Tree])<>0)
    # THEN(1/(1+(min(0,(TW_PotRange[Tree,BufValues]))/TW_PotSuctHalf[Tree])^TW_m[Tree])) - TW_DemActSubtract[BufValues]ELSE(0)
    treebuf_df$TW_DemandRedFacRange <- ifelse(
      treebuf_df$TW_PotSuctHalf != 0 &
        treebuf_df$TW_PotRange != 0 &
        (1 + (
          pmin(0, treebuf_df$TW_PotRange) / treebuf_df$TW_PotSuctHalf
        )^treebuf_df$TW_m) != 0,
      (1 / (
        1 + (
          pmin(0, treebuf_df$TW_PotRange) / treebuf_df$TW_PotSuctHalf
        )^treebuf_df$TW_m
      )) - treebuf_df$TW_DemActSubtract,
      0
    )
    
    
    # TW_DemandActRange[Tree,BufValues] = TW_DemandPot[Tree]*TW_DemandRedFacRange[Tree,BufValues]
    treebuf_df$TW_DemandActRange <- treebuf_df$TW_DemandPot * treebuf_df$TW_DemandRedFacRange
    
    # TW_DistAxialTransp[Tree,Zone] = if AF_TreePosit4Q[Tree] = 0 then (RT_ZoneLeft[Zone]+RT_ZoneRight[Zone])/2 else AF_ZoneTot-(RT_ZoneLeft[Zone]+RT_ZoneRight[Zone])/2
    # Tw_DistAxialTranspMean[Tree] = ARRAYMEAN(TW_DistAxialTransp[Tree,*])
    zonetree_df$TW_DistAxialTransp <- ifelse(
      zonetree_df$AF_TreePosit4Q == 0,
      (zonetree_df$RT_ZoneLeft + zonetree_df$RT_ZoneRight) /
        2,
      AF_ZoneTot - (zonetree_df$RT_ZoneLeft +
                      zonetree_df$RT_ZoneRight) / 2
    )
    
    tree_df$Tw_DistAxialTranspMean <- aggregate(zonetree_df["TW_DistAxialTransp"], zonetree_df["tree_id"], sum)$TW_DistAxialTransp
    
    zonetreebuf_df$Tw_DistAxialTranspMean <- rep(rep(tree_df$Tw_DistAxialTranspMean, each = nzone),
                                                 nrow(buf_df))
    zonetreebuf_df$TW_PotRange <- rep(treebuf_df$TW_PotRange, each = nzone)
    zonetreebuf_df$TW_DemandRedFacRange <- rep(treebuf_df$TW_DemandRedFacRange, each = nzone)
    zonetreebuf_df$TW_PotRadial <- rep(treebuf_df$TW_PotRadial, each = nzone)
    zonetreebuf_df$TW_PotLongitudinal <- rep(treebuf_df$TW_PotLongitudinal, each = nzone)
    zonetreebuf_df$TW_DistAxialTransp <- rep(zonetree_df$TW_DistAxialTransp, nrow(buf_df))
    
    # TW_PotRhizOptT1[Zone,BufValues] = TW_PotRange[Sp1,BufValues]-(1-TW_DemandRedFacRange[Sp1,BufValues])*(TW_PotRadial[Sp1]+TW_PotLongitudinal[Sp1])-
    #   (TW_DistAxialTransp[Sp1,Zone]/Tw_DistAxialTranspMean[Sp1])*TW_DemandRedFacRange[Sp1,BufValues]*TW_PotLongitudinal[Sp1]
    # TW_PotRhizOptT2[Zone,BufValues] = TW_PotRange[Sp2,BufValues]-(1-TW_DemandRedFacRange[Sp2,BufValues])*(TW_PotRadial[Sp2]+TW_PotLongitudinal[Sp2])-
    #   (TW_DistAxialTransp[Sp2,Zone]/Tw_DistAxialTranspMean[Sp2])*TW_DemandRedFacRange[Sp2,BufValues]*TW_PotLongitudinal[Sp2]
    # TW_PotRhizOptT3[Zone,BufValues] = TW_PotRange[Sp3,BufValues]-(1-TW_DemandRedFacRange[Sp3,BufValues])*(TW_PotRadial[Sp3]+TW_PotLongitudinal[Sp3])-
    #   (TW_DistAxialTransp[Sp3,Zone]/Tw_DistAxialTranspMean[Sp3])*TW_DemandRedFacRange[Sp3,BufValues]*TW_PotLongitudinal[Sp3]-TW_DemandRedFacRange[Sp3,BufValues]*TW_PotRadial[Sp3]
    
    zonetreebuf_df$TW_PotRhizOpt <- zonetreebuf_df$TW_PotRange - (1 - zonetreebuf_df$TW_DemandRedFacRange) *
      (zonetreebuf_df$TW_PotRadial + zonetreebuf_df$TW_PotLongitudinal) -
      (zonetreebuf_df$TW_DistAxialTransp / zonetreebuf_df$Tw_DistAxialTranspMean) * zonetreebuf_df$TW_DemandRedFacRange * zonetreebuf_df$TW_PotLongitudinal
    zt3b_df <- zonetreebuf_df[zonetreebuf_df$tree_id == 3, c("TW_PotRhizOpt", "TW_DemandRedFacRange", "TW_PotRadial")]
    zonetreebuf_df[zonetreebuf_df$tree_id == 3, "TW_PotRhizOpt"] <- zt3b_df$TW_PotRhizOpt - zt3b_df$TW_DemandRedFacRange * zt3b_df$TW_PotRadial
    
    df <- zonelayertree_df[c("W_Alpha", "W_n", "W_ThetaSat")]
    zonelayertreebuf_df[c("W_Alpha", "W_n", "W_ThetaSat")] <- df[rep(seq_len(nrow(df)), nrow(buf_df)), ]
    # zonelayertreebuf_df$buf_id <- rep(buf_df$buf_id, each = nrow(zonelayertree_df))
    
    df <- zonetreebuf_df[c("zone", "tree_id", "buf_id", "TW_PotRhizOpt")]
    df <- df[rep(seq_len(nrow(df)), nlayer), ]
    df$layer <- rep(layer_df$layer, each = nrow(zonetreebuf_df))
    df <- df[order(df$buf_id, df$tree_id, df$layer, df$zone), ]
    zonelayertreebuf_df$TW_PotRhizOpt <- df$TW_PotRhizOpt
    
    # TW_PotRhizThetaT1L1[Zone,BufValues] = if (1+(ABS(W_Alpha1*TW_PotRhizOptT1[Zone,BufValues]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*TW_PotRhizOptT1[Zone,BufValues]))^W_n1)^(1-1/W_n1) else 0
    # TW_PotRhizThetaT1L2[Zone,BufValues] = if (1+(ABS(W_Alpha2*TW_PotRhizOptT1[Zone,BufValues]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2 /(1+(ABS(W_Alpha2*TW_PotRhizOptT1[Zone,BufValues]))^W_n2)^(1-1/W_n2) else 0
    # TW_PotRhizThetaT1L3[Zone,BufValues] = if (1+(ABS(W_Alpha3*TW_PotRhizOptT1[Zone,BufValues]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3 /(1+(ABS(W_Alpha3*TW_PotRhizOptT1[Zone,BufValues]))^W_n3)^(1-1/W_n3) else 0
    # TW_PotRhizThetaT1L4[Zone,BufValues] = if (1+(ABS(W_Alpha4*TW_PotRhizOptT1[Zone,BufValues]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4 /(1+(ABS(W_Alpha4*TW_PotRhizOptT1[Zone,BufValues]))^W_n4)^(1-1/W_n4) else 0
    # TW_PotRhizThetaT2L1[Zone,BufValues] = If (1+(ABS(W_Alpha1*TW_PotRhizOptT2[Zone,BufValues]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*TW_PotRhizOptT2[Zone,BufValues]))^W_n1)^(1-1/W_n1) else 0
    # TW_PotRhizThetaT2L2[Zone,BufValues] = if (1+(ABS(W_Alpha2*TW_PotRhizOptT2[Zone,BufValues]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2 /(1+(ABS(W_Alpha2*TW_PotRhizOptT2[Zone,BufValues]))^W_n2)^(1-1/W_n2) else 0
    # TW_PotRhizThetaT2L3[Zone,BufValues] = if (1+(ABS(W_Alpha3*TW_PotRhizOptT2[Zone,BufValues]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3 /(1+(ABS(W_Alpha3*TW_PotRhizOptT2[Zone,BufValues]))^W_n3)^(1-1/W_n3) else 0
    # TW_PotRhizThetaT2L4[Zone,BufValues] = if (1+(ABS(W_Alpha4*TW_PotRhizOptT2[Zone,BufValues]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4 /(1+(ABS(W_Alpha4*TW_PotRhizOptT2[Zone,BufValues]))^W_n4)^(1-1/W_n4) else 0
    # TW_PotRhizThetaT3L1[Zone,BufValues] = if (1+(ABS(W_Alpha1*TW_PotRhizOptT3[Zone,BufValues]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*TW_PotRhizOptT3[Zone,BufValues]))^W_n1)^(1-1/W_n1) else 0
    # TW_PotRhizThetaT3L2[Zone,BufValues] = if (1+(ABS(W_Alpha2*TW_PotRhizOptT3[Zone,BufValues]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2 /(1+(ABS(W_Alpha2*TW_PotRhizOptT3[Zone,BufValues]))^W_n2)^(1-1/W_n2) else 0
    # TW_PotRhizThetaT3L3[Zone,BufValues] = if (1+(ABS(W_Alpha3*TW_PotRhizOptT3[Zone,BufValues]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3 /(1+(ABS(W_Alpha3*TW_PotRhizOptT3[Zone,BufValues]))^W_n3)^(1-1/W_n3) else 0
    # TW_PotRhizThetaT3L4[Zone,BufValues] = if (1+(ABS(W_Alpha4*TW_PotRhizOptT3[Zone,BufValues]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4 /(1+(ABS(W_Alpha4*TW_PotRhizOptT3[Zone,BufValues]))^W_n4)^(1-1/W_n4) else 0
    
    zonelayertreebuf_df$TW_PotRhizTheta_a <- (
      1 + abs(
        zonelayertreebuf_df$W_Alpha * zonelayertreebuf_df$TW_PotRhizOpt
      )^zonelayertreebuf_df$W_n
    )^(1 - 1 / zonelayertreebuf_df$W_n)
    
    zonelayertreebuf_df$TW_PotRhizTheta <- ifelse(
      zonelayertreebuf_df$TW_PotRhizTheta_a != 0,
      zonelayertreebuf_df$W_ThetaSat / zonelayertreebuf_df$TW_PotRhizTheta_a,
      0
    )
    
    
    
    zonelayer_df$RT_CParasitFrac <- rep(zone_df$RT_CParasitFrac, nlayer)
    
    # RT_CLrv1[Zone] = RT_CLrvM1[Zone]*(1-RT_CParasitFrac[Zone])
    # RT_CLrv2[Zone] = RT_CLrvM2[Zone]*(1-RT_CParasitFrac[Zone])
    # RT_CLrv3[Zone] = RT_CLrvM3[Zone]*(1-RT_CParasitFrac[Zone])
    # RT_CLrv4[Zone] = RT_CLrvM4[Zone]*(1-RT_CParasitFrac[Zone])
    zonelayer_df$RT_CLrv <- zonelayer_df$RT_CLrvM * (1 - zonelayer_df$RT_CParasitFrac)
    
    
    #
    # RT_T_RelImp_L1[Tree,Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv1[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv1[Zone,Sp1]+
    #   +TW_DemandPerRoot[Sp2]*RT_TLrv1[Zone,Sp2]+
    #   +TW_DemandPerRoot[Sp3]*RT_TLrv1[Zone,Sp3]) = 0 then 1 else TW_DemandPerRoot[Tree]*RT_TLrv1[Zone,Tree]
    # /(CW_DemandPerRoot[Zone]*RT_CLrv1[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv1[Zone,Sp1]+
    # +TW_DemandPerRoot[Sp2]*RT_TLrv1[Zone,Sp2]+
    # +TW_DemandPerRoot[Sp3]*RT_TLrv1[Zone,Sp3])
    #
    # RT_T_RelImp_L2[Tree,Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv2[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv2[Zone,Sp1]+
    #   +TW_DemandPerRoot[Sp2]*RT_TLrv2[Zone,Sp2]+
    #   +TW_DemandPerRoot[Sp3]*RT_TLrv2[Zone,Sp3]) = 0 then 1 else TW_DemandPerRoot[Tree]*RT_TLrv2[Zone,Tree]
    # /(CW_DemandPerRoot[Zone]*RT_CLrv2[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv2[Zone,Sp1]+
    # +TW_DemandPerRoot[Sp2]*RT_TLrv2[Zone,Sp2]+
    # +TW_DemandPerRoot[Sp3]*RT_TLrv2[Zone,Sp3])
    #
    # RT_T_RelImp_L3[Tree,Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv3[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv3[Zone,Sp1]+
    #   +TW_DemandPerRoot[Sp2]*RT_TLrv3[Zone,Sp2]+
    #   +TW_DemandPerRoot[Sp3]*RT_TLrv3[Zone,Sp3]) = 0 then 1 else TW_DemandPerRoot[Tree]*RT_TLrv3[Zone,Tree]
    # /(CW_DemandPerRoot[Zone]*RT_CLrv3[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv3[Zone,Sp1]+
    # +TW_DemandPerRoot[Sp2]*RT_TLrv3[Zone,Sp2]+
    # +TW_DemandPerRoot[Sp3]*RT_TLrv3[Zone,Sp3])
    #
    # RT_T_RelImp_L4[Tree,Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv4[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv4[Zone,Sp1]+
    #   +TW_DemandPerRoot[Sp2]*RT_TLrv4[Zone,Sp2]+
    #   +TW_DemandPerRoot[Sp3]*RT_TLrv4[Zone,Sp3]) = 0 then 1 else TW_DemandPerRoot[Tree]*RT_TLrv4[Zone,Tree]
    # /(CW_DemandPerRoot[Zone]*RT_CLrv4[Zone]
    #   +TW_DemandPerRoot[Sp1]*RT_TLrv4[Zone,Sp1]+
    # +TW_DemandPerRoot[Sp2]*RT_TLrv4[Zone,Sp2]+
    # +TW_DemandPerRoot[Sp3]*RT_TLrv4[Zone,Sp3])
    
    
    zonelayer_df$CW_DemandPerRoot <- rep(zone_df$CW_DemandPerRoot, nlayer)
    zonelayertree_df$TW_DemandPerRoot <- rep(tree_df$TW_DemandPerRoot, each = nzone *
                                               nlayer)
    
    zlt1 <- zonelayertree_df[zonelayertree_df$tree_id == 1, c("TW_DemandPerRoot", "RT_TLrv")]
    zlt2 <- zonelayertree_df[zonelayertree_df$tree_id == 2, c("TW_DemandPerRoot", "RT_TLrv")]
    zlt3 <- zonelayertree_df[zonelayertree_df$tree_id == 3, c("TW_DemandPerRoot", "RT_TLrv")]
    
    zonelayer_df$RT_T_RelImp_a <- zonelayer_df$CW_DemandPerRoot * zonelayer_df$RT_CLrv +
      zlt1$TW_DemandPerRoot * zlt1$RT_TLrv + zlt2$TW_DemandPerRoot * zlt2$RT_TLrv + zlt3$TW_DemandPerRoot * zlt3$RT_TLrv
    
    zonelayertree_df$RT_T_RelImp_a <- rep(zonelayer_df$RT_T_RelImp_a, ntree)
    zonelayertree_df$RT_T_RelImp <- ifelse(
      zonelayertree_df$RT_T_RelImp_a == 0,
      1,
      zonelayertree_df$TW_DemandPerRoot * zonelayertree_df$RT_TLrv / zonelayertree_df$RT_T_RelImp_a
    )
    
    
    zonelayertree_df$RT_TLrv_by_TD <- zonelayertree_df$RT_TLrv * sqrt(zonelayertree_df$RT_TDiam)
    tree_agg_df <- aggregate(zonelayertree_df[c("RT_TLrv", "RT_TLrv_by_TD")], zonelayertree_df[c("zone", "layer")], sum)
    zonelayer_df$RT_TLrv_sum <- tree_agg_df$RT_TLrv
    zonelayer_df$RT_TLrv_by_TD_sum <- tree_agg_df$RT_TLrv_by_TD
    
    # RT_TCDiam1[Zone] = IF((RT_CLrv1[Zone]+ARRAYSUM(RT_TLrv1[Zone,*]))>0)THEN(((RT_CLrv1[Zone]*SQRT(CQ_RtDiam[Zone])+RT_TLrv1[Zone,Sp1]*SQRT(RT_TDiam[Sp1])+RT_TLrv1[Zone,Sp2]*SQRT(RT_TDiam[Sp2])+RT_TLrv1[Zone,Sp3]*SQRT(RT_TDiam[Sp3]))/(RT_CLrv1[Zone]+ARRAYSUM(RT_TLrv1[Zone,*])))^2)ELSE(0)
    # RT_TCDiam2[Zone] = IF((RT_CLrv2[Zone]+ARRAYSUM(RT_TLrv2[Zone,*]))>0)THEN(((RT_CLrv2[Zone]*SQRT(CQ_RtDiam[Zone])+RT_TLrv2[Zone,Sp1]*SQRT(RT_TDiam[Sp1])+RT_TLrv2[Zone,Sp2]*SQRT(RT_TDiam[Sp2])+RT_TLrv2[Zone,Sp3]*SQRT(RT_TDiam[Sp3]))/(RT_CLrv2[Zone]+ARRAYSUM(RT_TLrv2[Zone,*])))^2)ELSE(0)
    # RT_TCDiam3[Zone] = IF((RT_CLrv3[Zone]+ARRAYSUM(RT_TLrv3[Zone,*]))>0)THEN(((RT_CLrv3[Zone]*SQRT(CQ_RtDiam[Zone])+RT_TLrv3[Zone,Sp1]*SQRT(RT_TDiam[Sp1])+RT_TLrv3[Zone,Sp2]*SQRT(RT_TDiam[Sp2])+RT_TLrv3[Zone,Sp3]*SQRT(RT_TDiam[Sp3]))/(RT_CLrv3[Zone]+ARRAYSUM(RT_TLrv3[Zone,*])))^2)ELSE(0)
    # RT_TCDiam4[Zone] = IF((RT_CLrv4[Zone]+ARRAYSUM(RT_TLrv4[Zone,*]))>0)THEN(((RT_CLrv4[Zone]*SQRT(CQ_RtDiam[Zone])+RT_TLrv4[Zone,Sp1]*SQRT(RT_TDiam[Sp1])+RT_TLrv4[Zone,Sp2]*SQRT(RT_TDiam[Sp2])+RT_TLrv4[Zone,Sp3]*SQRT(RT_TDiam[Sp3]))/(RT_CLrv4[Zone]+ARRAYSUM(RT_TLrv4[Zone,*])))^2)ELSE(0)
    zonelayer_df$RT_TCDiam <- ifelse((zonelayer_df$RT_CLrv + zonelayer_df$RT_TLrv_sum) >
                                       0,
                                     (((
                                       zonelayer_df$RT_CLrv * sqrt(zonelayer_df$CQ_RtDiam) + zonelayer_df$RT_TLrv_by_TD_sum
                                     ) / (zonelayer_df$RT_CLrv + zonelayer_df$RT_TLrv_sum)
                                     ))^2,
                                     0)
    
    # RT_RhoTot1[Zone] = if RT_TCDiam1[Zone]*.5*SQRT(PI*(RT_CLrv1[Zone]+ARRAYSUM(RT_TLrv1[Zone,*]))) > 0 then
    # 1/(RT_TCDiam1[Zone]*.5*SQRT(PI*(RT_CLrv1[Zone]+ARRAYSUM(RT_TLrv1[Zone,*])))) else RT_StopGap
    # RT_RhoTot2[Zone] = if RT_TCDiam2[Zone]*.5*SQRT(PI*(RT_CLrv2[Zone]+ARRAYSUM(RT_TLrv2[Zone,*]))) > 0 then
    # 1/(RT_TCDiam2[Zone]*.5*SQRT(PI*(RT_CLrv2[Zone]+ARRAYSUM(RT_TLrv2[Zone,*])))) else RT_StopGap
    # RT_RhoTot3[Zone] = if RT_TCDiam3[Zone]*.5*SQRT(PI*(RT_CLrv3[Zone]+ARRAYSUM(RT_TLrv3[Zone,*]))) > 0 then
    # 1/(RT_TCDiam3[Zone]*.5*SQRT(PI*(RT_CLrv3[Zone]+ARRAYSUM(RT_TLrv3[Zone,*])))) else RT_StopGap
    # RT_RhoTot4[Zone] = if RT_TCDiam4[Zone]*.5*SQRT(PI*(RT_CLrv4[Zone]+ARRAYSUM(RT_TLrv4[Zone,*]))) >0 then
    # 1/(RT_TCDiam4[Zone]*.5*SQRT(PI*(RT_CLrv4[Zone]+ARRAYSUM(RT_TLrv4[Zone,*])))) else RT_StopGap
    
    zonelayer_df$RT_RhoTot_a <- zonelayer_df$RT_TCDiam * 0.5 * sqrt(pi * (zonelayer_df$RT_CLrv + zonelayer_df$RT_TLrv_sum))
    zonelayer_df$RT_RhoTot <- ifelse(zonelayer_df$RT_RhoTot_a > 0,
                                     1 / zonelayer_df$RT_RhoTot_a,
                                     RT_StopGap)
    
    
    
    # RT_TC_G1[Zone] = if RT_RhoTot1[Zone] <> RT_StopGap then
    # (RT_RhoTot1[Zone]^2-1)/(0.5*(((1-(3*RT_RhoTot1[Zone]^2))/4)+((RT_RhoTot1[Zone]^4*LOGN(RT_RhoTot1[Zone]))/(RT_RhoTot1[Zone]^2-1)))) else 0
    # RT_TC_G2[Zone] = if RT_RhoTot2[Zone] <> RT_StopGap then
    # (RT_RhoTot2[Zone]^2-1)/(0.5*(((1-(3*RT_RhoTot2[Zone]^2))/4)+((RT_RhoTot2[Zone]^4*LOGN(RT_RhoTot2[Zone]))/(RT_RhoTot2[Zone]^2-1)))) else 0
    # RT_TC_G3[Zone] = if RT_RhoTot3[Zone] <> RT_StopGap then
    # (RT_RhoTot3[Zone]^2-1)/(0.5*(((1-(3*RT_RhoTot3[Zone]^2))/4)+((RT_RhoTot3[Zone]^4*LOGN(RT_RhoTot3[Zone]))/(RT_RhoTot3[Zone]^2-1)))) else 0
    # RT_TC_G4[Zone] = if RT_RhoTot4[Zone] <> RT_StopGap then
    # (RT_RhoTot4[Zone]^2-1)/(0.5*(((1-(3*RT_RhoTot4[Zone]^2))/4)+((RT_RhoTot4[Zone]^4*LOGN(RT_RhoTot4[Zone]))/(RT_RhoTot4[Zone]^2-1)))) else 0
    
    zonelayer_df$RT_TC_G <- ifelse(zonelayer_df$RT_RhoTot != RT_StopGap,
                                   (zonelayer_df$RT_RhoTot^2 - 1) / (0.5 * (((
                                     1 - (3 * zonelayer_df$RT_RhoTot^2)
                                   ) / 4) + ((zonelayer_df$RT_RhoTot^4 * log(zonelayer_df$RT_RhoTot)) / (zonelayer_df$RT_RhoTot^2 - 1)
                                   ))),
                                   0)
    
    
    # W_PhiTheta1[Zone] = GRAPH(W_Theta1[Zone])
    # W_PhiTheta2[Zone] = GRAPH(W_Theta2[Zone])
    # W_PhiTheta3[Zone] = GRAPH(W_Theta3[Zone])
    # W_PhiTheta4[Zone] = GRAPH(W_Theta4[Zone])
    layer_df$W_PhiTheta <- apply(layer_df[c("layer", "W_Theta")], 1, function(x){
      get_graph_y(
        W_PhiTheta_df,
        x[["W_Theta"]],
        x_column = "Theta",
        y_column = names(W_PhiTheta_df)[x[["layer"]]],
        mode = "continues"
      )
    })
    zonelayer_df$W_PhiTheta <- rep(layer_df$W_PhiTheta, each = nzone)
    
    
    # zonelayer_df$W_PhiTheta <- NA
    # for (i in 1:nrow(zonelayer_df)) {
    #   zonelayer_df[i, ]$W_PhiTheta <- get_graph_y(
    #     W_PhiTheta_df,
    #     zonelayer_df[i, ]$W_Theta,
    #     x_column = "Theta",
    #     y_column = names(W_PhiTheta_df)[zonelayer_df[i, ]$layer],
    #     mode = "continues"
    #   )
    # }
    
    zonelayertreebuf_df$RT_TC_G <- rep(zonelayer_df$RT_TC_G, ntree * nrow(buf_df))
    zonelayertreebuf_df$W_PhiTheta <- rep(zonelayer_df$W_PhiTheta, ntree * nrow(buf_df))
    
    # TW_pFPotRhizOptT1[Zone,BufValues] = IF TW_PotRhizOptT1[Zone,BufValues]<0 THEN LOG10(-TW_PotRhizOptT1[Zone,BufValues])ELSE 0
    # TW_pFPotRhizOptT2[Zone,BufValues] = IF TW_PotRhizOptT2[Zone,BufValues]<0 THEN LOG10(-TW_PotRhizOptT2[Zone,BufValues])ELSE 0
    # TW_pFPotRhizOptT3[Zone,BufValues] = IF TW_PotRhizOptT3[Zone,BufValues]<0 THEN LOG10(-TW_PotRhizOptT3[Zone,BufValues])ELSE 0
    zonetreebuf_df$TW_pFPotRhizOpt <- ifelse(zonetreebuf_df$TW_PotRhizOpt <
                                               0,
                                             log10(-zonetreebuf_df$TW_PotRhizOpt),
                                             0)
    
    
    # TW_PhiPotT1L1[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT1[Zone,BufValues])
    # TW_PhiPotT1L2[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT1[Zone,BufValues])
    # TW_PhiPotT1L3[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT1[Zone,BufValues])
    # TW_PhiPotT1L4[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT1[Zone,BufValues])
    # TW_PhiPotT2L1[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT2[Zone,BufValues])
    # TW_PhiPotT2L2[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT2[Zone,BufValues])
    # TW_PhiPotT2L3[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT2[Zone,BufValues])
    # TW_PhiPotT2L4[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT2[Zone,BufValues])
    # TW_PhiPotT3L1[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT3[Zone,BufValues])
    # TW_PhiPotT3L2[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT3[Zone,BufValues])
    # TW_PhiPotT3L3[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT3[Zone,BufValues])
    # TW_PhiPotT3L4[Zone,BufValues] = GRAPH(TW_pFPotRhizOptT3[Zone,BufValues])
    tree_df$TW_pFPotRhizOpt <- zonetreebuf_df[zonetreebuf_df$zone ==1 & zonetreebuf_df$buf_id == 1,]$TW_pFPotRhizOpt
    layertree_df$TW_pFPotRhizOpt <- rep(tree_df$TW_pFPotRhizOpt, each = nlayer)
    layertree_df$TW_PhiPot <- apply(layertree_df[c("layer", "tree_id", "TW_pFPotRhizOpt")], 1,function(x){
      get_TW_PhiPot(x[["TW_pFPotRhizOpt"]], x[["layer"]], x[["tree_id"]])
    })
    zonelayertreebuf_df$TW_PhiPot <- rep(rep(layertree_df$TW_PhiPot, each = nzone), nrow(buf_df))
    
    # 
    # zonelayertreebuf_df$TW_PhiPot <- NA
    # 
    # #TODO: ini lama!
    # for (i in 1:nrow(zonelayertreebuf_df)) {
    #   x <- zonetreebuf_df[zonetreebuf_df$zone == zonelayertreebuf_df[i, ]$zone &
    #                         zonetreebuf_df$tree_id == zonelayertreebuf_df[i, ]$tree_id &
    #                         zonetreebuf_df$buf_id == zonelayertreebuf_df[i, ]$buf_id, ]$TW_pFPotRhizOpt
    #   
    #   zonelayertreebuf_df[i, ]$TW_PhiPot <- get_TW_PhiPot(x,
    #                                                       zonelayertreebuf_df[i, ]$layer,
    #                                                       zonelayertreebuf_df[i, ]$tree_id)
    # }
    
    # W_PotUptOptT1L1[Zone,BufValues] = IF RT_TC_G1[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta1[Zone]-TW_PhiPotT1L1[Zone,BufValues]))*RT_TC_G1[Zone]*RT_TLrv1[Zone,Sp1] ELSE 0
    # W_PotUptOptT1L2[Zone,BufValues] = IF RT_TC_G2[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta2[Zone]-TW_PhiPotT1L2[Zone,BufValues]))*RT_TC_G2[Zone]*RT_TLrv2[Zone,Sp1] ELSE 0
    # W_PotUptOptT1L3[Zone,BufValues] = IF RT_TC_G3[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta3[Zone]-TW_PhiPotT1L3[Zone,BufValues]))*RT_TC_G3[Zone]*RT_TLrv3[Zone,Sp1] ELSE 0
    # W_PotUptOptT1L4[Zone,BufValues] = IF RT_TC_G4[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta4[Zone]-TW_PhiPotT1L4[Zone,BufValues]))*RT_TC_G4[Zone]*RT_TLrv4[Zone,Sp1] ELSE 0
    # W_PotUptOptT2L1[Zone,BufValues] = IF RT_TC_G1[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta1[Zone]-TW_PhiPotT2L1[Zone,BufValues]))*RT_TC_G1[Zone]*RT_TLrv1[Zone,Sp2] ELSE 0
    # W_PotUptOptT2L2[Zone,BufValues] = IF RT_TC_G2[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta2[Zone]-TW_PhiPotT2L2[Zone,BufValues]))*RT_TC_G2[Zone]*RT_TLrv2[Zone,Sp2] ELSE 0
    # W_PotUptOptT2L3[Zone,BufValues] = IF RT_TC_G3[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta3[Zone]-TW_PhiPotT2L3[Zone,BufValues]))*RT_TC_G3[Zone]*RT_TLrv3[Zone,Sp2] ELSE 0
    # W_PotUptOptT2L4[Zone,BufValues] = IF RT_TC_G4[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta4[Zone]-TW_PhiPotT2L4[Zone,BufValues]))*RT_TC_G4[Zone]*RT_TLrv4[Zone,Sp2] ELSE 0
    # W_PotUptOptT3L1[Zone,BufValues] = IF RT_TC_G1[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta1[Zone]-TW_PhiPotT3L1[Zone,BufValues]))*RT_TC_G1[Zone]*RT_TLrv1[Zone,Sp3] ELSE 0
    # W_PotUptOptT3L2[Zone,BufValues] = IF RT_TC_G2[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta2[Zone]-TW_PhiPotT3L2[Zone,BufValues]))*RT_TC_G2[Zone]*RT_TLrv2[Zone,Sp3] ELSE 0
    # W_PotUptOptT3L3[Zone,BufValues] = IF RT_TC_G3[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta3[Zone]-TW_PhiPotT3L3[Zone,BufValues]))*RT_TC_G3[Zone]*RT_TLrv3[Zone,Sp3] ELSE 0
    # W_PotUptOptT3L4[Zone,BufValues] = IF RT_TC_G4[Zone]<>0 THEN 10*PI*(max(0,+W_PhiTheta4[Zone]-TW_PhiPotT3L4[Zone,BufValues]))*RT_TC_G4[Zone]*RT_TLrv4[Zone,Sp3] ELSE 0
    
    zonelayertreebuf_df$RT_TLrv <- rep(zonelayertree_df$RT_TLrv, nrow(buf_df))
    zonelayertreebuf_df$W_PotUptOpt <- ifelse(
      zonelayertreebuf_df$RT_TC_G != 0,
      10 * pi * (
        pmax(
          0,
          zonelayertreebuf_df$W_PhiTheta -
            zonelayertreebuf_df$TW_PhiPot
        )
      ) * zonelayertreebuf_df$RT_TC_G * zonelayertreebuf_df$RT_TLrv,
      0
    )
    
    
    # W_PotUptOptT1profileZn[Zone,BufValues] = if TW_Water_Limited?[Zone]=1 then Max(0,min((W_Theta1[Zone]-TW_PotRhizThetaT1L1[Zone,BufValues])*AF_DepthAct1[Zone]*1000,100*RT_T_RelImp_L1[Sp1,Zone]*AF_DepthAct1[Zone]*W_PotUptOptT1L1[Zone,BufValues]))+Max(0,min((W_Theta2[Zone]-Tw_PotRhizThetaT1L2[Zone,BufValues])*AF_Depth2[Zone]*1000,100*RT_T_RelImp_L2[Sp1,Zone]*AF_Depth2[Zone]*W_PotUptOptT1L2[Zone,BufValues]))+Max(0,min((W_Theta3[Zone]-Tw_PotRhizThetaT1L3[Zone,BufValues])*AF_Depth3[Zone]*1000,100*RT_T_RelImp_L3[Sp1,Zone]*AF_Depth3[Zone]*W_PotUptOptT1L3[Zone,BufValues]))+Max(0,min((W_Theta4[Zone]-Tw_PotRhizThetaT1L4[Zone,BufValues])*AF_Depth4[Zone]*1000,100*RT_T_RelImp_L4[Sp1,Zone]*AF_Depth4[Zone]*W_PotUptOptT1L4[Zone,BufValues])) else Max(0,100*RT_T_RelImp_L1[Sp1,Zone]*AF_DepthAct1[Zone]*W_PotUptOptT1L1[Zone,BufValues])+Max(0,100*RT_T_RelImp_L2[Sp1,Zone]*AF_Depth2[Zone]*W_PotUptOptT1L2[Zone,BufValues])+Max(0,100*RT_T_RelImp_L3[Sp1,Zone]*AF_Depth3[Zone]*W_PotUptOptT1L3[Zone,BufValues])+Max(0,100*RT_T_RelImp_L4[Sp1,Zone]*AF_Depth4[Zone]*W_PotUptOptT1L4[Zone,BufValues])
    # W_PotUptOptT2ProfileZn[Zone,BufValues] = if TW_Water_Limited?[Zone]=1 then Max(0,min((W_Theta1[Zone]-Tw_PotRhizThetaT2L1[Zone,BufValues])*AF_DepthAct1[Zone]*1000,100*RT_T_RelImp_L1[Sp2,Zone]*AF_DepthAct1[Zone]*W_PotUptOptT2L1[Zone,BufValues]))+Max(0,min((W_Theta2[Zone]-Tw_PotRhizThetaT2L2[Zone,BufValues])*AF_Depth2[Zone]*1000,100*RT_T_RelImp_L2[Sp2,Zone]*AF_Depth2[Zone]*W_PotUptOptT2L2[Zone,BufValues]))+Max(0,min((W_Theta3[Zone]-Tw_PotRhizThetaT2L3[Zone,BufValues])*AF_Depth3[Zone]*1000,100*RT_T_RelImp_L3[Sp2,Zone]*AF_Depth3[Zone]*W_PotUptOptT2L3[Zone,BufValues]))+Max(0,min((W_Theta4[Zone]-Tw_PotRhizThetaT2L4[Zone,BufValues])*AF_Depth4[Zone]*1000,100*RT_T_RelImp_L4[Sp2,Zone]*AF_Depth4[Zone]*W_PotUptOptT2L4[Zone,BufValues])) else Max(0,100*RT_T_RelImp_L1[Sp2,Zone]*AF_DepthAct1[Zone]*W_PotUptOptT2L1[Zone,BufValues])+Max(0,100*RT_T_RelImp_L2[Sp2,Zone]*AF_Depth2[Zone]*W_PotUptOptT2L2[Zone,BufValues])+Max(0,100*RT_T_RelImp_L3[Sp2,Zone]*AF_Depth3[Zone]*W_PotUptOptT2L3[Zone,BufValues])+Max(0,100*RT_T_RelImp_L4[Sp2,Zone]*AF_Depth4[Zone]*W_PotUptOptT2L4[Zone,BufValues])
    # W_PotUptOptT3ProfileZn[Zone,BufValues] = if TW_Water_Limited?[Zone]=1 then Max(0,min((W_Theta1[Zone]-Tw_PotRhizThetaT3L1[Zone,BufValues])*AF_DepthAct1[Zone]*1000,100*RT_T_RelImp_L1[Sp3,Zone]*AF_DepthAct1[Zone]*W_PotUptOptT3L1[Zone,BufValues]))+Max(0,min((W_Theta2[Zone]-Tw_PotRhizThetaT3L2[Zone,BufValues])*AF_Depth2[Zone]*1000,100*RT_T_RelImp_L2[Sp3,Zone]*AF_Depth2[Zone]*W_PotUptOptT3L2[Zone,BufValues]))+Max(0,min((W_Theta3[Zone]-Tw_PotRhizThetaT3L3[Zone,BufValues])*AF_Depth3[Zone]*1000,100*RT_T_RelImp_L3[Sp3,Zone]*AF_Depth3[Zone]*W_PotUptOptT3L3[Zone,BufValues]))+Max(0,min((W_Theta4[Zone]-Tw_PotRhizThetaT3L4[Zone,BufValues])*AF_Depth4[Zone]*1000,100*RT_T_RelImp_L4[Sp3,Zone]*AF_Depth4[Zone]*W_PotUptOptT3L4[Zone,BufValues])) else Max(0,100*RT_T_RelImp_L1[Sp3,Zone]*AF_DepthAct1[Zone]*W_PotUptOptT3L1[Zone,BufValues])+Max(0,100*RT_T_RelImp_L2[Sp3,Zone]*AF_Depth2[Zone]*W_PotUptOptT3L2[Zone,BufValues])+Max(0,100*RT_T_RelImp_L3[Sp3,Zone]*AF_Depth3[Zone]*W_PotUptOptT3L3[Zone,BufValues])+Max(0,100*RT_T_RelImp_L4[Sp3,Zone]*AF_Depth4[Zone]*W_PotUptOptT3L4[Zone,BufValues])
    
    zonelayertreebuf_df$W_Theta <- rep(zonelayer_df$W_Theta, ntree * nrow(buf_df))
    zonelayertreebuf_df$AF_Depth <- rep(zonelayer_df$AF_Depth, ntree * nrow(buf_df))
    zonelayertreebuf_df$RT_T_RelImp <- rep(zonelayertree_df$RT_T_RelImp, nrow(buf_df))
    zonetreebuf_df$TW_Water_Limited_is <- rep(zone_df$TW_Water_Limited_is, ntree * nrow(buf_df))
    
    zonelayertreebuf_df$W_PotUptOpt_a <- pmax(
      0,
      pmin((
        zonelayertreebuf_df$W_Theta - zonelayertreebuf_df$TW_PotRhizTheta
      ) * zonelayertreebuf_df$AF_Depth * 1000,
      100 * zonelayertreebuf_df$RT_T_RelImp *
        zonelayertreebuf_df$AF_Depth * zonelayertreebuf_df$W_PotUptOpt
      )
    )
    zonelayertreebuf_df$W_PotUptOpt_b <- pmax(
      0,
      100 * zonelayertreebuf_df$RT_T_RelImp * zonelayertreebuf_df$AF_Depth * zonelayertreebuf_df$W_PotUptOpt
    )
    zonetreebuf_df <- cbind(zonetreebuf_df,
                            aggregate(zonelayertreebuf_df[c("W_PotUptOpt_a", "W_PotUptOpt_b")], zonelayertreebuf_df[c("zone", "tree_id", "buf_id")], sum)[c("W_PotUptOpt_a", "W_PotUptOpt_b")])
    
    zonetreebuf_df$W_PotUptOptProfileZn <- ifelse(
      zonetreebuf_df$TW_Water_Limited_is == 1,
      zonetreebuf_df$W_PotUptOpt_a,
      zonetreebuf_df$W_PotUptOpt_b
    )
    
    
    # W_PotUptT1Profile[BufValues] = AF_ZoneFrac[Zn1]*W_PotUptOptT1profileZn[Zn1,BufValues]+
    #   AF_ZoneFrac[Zn2]*W_PotUptOptT1profileZn[Zn2,BufValues]+
    #   AF_ZoneFrac[Zn3]*W_PotUptOptT1profileZn[Zn3,BufValues]+
    #   AF_ZoneFrac[Zn4]*W_PotUptOptT1profileZn[Zn4,BufValues]
    # W_PotUptT2Profile[BufValues] = AF_ZoneFrac[Zn1]*W_PotUptOptT2ProfileZn[Zn1,BufValues]+
    #   AF_ZoneFrac[Zn2]*W_PotUptOptT2ProfileZn[Zn2,BufValues]+
    #   AF_ZoneFrac[Zn3]*W_PotUptOptT2ProfileZn[Zn3,BufValues]+
    #   AF_ZoneFrac[Zn4]*W_PotUptOptT2ProfileZn[Zn4,BufValues]
    # W_PotUptT3Profile[BufValues] = AF_ZoneFrac[Zn1]*W_PotUptOptT3ProfileZn[Zn1,BufValues]+
    #   AF_ZoneFrac[Zn2]*W_PotUptOptT3ProfileZn[Zn2,BufValues]+
    #   AF_ZoneFrac[Zn3]*W_PotUptOptT3ProfileZn[Zn3,BufValues]+
    #   AF_ZoneFrac[Zn4]*W_PotUptOptT3ProfileZn[Zn4,BufValues]
    
    
    zonetreebuf_df$W_PotUptProfile_a <- zonetreebuf_df$AF_ZoneFrac * zonetreebuf_df$W_PotUptOptProfileZn
    treebuf_df$W_PotUptProfile <- aggregate(
      list(W_PotUptProfile_sum = zonetreebuf_df$W_PotUptProfile_a),
      zonetreebuf_df[c("tree_id", "buf_id")],
      sum
    )$W_PotUptProfile_sum
    
    
    # TW_PotUptOptAll[Sp1,1] = W_PotUptT1Profile[1]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,2] = W_PotUptT1Profile[2]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,3] = W_PotUptT1Profile[3]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,4] = W_PotUptT1Profile[4]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,5] = W_PotUptT1Profile[5]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,6] = W_PotUptT1Profile[6]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,7] = W_PotUptT1Profile[7]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,8] = W_PotUptT1Profile[8]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,9] = W_PotUptT1Profile[9]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp1,10] = W_PotUptT1Profile[10]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,1] = W_PotUptT2Profile[1]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,2] = W_PotUptT2Profile[2]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,3] = W_PotUptT2Profile[3]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,4] = W_PotUptT2Profile[4]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,5] = W_PotUptT2Profile[5]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,6] = W_PotUptT2Profile[6]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,7] = W_PotUptT2Profile[7]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,8] = W_PotUptT2Profile[8]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,9] = W_PotUptT2Profile[9]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp2,10] = W_PotUptT2Profile[10]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,1] = W_PotUptT3Profile[1]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,2] = W_PotUptT3Profile[2]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,3] = W_PotUptT3Profile[3]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,4] = W_PotUptT3Profile[4]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,5] = W_PotUptT3Profile[5]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,6] = W_PotUptT3Profile[6]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,7] = W_PotUptT3Profile[7]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,8] = W_PotUptT3Profile[8]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,9] = W_PotUptT3Profile[9]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    # TW_PotUptOptAll[Sp3,10] = W_PotUptT3Profile[10]+0*(W_PotUptT1Profile[1]+W_PotUptT2Profile[1]+W_PotUptT3Profile[1])
    treebuf_df$TW_PotUptOptAll <- treebuf_df$W_PotUptProfile
    
    # TW_PU[Tree,BufValues] = min(TW_DemandActRange[Tree,BufValues],TW_PotUptOptAll[Tree,BufValues])
    treebuf_df$TW_PU <- pmin(treebuf_df$TW_DemandActRange,
                             treebuf_df$TW_PotUptOptAll)
    
    # TW_MaxUptPot[Tree] = max(TW_PU[Tree,1],TW_PU[Tree,2],TW_PU[Tree,3],TW_PU[Tree,4],TW_PU[Tree,5],TW_PU[Tree,6],TW_PU[Tree,7],TW_PU[Tree,8],TW_PU[Tree,9],TW_PU[Tree,10])
    tree_df$TW_MaxUptPot <- aggregate(treebuf_df$TW_PU, treebuf_df["tree_id"], max)$x
    
    # tree_df$TW_MaxUptPot <- NA
    # for (i in 1:ntree) {
    #   tree_df[tree_df$tree_id == i, ]$TW_MaxUptPot <- max(treebuf_df[treebuf_df$tree_id == i, ]$TW_PU)
    # }
    
    treebuf_df$TW_MaxUptPot <- rep(tree_df$TW_MaxUptPot, nrow(buf_df))
    
    # TW_Best?[Sp1,1] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,1] then 1 else 0
    # TW_Best?[Sp1,2] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,2] and TW_PU[Sp1,2] > TW_PU[Sp1,1] then 1 else 0
    # TW_Best?[Sp1,3] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,3] and TW_PU[Sp1,3] > TW_PU[Sp1,2] then 1 else 0
    # TW_Best?[Sp1,4] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,4] and TW_PU[Sp1,4] > TW_PU[Sp1,3] then 1 else 0
    # TW_Best?[Sp1,5] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,5] and TW_PU[Sp1,5] > TW_PU[Sp1,4] then 1 else 0
    # TW_Best?[Sp1,6] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,6] and TW_PU[Sp1,6] > TW_PU[Sp1,5] then 1 else 0
    # TW_Best?[Sp1,7] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,7] and TW_PU[Sp1,7] > TW_PU[Sp1,6] then 1 else 0
    # TW_Best?[Sp1,8] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,8] and TW_PU[Sp1,8] > TW_PU[Sp1,7] then 1 else 0
    # TW_Best?[Sp1,9] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] = TW_PU[Sp1,9] and TW_PU[Sp1,9] > TW_PU[Sp1,8] then 1 else 0
    # TW_Best?[Sp1,10] = if TW_MaxUptPot[Sp1]>0 and TW_MaxUptPot[Sp1] > TW_PU[Sp1,9]  then 1 else 0
    # TW_Best?[Sp2,1] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,1] then 1 else 0
    # TW_Best?[Sp2,2] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,2] and TW_PU[Sp2,2] > TW_PU[Sp2,1] then 1 else 0
    # TW_Best?[Sp2,3] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,3] and TW_PU[Sp2,3] > TW_PU[Sp2,2] then 1 else 0
    # TW_Best?[Sp2,4] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,4] and TW_PU[Sp2,4] > TW_PU[Sp2,3] then 1 else 0
    # TW_Best?[Sp2,5] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,5] and TW_PU[Sp2,5] > TW_PU[Sp2,4] then 1 else 0
    # TW_Best?[Sp2,6] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,6] and TW_PU[Sp2,6] > TW_PU[Sp2,5] then 1 else 0
    # TW_Best?[Sp2,7] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,7] and TW_PU[Sp2,7] > TW_PU[Sp2,6] then 1 else 0
    # TW_Best?[Sp2,8] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,8] and TW_PU[Sp2,8] > TW_PU[Sp2,7] then 1 else 0
    # TW_Best?[Sp2,9] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] = TW_PU[Sp2,9] and TW_PU[Sp2,9] > TW_PU[Sp2,8] then 1 else 0
    # TW_Best?[Sp2,10] = if TW_MaxUptPot[Sp2]>0 and TW_MaxUptPot[Sp2] > TW_PU[Sp2,9]  then 1 else 0
    # TW_Best?[Sp3,1] = if TW_MaxUptPot[Sp3] > 0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,1] then 1 else 0
    # TW_Best?[Sp3,2] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,2] and TW_PU[Sp3,2] > TW_PU[Sp3,1] then 1 else 0
    # TW_Best?[Sp3,3] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,3] and TW_PU[Sp3,3] > TW_PU[Sp3,2] then 1 else 0
    # TW_Best?[Sp3,4] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,4] and TW_PU[Sp3,4] > TW_PU[Sp3,3] then 1 else 0
    # TW_Best?[Sp3,5] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,5] and TW_PU[Sp3,5] > TW_PU[Sp3,4] then 1 else 0
    # TW_Best?[Sp3,6] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,6] and TW_PU[Sp3,6] > TW_PU[Sp3,5] then 1 else 0
    # TW_Best?[Sp3,7] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,7] and TW_PU[Sp3,7] > TW_PU[Sp3,6] then 1 else 0
    # TW_Best?[Sp3,8] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,8] and TW_PU[Sp3,8] > TW_PU[Sp3,7] then 1 else 0
    # TW_Best?[Sp3,9] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] = TW_PU[Sp3,9] and TW_PU[Sp3,9] > TW_PU[Sp3,8] then 1 else 0
    # TW_Best?[Sp3,10] = if TW_MaxUptPot[Sp3]>0 and TW_MaxUptPot[Sp3] > TW_PU[Sp3,9]  then 1 else 0
    
    treebuf_df$TW_PU_before <- 0
    treebuf_df[treebuf_df$buf_id %in% c(2:10), ]$TW_PU_before <- treebuf_df[treebuf_df$buf_id %in% c(1:9), ]$TW_PU
    treebuf_df$TW_Best_is <- ifelse(
      treebuf_df$TW_MaxUptPot > 0 &
        treebuf_df$TW_MaxUptPot == treebuf_df$TW_PU &
        treebuf_df$TW_PU > treebuf_df$TW_PU_before,
      1,
      0
    )
    tb1 <- treebuf_df[treebuf_df$buf_id == 1, ]
    tb10 <- treebuf_df[treebuf_df$buf_id == 10, ]
    treebuf_df[treebuf_df$buf_id == 1, ]$TW_Best_is <- ifelse(tb1$TW_MaxUptPot > 0 &
                                                                tb1$TW_MaxUptPot == tb1$TW_PU, 1, 0)
    treebuf_df[treebuf_df$buf_id == 10, ]$TW_Best_is <- ifelse(tb10$TW_MaxUptPot > 0 &
                                                                 tb10$TW_MaxUptPot > tb10$TW_PU_before,
                                                               1,
                                                               0)
    
    
    # TW_PotBest[Tree] = TW_Best?[Tree,1]*TW_PotRange[Tree,1]+
    #   TW_Best?[Tree,2]*TW_PotRange[Tree,2]+
    #   TW_Best?[Tree,3]*TW_PotRange[Tree,3]+
    #   TW_Best?[Tree,4]*TW_PotRange[Tree,4]+
    #   TW_Best?[Tree,5]*TW_PotRange[Tree,5]+
    #   TW_Best?[Tree,6]*TW_PotRange[Tree,6]+
    #   TW_Best?[Tree,7]*TW_PotRange[Tree,7]+
    #   TW_Best?[Tree,8]*TW_PotRange[Tree,8]+
    #   TW_Best?[Tree,9]*TW_PotRange[Tree,9]+
    #   TW_Best?[Tree,10]*TW_PotRange[Tree,10]
    treebuf_df$TW_PotRange_sum <- treebuf_df$TW_Best_is * treebuf_df$TW_PotRange
    tree_df$TW_PotBest <- aggregate(list(x = treebuf_df$TW_PotRange_sum), treebuf_df["tree_id"], sum)$x
    
    # TW_DemandRedFac[Tree] = IF(TW_PotSuctHalf[Tree]<>0) and (TW_PotBest[Tree]<>0 and (1+((TW_PotBest[Tree])/TW_PotSuctHalf[Tree])^TW_m[Tree])<>0)
    # THEN(1/(1+((TW_PotBest[Tree])/TW_PotSuctHalf[Tree])^TW_m[Tree]))ELSE(0)
    tree_df$TW_DemandRedFac <- ifelse(
      tree_df$TW_PotSuctHalf != 0 &
        tree_df$TW_PotBest != 0 &
        (
          1 + (tree_df$TW_PotBest / tree_df$TW_PotSuctHalf)^tree_df$TW_m
        ) != 0,
      1 / (1 + ((tree_df$TW_PotBest) / tree_df$TW_PotSuctHalf
      )^tree_df$TW_m),
      0
    )
    
    
    # TW_HEqFactor[Tree] = T_RootConductivity[Tree]*PI*RT_TDiam[Tree]*(0.5+0.5*TW_DemandRedFac[Tree])*100
    tree_df$TW_HEqFactor <- tree_df$T_RootConductivity * pi * tree_df$RT_TDiam *
      (0.5 + 0.5 * tree_df$TW_DemandRedFac) * 100
    
    
    zonelayertree_df$TW_HEqFactor <- rep(tree_df$TW_HEqFactor, each = nzone *
                                           nlayer)
    
    # TW_HEgrad1[Zone,Tree] = if (TW_EqTheta1[Zone,Tree]-W_Theta1[Zone]) <> 0 then
    # (TW_PStem[Tree]-W_PTheta1[Zone])/(TW_EqTheta1[Zone,Tree]-W_Theta1[Zone]) else 1
    # TW_HEgrad2[Zone,Tree] = if (TW_EqTheta2[Zone,Tree]-W_Theta2[Zone]) <> 0 then
    # (TW_PStem[Tree]-W_PTheta2[Zone])/(TW_EqTheta2[Zone,Tree]-W_Theta2[Zone]) else 1
    # TW_HEgrad3[Zone,Tree] = if (TW_EqTheta3[Zone,Tree]-W_Theta3[Zone]) <> 0 then
    # (TW_PStem[Tree]-W_PTheta3[Zone])/(TW_EqTheta3[Zone,Tree]-W_Theta3[Zone]) else 1
    # TW_HEgrad4[Zone,Tree] = if (TW_EqTheta4[Zone,Tree]-W_Theta4[Zone]) <> 0 then
    # (TW_PStem[Tree]-W_PTheta4[Zone])/(TW_EqTheta4[Zone,Tree]-W_Theta4[Zone]) else 1
    zonelayertree_df$W_Theta <- rep(zonelayer_df$W_Theta, ntree)
    
    zonelayertree_df$TW_HEgrad <- ifelse(
      (zonelayertree_df$TW_EqTheta - zonelayertree_df$W_Theta) != 0,
      (zonelayertree_df$TW_PStem - zonelayertree_df$W_PTheta) / (zonelayertree_df$TW_EqTheta - zonelayertree_df$W_Theta),
      1
    )
    
    
    
    # TW_PotDelta1[Zone,Tree] = (TW_EqTheta1[Zone,Tree]-W_Theta1[Zone])*min(W_TCW_Constant, RT_TLrv1[Zone,Tree]*TW_HEqFactor[Tree]*TW_HEgrad1[Zone,Tree])
    # TW_PotDelta2[Zone,Tree] = (TW_EqTheta2[Zone,Tree]-W_Theta2[Zone])*min(W_TCW_Constant, RT_TLrv2[Zone,Tree]*TW_HEqFactor[Tree]*TW_HEgrad2[Zone,Tree])
    # TW_PotDelta3[Zone,Tree] = (TW_EqTheta3[Zone,Tree]-W_Theta3[Zone])*min(W_TCW_Constant, RT_TLrv3[Zone,Tree]*TW_HEqFactor[Tree]*TW_HEgrad3[Zone,Tree])
    # TW_PotDelta4[Zone,Tree] = (TW_EqTheta4[Zone,Tree]-W_Theta4[Zone])*min(W_TCW_Constant, RT_TLrv4[Zone,Tree]*TW_HEqFactor[Tree]*TW_HEgrad4[Zone,Tree])
    zonelayertree_df$TW_PotDelta <- (zonelayertree_df$TW_EqTheta - zonelayertree_df$W_Theta) *
      pmin(
        W_TCW_Constant,
        zonelayertree_df$RT_TLrv * zonelayertree_df$TW_HEqFactor * zonelayertree_df$TW_HEgrad
      )
    
    # TW_PotFlux1[Zone,Tree] = TW_PotDelta1[Zone,Tree]*AF_DepthAct1[Zone]*1000*AF_ZoneFrac[Zone]
    # TW_PotFlux2[Zone,Tree] = TW_PotDelta2[Zone,Tree]*AF_Depth2[Zone]*1000*AF_ZoneFrac[Zone]
    # TW_PotFlux3[Zone,Tree] = TW_PotDelta3[Zone,Tree]*AF_Depth3[Zone]*1000*AF_ZoneFrac[Zone]
    # TW_PotFlux4[Zone,Tree] = TW_PotDelta4[Zone,Tree]*AF_Depth4[Zone]*1000*AF_ZoneFrac[Zone]
    
    zonelayertree_df$TW_PotFlux <- zonelayertree_df$TW_PotDelta * zonelayertree_df$AF_Depth * 1000 * zonelayertree_df$AF_ZoneFrac
    
    # TW_PotFluxSum[Tree] = ARRAYSUM(TW_PotFlux1[*,Tree])+ARRAYSUM(TW_PotFlux2[*,Tree])+ARRAYSUM(TW_PotFlux3[*,Tree])+ARRAYSUM(TW_PotFlux4[*,Tree])
    tree_df$TW_PotFluxSum <- aggregate(list(x = zonelayertree_df$TW_PotFlux),
                                       zonelayertree_df["tree_id"],
                                       sum)$x
    
    # TW_PotFluxSumAbs1[Zone,Tree] = ABS(TW_PotFlux1[Zone,Tree])
    # TW_PotFluxSumAbs2[Zone,Tree] = ABS(TW_PotFlux2[Zone,Tree])
    # TW_PotFluxSumAbs3[Zone,Tree] = ABS(TW_PotFlux3[Zone,Tree])
    # TW_PotFluxSumAbs4[Zone,Tree] = ABS(TW_PotFlux4[Zone,Tree])
    # TW_PotFluxSumAbs[Tree] = ARRAYSUM(TW_PotFluxSumAbs1[*,Tree])+ARRAYSUM(TW_PotFluxSumAbs2[*,Tree])+ARRAYSUM(TW_PotFluxSumAbs3[*,Tree])+ARRAYSUM(TW_PotFluxSumAbs4[*,Tree])
    tree_df$TW_PotFluxSumAbs <- aggregate(list(x = abs(zonelayertree_df$TW_PotFlux)), zonelayertree_df["tree_id"], sum)$x
    
    # TW_PotFluxPos[Tree] = 0.5*(TW_PotFluxSum[Tree]+TW_PotFluxSumAbs[Tree])
    tree_df$TW_PotFluxPos <- 0.5 * (tree_df$TW_PotFluxSum + tree_df$TW_PotFluxSumAbs)
    
    # TW_PotFluxNeg[Tree] =  0.5*(TW_PotFluxSumAbs[Tree]-TW_PotFluxSum[Tree])
    tree_df$TW_PotFluxNeg <-  0.5 * (tree_df$TW_PotFluxSumAbs - tree_df$TW_PotFluxSum)
    
    # TW_ScalingFacPosFluxes[Tree] = if TW_PotFluxPos[Tree]> 0 then if TW_PotFluxPos[Tree] > TW_PotFluxNeg[Tree] then
    # TW_PotFluxNeg[Tree] /( TW_PotFluxPos[Tree] ) else 1 else 0
    tree_df$TW_ScalingFacPosFluxes <- ifelse(
      tree_df$TW_PotFluxPos > 0,
      ifelse(
        tree_df$TW_PotFluxPos > tree_df$TW_PotFluxNeg,
        tree_df$TW_PotFluxNeg / (tree_df$TW_PotFluxPos),
        1
      ),
      0
    )
    # TW_ScalingFacNegFluxes[Tree] = if TW_PotFluxNeg[Tree]> 0 then if TW_PotFluxNeg[Tree] > TW_PotFluxPos[Tree] then
    # TW_PotFluxPos[Tree] /( TW_PotFluxNeg[Tree] ) else 1 else 0
    
    tree_df$TW_ScalingFacNegFluxes <- ifelse(
      tree_df$TW_PotFluxNeg > 0,
      ifelse(
        tree_df$TW_PotFluxNeg > tree_df$TW_PotFluxPos,
        tree_df$TW_PotFluxPos / tree_df$TW_PotFluxNeg,
        1
      ),
      0
    )
    
    
    zonelayertree_df$TW_ScalingFacPosFluxes <- rep(tree_df$TW_ScalingFacPosFluxes, each = nzone *
                                                     nlayer)
    zonelayertree_df$TW_ScalingFacNegFluxes <- rep(tree_df$TW_ScalingFacNegFluxes, each = nzone *
                                                     nlayer)
    
    # TW_HydFluxTot1[Zone,Tree] = if TW_PotFlux1[Zone,Tree] > 0 then TW_PotFlux1[Zone,Tree]*TW_ScalingFacPosFluxes[Tree] else TW_PotFlux1[Zone,Tree]*TW_ScalingFacNegFluxes[Tree]
    # TW_HydFluxTot2[Zone,Tree] = if TW_PotFlux2[Zone,Tree] > 0 then TW_PotFlux2[Zone,Tree]*TW_ScalingFacPosFluxes[Tree] else TW_PotFlux2[Zone,Tree]*TW_ScalingFacNegFluxes[Tree]
    # TW_HydFluxTot3[Zone,Tree] = if TW_PotFlux3[Zone,Tree] > 0 then TW_PotFlux3[Zone,Tree]*TW_ScalingFacPosFluxes[Tree] else TW_PotFlux3[Zone,Tree]*TW_ScalingFacNegFluxes[Tree]
    # TW_HydFluxTot4[Zone,Tree] = if TW_PotFlux4[Zone,Tree] > 0 then TW_PotFlux4[Zone,Tree]*TW_ScalingFacPosFluxes[Tree] else TW_PotFlux4[Zone,Tree]*TW_ScalingFacNegFluxes[Tree]
    
    zonelayertree_df$TW_HydFluxTot <- ifelse(
      zonelayertree_df$TW_PotFlux > 0,
      zonelayertree_df$TW_PotFlux * zonelayertree_df$TW_ScalingFacPosFluxes,
      zonelayertree_df$TW_PotFlux * zonelayertree_df$TW_ScalingFacNegFluxes
    )
    
    # TW_HydFlux1[Zone,Tree] = TW_HydFluxTot1[Zone,Tree]/AF_ZoneFrac[Zone]
    # TW_HydFlux2[Zone,Tree] = TW_HydFluxTot2[Zone,Tree]/AF_ZoneFrac[Zone]
    # TW_HydFlux3[Zone,Tree] = TW_HydFluxTot3[Zone,Tree]/AF_ZoneFrac[Zone]
    # TW_HydFlux4[Zone,Tree] = TW_HydFluxTot4[Zone,Tree]/AF_ZoneFrac[Zone]
    zonelayertree_df$TW_HydFlux <- zonelayertree_df$TW_HydFluxTot / zonelayertree_df$AF_ZoneFrac
    
    
    # CW_Conduct1[Zone] = AF_DepthAct1[Zone]*RT_CLrv1[Zone]
    # CW_Conduct2[Zone] = AF_Depth2[Zone]*RT_CLrv2[Zone]
    # CW_Conduct3[Zone] = AF_Depth3[Zone]*RT_CLrv3[Zone]
    # CW_Conduct4[Zone] = AF_Depth4[Zone]*RT_CLrv4[Zone]
    zonelayer_df$CW_Conduct <- zonelayer_df$AF_Depth * zonelayer_df$RT_CLrv
    
    # CW_ConductSum[Zone] = CW_Conduct1[Zone]+CW_Conduct2[Zone]+CW_Conduct3[Zone]+CW_Conduct4[Zone]
    zone_df$CW_ConductSum <- aggregate(list(x = zonelayer_df$CW_Conduct), zonelayer_df["zone"], sum)$x
    
    # CW_PStem1[Zone] = CW_Conduct1[Zone]*W_PTheta1[Zone]
    # CW_PStem2[Zone] = CW_Conduct2[Zone]*W_PTheta2[Zone]
    # CW_PStem3[Zone] = CW_Conduct3[Zone]*W_PTheta3[Zone]
    # CW_PStem4[Zone] = CW_Conduct4[Zone]*W_PTheta4[Zone]
    # CW_PStemSum[Zone] = CW_PStem1[Zone]+CW_PStem2[Zone]+CW_PStem3[Zone]+CW_PStem4[Zone]
    
    zonelayer_df$CW_PStem_zl <- zonelayer_df$CW_Conduct * zonelayer_df$W_PTheta
    zone_df$CW_PStemSum <- aggregate(list(x = zonelayer_df$CW_PStem_zl), zonelayer_df["zone"], sum)$x
    
    # CW_PStem[Zone] = If CW_ConductSum[Zone] <> 0 then CW_PStemSum[Zone]/CW_ConductSum[Zone] else 10
    zone_df$CW_PStem <- ifelse(zone_df$CW_ConductSum != 0,
                               zone_df$CW_PStemSum / zone_df$CW_ConductSum,
                               10)
    zonelayer_df$CW_PStem <- rep(zone_df$CW_PStem, nlayer)
    
    zonelayer_df$W_ThetaSat <- rep(layer_df$W_ThetaSat, each = nzone)
    zonelayer_df$W_Alpha <- rep(layer_df$W_Alpha, each = nzone)
    zonelayer_df$W_n <- rep(layer_df$W_n, each = nzone)
    
    # CW_EqTheta1[Zone] = W_ThetaSat1/(1+(ABS(W_Alpha1*CW_PStem[Zone]))^W_n1)^(1-1/W_n1)
    # CW_EqTheta2[Zone] = W_ThetaSat2/(1+(ABS(W_Alpha2*CW_PStem[Zone]))^W_n2)^(1-1/W_n2)
    # CW_EqTheta3[Zone] = W_ThetaSat3/(1+(ABS(W_Alpha3*CW_PStem[Zone]))^W_n3)^(1-1/W_n3)
    # CW_EqTheta4[Zone] = W_ThetaSat4/(1+(ABS(W_Alpha4*CW_PStem[Zone]))^W_n4)^(1-1/W_n4)
    zonelayer_df$CW_EqTheta <- zonelayer_df$W_ThetaSat / (1 + (abs(
      zonelayer_df$W_Alpha * zonelayer_df$CW_PStem
    ))^zonelayer_df$W_n)^(1 - 1 / zonelayer_df$W_n)
    
    # CW_HEGrad1[Zone] = if (CW_EqTheta1[Zone]-W_Theta1[Zone]) <> 0 then (CW_PStem[Zone]-W_PTheta1[Zone])/(CW_EqTheta1[Zone]-W_Theta1[Zone]) else 1
    # CW_HEGrad2[Zone] = if (CW_EqTheta2[Zone]-W_Theta2[Zone]) <> 0 then (CW_PStem[Zone]-W_PTheta2[Zone])/(CW_EqTheta2[Zone]-W_Theta2[Zone]) else 1
    # CW_HEGrad3[Zone] = if (CW_EqTheta3[Zone]-W_Theta3[Zone]) <> 0 then (CW_PStem[Zone]-W_PTheta3[Zone])/(CW_EqTheta3[Zone]-W_Theta3[Zone]) else 1
    # CW_HEGrad4[Zone] = if (CW_EqTheta4[Zone]-W_Theta4[Zone]) <> 0 then (CW_PStem[Zone]-W_PTheta4[Zone])/(CW_EqTheta4[Zone]-W_Theta4[Zone]) else 1
    
    zonelayer_df$CW_HEGrad <- ifelse((zonelayer_df$CW_EqTheta - zonelayer_df$W_Theta) != 0,
                                     (zonelayer_df$CW_PStem - zonelayer_df$W_PTheta) / (zonelayer_df$CW_EqTheta -
                                                                                          zonelayer_df$W_Theta),
                                     1
    )
    
    
    # RT_CAmount1[Zone] = AF_DepthAct1[Zone]*RT_CLrv1[Zone]*100
    # RT_CAmount2[Zone] = AF_Depth2[Zone]*RT_CLrv2[Zone]*100
    # RT_CAmount3[Zone] = AF_Depth3[Zone]*RT_CLrv3[Zone]*100
    # RT_CAmount4[Zone] = AF_Depth4[Zone]*RT_CLrv4[Zone]*100
    # RT_CAmount[Zone] = RT_CAmount1[Zone]+RT_CAmount2[Zone]+RT_CAmount3[Zone]+RT_CAmount4[Zone]
    
    zonelayer_df$RT_CAmount <- zonelayer_df$AF_Depth * zonelayer_df$RT_CLrv *
      100
    zone_df$RT_CAmount <- aggregate(list(x = zonelayer_df$RT_CAmount), zonelayer_df["zone"], sum)$x
    
    zonebuf_df$RT_CAmount <- rep(zone_df$RT_CAmount, nrow(buf_df))
    
    # CW_PotSuctHalf[Zone] = -((CQ_PotSuctAlphMaxCurr[Zone]*CQ_PotSuctAlphMinCurr[Zone])^0.5)
    zone_df$CW_PotSuctHalf <- -((
      zone_df$CQ_PotSuctAlphMaxCurr * zone_df$CQ_PotSuctAlphMinCurr
    )^0.5)
    
    zonelayer_df$RT_CLrv_depth <- zonelayer_df$AF_Depth * zonelayer_df$RT_CLrv
    zonelayerbuf_df$RT_CLrv_depth <- rep(zonelayer_df$RT_CLrv_depth, nrow(buf_df))
    zonelayerbuf_df$W_PTheta <- rep(zonelayer_df$W_PTheta, nrow(buf_df))
    
    zonebuf_df$CW_DryFactRangeInit <- rep(buf_df$CW_DryFactRangeInit, each = nzone)
    zonebuf_df$CW_DryFactRangePower <- rep(zone_df$CW_DryFactRangePower, nrow(buf_df))
    zonebuf_df$TW_RangeToppingUp <- rep(buf_df$TW_RangeToppingUp, each = nzone)
    
    # CW_DrySoilFact[BufValues,Zone] = max(min(CW_DryFactRangeInit[BufValues]^CW_DryFactRangePower[Zone],CW_DryPowerMax),CW_DryPowerMin)
    zonebuf_df$CW_DrySoilFact <- pmax(
      pmin(
        zonebuf_df$CW_DryFactRangeInit^zonebuf_df$CW_DryFactRangePower,
        CW_DryPowerMax
      ),
      CW_DryPowerMin
    )
    
    zl1b <- zonelayerbuf_df[zonelayerbuf_df$layer == 1, c("RT_CLrv_depth", "W_PTheta")]
    zl2b <- zonelayerbuf_df[zonelayerbuf_df$layer == 2, c("RT_CLrv_depth", "W_PTheta")]
    zl3b <- zonelayerbuf_df[zonelayerbuf_df$layer == 3, c("RT_CLrv_depth", "W_PTheta")]
    zl4b <- zonelayerbuf_df[zonelayerbuf_df$layer == 4, c("RT_CLrv_depth", "W_PTheta")]
    
    # CW_PotSoil[Zone,BufValues] = if AF_DepthAct1[Zone]*RT_CLrv1[Zone] > 0 then -TW_RangeToppingUp[BufValues]*((0.01*RT_CAmount[Zone]/(AF_DepthAct1[Zone]*RT_CLrv1[Zone]/ABS(W_PTheta1[Zone])^CW_DrySoilFact[BufValues,Zone]+AF_Depth2[Zone]*RT_CLrv2[Zone]/ABS(W_PTheta2[Zone])^CW_DrySoilFact[BufValues,Zone]+AF_Depth3[Zone]*RT_CLrv3[Zone]/ABS(W_PTheta3[Zone])^CW_DrySoilFact[BufValues,Zone]+AF_Depth4[Zone]*RT_CLrv4[Zone]/ABS(W_PTheta4[Zone])^CW_DrySoilFact[BufValues,Zone]))^(1/CW_DrySoilFact[BufValues,Zone])) else W_PTheta1[Zone]
    zonebuf_df$CW_PotSoil <- ifelse(zl1b$RT_CLrv_depth > 0,
                                    -zonebuf_df$TW_RangeToppingUp * ((
                                      0.01 * zonebuf_df$RT_CAmount /
                                        (
                                          zl1b$RT_CLrv_depth / abs(zl1b$W_PTheta)^zonebuf_df$CW_DrySoilFact +
                                            zl2b$RT_CLrv_depth /
                                            abs(zl2b$W_PTheta)^zonebuf_df$CW_DrySoilFact +
                                            zl3b$RT_CLrv_depth /
                                            abs(zl3b$W_PTheta)^zonebuf_df$CW_DrySoilFact +
                                            zl4b$RT_CLrv_depth /
                                            abs(zl4b$W_PTheta)^zonebuf_df$CW_DrySoilFact
                                        )
                                    )^(1 / zonebuf_df$CW_DrySoilFact)
                                    ),
                                    zl1b$W_PTheta)
    
    
    # LIGHT_CCap1[Zone] = IF(LIGHT_TCCap1[Zone]>0)THEN(LIGHT_TCCap1[Zone]*(CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L1])/(T_klight[Sp1]*LIGHT_LAIT1[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT1[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT1[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L1]+LIGHT_kTB[Sp1]*LIGHT_TBAI1[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI1[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI1[Zone,Sp3]))ELSE(0)
    # LIGHT_CCap2[Zone] = IF(LIGHT_TCCap2[Zone]>0)THEN(LIGHT_TCCap2[Zone]*(CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L2])/(T_klight[Sp1]*LIGHT_LAIT2[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT2[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT2[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L2]+LIGHT_kTB[Sp1]*LIGHT_TBAI2[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI2[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI2[Zone,Sp3]))ELSE(0)
    # LIGHT_CCap3[Zone] = IF(LIGHT_TCCap3[Zone]>0)THEN(LIGHT_TCCap3[Zone]*CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L3]/(T_klight[Sp1]*LIGHT_LAIT3[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT3[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT3[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L3]+LIGHT_kTB[Sp1]*LIGHT_TBAI3[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI3[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI3[Zone,Sp3]))ELSE(0)
    # LIGHT_CCap4[Zone] = IF(LIGHT_TCCap4[Zone]>0)THEN(LIGHT_TCCap4[Zone]*CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L4]/(T_klight[Sp1]*LIGHT_LAIT4[Zone,Sp1]+T_klight[Sp2]*LIGHT_LAIT4[Zone,Sp2]+T_klight[Sp3]*LIGHT_LAIT4[Zone,Sp3]+CQ_kLightCurr[Zone]*LIGHT_LAIC[Zone,L4]+LIGHT_kTB[Sp1]*LIGHT_TBAI4[Zone,Sp1]+LIGHT_kTB[Sp2]*LIGHT_TBAI4[Zone,Sp2]+LIGHT_kTB[Sp3]*LIGHT_TBAI4[Zone,Sp3]))ELSE(0)
    
    zonelayertree_df$LIGHT_CCap_a <- zonelayertree_df$T_klight * zonelayertree_df$LIGHT_LAIT
    zonelayertree_df$LIGHT_kTB <- rep(tree_df$LIGHT_kTB, each = nzone * nlayer)
    zonelayertree_df$LIGHT_CCap_b <- zonelayertree_df$LIGHT_kTB * zonelayertree_df$LIGHT_TBAI
    
    zonelayer_df <- cbind(zonelayer_df,
                          aggregate(zonelayertree_df[c("LIGHT_CCap_a", "LIGHT_CCap_b")], zonelayertree_df[c("zone", "layer")], sum)[c("LIGHT_CCap_a", "LIGHT_CCap_b")])
    
    zonelayer_df$LIGHT_CCap <- ifelse(zonelayer_df$LIGHT_TCCap > 0,
                                      (
                                        zonelayer_df$LIGHT_TCCap * (zonelayer_df$CQ_kLightCurr * zonelayer_df$LIGHT_LAIC) / (
                                          zonelayertree_df$LIGHT_CCap_a + zonelayertree_df$LIGHT_CCap_b +
                                            zonelayer_df$CQ_kLightCurr * zonelayer_df$LIGHT_LAIC
                                        )
                                      ),
                                      0)
    
    
    zone_df$LIGHT_CCap_sum <- aggregate(list(x = zonelayer_df$LIGHT_CCap), zonelayer_df["zone"], sum)$x
    
    zone_df$LightSwitch <- LightSwitch
    
    # LIGHT_CRelCap[Zone] = if LightSwitch = 1 or LightSwitch = 2 then (LIGHT_CCap1[Zone]+LIGHT_CCap2[Zone]+LIGHT_CCap3[Zone]+LIGHT_CCap4[Zone])*RelLightCapPerZone[Zone] else (LIGHT_CCap1[Zone]+LIGHT_CCap2[Zone]+LIGHT_CCap3[Zone]+LIGHT_CCap4[Zone])
    zone_df$LIGHT_CRelCap <- ifelse(
      zone_df$LightSwitch == 1 | zone_df$LightSwitch == 2,
      zone_df$LIGHT_CCap_sum * zone_df$RelLightCapPerZone,
      zone_df$LIGHT_CCap_sum
    )
    
    
    # EVAP_CropWatDem[Zone] = EVAP_EpotDemandNotMetBy_CanInterc*LIGHT_CRelCap[Zone]
    zone_df$EVAP_CropWatDem <- EVAP_EpotDemandNotMetBy_CanInterc * zone_df$LIGHT_CRelCap
    
    
    # S&B_SlashYear[Sp1] = GRAPH( S&B_PastSlashEvents[Sp1])
    # S&B_SlashYear[Sp2] = GRAPH( S&B_PastSlashEvents[Sp2])
    # S&B_SlashYear[Sp3] = GRAPH( S&B_PastSlashEvents[Sp3])
    tree_df$SB_SlashYear <- c(
      get_y_df(tree_df[tree_df$tree_id == 1, "SB_PastSlashEvents"], "SB_SlashYear_Sp1"),
      get_y_df(tree_df[tree_df$tree_id == 2, "SB_PastSlashEvents"], "SB_SlashYear_Sp2"),
      get_y_df(tree_df[tree_df$tree_id == 3, "SB_PastSlashEvents"], "SB_SlashYear_Sp3")
    )
    
    
    # S&B_SlashDOY[Sp1] = GRAPH(S&B_PastSlashEvents[Sp1])
    # S&B_SlashDOY[Sp2] = GRAPH(S&B_PastSlashEvents[Sp2])
    # S&B_SlashDOY[Sp3] = GRAPH(S&B_PastSlashEvents[Sp3])
    tree_df$SB_SlashDOY <- c(
      get_y_df(tree_df[tree_df$tree_id == 1, "SB_PastSlashEvents"], "SB_SlashDOY_Sp1"),
      get_y_df(tree_df[tree_df$tree_id == 2, "SB_PastSlashEvents"], "SB_SlashDOY_Sp2"),
      get_y_df(tree_df[tree_df$tree_id == 3, "SB_PastSlashEvents"], "SB_SlashDOY_Sp3")
    )
    
    
    # S&B_SlashTime[Tree] = S&B_SlashDOY[Tree] + 365* (S&B_SlashYear[Tree])-CA_DOYStart
    tree_df$SB_SlashTime <- tree_df$SB_SlashDOY + 365 * (tree_df$SB_SlashYear) -
      CA_DOYStart
    
    # S&B_FireTime? = if (time > S&B_SlashTime[Sp1]+S&B_MinDryingPer and time < S&B_SlashTime[Sp1]+S&B_MaxDryingPer) or (time > S&B_SlashTime[Sp2]+S&B_MinDryingPer and time < S&B_SlashTime[Sp2]+S&B_MaxDryingPer) or (time > S&B_SlashTime[Sp3]+S&B_MinDryingPer and time < S&B_SlashTime[Sp3]+S&B_MaxDryingPer) then 1 else 0
    SB_FireTime_is = ifelse(
      (
        time > tree_df$SB_SlashTime[1] + SB_MinDryingPer &
          time < tree_df$SB_SlashTime[1] + SB_MaxDryingPer
      ) |
        (
          time > tree_df$SB_SlashTime[2] + SB_MinDryingPer &
            time < tree_df$SB_SlashTime[2] + SB_MaxDryingPer
        ) |
        (
          time > tree_df$SB_SlashTime[3] + SB_MinDryingPer &
            time < tree_df$SB_SlashTime[3] + SB_MaxDryingPer
        ),
      1,
      0
    )
    
    zone_df$SB_SlashMoist <- ifelse(
      zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_FineNecromass"] > 0,
      zone_df$EVAP_SlashWater / zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_FineNecromass"],
      0
    )
    
    
    # S&B_IsSlashDry?[Zone] = if S&B_FineNecromass[Zone,DW] > 0 then if (S&B_FineNecromass[Zone,DW]*S&B_SlashMoist[Zone]+RAIN_CanopyWater[Zone]) /S&B_FineNecromass[Zone,DW] < S&B_CritMoist  then 1 else 0 else 0
    zone_df$SB_IsSlashDry_is <- ifelse(
      zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_FineNecromass"] > 0,
      ifelse((
        zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_FineNecromass"] * zone_df$SB_SlashMoist + zone_df$RAIN_CanopyWater
      ) /
        zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_FineNecromass"] < SB_CritMoist,
      1,
      0
      ),
      0
    )
    
    # S&B_Fire? = if S&B_FireTime? = 1 and ARRAYMEAN(S&B_IsSlashDry?[*]) = 1 then 1 else 0
    SB_Fire_is <- ifelse(SB_FireTime_is == 1 &
                           sum(zone_df$SB_IsSlashDry_is) == 1, 1, 0)
    
    zone_df$CA_PlantDoY <- get_val_by_CA_ComplCrop(CA_PlantDoY_df, zone_df$CA_ComplCrop, zone_df$zone)
    zone_df$CA_PlantYear <- get_val_by_CA_ComplCrop(CA_PlantYear_df, zone_df$CA_ComplCrop, zone_df$zone)
    #
    # zone_df$CA_PlantDoY <- NA
    # for (i in c(1:nzone)) {
    #   x <- zone_df[zone_df$zone == i, ]$CA_ComplCrop
    #   zone_df[zone_df$zone == i, ]$CA_PlantDoY <- get_graph_y(
    #     CA_PlantDoY_df,
    #     x = x,
    #     x_column = "CA_ComplCrop",
    #     y_column = names(CA_PlantDoY_df)[i],
    #     mode = "continues"
    #   )
    # }
    #
    # zone_df$CA_PlantYear <- NA
    # for (i in c(1:nzone)) {
    #   x <- zone_df[zone_df$zone == i, ]$CA_ComplCrop
    #   zone_df[zone_df$zone == i, ]$CA_PlantYear <- get_graph_y(
    #     CA_PlantYear_df,
    #     x = x,
    #     x_column = "CA_ComplCrop",
    #     y_column = names(CA_PlantYear_df)[i],
    #     mode = "continues"
    #   )
    # }
    
    # CA_PlantTime[Zone] = CA_PlantDoY[Zone] + 365* (CA_PlantYear[Zone])-CA_DOYStart
    zone_df$CA_PlantTime <- zone_df$CA_PlantDoY + 365 * (zone_df$CA_PlantYear) -
      CA_DOYStart
    
    
    # C_PlantDiesToday?[Zone] = if CQ_Stage[Zone]>=2 and CQ_StageAfterHarvest[Zone] = 0 or time = int(S&B_SlashTime[Sp1]) or time = int(S&B_SlashTime[Sp2]) or time = int(S&B_SlashTime[Sp3]) or  time = int(CA_PlantTime[Zone])  or S&B_Fire? = 1 or C_GroRes[Zone,DW] = 0 then 1 else 0
    zone_df$time <- time
    zone_df$C_PlantDiesToday_is <- ifelse(
      zone_df$CQ_Stage >= 2 &
        zone_df$CQ_StageAfterHarvest == 0 |
        zone_df$time == floor(tree_df$SB_SlashTime[1]) |
        zone_df$time == floor(tree_df$SB_SlashTime[2]) |
        zone_df$time == floor(tree_df$SB_SlashTime[3]) |
        zone_df$time == floor(zone_df$CA_PlantTime)  |
        SB_Fire_is == 1 |
        zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_GroRes"] == 0,
      1,
      0
    )
    
    # C_BiomCan[Zone,PlantComp] = C_BiomStLv[Zone,PlantComp]+C_YieldCurr[Zone,PlantComp]+C_GroRes[Zone,PlantComp]
    zonepcomp_df$C_BiomCan <-  zonepcomp_df$C_BiomStLv + zonepcomp_df$C_YieldCurr + zonepcomp_df$C_GroRes
    
    
    zonenut_df$CQ_ClosedCanCurr <- rep(zone_df$CQ_ClosedCanCurr, nrow(nut_df))
    zonenut_df$C_BiomCan_DW <- rep(zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomCan"], nrow(nut_df))
    zonenut_df$C_Root_DW_zone <- rep(zone_df$C_Root_DW_zone, nrow(nut_df))
    
    # C_NTarget[Zone,SlNut] = (MIN(C_BiomCan[Zone,DW],CQ_ClosedCanCurr[Zone])*CQ_NConcYoungCurr[Zone,SlNut]+MAX((C_BiomCan[Zone,DW]-CQ_ClosedCanCurr[Zone]),0)*CQ_NConcOldCurr[Zone,SlNut]+ARRAYSUM(C_Root_DW[Zone,*])*CQ_NConcOldCurr[Zone,SlNut])*1000
    zonenut_df$C_NTarget <- (
      pmin(zonenut_df$C_BiomCan_DW, zonenut_df$CQ_ClosedCanCurr) * zonenut_df$CQ_NConcYoungCurr +
        pmax((zonenut_df$C_BiomCan_DW - zonenut_df$CQ_ClosedCanCurr),
             0
        ) * zonenut_df$CQ_NConcOldCurr +
        zonenut_df$C_Root_DW_zone * zonenut_df$CQ_NConcOldCurr
    ) * 1000
    
    # C_RootPlComp[Zn1,DW] = ARRAYSUM(C_Root_DW[Zn1,*])+0*ARRAYSUM(C_Root_N[Zn1,*])+0*ARRAYSUM(C_Root_P[Zn1,*])
    # C_RootPlComp[Zn1,N] = 0*ARRAYSUM(C_Root_DW[Zn1,*])+ARRAYSUM(C_Root_N[Zn1,*])+0*ARRAYSUM(C_Root_P[Zn1,*])
    # C_RootPlComp[Zn1,P] = 0*ARRAYSUM(C_Root_DW[Zn1,*])+0*ARRAYSUM(C_Root_N[Zn1,*])+ARRAYSUM(C_Root_P[Zn1,*])
    # C_RootPlComp[Zn2,DW] = ARRAYSUM(C_Root_DW[Zn2,*])+0*ARRAYSUM(C_Root_N[Zn2,*])+0*ARRAYSUM(C_Root_P[Zn2,*])
    # C_RootPlComp[Zn2,N] = 0*ARRAYSUM(C_Root_DW[Zn2,*])+ARRAYSUM(C_Root_N[Zn2,*])+0*ARRAYSUM(C_Root_P[Zn2,*])
    # C_RootPlComp[Zn2,P] = 0*ARRAYSUM(C_Root_DW[Zn2,*])+0*ARRAYSUM(C_Root_N[Zn2,*])+ARRAYSUM(C_Root_P[Zn2,*])
    # C_RootPlComp[Zn3,DW] = ARRAYSUM(C_Root_DW[Zn3,*])+0*ARRAYSUM(C_Root_N[Zn3,*])+0*ARRAYSUM(C_Root_P[Zn3,*])
    # C_RootPlComp[Zn3,N] = 0*ARRAYSUM(C_Root_DW[Zn3,*])+ARRAYSUM(C_Root_N[Zn3,*])+0*ARRAYSUM(C_Root_P[Zn3,*])
    # C_RootPlComp[Zn3,P] = 0*ARRAYSUM(C_Root_DW[Zn3,*])+0*ARRAYSUM(C_Root_N[Zn3,*])+ARRAYSUM(C_Root_P[Zn3,*])
    # C_RootPlComp[Zn4,DW] = ARRAYSUM(C_Root_DW[Zn4,*])+0*ARRAYSUM(C_Root_N[Zn4,*])+0*ARRAYSUM(C_Root_P[Zn4,*])
    # C_RootPlComp[Zn4,N] = 0*ARRAYSUM(C_Root_DW[Zn4,*])+ARRAYSUM(C_Root_N[Zn4,*])+0*ARRAYSUM(C_Root_P[Zn4,*])
    # C_RootPlComp[Zn4,P] = 0*ARRAYSUM(C_Root_DW[Zn4,*])+0*ARRAYSUM(C_Root_N[Zn4,*])+ARRAYSUM(C_Root_P[Zn4,*])
    zonepcomp_df$C_RootPlComp <- aggregate(zonelayerpcomp_df["C_Root"], zonelayerpcomp_df[c("zone", "PlantComp")], sum)$C_Root
    
    # C_Biom[Zone,PlantComp] = C_RootPlComp[Zone,PlantComp]+C_BiomCan[Zone,PlantComp]
    zonepcomp_df$C_Biom <- zonepcomp_df$C_RootPlComp + zonepcomp_df$C_BiomCan
    
    # C_NBiom[Zn1,N] = C_Biom[Zn1,N]
    # C_NBiom[Zn1,P] = C_Biom[Zn1,P]
    # C_NBiom[Zn2,N] = C_Biom[Zn2,N]
    # C_NBiom[Zn2,P] = C_Biom[Zn2,P]
    # C_NBiom[Zn3,N] = C_Biom[Zn3,N]
    # C_NBiom[Zn3,P] = C_Biom[Zn3,P]
    # C_NBiom[Zn4,N] = C_Biom[Zn4,N]
    # C_NBiom[Zn4,P] = C_Biom[Zn4,P]
    zonenut_df$C_NBiom <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_Biom"]
    
    zonenut_df$AF_RunNutLim_is <- rep(nut_df$AF_RunNutLim_is, each = nzone)
    # C_NPosgro[Zone,SlNut] = if AF_RunNutLim?[SlNut]> 0.5 and (C_NTarget[Zone,SlNut]-.4) >0 then MAX(0,MIN(1,(2*(C_NBiom[Zone,SlNut]/ C_NTarget[Zone,SlNut]-.4)))) else 1
    zonenut_df$C_NPosgro <- ifelse(zonenut_df$AF_RunNutLim_is > 0.5 &
                                     (zonenut_df$C_NTarget - .4) > 0,
                                   pmax(0, pmin(1, (
                                     2 * (zonenut_df$C_NBiom / zonenut_df$C_NTarget - .4)
                                   ))),
                                   1)
    
    z_dw <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", ]
    
    # C_BiomforResp[Zone] = C_GroRes[Zone,DW]*C_RelRespGroRes+C_BiomStLv[Zone,DW]*C_RelRespStLv+C_YieldCurr[Zone,DW]*C_RelRespYieldCurr+C_RootPlComp[Zone,DW]*C_RelRespRt
    zone_df$C_BiomforResp <- z_dw$C_GroRes * C_RelRespGroRes +
      z_dw$C_BiomStLv * C_RelRespStLv +
      z_dw$C_YieldCurr * C_RelRespYieldCurr +
      z_dw$C_RootPlComp * C_RelRespRt
    
    # TEMP_SoilDailyData = GRAPH(RAIN_DoY)
    TEMP_SoilDailyData <- get_y_df(RAIN_DoY, "TEMP_SoilDailyData")
    
    # TEMP_MonthAvg = GRAPH(RAIN_DoY)
    TEMP_MonthAvg <- get_y_df(RAIN_DoY, "TEMP_MonthAvg")
    
    # Temp[Zone,SoilLayer] = IF(TEMP_AType=1)THEN(TEMP_Cons)ELSE(IF(TEMP_AType=3)THEN(TEMP_SoilDailyData)ELSE(TEMP_MonthAvg))
    zonelayer_df$Temp <- ifelse(
      TEMP_AType == 1,
      TEMP_Cons,
      ifelse(TEMP_AType == 3, TEMP_SoilDailyData, TEMP_MonthAvg)
    )
    
    # C_RespTemp[Zone] = GRAPH(Temp[Zone,1])
    zone_df$C_RespTemp <- get_y_df(zonelayer_df[zonelayer_df$layer == 1, "Temp"], "C_RespTemp")
    
    
    # C_MaintResp[Zone] = C_BiomforResp[Zone]*C_RespperBiom*C_RespTemp[Zone]
    zone_df$C_MaintResp <- zone_df$C_BiomforResp * C_RespperBiom * zone_df$C_RespTemp
    
    # C_PotGroRed[Zone] = if C_PlantDiesToday?[Zone] = 0 then min(1,min(C_NPosgro[Zone,P],C_NPosgro[Zone,N])*LIGHT_CRelCap[Zone]/CQ_RelLightMaxCurr[Zone])
    # *CQ_CRelLUECurr[Zone] *( CQ_GroMaxCurr[Zone]+C_ApplyMaintResp?*C_MaintResp[Zone])/(1-CQ_CRtAllocCurr[Zone]) else 0
    zone_df$C_NPosgro_N <- zonenut_df[zonenut_df$SlNut == "N", "C_NPosgro"]
    zone_df$C_NPosgro_P <- zonenut_df[zonenut_df$SlNut == "P", "C_NPosgro"]
    
    zone_df$C_PotGroRed <- ifelse(
      zone_df$C_PlantDiesToday_is == 0,
      pmin(
        1,
        pmin(zone_df$C_NPosgro_P, zone_df$C_NPosgro_N) * zone_df$LIGHT_CRelCap / zone_df$CQ_RelLightMaxCurr
      )
      * zone_df$CQ_CRelLUECurr * (
        zone_df$CQ_GroMaxCurr + C_ApplyMaintResp_is * zone_df$C_MaintResp
      ) / (1 - zone_df$CQ_CRtAllocCurr),
      0
    )
    
    
    # CW_DemandPot[Zone] = if CW_EnergyDrivenEpot? = 1 then EVAP_CropWatDem[Zone] else C_PotGroRed[Zone]*CQ_TranspRatioCurr[Zone]
    zone_df$CW_DemandPot <- ifelse(
      CW_EnergyDrivenEpot_is == 1,
      zone_df$EVAP_CropWatDem,
      zone_df$C_PotGroRed * zone_df$CQ_TranspRatioCurr
    )
    
    # CW_PotRadial[Zone] = if RT_CAmount[Zone]>0 then -CW_DemandPot[Zone]*0.1/(CQ_ConductivityCurr[Zone]*(RT_CAmount[Zone])) else -16000
    zone_df$CW_PotRadial <- ifelse(
      zone_df$RT_CAmount > 0,
      -zone_df$CW_DemandPot * 0.1 / (zone_df$CQ_ConductivityCurr * zone_df$RT_CAmount),
      -16000
    )
    
    zonebuf_df$CW_PotRadial <- rep(zone_df$CW_PotRadial, nrow(buf_df))
    
    # CW_PotRange[Zone,BufValues] = IF(RT_CAmount[Zone]>0)THEN CW_PotSoil[Zone,BufValues]+CW_PotRadial[Zone]  ELSE -10
    zonebuf_df$CW_PotRange <- ifelse(zonebuf_df$RT_CAmount > 0,
                                     zonebuf_df$CW_PotSoil + zonebuf_df$CW_PotRadial,
                                     -10)
    zonebuf_df$CW_PotSuctHalf <- rep(zone_df$CW_PotSuctHalf, nrow(buf_df))
    
    # CW_m[Zone] = 2*LOGN(CW_Alpha/(1-CW_Alpha))/LOGN(CQ_PotSuctAlphMaxCurr[Zone]/CQ_PotSuctAlphMinCurr[Zone])
    zone_df$CW_m <- 2 * log(CW_Alpha / (1 - CW_Alpha)) /
      log(zone_df$CQ_PotSuctAlphMaxCurr / zone_df$CQ_PotSuctAlphMinCurr)
    
    zonebuf_df$CW_m <- rep(zone_df$CW_m, nrow(buf_df))
    zonebuf_df$TW_DemActSubtract <- rep(buf_df$TW_DemActSubtract, each = nzone)
    
    # CW_DemRedFacRange[Zone,BufValues] = IF CW_PotSuctHalf[Zone] <>0 and (1+(MIN(0,CW_PotRange[Zone,BufValues])/CW_PotSuctHalf[Zone])^CW_m[Zone])<>0THEN (1/(1+(MIN(0,CW_PotRange[Zone,BufValues])/CW_PotSuctHalf[Zone])^CW_m[Zone])) - TW_DemActSubtract[BufValues]ELSE 0
    zonebuf_df$CW_DemRedFacRange <- ifelse(
      zonebuf_df$CW_PotSuctHalf  != 0 &
        (1 + (
          pmin(0, zonebuf_df$CW_PotRange) / zonebuf_df$CW_PotSuctHalf
        )^zonebuf_df$CW_m) != 0,
      (1 / (
        1 + (
          pmin(0, zonebuf_df$CW_PotRange) / zonebuf_df$CW_PotSuctHalf
        )^zonebuf_df$CW_m
      )) - zonebuf_df$TW_DemActSubtract,
      0
    )
    
    zonebuf_df$CW_DemandPot <- rep(zone_df$CW_DemandPot, nrow(buf_df))
    # CW_DemandActRange[Zone,BufValues] = CW_DemRedFacRange[Zone,BufValues]*CW_DemandPot[Zone]
    zonebuf_df$CW_DemandActRange <- zonebuf_df$CW_DemRedFacRange * zonebuf_df$CW_DemandPot
    
    # RT_RhoCL1[Zone] = if RT_CLrv1[Zone]> 0 then 1/(CQ_RtDiam[Zone]*.5*SQRT(PI*(RT_CLrv1[Zone]))) else RT_StopGap
    # RT_RhoCL2[Zone] = if RT_CLrv2[Zone]> 0 then 1/(CQ_RtDiam[Zone]*.5*SQRT(PI*(RT_CLrv2[Zone]))) else RT_StopGap
    # RT_RhoCL3[Zone] = if RT_CLrv3[Zone]> 0 then 1/(CQ_RtDiam[Zone]*.5*SQRT(PI*(RT_CLrv3[Zone]))) else RT_StopGap
    # RT_RhoCL4[Zone] = if RT_CLrv4[Zone]> 0 then 1/(CQ_RtDiam[Zone]*.5*SQRT(PI*(RT_CLrv4[Zone]))) else RT_StopGap
    zonelayer_df$RT_RhoCL <- ifelse(zonelayer_df$RT_CLrv > 0,
                                    1 / (zonelayer_df$CQ_RtDiam * .5 * sqrt(pi * (
                                      zonelayer_df$RT_CLrv
                                    ))),
                                    RT_StopGap)
    
    
    # RT_C_G1[Zone] = if RT_RhoCL1[Zone] <> RT_StopGap then (RT_RhoCL1[Zone]^2-1)/(0.5*(((1-(3*RT_RhoCL1[Zone]^2))/4)+((RT_RhoCL1[Zone]^4*LOGN(RT_RhoCL1[Zone]))/(RT_RhoCL1[Zone]^2-1)))) else 0
    # RT_C_G2[Zone] = if RT_RhoCL2[Zone] <> RT_StopGap then (RT_RhoCL2[Zone]^2-1)/(0.5*(((1-(3*RT_RhoCL2[Zone]^2))/4)+((RT_RhoCL2[Zone]^4*LOGN(RT_RhoCL2[Zone]))/(RT_RhoCL2[Zone]^2-1)))) else 0
    # RT_C_G3[Zone] = if RT_RhoCL3[Zone] <> RT_StopGap then (RT_RhoCL3[Zone]^2-1)/(0.5*(((1-(3*RT_RhoCL3[Zone]^2))/4)+((RT_RhoCL3[Zone]^4*LOGN(RT_RhoCL3[Zone]))/(RT_RhoCL3[Zone]^2-1)))) else 0
    # RT_C_G4[Zone] = if RT_RhoCL4[Zone] <> RT_StopGap then (RT_RhoCL4[Zone]^2-1)/(0.5*(((1-(3*RT_RhoCL4[Zone]^2))/4)+((RT_RhoCL4[Zone]^4*LOGN(RT_RhoCL4[Zone]))/(RT_RhoCL4[Zone]^2-1)))) else 0
    
    zonelayer_df$RT_C_G <- ifelse(zonelayer_df$RT_RhoCL != RT_StopGap,
                                  (zonelayer_df$RT_RhoCL^2 - 1) / (0.5 * (((
                                    1 - (3 * zonelayer_df$RT_RhoCL^2)
                                  ) / 4) +
                                    ((zonelayer_df$RT_RhoCL^4 *
                                        log(zonelayer_df$RT_RhoCL)) / (zonelayer_df$RT_RhoCL^2 - 1)
                                    ))),
                                  0)
    
    zonelayerbuf_df$RT_C_G <- rep(zonelayer_df$RT_C_G, nrow(buf_df))
    zonelayerbuf_df$W_Theta <- rep(zonelayer_df$W_Theta, nrow(buf_df))
    zonelayerbuf_df$W_ThetaSat <- rep(zonelayer_df$W_ThetaSat, nrow(buf_df))
    zonelayerbuf_df$W_Alpha <- rep(zonelayer_df$W_Alpha, nrow(buf_df))
    
    zonebuf_df$CW_PotRadial <- rep(zone_df$CW_PotRadial, nrow(buf_df))
    
    # zb_df <- zonebuf_df[c("zone", "buf_id", "CW_PotRange", "CW_DemRedFacRange")]
    # zlb_df <- zb_df[rep(seq_len(nrow(zb_df)), nlayer), ]
    # zlb_df$layer <- rep(layer_df$layer, each = nzone * nrow(buf_df))
    # zlb_df[order(zlb_df$buf_id, zlb_df$layer, zlb_df$zone),]
    # zonelayerbuf_df <- cbind(zonelayerbuf_df, zlb_df[c("CW_PotRange", "CW_DemRedFacRange")])
    
    # CW_PotActRange[Zone,BufValues] = CW_PotRange[Zone,BufValues] - (1-CW_DemRedFacRange[Zone,BufValues])*CW_PotRadial[Zone]
    zonebuf_df$CW_PotActRange <- zonebuf_df$CW_PotRange - (1 - zonebuf_df$CW_DemRedFacRange) * zonebuf_df$CW_PotRadial
    
    zb_df <- zonebuf_df[c("zone", "buf_id", "CW_PotActRange")]
    zlb_df <- zb_df[rep(seq_len(nrow(zb_df)), nlayer), ]
    zlb_df$layer <- rep(layer_df$layer, each = nzone * nrow(buf_df))
    zlb_df <- zlb_df[order(zlb_df$buf_id, zlb_df$layer, zlb_df$zone), ]
    zonelayerbuf_df$CW_PotActRange <- zlb_df$CW_PotActRange
    
    
    zonelayerbuf_df$W_n <- rep(zonelayer_df$W_n, nrow(buf_df))
    zonelayerbuf_df$AF_Depth <- rep(zonelayer_df$AF_Depth, nrow(buf_df))
    
    # CW_ThetaRange1[Zone,BufValues] = max(0,(W_Theta1[Zone]-(W_ThetaSat1/(1+abs(W_Alpha1*CW_PotActRange[Zone,BufValues])^W_n1)^(1-1/W_n1))))*AF_DepthAct1[Zone]*1000
    # CW_ThetaRange2[Zone,BufValues] = max(0,(W_Theta2[Zone]-(W_ThetaSat2/(1+abs(W_Alpha2*CW_PotActRange[Zone,BufValues])^W_n2)^(1-1/W_n2))))*AF_Depth2[Zone]*1000
    # CW_ThetaRange3[Zone,BufValues] = max(0,(W_Theta3[Zone]-(W_ThetaSat3/(1+abs(W_Alpha3*CW_PotActRange[Zone,BufValues])^W_n3)^(1-1/W_n3))))*AF_Depth3[Zone]*1000
    # CW_ThetaRange4[Zone,BufValues] = max(0,(W_Theta4[Zone]-(W_ThetaSat4/(1+abs(W_Alpha4*CW_PotActRange[Zone,BufValues])^W_n4)^(1-1/W_n4))))*AF_Depth4[Zone]*1000
    zonelayerbuf_df$CW_ThetaRange <- max(0, (
      zonelayerbuf_df$W_Theta - (
        zonelayerbuf_df$W_ThetaSat /
          (
            1 + abs(zonelayerbuf_df$W_Alpha * zonelayerbuf_df$CW_PotActRange)^zonelayerbuf_df$W_n
          )^(1 - 1 / zonelayerbuf_df$W_n)
      )
    )) * zonelayerbuf_df$AF_Depth * 1000
    
    # RT_C_RelImp_L1[Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv1[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv1[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv1[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv1[Zone,Sp3])  = 0 then 1 else
    #CW_DemandPerRoot[Zone]*RT_CLrv1[Zone]/(CW_DemandPerRoot[Zone]*RT_CLrv1[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv1[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv1[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv1[Zone,Sp3])
    # RT_C_RelImp_L2[Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv2[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv2[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv2[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv2[Zone,Sp3])  = 0 then 1 else
    #CW_DemandPerRoot[Zone]*RT_CLrv2[Zone]/(CW_DemandPerRoot[Zone]*RT_CLrv2[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv2[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv2[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv2[Zone,Sp3])
    # RT_C_RelImp_L3[Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv3[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv3[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv3[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv3[Zone,Sp3])  = 0 then 1 else
    #CW_DemandPerRoot[Zone]*RT_CLrv3[Zone]/(CW_DemandPerRoot[Zone]*RT_CLrv3[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv3[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv3[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv3[Zone,Sp3])
    # RT_C_RelImp_L4[Zone] = if (CW_DemandPerRoot[Zone]*RT_CLrv4[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv4[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv4[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv4[Zone,Sp3])  = 0 then 1 else
    #CW_DemandPerRoot[Zone]*RT_CLrv4[Zone]/(CW_DemandPerRoot[Zone]*RT_CLrv4[Zone]+TW_DemandPerRoot[Sp1]*RT_TLrv4[Zone,Sp1]+TW_DemandPerRoot[Sp2]*RT_TLrv4[Zone,Sp2]+TW_DemandPerRoot[Sp3]*RT_TLrv4[Zone,Sp3])
    
    # zonelayer_df$RT_T_RelImp_a <- zonelayer_df$CW_DemandPerRoot * zonelayer_df$RT_CLrv +
    #   zlt1$TW_DemandPerRoot * zlt1$RT_TLrv + zlt2$TW_DemandPerRoot * zlt2$RT_TLrv + zlt3$TW_DemandPerRoot * zlt3$RT_TLrv
    zonelayer_df$RT_C_RelImp_a <- zonelayer_df$RT_T_RelImp_a
    zonelayer_df$RT_C_RelImp <- ifelse(
      zonelayer_df$RT_C_RelImp_a  == 0,
      1,
      zonelayer_df$CW_DemandPerRoot * zonelayer_df$RT_CLrv / zonelayer_df$RT_C_RelImp_a
    )
    
    # CW_pF_range[Zone,BufValues] = IF(CW_PotActRange[Zone,BufValues]=0)THEN 0 else (LOG10(-MIN(-1,CW_PotActRange[Zone,BufValues])))
    zonebuf_df$CW_pF_range <- ifelse(zonebuf_df$CW_PotActRange == 0, 0, log10(-pmin(-1, zonebuf_df$CW_PotActRange)))
    
    # W_PhiPRhizRange[Zone,BufValues] = GRAPH(CW_pF_range[Zone,BufValues])
    zonebuf_df$W_PhiPRhizRange <- get_y_df(zonebuf_df$CW_pF_range, "W_PhiPRhizRange")
    
    zb_df <- zonebuf_df[c("zone", "buf_id", "W_PhiPRhizRange")]
    zlb_df <- zb_df[rep(seq_len(nrow(zb_df)), nlayer), ]
    zlb_df$layer <- rep(layer_df$layer, each = nzone * nrow(buf_df))
    zlb_df <- zlb_df[order(zlb_df$buf_id, zlb_df$layer, zlb_df$zone), ]
    zonelayerbuf_df$W_PhiPRhizRange <- zlb_df$W_PhiPRhizRange
    
    
    zonelayerbuf_df$W_PhiTheta <- rep(zonelayer_df$W_PhiTheta, nrow(buf_df))
    zonelayerbuf_df$RT_CLrv <- rep(zonelayer_df$RT_CLrv, nrow(buf_df))
    zonelayerbuf_df$RT_C_RelImp <- rep(zonelayer_df$RT_C_RelImp, nrow(buf_df))
    
    # CW_PU1[Zone,BufValues] = if RT_C_G1[Zone] = 0 then 0 else min(CW_ThetaRange1[Zone,BufValues],AF_DepthAct1[Zone]*RT_C_RelImp_L1[Zone]*10*PI*100*max(0,-W_PhiPRhizRange[Zone,BufValues]+W_PhiTheta1[Zone])*RT_CLrv1[Zone]*RT_C_G1[Zone])
    # CW_PU2[Zone,BufValues] = if RT_C_G2[Zone] = 0 then 0 else min(CW_ThetaRange2[Zone,BufValues],AF_Depth2[Zone]*RT_C_RelImp_L2[Zone]*10*PI*100*max(0,-W_PhiPRhizRange[Zone,BufValues]+W_PhiTheta2[Zone])*RT_CLrv2[Zone]*RT_C_G2[Zone])
    # CW_PU3[Zone,BufValues] =  if RT_C_G3[Zone] = 0 then 0 else min(CW_ThetaRange3[Zone,BufValues],AF_Depth3[Zone]*RT_C_RelImp_L3[Zone]*10*PI*100*max(0,-W_PhiPRhizRange[Zone,BufValues]+W_PhiTheta3[Zone])*RT_CLrv3[Zone]*RT_C_G3[Zone])
    # CW_PU4[Zone,BufValues] = if RT_C_G4[Zone] = 0 then 0 else min(CW_ThetaRange4[Zone,BufValues],AF_Depth4[Zone]*RT_C_RelImp_L4[Zone]*10*PI*100*max(0,-W_PhiPRhizRange[Zone,BufValues]+W_PhiTheta4[Zone])*RT_CLrv4[Zone]*RT_C_G4[Zone])
    
    zonelayerbuf_df$CW_PU <- ifelse(
      zonelayerbuf_df$RT_C_G == 0,
      0,
      pmin(
        zonelayerbuf_df$CW_ThetaRange,
        zonelayerbuf_df$AF_Depth * zonelayerbuf_df$RT_C_RelImp * 10 * pi * 100 *
          pmax(
            0,
            -zonelayerbuf_df$W_PhiPRhizRange + zonelayerbuf_df$W_PhiTheta
          ) * zonelayerbuf_df$RT_CLrv * zonelayerbuf_df$RT_C_G
      )
    )
    
    
    # CW_PU[Zone,BufValues] = CW_PU1[Zone,BufValues] + CW_PU2[Zone,BufValues]+ CW_PU3[Zone,BufValues]+CW_PU4[Zone,BufValues]
    zonebuf_df$CW_PU <- aggregate(zonelayerbuf_df["CW_PU"], zonelayerbuf_df[c("zone", "buf_id")], sum)$CW_PU
    
    # CW_PotUptRange[Zone,BufValues] = min(CW_DemandActRange[Zone,BufValues],CW_PU[Zone,BufValues])
    zonebuf_df$CW_PotUptRange <- pmin(zonebuf_df$CW_DemandActRange, zonebuf_df$CW_PU)
    
    zone_df$CW_PotUptRange_sum <- aggregate(zonebuf_df["CW_PotUptRange"], zonebuf_df[c("zone")], sum)$CW_PotUptRange
    zone_df$CW_PotUptRange_max <- aggregate(zonebuf_df["CW_PotUptRange"], zonebuf_df[c("zone")], max)$CW_PotUptRange
    
    # CW_MaxUptofRange[Zone] = if arraysum(CW_PotUptRange[Zone,*]) = 0 then 0 else max(CW_PotUptRange[Zone,1],CW_PotUptRange[Zone,2],CW_PotUptRange[Zone,3],CW_PotUptRange[Zone,4],CW_PotUptRange[Zone,5],CW_PotUptRange[Zone,6],CW_PotUptRange[Zone,7],CW_PotUptRange[Zone,8],CW_PotUptRange[Zone,9],CW_PotUptRange[Zone,10])
    zone_df$CW_MaxUptofRange <- ifelse(zone_df$CW_PotUptRange_sum == 0,
                                       0,
                                       zone_df$CW_PotUptRange_max)
    
    
    # CW_Best[Zn1,1] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,1] then 1 else 0
    # CW_Best[Zn1,2] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,2] and CW_PotUptRange[Zn1,2]>CW_PotUptRange[Zn1,1] then 1 else 0
    # CW_Best[Zn1,3] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,3]  and CW_PotUptRange[Zn1,3]>CW_PotUptRange[Zn1,2] then 1 else 0
    # CW_Best[Zn1,4] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,4]  and CW_PotUptRange[Zn1,4]>CW_PotUptRange[Zn1,3] then 1 else 0
    # CW_Best[Zn1,5] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,5]  and CW_PotUptRange[Zn1,5]>CW_PotUptRange[Zn1,4] then 1 else 0
    # CW_Best[Zn1,6] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,6] and CW_PotUptRange[Zn1,6]>CW_PotUptRange[Zn1,5] then 1 else 0
    # CW_Best[Zn1,7] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,7]  and CW_PotUptRange[Zn1,7]>CW_PotUptRange[Zn1,6] then 1 else 0
    # CW_Best[Zn1,8] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,8]  and CW_PotUptRange[Zn1,8]>CW_PotUptRange[Zn1,7] then 1 else 0
    # CW_Best[Zn1,9] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,9]  and CW_PotUptRange[Zn1,9]>CW_PotUptRange[Zn1,8] then 1 else 0
    # CW_Best[Zn1,10] = if CW_MaxUptofRange[Zn1]>0 and CW_MaxUptofRange[Zn1]=CW_PotUptRange[Zn1,10]  and CW_PotUptRange[Zn1,10]>CW_PotUptRange[Zn1,9] then 1 else 0
    # CW_Best[Zn2,1] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,1]  then 1 else 0
    # CW_Best[Zn2,2] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,2]  and CW_PotUptRange[Zn2,2]>CW_PotUptRange[Zn2,1] then 1 else 0
    # CW_Best[Zn2,3] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,3]  and CW_PotUptRange[Zn2,3]>CW_PotUptRange[Zn2,2] then 1 else 0
    # CW_Best[Zn2,4] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,4]  and CW_PotUptRange[Zn2,4]>CW_PotUptRange[Zn2,3] then 1 else 0
    # CW_Best[Zn2,5] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,5]  and CW_PotUptRange[Zn2,5]>CW_PotUptRange[Zn2,4] then 1 else 0
    # CW_Best[Zn2,6] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,6]  and CW_PotUptRange[Zn2,6]>CW_PotUptRange[Zn2,5] then 1 else 0
    # CW_Best[Zn2,7] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,7]  and CW_PotUptRange[Zn2,7]>CW_PotUptRange[Zn2,6] then 1 else 0
    # CW_Best[Zn2,8] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,8]  and CW_PotUptRange[Zn2,8]>CW_PotUptRange[Zn2,7] then 1 else 0
    # CW_Best[Zn2,9] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,9]  and CW_PotUptRange[Zn2,9]>CW_PotUptRange[Zn2,8] then 1 else 0
    # CW_Best[Zn2,10] = if CW_MaxUptofRange[Zn2]>0 and CW_MaxUptofRange[Zn2]=CW_PotUptRange[Zn2,10]  and CW_PotUptRange[Zn2,10]>CW_PotUptRange[Zn2,9] then 1 else 0
    # CW_Best[Zn3,1] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,1] then 1 else 0
    # CW_Best[Zn3,2] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,2]   and CW_PotUptRange[Zn3,2]>CW_PotUptRange[Zn3,1] then 1 else 0
    # CW_Best[Zn3,3] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,3]   and CW_PotUptRange[Zn3,3]>CW_PotUptRange[Zn3,2] then 1 else 0
    # CW_Best[Zn3,4] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,4]   and CW_PotUptRange[Zn3,4]>CW_PotUptRange[Zn3,3] then 1 else 0
    # CW_Best[Zn3,5] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,5]   and CW_PotUptRange[Zn3,5]>CW_PotUptRange[Zn3,4] then 1 else 0
    # CW_Best[Zn3,6] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,6]   and CW_PotUptRange[Zn3,6]>CW_PotUptRange[Zn3,5] then 1 else 0
    # CW_Best[Zn3,7] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,7]   and CW_PotUptRange[Zn3,7]>CW_PotUptRange[Zn3,6] then 1 else 0
    # CW_Best[Zn3,8] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,8]  and CW_PotUptRange[Zn3,8]>CW_PotUptRange[Zn3,7]  then 1 else 0
    # CW_Best[Zn3,9] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,9]   and CW_PotUptRange[Zn3,9]>CW_PotUptRange[Zn3,8] then 1 else 0
    # CW_Best[Zn3,10] = if CW_MaxUptofRange[Zn3]>0 and CW_MaxUptofRange[Zn3]=CW_PotUptRange[Zn3,10]   and CW_PotUptRange[Zn3,10]>CW_PotUptRange[Zn3,9] then 1 else 0
    # CW_Best[Zn4,1] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,1] then 1 else 0
    # CW_Best[Zn4,2] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,2]   and CW_PotUptRange[Zn4,2]>CW_PotUptRange[Zn4,1] then 1 else 0
    # CW_Best[Zn4,3] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,3]   and CW_PotUptRange[Zn4,3]>CW_PotUptRange[Zn4,2] then 1 else 0
    # CW_Best[Zn4,4] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,4]   and CW_PotUptRange[Zn4,4]>CW_PotUptRange[Zn4,3] then 1 else 0
    # CW_Best[Zn4,5] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,5]  and CW_PotUptRange[Zn4,5]>CW_PotUptRange[Zn4,4] then 1 else 0
    # CW_Best[Zn4,6] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,6]   and CW_PotUptRange[Zn4,6]>CW_PotUptRange[Zn4,5] then 1 else 0
    # CW_Best[Zn4,7] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,7]  and CW_PotUptRange[Zn4,7]>CW_PotUptRange[Zn4,6]  then 1 else 0
    # CW_Best[Zn4,8] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,8] and CW_PotUptRange[Zn4,8]>CW_PotUptRange[Zn4,7] then 1 else 0
    # CW_Best[Zn4,9] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,9]  and CW_PotUptRange[Zn4,9]>CW_PotUptRange[Zn4,8] then 1 else 0
    # CW_Best[Zn4,10] = if CW_MaxUptofRange[Zn4]>0 and CW_MaxUptofRange[Zn4]=CW_PotUptRange[Zn4,10]   and CW_PotUptRange[Zn4,10]>CW_PotUptRange[Zn4,9] then 1 else 0
    
    zonebuf_df$CW_PotUptRange_before <- NA
    zonebuf_df[zonebuf_df$buf_id %in% 2:10, "CW_PotUptRange_before"] <- zonebuf_df[zonebuf_df$buf_id %in% 1:9, "CW_PotUptRange"]
    
    zonebuf_df$CW_MaxUptofRange <- rep(zone_df$CW_MaxUptofRange, nrow(buf_df))
    zonebuf_df$CW_Best <- ifelse(
      zonebuf_df$CW_MaxUptofRange > 0 &
        zonebuf_df$CW_MaxUptofRange == zonebuf_df$CW_PotUptRange &
        zonebuf_df$CW_PotUptRange > zonebuf_df$CW_PotUptRange_before,
      1,
      0
    )
    zb1 <- zonebuf_df[zonebuf_df$buf_id == 1, ]
    zonebuf_df[zonebuf_df$buf_id == 1, "CW_Best"] <- ifelse(zb1$CW_MaxUptofRange >
                                                             0 &
                                                             zb1$CW_MaxUptofRange == zb1$CW_PotUptRange,
                                                           1,
                                                           0)
    
    # CW_PotSoilbest[Zone] = CW_Best[Zone,1]*CW_PotSoil[Zone,1]+
    #   CW_Best[Zone,2]*CW_PotSoil[Zone,2]+
    #   CW_Best[Zone,3]*CW_PotSoil[Zone,3]+
    #   CW_Best[Zone,4]*CW_PotSoil[Zone,4]+
    #   CW_Best[Zone,5]*CW_PotSoil[Zone,5]+
    #   CW_Best[Zone,6]*CW_PotSoil[Zone,6]+
    #   CW_Best[Zone,7]*CW_PotSoil[Zone,7]+
    #   CW_Best[Zone,8]*CW_PotSoil[Zone,8]+
    #   CW_Best[Zone,9]*CW_PotSoil[Zone,9]+
    #   CW_Best[Zone,10]*CW_PotSoil[Zone,10]
    
    zonebuf_df$CW_PotSoilbest_a <- zonebuf_df$CW_Best * zonebuf_df$CW_PotSoil
    zone_df$CW_PotSoilbest <- aggregate(zonebuf_df["CW_PotSoilbest_a"], zonebuf_df["zone"], sum)$CW_PotSoilbest_a
    
    
    # CW_Pot[Zone] = IF(RT_CAmount[Zone]>0)THEN CW_PotSoilbest[Zone]+  CW_PotRadial[Zone] ELSE(CQ_PotSuctAlphMinCurr[Zone])
    zone_df$CW_Pot <- ifelse(
      zone_df$RT_CAmount > 0,
      zone_df$CW_PotSoilbest +  zone_df$CW_PotRadial,
      zone_df$CQ_PotSuctAlphMinCurr
    )
    
    
    # CW_DemandRedFac[Zone] = IF(CW_PotSuctHalf[Zone]<CW_Pot[Zone]*0.00001) and (1+(CW_Pot[Zone]/CW_PotSuctHalf[Zone])^CW_m[Zone])<>0THEN (1/(1+(CW_Pot[Zone]/CW_PotSuctHalf[Zone])^CW_m[Zone])) ELSE 0
    zone_df$CW_DemandRedFac <- ifelse((zone_df$CW_PotSuctHalf < zone_df$CW_Pot *
                                         0.00001) &
                                        (1 + (
                                          zone_df$CW_Pot / zone_df$CW_PotSuctHalf
                                        )^zone_df$CW_m) != 0,
                                      1 / (1 + (
                                        zone_df$CW_Pot / zone_df$CW_PotSuctHalf
                                      )^zone_df$CW_m),
                                      0
    )
    
    # CW_HEqFactor[Zone] = CQ_ConductivityCurr[Zone]*PI*CQ_RtDiam[Zone]*(0.5+0.5*CW_DemandRedFac[Zone])*10
    zone_df$CW_HEqFactor <- zone_df$CQ_ConductivityCurr * pi * zone_df$CQ_RtDiam *
      (0.5 + 0.5 * zone_df$CW_DemandRedFac) * 10
    
    # CW_EqTheta1[Zone] = W_ThetaSat1/(1+(ABS(W_Alpha1*CW_PStem[Zone]))^W_n1)^(1-1/W_n1)
    # CW_EqTheta2[Zone] = W_ThetaSat2/(1+(ABS(W_Alpha2*CW_PStem[Zone]))^W_n2)^(1-1/W_n2)
    # CW_EqTheta3[Zone] = W_ThetaSat3/(1+(ABS(W_Alpha3*CW_PStem[Zone]))^W_n3)^(1-1/W_n3)
    # CW_EqTheta4[Zone] = W_ThetaSat4/(1+(ABS(W_Alpha4*CW_PStem[Zone]))^W_n4)^(1-1/W_n4)
    
    zonelayer_df$CW_EqTheta <- zonelayer_df$W_ThetaSat / (1 + (abs(
      zonelayer_df$W_Alpha * zonelayer_df$CW_PStem
    ))^zonelayer_df$W_n)^(1 - 1 / zonelayer_df$W_n)
    
    
    # P_PrevCropOK? = if P_UseCropStopRule? = 1 then P_FlagPrevCropOK? else 1
    P_PrevCropOK_is <- ifelse(P_UseCropStopRule_is == 1, P_FlagPrevCropOK_is, 1)
    zonelayer_df$P_PrevCropOK_is <- P_PrevCropOK_is
    
    # C_GrowsToday? = if AF_Crop? = 0 then 0 else 1
    zonelayer_df$C_GrowsToday_is <- AF_Crop_is
    
    # CW_PotDelta1[Zone] = IF TIME=(int(CA_PlantTime[Zone])) and C_GrowsToday? = 1 and  P_PrevCropOK? = 1 then(CW_EqTheta1[Zone]-W_Theta1[Zone])*min(W_TCW_Constant, RT_CLrv1[Zone]*CW_HEqFactor[Zone]*CW_HEGrad1[Zone]) else 0
    # CW_PotDelta2[Zone] = IF TIME=(int(CA_PlantTime[Zone])) and C_GrowsToday? = 1 and  P_PrevCropOK? = 1 then(CW_EqTheta2[Zone]-W_Theta2[Zone])*min(W_TCW_Constant, RT_CLrv2[Zone]*CW_HEqFactor[Zone]*CW_HEGrad2[Zone]) else 0
    # CW_PotDelta3[Zone] = IF TIME=(int(CA_PlantTime[Zone])) and C_GrowsToday? = 1 and  P_PrevCropOK? = 1 then(CW_EqTheta3[Zone]-W_Theta3[Zone])*min(W_TCW_Constant, RT_CLrv3[Zone]*CW_HEqFactor[Zone]*CW_HEGrad3[Zone]) else 0
    # CW_PotDelta4[Zone] = IF TIME=(int(CA_PlantTime[Zone])) and C_GrowsToday? = 1 and  P_PrevCropOK? = 1 then(CW_EqTheta4[Zone]-W_Theta4[Zone])*min(W_TCW_Constant, RT_CLrv4[Zone]*CW_HEqFactor[Zone]*CW_HEGrad4[Zone]) else 0
    
    zonelayer_df$CW_HEqFactor <- rep(zone_df$CW_HEqFactor, nlayer)
    zonelayer_df$CA_PlantTime <- rep(zone_df$CA_PlantTime, nlayer)
    zonelayer_df$time <- time
    
    zonelayer_df$CW_PotDelta <- ifelse(
      zonelayer_df$time == (floor(zonelayer_df$CA_PlantTime)) &
        zonelayer_df$C_GrowsToday_is == 1 &
        zonelayer_df$P_PrevCropOK_is == 1,
      (zonelayer_df$CW_EqTheta - zonelayer_df$W_Theta) *
        pmin(
          W_TCW_Constant,
          zonelayer_df$RT_CLrv * zonelayer_df$CW_HEqFactor * zonelayer_df$CW_HEGrad
        ),
      0
    )
    
    # CW_PotFlux1[Zone] = CW_PotDelta1[Zone]*AF_DepthAct1[Zone]*1000
    # CW_PotFlux2[Zone] = CW_PotDelta2[Zone]*AF_Depth2[Zone]*1000
    # CW_PotFlux3[Zone] = CW_PotDelta3[Zone]*AF_Depth3[Zone]*1000
    # CW_PotFlux4[Zone] = CW_PotDelta4[Zone]*AF_Depth4[Zone]*1000
    zonelayer_df$CW_PotFlux <- zonelayer_df$CW_PotDelta * zonelayer_df$AF_Depth *
      1000
    
    # CW_PotFluxSumAbs1[Zone] = ABS(CW_PotFlux1[Zone])
    # CW_PotFluxSumAbs2[Zone] = ABS(CW_PotFlux2[Zone])
    # CW_PotFluxSumAbs3[Zone] = ABS(CW_PotFlux3[Zone])
    # CW_PotFluxSumAbs4[Zone] = ABS(CW_PotFlux4[Zone])
    zonelayer_df$CW_PotFluxSumAbs <- abs(zonelayer_df$CW_PotFlux)
    
    # CW_PotFluxSumAbs[Zone] = CW_PotFluxSumAbs1[Zone]+CW_PotFluxSumAbs2[Zone]+CW_PotFluxSumAbs3[Zone]+CW_PotFluxSumAbs4[Zone]
    zone_df$CW_PotFluxSumAbs <- aggregate(zonelayer_df["CW_PotFluxSumAbs"], zonelayer_df["zone"], sum)$CW_PotFluxSumAbs
    
    # CW_PotFluxSum[Zone] = CW_PotFlux1[Zone]+CW_PotFlux2[Zone]+CW_PotFlux3[Zone]+CW_PotFlux4[Zone]
    zone_df$CW_PotFluxSum <- aggregate(zonelayer_df["CW_PotFlux"], zonelayer_df["zone"], sum)$CW_PotFlux
    
    # CW_PotFluxNeg[Zone] = 0.5*(CW_PotFluxSumAbs[Zone]-CW_PotFluxSum[Zone])
    zone_df$CW_PotFluxNeg <- 0.5 * (zone_df$CW_PotFluxSumAbs - zone_df$CW_PotFluxSum)
    
    # CW_PotFluxPos[Zone] = 0.5*(CW_PotFluxSumAbs[Zone]+CW_PotFluxSum[Zone])
    zone_df$CW_PotFluxPos <- 0.5 * (zone_df$CW_PotFluxSumAbs + zone_df$CW_PotFluxSum)
    
    # CW_ScalingFacPos[Zone] = if CW_PotFluxPos[Zone]> 0 then if CW_PotFluxPos[Zone] > CW_PotFluxNeg[Zone]then CW_PotFluxNeg[Zone]/( CW_PotFluxPos[Zone]) else 1 else 0
    zone_df$CW_ScalingFacPos <- ifelse(
      zone_df$CW_PotFluxPos > 0,
      ifelse(
        zone_df$CW_PotFluxPos > zone_df$CW_PotFluxNeg,
        zone_df$CW_PotFluxNeg / zone_df$CW_PotFluxPos,
        1
      ),
      0
    )
    
    # CW_ScalingFacNeg[Zone] = if CW_PotFluxNeg[Zone]> 0 then if CW_PotFluxNeg[Zone] > CW_PotFluxPos[Zone]then CW_PotFluxPos[Zone]/( CW_PotFluxNeg[Zone]) else 1 else 0
    zone_df$CW_ScalingFacNeg <- ifelse(
      zone_df$CW_PotFluxNeg > 0,
      ifelse(
        zone_df$CW_PotFluxNeg > zone_df$CW_PotFluxPos,
        zone_df$CW_PotFluxPos / zone_df$CW_PotFluxNeg,
        1
      ),
      0
    )
    
    zonelayer_df$CW_ScalingFacPos <- rep(zone_df$CW_ScalingFacPos, nlayer)
    zonelayer_df$CW_ScalingFacNeg <- rep(zone_df$CW_ScalingFacNeg, nlayer)
    # CW_HydFlux1[Zone] = if CW_PotFlux1[Zone]> 0 then CW_ScalingFacPos[Zone]*CW_PotFlux1[Zone] else CW_ScalingFacNeg[Zone]*CW_PotFlux1[Zone]
    # CW_HydFlux2[Zone] = if CW_PotFlux2[Zone]> 0 then CW_ScalingFacPos[Zone]*CW_PotFlux2[Zone] else CW_ScalingFacNeg[Zone]*CW_PotFlux2[Zone]
    # CW_HydFlux3[Zone] = if CW_PotFlux3[Zone]> 0 then CW_ScalingFacPos[Zone]*CW_PotFlux3[Zone] else CW_ScalingFacNeg[Zone]*CW_PotFlux3[Zone]
    # CW_HydFlux4[Zone] = if CW_PotFlux4[Zone]> 0 then CW_ScalingFacPos[Zone]*CW_PotFlux4[Zone] else CW_ScalingFacNeg[Zone]*CW_PotFlux4[Zone]
    zonelayer_df$CW_HydFlux <- ifelse(
      zonelayer_df$CW_PotFlux > 0,
      zonelayer_df$CW_ScalingFacPos * zonelayer_df$CW_PotFlux,
      zonelayer_df$CW_ScalingFacNeg * zonelayer_df$CW_PotFlux
    )
    
    # W_HydEquil1[Zone] = (ARRAYSUM(TW_HydFlux1[Zone,*])+CW_HydFlux1[Zone])
    # W_HydEquil2[Zone] = (ARRAYSUM(TW_HydFlux2[Zone,*])+CW_HydFlux2[Zone])
    # W_HydEquil3[Zone] = (ARRAYSUM(TW_HydFlux3[Zone,*])+CW_HydFlux3[Zone])
    # W_HydEquil4[Zone] = (ARRAYSUM(TW_HydFlux4[Zone,*])+CW_HydFlux4[Zone])
    
    zonelayer_df$TW_HydFlux_sum  <- aggregate(zonelayertree_df["TW_HydFlux"], zonelayertree_df[c("zone", "layer")], sum)$TW_HydFlux
    zonelayer_df$W_HydEquil <- zonelayer_df$TW_HydFlux_sum + zonelayer_df$CW_HydFlux
    
    # W_Seep12[Zone] = If W_WatDef1[Zone]<0 then 0 else 0.01*W_SeepScalar*W_Stock1[Zone]*W_PhiTheta1[Zone]/AF_DepthAct1[Zone]
    # W_Seep23[Zone] = If W_WatDef2[Zone]<0 then 0 else 0.01*W_SeepScalar*W_Stock2[Zone]*W_PhiTheta2[Zone]/AF_Depth2[Zone]
    # W_Seep34[Zone] = If W_WatDef3[Zone]<0 then 0 else 0.01*W_SeepScalar*W_Stock3[Zone]*W_PhiTheta3[Zone]/AF_Depth3[Zone]
    # W_Seep4Out[Zone] = If W_WatDef4[Zone]<0 then 0 else 0.01*W_SeepScalar*W_Stock4[Zone]*W_PhiTheta4[Zone]/AF_Depth4[Zone]
    
    zonelayer_df$W_Seep <- ifelse(
      zonelayer_df$W_WatDef < 0,
      0,
      0.01 * W_SeepScalar * zonelayer_df$W_Stock * zonelayer_df$W_PhiTheta /
        zonelayer_df$AF_Depth
    )
    
    
    
    zonelayer_df$W_Seep_before <- 0
    zonelayer_df[zonelayer_df$layer %in% 2:4, "W_Seep_before"] <- zonelayer_df[zonelayer_df$layer %in% 1:3, "W_Seep"]
    
    # W_NetSeep1[Zone] = W_Seep12[Zone]
    # W_NetSeep2[Zone] = -W_Seep12[Zone]+W_Seep23[Zone]
    # W_NetSeep3[Zone] = -W_Seep23[Zone]+W_Seep34[Zone]
    # W_NetSeep4[Zone] = -W_Seep34[Zone]+W_Seep4Out[Zone]
    zonelayer_df$W_NetSeep <- zonelayer_df$W_Seep - zonelayer_df$W_Seep_before
    
    # W_In1[Zone] = W_LatRecharge1[Zone]+RAIN_Infiltr[Zone]-W_V1Drain[Zone]+W_HydEquil1[Zone]-W_Seep12[Zone]
    # W_In2[Zone] = W_V1Drain[Zone]-W_V2Drain[Zone]+W_LatRecharge2[Zone]+W_HydEquil2[Zone]-W_NetSeep2[Zone]
    # W_In3[Zone] = W_V2Drain[Zone]-W_V3Drain[Zone]+W_LatRecharge3[Zone]+W_HydEquil3[Zone]-W_NetSeep3[Zone]
    # W_In4[Zone] = W_V3Drain[Zone]-W_V4Drain[Zone]+W_LatRecharge4[Zone]+W_HydEquil4[Zone]-W_NetSeep4[Zone]
    
    zonelayer_df$W_VDRAIN_up <- c(zone_df$RAIN_Infiltr, zonelayer_df[zonelayer_df$layer %in% 1:3, "W_VDrain"])
    zonelayer_df$W_In <- zonelayer_df$W_VDRAIN_up - zonelayer_df$W_VDrain + zonelayer_df$W_LatRecharge + zonelayer_df$W_HydEquil -
      c(zonelayer_df[zonelayer_df$layer == 1, "W_Seep"], zonelayer_df[zonelayer_df$layer %in% 2:4, "W_NetSeep"])
    
    
    # W_MaxSoilEvap[Zone] = W_Stock1[Zone]-AF_DepthAct1[Zone]*W_ThetaInacc1[Zone]*1000
    zl1 <- zonelayer_df[zonelayer_df$layer == 1, c("W_Stock", "AF_Depth", "W_ThetaInacc", "W_Theta", "W_ThetaInacc", "W_FieldCap"  )]
    zone_df$W_MaxSoilEvap <- zl1$W_Stock - zl1$AF_Depth * zl1$W_ThetaInacc *
      1000
    
    # EVAP_LightNotCaptured[Zone] = 1-ARRAYSUM(LIGHT_TCap1234[Zone,*])-LIGHT_CRelCap[Zone]
    zone_df$EVAP_LightNotCaptured <- 1 - aggregate(zonetree_df["LIGHT_TCap1234"], zonetree_df["zone"], sum)$LIGHT_TCap1234 -
      zone_df$LIGHT_CRelCap
    
    # EVAP_PotSoilEvap[Zone] = EVAP_EpotDemandNotMetBy_CanInterc*EVAP_LightNotCaptured[Zone]
    zone_df$EVAP_PotSoilEvap <- EVAP_EpotDemandNotMetBy_CanInterc * zone_df$EVAP_LightNotCaptured
    
    # EVAP_SlashEvap[Zone] = EVAP_SlashDryFact*min(EVAP_SlashWater[Zone],max(0,(EVAP_Pot-RAIN_InterceptEvapAvg)))
    zone_df$EVAP_SlashEvap <- EVAP_SlashDryFact * pmin(zone_df$EVAP_SlashWater, pmax(0, (EVAP_Pot -
                                                                                           RAIN_InterceptEvapAvg)))
    
    # EVAP_RedFact[Zone] = min(((W_Theta1[Zone]-W_ThetaInacc1[Zone])/(W_FieldCap1[Zone]-W_ThetaInacc1[Zone]))*EXP(-0.0034*(C_LAI[Zone]+ARRAYSUM(T_LAIEff[Zone,*])+EVAP_MulchEffSurfLit*MC_LAIperNecmss[Zone]*MC_Struc[Zone])),1)
    zone_df$T_LAIEff_sum <- aggregate(zonetree_df["T_LAIEff"], zonetree_df["zone"], sum)$T_LAIEff
    zone_df$EVAP_RedFact <- pmin(((zl1$W_Theta - zl1$W_ThetaInacc) / (zl1$W_FieldCap - zl1$W_ThetaInacc)
    ) *
      exp(
        -0.0034 * (
          zone_df$C_LAI + zone_df$T_LAIEff_sum + EVAP_MulchEffSurfLit * zone_df$MC_LAIperNecmss * zone_df$MC_Struc
        )
      ), 1)
    
    
    zdw <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", c("SB_FineNecromass", "SB_DeadWood")]
    
    # S&B_SlashMoist[Zone] = if S&B_FineNecromass[Zone,DW]>0 then EVAP_SlashWater[Zone]/S&B_FineNecromass[Zone,DW] else 0
    zone_df$SB_SlashMoist <- ifelse(zdw$SB_FineNecromass > 0,
                                    zone_df$EVAP_SlashWater / zdw$SB_FineNecromass,
                                    0)
    
    
    # S&B_IsSlashDry?[Zone] = if S&B_FineNecromass[Zone,DW] > 0 then if (S&B_FineNecromass[Zone,DW]*S&B_SlashMoist[Zone]+RAIN_CanopyWater[Zone]) /S&B_FineNecromass[Zone,DW] < S&B_CritMoist  then 1 else 0 else 0
    zone_df$SB_IsSlashDry_is <- ifelse(zdw$SB_FineNecromass > 0,
                                       ifelse(
                                         (
                                           zdw$SB_FineNecromass * zone_df$SB_SlashMoist + zone_df$RAIN_CanopyWater
                                         ) / zdw$SB_FineNecromass < SB_CritMoist,
                                         1,
                                         0
                                       ),
                                       0)
    
    
    # S&B_Fire? = if S&B_FireTime? = 1 and ARRAYMEAN(S&B_IsSlashDry?[*]) = 1 then 1 else 0
    SB_Fire_is <- ifelse(SB_FireTime_is == 1 &
                           mean(zone_df$SB_IsSlashDry_is) == 1,
                         1,
                         0)
    
    
    # S&B_PileUpT? = DELAY(S&B_Fire?,S&B_TimetoPileUp)
    SB_PileUpT_is <- delay(SB_Fire_is, SB_TimetoPileUp, 0)
    
    # S&B_SecondFire? = delay(S&B_PileUpT?,S&B_2ndFireafterPileUp)
    SB_SecondFire_is <- delay(SB_PileUpT_is, SB_2ndFireafterPileUp, 0)
    
    # S&B_WoodMoist[Zone] = if S&B_DeadWood[Zone,DW]>0 then EVAP_WoodMoist[Zone]/S&B_DeadWood[Zone,DW] else 0
    zone_df$SB_WoodMoist <- ifelse(zdw$SB_DeadWood > 0,
                                   zone_df$EVAP_WoodMoist / zdw$SB_DeadWood,
                                   0)
    
    zone_df$SB_Fire_is <- SB_Fire_is
    zone_df$SB_SecondFire_is <- SB_SecondFire_is
    
    # S&B_FireTempIncSurf[Zone] = if S&B_Fire? = 1 or S&B_SecondFire? = 1  then max(0,S&B_DeadWoodFuelFact*S&B_DeadWood[Zone,DW]*(1-S&B_WoodMoist[Zone]*S&B_WetnessTempImp))+
    #   S&B_FuelloadFactor*(S&B_FineNecromass[Zone,DW]-S&B_WetnessTempImp*(S&B_SlashMoist[Zone]*S&B_FineNecromass[Zone,DW]+RAIN_CanopyWater[Zone])+ MC_Struc[Zone]/(1000*MC_Carbon)*(1-S&B_WetnessTempImp*W_Theta1[Zone]))*S&B_WindEffect else 0
    zone_df$SB_FireTempIncSurf <- ifelse(
      zone_df$SB_Fire_is == 1 | zone_df$SB_SecondFire_is == 1,
      pmax(
        0,
        SB_DeadWoodFuelFact * zdw$SB_DeadWood * (1 - zone_df$SB_WoodMoist * SB_WetnessTempImp)
      ) +
        SB_FuelloadFactor * (
          zdw$SB_FineNecromass - SB_WetnessTempImp * (
            zone_df$SB_SlashMoist * zdw$SB_FineNecromass +
              zone_df$RAIN_CanopyWater
          ) + zone_df$MC_Struc / (1000 * MC_Carbon) * (1 - SB_WetnessTempImp * zl1$W_Theta)
        ) * SB_WindEffect,
      0
    )
    
    # S&B_FireTempIncTopSoil[Zone] = S&B_FireTempIncSurf[Zone]*((1-W_Theta1[Zone])^2)*(0.05/AF_DepthAct1[Zone])
    zone_df$SB_FireTempIncTopSoil <- zone_df$SB_FireTempIncSurf * ((1 - zl1$W_Theta)^2) *
      (0.05 / zl1$AF_Depth)
    
    # S&B_FirEvapS&W[Zone] = if  S&B_FireTempIncTopSoil[Zone]>100 then 1 else 0
    zone_df$SB_FirEvapSW <- ifelse(zone_df$SB_FireTempIncTopSoil > 100, 1, 0)
    
    # EVAP_Surf[Zone] = min(W_MaxSoilEvap[Zone],max(0,EVAP_PotSoilEvap[Zone]-EVAP_SlashEvap[Zone])*EVAP_RedFact[Zone]+S&B_FirEvapS&W[Zone]*W_Stock1[Zone])
    zone_df$EVAP_Surf <- pmin(
      zone_df$W_MaxSoilEvap,
      pmax(0, zone_df$EVAP_PotSoilEvap - zone_df$EVAP_SlashEvap) * zone_df$EVAP_RedFact + zone_df$SB_FirEvapSW * zl1$W_Stock
    )
    
    # W_StockAcc1[Zone] =  max(0,W_Stock1[Zone]- EVAP_Surf[Zone]- W_ThetaInacc1[Zone]*AF_DepthAct1[Zone]*1000)
    # W_StockAcc2[Zone] = max(0,W_Stock2[Zone]-W_ThetaInacc2[Zone]*AF_Depth2[Zone]*1000)
    # W_StockAcc3[Zone] = max(0,W_Stock3[Zone]-W_ThetaInacc3[Zone]*AF_Depth3[Zone]*1000)
    # W_StockAcc4[Zone] = max(0,W_Stock4[Zone]-W_ThetaInacc4[Zone]*AF_Depth4[Zone]*1000)
    
    zonelayer_df$W_StockAcc <- pmax(
      0,
      zonelayer_df$W_Stock - zonelayer_df$W_ThetaInacc * zonelayer_df$AF_Depth *
        1000
    )
    zonelayer_df[zonelayer_df$layer == 1, "W_StockAcc"] <- pmax(0,
                                                               zl1$W_Stock - zone_df$EVAP_Surf - zl1$W_ThetaInacc * zl1$AF_Depth * 1000)
    
    # CW_PotAct[Zone] = CW_Pot[Zone] - (1-CW_DemandRedFac[Zone])*CW_PotRadial[Zone]
    zone_df$CW_PotAct <- zone_df$CW_Pot - (1 - zone_df$CW_DemandRedFac) * zone_df$CW_PotRadial
    
    # TW_PotAct[Tree] = min(0,TW_PotBest[Tree]-(1-TW_DemandRedFac[Tree])*(TW_PotRadial[Tree]+TW_PotLongitudinal[Tree]))
    tree_df$TW_PotAct <- pmin(
      0,
      tree_df$TW_PotBest - (1 - tree_df$TW_DemandRedFac) * (tree_df$TW_PotRadial + tree_df$TW_PotLongitudinal)
    )
    zonetree_df$TW_PotAct <- rep(tree_df$TW_PotAct, each = nzone)
    
    tree_df$TW_DistAxialTransp_mean <- aggregate(zonetree_df["TW_DistAxialTransp"], zonetree_df["tree_id"], mean)$TW_DistAxialTransp
    zonetree_df$TW_DistAxialTransp_mean <- rep(tree_df$TW_DistAxialTransp_mean, each = nzone)
    
    zonetree_df$TW_DemandRedFac <- rep(tree_df$TW_DemandRedFac, each = nzone)
    zonetree_df$TW_PotLongitudinal <- rep(tree_df$TW_PotLongitudinal, each = nzone)
    # TW_PotRhizZn[Zone,Tree] = TW_PotAct[Tree]-(TW_DistAxialTransp[Tree,Zone]/ARRAYMEAN(TW_DistAxialTransp[Tree,*]))*TW_DemandRedFac[Tree]*TW_PotLongitudinal[Tree]
    zonetree_df$TW_PotRhizZn <- zonetree_df$TW_PotAct - (zonetree_df$TW_DistAxialTransp /
                                                           zonetree_df$TW_DistAxialTransp_mean) * zonetree_df$TW_DemandRedFac * zonetree_df$TW_PotLongitudinal
    
    # CW_PotActCor[Zone] = if CW_PotAct[Zone]<0 then CW_PotAct[Zone] else -50000
    zone_df$CW_PotActCor <- ifelse(zone_df$CW_PotAct < 0, zone_df$CW_PotAct, -50000)
    
    # TW_PotRhizZnCor[Tree,Zone] = if TW_PotRhizZn[Zone,Tree]<0 then TW_PotRhizZn[Zone,Tree] else -50000
    zonetree_df$TW_PotRhizZnCor <- ifelse(zonetree_df$TW_PotRhizZn < 0,
                                          zonetree_df$TW_PotRhizZn,
                                          -50000)
    
    # W_PRS[Zone] = min(CW_PotAct[Zone],TW_PotRhizZn[Zone,Sp1],TW_PotRhizZn[Zone,Sp2],TW_PotRhizZn[Zone,Sp3])
    # W_PRW[Zone] = MAX(CW_PotActCor[Zone],TW_PotRhizZnCor[Sp1,Zone],TW_PotRhizZnCor[Sp2,Zone],TW_PotRhizZnCor[Sp3,Zone])
    zone_df$W_PRS <- pmin(
      zone_df$CW_PotAct,
      zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"],
      zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"],
      zonetree_df[zonetree_df$tree_id == 3, "TW_PotRhizZn"]
    )
    zone_df$W_PRW <- pmax(
      zone_df$CW_PotActCor,
      zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZnCor"],
      zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZnCor"],
      zonetree_df[zonetree_df$tree_id == 3, "TW_PotRhizZnCor"]
    )
    
    # W_FlagCropS[Zone] = IF  abs(CW_PotAct[Zone]- W_PRS[Zone])<0.0001 THEN 1 ELSE 0
    # W_FlagCropW[Zone] = IF abs(CW_PotAct[Zone]- W_PRW[Zone])<0.0001 THEN 1 ELSE 0
    zone_df$W_FlagCropS <- ifelse(abs(zone_df$CW_PotAct - zone_df$W_PRS) <
                                    0.0001, 1, 0)
    zone_df$W_FlagCropW <- ifelse(abs(zone_df$CW_PotAct - zone_df$W_PRW) <
                                    0.0001, 1, 0)
    
    zonetree_df$W_PRS <- rep(zone_df$W_PRS, ntree)
    # W_FlagTreeS[Zone,Tree] = IF  abs(TW_PotRhizZn[Zone,Tree] - W_PRS[Zone] )< 0.0001 THEN 1 ELSE 0
    zonetree_df$W_FlagTreeS <- ifelse(abs(zonetree_df$TW_PotRhizZn - zonetree_df$W_PRS) < 0.0001,
                                      1,
                                      0)
    
    zone_df$W_FlagTreeS_sum <- aggregate(zonetree_df["W_FlagTreeS"], zonetree_df["zone"], sum)$W_FlagTreeS
    
    # W_TotSFlags[Zone] = W_FlagCropS[Zone]+ARRAYSUM(W_FlagTreeS[Zone,*])
    zone_df$W_TotSFlags <- zone_df$W_FlagCropS + zone_df$W_FlagTreeS_sum
    
    
    
    # W_PRMid1[Zone] = if W_TotSFlags[Zone]>1  then W_PRS[Zone] else IF abs(CW_PotAct[Zone]-W_PRW[Zone])>0.00000001 AND abs(CW_PotAct[Zone]-W_PRS[Zone])>0.00000001 THEN CW_PotAct[Zone] ELSE IF abs(TW_PotRhizZn[Zone,Sp1]-W_PRW[Zone])>0.00000001 AND abs(TW_PotRhizZn[Zone,Sp1]-W_PRS[Zone])>0.00000001 THEN TW_PotRhizZn[Zone,Sp1] ELSE  IF abs(TW_PotRhizZn[Zone,Sp2]-W_PRW[Zone])>0.00000001 AND abs(TW_PotRhizZn[Zone,Sp2]-W_PRS[Zone])>0.00000001 THEN TW_PotRhizZn[Zone,Sp2] ELSE TW_PotRhizZn[Zone,Sp3]
    # W_PRMid2[Zone] = if W_TotSFlags[Zone]>2 then W_PRS[Zone] else IF abs(CW_PotAct[Zone]-W_PRW[Zone])>0.00000001 AND abs(CW_PotAct[Zone]-W_PRS[Zone])>0.00000001 AND abs(CW_PotAct[Zone]-W_PRMid1[Zone])>0.00000001 THEN CW_PotAct[Zone] ELSE IF abs(TW_PotRhizZn[Zone,Sp1]-W_PRW[Zone])>0.00000001 AND abs(TW_PotRhizZn[Zone,Sp1]-W_PRS[Zone])>0.00000001 AND abs(TW_PotRhizZn[Zone,Sp1]-W_PRMid1[Zone])>0.00000001 THEN TW_PotRhizZn[Zone,Sp1] ELSE  IF abs(TW_PotRhizZn[Zone,Sp2]-W_PRW[Zone])>0.00000001 AND abs(TW_PotRhizZn[Zone,Sp2]-W_PRS[Zone])>0.00000001 AND abs(TW_PotRhizZn[Zone,Sp2]-W_PRMid1[Zone])>0.00000001 THEN TW_PotRhizZn[Zone,Sp2] ELSE TW_PotRhizZn[Zone,Sp3]
    zone_df$W_PRMid1 <- ifelse(
      zone_df$W_TotSFlags > 1,
      zone_df$W_PRS,
      ifelse(
        abs(zone_df$CW_PotAct - zone_df$W_PRW) > 0.00000001 &
          abs(zone_df$CW_PotAct - zone_df$W_PRS) > 0.00000001,
        zone_df$CW_PotAct,
        ifelse(
          abs(zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"] - zone_df$W_PRW) > 0.00000001 &
            abs(zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"] - zone_df$W_PRS) > 0.00000001,
          zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"],
          ifelse(
            abs(zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"] - zone_df$W_PRW) > 0.00000001 &
              abs(zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"] - zone_df$W_PRS) > 0.00000001,
            zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"],
            zonetree_df[zonetree_df$tree_id == 3, "TW_PotRhizZn"]
          )
        )
      )
    )
    
    zone_df$W_PRMid2 <- ifelse(
      zone_df$W_TotSFlags > 2,
      zone_df$W_PRS,
      ifelse(
        abs(zone_df$CW_PotAct - zone_df$W_PRW) > 0.00000001 &
          abs(zone_df$CW_PotAct - zone_df$W_PRS) > 0.00000001 &
          abs(zone_df$CW_PotAct - zone_df$W_PRMid1) > 0.00000001,
        zone_df$CW_PotAct,
        ifelse(
          abs(zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"] - zone_df$W_PRW) > 0.00000001 &
            abs(zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"] - zone_df$W_PRS) > 0.00000001 &
            abs(zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"] - zone_df$W_PRMid1) > 0.00000001,
          zonetree_df[zonetree_df$tree_id == 1, "TW_PotRhizZn"],
          ifelse(
            abs(zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"] - zone_df$W_PRW) > 0.00000001 &
              abs(zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"] - zone_df$W_PRS) > 0.00000001 &
              abs(zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"] - zone_df$W_PRMid1) > 0.00000001,
            zonetree_df[zonetree_df$tree_id == 2, "TW_PotRhizZn"],
            zonetree_df[zonetree_df$tree_id == 3, "TW_PotRhizZn"]
          )
        )
      )
    )
    
    # W_PRMS[Zone] = min(W_PRMid1[Zone],W_PRMid2[Zone])
    # W_PRMW[Zone] = max(W_PRMid1[Zone],W_PRMid2[Zone])
    zone_df$W_PRMS <- pmin(zone_df$W_PRMid1, zone_df$W_PRMid2)
    zone_df$W_PRMW <- pmax(zone_df$W_PRMid1, zone_df$W_PRMid2)
    
    # W_FlagCropMS[Zone] = IF abs(CW_PotAct[Zone]- W_PRMS[Zone])<0.0001 THEN 1 ELSE 0
    # W_FlagCropMW[Zone] = IF abs(CW_PotAct[Zone]- W_PRMW[Zone])<0.0001 THEN 1 ELSE 0
    zone_df$W_FlagCropMS <- ifelse(abs(zone_df$CW_PotAct - zone_df$W_PRMS) <
                                     0.0001, 1, 0)
    zone_df$W_FlagCropMW <- ifelse(abs(zone_df$CW_PotAct - zone_df$W_PRMW) <
                                     0.0001, 1, 0)
    
    # W_FlagTreeMS[Zone,Tree] = IF abs(TW_PotRhizZn[Zone,Tree]- W_PRMS[Zone])<0.0001 THEN 1 ELSE 0
    # W_FlagTreeMW[Zone,Tree] = IF abs(TW_PotRhizZn[Zone,Tree]- W_PRMW[Zone])<0.0001 THEN 1 ELSE 0
    # W_FlagTreeS[Zone,Tree] = IF  abs(TW_PotRhizZn[Zone,Tree] - W_PRS[Zone])< 0.0001 THEN 1 ELSE 0
    # W_FlagTreeW[Zone,Tree] = IF abs(TW_PotRhizZn[Zone,Tree] - W_PRW[Zone])<0.0001  THEN 1 ELSE 0
    
    zonetreewater_df$TW_PotRhizZn <- rep(zonetree_df$TW_PotRhizZn, nwater)
    zonetreewater_df$W_PR <- NA
    zonetreewater_df[zonetreewater_df$water == "MS", "W_PR"] <- rep(zone_df$W_PRMS, ntree)
    zonetreewater_df[zonetreewater_df$water == "MW", "W_PR"] <- rep(zone_df$W_PRMW, ntree)
    zonetreewater_df[zonetreewater_df$water == "S", "W_PR"] <- rep(zone_df$W_PRS, ntree)
    zonetreewater_df[zonetreewater_df$water == "W", "W_PR"] <- rep(zone_df$W_PRW, ntree)
    
    zonetreewater_df$W_FlagTree <- ifelse(abs(zonetreewater_df$TW_PotRhizZn - zonetreewater_df$W_PR) < 0.0001,
                                          1,
                                          0)
    
    
    # RT_LrvMS[Zn1,1] = W_FlagCropMS[Zn1]*RT_CLrv1[Zn1]+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3] + 0*(W_FlagCropMS[Zn1]+W_FlagTreeMS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMS[Zn1,2] = W_FlagCropMS[Zn1]*RT_CLrv2[Zn1]+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3] + 0*(W_FlagCropMS[Zn1]+W_FlagTreeMS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMS[Zn1,3] = W_FlagCropMS[Zn1]*RT_CLrv3[Zn1]+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3] + 0*(W_FlagCropMS[Zn1]+W_FlagTreeMS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMS[Zn1,4] = W_FlagCropMS[Zn1]*RT_CLrv4[Zn1]+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3] + 0*(W_FlagCropMS[Zn1]+W_FlagTreeMS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMS[Zn2,1] = W_FlagCropMS[Zn2]*RT_CLrv1[Zn2]+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3] + 0*(W_FlagCropMS[Zn2]+W_FlagTreeMS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMS[Zn2,2] = W_FlagCropMS[Zn2]*RT_CLrv2[Zn2]+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3] + 0*(W_FlagCropMS[Zn2]+W_FlagTreeMS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMS[Zn2,3] = W_FlagCropMS[Zn2]*RT_CLrv3[Zn2]+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3] + 0*(W_FlagCropMS[Zn2]+W_FlagTreeMS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMS[Zn2,4] = W_FlagCropMS[Zn2]*RT_CLrv4[Zn2]+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3] + 0*(W_FlagCropMS[Zn2]+W_FlagTreeMS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMS[Zn3,1] = W_FlagCropMS[Zn3]*RT_CLrv1[Zn3]+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3] + 0*(W_FlagCropMS[Zn3]+W_FlagTreeMS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMS[Zn3,2] = W_FlagCropMS[Zn3]*RT_CLrv2[Zn3]+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3] + 0*(W_FlagCropMS[Zn3]+W_FlagTreeMS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMS[Zn3,3] = W_FlagCropMS[Zn3]*RT_CLrv3[Zn3]+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3] + 0*(W_FlagCropMS[Zn3]+W_FlagTreeMS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMS[Zn3,4] = W_FlagCropMS[Zn3]*RT_CLrv4[Zn3]+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3] + 0*(W_FlagCropMS[Zn3]+W_FlagTreeMS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMS[Zn4,1] = W_FlagCropMS[Zn4]*RT_CLrv1[Zn4]+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3] + 0*(W_FlagCropMS[Zn4]+W_FlagTreeMS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvMS[Zn4,2] = W_FlagCropMS[Zn4]*RT_CLrv2[Zn4]+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3] + 0*(W_FlagCropMS[Zn4]+W_FlagTreeMS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvMS[Zn4,3] = W_FlagCropMS[Zn4]*RT_CLrv3[Zn4]+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3] + 0*(W_FlagCropMS[Zn4]+W_FlagTreeMS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvMS[Zn4,4] = W_FlagCropMS[Zn4]*RT_CLrv4[Zn4]+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3] + 0*(W_FlagCropMS[Zn4]+W_FlagTreeMS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    #
    # RT_LrvMW[Zn1,1] = W_FlagCropMW[Zn1]*RT_CLrv1[Zn1]+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3] + 0*(W_FlagCropMW[Zn1]+W_FlagTreeMW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMW[Zn1,2] = W_FlagCropMW[Zn1]*RT_CLrv2[Zn1]+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3] + 0*(W_FlagCropMW[Zn1]+W_FlagTreeMW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMW[Zn1,3] = W_FlagCropMW[Zn1]*RT_CLrv3[Zn1]+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3] + 0*(W_FlagCropMW[Zn1]+W_FlagTreeMW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMW[Zn1,4] = W_FlagCropMW[Zn1]*RT_CLrv4[Zn1]+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3] + 0*(W_FlagCropMW[Zn1]+W_FlagTreeMW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvMW[Zn2,1] = W_FlagCropMW[Zn2]*RT_CLrv1[Zn2]+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3] + 0*(W_FlagCropMW[Zn2]+W_FlagTreeMW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMW[Zn2,2] = W_FlagCropMW[Zn2]*RT_CLrv2[Zn2]+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3] + 0*(W_FlagCropMW[Zn2]+W_FlagTreeMW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMW[Zn2,3] = W_FlagCropMW[Zn2]*RT_CLrv3[Zn2]+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3] + 0*(W_FlagCropMW[Zn2]+W_FlagTreeMW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMW[Zn2,4] = W_FlagCropMW[Zn2]*RT_CLrv4[Zn2]+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3] + 0*(W_FlagCropMW[Zn2]+W_FlagTreeMW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvMW[Zn3,1] = W_FlagCropMW[Zn3]*RT_CLrv1[Zn3]+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3] + 0*(W_FlagCropMW[Zn3]+W_FlagTreeMW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMW[Zn3,2] = W_FlagCropMW[Zn3]*RT_CLrv2[Zn3]+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3] + 0*(W_FlagCropMW[Zn3]+W_FlagTreeMW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMW[Zn3,3] = W_FlagCropMW[Zn3]*RT_CLrv3[Zn3]+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3] + 0*(W_FlagCropMW[Zn3]+W_FlagTreeMW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMW[Zn3,4] = W_FlagCropMW[Zn3]*RT_CLrv4[Zn3]+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3] + 0*(W_FlagCropMW[Zn3]+W_FlagTreeMW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvMW[Zn4,1] = W_FlagCropMW[Zn4]*RT_CLrv1[Zn4]+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3] + 0*(W_FlagCropMW[Zn4]+W_FlagTreeMW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvMW[Zn4,2] = W_FlagCropMW[Zn4]*RT_CLrv2[Zn4]+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3] + 0*(W_FlagCropMW[Zn4]+W_FlagTreeMW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvMW[Zn4,3] = W_FlagCropMW[Zn4]*RT_CLrv3[Zn4]+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3] + 0*(W_FlagCropMW[Zn4]+W_FlagTreeMW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvMW[Zn4,4] = W_FlagCropMW[Zn4]*RT_CLrv4[Zn4]+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3] + 0*(W_FlagCropMW[Zn4]+W_FlagTreeMW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    #
    # RT_LrvS[Zn1,1] = W_FlagCropS[Zn1]*RT_CLrv1[Zn1]+W_FlagTreeS[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]+W_FlagTreeS[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]+W_FlagTreeS[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3] + 0*(W_FlagCropS[Zn1]+W_FlagTreeS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvS[Zn1,2] = W_FlagCropS[Zn1]*RT_CLrv2[Zn1]+W_FlagTreeS[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]+W_FlagTreeS[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]+W_FlagTreeS[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3] + 0*(W_FlagCropS[Zn1]+W_FlagTreeS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvS[Zn1,3] = W_FlagCropS[Zn1]*RT_CLrv3[Zn1]+W_FlagTreeS[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]+W_FlagTreeS[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]+W_FlagTreeS[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3] + 0*(W_FlagCropS[Zn1]+W_FlagTreeS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvS[Zn1,4] = W_FlagCropS[Zn1]*RT_CLrv4[Zn1]+W_FlagTreeS[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]+W_FlagTreeS[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]+W_FlagTreeS[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3] + 0*(W_FlagCropS[Zn1]+W_FlagTreeS[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvS[Zn2,1] = W_FlagCropS[Zn2]*RT_CLrv1[Zn2]+W_FlagTreeS[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]+W_FlagTreeS[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]+W_FlagTreeS[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3] + 0*(W_FlagCropS[Zn2]+W_FlagTreeS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvS[Zn2,2] = W_FlagCropS[Zn2]*RT_CLrv2[Zn2]+W_FlagTreeS[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]+W_FlagTreeS[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]+W_FlagTreeS[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3] + 0*(W_FlagCropS[Zn2]+W_FlagTreeS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvS[Zn2,3] = W_FlagCropS[Zn2]*RT_CLrv3[Zn2]+W_FlagTreeS[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]+W_FlagTreeS[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]+W_FlagTreeS[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3] + 0*(W_FlagCropS[Zn2]+W_FlagTreeS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvS[Zn2,4] = W_FlagCropS[Zn2]*RT_CLrv4[Zn2]+W_FlagTreeS[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]+W_FlagTreeS[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]+W_FlagTreeS[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3] + 0*(W_FlagCropS[Zn2]+W_FlagTreeS[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvS[Zn3,1] = W_FlagCropS[Zn3]*RT_CLrv1[Zn3]+W_FlagTreeS[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]+W_FlagTreeS[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]+W_FlagTreeS[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3] + 0*(W_FlagCropS[Zn3]+W_FlagTreeS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvS[Zn3,2] = W_FlagCropS[Zn3]*RT_CLrv2[Zn3]+W_FlagTreeS[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]+W_FlagTreeS[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]+W_FlagTreeS[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3] + 0*(W_FlagCropS[Zn3]+W_FlagTreeS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvS[Zn3,3] = W_FlagCropS[Zn3]*RT_CLrv3[Zn3]+W_FlagTreeS[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]+W_FlagTreeS[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]+W_FlagTreeS[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3] + 0*(W_FlagCropS[Zn3]+W_FlagTreeS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvS[Zn3,4] = W_FlagCropS[Zn3]*RT_CLrv4[Zn3]+W_FlagTreeS[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]+W_FlagTreeS[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]+W_FlagTreeS[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3] + 0*(W_FlagCropS[Zn3]+W_FlagTreeS[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvS[Zn4,1] = W_FlagCropS[Zn4]*RT_CLrv1[Zn4]+W_FlagTreeS[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]+W_FlagTreeS[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]+W_FlagTreeS[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3] + 0*(W_FlagCropS[Zn4]+W_FlagTreeS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvS[Zn4,2] = W_FlagCropS[Zn4]*RT_CLrv2[Zn4]+W_FlagTreeS[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]+W_FlagTreeS[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]+W_FlagTreeS[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3] + 0*(W_FlagCropS[Zn4]+W_FlagTreeS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvS[Zn4,3] = W_FlagCropS[Zn4]*RT_CLrv3[Zn4]+W_FlagTreeS[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]+W_FlagTreeS[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]+W_FlagTreeS[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3] + 0*(W_FlagCropS[Zn4]+W_FlagTreeS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvS[Zn4,4] = W_FlagCropS[Zn4]*RT_CLrv4[Zn4]+W_FlagTreeS[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]+W_FlagTreeS[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]+W_FlagTreeS[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3] + 0*(W_FlagCropS[Zn4]+W_FlagTreeS[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    #
    # RT_LrvW[Zn1,1] = W_FlagCropW[Zn1]*RT_CLrv1[Zn1]+W_FlagTreeW[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]+W_FlagTreeW[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]+W_FlagTreeW[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3] + 0*(W_FlagCropW[Zn1]+W_FlagTreeW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvW[Zn1,2] = W_FlagCropW[Zn1]*RT_CLrv2[Zn1]+W_FlagTreeW[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]+W_FlagTreeW[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]+W_FlagTreeW[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3] + 0*(W_FlagCropW[Zn1]+W_FlagTreeW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvW[Zn1,3] = W_FlagCropW[Zn1]*RT_CLrv3[Zn1]+W_FlagTreeW[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]+W_FlagTreeW[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]+W_FlagTreeW[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3] + 0*(W_FlagCropW[Zn1]+W_FlagTreeW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvW[Zn1,4] = W_FlagCropW[Zn1]*RT_CLrv4[Zn1]+W_FlagTreeW[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]+W_FlagTreeW[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]+W_FlagTreeW[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3] + 0*(W_FlagCropW[Zn1]+W_FlagTreeW[Zn1,Sp1]+RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv1[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_LrvW[Zn2,1] = W_FlagCropW[Zn2]*RT_CLrv1[Zn2]+W_FlagTreeW[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]+W_FlagTreeW[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]+W_FlagTreeW[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3] + 0*(W_FlagCropW[Zn2]+W_FlagTreeW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvW[Zn2,2] = W_FlagCropW[Zn2]*RT_CLrv2[Zn2]+W_FlagTreeW[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]+W_FlagTreeW[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]+W_FlagTreeW[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3] + 0*(W_FlagCropW[Zn2]+W_FlagTreeW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvW[Zn2,3] = W_FlagCropW[Zn2]*RT_CLrv3[Zn2]+W_FlagTreeW[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]+W_FlagTreeW[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]+W_FlagTreeW[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3] + 0*(W_FlagCropW[Zn2]+W_FlagTreeW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvW[Zn2,4] = W_FlagCropW[Zn2]*RT_CLrv4[Zn2]+W_FlagTreeW[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]+W_FlagTreeW[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]+W_FlagTreeW[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3] + 0*(W_FlagCropW[Zn2]+W_FlagTreeW[Zn2,Sp1]+RT_CLrv1[Zn2]+RT_CLrv2[Zn2]+RT_CLrv3[Zn2]+RT_CLrv4[Zn2]+RT_TLrv2[Zn2,Sp1]+RT_TLrv1[Zn2,Sp1]+RT_TLrv3[Zn2,Sp1]+RT_TLrv4[Zn2,Sp1])
    # RT_LrvW[Zn3,1] = W_FlagCropW[Zn3]*RT_CLrv1[Zn3]+W_FlagTreeW[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]+W_FlagTreeW[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]+W_FlagTreeW[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3] + 0*(W_FlagCropW[Zn3]+W_FlagTreeW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvW[Zn3,2] = W_FlagCropW[Zn3]*RT_CLrv2[Zn3]+W_FlagTreeW[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]+W_FlagTreeW[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]+W_FlagTreeW[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3] + 0*(W_FlagCropW[Zn3]+W_FlagTreeW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvW[Zn3,3] = W_FlagCropW[Zn3]*RT_CLrv3[Zn3]+W_FlagTreeW[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]+W_FlagTreeW[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]+W_FlagTreeW[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3] + 0*(W_FlagCropW[Zn3]+W_FlagTreeW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvW[Zn3,4] = W_FlagCropW[Zn3]*RT_CLrv4[Zn3]+W_FlagTreeW[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]+W_FlagTreeW[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]+W_FlagTreeW[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3] + 0*(W_FlagCropW[Zn3]+W_FlagTreeW[Zn3,Sp1]+RT_CLrv1[Zn3]+RT_CLrv2[Zn3]+RT_CLrv3[Zn3]+RT_CLrv4[Zn3]+RT_TLrv2[Zn3,Sp1]+RT_TLrv1[Zn3,Sp1]+RT_TLrv3[Zn3,Sp1]+RT_TLrv4[Zn3,Sp1])
    # RT_LrvW[Zn4,1] = W_FlagCropW[Zn4]*RT_CLrv1[Zn4]+W_FlagTreeW[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]+W_FlagTreeW[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]+W_FlagTreeW[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3] + 0*(W_FlagCropW[Zn4]+W_FlagTreeW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvW[Zn4,2] = W_FlagCropW[Zn4]*RT_CLrv2[Zn4]+W_FlagTreeW[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]+W_FlagTreeW[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]+W_FlagTreeW[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3] + 0*(W_FlagCropW[Zn4]+W_FlagTreeW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvW[Zn4,3] = W_FlagCropW[Zn4]*RT_CLrv3[Zn4]+W_FlagTreeW[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]+W_FlagTreeW[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]+W_FlagTreeW[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3] + 0*(W_FlagCropW[Zn4]+W_FlagTreeW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    # RT_LrvW[Zn4,4] = W_FlagCropW[Zn4]*RT_CLrv4[Zn4]+W_FlagTreeW[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]+W_FlagTreeW[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]+W_FlagTreeW[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3] + 0*(W_FlagCropW[Zn4]+W_FlagTreeW[Zn4,Sp1]+RT_CLrv1[Zn4]+RT_CLrv2[Zn4]+RT_CLrv3[Zn4]+RT_CLrv4[Zn4]+RT_TLrv2[Zn4,Sp1]+RT_TLrv1[Zn4,Sp1]+RT_TLrv3[Zn4,Sp1]+RT_TLrv4[Zn4,Sp1])
    
    
    zonelayerwater_df$W_FlagCrop <- NA
    zonelayerwater_df[zonelayerwater_df$water == "MS", "W_FlagCrop"] <- zone_df$W_FlagCropMS
    zonelayerwater_df[zonelayerwater_df$water == "MW", "W_FlagCrop"] <- zone_df$W_FlagCropMW
    zonelayerwater_df[zonelayerwater_df$water == "S", "W_FlagCrop"] <- zone_df$W_FlagCropS
    zonelayerwater_df[zonelayerwater_df$water == "W", "W_FlagCrop"] <- zone_df$W_FlagCropW
    
    zonelayerwater_df$RT_CLrv <- rep(zonelayer_df$RT_CLrv, nwater)
    
    # add layer index of array
    df <- zonetreewater_df[c("zone", "tree_id", "water", "W_FlagTree")]
    l_df <- df[rep(seq_len(nrow(df)), nlayer), ]
    l_df$layer <- rep(layer_df$layer, each = nrow(zonetreewater_df))
    l_df <- l_df[order(l_df$water, l_df$tree_id, l_df$layer, l_df$zone), ]
    zonelayertreewater_df$W_FlagTree <- l_df$W_FlagTree
    
    zonelayertreewater_df$RT_TLrv <- rep(zonelayertree_df$RT_TLrv, nwater)
    zonelayertreewater_df$RT_TLrv_flag <- zonelayertreewater_df$W_FlagTree * zonelayertreewater_df$RT_TLrv
    zonelayerwater_df$RT_TLrv_flag_sum <- aggregate(zonelayertreewater_df["RT_TLrv_flag"], zonelayertreewater_df[c("zone", "layer", "water")], sum)$RT_TLrv_flag
    
    zonelayerwater_df$RT_Lrv <- zonelayerwater_df$W_FlagCrop * zonelayerwater_df$RT_CLrv + zonelayerwater_df$RT_TLrv_flag_sum
    
    
    # W_Theta1MS[Zone] = if (1+(ABS(W_Alpha1*W_PRMS[Zone]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*W_PRMS[Zone]))^W_n1)^(1-1/W_n1) else 0
    # W_Theta2MS[Zone] = if (1+(ABS(W_Alpha2*W_PRMS[Zone]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2/(1+(ABS(W_Alpha2*W_PRMS[Zone]))^W_n2)^(1-1/W_n2) else 0
    # W_Theta3MS[Zone] = if (1+(ABS(W_Alpha3*W_PRMS[Zone]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3/(1+(ABS(W_Alpha3*W_PRMS[Zone]))^W_n3)^(1-1/W_n3) else 0
    # W_Theta4MS[Zone] = if (1+(ABS(W_Alpha4*W_PRMS[Zone]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4/(1+(ABS(W_Alpha4*W_PRMS[Zone]))^W_n4)^(1-1/W_n4) else 0
    #
    # W_Theta1MW[Zone] = if (1+(ABS(W_Alpha1*W_PRMW[Zone]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*W_PRMW[Zone]))^W_n1)^(1-1/W_n1) else 0
    # W_Theta2MW[Zone] = if (1+(ABS(W_Alpha2*W_PRMW[Zone]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2/(1+(ABS(W_Alpha2*W_PRMW[Zone]))^W_n2)^(1-1/W_n2) else 0
    # W_Theta3MW[Zone] = if (1+(ABS(W_Alpha3*W_PRMW[Zone]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3/(1+(ABS(W_Alpha3*W_PRMW[Zone]))^W_n3)^(1-1/W_n3) else 0
    # W_Theta4MW[Zone] = if (1+(ABS(W_Alpha4*W_PRMW[Zone]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4/(1+(ABS(W_Alpha4*W_PRMW[Zone]))^W_n4)^(1-1/W_n4) else 0
    #
    # W_Theta1S[Zone] = if (1+(ABS(W_Alpha1*W_PRS[Zone]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*W_PRS[Zone]))^W_n1)^(1-1/W_n1) else 0
    # W_Theta2S[Zone] = if (1+(ABS(W_Alpha2*W_PRS[Zone]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2/(1+(ABS(W_Alpha2*W_PRS[Zone]))^W_n2)^(1-1/W_n2) else 0
    # W_Theta3S[Zone] = if (1+(ABS(W_Alpha3*W_PRS[Zone]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3/(1+(ABS(W_Alpha3*W_PRS[Zone]))^W_n3)^(1-1/W_n3) else 0
    # W_Theta4S[Zone] = if (1+(ABS(W_Alpha4*W_PRS[Zone]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4/(1+(ABS(W_Alpha4*W_PRS[Zone]))^W_n4)^(1-1/W_n4) else 0
    #
    # W_Theta1W[Zone] = if (1+(ABS(W_Alpha1*W_PRW[Zone]))^W_n1)^(1-1/W_n1)<>0 then W_ThetaSat1/(1+(ABS(W_Alpha1*W_PRW[Zone]))^W_n1)^(1-1/W_n1) else 0
    # W_Theta2W[Zone] = if (1+(ABS(W_Alpha2*W_PRW[Zone]))^W_n2)^(1-1/W_n2)<>0 then W_ThetaSat2/(1+(ABS(W_Alpha2*W_PRW[Zone]))^W_n2)^(1-1/W_n2) else 0
    # W_Theta3W[Zone] = if (1+(ABS(W_Alpha3*W_PRW[Zone]))^W_n3)^(1-1/W_n3)<>0 then W_ThetaSat3/(1+(ABS(W_Alpha3*W_PRW[Zone]))^W_n3)^(1-1/W_n3) else 0
    # W_Theta4W[Zone] = if (1+(ABS(W_Alpha4*W_PRW[Zone]))^W_n4)^(1-1/W_n4)<>0 then W_ThetaSat4/(1+(ABS(W_Alpha4*W_PRW[Zone]))^W_n4)^(1-1/W_n4) else 0
    
    zonelayerwater_df$W_Alpha <- rep(zonelayer_df$W_Alpha, 4)
    zonelayerwater_df$W_n <- rep(zonelayer_df$W_n, 4)
    zonelayerwater_df$W_ThetaSat <- rep(zonelayer_df$W_ThetaSat, 4)
    zonelayerwater_df$W_PR <- NA
    zonelayerwater_df[zonelayerwater_df$water == "MS", "W_PR"] <- rep(zone_df$W_PRMS, nlayer)
    zonelayerwater_df[zonelayerwater_df$water == "MW", "W_PR"] <- rep(zone_df$W_PRMW, nlayer)
    zonelayerwater_df[zonelayerwater_df$water == "S", "W_PR"] <- rep(zone_df$W_PRS, nlayer)
    zonelayerwater_df[zonelayerwater_df$water == "W", "W_PR"] <- rep(zone_df$W_PRW, nlayer)
    
    zonelayerwater_df$W_Theta_water_a <- (1 + (abs(
      zonelayerwater_df$W_Alpha * zonelayerwater_df$W_PR
    ))^zonelayerwater_df$W_n)^(1 - 1 / zonelayerwater_df$W_n)
    zonelayerwater_df$W_Theta_water <- ifelse(
      zonelayerwater_df$W_Theta_water_a != 0,
      zonelayerwater_df$W_ThetaSat / zonelayerwater_df$W_Theta_water_a,
      0
    )
    
    # W_Theta1_MS_MW[Zone] = 1000*AF_DepthAct1[Zone]*max(0,min(W_Theta1[Zone],W_Theta1MW[Zone])-W_Theta1MS[Zone])
    # W_Theta2_MS_MW[Zone] = 1000*AF_Depth2[Zone]*max(0,min(W_Theta2[Zone],W_Theta2MW[Zone])-W_Theta2MS[Zone])
    # W_Theta3_MS_MW[Zone] = 1000*AF_Depth3[Zone]*max(0,min(W_Theta3[Zone],W_Theta3MW[Zone])-W_Theta3MS[Zone])
    # W_Theta4_MS_MW[Zone] = 1000*AF_Depth4[Zone]*max(0,min(W_Theta4[Zone],W_Theta4MW[Zone])-W_Theta4MS[Zone])
    #
    # W_Theta1_MW_W[Zone] = 1000*AF_DepthAct1[Zone]*max(0,min(W_Theta1[Zone],W_Theta1W[Zone])-W_Theta1MW[Zone])
    # W_Theta2_MW_W[Zone] = 1000*AF_Depth2[Zone]*max(0,min(W_Theta2[Zone],W_Theta2W[Zone])-W_Theta2MW[Zone])
    # W_Theta3_MW_W[Zone] = 1000*AF_Depth3[Zone]*max(0,min(W_Theta3[Zone],W_Theta3W[Zone])-W_Theta3MW[Zone])
    # W_Theta4_MW_W[Zone] = 1000*AF_Depth4[Zone]*max(0,min(W_Theta4[Zone],W_Theta4W[Zone])-W_Theta4MW[Zone])
    #
    # W_Theta1S_MS[Zone] = 1000*AF_DepthAct1[Zone]*max(0,min(W_Theta1[Zone],W_Theta1MS[Zone])-W_Theta1S[Zone])
    # W_Theta2_S_MS[Zone] = 1000*AF_Depth2[Zone]*max(0,min(W_Theta2[Zone],W_Theta2MS[Zone])-W_Theta2S[Zone])
    # W_Theta3_S_MS[Zone] = 1000*AF_Depth3[Zone]*max(0,min(W_Theta3[Zone],W_Theta3MS[Zone])-W_Theta3S[Zone])
    # W_Theta4_S_MS[Zone] = 1000*AF_Depth4[Zone]*max(0,min(W_Theta4[Zone],W_Theta4MS[Zone])-W_Theta4S[Zone])
    #
    # W_Theta1_W_Soil[Zone] = 1000*AF_DepthAct1[Zone]*max(0,W_Theta1[Zone]-W_Theta1W[Zone])
    # W_Theta2_W_Soil[Zone] = 1000*AF_Depth2[Zone]*max(0,W_Theta2[Zone]-W_Theta2W[Zone])
    # W_Theta3_W_Soil[Zone] = 1000*AF_Depth3[Zone]*max(0,W_Theta3[Zone]-W_Theta3W[Zone])
    # W_Theta4_W_Soil[Zone] = 1000*AF_Depth4[Zone]*max(0,W_Theta4[Zone]-W_Theta4W[Zone])
    
    
    zonelayerwater_df$AF_Depth <- rep(zonelayer_df$AF_Depth, 4)
    zonelayerwater_df$W_Theta <- rep(zonelayer_df$W_Theta, 4)
    zonelayerwater_df$W_Theta_water_x <- c(
      zonelayerwater_df[zonelayerwater_df$water == "MW", "W_Theta_water"],
      zonelayerwater_df[zonelayerwater_df$water == "W", "W_Theta_water"],
      zonelayerwater_df[zonelayerwater_df$water == "MS", "W_Theta_water"],
      rep(maxval, nzone * nlayer)
    )
    
    zonelayerwater_df$W_Theta_water_pair <- 1000 * zonelayerwater_df$AF_Depth *
      pmax(
        0,
        pmin(
          zonelayerwater_df$W_Theta,
          zonelayerwater_df$W_Theta_water_x
        ) - zonelayerwater_df$W_Theta_water
      )
    
    
    # W_pFMS[Zone] = IF W_PRMS[Zone]<0 THEN LOG10(-W_PRMS[Zone]) ELSE 0
    # W_pFMW[Zone] = IF W_PRMW[Zone]<0 THEN LOG10(-W_PRMW[Zone]) ELSE 0
    # W_pFS[Zone] = IF W_PRS[Zone]<0  THEN LOG10(-W_PRS[Zone]) ELSE 0
    # W_pFW[Zone] = IF W_PRW[Zone]<0 THEN LOG10(-W_PRW[Zone]) ELSE 0
    zone_df$W_pFMS <- ifelse(zone_df$W_PRMS < 0, log10(-zone_df$W_PRMS), 0)
    zone_df$W_pFMW <- ifelse(zone_df$W_PRMW < 0, log10(-zone_df$W_PRMW), 0)
    zone_df$W_pFS <- ifelse(zone_df$W_PRS < 0, log10(-zone_df$W_PRS), 0)
    zone_df$W_pFW <- ifelse(zone_df$W_PRW < 0, log10(-zone_df$W_PRW), 0)
    
    #TODO: to be checked for X range of W_PhiPMW4 and W_PhiPW2. it has X range of 0-100 instead 0-0.2 as the series of similar variables on the STELLA model (?). Assumed as typos for time being, and generalized to use x = 0-0.2 for all series
    # the original X axis for W_PhiPMW4 and W_PhiPW2 is c(0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100)
    
    # W_PhiPMS1[Zone] = GRAPH(W_pFMS[Zone])
    # W_PhiPMS2[Zone] = GRAPH(W_pFMS[Zone])
    # W_PhiPMS3[Zone] = GRAPH(W_pFMS[Zone])
    # W_PhiPMS4[Zone] = GRAPH(W_pFMS[Zone])
    #
    # W_PhiPMW1[Zone] = GRAPH(W_pFMW[Zone])
    # W_PhiPMW2[Zone] = GRAPH(W_pFMW[Zone])
    # W_PhiPMW3[Zone] = GRAPH(W_pFMW[Zone])
    # W_PhiPMW4[Zone] = GRAPH(W_pFMW[Zone])
    #
    # W_PhiPS1[Zone] = GRAPH(W_pFS[Zone])
    # W_PhiPS2[Zone] = GRAPH(W_pFS[Zone])
    # W_PhiPS3[Zone] = GRAPH(W_pFS[Zone])
    # W_PhiPS4[Zone] = GRAPH(W_pFS[Zone])
    #
    # W_PhiPW1[Zone] = GRAPH(W_pFW[Zone])
    # W_PhiPW2[Zone] = GRAPH(W_pFW[Zone])
    # W_PhiPW3[Zone] = GRAPH(W_pFW[Zone])
    # W_PhiPW4[Zone] = GRAPH(W_pFW[Zone])
    zonelayerwater_df$W_PhiP <- NA
    zonelayerwater_df[zonelayerwater_df$water == "MS", "W_PhiP"] <- get_y_df(zone_df$W_pFMS, "W_PhiPMS")
    zonelayerwater_df[zonelayerwater_df$water == "MW", "W_PhiP"] <- get_y_df(zone_df$W_pFMW, "W_PhiPMW")
    zonelayerwater_df[zonelayerwater_df$water == "S", "W_PhiP"] <- get_y_df(zone_df$W_pFS, "W_PhiPS")
    zonelayerwater_df[zonelayerwater_df$water == "W", "W_PhiP"] <- get_y_df(zone_df$W_pFW, "W_PhiPW")
    
    
    
    zonelayerwater_df$W_PhiTheta <- rep(zonelayer_df$W_PhiTheta, 4)
    zonelayerwater_df[zonelayerwater_df$water == "W", "W_PhiTheta"] <- maxval #to be neglected when compared with min()
    
    
    # RT_Diam_MS[Zn1,1] = If RT_LrvMS[Zn1,1]> 0 then ((W_FlagCropMS[Zn1]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn1,2] = If RT_LrvMS[Zn1,1]> 0 then ((W_FlagCropMS[Zn1]*RT_CLrv2[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn1,3] = If RT_LrvMS[Zn1,1]> 0 then ((W_FlagCropMS[Zn1]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn1,4] = If RT_LrvMS[Zn1,1]> 0 then ((W_FlagCropMS[Zn1]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMS[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn2,1] = If RT_LrvMS[Zn2,1]> 0 then ((W_FlagCropMS[Zn2]*RT_CLrv1[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn2,2] = If RT_LrvMS[Zn2,1]> 0 then ((W_FlagCropMS[Zn2]*RT_CLrv2[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn2,3] = If RT_LrvMS[Zn2,1]> 0 then ((W_FlagCropMS[Zn2]*RT_CLrv3[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn2,4] = If RT_LrvMS[Zn2,1]> 0 then ((W_FlagCropMS[Zn2]*RT_CLrv4[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMS[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn3,1] = If RT_LrvMS[Zn3,1]> 0 then ((W_FlagCropMS[Zn3]*RT_CLrv1[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn3,2] = If RT_LrvMS[Zn3,1]> 0 then ((W_FlagCropMS[Zn3]*RT_CLrv2[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn3,3] = If RT_LrvMS[Zn3,1]> 0 then ((W_FlagCropMS[Zn3]*RT_CLrv3[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn3,4] = If RT_LrvMS[Zn3,1]> 0 then ((W_FlagCropMS[Zn3]*RT_CLrv4[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMS[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn4,1] = If RT_LrvMS[Zn4,1]> 0 then ((W_FlagCropMS[Zn4]*RT_CLrv1[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn4,2] = If RT_LrvMS[Zn4,1]> 0 then ((W_FlagCropMS[Zn4]*RT_CLrv2[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn4,3] = If RT_LrvMS[Zn4,1]> 0 then ((W_FlagCropMS[Zn4]*RT_CLrv3[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MS[Zn4,4] = If RT_LrvMS[Zn4,1]> 0 then ((W_FlagCropMS[Zn4]*RT_CLrv4[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMS[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMS[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMS[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn1,1] = If RT_LrvMW[Zn1,1]> 0 then ((W_FlagCropMW[Zn1]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn1,2] = If RT_LrvMW[Zn1,1]> 0 then ((W_FlagCropMW[Zn1]*RT_CLrv2[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn1,3] = If RT_LrvMW[Zn1,1]> 0 then ((W_FlagCropMW[Zn1]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn1,4] = If RT_LrvMW[Zn1,1]> 0 then ((W_FlagCropMW[Zn1]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeMW[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn2,1] = If RT_LrvMW[Zn2,1]> 0 then ((W_FlagCropMW[Zn2]*RT_CLrv1[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn2,2] = If RT_LrvMW[Zn2,1]> 0 then ((W_FlagCropMW[Zn2]*RT_CLrv2[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn2,3] = If RT_LrvMW[Zn2,1]> 0 then ((W_FlagCropMW[Zn2]*RT_CLrv3[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn2,4] = If RT_LrvMW[Zn2,1]> 0 then ((W_FlagCropMW[Zn2]*RT_CLrv4[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeMW[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn3,1] = If RT_LrvMW[Zn3,1]> 0 then ((W_FlagCropMW[Zn3]*RT_CLrv1[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn3,2] = If RT_LrvMW[Zn3,1]> 0 then ((W_FlagCropMW[Zn3]*RT_CLrv2[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn3,3] = If RT_LrvMW[Zn3,1]> 0 then ((W_FlagCropMW[Zn3]*RT_CLrv3[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn3,4] = If RT_LrvMW[Zn3,1]> 0 then ((W_FlagCropMW[Zn3]*RT_CLrv4[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeMW[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn4,1] = If RT_LrvMW[Zn4,1]> 0 then ((W_FlagCropMW[Zn4]*RT_CLrv1[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn4,2] = If RT_LrvMW[Zn4,1]> 0 then ((W_FlagCropMW[Zn4]*RT_CLrv2[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn4,3] = If RT_LrvMW[Zn4,1]> 0 then ((W_FlagCropMW[Zn4]*RT_CLrv3[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_MW[Zn4,4] = If RT_LrvMW[Zn4,1]> 0 then ((W_FlagCropMW[Zn4]*RT_CLrv4[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeMW[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeMW[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeMW[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvMW[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn1,1] = If RT_LrvS[Zn1,1]> 0 then  ((W_FlagCropS[Zn1]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeS[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn1,2] = If RT_LrvS[Zn1,1]> 0 then  ((W_FlagCropS[Zn1]*RT_CLrv2[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeS[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn1,3] = If RT_LrvS[Zn1,1]> 0 then  ((W_FlagCropS[Zn1]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeS[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn1,4] = If RT_LrvS[Zn1,1]> 0 then  ((W_FlagCropS[Zn1]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeS[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn2,1] = If RT_LrvS[Zn2,1]> 0 then  ((W_FlagCropS[Zn2]*RT_CLrv1[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeS[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn2,2] = If RT_LrvS[Zn2,1]> 0 then  ((W_FlagCropS[Zn2]*RT_CLrv2[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeS[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn2,3] = If RT_LrvS[Zn2,1]> 0 then  ((W_FlagCropS[Zn2]*RT_CLrv3[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeS[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn2,4] = If RT_LrvS[Zn2,1]> 0 then  ((W_FlagCropS[Zn2]*RT_CLrv4[Zn2]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeS[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn3,1] = If RT_LrvS[Zn3,1]> 0 then  ((W_FlagCropS[Zn3]*RT_CLrv1[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeS[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn3,2] = If RT_LrvS[Zn3,1]> 0 then  ((W_FlagCropS[Zn3]*RT_CLrv2[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeS[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn3,3] = If RT_LrvS[Zn3,1]> 0 then  ((W_FlagCropS[Zn3]*RT_CLrv3[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeS[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn3,4] = If RT_LrvS[Zn3,1]> 0 then  ((W_FlagCropS[Zn3]*RT_CLrv4[Zn3]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeS[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn4,1] = If RT_LrvS[Zn4,1]> 0 then  ((W_FlagCropS[Zn4]*RT_CLrv1[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeS[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn4,2] = If RT_LrvS[Zn4,1]> 0 then  ((W_FlagCropS[Zn4]*RT_CLrv2[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeS[Zn4,Sp1]*RT_TLrv2[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn4,Sp2]*RT_TLrv2[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn4,Sp3]*RT_TLrv2[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn4,3] = If RT_LrvS[Zn4,1]> 0 then  ((W_FlagCropS[Zn4]*RT_CLrv3[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeS[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_S[Zn4,4] = If RT_LrvS[Zn4,1]> 0 then  ((W_FlagCropS[Zn4]*RT_CLrv4[Zn4]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeS[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeS[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeS[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvS[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn1,1] = If RT_LrvW[Zn1,1]> 0 then  ((W_FlagCropW[Zn1]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeW[Zn1,Sp1]*RT_TLrv1[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn1,Sp2]*RT_TLrv1[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn1,Sp3]*RT_TLrv1[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn1,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn1,2] = If RT_LrvW[Zn1,2]> 0 then  ((W_FlagCropW[Zn1]*RT_CLrv2[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeW[Zn1,Sp1]*RT_TLrv2[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn1,Sp2]*RT_TLrv2[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn1,Sp3]*RT_TLrv2[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn1,2])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn1,3] = If RT_LrvW[Zn1,3]> 0 then  ((W_FlagCropW[Zn1]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeW[Zn1,Sp1]*RT_TLrv3[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn1,Sp2]*RT_TLrv3[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn1,Sp3]*RT_TLrv3[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn1,3])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn1,4] = If RT_LrvW[Zn1,4]> 0 then  ((W_FlagCropW[Zn1]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn1])+W_FlagTreeW[Zn1,Sp1]*RT_TLrv4[Zn1,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn1,Sp2]*RT_TLrv4[Zn1,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn1,Sp3]*RT_TLrv4[Zn1,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn1,4])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn2,1] = If RT_LrvW[Zn2,1]> 0 then  ((W_FlagCropW[Zn2]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeW[Zn2,Sp1]*RT_TLrv1[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn2,Sp2]*RT_TLrv1[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn2,Sp3]*RT_TLrv1[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn2,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn2,2] = If RT_LrvW[Zn2,2]> 0 then  ((W_FlagCropW[Zn2]*RT_CLrv2[Zn1]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeW[Zn2,Sp1]*RT_TLrv2[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn2,Sp2]*RT_TLrv2[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn2,Sp3]*RT_TLrv2[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn2,2])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn2,3] = If RT_LrvW[Zn2,3]> 0 then  ((W_FlagCropW[Zn2]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeW[Zn2,Sp1]*RT_TLrv3[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn2,Sp2]*RT_TLrv3[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn2,Sp3]*RT_TLrv3[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn2,3])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn2,4] = If RT_LrvW[Zn2,4]> 0 then  ((W_FlagCropW[Zn2]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn2])+W_FlagTreeW[Zn2,Sp1]*RT_TLrv4[Zn2,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn2,Sp2]*RT_TLrv4[Zn2,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn2,Sp3]*RT_TLrv4[Zn2,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn2,4])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn3,1] = If RT_LrvW[Zn3,1]> 0 then  ((W_FlagCropW[Zn3]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeW[Zn3,Sp1]*RT_TLrv1[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn3,Sp2]*RT_TLrv1[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn3,Sp3]*RT_TLrv1[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn3,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn3,2] = If RT_LrvW[Zn3,2]> 0 then  ((W_FlagCropW[Zn3]*RT_CLrv2[Zn1]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeW[Zn3,Sp1]*RT_TLrv2[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn3,Sp2]*RT_TLrv2[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn3,Sp3]*RT_TLrv2[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn3,2])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn3,3] = If RT_LrvW[Zn3,3]> 0 then  ((W_FlagCropW[Zn3]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeW[Zn3,Sp1]*RT_TLrv3[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn3,Sp2]*RT_TLrv3[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn3,Sp3]*RT_TLrv3[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn3,3])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn3,4] = If RT_LrvW[Zn3,4]> 0 then  ((W_FlagCropW[Zn3]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn3])+W_FlagTreeW[Zn3,Sp1]*RT_TLrv4[Zn3,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn3,Sp2]*RT_TLrv4[Zn3,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn3,Sp3]*RT_TLrv4[Zn3,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn3,4])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn4,1] = If RT_LrvW[Zn4,1]> 0 then  ((W_FlagCropW[Zn4]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeW[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn4,1])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn4,2] = If RT_LrvW[Zn4,2]> 0 then  ((W_FlagCropW[Zn4]*RT_CLrv1[Zn1]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeW[Zn4,Sp1]*RT_TLrv1[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn4,Sp2]*RT_TLrv1[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn4,Sp3]*RT_TLrv1[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn4,2])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn4,3] = If RT_LrvW[Zn4,3]> 0 then  ((W_FlagCropW[Zn4]*RT_CLrv3[Zn1]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeW[Zn4,Sp1]*RT_TLrv3[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn4,Sp2]*RT_TLrv3[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn4,Sp3]*RT_TLrv3[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn4,3])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    # RT_Diam_W[Zn4,4] = If RT_LrvW[Zn4,4]> 0 then  ((W_FlagCropW[Zn4]*RT_CLrv4[Zn1]*SQRT(CQ_RtDiam[Zn4])+W_FlagTreeW[Zn4,Sp1]*RT_TLrv4[Zn4,Sp1]*SQRT(RT_TDiam[Sp1])+W_FlagTreeW[Zn4,Sp2]*RT_TLrv4[Zn4,Sp2]*SQRT(RT_TDiam[Sp2])+W_FlagTreeW[Zn4,Sp3]*RT_TLrv4[Zn4,Sp3]*SQRT(RT_TDiam[Sp3]))/RT_LrvW[Zn4,4])^2 else RT_Stopgap + 0*(RT_CLrv1[Zn1]+RT_CLrv2[Zn1]+RT_CLrv3[Zn1]+RT_CLrv4[Zn1])+0*(RT_TLrv1[Zn1,Sp1]+RT_TLrv2[Zn1,Sp1]+RT_TLrv3[Zn1,Sp1]+RT_TLrv4[Zn1,Sp1])
    
    
    zonelayertreewater_df$RT_TDiam <- rep(zonelayertree_df$RT_TDiam, nwater)
    zonelayertreewater_df$RT_vol_flag <- zonelayertreewater_df$W_FlagTree * zonelayertreewater_df$RT_TLrv * sqrt(zonelayertreewater_df$RT_TDiam)
    zonelayerwater_df$RT_vol_flag_sum <- aggregate(zonelayertreewater_df["RT_vol_flag"], zonelayertreewater_df[c("zone", "layer", "water")], sum)$RT_vol_flag
    
    zonelayerwater_df$CQ_RtDiam <- rep(zone_df$CQ_RtDiam, nlayer * nwater)
    
    zonelayerwater_df$RT_Diam <- ifelse(zonelayerwater_df$RT_Lrv > 0,
                                        ((
                                          zonelayerwater_df$W_FlagCrop * zonelayerwater_df$RT_CLrv * sqrt(zonelayerwater_df$CQ_RtDiam) +
                                            zonelayerwater_df$RT_vol_flag_sum
                                        ) / zonelayerwater_df$RT_Lrv
                                        )^2,
                                        RT_StopGap)
    
    
    # RT_Rho_MS[Zone,SoilLayer] = if RT_LrvMS[Zone,SoilLayer] > 0 and RT_Diam_MS[Zone,SoilLayer]>0 then 1/(((PI*RT_LrvMS[Zone,SoilLayer])^0.5)*0.5*RT_Diam_MS[Zone,SoilLayer]) else RT_StopGap
    # RT_Rho_MW[Zone,SoilLayer] = if RT_LrvMW[Zone,SoilLayer] > 0 and RT_Diam_MW[Zone,SoilLayer]>0 then 1/(((PI*RT_LrvMW[Zone,SoilLayer])^0.5)*0.5*RT_Diam_MW[Zone,SoilLayer]) else RT_StopGap
    # RT_Rho_S[Zone,SoilLayer] = if RT_LrvS[Zone,SoilLayer] > 0 and RT_Diam_S[Zone,SoilLayer]>0 then 1/(((PI*RT_LrvS[Zone,SoilLayer])^0.5)*0.5*RT_Diam_S[Zone,SoilLayer]) else RT_StopGap
    # RT_Rho_W[Zone,SoilLayer] = if RT_LrvW[Zone,SoilLayer] > 0 and RT_Diam_W[Zone,SoilLayer]>0 then 1/(((PI*RT_LrvW[Zone,SoilLayer])^0.5)*0.5*RT_Diam_W[Zone,SoilLayer]) else RT_StopGap
    
    zonelayerwater_df$RT_Rho <- ifelse(
      zonelayerwater_df$RT_Lrv > 0 & zonelayerwater_df$RT_Diam > 0,
      1 / (((
        pi * zonelayerwater_df$RT_Lrv
      )^0.5) * 0.5 * zonelayerwater_df$RT_Diam),
      RT_StopGap
    )
    
    # RT_GMS[Zone,SoilLayer] = if RT_Rho_MS[Zone,SoilLayer] <> RT_StopGap then (RT_Rho_MS[Zone,SoilLayer]^2-1)/(0.5*(((1-(3*RT_Rho_MS[Zone,SoilLayer]^2))/4)+((RT_Rho_MS[Zone,SoilLayer]^4*LOGN(RT_Rho_MS[Zone,SoilLayer]))/(RT_Rho_MS[Zone,SoilLayer]^2-1)))) else RT_StopGap
    # RT_GMW[Zone,SoilLayer] = if RT_Rho_MW[Zone,SoilLayer] <> RT_StopGap then (RT_Rho_MW[Zone,SoilLayer]^2-1)/(0.5*(((1-(3*RT_Rho_MW[Zone,SoilLayer]^2))/4)+((RT_Rho_MW[Zone,SoilLayer]^4*LOGN(RT_Rho_MW[Zone,SoilLayer]))/(RT_Rho_MW[Zone,SoilLayer]^2-1)))) else RT_StopGap
    # RT_GS[Zone,SoilLayer]  = if RT_Rho_S[Zone,SoilLayer]  <> RT_StopGap then (RT_Rho_S[Zone,SoilLayer]^2-1) /(0.5*(((1-(3*RT_Rho_S[Zone,SoilLayer]^2))/4)+((RT_Rho_S[Zone,SoilLayer]^4*LOGN(RT_Rho_S[Zone,SoilLayer]))/(RT_Rho_S[Zone,SoilLayer]^2-1)))) else RT_StopGap
    # RT_GW[Zone,SoilLayer]  = if RT_Rho_W[Zone,SoilLayer]  <> RT_StopGap then (RT_Rho_W[Zone,SoilLayer]^2-1) /(0.5*(((1-(3*RT_Rho_W[Zone,SoilLayer]^2))/4)+((RT_Rho_W[Zone,SoilLayer]^4*LOGN(RT_Rho_W[Zone,SoilLayer]))/(RT_Rho_W[Zone,SoilLayer]^2-1)))) else RT_StopGap
    
    zonelayerwater_df$RT_G <- ifelse(
      zonelayerwater_df$RT_Rho != RT_StopGap,
      (zonelayerwater_df$RT_Rho^2 - 1) / (0.5 * (((
        1 - (3 * zonelayerwater_df$RT_Rho^2)
      ) / 4) + ((
        zonelayerwater_df$RT_Rho^4 * log(zonelayerwater_df$RT_Rho)
      ) /
        (zonelayerwater_df$RT_Rho^2 - 1)
      ))),
      RT_StopGap
    )
    
    
    # W_PotUptMS1[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMS[Zone,1]>0 THEN min(W_Theta1_MS_MW[Zone],10*PI*100*AF_DepthAct1[Zone]*(max(0,+min(W_PhiPMW1[Zone],W_PhiTheta1[Zone])-W_PhiPMS1[Zone]))*RT_GMS[Zone,1]*RT_LrvMS[Zone,1]) ELSE 0 else IF RT_LrvMS[Zone,1]>0 THEN 10*PI*100*AF_DepthAct1[Zone]*(max(0,+min(W_PhiPMW1[Zone],W_PhiTheta1[Zone])-W_PhiPMS1[Zone]))*RT_GMS[Zone,1]*RT_LrvMS[Zone,1] ELSE 0
    # W_PotUptMS2[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMS[Zone,2]>0 THEN min(W_Theta2_MS_MW[Zone],10*PI*100*AF_Depth2[Zone]*(max(0,+min(W_PhiPMW2[Zone],W_PhiTheta2[Zone])-W_PhiPMS2[Zone]))*RT_GMS[Zone,2]*RT_LrvMS[Zone,2]) ELSE 0 else IF RT_LrvMS[Zone,2]>0 THEN 10*PI*100*AF_Depth2[Zone]*(max(0,+min(W_PhiPMW2[Zone],W_PhiTheta2[Zone])-W_PhiPMS2[Zone]))*RT_GMS[Zone,2]*RT_LrvMS[Zone,2] ELSE 0
    # W_PotUptMS3[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMS[Zone,3]>0 THEN min(W_Theta3_MS_MW[Zone],10*PI*100*AF_Depth3[Zone]*(max(0,+min(W_PhiPMW3[Zone],W_PhiTheta3[Zone])-W_PhiPMS3[Zone]))*RT_GMS[Zone,3]*RT_LrvMS[Zone,3]) ELSE 0 else IF RT_LrvMS[Zone,3]>0 THEN 10*PI*100*AF_Depth3[Zone]*(max(0,+min(W_PhiPMW3[Zone],W_PhiTheta3[Zone])-W_PhiPMS3[Zone]))*RT_GMS[Zone,3]*RT_LrvMS[Zone,3] ELSE 0
    # W_PotUptMS4[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMS[Zone,4]>0 THEN min(W_Theta4_MS_MW[Zone],10*PI*100*AF_Depth4[Zone]*(max(0,+min(W_PhiPMW4[Zone],W_PhiTheta4[Zone])-W_PhiPMS4[Zone]))*RT_GMS[Zone,4]*RT_LrvMS[Zone,4]) ELSE 0 else IF RT_LrvMS[Zone,4]>0 THEN 10*PI*100*AF_Depth4[Zone]*(max(0,+min(W_PhiPMW4[Zone],W_PhiTheta4[Zone])-W_PhiPMS4[Zone]))*RT_GMS[Zone,4]*RT_LrvMS[Zone,4] ELSE 0
    # W_PotUptMW1[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMW[Zone,1]>0 THEN min(W_Theta1_MW_W[Zone],10*PI*100*AF_DepthAct1[Zone]*(max(0,+min(W_PhiPW1[Zone],W_PhiTheta1[Zone])-W_PhiPMW1[Zone]))*RT_GMW[Zone,1]*RT_LrvMW[Zone,1]) ELSE 0 else IF RT_LrvMW[Zone,1]>0 THEN 10*PI*100*AF_DepthAct1[Zone]*(max(0,+min(W_PhiPW1[Zone],W_PhiTheta1[Zone])-W_PhiPMW1[Zone]))*RT_GMW[Zone,1]*RT_LrvMW[Zone,1] ELSE 0
    # W_PotUptMW2[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMW[Zone,2]>0 THEN min(W_Theta2_MW_W[Zone],10*PI*100*AF_Depth2[Zone]*(max(0,+min(W_PhiPW2[Zone],W_PhiTheta2[Zone])-W_PhiPMW2[Zone]))*RT_GMW[Zone,2]*RT_LrvMW[Zone,2]) ELSE 0 else IF RT_LrvMW[Zone,2]>0 THEN 10*PI*100*AF_Depth2[Zone]*(max(0,+min(W_PhiPW2[Zone],W_PhiTheta2[Zone])-W_PhiPMW2[Zone]))*RT_GMW[Zone,2]*RT_LrvMW[Zone,2] ELSE 0
    # W_PotUptMW3[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMW[Zone,3]>0 THEN min(W_Theta3_MW_W[Zone],10*PI*100*AF_Depth3[Zone]*(max(0,+min(W_PhiPW3[Zone],W_PhiTheta3[Zone])-W_PhiPMW3[Zone]))*RT_GMW[Zone,3]*RT_LrvMW[Zone,3]) ELSE 0 else IF RT_LrvMW[Zone,3]>0 THEN 10*PI*100*AF_Depth3[Zone]*(max(0,+min(W_PhiPW3[Zone],W_PhiTheta3[Zone])-W_PhiPMW3[Zone]))*RT_GMW[Zone,3]*RT_LrvMW[Zone,3] ELSE 0
    # W_PotUptMW4[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvMW[Zone,4]>0 THEN min(W_Theta4_MW_W[Zone],10*PI*100*AF_Depth4[Zone]*(max(0,+min(W_PhiPW4[Zone],W_PhiTheta4[Zone])-W_PhiPMW4[Zone]))*RT_GMW[Zone,4]*RT_LrvMW[Zone,4]) ELSE 0 else IF RT_LrvMW[Zone,4]>0 THEN 10*PI*100*AF_Depth4[Zone]*(max(0,+min(W_PhiPW4[Zone],W_PhiTheta4[Zone])-W_PhiPMW4[Zone]))*RT_GMW[Zone,4]*RT_LrvMW[Zone,4] ELSE 0
    # W_PotUptS1[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvS[Zone,1]>0 THEN min(W_Theta1S_MS[Zone], 10*PI*100*AF_DepthAct1[Zone]*(max(0,min(W_PhiPMS1[Zone],W_PhiTheta1[Zone])-W_PhiPS1[Zone]))*RT_GS[Zone,1]*RT_LrvS[Zone,1]) ELSE 0 else IF RT_LrvS[Zone,1]>0 THEN  10*PI*100*AF_DepthAct1[Zone]*(max(0,min(W_PhiPMS1[Zone],W_PhiTheta1[Zone])-W_PhiPS1[Zone]))*RT_GS[Zone,1]*RT_LrvS[Zone,1] ELSE 0
    # W_PotUptS2[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvS[Zone,2]>0 THEN min(W_Theta2_S_MS[Zone], 10*PI*100*AF_Depth2[Zone]*(max(0,min(W_PhiPMS2[Zone],W_PhiTheta2[Zone])-W_PhiPS2[Zone]))*RT_GS[Zone,2]*RT_LrvS[Zone,2]) ELSE 0 else IF RT_LrvS[Zone,2]>0 THEN 10*PI*100*AF_Depth2[Zone]*(max(0,min(W_PhiPMS2[Zone],W_PhiTheta2[Zone])-W_PhiPS2[Zone]))*RT_GS[Zone,2]*RT_LrvS[Zone,2] ELSE 0
    # W_PotUptS3[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvS[Zone,3]>0 THEN min(W_Theta3_S_MS[Zone], 10*PI*100*AF_Depth3[Zone]*(max(0,min(W_PhiPMS3[Zone],W_PhiTheta3[Zone])-W_PhiPS3[Zone]))*RT_GS[Zone,3]*RT_LrvS[Zone,3]) ELSE 0 else IF RT_LrvS[Zone,3]>0 THEN  10*PI*100*AF_Depth3[Zone]*(max(0,min(W_PhiPMS3[Zone],W_PhiTheta3[Zone])-W_PhiPS3[Zone]))*RT_GS[Zone,3]*RT_LrvS[Zone,3] ELSE 0
    # W_PotUptS4[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvS[Zone,4]>0 THEN min(W_Theta4_S_MS[Zone], 10*PI*100*AF_Depth4[Zone]*(max(0,min(W_PhiPMS4[Zone],W_PhiTheta4[Zone])-W_PhiPS4[Zone]))*RT_GS[Zone,4]*RT_LrvS[Zone,4]) ELSE 0 else IF RT_LrvS[Zone,4]>0 THEN  10*PI*100*AF_Depth4[Zone]*(max(0,min(W_PhiPMS4[Zone],W_PhiTheta4[Zone])-W_PhiPS4[Zone]))*RT_GS[Zone,4]*RT_LrvS[Zone,4] ELSE 0
    # W_PotUptW1[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvW[Zone,1]>0 THEN min(W_Theta1_W_Soil[Zone],10*PI*100*AF_DepthAct1[Zone]*(max(0,+W_PhiTheta1[Zone]-W_PhiPW1[Zone]))*RT_GW[Zone,1]*RT_LrvW[Zone,1]) ELSE 0 else IF RT_LrvW[Zone,1]>0 THEN 10*PI*100*AF_DepthAct1[Zone]*(max(0,+W_PhiTheta1[Zone]-W_PhiPW1[Zone]))*RT_GW[Zone,1]*RT_LrvW[Zone,1] ELSE 0
    # W_PotUptW2[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvW[Zone,2]>0 THEN min(W_Theta2_W_Soil[Zone],10*PI*100*AF_Depth2[Zone]*(max(0,+W_PhiTheta2[Zone]-W_PhiPW2[Zone]))*RT_GW[Zone,2]*RT_LrvW[Zone,2]) ELSE 0 else IF RT_LrvW[Zone,2]>0 THEN 10*PI*100*AF_Depth2[Zone]*(max(0,+W_PhiTheta2[Zone]-W_PhiPW2[Zone]))*RT_GW[Zone,2]*RT_LrvW[Zone,2] ELSE 0
    # W_PotUptW3[Zone] = if W_WaterLimited?[Zone]=1 then IF RT_LrvW[Zone,3]>0 THEN min(W_Theta3_W_Soil[Zone],10*PI*100*AF_Depth3[Zone]*(max(0,+W_PhiTheta3[Zone]-W_PhiPW3[Zone]))*RT_GW[Zone,3]*RT_LrvW[Zone,3]) ELSE 0 else IF RT_LrvW[Zone,3]>0 THEN 10*PI*100*AF_Depth3[Zone]*(max(0,+W_PhiTheta3[Zone]-W_PhiPW3[Zone]))*RT_GW[Zone,3]*RT_LrvW[Zone,3] ELSE 0
    # W_PotUptW4[Zone] = IF W_WaterLimited?[Zone]=1 then IF RT_LrvW[Zone,2]>0 THEN min(W_Theta4_W_Soil[Zone],10*PI*100*AF_Depth4[Zone]*(max(0,+W_PhiTheta4[Zone]-W_PhiPW4[Zone]))*RT_GW[Zone,4]*RT_LrvW[Zone,4]) ELSE 0 else IF RT_LrvW[Zone,2]>0 THEN 10*PI*100*AF_Depth4[Zone]*(max(0,+W_PhiTheta4[Zone]-W_PhiPW4[Zone]))*RT_GW[Zone,4]*RT_LrvW[Zone,4] ELSE 0
    zonelayerwater_df$W_WaterLimited_is <- rep(zone_df$W_WaterLimited_is, nlayer)
    
    zonelayerwater_df$W_PhiP_x <- c(
      zonelayerwater_df[zonelayerwater_df$water == "MW", "W_PhiP"],
      zonelayerwater_df[zonelayerwater_df$water == "W", "W_PhiP"],
      zonelayerwater_df[zonelayerwater_df$water == "MS", "W_PhiP"],
      rep(maxval, nzone * nlayer)
    )
    zonelayerwater_df$W_PotUpt_a <- 10 * pi * 100 * zonelayerwater_df$AF_Depth * (pmax(
      0,
      pmin(
        zonelayerwater_df$W_PhiP_x,
        zonelayerwater_df$W_PhiTheta
      ) - zonelayerwater_df$W_PhiP
    )) * zonelayerwater_df$RT_G * zonelayerwater_df$RT_Lrv
    
    zonelayerwater_df$W_PotUpt <- ifelse(
      zonelayerwater_df$W_WaterLimited_is == 1,
      ifelse(
        zonelayerwater_df$RT_Lrv > 0,
        pmin(
          zonelayerwater_df$W_Theta_water_pair,
          zonelayerwater_df$W_PotUpt_a
        ),
        0
      ),
      ifelse(
        zonelayerwater_df$RT_Lrv > 0,
        zonelayerwater_df$W_PotUpt_a,
        0
      )
    )
    
    # W_CUptPot1[Zone] = RT_CLrv1[Zone]*(W_FlagCropS[Zone]*W_PotUptS1[Zone]+W_FlagCropMS[Zone]*W_PotUptMS1[Zone]+W_FlagCropMW[Zone]*W_PotUptMW1[Zone]+W_FlagCropW[Zone]*W_PotUptW1[Zone])
    # W_CUptPot2[Zone] = RT_CLrv2[Zone]*(W_FlagCropS[Zone]*W_PotUptS2[Zone]+W_FlagCropMS[Zone]*W_PotUptMS2[Zone]+W_FlagCropMW[Zone]*W_PotUptMW2[Zone]+W_FlagCropW[Zone]*W_PotUptW2[Zone])
    # W_CUptPot3[Zone] = RT_CLrv3[Zone]*(W_FlagCropS[Zone]*W_PotUptS3[Zone]+W_FlagCropMS[Zone]*W_PotUptMS3[Zone]+W_FlagCropMW[Zone]*W_PotUptMW3[Zone]+W_FlagCropW[Zone]*W_PotUptW3[Zone])
    # W_CUptPot4[Zone] = RT_CLrv4[Zone]*(W_FlagCropS[Zone]*W_PotUptS4[Zone]+W_FlagCropMS[Zone]*W_PotUptMS4[Zone]+W_FlagCropMW[Zone]*W_PotUptMW4[Zone]+W_FlagCropW[Zone]*W_PotUptW4[Zone])
    
    zonelayerwater_df$W_PotUpt_flagC <- zonelayerwater_df$W_FlagCrop * zonelayerwater_df$W_PotUpt
    zonelayer_df$W_PotUpt_flagC_sum <- aggregate(zonelayerwater_df["W_PotUpt_flagC"], zonelayerwater_df[c("zone", "layer")], sum)$W_PotUpt_flagC
    zonelayer_df$W_CUptPot <- zonelayer_df$RT_CLrv * zonelayer_df$W_PotUpt_flagC_sum
    
    
    # W_TUptPot1[Zone,Tree] = RT_TLrv1[Zone,Tree]*(W_FlagTreeS[Zone,Tree]*W_PotUptS1[Zone]+W_FlagTreeMS[Zone,Tree]*W_PotUptMS1[Zone]+W_FlagTreeMW[Zone,Tree]*W_PotUptMW1[Zone]+W_FlagTreeW[Zone,Tree]*W_PotUptW1[Zone])
    # W_TUptPot2[Zone,Tree] = RT_TLrv2[Zone,Tree]*(W_FlagTreeS[Zone,Tree]*W_PotUptS2[Zone]+W_FlagTreeMS[Zone,Tree]*W_PotUptMS2[Zone]+W_FlagTreeMW[Zone,Tree]*W_PotUptMW2[Zone]+W_FlagTreeW[Zone,Tree]*W_PotUptW2[Zone])
    # W_TUptPot3[Zone,Tree] = RT_TLrv3[Zone,Tree]*(W_FlagTreeS[Zone,Tree]*W_PotUptS3[Zone]+W_FlagTreeMS[Zone,Tree]*W_PotUptMS3[Zone]+W_FlagTreeMW[Zone,Tree]*W_PotUptMW3[Zone]+W_FlagTreeW[Zone,Tree]*W_PotUptW3[Zone])
    # W_TUptPot4[Zone,Tree] = RT_TLrv4[Zone,Tree]*(W_FlagTreeS[Zone,Tree]*W_PotUptS4[Zone]+W_FlagTreeMS[Zone,Tree]*W_PotUptMS4[Zone]+W_FlagTreeMW[Zone,Tree]*W_PotUptMW4[Zone]+W_FlagTreeW[Zone,Tree]*W_PotUptW4[Zone])
    
    
    # add tree index of array
    df <- zonelayerwater_df[c("zone", "layer", "water", "W_PotUpt")]
    t_df <- df[rep(seq_len(nrow(df)), ntree), ]
    t_df$tree_id <- rep(tree_df$tree_id, each = nrow(zonelayerwater_df))
    t_df <- t_df[order(t_df$water, t_df$tree_id, t_df$layer, t_df$zone), ]
    zonelayertreewater_df$W_PotUpt <- t_df$W_PotUpt
    
    zonelayertreewater_df$W_PotUpt_flagT <- zonelayertreewater_df$W_FlagTree * zonelayertreewater_df$W_PotUpt
    
    zonelayertree_df$W_PotUpt_flagT_sum <- aggregate(zonelayertreewater_df["W_PotUpt_flagT"], zonelayertreewater_df[c("zone", "layer", "tree_id")], sum)$W_PotUpt_flagT
    zonelayertree_df$W_TUptPot <- zonelayertree_df$RT_TLrv * zonelayertree_df$W_PotUpt_flagT_sum
    
    # W_CUptPotAct1[Zone] = IF W_StockAcc1[Zone]>0 then if (W_CUptPot1[Zone]+ARRAYSUM(W_TUptPot1[Zone,*]))>W_StockAcc1[Zone] then (W_StockAcc1[Zone]*W_CUptPot1[Zone]/(W_CUptPot1[Zone]+ARRAYSUM(W_TUptPot1[Zone,*]))) ELSE W_CUptPot1[Zone] ELSE 0
    # W_CUptPotAct2[Zone] = IF(W_StockAcc2[Zone]>0)THEN IF (W_CUptPot2[Zone]+ARRAYSUM(W_TUptPot2[Zone,*]))>0 THEN IF (W_CUptPot2[Zone]+ARRAYSUM(W_TUptPot2[Zone,*]))>W_StockAcc2[Zone] THEN (W_StockAcc2[Zone]*W_CUptPot2[Zone]/(W_CUptPot2[Zone]+ARRAYSUM(W_TUptPot2[Zone,*])))ELSE(W_CUptPot2[Zone])ELSE(0)ELSE(0)
    # W_CUptPotAct3[Zone] = IF(W_StockAcc3[Zone]>0)THEN IF (W_CUptPot3[Zone]+ARRAYSUM(W_TUptPot3[Zone,*]))>0 THEN IF (W_CUptPot3[Zone]+ARRAYSUM(W_TUptPot3[Zone,*]))>W_StockAcc3[Zone] THEN (W_StockAcc3[Zone]*W_CUptPot3[Zone]/(W_CUptPot3[Zone]+ARRAYSUM(W_TUptPot3[Zone,*])))ELSE(W_CUptPot3[Zone])ELSE(0)ELSE(0)
    # W_CUptPotAct4[Zone] = IF(W_StockAcc4[Zone]>0)THEN IF (W_CUptPot4[Zone]+ARRAYSUM(W_TUptPot4[Zone,*]))>0 THEN IF (W_CUptPot4[Zone]+ARRAYSUM(W_TUptPot4[Zone,*]))>W_StockAcc4[Zone] THEN (W_StockAcc4[Zone]*W_CUptPot4[Zone]/(W_CUptPot4[Zone]+ARRAYSUM(W_TUptPot4[Zone,*])))ELSE(W_CUptPot4[Zone])ELSE(0)ELSE(0)
    
    zonelayer_df$W_TUptPot_sum <- aggregate(zonelayertree_df["W_TUptPot"], zonelayertree_df[c("zone", "layer")], sum)$W_TUptPot
    zonelayer_df$W_CTUptPot_sum <- zonelayer_df$W_CUptPot + zonelayer_df$W_TUptPot_sum
    zonelayer_df$W_CUptPotAct <- ifelse(
      zonelayer_df$W_StockAcc > 0,
      ifelse(
        zonelayer_df$W_CTUptPot_sum > 0,
        ifelse(
          zonelayer_df$W_CTUptPot_sum > zonelayer_df$W_StockAcc,
          zonelayer_df$W_StockAcc * zonelayer_df$W_CUptPot / zonelayer_df$W_CTUptPot_sum,
          zonelayer_df$W_CUptPot
        ),
        0
      ),
      0
    )
    
    
    # CW_UptPot[Zone] = W_CUptPotAct1[Zone]+W_CUptPotAct2[Zone]+W_CUptPotAct3[Zone]+W_CUptPotAct4[Zone]
    zone_df$CW_UptPot <- aggregate(zonelayer_df["W_CUptPotAct"], zonelayer_df[c("zone")], sum)$W_CUptPotAct
    
    
    # CW_DemandAct[Zone] = CW_DemandPot[Zone]*CW_DemandRedFac[Zone]
    zone_df$CW_DemandAct <- zone_df$CW_DemandPot * zone_df$CW_DemandRedFac
    
    # CW_UptDeno[Zone] = (W_CUptPotAct1[Zone]*RT_CLrv1[Zone]+RT_CLrv2[Zone]*W_CUptPotAct2[Zone]+RT_CLrv3[Zone]*W_CUptPotAct3[Zone]+RT_CLrv4[Zone]*W_CUptPotAct4[Zone])
    zonelayer_df$CW_UptDeno_a <- zonelayer_df$W_CUptPotAct * zonelayer_df$RT_CLrv
    zone_df$CW_UptDeno <- aggregate(zonelayer_df["CW_UptDeno_a"], zonelayer_df[c("zone")], sum)$CW_UptDeno_a
    
    
    
    
    # W_CUpt1[Zone] = IF(CW_UptPot[Zone]>CW_DemandAct[Zone] and CW_UptDeno[Zone]>0)THEN(CW_DemandAct[Zone]*W_CUptPotAct1[Zone]*RT_CLrv1[Zone]/CW_UptDeno[Zone])ELSE(W_CUptPotAct1[Zone])
    # W_CUpt2[Zone] = if CW_UptPot[Zone]>CW_DemandAct[Zone] and CW_UptDeno[Zone]>0 then(CW_DemandAct[Zone]*W_CUptPotAct2[Zone]*RT_CLrv2[Zone]/CW_UptDeno[Zone])ELSE(W_CUptPotAct2[Zone])
    # W_CUpt3[Zone] = IF(CW_UptPot[Zone]>CW_DemandAct[Zone])and CW_UptDeno[Zone]>0 THEN(CW_DemandAct[Zone]*W_CUptPotAct3[Zone]*RT_CLrv3[Zone]/CW_UptDeno[Zone])ELSE(W_CUptPotAct3[Zone])
    # W_CUpt4[Zone] = IF(CW_UptPot[Zone]>CW_DemandAct[Zone] and CW_UptDeno[Zone]>0)THEN(CW_DemandAct[Zone]*W_CUptPotAct4[Zone]*RT_CLrv4[Zone]/CW_UptDeno[Zone])ELSE(W_CUptPotAct4[Zone])
    
    zonelayer_df$CW_UptPot <- rep(zone_df$CW_UptPot, nlayer)
    zonelayer_df$CW_DemandAct <- rep(zone_df$CW_DemandAct, nlayer)
    zonelayer_df$CW_UptDeno <- rep(zone_df$CW_UptDeno, nlayer)
    
    zonelayer_df$W_CUpt <- ifelse(
      zonelayer_df$CW_UptPot > zonelayer_df$CW_DemandAct &
        zonelayer_df$CW_UptDeno > 0,
      zonelayer_df$CW_DemandAct * zonelayer_df$W_CUptPotAct * zonelayer_df$RT_CLrv / zonelayer_df$CW_UptDeno,
      zonelayer_df$W_CUptPotAct
    )
    
    
    
    # W_TUptPotAct1[Zone,Tree] = IF W_StockAcc1[Zone]>0 then                                                           if (W_CUptPot1[Zone]+ARRAYSUM(W_TUptPot1[Zone,*]))>W_StockAcc1[Zone] then (W_StockAcc1[Zone]*W_TUptPot1[Zone,Tree]/(W_CUptPot1[Zone]+ARRAYSUM(W_TUptPot1[Zone,*])))ELSE W_TUptPot1[Zone,Tree] ELSE 0
    # W_TUptPotAct2[Zone,Tree] = IF(W_StockAcc2[Zone]>0)THEN IF (W_CUptPot2[Zone]+ARRAYSUM(W_TUptPot2[Zone,*]))>0 THEN IF (W_CUptPot2[Zone]+ARRAYSUM(W_TUptPot2[Zone,*]))>W_StockAcc2[Zone] THEN (W_StockAcc2[Zone]*W_TUptPot2[Zone,Tree]/(W_CUptPot2[Zone]+ARRAYSUM(W_TUptPot2[Zone,*])))ELSE(W_TUptPot2[Zone,Tree])ELSE(0)ELSE(0)
    # W_TUptPotAct3[Zone,Tree] = IF(W_StockAcc3[Zone]>0)THEN IF (W_CUptPot3[Zone]+ARRAYSUM(W_TUptPot3[Zone,*]))>0 THEN IF (W_CUptPot3[Zone]+ARRAYSUM(W_TUptPot3[Zone,*]))>W_StockAcc3[Zone] THEN (W_StockAcc3[Zone]*W_TUptPot3[Zone,Tree]/(W_CUptPot3[Zone]+ARRAYSUM(W_TUptPot3[Zone,*])))ELSE(W_TUptPot3[Zone,Tree])ELSE(0)ELSE(0)
    # W_TUptPotAct4[Zone,Tree] = IF(W_StockAcc4[Zone]>0)THEN IF (W_CUptPot4[Zone]+ARRAYSUM(W_TUptPot4[Zone,*]))>0 THEN IF (W_CUptPot4[Zone]+ARRAYSUM(W_TUptPot4[Zone,*]))>W_StockAcc4[Zone] THEN (W_StockAcc4[Zone]*W_TUptPot4[Zone,Tree]/(W_CUptPot4[Zone]+ARRAYSUM(W_TUptPot4[Zone,*])))ELSE(W_TUptPot4[Zone,Tree])ELSE(0)ELSE(0)
    zonelayertree_df$W_StockAcc <- rep(zonelayer_df$W_StockAcc, ntree)
    zonelayertree_df$W_CTUptPot_sum <- rep(zonelayer_df$W_CTUptPot_sum, ntree)
    zonelayertree_df$W_TUptPotAct <- ifelse(
      zonelayertree_df$W_StockAcc > 0,
      ifelse(
        zonelayertree_df$W_CTUptPot_sum > 0,
        ifelse(
          zonelayertree_df$W_CTUptPot_sum > zonelayertree_df$W_StockAcc,
          zonelayertree_df$W_StockAcc * zonelayertree_df$W_TUptPot / zonelayertree_df$W_CTUptPot_sum,
          zonelayertree_df$W_TUptPot
        ),
        0
      ),
      0
    )
    
    # TW_UptDenoZn[Zone,Tree] = (RT_TLrv1[Zone,Tree]*W_TUptPotAct1[Zone,Tree]+RT_TLrv2[Zone,Tree]*W_TUptPotAct2[Zone,Tree]+RT_TLrv3[Zone,Tree]*W_TUptPotAct3[Zone,Tree]+RT_TLrv4[Zone,Tree]*W_TUptPotAct4[Zone,Tree])*AF_ZoneWidth[Zone]
    zonelayertree_df$TW_UptDenoZn_a <- zonelayertree_df$RT_TLrv * zonelayertree_df$W_TUptPotAct
    zonetree_df$TW_UptDenoZn <- aggregate(zonelayertree_df["TW_UptDenoZn_a"], zonelayertree_df[c("zone", "tree_id")], sum)$TW_UptDenoZn_a
    
    # TW_UptDeno[Tree] = ARRAYSUM(TW_UptDenoZn[*,Tree])
    tree_df$TW_UptDeno <- aggregate(zonetree_df["TW_UptDenoZn"], zonetree_df[c("tree_id")], sum)$TW_UptDenoZn
    
    # TW_UptPotZn[Zone,Tree] = AF_ZoneFrac[Zone]*(W_TUptPotAct1[Zone,Tree]+W_TUptPotAct2[Zone,Tree]+W_TUptPotAct3[Zone,Tree]+W_TUptPotAct4[Zone,Tree])
    zonetree_df$TW_UptPotZn <- zonetree_df$AF_ZoneFrac * aggregate(zonelayertree_df["W_TUptPotAct"], zonelayertree_df[c("zone", "tree_id")], sum)$W_TUptPotAct
    
    # TW_UptPot[Tree] = ARRAYSUM(TW_UptPotZn[*,Tree])
    tree_df$TW_UptPot <- aggregate(zonetree_df["TW_UptPotZn"], zonetree_df[c("tree_id")], sum)$TW_UptPotZn
    
    # TW_DemandAct[Tree] = TW_DemandPot[Tree]*TW_DemandRedFac[Tree]
    tree_df$TW_DemandAct <- tree_df$TW_DemandPot * tree_df$TW_DemandRedFac
    
    # W_T1Upt1[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp1]>0) THEN (IF(TW_UptPot[Sp1]>TW_DemandAct[Sp1])THEN (TW_DemandAct[Sp1]/AF_ZoneFrac[Zone]*W_TUptPotAct1[Zone,Sp1]*RT_TLrv1[Zone,Sp1]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp1])ELSE(W_TUptPotAct1[Zone,Sp1]))ELSE(0)
    # W_T2Upt1[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp2]>0) THEN (IF(TW_UptPot[Sp2]>TW_DemandAct[Sp2])THEN (TW_DemandAct[Sp2]/AF_ZoneFrac[Zone]*W_TUptPotAct1[Zone,Sp2]*RT_TLrv1[Zone,Sp2]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp2])ELSE(W_TUptPotAct1[Zone,Sp2]))ELSE(0)
    # W_T3Upt1[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp3]>0) THEN (IF(TW_UptPot[Sp3]>TW_DemandAct[Sp3])THEN (TW_DemandAct[Sp3]/AF_ZoneFrac[Zone]*W_TUptPotAct1[Zone,Sp3]*RT_TLrv1[Zone,Sp3]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp3])ELSE(W_TUptPotAct1[Zone,Sp3]))ELSE(0)
    #
    # W_T1Upt2[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp1]>0) THEN (IF(TW_UptPot[Sp1]>TW_DemandAct[Sp1])THEN (TW_DemandAct[Sp1]/AF_ZoneFrac[Zone]*W_TUptPotAct2[Zone,Sp1]*RT_TLrv2[Zone,Sp1]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp1])ELSE(W_TUptPotAct2[Zone,Sp1]))ELSE(0)
    # W_T2Upt2[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp2]>0) THEN (IF(TW_UptPot[Sp2]>TW_DemandAct[Sp2])THEN (TW_DemandAct[Sp2]/AF_ZoneFrac[Zone]*W_TUptPotAct2[Zone,Sp2]*RT_TLrv2[Zone,Sp2]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp2])ELSE(W_TUptPotAct2[Zone,Sp2]))ELSE(0)
    # W_T3Upt2[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp3]>0) THEN (IF(TW_UptPot[Sp3]>TW_DemandAct[Sp3])THEN (TW_DemandAct[Sp3]/AF_ZoneFrac[Zone]*W_TUptPotAct2[Zone,Sp3]*RT_TLrv2[Zone,Sp3]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp3])ELSE(W_TUptPotAct2[Zone,Sp3]))ELSE(0)
    #
    # W_T1Upt3[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp1]>0) THEN (IF(TW_UptPot[Sp1]>TW_DemandAct[Sp1])THEN (TW_DemandAct[Sp1]/AF_ZoneFrac[Zone]*W_TUptPotAct3[Zone,Sp1]*RT_TLrv3[Zone,Sp1]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp1])ELSE(W_TUptPotAct3[Zone,Sp1]))ELSE(0)
    # W_T2Upt3[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp2]>0) THEN (IF(TW_UptPot[Sp2]>TW_DemandAct[Sp2])THEN (TW_DemandAct[Sp2]/AF_ZoneFrac[Zone]*W_TUptPotAct3[Zone,Sp2]*RT_TLrv3[Zone,Sp2]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp2])ELSE(W_TUptPotAct3[Zone,Sp2]))ELSE(0)
    # W_T3Upt3[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp3]>0) THEN (IF(TW_UptPot[Sp3]>TW_DemandAct[Sp3])THEN (TW_DemandAct[Sp3]/AF_ZoneFrac[Zone]*W_TUptPotAct3[Zone,Sp3]*RT_TLrv3[Zone,Sp3]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp3])ELSE(W_TUptPotAct3[Zone,Sp3]))ELSE(0)
    #
    # W_T1Upt4[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp1]>0) THEN (IF(TW_UptPot[Sp1]>TW_DemandAct[Sp1])THEN (TW_DemandAct[Sp1]/AF_ZoneFrac[Zone]*W_TUptPotAct4[Zone,Sp1]*RT_TLrv4[Zone,Sp1]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp1])ELSE(W_TUptPotAct4[Zone,Sp1]))ELSE(0)
    # W_T2Upt4[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp2]>0) THEN (IF(TW_UptPot[Sp2]>TW_DemandAct[Sp2])THEN (TW_DemandAct[Sp2]/AF_ZoneFrac[Zone]*W_TUptPotAct4[Zone,Sp2]*RT_TLrv4[Zone,Sp2]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp2])ELSE(W_TUptPotAct4[Zone,Sp2]))ELSE(0)
    # W_T3Upt4[Zone] = IF(AF_ZoneFrac[Zone]>0 AND TW_UptDeno[Sp3]>0) THEN (IF(TW_UptPot[Sp3]>TW_DemandAct[Sp3])THEN (TW_DemandAct[Sp3]/AF_ZoneFrac[Zone]*W_TUptPotAct4[Zone,Sp3]*RT_TLrv4[Zone,Sp3]*AF_ZoneWidth[Zone]/TW_UptDeno[Sp3])ELSE(W_TUptPotAct4[Zone,Sp3]))ELSE(0)
    
    zonelayertree_df$TW_UptDeno <- rep(tree_df$TW_UptDeno, each = nzone * nlayer)
    zonelayertree_df$TW_UptPot <- rep(tree_df$TW_UptPot, each = nzone * nlayer)
    zonelayertree_df$TW_DemandAct <- rep(tree_df$TW_DemandAct, each = nzone * nlayer)
    zonelayertree_df$AF_ZoneWidth <- rep(zone_df$AF_ZoneWidth, nlayer * ntree)
    
    zonelayertree_df$W_Upt <- ifelse(
      zonelayertree_df$AF_ZoneFrac > 0 & zonelayertree_df$TW_UptDeno > 0,
      ifelse(
        zonelayertree_df$TW_UptPot > zonelayertree_df$TW_DemandAct,
        zonelayertree_df$TW_DemandAct /
          zonelayertree_df$AF_ZoneFrac * zonelayertree_df$W_TUptPotAct * zonelayertree_df$RT_TLrv * zonelayertree_df$AF_ZoneWidth / zonelayertree_df$TW_UptDeno,
        zonelayertree_df$W_TUptPotAct
      ),
      0
    )
    
    
    
    
    # S_LFoodForWorms[Zone] = S_WormsLikeLitMetab*(MC_Metab[Zone]+MC_Act[Zone]+ 0.5 * MC_Slw[Zone])+S_WormsLikeLitStruc*(MC_Struc[Zone]+MC_Pass[Zone]+ 0.5 *MC_Slw[Zone] )
    zone_df$S_LFoodForWorms <- S_WormsLikeLitMetab * (zone_df$MC_Metab + zone_df$MC_Act + 0.5 * zone_df$MC_Slw) + S_WormsLikeLitStruc *
      (zone_df$MC_Struc + zone_df$MC_Pass + 0.5 * zone_df$MC_Slw)
    
    # S_SOMFoodForWorms[Zone,SoilLayer] = S_WormsLikeSOMMetab*(MC2_Metab[Zone,SoilLayer]+MC2_Act[Zone,SoilLayer]+ 0.5 * MC2_Slw[Zone,SoilLayer])+S_WormsLikeSOMStruc*(MC2_Struc[Zone,SoilLayer]+MC2_Pass[Zone,SoilLayer]+ 0.5 *MC2_Slw[Zone,SoilLayer] )
    zonelayer_df$S_SOMFoodForWorms <- S_WormsLikeSOMMetab *
      (zonelayer_df$MC2_Metab + zonelayer_df$MC2_Act + 0.5 * zonelayer_df$MC2_Slw) +
      S_WormsLikeSOMStruc * (zonelayer_df$MC2_Struc + zonelayer_df$MC2_Pass + 0.5 * zonelayer_df$MC2_Slw)
    
    # MN2_RelImpLayer[Zn1,1] = AF_DepthAct1[Zn1]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn1]+0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
    # MN2_RelImpLayer[Zn1,2] = AF_Depth2[Zn1]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn1]+0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
    # MN2_RelImpLayer[Zn1,3] = AF_Depth3[Zn1]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn1]+0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
    # MN2_RelImpLayer[Zn1,4] = AF_Depth4[Zn1]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn1]+0*(AF_DepthAct1[Zn1]+AF_Depth2[Zn1]+AF_Depth3[Zn1]+AF_Depth4[Zn1])
    # MN2_RelImpLayer[Zn2,1] = AF_DepthAct1[Zn2]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn2]+0*(AF_DepthAct1[Zn2]+AF_Depth2[Zn2]+AF_Depth3[Zn2]+AF_Depth4[Zn2])
    # MN2_RelImpLayer[Zn2,2] = AF_Depth2[Zn2]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn2]+0*(AF_DepthAct1[Zn2]+AF_Depth2[Zn2]+AF_Depth3[Zn2]+AF_Depth4[Zn2])
    # MN2_RelImpLayer[Zn2,3] = AF_Depth3[Zn2]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn2]+0*(AF_DepthAct1[Zn2]+AF_Depth2[Zn2]+AF_Depth3[Zn2]+AF_Depth4[Zn2])
    # MN2_RelImpLayer[Zn2,4] = AF_Depth4[Zn2]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn2]+0*(AF_DepthAct1[Zn2]+AF_Depth2[Zn2]+AF_Depth3[Zn2]+AF_Depth4[Zn2])
    # MN2_RelImpLayer[Zn3,1] = AF_DepthAct1[Zn3]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn3]+0*(AF_DepthAct1[Zn3]+AF_Depth2[Zn3]+AF_Depth3[Zn3]+AF_Depth4[Zn3])
    # MN2_RelImpLayer[Zn3,2] = AF_Depth2[Zn3]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn3]+0*(AF_DepthAct1[Zn3]+AF_Depth2[Zn3]+AF_Depth3[Zn3]+AF_Depth4[Zn3])
    # MN2_RelImpLayer[Zn3,3] = AF_Depth3[Zn3]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn3]+0*(AF_DepthAct1[Zn3]+AF_Depth2[Zn3]+AF_Depth3[Zn3]+AF_Depth4[Zn3])
    # MN2_RelImpLayer[Zn3,4] = AF_Depth4[Zn3]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn3]+0*(AF_DepthAct1[Zn3]+AF_Depth2[Zn3]+AF_Depth3[Zn3]+AF_Depth4[Zn3])
    # MN2_RelImpLayer[Zn4,1] = AF_DepthAct1[Zn4]*MC2_SOMDist[1]/MC2_RelImpDeno[Zn4]+0*(AF_DepthAct1[Zn4]+AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
    # MN2_RelImpLayer[Zn4,2] = AF_Depth2[Zn4]*MC2_SOMDist[2]/MC2_RelImpDeno[Zn4]+0*(AF_DepthAct1[Zn4]+AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
    # MN2_RelImpLayer[Zn4,3] = AF_Depth3[Zn4]*MC2_SOMDist[3]/MC2_RelImpDeno[Zn4]+0*(AF_DepthAct1[Zn4]+AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
    # MN2_RelImpLayer[Zn4,4] = AF_Depth4[Zn4]*MC2_SOMDist[4]/MC2_RelImpDeno[Zn4]+0*(AF_DepthAct1[Zn4]+AF_Depth2[Zn4]+AF_Depth3[Zn4]+AF_Depth4[Zn4])
    zonelayer_df$MN2_RelImpLayer <- zonelayer_df$AF_Depth * zonelayer_df$MC2_SOMDist /
      zonelayer_df$MC2_RelImpDeno
    
    # S_WormAct[Zone,SoilLayer] = S_LFoodForWorms[Zone]*S_RelWormLit[1]+S_SOMFoodForWorms[Zone,SoilLayer]*MN2_RelImpLayer[Zone,SoilLayer]
    zonelayer_df$S_LFoodForWorms <- rep(zone_df$S_LFoodForWorms, nlayer)
    zonelayer_df$S_WormAct <- zonelayer_df$S_LFoodForWorms * S_RelWormLit[1] + zonelayer_df$S_SOMFoodForWorms *
      zonelayer_df$MN2_RelImpLayer
    
    
    # PD_CRhizConst[Zone] = if CQ_CropType[Zone] = 1 then PD_CRhizovory[Type1] else if CQ_CropType[Zone] = 2 then PD_CRhizovory[Type2] else if CQ_CropType[Zone] = 3 then PD_CRhizovory[Type3] else if CQ_CropType[Zone] = 4 then PD_CRhizovory[Type4] else if CQ_CropType[Zone] = 5 then PD_CRhizovory[Type5] else 0
    zone_df$PD_CRhizConst <- crop_df$PD_CRhizovory[zone_df$CQ_CType]
    
    # PD_CRhizImp[Zone,Animals] = PD_NastiesinPlot[Animals]*PD_CRhizovore?[Animals]*PD_CropsEaten?[Zone,Animals]
    zoneanimal_df$PD_NastiesinPlot <- rep(animal_df$PD_NastiesinPlot, each = nzone)
    zoneanimal_df$PD_CRhizovore_is <- rep(animal_df$PD_CRhizovore_is, each = nzone)
    zoneanimal_df$PD_CRhizImp <- zoneanimal_df$PD_NastiesinPlot * zoneanimal_df$PD_CRhizovore_is * zoneanimal_df$PD_CropsEaten_is
    
    # PD_CRhizoVFrac[Zone] = min(1,PD_CRhizConst[Zone]+AF_DynPestImpacts?*ARRAYSUM(PD_CRhizImp[Zone,*]))
    zone_df$PD_CRhizoVFrac <- pmin(
      1,
      zone_df$PD_CRhizConst + AF_DynPestImpacts_is * aggregate(zoneanimal_df["PD_CRhizImp"], zoneanimal_df["zone"], sum)$PD_CRhizImp
    )
    
    # C_RtDecay_DW[Zone,SoilLayer] = if C_PlantDiesToday?[Zone] = 1 then C_Root_DW[Zone,SoilLayer]/dt  else (0.69/RT_CHalfLifeCurr[Zone] + PD_CRhizoVFrac[Zone]) *C_Root_DW[Zone,SoilLayer]
    # C_RtDecay_N[Zone,SoilLayer] = if C_PlantDiesToday?[Zone] = 1 then C_Root_N[Zone,SoilLayer]/dt  else (0.69/RT_CHalfLifeCurr[Zone] + PD_CRhizoVFrac[Zone]) *C_Root_N[Zone,SoilLayer]
    # C_RtDecay_P[Zone,SoilLayer] = if C_PlantDiesToday?[Zone] = 1 then C_Root_P[Zone,SoilLayer]/dt  else (0.69/RT_CHalfLifeCurr[Zone] + PD_CRhizoVFrac[Zone]) *C_Root_P[Zone,SoilLayer]
    
    zonelayerpcomp_df$C_PlantDiesToday_is <- rep(zone_df$C_PlantDiesToday_is, nlayer *
                                                   nrow(pcomp_df))
    zonelayerpcomp_df$RT_CHalfLifeCurr <- rep(zone_df$RT_CHalfLifeCurr, nlayer *
                                                nrow(pcomp_df))
    zonelayerpcomp_df$PD_CRhizoVFrac <- rep(zone_df$PD_CRhizoVFrac, nlayer *
                                              nrow(pcomp_df))
    zonelayerpcomp_df$C_RtDecay <- ifelse(
      zonelayerpcomp_df$C_PlantDiesToday_is == 1,
      zonelayerpcomp_df$C_Root,
      (
        0.69 / zonelayerpcomp_df$RT_CHalfLifeCurr + zonelayerpcomp_df$PD_CRhizoVFrac
      ) * zonelayerpcomp_df$C_Root
    )
    
    #TODO: check whether the CQ_RtDiam multiplied twice (quadratic)
    # S_C_RootVolDecay[Zone,SoilLayer] = S_C_RT_StrucFormFrac*C_RtDecay_DW[Zone,SoilLayer]*RT_CSRLCurr[Zone]*CQ_RtDiam[Zone]*CQ_RtDiam[Zone]*3.14/4*0.1
    zonelayer_df$RT_CSRLCurr <- rep(zone_df$RT_CSRLCurr, nlayer)
    zonelayer_df$S_C_RootVolDecay <- S_C_RT_StrucFormFrac * zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "DW", "C_RtDecay"] *
      zonelayer_df$RT_CSRLCurr * zonelayer_df$CQ_RtDiam * zonelayer_df$CQ_RtDiam *
      3.14 / 4 * 0.1
    
    # RT_T_MeanResTime[Sp1] = T_Par1[Root_HalfLifeTime]/0.69 +0*(T_Par2[Root_HalfLifeTime]+T_Par3[Root_HalfLifeTime])
    # RT_T_MeanResTime[Sp2] = 0*T_Par1[Root_HalfLifeTime] +T_Par2[Root_HalfLifeTime]/0.69 +0*T_Par3[Root_HalfLifeTime]
    # RT_T_MeanResTime[Sp3] = 0*(T_Par1[Root_HalfLifeTime] +T_Par2[Root_HalfLifeTime])+T_Par3[Root_HalfLifeTime]/0.69
    tree_df$RT_T_MeanResTime <- tree_df$RT_THalfLife / 0.69
    
    # PD_TRhizImp[Tree,Animals] = PD_NastiesinPlot[Animals]*PD_TEatenBy?[Tree,Animals]*PD_TRhizovore?[Animals]
    treeanimal_df$PD_NastiesinPlot <- rep(animal_df$PD_NastiesinPlot, each = ntree)
    treeanimal_df$PD_TRhizovore_is <- rep(animal_df$PD_TRhizovore_is, each = ntree)
    treeanimal_df$PD_TRhizImp <- treeanimal_df$PD_NastiesinPlot * treeanimal_df$PD_TEatenBy_is * treeanimal_df$PD_TRhizovore_is
    
    # PD_TRhizVFrac[Tree] = min(1,PD_TRhizovory[Tree]+AF_DynPestImpacts?*ARRAYSUM(PD_TRhizImp[Tree,*]))
    tree_df$PD_TRhizVFrac <- pmin(
      1,
      tree_df$PD_TRhizovory + AF_DynPestImpacts_is * aggregate(treeanimal_df["PD_TRhizImp"], treeanimal_df["tree_id"], sum)$PD_TRhizImp
    )
    
    # S&B_FirTreeMort?[Tree] = if S&B_FireTempIncTopSoil[Zn1] >S&B_TTempTol[Tree] then 1 else 0
    tree_df$SB_FirTreeMoRT_is <- ifelse(zone_df[zone_df$zone == 1, "SB_FireTempIncTopSoil"] > tree_df$SB_TTempTol, 1, 0)
    
    
    # T_DiesToday?[Tree] = if time = (T_KillDOY[Tree]+ 365* T_KillY[Tree]-CA_DOYStart) or
    # time = (T_Kill2DOY[Tree]+ 365* T_Kill2Y[Tree]-CA_DOYStart) or
    # time = (T_Kill3DOY[Tree]+ 365* T_Kill3Y[Tree]-CA_DOYStart)
    # then 1 else if T_StemDiam[Tree]>T_DiamTreshHarv[Tree] then 1 else
    #   S&B_FirTreeMort?[Tree]
    tree_df$time <- time
    tree_df$T_DiesToday_is <- ifelse(
      tree_df$time == (tree_df$T_KillDOY + 365 * tree_df$T_KillY - CA_DOYStart) |
        tree_df$time == (tree_df$T_Kill2DOY + 365 * tree_df$T_Kill2Y - CA_DOYStart) |
        tree_df$time == (tree_df$T_Kill3DOY + 365 * tree_df$T_Kill3Y - CA_DOYStart),
      1,
      ifelse(
        tree_df$T_StemDiam > tree_df$T_DiamTreshHarv,
        1,
        tree_df$SB_FirTreeMoRT_is
      )
    )
    
    # T_Root_T1_DWdecay[Zone,SoilLayer] = if T_DiesToday?[Sp1]= 1 then T_RootT1DW[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp1]>0 THEN (1/RT_T_MeanResTime[Sp1]+PD_TRhizVFrac[Sp1])*T_RootT1DW[Zone,SoilLayer] ELSE 0
    # T_Root_T2_DWdecay[Zone,SoilLayer] = if T_DiesToday?[Sp2]= 1 then T_RootT2DW[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp2]>0 THEN (1/RT_T_MeanResTime[Sp2]+PD_TRhizVFrac[Sp2])*T_RootT2DW[Zone,SoilLayer] ELSE 0
    # T_Root_T3_DWdecay[Zone,SoilLayer] = if T_DiesToday?[Sp3]= 1 then T_RootT3DW[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp3]>0 THEN (1/RT_T_MeanResTime[Sp3]+PD_TRhizVFrac[Sp3])*T_RootT3DW[Zone,SoilLayer] ELSE 0
    # T_Root_T1_Ndecay[Zone,SoilLayer] = if T_DiesToday?[Sp1]= 1 then T_RootT1N[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp1]>0 THEN (1/RT_T_MeanResTime[Sp1]+PD_TRhizVFrac[Sp1])*T_RootT1N[Zone,SoilLayer] ELSE 0
    # T_Root_T2_Ndecay[Zone,SoilLayer] = if T_DiesToday?[Sp2]= 1 then T_RootT2N[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp2]>0 THEN (1/RT_T_MeanResTime[Sp2]+PD_TRhizVFrac[Sp2])*T_RootT2N[Zone,SoilLayer] ELSE 0
    # T_Root_T3_Ndecay[Zone,SoilLayer] = if T_DiesToday?[Sp3]= 1 then T_RootT3N[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp3]>0 THEN (1/RT_T_MeanResTime[Sp3]+PD_TRhizVFrac[Sp3])*T_RootT3N[Zone,SoilLayer] ELSE 0
    # T_Root_T1_Pdecay[Zone,SoilLayer] = if T_DiesToday?[Sp1]= 1 then T_RootT1P[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp1]>0 THEN (1/RT_T_MeanResTime[Sp1]+PD_TRhizVFrac[Sp1])*T_RootT1P[Zone,SoilLayer] ELSE 0
    # T_Root_T2_Pdecay[Zone,SoilLayer] = if T_DiesToday?[Sp2]= 1 then T_RootT2P[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp2]>0 THEN (1/RT_T_MeanResTime[Sp2]+PD_TRhizVFrac[Sp2])*T_RootT2P[Zone,SoilLayer] ELSE 0
    # T_Root_T3_Pdecay[Zone,SoilLayer] = if T_DiesToday?[Sp3]= 1 then T_RootT3P[Zone,SoilLayer]/dt else IF RT_T_MeanResTime[Sp3]>0 THEN (1/RT_T_MeanResTime[Sp3]+PD_TRhizVFrac[Sp3])*T_RootT3P[Zone,SoilLayer] ELSE 0
    
    colvar <- c(
      "T_DiesToday_is",
      "RT_T_MeanResTime",
      "PD_TRhizVFrac",
      "S_T_RT_StrucFormFrac",
      "RT_TSRL",
      "RT_TDiam"
    )
    df <- tree_df[c("tree_id", colvar)]
    t_df <- df[rep(seq_len(nrow(df)), each = nzone * nlayer * nrow(pcomp_df)), ]
    zlp_df <- zonelayerpcomp_df[c("zone", "layer", "PlantComp")]
    t2_df <- zlp_df[rep(seq_len(nrow(zlp_df)), ntree), ]
    t_df <- cbind(t_df, t2_df)
    t_df <- t_df[order(t_df$PlantComp, t_df$tree_id, t_df$layer, t_df$zone), ]
    zonelayertreepcomp_df[colvar] <- t_df[colvar]
    
    zonelayertreepcomp_df$T_Root_decay <- ifelse(
      zonelayertreepcomp_df$T_DiesToday_is == 1,
      zonelayertreepcomp_df$T_Root,
      ifelse(
        zonelayertreepcomp_df$RT_T_MeanResTime > 0,
        (
          1 / zonelayertreepcomp_df$RT_T_MeanResTime + zonelayertreepcomp_df$PD_TRhizVFrac
        ) * zonelayertreepcomp_df$T_Root,
        0
      )
    )
    
    # S_T_RootVolDecay[Zone,SoilLayer] = 3.14*(S_T_RT_StrucFormFrac[Sp1]*T_Root_T1_DWdecay[Zone,SoilLayer]*RT_TSRL[Sp1]*RT_TDiam[Sp1]*RT_TDiam[Sp1]+
    #                                            S_T_RT_StrucFormFrac[Sp2]*T_Root_T2_DWdecay[Zone,SoilLayer]*RT_TSRL[Sp2]*RT_TDiam[Sp2]*RT_TDiam[Sp2]+
    #                                            S_T_RT_StrucFormFrac[Sp3]*T_Root_T3_DWdecay[Zone,SoilLayer]*RT_TSRL[Sp3]*RT_TDiam[Sp3]*RT_TDiam[Sp3]) /4*0.1
    colvar <- c("S_T_RT_StrucFormFrac", "RT_TSRL", "RT_TDiam")
    df <- tree_df[colvar]
    t_df <- df[rep(seq_len(nrow(df)), each = nzone * nlayer), ]
    zonelayertree_df[colvar] <- t_df[colvar]
    zonelayertree_df$S_T_RootVolDecay_a <- zonelayertree_df$S_T_RT_StrucFormFrac * zonelayertreepcomp_df[zonelayertreepcomp_df$PlantComp == "DW", "T_Root_decay"] * zonelayertree_df$RT_TSRL * zonelayertree_df$RT_TDiam * zonelayertree_df$RT_TDiam
    zonelayer_df$S_T_RootVolDecay <- 3.14 * (aggregate(zonelayertree_df["S_T_RootVolDecay_a"], zonelayertree_df[c("zone", "layer")], sum)$S_T_RootVolDecay_a) /
      4 * 0.1
    
    # S_TC_OldRC[Zone,SoilLayer] = S_C_RootVolDecay[Zone,SoilLayer]+S_T_RootVolDecay[Zone,SoilLayer]
    zonelayer_df$S_TC_OldRC <- zonelayer_df$S_C_RootVolDecay + zonelayer_df$S_T_RootVolDecay
    
    
    # INFLOWS:
    # S_BDModifierKsatV1[Zone] = if S_SoilStructDyn? =1   then -((S_WormAct[Zone,1]+S_TC_OldRC[Zone,1])* S_BDActOverBDRefKsatV1[Zone])+ S_BDBDrefDecay* (max(0,1- S_BDActOverBDRefKsatV1[Zone])^ S_BDEqPower) else 0
    # S_BDModifierKsatV2[Zone] = if S_SoilStructDyn? =1   then -((S_WormAct[Zone,2]+S_TC_OldRC[Zone,2])* S_BDActOverBDRefKsatV2[Zone])+ S_BDBDrefDecay* (max(0,1- S_BDActOverBDRefKsatV2[Zone])^ S_BDEqPower) else 0
    # S_BDModifierKsatV3[Zone] = if S_SoilStructDyn? =1   then -((S_WormAct[Zone,3]+S_TC_OldRC[Zone,3])* S_BDActOverBDRefKsatV3[Zone])+ S_BDBDrefDecay* (max(0,1- S_BDActOverBDRefKsatV3[Zone])^ S_BDEqPower) else 0
    # S_BDModifierKsatV4[Zone] = if S_SoilStructDyn? =1   then -((S_WormAct[Zone,4]+S_TC_OldRC[Zone,4])* S_BDActOverBDRefKsatV4[Zone])+ S_BDBDrefDecay* (max(0,1- S_BDActOverBDRefKsatV4[Zone])^ S_BDEqPower) else 0
    
    
    zonelayer_df$S_SoilStructDyn_is <-  S_SoilStructDyn_is
    zonelayer_df$S_BDModifierKsatV <- ifelse(
      zonelayer_df$S_SoilStructDyn_is == 1,
      -((zonelayer_df$S_WormAct + zonelayer_df$S_TC_OldRC) * zonelayer_df$S_BDActOverBDRefKsatV
      ) + S_BDBDrefDecay *
        (
          max(0, 1 - zonelayer_df$S_BDActOverBDRefKsatV)^S_BDEqPower
        ) ,
      0
    )
    
    
    # S_WormActSurf[Zone] = S_LFoodForWorms[Zone]*S_RelWormSurf
    zone_df$S_WormActSurf <- zone_df$S_LFoodForWorms * S_RelWormSurf
    
    # S_BDModifierInfiltr[Zone] = if S_SoilStructDyn? =1   then -(S_WormActSurf[Zone]*S_BDActOverBDRefInfiltr[Zone])+S_BDBDrefDecay*(max(0,1-S_BDActOverBDRefInfiltr[Zone])^S_BDEqPower)  else 0
    zone_df$S_BDModifierInfiltr <- ifelse(
      S_SoilStructDyn_is == 1,
      -(zone_df$S_WormActSurf * zone_df$S_BDActOverBDRefInfiltr) +
        S_BDBDrefDecay *
        (max(
          0, 1 - zone_df$S_BDActOverBDRefInfiltr
        )^S_BDEqPower),
      0
    )
    
    
    
    zone_df$CQ_CropType <- get_val_by_CA_ComplCrop(CQ_CropType_df, zone_df$CA_ComplCrop, zone_df$zone)
    
    
    
    # P_PriceCSeed[Private,Zn1] = P_ParamCCurr[Zn1,SeedP]
    # P_PriceCSeed[Private,Zn2] = P_ParamCCurr[Zn2,SeedP]
    # P_PriceCSeed[Private,Zn3] = P_ParamCCurr[Zn3,SeedP]
    # P_PriceCSeed[Private,Zn4] = P_ParamCCurr[Zn4,SeedP]
    # P_PriceCSeed[Social,Zn1] = P_ParamCCurr[Zn1,SeedS]
    # P_PriceCSeed[Social,Zn2] = P_ParamCCurr[Zn2,SeedS]
    # P_PriceCSeed[Social,Zn3] = P_ParamCCurr[Zn3,SeedS]
    # P_PriceCSeed[Social,Zn4] = P_ParamCCurr[Zn4,SeedS]
    zoneprice_df$P_PriceCSeed <- c(PF_UnitCrop_df[zone_df$CQ_CropType, "SeedP"], PF_UnitCrop_df[zone_df$CQ_CropType, "SeedS"])
    
    # P_CPlantLab[Zone] = P_ParamCCurr[Zone,PlantLab]
    zone_df$P_CPlantLab <- PF_UnitCrop_df[zone_df$CQ_CropType, "PlantLab"]
    
    # P_CPestConLab[Zone] = P_ParamCCurr[Zone,PestLab]
    zone_df$P_CPestConLab <- PF_UnitCrop_df[zone_df$CQ_CropType, "PestLab"]
    
    # P_CWeedLab[Zone] = P_ParamCCurr[Zone,WeedLab]
    zone_df$P_CWeedLab <- PF_UnitCrop_df[zone_df$CQ_CropType, "WeedLab"]
    
    # P_CHarvLab[Zone] = P_ParamCCurr[Zone,HarvLab]
    zone_df$P_CHarvLab <- PF_UnitCrop_df[zone_df$CQ_CropType, "HarvLab"]
    
    # P_CFertLab[Zone] = P_ParamCCurr[Zone,FertLab]
    zone_df$P_CFertLab <- PF_UnitCrop_df[zone_df$CQ_CropType, "FertLab"]
    
    # P_CYieldPrice[Private,Zn1] = P_ParamCCurr[Zn1,YieldP]
    # P_CYieldPrice[Private,Zn2] = P_ParamCCurr[Zn2,YieldP]
    # P_CYieldPrice[Private,Zn3] = P_ParamCCurr[Zn3,YieldP]
    # P_CYieldPrice[Private,Zn4] = P_ParamCCurr[Zn4,YieldP]
    # P_CYieldPrice[Social,Zn1] = P_ParamCCurr[Zn1,YieldS]
    # P_CYieldPrice[Social,Zn2] = P_ParamCCurr[Zn2,YieldS]
    # P_CYieldPrice[Social,Zn3] = P_ParamCCurr[Zn3,YieldS]
    # P_CYieldPrice[Social,Zn4] = P_ParamCCurr[Zn4,YieldS]
    zoneprice_df$P_CYieldPrice <- c(PF_UnitCrop_df[zone_df$CQ_CropType, "YieldP"], PF_UnitCrop_df[zone_df$CQ_CropType, "YieldS"])
    
    
    
    
    
    
    
    # CQ_WeedRestart?[Zn1] = if AF_SimulateWeeds? = 1 and CQ_Stage[Zn1] = 0 then 1*AF_WeedZn?[Zn1] else 0
    # CQ_WeedRestart?[Zn2] = if AF_SimulateWeeds? = 1 and CQ_Stage[Zn2] = 0 then 1*AF_WeedZn?[Zn2] else 0
    # CQ_WeedRestart?[Zn3] = if AF_SimulateWeeds? = 1 and CQ_Stage[Zn3] = 0 then 1*AF_WeedZn?[Zn3] else 0
    # CQ_WeedRestart?[Zn4] = if AF_SimulateWeeds? = 1 and CQ_Stage[Zn4] = 0 then 1*AF_WeedZn?[Zn4] else 0
    zone_df$AF_SimulateWeeds_is <- AF_SimulateWeeds_is
    zone_df$CQ_WeedRestaRT_is <- ifelse(zone_df$AF_SimulateWeeds_is == 1 &
                                          zone_df$CQ_Stage == 0,
                                        zone_df$AF_WeedZn_is,
                                        0)
    
    
    
    # CQ_CWswitch[Zone] = if time = int(CA_PlantTime[Zone]-1) then CQ_CropType[Zone]-CQ_CropWeedSwitch[Zone]/dt  else if CQ_WeedRestart?[Zone] = 1 then CQ_WeedType- CQ_CropWeedSwitch[Zone]/dt else 0
    zone_df$time <- time
    zone_df$CQ_CWswitch <- ifelse(
      zone_df$time == floor(zone_df$CA_PlantTime - 1),
      zone_df$CQ_CropType - zone_df$CQ_CropWeedSwitch,
      ifelse(
        zone_df$CQ_WeedRestaRT_is == 1,
        CQ_WeedType - zone_df$CQ_CropWeedSwitch,
        0
      )
    )
    
    
    
    # TEMP_AirDailyData = GRAPH(RAIN_DoY)
    TEMP_AirDailyData <- get_y_df(RAIN_DoY, "TEMP_AirDailyData")
    
    # C_TempDevStage = IF(C_TOpt-C_TMin)>0 THEN  min(1,max(0,TEMP_AirDailyData-C_TMin)/(C_TOpt-C_TMin)) ELSE 0
    C_TempDevStage <- ifelse((C_TOpt - C_TMin) >
                               0 , min(1, max(0, TEMP_AirDailyData - C_TMin) / (C_TOpt - C_TMin)), 0)
    
    # CQ_StageInc[Zone] = if time = int(CA_PlantTime[Zone]) or CQ_WeedRestart?[Zone] = 1 then (0.0001-CQ_Stage[Zone]/dt ) else
    # if CQ_Stage[Zone] = 0 then 0 else
    # if CQ_CropGraze >0 then (CQ_StageAfterGraze-CQ_Stage[Zone]/ dt ) else
    # if (CQ_Stage[Zone] >=2 ) then ((-CQ_Stage[Zone]+CQ_StageAfterHarvest[Zone])/dt) else
    # if (CQ_Stage[Zone] > 0 and CQ_Stage[Zone] < 1) then min(1-CQ_Stage[Zone], (1/(CQ_CTimeVegCurr[Zone]))) else
    # if (CQ_Stage[Zone] >1 and CQ_Stage[Zone]< 2) then (1/(CQ_CTimeGenCurr[Zone])*C_TempDevStage) else
    # if (mod (Time,365)  > CQ_DOYFlwDOYBegin[Zone]  and mod (Time,365)  < CQ_DOYFlwEnd[Zone]) then (1/CQ_CTimeGenCurr[Zone]*C_TempDevStage ) else 0
    
    zone_df$CQ_StageInc <- ifelse(
      zone_df$time == zone_df$CA_PlantTime |
        zone_df$CQ_WeedRestaRT_is == 1,
      0.0001 - zone_df$CQ_Stage,
      ifelse(
        zone_df$CQ_Stage == 0,
        0,
        ifelse(
          CQ_CropGraze > 0,
          CQ_StageAfterGraze - zone_df$CQ_Stage,
          ifelse(
            zone_df$CQ_Stage >= 2,
            -zone_df$CQ_Stage + zone_df$CQ_StageAfterHarvest,
            ifelse(
              zone_df$CQ_Stage > 0 & zone_df$CQ_Stage < 1,
              pmin(1 - zone_df$CQ_Stage, 1 / zone_df$CQ_CTimeVegCurr),
              ifelse(
                zone_df$CQ_Stage > 1 & zone_df$CQ_Stage < 2,
                1 / zone_df$CQ_CTimeGenCurr * C_TempDevStage,
                ifelse((Time %% 365) > zone_df$CQ_DOYFlwDOYBegin &
                         (Time %% 365) < zone_df$CQ_DOYFlwEnd,
                       1 / zone_df$CQ_CTimeGenCurr * C_TempDevStage,
                       0
                )
              )
            )
          )
        )
      )
    )
    
    
    
    zonepcomp_df$C_PlantDiesToday_is <- rep(zone_df$C_PlantDiesToday_is, each = nrow(pcomp_df))
    zonepcomp_df$CQ_CHarvAllocCurr <- rep(zone_df$CQ_CHarvAllocCurr, each = nrow(pcomp_df))
    zonepcomp_df$CQ_RemobFrac <- rep(zone_df$CQ_RemobFrac, each = nrow(pcomp_df))
    # C_StLeafInc[Zone,PlantComp] = IF (C_PlantDiesToday?[Zone]=0 )THEN(C_GroResMobFrac*(1-CQ_CHarvAllocCurr[Zone])*C_GroRes[Zone,PlantComp]-CQ_RemobFrac[Zone]*C_BiomStLv[Zone,PlantComp])ELSE(0)
    zonepcomp_df$C_StLeafInc <- ifelse(
      zonepcomp_df$C_PlantDiesToday_is == 0,
      C_GroResMobFrac * (1 - zonepcomp_df$CQ_CHarvAllocCurr) * zonepcomp_df$C_GroRes -
        zonepcomp_df$CQ_RemobFrac * zonepcomp_df$C_BiomStLv,
      0
    )
    
    # C_Resid[Zone,PlantComp] = IF C_PlantDiesToday?[Zone] THEN C_ResidRemovalFrac*C_BiomStLv[Zone,PlantComp]/dt ELSE  0
    zonepcomp_df$C_Resid <- ifelse(
      zonepcomp_df$C_PlantDiesToday_is,
      C_ResidRemovalFrac * zonepcomp_df$C_BiomStLv,
      0
    )
    
    # C_StLeaveMulch[Zone,PlantComp] = if C_PlantDiesToday?[Zone]=1 then (1-C_ResidRemovalFrac)*C_BiomStLv[Zone,PlantComp]/dt else  if C_LAI[Zone]>C_LAIMax[Zone] then C_BiomStLv[Zone,PlantComp]*(C_LAI[Zone]-C_LAIMax[Zone])/C_LAI[Zone] else PD_CHerbVFrac[Zone]* C_BiomStLv[Zone,PlantComp]
    zonepcomp_df$C_StLeaveMulch <- ifelse(
      zonepcomp_df$C_PlantDiesToday_is == 1,
      (1 - C_ResidRemovalFrac) * zonepcomp_df$C_BiomStLv,
      ifelse(
        zonepcomp_df$C_LAI[Zone] > zonepcomp_df$C_LAIMax[Zone],
        zonepcomp_df$C_BiomStLv *
          (zonepcomp_df$C_LAI[Zone] - zonepcomp_df$C_LAIMax[Zone]) / zonepcomp_df$C_LAI[Zone],
        zonepcomp_df$PD_CHerbVFrac[Zone] * zonepcomp_df$C_BiomStLv
      )
    )
    # C_BiomHarvestDoY = GRAPH(C_BiomHarvestPast)
    C_BiomHarvestDoY <- get_y_df(C_BiomHarvestPast, "C_BiomHarvestDoY")
    C_BiomHarvestY <- get_y_df(C_BiomHarvestPast, "C_BiomHarvestY")
    C_BiomHarvestFracD <- get_y_df(C_BiomHarvestPast, "C_BiomHarvestFracD")
    
    # C_BiomHarvestDay = C_BiomHarvestDoY+365*(C_BiomHarvestY)-CA_DOYStart
    C_BiomHarvestDay <- C_BiomHarvestDoY + 365 * (C_BiomHarvestY) - CA_DOYStart
    
    zonepcomp_df$C_BiomHarv_is <- C_BiomHarv_is
    zonepcomp_df$C_BiomHarvestDay <- C_BiomHarvestDay
    zonepcomp_df$time <- time
    # C_BiomHarvest[Zone,PlantComp] = IF C_BiomHarv?=1 and TIME=INT(C_BiomHarvestDay) then C_BiomHarvestFracD*C_BiomStLv[Zone,PlantComp]/dt else 0
    zonepcomp_df$C_BiomHarvest <- ifelse(
      zonepcomp_df$C_BiomHarv_is == 1 &
        zonepcomp_df$time == floor(zonepcomp_df$C_BiomHarvestDay),
      C_BiomHarvestFracD * zonepcomp_df$C_BiomStLv,
      0
    )
    
    
    
    treepcomp_df$T_PrunPlant_is <- T_PrunOption_par$`PrunPlant?`
    
    T_PrunDoY <- get_graph_y(T_PrunDoY_df, T_PrunPast)
    T_PrunY <- get_graph_y(T_PrunY_df, T_PrunPast)
    
    # T_PrunDay = T_PrunDoY+365*(T_PrunY)-CA_DOYStart
    T_PrunDay <- T_PrunDoY + 365 * (T_PrunY) - CA_DOYStart
    
    
    # C_NewCropPlanted = IF(TIME=INT(CA_PlantTime[Zn1]) OR TIME=INT(CA_PlantTime[Zn2]) OR TIME=INT(CA_PlantTime[Zn3]) OR TIME=INT(CA_PlantTime[Zn4]))THEN 1 ELSE 0
    C_NewCropPlanted <- ifelse(any(time == floor(zone_df$CA_PlantTime)), 1, 0)
    
    # T_CropinZone?[Zone] = IF C_Biom[Zone,DW]>0 THEN 1 ELSE 0
    zone_df$T_CropinZone_is <- ifelse(zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Biom"] > 0, 1, 0)
    
    
    # T_LAIcropzoneTot = (AF_ZoneWidth[Zn1]*T_CropinZone?[Zn1]*(T_LAIEff[Zn1,Sp1]+T_LAIEff[Zn1,Sp2]+T_LAIEff[Zn1,Sp3])+AF_ZoneWidth[Zn2]*T_CropinZone?[Zn2]* (T_LAIEff[Zn2,Sp1]+T_LAIEff[Zn2,Sp2]+T_LAIEff[Zn2,Sp3])+AF_ZoneWidth[Zn3]*T_CropinZone?[Zn3]* (T_LAIEff[Zn3,Sp1]+T_LAIEff[Zn3,Sp2]+T_LAIEff[Zn3,Sp3])+(AF_ZoneWidth[Zn4]*T_CropinZone?[Zn4]* (T_LAIEff[Zn4,Sp1]+T_LAIEff[Zn4,Sp2]+T_LAIEff[Zn4,Sp3])))/(AF_ZoneWidth[Zn1]+AF_ZoneWidth[Zn2]+AF_ZoneWidth[Zn3]+AF_ZoneWidth[Zn4])
    zone_df$T_LAIcropzoneTot_a <- zone_df$AF_ZoneWidth * zone_df$T_CropinZone_is * zone_df$T_LAIEff_sum
    T_LAIcropzoneTot <- sum(zone_df$T_LAIcropzoneTot_a) / sum(zone_df$AF_ZoneWidth)
    
    
    # CQ_WeedZn?[Zone] = if CQ_CType[Zone]=CQ_WeedType then 1 else 0
    zone_df$CQ_WeedZn_is <- ifelse(zone_df$CQ_CType == CQ_WeedType, 1, 0)
    
    # T_CropinField? = if ARRAYMEAN(CQ_WeedZn?[*]) <1 then IF(CQ_Stage[Zn1] <T_PrunStageLimit OR CQ_Stage[Zn2] <T_PrunStageLimit OR  CQ_Stage[Zn3] <T_PrunStageLimit OR  CQ_Stage[Zn4] <T_PrunStageLimit)THEN(1)ELSE(0) else 0
    T_CropinField_is <- ifelse(mean(zone_df$CQ_WeedZn_is) < 1, ifelse(any(zone_df$CQ_Stage < T_PrunStageLimit), 1, 0), 0)
    
    T_PrunType_is <- T_PrunOption_par$`PrunType?`
    
    
    tree_df$T_PrunFracD <- get_T_PrunFracD(T_PrunPast)
    
    # T_PrunFrac[Tree] = T_PrunType?*T_PrunFracD[Tree] + (1-T_PrunType?)*T_PrunFracC[Tree]
    tree_df$T_PrunFrac <- T_PrunType_is * tree_df$T_PrunFracD + (1 - T_PrunType_is) * tree_df$T_PrunFracC
    
    # T_Prun[PlantComp,Tree] = IF (T_PrunPlant?=1)THEN(if (TIME=INT(T_PrunDay) OR C_NewCropPlanted=1) OR (T_LAIcropzoneTot>T_PrunLimit and T_CropinField?=1)
    # then (T_PrunFrac[Tree]*T_LfTwig[PlantComp,Tree] / dt)  else 0) ELSE
    # (if (TIME=INT(T_PrunDay) OR(T_LAIcropzoneTot>T_PrunLimit) and T_CropinField?=1)
    # then (T_PrunFrac[Tree]*T_LfTwig[PlantComp,Tree]/ dt) else 0)
    
    treepcomp_df$T_Prun <- ifelse(
      treepcomp_df$T_PrunPlant_is == 1,
      ifelse(
        (time == floor(T_PrunDay) |
           C_NewCropPlanted == 1) |
          (T_LAIcropzoneTot > T_PrunLimit &
             T_CropinField_is == 1),
        tree_df$T_PrunFrac * treepcomp_df$T_LfTwig,
        0
      ),
      ifelse (
        time == floor(T_PrunDay) |
          (T_LAIcropzoneTot > T_PrunLimit) &
          T_CropinField_is == 1,
        tree_df$T_PrunFrac * treepcomp_df$T_LfTwig,
        0
      )
    )
    
    
    tree_df$AF_AnyTrees_is <- AF_AnyTrees_is
    
    # T_GrowsToday?[Tree] = if AF_AnyTrees?= 0 then 0 else if (T_DiesToday?[Tree]=1) or (T_CumWatStress[Tree]>T_LiFallThreshWStress[Tree]^T_StressRatio) or (T_PrunLapse[Tree]<T_PrunRecov[Tree]) OR (T_Prun[DW, Tree]>0) or (time = int(S&B_SlashTime[Tree])) or (S&B_FireTime? = 1 ) THEN (0) else 1
    tree_df$T_GrowsToday_is <- ifelse(tree_df$AF_AnyTrees_is == 0, 0, ifelse(
      (tree_df$T_DiesToday_is == 1) |
        (
          tree_df$T_CumWatStress > tree_df$T_LiFallThreshWStress^T_StressRatio
        ) |
        (tree_df$T_PrunLapse <
           tree_df$T_PrunRecov) |
        (treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Prun"] > 0) |
        (time == floor(tree_df$SB_SlashTime)) |
        (SB_FireTime_is == 1),
      0,
      1
    ))
    
    treepcomp_df$T_GrowsToday_is <- rep(tree_df$T_GrowsToday_is, nrow(pcomp_df))
    treepcomp_df$T_ApplyPalm_is <- rep(tree_df$T_ApplyPalm_is, nrow(pcomp_df))
    treepcomp_df$T_GroResFrac <- rep(tree_df$T_GroResFrac, nrow(pcomp_df))
    
    treenut_df$AF_RunNutLim_is <- rep(nut_df$AF_RunNutLim_is, each = ntree)
    
    tree_df$T_LfTwig_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LfTwig"]
    treepcomp_df$T_LfTwig_DW <- rep(tree_df$T_LfTwig_DW, nrow(pcomp_df))
    treepcomp_df$T_LWR <- rep(tree_df$T_LWR, nrow(pcomp_df))
    
    
    # T_CanTargConc[PlantComp,Tree] = T_LWR[Tree]*T_LfConc[PlantComp,Tree]+(1-T_LWR[Tree])*T_TwigConc[PlantComp,Tree]
    treepcomp_df$T_CanTargConc <- treepcomp_df$T_LWR * treepcomp_df$T_LfConc + (1 -
                                                                                  treepcomp_df$T_LWR) * treepcomp_df$T_TwigConc
    
    treepcomp_df$T_UnitConv <- rep(pcomp_df$T_UnitConv, each = ntree)
    
    # T_TargetCan[PlantComp,Tree] = T_LfTwig[DW, Tree]*T_CanTargConc[PlantComp,Tree]*T_UnitConv[PlantComp]
    treepcomp_df$T_TargetCan <- treepcomp_df$T_LfTwig_DW * treepcomp_df$T_CanTargConc * treepcomp_df$T_UnitConv
    
    # T_NTargetCan[N,Sp1] = T_TargetCan[N,Sp1]
    # T_NTargetCan[N,Sp2] = T_TargetCan[N,Sp2]
    # T_NTargetCan[N,Sp3] = T_TargetCan[N,Sp3]
    # T_NTargetCan[P,Sp1] = T_TargetCan[P,Sp1]
    # T_NTargetCan[P,Sp2] = T_TargetCan[P,Sp2]
    # T_NTargetCan[P,Sp3] = T_TargetCan[P,Sp3]
    treenut_df$T_NTargetCan <- treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), "T_TargetCan"]
    
    # T_Root_DWtot[Sp1] = AF_ZoneFrac[Zn1]*(T_RootT1DW[Zn1,1]+T_RootT1DW[Zn1,2]+T_RootT1DW[Zn1,3]+T_RootT3DW[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT1DW[Zn2,1]+T_RootT1DW[Zn2,2]+T_RootT1DW[Zn2,3]+T_RootT1DW[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT1DW[Zn3,1]+T_RootT1DW[Zn3,2]+T_RootT1DW[Zn3,3]+T_RootT1DW[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT1DW[Zn4,1]+T_RootT1DW[Zn4,2]+T_RootT1DW[Zn4,3]+T_RootT1DW[Zn4,4])+
    #   0*(T_RootT1DW[Zn1,1]+T_RootT2DW[Zn1,1]+T_RootT3DW[Zn1,1])
    # T_Root_DWtot[Sp2] = AF_ZoneFrac[Zn1]*(T_RootT2DW[Zn1,1]+T_RootT2DW[Zn1,2]+T_RootT2DW[Zn1,3]+T_RootT2DW[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT2DW[Zn2,1]+T_RootT2DW[Zn2,2]+T_RootT2DW[Zn2,3]+T_RootT2DW[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT2DW[Zn3,1]+T_RootT2DW[Zn3,2]+T_RootT2DW[Zn3,3]+T_RootT2DW[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT2DW[Zn4,1]+T_RootT2DW[Zn4,2]+T_RootT2DW[Zn4,3]+T_RootT2DW[Zn4,4])+
    #   0*(T_RootT1DW[Zn1,1]+T_RootT2DW[Zn1,1]+T_RootT3DW[Zn1,1])
    # T_Root_DWtot[Sp3] = AF_ZoneFrac[Zn1]*(T_RootT3DW[Zn1,1]+T_RootT3DW[Zn1,2]+T_RootT3DW[Zn1,3]+T_RootT3DW[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT3DW[Zn2,1]+T_RootT3DW[Zn2,2]+T_RootT3DW[Zn2,3]+T_RootT3DW[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT3DW[Zn3,1]+T_RootT3DW[Zn3,2]+T_RootT3DW[Zn3,3]+T_RootT3DW[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT3DW[Zn4,1]+T_RootT3DW[Zn4,2]+T_RootT3DW[Zn4,3]+T_RootT3DW[Zn4,4])+
    #   0*(T_RootT1DW[Zn1,1]+T_RootT2DW[Zn1,1]+T_RootT3DW[Zn1,1])
    # T_RootNtot[Sp1] = AF_ZoneFrac[Zn1]*(T_RootT1N[Zn1,1]+T_RootT1N[Zn1,2]+T_RootT1N[Zn1,3]+T_RootT1N[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT1N[Zn2,1]+T_RootT1N[Zn2,2]+T_RootT1N[Zn2,3]+T_RootT1N[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT1N[Zn3,1]+T_RootT1N[Zn3,2]+T_RootT1N[Zn3,3]+T_RootT1N[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT1N[Zn4,1]+T_RootT1N[Zn4,2]+T_RootT1N[Zn4,3]+T_RootT1N[Zn4,4])+
    #   0*(T_RootT1N[Zn1,1]+T_RootT2N[Zn1,1]+T_RootT3N[Zn1,1])
    # T_RootNtot[Sp2] = AF_ZoneFrac[Zn1]*(T_RootT2N[Zn1,1]+T_RootT2N[Zn1,2]+T_RootT2N[Zn1,3]+T_RootT2N[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT2N[Zn2,1]+T_RootT2N[Zn2,2]+T_RootT2N[Zn2,3]+T_RootT2N[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT2N[Zn3,1]+T_RootT2N[Zn3,2]+T_RootT2N[Zn3,3]+T_RootT2N[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT2N[Zn4,1]+T_RootT2N[Zn4,2]+T_RootT2N[Zn4,3]+T_RootT2N[Zn4,4])+
    #   0*(T_RootT1N[Zn1,1]+T_RootT2N[Zn1,1]+T_RootT3N[Zn1,1])
    # T_RootNtot[Sp3] = AF_ZoneFrac[Zn1]*(T_RootT3N[Zn1,1]+T_RootT3N[Zn1,2]+T_RootT3N[Zn1,3]+T_RootT3N[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT3N[Zn2,1]+T_RootT3N[Zn2,2]+T_RootT3N[Zn2,3]+T_RootT3N[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT3N[Zn3,1]+T_RootT3N[Zn3,2]+T_RootT3N[Zn3,3]+T_RootT3N[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT3N[Zn4,1]+T_RootT3N[Zn4,2]+T_RootT3N[Zn4,3]+T_RootT3N[Zn4,4])+
    #   0*(T_RootT1N[Zn1,1]+T_RootT2N[Zn1,1]+T_RootT3N[Zn1,1])
    # T_RootPtot[Sp1] = AF_ZoneFrac[Zn1]*(T_RootT1P[Zn1,1]+T_RootT1P[Zn1,2]+T_RootT1P[Zn1,3]+T_RootT1P[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT1P[Zn2,1]+T_RootT1P[Zn2,2]+T_RootT1P[Zn2,3]+T_RootT1P[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT1P[Zn3,1]+T_RootT1P[Zn3,2]+T_RootT1P[Zn3,3]+T_RootT1P[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT1P[Zn4,1]+T_RootT1P[Zn4,2]+T_RootT1P[Zn4,3]+T_RootT1P[Zn4,4])+
    #   0*(T_RootT1P[Zn1,1]+T_RootT2P[Zn1,1]+T_RootT3P[Zn1,1])
    # T_RootPtot[Sp2] = AF_ZoneFrac[Zn1]*(T_RootT2P[Zn1,1]+T_RootT2P[Zn1,2]+T_RootT2P[Zn1,3]+T_RootT2P[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT2P[Zn2,1]+T_RootT2P[Zn2,2]+T_RootT2P[Zn2,3]+T_RootT2P[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT2P[Zn3,1]+T_RootT2P[Zn3,2]+T_RootT2P[Zn3,3]+T_RootT2P[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT2P[Zn4,1]+T_RootT2P[Zn4,2]+T_RootT2P[Zn4,3]+T_RootT2P[Zn4,4])+
    #   0*(T_RootT1P[Zn1,1]+T_RootT2P[Zn1,1]+T_RootT3P[Zn1,1])
    # T_RootPtot[Sp3] = AF_ZoneFrac[Zn1]*(T_RootT3P[Zn1,1]+T_RootT3P[Zn1,2]+T_RootT3P[Zn1,3]+T_RootT3P[Zn1,4])+
    #   AF_ZoneFrac[Zn2]*(T_RootT3P[Zn2,1]+T_RootT3P[Zn2,2]+T_RootT3P[Zn2,3]+T_RootT3P[Zn2,4])+
    #   AF_ZoneFrac[Zn3]*(T_RootT3P[Zn3,1]+T_RootT3P[Zn3,2]+T_RootT3P[Zn3,3]+T_RootT3P[Zn3,4])+
    #   AF_ZoneFrac[Zn4]*(T_RootT3P[Zn4,1]+T_RootT3P[Zn4,2]+T_RootT3P[Zn4,3]+T_RootT3P[Zn4,4])+
    #   0*(T_RootT1P[Zn1,1]+T_RootT2P[Zn1,1]+T_RootT3P[Zn1,1])
    
    zonetreepcomp_df <- aggregate(zonelayertreepcomp_df["T_Root"], zonelayertreepcomp_df[c("zone", "tree_id", "PlantComp")], sum)
    zonetreepcomp_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, ntree * nrow(pcomp_df))
    zonetreepcomp_df$T_Root_zf <- zonetreepcomp_df$AF_ZoneFrac * zonetreepcomp_df$T_Root
    treepcomp_df$T_RootTot <- aggregate(zonetreepcomp_df["T_Root_zf"], zonetreepcomp_df[c("tree_id", "PlantComp")], sum)$T_Root_zf
    
    # T_RootPlCompTot[Sp1,DW] = T_Root_DWtot[Sp1]+0*(T_RootNtot[Sp1]+T_RootPtot[Sp1])
    # T_RootPlCompTot[Sp1,N] = 0*T_Root_DWtot[Sp1]+T_RootNtot[Sp1]+0*T_RootPtot[Sp1]
    # T_RootPlCompTot[Sp1,P] = 0*T_Root_DWtot[Sp1]+0*T_RootNtot[Sp1]+T_RootPtot[Sp1]
    # T_RootPlCompTot[Sp2,DW] = T_Root_DWtot[Sp2]+0*T_RootNtot[Sp2]+0*T_RootPtot[Sp2]
    # T_RootPlCompTot[Sp2,N] = 0*T_Root_DWtot[Sp2]+T_RootNtot[Sp2]+0*T_RootPtot[Sp2]
    # T_RootPlCompTot[Sp2,P] = 0*T_Root_DWtot[Sp2]+0*T_RootNtot[Sp2]+T_RootPtot[Sp2]
    # T_RootPlCompTot[Sp3,DW] = T_Root_DWtot[Sp3]+0*T_RootNtot[Sp3]+0*T_RootPtot[Sp3]
    # T_RootPlCompTot[Sp3,N] = 0*T_Root_DWtot[Sp3]+T_RootNtot[Sp3]+0*T_RootPtot[Sp3]
    # T_RootPlCompTot[Sp3,P] = 0*T_Root_DWtot[Sp3]+0*T_RootNtot[Sp3]+T_RootPtot[Sp3]
    treepcomp_df$T_RootPlCompTot <- treepcomp_df$T_RootTot
    
    treepcomp_df$T_Fruit_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Fruit"], nrow(pcomp_df))
    tree_df$T_GroRes_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_GroRes"]
    treepcomp_df$T_GroRes_DW <- rep(tree_df$T_GroRes_DW, nrow(pcomp_df))
    treepcomp_df$T_RootPlCompTot_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_RootPlCompTot"], nrow(pcomp_df))
    treepcomp_df$T_SapWood_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_SapWood"], nrow(pcomp_df))
    treepcomp_df$T_LatexStock_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LatexStock"], nrow(pcomp_df))
    treepcomp_df$T_HeartWood_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_HeartWood"], nrow(pcomp_df))
    
    # T_TargetNonCan[PlantComp,Tree] = (T_Fruit[DW, Tree]*T_FruitConc[PlantComp,Tree]+T_GroRes[DW, Tree]*T_GroResConc[PlantComp,Tree]+T_RootPlCompTot[Tree,DW]*T_RtConc[PlantComp,Tree]+(T_SapWood[DW, Tree]+T_LatexStock[DW,Tree]+T_HeartWood[DW,Tree])*T_WoodConc[PlantComp,Tree])*T_UnitConv[PlantComp]
    treepcomp_df$T_TargetNonCan <- (
      treepcomp_df$T_Fruit_DW * treepcomp_df$T_FruitConc +
        treepcomp_df$T_GroRes_DW * treepcomp_df$T_GroResConc +
        treepcomp_df$T_RootPlCompTot_DW * treepcomp_df$T_RtConc +
        (
          treepcomp_df$T_SapWood_DW + treepcomp_df$T_LatexStock_DW +
            treepcomp_df$T_HeartWood_DW
        ) * treepcomp_df$T_WoodConc
    ) * treepcomp_df$T_UnitConv
    
    # T_NTargetNonCan[N,Sp1] = T_TargetNonCan[N,Sp1]
    # T_NTargetNonCan[N,Sp2] = T_TargetNonCan[N,Sp2]
    # T_NTargetNonCan[N,Sp3] = T_TargetNonCan[N,Sp3]
    # T_NTargetNonCan[P,Sp1] = T_TargetNonCan[P,Sp1]
    # T_NTargetNonCan[P,Sp2] = T_TargetNonCan[P,Sp2]
    # T_NTargetNonCan[P,Sp3] = T_TargetNonCan[P,Sp3]
    treenut_df$T_NTargetNonCan <- treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), "T_TargetNonCan"]
    
    # T_NTarget[SlNut,Tree] = T_NTargetCan[SlNut,Tree]+T_NTargetNonCan[SlNut,Tree]
    treenut_df$T_NTarget <- treenut_df$T_NTargetCan + treenut_df$T_NTargetNonCan
    
    # T_Biom[PlantComp,Tree] = T_GroRes[PlantComp,Tree]+T_LfTwig[PlantComp,Tree]+T_SapWood[PlantComp,Tree]+T_Fruit[PlantComp,Tree]+T_RootPlCompTot[Tree,PlantComp]+T_HeartWood[PlantComp,Tree]+T_LatexStock[PlantComp,Tree]
    treepcomp_df$T_Biom <- treepcomp_df$T_GroRes + treepcomp_df$T_LfTwig + treepcomp_df$T_SapWood + treepcomp_df$T_Fruit + treepcomp_df$T_RootPlCompTot + treepcomp_df$T_HeartWood + treepcomp_df$T_LatexStock
    
    # T_NBiom[N,Sp1] = T_Biom[N,Sp1]
    # T_NBiom[N,Sp2] = T_Biom[N,Sp2]
    # T_NBiom[N,Sp3] = T_Biom[N,Sp3]
    # T_NBiom[P,Sp1] = T_Biom[P,Sp1]
    # T_NBiom[P,Sp2] = T_Biom[P,Sp2]
    # T_NBiom[P,Sp3] = T_Biom[P,Sp3]
    treenut_df$T_NBiom <- treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), "T_Biom"]
    
    # T_NTargetNbiomRatio[SlNut,Tree] = if T_NTarget[SlNut,Tree]>0 then min(T_NBiom[SlNut,Tree]/T_NTarget[SlNut,Tree],1) else 1
    treenut_df$T_NTargetNbiomRatio <- ifelse(treenut_df$T_NTarget > 0,
                                             pmin(treenut_df$T_NBiom / treenut_df$T_NTarget, 1),
                                             1)
    
    # T_NPosgro[SlNut,Tree] = if AF_RunNutLim?[SlNut] >0.5 then MAX(0,MIN(1,(2*(T_NTargetNbiomRatio[SlNut,Tree]-.4)))) else 1
    treenut_df$T_NPosgro <- ifelse(treenut_df$AF_RunNutLim_is > 0.5, pmax(0, pmin(1, (
      2 * (treenut_df$T_NTargetNbiomRatio - .4)
    ))), 1)
    
    # TF_WatNutSuff[Tree] = TF_RecentTWPosgro[Tree]*T_NPosgro[N,Tree]*T_NPosgro[P,Tree]
    tree_df$TF_WatNutSuff <- tree_df$TF_RecentTWPosgro * treenut_df[treenut_df$SlNut == "N", "T_NPosgro"] * treenut_df[treenut_df$SlNut == "P", "T_NPosgro"]
    
    # TF_PhyllochronStressed[Tree] = TF_PhyllochronStressFac[Tree]+(1-TF_PhyllochronStressFac[Tree])*TF_WatNutSuff[Tree]
    tree_df$TF_PhyllochronStressed <- tree_df$TF_PhyllochronStressFac +
      (1 - tree_df$TF_PhyllochronStressFac) * tree_df$TF_WatNutSuff
    
    # Simulation_Time = TIME
    Simulation_Time <- time
    
    # TF_AgeofPalm[Tree] = max(0, Simulation_Time-(T_PlantTime[Tree]-1))
    tree_df$TF_AgeofPalm <- pmax(0, Simulation_Time - (tree_df$T_PlantTime -
                                                         1))
    
    # TF_PotPhyllochronTime[Tree] = GRAPH(TF_AgeofPalm[Tree])
    tree_df$TF_PotPhyllochronTime <- get_y_df(tree_df$TF_AgeofPalm, "TF_PotPhyllochronTime")
    # tree_df$TF_PotPhyllochronTime <- get_TF_PotPhyllochronTime(tree_df$TF_AgeofPalm)
    
    # TF_PhyllochronTime[Tree] = if TF_PhyllochronStressed[Tree]> 0 then TF_PotPhyllochronTime[Tree]/TF_PhyllochronStressed[Tree] else 0
    tree_df$TF_PhyllochronTime <- ifelse(
      tree_df$TF_PhyllochronStressed > 0,
      tree_df$TF_PotPhyllochronTime / tree_df$TF_PhyllochronStressed,
      0
    )

    # TF_TrunkHIncr[Tree] = if (TF_CurrentLeafNo[Tree]>TF_PalmTrunkIntercept[Tree]) then TF_PalmTrunkInternode[Tree]/TF_PhyllochronTime[Tree] else 0
    tree_df$TF_TrunkHIncr <- ifelse(
      tree_df$TF_CurrentLeafNo > tree_df$TF_PalmTrunkIntercept,
      tree_df$TF_PalmTrunkInternode / tree_df$TF_PhyllochronTime,
      0
    )
    
    # TF_TrunkVolIncrement[Tree] = TF_TrunkHIncr[Tree]*3.14*(TF_TrunkDiam[Tree]/2*10^-2)^2
    tree_df$TF_TrunkVolIncrement <- tree_df$TF_TrunkHIncr * 3.14 * (tree_df$TF_TrunkDiam /
                                                                      2 * 10^-2)^2
    
    # TF_TrunkBiomass_GrowthAllocation[Tree] = TF_TrunkVolIncrement[Tree]*T_WoodDens[Tree]* T_TreesperHa[Tree]/10^4
    tree_df$TF_TrunkBiomass_GrowthAllocation <- tree_df$TF_TrunkVolIncrement * tree_df$T_WoodDens * tree_df$T_Treesperha /
      10^4
    
    # TF_PotentialFrondLength[Tree] = GRAPH(TF_PalmTrunkHeight[Tree])
    tree_df$TF_PotentialFrondLength <- get_y_df(tree_df$TF_PalmTrunkHeight, "TF_PotentialFrondLength")
    # tree_df$TF_PotentialFrondLength <- get_TF_PotentialFrondLength(tree_df$TF_PalmTrunkHeight)
    
    
    # TF_StressedFrondLength[Tree] = if TF_AgeofPalm[Tree] >0 then max(0,(1-TF_FrondLengthStressFac[Tree]+TF_FrondLengthStressFac[Tree]* TF_DW_Sufficiency_Yesterday[Tree])*TF_PotentialFrondLength[Tree]) else 0
    tree_df$TF_StressedFrondLength <- ifelse(tree_df$TF_AgeofPalm > 0,
                                             pmax(
                                               0,
                                               (
                                                 1 - tree_df$TF_FrondLengthStressFac +
                                                   tree_df$TF_FrondLengthStressFac * tree_df$TF_DW_Sufficiency_Yesterday
                                               ) * tree_df$TF_PotentialFrondLength
                                             ),
                                             0)
    
    # TF_TargetNewFrondBiom[Tree] = if TF_FrondLDpetPower[Tree] > 0 and TF_FrondLDpetInterc[Tree]> 0 then TF_FrondWDpetInterc[Tree]*(TF_StressedFrondLength[Tree]/TF_FrondLDpetInterc[Tree])^(TF_FrondWDpetPower[Tree]/TF_FrondLDpetPower[Tree]) else 0
    tree_df$TF_TargetNewFrondBiom <- ifelse(
      tree_df$TF_FrondLDpetPower > 0 & tree_df$TF_FrondLDpetInterc > 0,
      tree_df$TF_FrondWDpetInterc *
        (
          tree_df$TF_StressedFrondLength / tree_df$TF_FrondLDpetInterc
        )^(tree_df$TF_FrondWDpetPower /
             tree_df$TF_FrondLDpetPower),
      0
    )
    
    # TF_TargetLeafAlloc[Tree] = if TF_PhyllochronTime[Tree]>0 then (TF_TargetNewFrondBiom[Tree]/TF_PhyllochronTime[Tree])*T_TreesperHa[Tree]/10^4  else 0
    tree_df$TF_TargetLeafAlloc <- ifelse(
      tree_df$TF_PhyllochronTime > 0,
      (
        tree_df$TF_TargetNewFrondBiom / tree_df$TF_PhyllochronTime
      ) * tree_df$T_Treesperha /
        10^4,
      0
    )
    
    
    # TF_PalmTtBiomToLvs[Tree] = TF_TrunkBiomass_GrowthAllocation[Tree]+TF_TargetLeafAlloc[Tree]
    tree_df$TF_PalmTtBiomToLvs <- tree_df$TF_TrunkBiomass_GrowthAllocation + tree_df$TF_TargetLeafAlloc
    
    treepcomp_df$TF_PalmTtBiomToLvs <- rep(tree_df$TF_PalmTtBiomToLvs, nrow(pcomp_df))
    
    # TF_VegDemand[PlantComp,Tree] = TF_PalmTtBiomToLvs[Tree]*T_UnitConv[PlantComp]
    treepcomp_df$TF_VegDemand <- treepcomp_df$TF_PalmTtBiomToLvs * treepcomp_df$T_UnitConv
    
    # T_DOY = mod(time,365)
    T_DOY <- time %% 365
    
    # T_LeafFlush?[Sp1] = GRAPH(T_DOY)
    # T_LeafFlush?[Sp2] = GRAPH(T_DOY)
    # T_LeafFlush?[Sp3] = GRAPH(T_DOY)
    tree_df$T_LeafFlush_is <- get_y_df(T_DOY, "T_LeafFlush_is")
    # tree_df$T_LeafFlush_is <- get_T_LeafFlush_is(T_DOY)
    
    # T_LeavesPotFormed?[Tree] = if (T_DOY_SeaLitFall_1_Start[Tree] < T_DOY_1_LfFlush[Tree]) or (T_DOY_SeaLitFall_2_Start[Tree] < T_DOY_2_LfFlush[Tree]) then 1 + Max(0,min(1,(mod(time,365) - T_DOY_1_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_1_Start[Tree]))) + Max(0,min(1,(mod(time,365) - T_DOY_2_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_2_Start[Tree])))
    # else Max(0,min(1,(mod(time,365) - T_DOY_1_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_1_Start[Tree]))) + Max(0,min(1,(mod(time,365) - T_DOY_2_LfFlush[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_2_Start[Tree])))
    
    tree_df$T_LeavesPotFormed_is_a <- pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_1_LfFlush
    ))) -  pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_SeaLitFall_1_Start
    ))) + pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_2_LfFlush
    ))) -  pmax(0, pmin(1, ((time %% 365) - tree_df$T_DOY_SeaLitFall_2_Start
    )))
    
    tree_df$T_LeavesPotFormed_is <- ifelse(
      (
        tree_df$T_DOY_SeaLitFall_1_Start < tree_df$T_DOY_1_LfFlush
      ) |
        (
          tree_df$T_DOY_SeaLitFall_2_Start < tree_df$T_DOY_2_LfFlush
        ),
      1 + tree_df$T_LeavesPotFormed_is_a,
      tree_df$T_LeavesPotFormed_is_a
    )
    
    # T_LvsFormed?[Tree] = if T_GraphPhenol?[Tree] = 1 then T_LeafFlush?[Tree] else T_LeavesPotFormed?[Tree]
    tree_df$T_LvsFormed_is <- ifelse(
      tree_df$T_GraphPhenol_is == 1,
      tree_df$T_LeafFlush_is,
      tree_df$T_LeavesPotFormed_is
    )
    
    tree_df$T_Stage_VegGen <- treestage_df[treestage_df$Tree_Stage == "VegGen", "T_Stage"]
    
    # T_FruitAllocStage[Tree] = GRAPH(T_Stage[Tree,VegGen])
    tree_df$T_FruitAllocStage <- get_y_df(tree_df$T_Stage_VegGen, "T_FruitAllocStage")
    # tree_df$T_FruitAllocStage <- get_T_FruitAllocStage(tree_df$T_Stage_VegGen)
    
    # TW_UptTot[Sp1] = AF_ZoneFrac[Zn1]*(W_T1Upt1[Zn1]+W_T1Upt2[Zn1]+W_T1Upt3[Zn1]+W_T1Upt4[Zn1])+
    #   AF_ZoneFrac[Zn2]*(W_T1Upt1[Zn2]+W_T1Upt2[Zn2]+W_T1Upt3[Zn2]+W_T1Upt4[Zn2])+
    #   AF_ZoneFrac[Zn3]*(W_T1Upt1[Zn3]+W_T1Upt2[Zn3]+W_T1Upt3[Zn3]+W_T1Upt4[Zn3])+
    #   AF_ZoneFrac[Zn4]*(W_T1Upt1[Zn4]+W_T1Upt2[Zn4]+W_T1Upt3[Zn4]+W_T1Upt4[Zn4])+
    #   0*(W_T2Upt1[Zn1]+W_T2Upt2[Zn1]+W_T2Upt3[Zn1]+W_T2Upt4[Zn1] +
    #        W_T3Upt1[Zn1]+W_T3Upt2[Zn1]+W_T3Upt3[Zn1]+W_T3Upt4[Zn1])
    # TW_UptTot[Sp2] = AF_ZoneFrac[Zn1]*(W_T2Upt1[Zn1]+W_T2Upt2[Zn1]+W_T2Upt3[Zn1]+W_T2Upt4[Zn1])+
    #   AF_ZoneFrac[Zn2]*(W_T2Upt1[Zn2]+W_T2Upt2[Zn2]+W_T2Upt3[Zn2]+W_T2Upt4[Zn2])+
    #   AF_ZoneFrac[Zn3]*(W_T2Upt1[Zn3]+W_T2Upt2[Zn3]+W_T2Upt3[Zn3]+W_T2Upt4[Zn3])+
    #   AF_ZoneFrac[Zn4]*(W_T2Upt1[Zn4]+W_T2Upt2[Zn4]+W_T2Upt3[Zn4]+W_T2Upt4[Zn4])+
    #   0*(W_T1Upt1[Zn1]+W_T1Upt2[Zn1]+W_T1Upt3[Zn1]+W_T1Upt4[Zn1] +
    #        W_T3Upt1[Zn1]+W_T3Upt2[Zn1]+W_T3Upt3[Zn1]+W_T3Upt4[Zn1])
    # TW_UptTot[Sp3] = AF_ZoneFrac[Zn1]*(W_T3Upt1[Zn1]+W_T3Upt2[Zn1]+W_T3Upt3[Zn1]+W_T3Upt4[Zn1])+
    #   AF_ZoneFrac[Zn2]*(W_T3Upt1[Zn2]+W_T3Upt2[Zn2]+W_T3Upt3[Zn2]+W_T3Upt4[Zn2])+
    #   AF_ZoneFrac[Zn3]*(W_T3Upt1[Zn3]+W_T3Upt2[Zn3]+W_T3Upt3[Zn3]+W_T3Upt4[Zn3])+
    #   AF_ZoneFrac[Zn4]*(W_T3Upt1[Zn4]+W_T3Upt2[Zn4]+W_T3Upt3[Zn4]+W_T3Upt4[Zn4])+
    #   0*(W_T2Upt1[Zn1]+W_T2Upt2[Zn1]+W_T2Upt3[Zn1]+W_T2Upt4[Zn1] +
    #        W_T1Upt1[Zn1]+W_T1Upt2[Zn1]+W_T1Upt3[Zn1]+W_T1Upt4[Zn1])
    zonetree_df$W_Upt_sum <- aggregate(zonelayertree_df["W_Upt"], zonelayertree_df[c("zone", "tree_id")], sum)
    zonetree_df$W_Upt_sum_frac <- zonetree_df$AF_ZoneFrac * zonetree_df$W_Upt_sum
    tree_df$TW_UptTot <- aggregate(zonetree_df["W_Upt_sum_frac"], zonetree_df["tree_id"], sum)$W_Upt_sum_frac
    
    tree_df$AF_RunWatLim_is <- AF_RunWatLim_is
    # TW_Posgro[Tree] = IF (TW_DemandPot[Tree]>0 AND AF_RunWatLim? > 0.5)  THEN max(0,((TW_UptTot[Tree]-TP_WaterDemand[Tree])/(TW_DemandPot[Tree]-TP_WaterDemand[Tree]))) ELSE 1
    tree_df$TW_Posgro <- ifelse (tree_df$TW_DemandPot > 0 &
                                   tree_df$AF_RunWatLim_is > 0.5,
                                 pmax(0, ((tree_df$TW_UptTot - tree_df$TP_WaterDemand) / (tree_df$TW_DemandPot - tree_df$TP_WaterDemand)
                                 )),
                                 1)
    
    # T_RtAllocAct[Tree] = IF(RT_ATType[Tree]>1 )THEN MIN(0.98,MAX(RT_TAlloc[Tree],(1-(T_Stage[Tree,VegGen]/(T_Stage[Tree,VegGen]+RT_THalfRtAllocStage)))+(0.98*(T_Stage[Tree,VegGen]/(T_Stage[Tree,VegGen]+RT_THalfRtAllocStage)) - (1-(T_Stage[Tree,VegGen]/(T_Stage[Tree,VegGen]+RT_THalfRtAllocStage))))*(1 -(min( min(T_NPosgro[N, Tree], T_NPosgro[P, Tree],T_NPosgroMin[N,Tree], T_NPosgroMin[P,Tree]),TW_PosgroMin[Tree], TW_Posgro[Tree]))^(0.0001+RT_TAllocResp[Tree])))) else 0
    tree_df$T_RtAllocAct_a <- tree_df$T_Stage_VegGen / (tree_df$T_Stage_VegGen + RT_THalfRtAllocStage)
    tree_df$T_RtAllocAct <- ifelse(tree_df$RT_ATType > 1, pmin(0.98, pmax(
      tree_df$RT_TAlloc,
      (1 - tree_df$T_RtAllocAct_a) +
        (0.98 * tree_df$T_RtAllocAct_a -
           (1 - tree_df$T_RtAllocAct_a)) *
        (1 - (
          pmin(
            pmin(
              treenut_df[treenut_df$SlNut == "N", "T_NPosgro"],
              treenut_df[treenut_df$SlNut == "P", "T_NPosgro"],
              treenut_df[treenut_df$SlNut == "N", "T_NPosgroMin"],
              treenut_df[treenut_df$SlNut == "P", "T_NPosgroMin"]
            ),
            tree_df$TW_PosgroMin,
            tree_df$TW_Posgro
          )
        )^(0.0001 + tree_df$RT_TAllocResp))
    )), 0)
    
    treepcomp_df$T_LvsFormed_is <- rep(tree_df$T_LvsFormed_is, nrow(pcomp_df))
    treepcomp_df$T_FruitAllocStage <- rep(tree_df$T_FruitAllocStage, nrow(pcomp_df))
    treepcomp_df$T_RelFruitAllocMax <- rep(tree_df$T_RelFruitAllocMax, nrow(pcomp_df))
    treepcomp_df$T_RtAllocAct <- rep(tree_df$T_RtAllocAct, nrow(pcomp_df))
    # T_CanBiomInc[PlantComp,Tree] = if T_GrowsToday?[Tree] = 0 then 0  else if T_ApplyPalm?[Tree] = 1 then min(T_GroRes[PlantComp,Tree]*T_GroResFrac[Tree],TF_VegDemand[PlantComp,Tree]) else T_LvsFormed?[Tree]*MAX((T_LfTwig[DW, Tree]+(T_GroResFrac[Tree]*(1-T_FruitAllocStage[Tree]*T_RelFruitAllocMax[Tree])*T_GroRes[DW, Tree])*(1-T_RtAllocAct[Tree]))*T_UnitConv[PlantComp]*T_CanTargConc[PlantComp,Tree]-T_LfTwig[PlantComp,Tree],(T_GroResFrac[Tree]*T_GroRes[PlantComp,Tree])*(1-T_RtAllocAct[Tree]))
    treepcomp_df$T_CanBiomInc <- ifelse(
      treepcomp_df$T_GrowsToday_is == 0,
      0,
      ifelse(
        treepcomp_df$T_ApplyPalm_is == 1,
        pmin(
          treepcomp_df$T_GroRes * treepcomp_df$T_GroResFrac,
          treepcomp_df$TF_VegDemand
        ),
        treepcomp_df$T_LvsFormed_is *
          pmax((
            treepcomp_df$T_LfTwig_DW + (
              treepcomp_df$T_GroResFrac * (
                1 - treepcomp_df$T_FruitAllocStage * treepcomp_df$T_RelFruitAllocMax
              ) *
                treepcomp_df$T_GroRes_DW
            ) * (1 - treepcomp_df$T_RtAllocAct)
          ) * treepcomp_df$T_UnitConv * treepcomp_df$T_CanTargConc -
            treepcomp_df$T_LfTwig,
          (treepcomp_df$T_GroResFrac * treepcomp_df$T_GroRes) * (1 - treepcomp_df$T_RtAllocAct)
          )
      )
    )
    
    treepcomp_df$T_PlantTime <- rep(tree_df$T_PlantTime, nrow(pcomp_df))
    treepcomp_df$AF_AnyTrees_is <- AF_AnyTrees_is
    treepcomp_df$T_CanBiomInit <- rep(tree_df$T_CanBiomInit, nrow(pcomp_df))
    treepcomp_df$T_Treesperha <- rep(tree_df$T_Treesperha, nrow(pcomp_df))
    # T_CanInit[PlantComp,Tree] = if  time =  T_PlantTime[Tree] and  AF_AnyTrees? = 1 then T_UnitConv[PlantComp]*T_CanTargConc[PlantComp,Tree]*T_CanBiomInit[Tree]*T_TreesperHa[Tree]/10000 else 0
    treepcomp_df$T_CanInit <- ifelse(
      time ==  treepcomp_df$T_PlantTime &
        treepcomp_df$AF_AnyTrees_is == 1,
      treepcomp_df$T_UnitConv * treepcomp_df$T_CanTargConc * treepcomp_df$T_CanBiomInit * treepcomp_df$T_Treesperha /
        10000,
      0
    )
    
    # T_CanBiomIni[PlantComp,Tree] = T_CanInit[PlantComp,Tree]
    treepcomp_df$T_CanBiomIni <- treepcomp_df$T_CanInit
    
    # T_LifallRed[DW,Sp1] = 0*(T_Par1[LifallRedN]+T_Par2[LifallRedN]+T_Par3[LifallRedN])
    # T_LifallRed[DW,Sp2] = 0*(T_Par1[LifallRedN]+T_Par2[LifallRedN]+T_Par3[LifallRedN])
    # T_LifallRed[DW,Sp3] = 0*(T_Par1[LifallRedN]+T_Par2[LifallRedN]+T_Par3[LifallRedN])
    # T_LifallRed[N,Sp1] = T_Par1[LifallRedN]+0*T_Par2[LifallRedN]+0*T_Par3[LifallRedN]
    # T_LifallRed[N,Sp2] = 0*T_Par1[LifallRedN]+T_Par2[LifallRedN]+0*T_Par3[LifallRedN]
    # T_LifallRed[N,Sp3] = 0*T_Par1[LifallRedN]+0*T_Par2[LifallRedN]+T_Par3[LifallRedN]
    # T_LifallRed[P,Sp1] = T_Par1[LifallRedP]+0*T_Par2[LifallRedP]+0*T_Par3[LifallRedP]
    # T_LifallRed[P,Sp2] = 0*T_Par1[LifallRedP]+T_Par2[LifallRedP]+0*T_Par3[LifallRedP]
    # T_LifallRed[P,Sp3] = 0*T_Par1[LifallRedP]+0*T_Par2[LifallRedP]+T_Par3[LifallRedP]
    treepcomp_df$T_LifallRed <- 0
    treepcomp_df[treepcomp_df$PlantComp == "N", "T_LifallRed"] <- tree_df$T_NLifallRed_N
    treepcomp_df[treepcomp_df$PlantComp == "P", "T_LifallRed"] <- tree_df$T_NLifallRed_P
    
    # T_LifallRedFac[PlantComp,Tree] = IF(T_TargetCan[PlantComp,Tree]>0)THEN((T_LfTwig[PlantComp,Tree]/T_TargetCan[PlantComp,Tree])^T_LifallRed[PlantComp,Tree])ELSE(1)
    treepcomp_df$T_LifallRedFac <- ifelse(
      treepcomp_df$T_TargetCan > 0,
      (treepcomp_df$T_LfTwig / treepcomp_df$T_TargetCan)^treepcomp_df$T_LifallRed,
      1
    )
    
    # T_LeafAgeTurnover[Tree] = 1/365*T_LeafHalfLife[Tree]
    tree_df$T_LeafAgeTurnover <- 1 / 365 * tree_df$T_LeafHalfLife
    
    # T_LitFalFracDrought[Tree] = min(T_LifallDroughtFrac[Tree],max(0, T_CumWatStress[Tree] - T_LiFallThreshWStress[Tree]))
    tree_df$T_LitFalFracDrought <- pmin(
      tree_df$T_LifallDroughtFrac,
      pmax(0, tree_df$T_CumWatStress - tree_df$T_LiFallThreshWStress)
    )
    
    # T_GraphLeafFall[Sp1] = GRAPH(T_DOY)
    # T_GraphLeafFall[Sp2] = GRAPH(T_DOY)
    # T_GraphLeafFall[Sp3] = GRAPH(T_DOY)
    tree_df$T_GraphLeafFall <- get_y_df(T_DOY, "T_GraphLeafFall")
    # tree_df$T_GraphLeafFall <- get_T_GraphLeafFall(T_DOY)
    
    # T_PotSeasLiFall[Tree] = if (T_DOY_Compl_1_LfFall[Tree] < T_DOY_SeaLitFall_1_Start[Tree]) or (T_DOY_Compl_2_LfFall[Tree] < T_DOY_SeaLitFall_2_Start[Tree]) then 1 + Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_1_Start[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_1_LfFall[Tree]))) + Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_2_Start[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_2_LfFall[Tree]))) else Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_1_Start[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_1_LfFall[Tree]))) + Max(0,min(1,(mod(time,365) - T_DOY_SeaLitFall_2_Start[Tree]))) -  Max(0,min(1,(mod(time,365) - T_DOY_Compl_2_LfFall[Tree])))
    tree_df$T_PotSeasLiFall_a <- pmax(0, pmin(1, T_DOY - tree_df$T_DOY_SeaLitFall_1_Start)) -
      pmax(0, pmin(1, T_DOY - tree_df$T_DOY_Compl_1_LfFall)) +
      pmax(0, pmin(1, T_DOY - tree_df$T_DOY_SeaLitFall_2_Start)) -
      pmax(0, pmin(1, T_DOY - tree_df$T_DOY_Compl_2_LfFall))
    
    tree_df$T_PotSeasLiFall <- ifelse(
      (
        tree_df$T_DOY_Compl_1_LfFall < tree_df$T_DOY_SeaLitFall_1_Start
      ) |
        (
          tree_df$T_DOY_Compl_2_LfFall < tree_df$T_DOY_SeaLitFall_2_Start
        ),
      1 + tree_df$T_PotSeasLiFall_a,
      tree_df$T_PotSeasLiFall_a
    )
    
    # T_PotSeasLiFallFrac[Tree] = if T_GraphPhenol?[Tree] = 1 then T_GraphLeafFall[Tree] else if T_DOY_Compl_1_LfFall[Tree]>T_DOY_SeaLitFall_1_Start[Tree] then (if mod(time,365) = T_DOY_Compl_1_LfFall[Tree] or mod(time,365) = T_DOY_Compl_2_LfFall[Tree] then T_FracSeasLitFll_1[Tree]*(1 - (1/(T_DOY_Compl_1_LfFall[Tree]-T_DOY_SeaLitFall_1_Start[Tree]))^(T_DOY_Compl_1_LfFall[Tree]-T_DOY_SeaLitFall_1_Start[Tree])) else T_FracSeasLitFll_1[Tree]*T_PotSeasLiFall[Tree]/(T_DOY_Compl_1_LfFall[Tree]-T_DOY_SeaLitFall_1_Start[Tree])) else (if mod(time,365) = T_DOY_Compl_1_LfFall[Tree] or mod(time,365) = T_DOY_Compl_2_LfFall[Tree] then T_FracSeasLitFll_1[Tree]*(1 - (1/(365 - T_DOY_SeaLitFall_1_Start[Tree] + T_DOY_Compl_1_LfFall[Tree]))^(365 - T_DOY_SeaLitFall_1_Start[Tree] + T_DOY_Compl_1_LfFall[Tree])) else T_FracSeasLitFll_1[Tree]*T_PotSeasLiFall[Tree]/ min(10,(365 - T_DOY_SeaLitFall_1_Start[Tree] + T_DOY_Compl_1_LfFall[Tree])))
    tree_df$T_PotSeasLiFallFrac <- ifelse(
      tree_df$T_GraphPhenol_is == 1,
      tree_df$T_GraphLeafFall,
      ifelse(
        tree_df$T_DOY_Compl_1_LfFall > tree_df$T_DOY_SeaLitFall_1_Start,
        ifelse(
          T_DOY == tree_df$T_DOY_Compl_1_LfFall |
            T_DOY == tree_df$T_DOY_Compl_2_LfFall,
          tree_df$T_FracSeasLitFll_1 *
            (
              1 - (
                1 / (
                  tree_df$T_DOY_Compl_1_LfFall - tree_df$T_DOY_SeaLitFall_1_Start
                )
              )^(
                tree_df$T_DOY_Compl_1_LfFall - tree_df$T_DOY_SeaLitFall_1_Start
              )
            ),
          tree_df$T_FracSeasLitFll_1 * tree_df$T_PotSeasLiFall /
            (
              tree_df$T_DOY_Compl_1_LfFall - tree_df$T_DOY_SeaLitFall_1_Start
            )
        ),
        ifelse(
          T_DOY == tree_df$T_DOY_Compl_1_LfFall |
            T_DOY == tree_df$T_DOY_Compl_2_LfFall,
          tree_df$T_FracSeasLitFll_1 *
            (
              1 - (
                1 / (
                  365 - tree_df$T_DOY_SeaLitFall_1_Start + tree_df$T_DOY_Compl_1_LfFall
                )
              )^(
                365 - tree_df$T_DOY_SeaLitFall_1_Start + tree_df$T_DOY_Compl_1_LfFall
              )
            ),
          tree_df$T_FracSeasLitFll_1 * tree_df$T_PotSeasLiFall / pmin(
            10,
            (
              365 - tree_df$T_DOY_SeaLitFall_1_Start + tree_df$T_DOY_Compl_1_LfFall
            )
          )
        )
      )
    )
    
    # T_StemDAllom[Tree] = if T_LfTwig[DW,Tree] > 0.001 AND T_DiamSlopeLfTwig[Tree]>0  then (T_LfTwig[DW, Tree]*10000/(T_Treesperha[Tree]*T_DiamLfTwig1[Tree]))^(1/T_DiamSlopeLfTwig[Tree]) else 0
    tree_df$T_StemDAllom <- ifelse(
      tree_df$T_LfTwig_DW > 0.001 & tree_df$T_DiamSlopeLfTwig > 0,
      (
        tree_df$T_LfTwig_DW * 10000 / (tree_df$T_Treesperha * tree_df$T_DiamLfTwig1)
      )^(1 / tree_df$T_DiamSlopeLfTwig),
      0
    )
    
    
    # T_CumLitTarget[Tree] = T_Treesperha[Tree]*0.0001*T_DiamCumLit1[Tree]*(T_StemDAllom[Tree]^T_DiamSlopeCumLit[Tree])
    tree_df$T_CumLitTarget <- tree_df$T_Treesperha * 0.0001 * tree_df$T_DiamCumLit1 *
      (tree_df$T_StemDAllom^tree_df$T_DiamSlopeCumLit)
    
    # T_FBALitFal[Tree] = T_ApplyFBA?[Tree]*max(0,T_LifallDelay*(T_CumLitTarget[Tree]-T_LifallCum[DW,Tree]))
    tree_df$T_FBALitFal <- tree_df$T_ApplyFBA_is * pmax(0,
                                                        T_LifallDelay * (tree_df$T_CumLitTarget - treepcomp_df[treepcomp_df$PlantComp == "DW", ]$T_LifallCum))
    
    # TF_LeafClockTicks?[Tree] = if Simulation_Time<T_PlantTime[Tree] then 0 else if Simulation_Time - TF_LeafTime[Tree] >=TF_PhyllochronTime[Tree] then TF_PhyllochronTime[Tree] else 0
    tree_df$TF_LeafClockTicks_is <- ifelse(
      Simulation_Time < tree_df$T_PlantTime,
      0,
      ifelse(
        Simulation_Time - tree_df$TF_LeafTime >= tree_df$TF_PhyllochronTime,
        tree_df$TF_PhyllochronTime,
        0
      )
    )
    
    # TF_NewLeaf?[Tree] = if TF_LeafClockTicks?[Tree] <> 0 then 1 else 0
    tree_df$TF_NewLeaf_is <- ifelse(tree_df$TF_LeafClockTicks_is != 0, 1, 0)
    
    # TF_FruitHarvNoperBunch[Sp1,Ripe] = if TF_NewLeaf?[Sp1] = 1 then TF_FruitsperBunch[Sp1,Ripe] else 0
    # TF_FruitHarvNoperBunch[Sp1,Ripe_1] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_2] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_3] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_4] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_5] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_6] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_7] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_8] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_9] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_10] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_11] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Ripe_12] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Early_fruit] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Pollinated] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis_1] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis_2] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis_3] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis_4] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis_5] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp1,Anthesis_6] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe] = if TF_NewLeaf?[Sp2] = 1 then TF_FruitsperBunch[Sp2,Ripe] else 0
    # TF_FruitHarvNoperBunch[Sp2,Ripe_1] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_2] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_3] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_4] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_5] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_6] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_7] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_8] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_9] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_10] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_11] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Ripe_12] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Early_fruit] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Pollinated] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis_1] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis_2] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis_3] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis_4] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis_5] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp2,Anthesis_6] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe] = if TF_NewLeaf?[Sp3] = 1 then TF_FruitsperBunch[Sp3,Ripe] else 0
    # TF_FruitHarvNoperBunch[Sp3,Ripe_1] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_2] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_3] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_4] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_5] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_6] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_7] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_8] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_9] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_10] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_11] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Ripe_12] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Early_fruit] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Pollinated] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis_1] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis_2] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis_3] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis_4] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis_5] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    # TF_FruitHarvNoperBunch[Sp3,Anthesis_6] = 0*(TF_FruitsperBunch[Sp3,Ripe_1]+TF_NewLeaf?[Sp1])
    treefruit_df$TF_FruitHarvNoperBunch <- 0
    treefruit_df[treefruit_df$Fruitbunch == "Ripe", "TF_FruitHarvNoperBunch"] <- ifelse(tree_df$TF_NewLeaf_is == 1, 1, 0)
    
    # T_LitFalFracShade[Tree] =  Max(0,T_LAICan[Tree]-T_LAIMax[Tree], T_CanH[Tree]-T_CanHMax[Tree])
    tree_df$T_LitFalFracShade <-  pmax(0,
                                       tree_df$T_LAICan - tree_df$T_LAIMax,
                                       tree_df$T_CanH - tree_df$T_CanHMax)
    
    # TF_OldFrondChange2[Tree] = if TF_FruitHarvNoperBunch[Tree,Ripe]>0 then TF_OldFrontBiomass[Tree] else 0
    tree_df$TF_OldFrondChange2 <- ifelse(treefruit_df[treefruit_df$Fruitbunch == "Ripe", "TF_FruitHarvNoperBunch"] > 0,
                                         tree_df$TF_OldFrontBiomass,
                                         0)
    
    # TF_LiFall[Tree] = TF_OldFrondChange2[Tree]
    tree_df$TF_LiFall <- tree_df$TF_OldFrondChange2
    
    
    treepcomp_df$T_LeafAgeTurnover <- rep(tree_df$T_LeafAgeTurnover, nrow(pcomp_df))
    treepcomp_df$T_LitFalFracDrought <- rep(tree_df$T_LitFalFracDrought, nrow(pcomp_df))
    treepcomp_df$T_PotSeasLiFallFrac <- rep(tree_df$T_PotSeasLiFallFrac, nrow(pcomp_df))
    treepcomp_df$T_FBALitFal <- rep(tree_df$T_FBALitFal, nrow(pcomp_df))
    treepcomp_df$T_LitFalFracShade <- rep(tree_df$T_LitFalFracShade, nrow(pcomp_df))
    treepcomp_df$TF_LiFall <- rep(tree_df$TF_LiFall, nrow(pcomp_df))
    treepcomp_df$TF_LitFallRedFac <- rep(pcomp_df$TF_LitFallRedFac, each = ntree)
    # T_LifallInc[PlantComp,Tree] = if T_ApplyPalm?[Tree] = 0 then min(1,T_LifallRedFac[PlantComp,Tree]*T_LWR[Tree]) * ((T_LfTwig[PlantComp,Tree]*(T_LeafAgeTurnover[Tree]+T_LitFalFracDrought[Tree] +T_PotSeasLiFallFrac[Tree] +T_FBALitFal[Tree]) + T_CanBiomInc[PlantComp,Tree]*T_LitFalFracShade[Tree])) else TF_LiFall[Tree]*TF_LitFallRedFac[PlantComp] * TF_LiFall_ResWithdrawl
    treepcomp_df$T_LifallInc <- ifelse(
      treepcomp_df$T_ApplyPalm_is == 0,
      pmin(1, treepcomp_df$T_LifallRedFac * treepcomp_df$T_LWR) *
        ((
          treepcomp_df$T_LfTwig * (
            treepcomp_df$T_LeafAgeTurnover + treepcomp_df$T_LitFalFracDrought + treepcomp_df$T_PotSeasLiFallFrac + treepcomp_df$T_FBALitFal
          ) +
            treepcomp_df$T_CanBiomInc * treepcomp_df$T_LitFalFracShade
        )
        ),
      treepcomp_df$TF_LiFall * treepcomp_df$TF_LitFallRedFac * TF_LiFall_ResWithdrawl
    )
    
    # TF_RelStemAlloc[Tree] = if TF_PalmTtBiomToLvs[Tree] = 0 then 0 else TF_TrunkBiomass_GrowthAllocation[Tree]/TF_PalmTtBiomToLvs[Tree]
    tree_df$TF_RelStemAlloc <- ifelse(
      tree_df$TF_PalmTtBiomToLvs == 0,
      0,
      tree_df$TF_TrunkBiomass_GrowthAllocation / tree_df$TF_PalmTtBiomToLvs
    )
    
    tree_df$T_BiomAG_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_BiomAG"]
    
    # T_SapWoodDiam[Tree] = if T_BiomAG[DW,Tree] > 0.001 AND T_DiamSlopeBiom[Tree]>0  then (T_BiomAG[DW, Tree]*10000/(T_Treesperha[Tree]*T_DiamBiom1[Tree]))^(1/T_DiamSlopeBiom[Tree]) else 0
    tree_df$T_SapWoodDiam <- ifelse(
      tree_df$T_BiomAG_DW > 0.001 &
        tree_df$T_DiamSlopeBiom > 0,
      (
        tree_df$T_BiomAG_DW * 10000 / (tree_df$T_Treesperha * tree_df$T_DiamBiom1)
      )^(1 / tree_df$T_DiamSlopeBiom),
      0
    )
    # T_TargetLeaf&Twig[Tree] = 0.0001*T_Treesperha[Tree]*T_DiamLfTwig1[Tree]*(T_SapWoodDiam[Tree]^T_DiamSlopeLfTwig[Tree])
    tree_df$T_TargetLeafTwig <- 0.0001 * tree_df$T_Treesperha * tree_df$T_DiamLfTwig1 *
      (tree_df$T_SapWoodDiam^tree_df$T_DiamSlopeLfTwig)
    
    treepcomp_df$TF_TrunkBiomass_GrowthAllocation <- rep(tree_df$TF_TrunkBiomass_GrowthAllocation,
                                                         nrow(pcomp_df))
    treepcomp_df$T_ApplyFBA_is <- rep(tree_df$T_ApplyFBA_is, nrow(pcomp_df))
    treepcomp_df$T_LAICan <- rep(tree_df$T_LAICan, nrow(pcomp_df))
    treepcomp_df$T_LAIMax <- rep(tree_df$T_LAIMax, nrow(pcomp_df))
    treepcomp_df$T_CanH <- rep(tree_df$T_CanH, nrow(pcomp_df))
    treepcomp_df$T_CanHMax <- rep(tree_df$T_CanHMax, nrow(pcomp_df))
    treepcomp_df$T_TargetLeafTwig <- rep(tree_df$T_TargetLeafTwig, nrow(pcomp_df))
    
    # T_WoodInc[PlantComp,Tree] = if T_ApplyPalm?[Tree] = 1 then
    # min(TF_RelStemAlloc[Tree]*T_CanBiomInc[PlantComp,Tree],TF_TrunkBiomass_GrowthAllocation[Tree]*T_WoodConc[PlantComp,Tree] ) else
    #   if T_ApplyFBA?[Tree] = 0 then
    #     (IF(T_LAICan[Tree]>T_LAIMax[Tree])THEN(T_CanBiomInc[PlantComp,Tree]*(1-T_LWR[Tree])) ELSE
    #       (IF(T_CanH[Tree]>T_CanHMax[Tree])THEN (T_CanBiomInc[PlantComp,Tree]*(1-T_LWR[Tree])*(1-T_CanHMax[Tree]/T_CanH[Tree])^2)ELSE(0))) else
    #     max(0,-T_TargetLeaf&Twig[Tree]+T_LfTwig[DW,Tree])*T_UnitConv[PlantComp]*T_WoodConc[PlantComp,Tree]
    treepcomp_df$T_WoodInc <- ifelse(
      treepcomp_df$T_ApplyPalm_is == 1,
      pmin(
        treepcomp_df$TF_RelStemAlloc * treepcomp_df$T_CanBiomInc,
        treepcomp_df$TF_TrunkBiomass_GrowthAllocation * treepcomp_df$T_WoodConc
      ),
      ifelse(
        treepcomp_df$T_ApplyFBA_is == 0,
        ifelse(
          treepcomp_df$T_LAICan > treepcomp_df$T_LAIMax,
          treepcomp_df$T_CanBiomInc * (1 - treepcomp_df$T_LWR),
          ifelse(
            treepcomp_df$T_CanH > treepcomp_df$T_CanHMax,
            treepcomp_df$T_CanBiomInc * (1 - treepcomp_df$T_LWR) * (1 - treepcomp_df$T_CanHMax / treepcomp_df$T_CanH)^2,
            0
          )
        ),
        pmax(
          0,
          -treepcomp_df$T_TargetLeafTwig + treepcomp_df$T_LfTwig_DW
        ) *
          treepcomp_df$T_UnitConv * treepcomp_df$T_WoodConc
      )
    )
    
    treeanimal_df$PD_THerbivore_is <- rep(animal_df$PD_THerbivore_is, each = ntree)
    
    # PD_THerbImp[Tree,Animals] = PD_NastiesinPlot[Animals]*PD_THerbivore?[Animals]*PD_TEatenBy?[Tree,Animals]
    treeanimal_df$PD_THerbImp <- treeanimal_df$PD_NastiesinPlot * treeanimal_df$PD_THerbivore_is * treeanimal_df$PD_TEatenBy_is
    
    # PD_THerbVFrac[Tree] = min(1,PD_THerbivory[Tree]+AF_DynPestImpacts?*ARRAYSUM(PD_THerbImp[Tree,*]))
    tree_df$PD_THerbVFrac <- pmin(
      1,
      tree_df$PD_THerbivory + AF_DynPestImpacts_is * aggregate(treeanimal_df["PD_THerbImp"], treeanimal_df["tree_id"], sum)$PD_THerbImp
    )
    
    treepcomp_df$PD_THerbVFrac <- rep(tree_df$PD_THerbVFrac, nrow(pcomp_df))
    
    # T_Herbivory[PlantComp,Tree] = PD_THerbVFrac[Tree]*T_LfTwig[PlantComp,Tree]
    treepcomp_df$T_Herbivory <- treepcomp_df$PD_THerbVFrac * treepcomp_df$T_LfTwig
    
    treepcomp_df$SB_SlashTime <- rep(tree_df$SB_SlashTime, nrow(pcomp_df))
    treepcomp_df$T_DiesToday_is <- rep(tree_df$T_DiesToday_is, nrow(pcomp_df))
    
    # T_CanBiomSlashed[PlantComp,Tree] = if time = int(S&B_SlashTime[Tree]) or S&B_FireTime? = 1 or T_DiesToday?[Tree] = 1  then T_LfTwig[PlantComp,Tree]/dt else 0
    treepcomp_df$T_CanBiomSlashed <- ifelse(
      time == floor(treepcomp_df$SB_SlashTime) |
        SB_FireTime_is == 1 |
        treepcomp_df$T_DiesToday_is == 1,
      treepcomp_df$T_LfTwig,
      0
    )
    
    # T_WoodHarvDoY[Sp1] = GRAPH(T_WoodHarvPast[Sp1])
    # T_WoodHarvDoY[Sp2] = GRAPH(T_WoodHarvPast[Sp2])
    # T_WoodHarvDoY[Sp3] = GRAPH(T_WoodHarvPast[Sp3])
    tree_df$T_WoodHarvDoY <- c(
      get_y_df(tree_df$T_WoodHarvPast[1], "T_WoodHarvDoY_Sp1"),
      get_y_df(tree_df$T_WoodHarvPast[2], "T_WoodHarvDoY_Sp2"),
      get_y_df(tree_df$T_WoodHarvPast[3], "T_WoodHarvDoY_Sp3")
    )
    tree_df$T_WoodHarvY <- c(
      get_y_df(tree_df$T_WoodHarvPast[1], "T_WoodHarvY_Sp1"),
      get_y_df(tree_df$T_WoodHarvPast[2], "T_WoodHarvY_Sp2"),
      get_y_df(tree_df$T_WoodHarvPast[3], "T_WoodHarvY_Sp3")
    )
    
    # tree_df$T_WoodHarvDoY <- get_T_WoodHarvDoY(tree_df$T_WoodHarvPast)
    # tree_df$T_WoodHarvY <- get_T_WoodHarvY(tree_df$T_WoodHarvPast)
    
    # T_WoodHarvDay[Tree] = T_WoodHarvDoY[Tree]+365*(T_WoodHarvY[Tree])-CA_DOYStart
    tree_df$T_WoodHarvDay <- tree_df$T_WoodHarvDoY + 365 * (tree_df$T_WoodHarvY) -
      CA_DOYStart
    
    treepcomp_df$T_WoodHarvDay <- rep(tree_df$T_WoodHarvDay, nrow(pcomp_df))
    # T_CanBiomTimHarv[PlantComp,Tree] = IF TIME = T_WoodHarvDay[Tree] THEN T_LfTwig[PlantComp,Tree] ELSE 0
    treepcomp_df$T_CanBiomTimHarv <- ifelse(time == treepcomp_df$T_WoodHarvDay,
                                            treepcomp_df$T_LfTwig,
                                            0)
    
    # TF_DWSufficiency[Tree] = if TF_PalmTtBiomToLvs[Tree] > 0 then T_CanBiomInc[DW,Tree]/TF_PalmTtBiomToLvs[Tree] else 1
    tree_df$TF_DWSufficiency <- ifelse(
      tree_df$TF_PalmTtBiomToLvs > 0,
      treepcomp_df[treepcomp_df$PlantComp == "DW", ]$T_CanBiomInc / tree_df$TF_PalmTtBiomToLvs,
      1
    )
    
    # TF_FrondGrowth[Tree] = if TF_AgeofPalm[Tree] > 0 then if TF_TrunkHIncr[Tree] > 0 then
    # (1-TF_FrondHistFrac[Tree]*TF_DWSufficiency[Tree])*(TF_StressedFrondLength[Tree]- TF_RecentFrondLength[Tree]) else 0 else 0
    tree_df$TF_FrondGrowth <- ifelse(tree_df$TF_AgeofPalm > 0,
                                     ifelse(
                                       tree_df$TF_TrunkHIncr > 0,
                                       (1 - tree_df$TF_FrondHistFrac * tree_df$TF_DWSufficiency) * (
                                         tree_df$TF_StressedFrondLength - tree_df$TF_RecentFrondLength
                                       ),
                                       0
                                     ),
                                     0)
    
    # TF_PotentialStemD[Tree] = GRAPH(TF_CurrentLeafNo[Tree])
    tree_df$TF_PotentialStemD <- get_y_df(tree_df$TF_CurrentLeafNo, "TF_PotentialStemD")
    # tree_df$TF_PotentialStemD <- get_TF_PotentialStemD(tree_df$TF_CurrentLeafNo)
    
    # TF_TrunkDiamGrowth[Tree] = if TF_AgeofPalm[Tree] > 0 then if TF_NewLeaf?[Tree]  = 1 then (1-TF_StemDHistFrac[Tree]*TF_DWSufficiency[Tree])*(1-TF_StemDStressFactor[Tree]+TF_StemDStressFactor[Tree]*TF_DWSufficiency[Tree])*(TF_PotentialStemD[Tree]-TF_TrunkDiam[Tree]) else 0 else 0
    tree_df$TF_TrunkDiamGrowth <- ifelse(tree_df$TF_AgeofPalm > 0,
                                         ifelse(
                                           tree_df$TF_NewLeaf_is == 1,
                                           (1 - tree_df$TF_StemDHistFrac *
                                              tree_df$TF_DWSufficiency) *
                                             (
                                               1 - tree_df$TF_StemDStressFactor + tree_df$TF_StemDStressFactor * tree_df$TF_DWSufficiency
                                             ) *
                                             (tree_df$TF_PotentialStemD -
                                                tree_df$TF_TrunkDiam),
                                           0
                                         ),
                                         0)
    
    # T_HeartWoodDiamInc[Tree] = max((T_SapWoodEqDiam[Tree]^(2/T_SapWoodScalingRule)-T_SapWoodEqDiam[Tree]^2)^0.5 - T_HeartWoodDiam[Tree],0)
    tree_df$T_HeartWoodDiamInc <- pmax((
      tree_df$T_SapWoodEqDiam^(2 / T_SapWoodScalingRule) - tree_df$T_SapWoodEqDiam^2
    )^0.5 - tree_df$T_HeartWoodDiam,
    0
    )
    
    # T_DiamHeartWoodTDies[Tree] = if T_DiesToday?[Tree] = 1 then T_HeartWoodDiam[Tree] else 0
    tree_df$T_DiamHeartWoodTDies <- ifelse(tree_df$T_DiesToday_is == 1, tree_df$T_HeartWoodDiam, 0)
    
    
    # T_StemDiamGrowth[Tree] = if T_ApplyPalm?[Tree] = 1 then TF_TrunkDiamGrowth[Tree] else max(0,(T_SapWoodDiam[Tree]-T_SapWoodEqDiam[Tree]))
    tree_df$T_StemDiamGrowth <- ifelse(
      tree_df$T_ApplyPalm_is == 1,
      tree_df$TF_TrunkDiamGrowth,
      pmax(0, tree_df$T_SapWoodDiam - tree_df$T_SapWoodEqDiam)
    )
    
    # T_StemBefPruningInc[Tree] = if T_HeartWoodAllocAftPruned? = 1 and T_Prun[DW,Tree]>0 then T_SapWoodEqDiam[Tree] else 0
    tree_df$T_StemBefPruningInc <- ifelse(
      T_HeartWoodAllocAftPruned_is == 1 &
        treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Prun"] > 0,
      tree_df$T_SapWoodEqDiam,
      0
    )
    
    # T_DiamSapWoodTreeDies[Tree] = if T_DiesToday?[Tree] = 1 then T_SapWoodEqDiam[Tree] else 0
    tree_df$T_DiamSapWoodTreeDies <- ifelse(tree_df$T_DiesToday_is == 1, tree_df$T_SapWoodEqDiam, 0)
    
    # T_CanBiomSlashed[PlantComp,Tree] = if time = int(S&B_SlashTime[Tree]) or S&B_FireTime? = 1 or T_DiesToday?[Tree] = 1  then T_LfTwig[PlantComp,Tree]/dt else 0
    treepcomp_df$T_CanBiomSlashed <- ifelse(
      time == floor(treepcomp_df$SB_SlashTime) |
        SB_FireTime_is == 1 | treepcomp_df$T_DiesToday_is == 1,
      treepcomp_df$T_LfTwig,
      0
    )
    
    # T_FruitSlashed[PlantComp,Tree] = if time = int(S&B_SlashTime[Tree]) then T_Fruit[PlantComp,Tree]/dt else 0
    treepcomp_df$T_FruitSlashed <- ifelse(time == floor(treepcomp_df$SB_SlashTime),
                                          treepcomp_df$T_Fruit,
                                          0)
    
    # T_BiomassSlashed[PlantComp] = ARRAYSUM(T_CanBiomSlashed[PlantComp,*])+ARRAYSUM(T_FruitSlashed[PlantComp,*])
    pcomp_df$T_BiomassSlashed <- aggregate(treepcomp_df["T_CanBiomSlashed"], treepcomp_df["PlantComp"], sum)$T_CanBiomSlashed +
      aggregate(treepcomp_df["T_FruitSlashed"], treepcomp_df["PlantComp"], sum)$T_FruitSlashed
    
    # S&B_SlashVegetation[Zone,PlantComp] =  T_BiomassSlashed[PlantComp]
    zonepcomp_df$SB_SlashVegetation <-  rep(pcomp_df$T_BiomassSlashed, each = nzone)
    
    # S&B_AerosolFrac[Zone] = GRAPH(S&B_FireTempIncSurf[Zone])
    zone_df$SB_AerosolFrac <- get_y_df(zone_df$SB_FireTempIncSurf, "SB_AerosolFrac")
    
    # S&B_NecroBurnFrac[Zone] = GRAPH(S&B_FireTempIncSurf[Zone])
    zone_df$SB_NecroBurnFrac <- get_y_df(zone_df$SB_FireTempIncSurf, "SB_NecroBurnFrac")
    
    zonepcomp_df$SB_AerosolFrac <- rep(zone_df$SB_AerosolFrac, nrow(pcomp_df))
    zonepcomp_df$SB_NecroBurnFrac <- rep(zone_df$SB_NecroBurnFrac, nrow(pcomp_df))
    zonepcomp_df$SB_DW_is <- rep(pcomp_df$SB_DW_is, each = nzone)
    # S&B_NecromassBurn[Zone,PlantComp] = S&B_DW?[PlantComp]*S&B_FineNecromass[Zone,PlantComp]*S&B_NecroBurnFrac[Zone]*(1-S&B_AerosolFrac[Zone])
    zonepcomp_df$SB_NecromassBurn <- zonepcomp_df$SB_DW_is * zonepcomp_df$SB_FineNecromass * zonepcomp_df$SB_NecroBurnFrac *
      (1 - zonepcomp_df$SB_AerosolFrac)
    
    # S&B_NVolatFrac[Zone] = GRAPH(S&B_FireTempIncSurf[Zone])
    # S&B_PVolatFrac[Zone] = GRAPH(S&B_FireTempIncSurf[Zone])
    # S&B_NutVolatFrac[Zn1,DW] = 0*(S&B_NVolatFrac[Zn1]+S&B_PVolatFrac[Zn1])
    # S&B_NutVolatFrac[Zn1,N] = S&B_NVolatFrac[Zn1]+0*S&B_PVolatFrac[Zn1]
    # S&B_NutVolatFrac[Zn1,P] = 0*S&B_NVolatFrac[Zn1]+S&B_PVolatFrac[Zn1]
    # S&B_NutVolatFrac[Zn2,DW] = 0*(S&B_NVolatFrac[Zn2]+S&B_PVolatFrac[Zn2])
    # S&B_NutVolatFrac[Zn2,N] = S&B_NVolatFrac[Zn2]+0*S&B_PVolatFrac[Zn2]
    # S&B_NutVolatFrac[Zn2,P] = 0*S&B_NVolatFrac[Zn2]+S&B_PVolatFrac[Zn2]
    # S&B_NutVolatFrac[Zn3,DW] = 0*(S&B_NVolatFrac[Zn3]+S&B_PVolatFrac[Zn3])
    # S&B_NutVolatFrac[Zn3,N] = S&B_NVolatFrac[Zn3]+0*S&B_PVolatFrac[Zn3]
    # S&B_NutVolatFrac[Zn3,P] = 0*S&B_NVolatFrac[Zn3]+S&B_PVolatFrac[Zn3]
    # S&B_NutVolatFrac[Zn4,DW] = 0*(S&B_NVolatFrac[Zn4]+S&B_PVolatFrac[Zn4])
    # S&B_NutVolatFrac[Zn4,N] = S&B_NVolatFrac[Zn4]+0*S&B_PVolatFrac[Zn4]
    # S&B_NutVolatFrac[Zn4,P] = 0*S&B_NVolatFrac[Zn4]+S&B_PVolatFrac[Zn4]
    zonepcomp_df$SB_NutVolatFrac <- 0
    zonepcomp_df[zonepcomp_df$PlantComp == "N", "SB_NutVolatFrac"] <- get_y_df(zone_df$SB_FireTempIncSurf, "SB_NVolatFrac")
    zonepcomp_df[zonepcomp_df$PlantComp == "P", "SB_NutVolatFrac"] <- get_y_df(zone_df$SB_FireTempIncSurf, "SB_PVolatFrac")
    
    # S&B_NecroFNutVolat[Zone,PlantComp] = (1-S&B_DW?[PlantComp])*S&B_NutVolatFrac[Zone,PlantComp]*S&B_FineNecromass[Zone,PlantComp]*S&B_NecroBurnFrac[Zone]
    zonepcomp_df$SB_NecroFNutVolat <- (1 - zonepcomp_df$SB_DW_is) * zonepcomp_df$SB_NutVolatFrac * zonepcomp_df$SB_FineNecromass * zonepcomp_df$SB_NecroBurnFrac
    
    # S&B_MinNutRele[Zone,PlantComp] = (1-S&B_DW?[PlantComp])*(1-S&B_NutVolatFrac[Zone,PlantComp])*S&B_FineNecromass[Zone,PlantComp]*S&B_NecroBurnFrac[Zone]
    zonepcomp_df$SB_MinNutRele <- (1 - zonepcomp_df$SB_DW_is) * (1 - zonepcomp_df$SB_NutVolatFrac) * zonepcomp_df$SB_FineNecromass * zonepcomp_df$SB_NecroBurnFrac
    
    # S&B_PileSum = AF_ZoneFrac[Zn1]*S&B_PileUpWgt[Zn1]+AF_ZoneFrac[Zn2]*S&B_PileUpWgt[Zn2]+AF_ZoneFrac[Zn3]*S&B_PileUpWgt[Zn3]+AF_ZoneFrac[Zn4]*S&B_PileUpWgt[Zn4]
    SB_PileSum <- sum(zone_df$AF_ZoneFrac * zone_df$SB_PileUpWgt)
    
    # S&B_RelPileUp[Zone] = if S&B_PileSum > 0 then S&B_PileUpWgt[Zone]/S&B_PileSum else 0
    zone_df$SB_RelPileUp <- ifelse(SB_PileSum > 0, zone_df$SB_PileUpWgt /
                                     SB_PileSum, 0)
    
    # S&B_NecromLitTransf[Zone,PlantComp] = S&B_DailyNecromLitTransfer*S&B_FineNecromass[Zone,PlantComp]
    zonepcomp_df$SB_NecromLitTransf <- SB_DailyNecromLitTransfer * zonepcomp_df$SB_FineNecromass
    
    # BC_DWFineNecroM[PlantComp] = AF_ZoneFrac[Zn1]* (S&B_FineNecromass[Zn1,PlantComp])+ AF_ZoneFrac[Zn2]* (S&B_FineNecromass[Zn2,PlantComp])+ AF_ZoneFrac[Zn3]* (S&B_FineNecromass[Zn3,PlantComp])+ AF_ZoneFrac[Zn4]* (S&B_FineNecromass[Zn4,PlantComp])
    
    zonepcomp_df$BC_DWFineNecroM_a <- rep(zone_df$AF_ZoneFrac, nrow(pcomp_df))  * zonepcomp_df$SB_FineNecromass
    
    pcomp_df$BC_DWFineNecroM <- aggregate(zonepcomp_df["BC_DWFineNecroM_a"], zonepcomp_df["PlantComp"], sum)$BC_DWFineNecroM_a
    
    zonepcomp_df$SB_RelPileUp <- rep(zone_df$SB_RelPileUp, nrow(pcomp_df))
    zonepcomp_df$BC_DWFineNecroM <- rep(pcomp_df$BC_DWFineNecroM, each = nzone)
    # S&B_SPileUp[Zone,PlantComp] = if S&B_PileUpT? = 1 then S&B_PileUpFrac*(S&B_FineNecromass[Zone,PlantComp]-S&B_RelPileUp[Zone]*BC_DWFineNecroM[PlantComp]) else 0
    zonepcomp_df$SB_SPileUp <- ifelse(
      SB_PileUpT_is == 1,
      SB_PileUpFrac * (
        zonepcomp_df$SB_FineNecromass -
          zonepcomp_df$SB_RelPileUp *
          zonepcomp_df$BC_DWFineNecroM
      ),
      0
    )
    # S&B_HazeFromSlash[Zone,PlantComp] = S&B_DW?[PlantComp]*S&B_FineNecromass[Zone,PlantComp]*S&B_NecroBurnFrac[Zone]*(S&B_AerosolFrac[Zone])
    zonepcomp_df$SB_HazeFromSlash <- zonepcomp_df$SB_DW_is * zonepcomp_df$SB_FineNecromass * zonepcomp_df$SB_NecroBurnFrac *
      (zonepcomp_df$SB_AerosolFrac)
    
    
    
    # T_PrunWtAct[Zone,Tree] = if T_PrunWeighTot[Tree]>0 then (T_PrunWeight[Zone,Tree]/ARRAYSUM(T_PrunWeight[*,Tree]))/AF_ZoneFrac[Zone] else 0
    zonetree_df$T_PrunWtAct <- ifelse(
      zonetree_df$T_PrunWeighTot > 0,
      (zonetree_df$T_PrunWeight / zonetree_df$T_PrunWeigh_sum) / zonetree_df$AF_ZoneFrac,
      0
    )
    
    tree_df$T_LifallWeight_sum <- aggregate(zonetree_df["T_LifallWeight"], zonetree_df["tree_id"], sum)$T_LifallWeight
    zonetree_df$T_LifallWeight_sum <- rep(tree_df$T_LifallWeight_sum, each = nzone)
    
    # T_LifallWtAct[Zone,Tree] = if T_LifallWeightTot[Zone,Tree] > 0 then (T_LifallWeight[Zone,Tree]/ARRAYSUM(T_LifallWeight[*,Tree]))/AF_ZoneFrac[Zone] else 0
    zonetree_df$T_LifallWtAct <- ifelse(
      zonetree_df$T_LifallWeightTot > 0,
      (
        zonetree_df$T_LifallWeight / zonetree_df$T_LifallWeight_sum
      ) / zonetree_df$AF_ZoneFrac,
      0
    )
    
    tree_dw_df <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_CanBiomSlashed", "T_Prun", "T_LifallInc")]
    zonetree_dw_df <- tree_dw_df[rep(seq_len(nrow(tree_dw_df)), each = nzone), ]
    
    # T_LfTwMulch[Zone,Tree] = (T_CanBiomSlashed[DW,Tree] + T_Prun[DW,Tree])*T_PrunWtAct[Zone,Tree]+T_LifallInc[DW,Tree]*T_LifallWtAct[Zone,Tree]
    zonetree_df$T_LfTwMulch <- (zonetree_dw_df$T_CanBiomSlashed + zonetree_dw_df$T_Prun) * zonetree_df$T_PrunWtAct + zonetree_dw_df$T_LifallInc * zonetree_df$T_LifallWtAct
    
    zone_df$T_LfTwMulch_sum <- aggregate(zonetree_df["T_LfTwMulch"], zonetree_df["zone"], sum)$T_LfTwMulch
    zonetree_df$T_LAINecrCh_a <- zonetree_df$T_LfTwMulch * rep(tree_df$T_LWR, each = nzone) * rep(tree_df$T_SLA, each = nzone)
    zone_df$T_LAINecrCh_a_sum <- aggregate(zonetree_df["T_LAINecrCh_a"], zonetree_df["zone"], sum)$T_LAINecrCh_a
    zone_df$C_StLeaveMulch_DW <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", ]$C_StLeaveMulch
    # T_LAINecrCh[Zone] = if (ARRAYSUM(T_LfTwMulch[Zone,*]) + C_StLeaveMulch[Zone,DW]) > 0 then - MC_LAIperNecmss[Zone] + (+MC_Struc[Zone]*MC_LAIperNecmss[Zone]+ CQ_CLWRCurr[Zone]*CQ_CSLACurr[Zone]*C_StLeaveMulch[Zone,DW]+ T_LfTwMulch[Zone,Sp1]*T_LWR[Sp1]*T_SLA[Sp1]+ T_LfTwMulch[Zone,Sp2]*T_LWR[Sp2]*T_SLA[Sp2]+ T_LfTwMulch[Zone,Sp3]*T_LWR[Sp3]*T_SLA[Sp3])/((ARRAYSUM(T_LfTwMulch[Zone,*]) + C_StLeaveMulch[Zone,DW] + MC_Struc[Zone])) else 0
    zone_df$T_LAINecrCh <- ifelse(
      (zone_df$T_LfTwMulch_sum + zone_df$C_StLeaveMulch_DW) > 0,
      -zone_df$MC_LAIperNecmss + (
        zone_df$MC_Struc * zone_df$MC_LAIperNecmss + zone_df$CQ_CLWRCurr * zone_df$CQ_CSLACurr *
          zone_df$C_StLeaveMulch_DW +
          zone_df$T_LAINecrCh_a_sum
      ) / (
        zone_df$T_LfTwMulch_sum + zone_df$C_StLeaveMulch_DW + zone_df$MC_Struc
      ),
      0
    )
    
    
    # LF_UphillGWIncr = AF_PlotNumberUphill*(AF_ZoneFrac[Zn1]*W_V4Drain[Zn1]+AF_ZoneFrac[Zn2]*W_V4Drain[Zn2])/(AF_ZoneFrac[Zn1]+AF_ZoneFrac[Zn2])
    zone_df$W_V4DRAIN_frac <- zone_df$AF_ZoneFrac * zonelayer_df[zonelayer_df$layer == 4, "W_VDrain"]
    LF_UphillGWIncr <- AF_PlotNumberUphill * (zone_df[zone_df$zone == 1, "W_V4DRAIN_frac"] + zone_df[zone_df$zone == 2, "W_V4DRAIN_frac"]) /
      (zone_df[zone_df$zone == 1, "AF_ZoneFrac"] + zone_df[zone_df$zone == 2, "AF_ZoneFrac"])
    
    # LF_UphillGWRelease = LF_UphillGWStore*LF_GW_ReleaseFraction
    LF_UphillGWRelease <- LF_UphillGWStore * LF_GW_ReleaseFraction
 
    
    # RT3_CurrentStress[Tree] = if TW_Posgro[Tree] < T_NPosgro[N,Tree] and TW_Posgro[Tree] < T_NPosgro[P,Tree] then 1 else if T_NPosgro[N,Tree] < T_NPosgro[P,Tree] and T_NPosgro[N,Tree] < TW_Posgro[Tree] then 2 else 3
    tree_df$T_NPosgro_N <- treenut_df[treenut_df$SlNut == "N", "T_NPosgro"]
    tree_df$T_NPosgro_P <- treenut_df[treenut_df$SlNut == "P", "T_NPosgro"]

    tree_df$RT3_CurrentStress <- ifelse(
      tree_df$TW_Posgro < tree_df$T_NPosgro_N &
        tree_df$TW_Posgro < tree_df$T_NPosgro_P,
      1,
      ifelse(
        tree_df$T_NPosgro_N < tree_df$T_NPosgro_P &
          tree_df$T_NPosgro_N < tree_df$TW_Posgro,
        2,
        3
      )
    )
    
    # RT3_LrvDepth1[Zone,Tree] = AF_DepthAct1[Zone]*100*RT_TLrv1[Zone,Tree]
    # RT3_LrvDepth2[Zone,Tree] = AF_Depth2[Zone]*100*RT_TLrv2[Zone,Tree]
    # RT3_LrvDepth3[Zone,Tree] = AF_Depth3[Zone]*100*RT_TLrv3[Zone,Tree]
    # RT3_LrvDepth4[Zone,Tree] = AF_Depth4[Zone]*100*RT_TLrv4[Zone,Tree]
    zonelayertree_df$RT3_LrvDepth <- zonelayertree_df$AF_Depth * 100 * zonelayertree_df$RT_TLrv
    
    # RT3_AvgWUptperRoot[Tree] = IF(RT_TField[Tree])>0 then TW_UptTot[Tree]/RT_TField[Tree] else 0
    tree_df$RT3_AvgWUptperRoot <- ifelse(tree_df$RT_TField > 0,
                                         tree_df$TW_UptTot /
                                           tree_df$RT_TField,
                                         0)
    
    # RT3_L1W_RelUptperLrv[Zn1,Sp1] = if RT3_LrvDepth1[Zn1,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt1[Zn1]/RT3_LrvDepth1[Zn1,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt1[Zn1]+W_T3Upt1[Zn1])
    # RT3_L1W_RelUptperLrv[Zn1,Sp2] = if RT3_LrvDepth1[Zn1,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt1[Zn1]/RT3_LrvDepth1[Zn1,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt1[Zn1]+W_T3Upt1[Zn1])
    # RT3_L1W_RelUptperLrv[Zn1,Sp3] = if RT3_LrvDepth1[Zn1,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>1 then (W_T3Upt1[Zn1]/RT3_LrvDepth1[Zn1,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt1[Zn1]+W_T2Upt1[Zn1])
    # RT3_L1W_RelUptperLrv[Zn2,Sp1] = if RT3_LrvDepth1[Zn2,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt1[Zn2]/RT3_LrvDepth1[Zn2,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt1[Zn2]+W_T3Upt1[Zn2])
    # RT3_L1W_RelUptperLrv[Zn2,Sp2] = if RT3_LrvDepth1[Zn2,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt1[Zn2]/RT3_LrvDepth1[Zn2,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt1[Zn2]+W_T3Upt1[Zn2])
    # RT3_L1W_RelUptperLrv[Zn2,Sp3] = if RT3_LrvDepth1[Zn2,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt1[Zn2]/RT3_LrvDepth1[Zn2,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt1[Zn2]+W_T2Upt1[Zn2])
    # RT3_L1W_RelUptperLrv[Zn3,Sp1] = if RT3_LrvDepth1[Zn3,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt1[Zn3]/RT3_LrvDepth1[Zn3,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt1[Zn3]+W_T3Upt1[Zn3])
    # RT3_L1W_RelUptperLrv[Zn3,Sp2] = if RT3_LrvDepth1[Zn3,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt1[Zn3]/RT3_LrvDepth1[Zn3,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt1[Zn3]+W_T3Upt1[Zn3])
    # RT3_L1W_RelUptperLrv[Zn3,Sp3] = if RT3_LrvDepth1[Zn3,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt1[Zn3]/RT3_LrvDepth1[Zn3,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt1[Zn3]+W_T2Upt1[Zn3])
    # RT3_L1W_RelUptperLrv[Zn4,Sp1] = if RT3_LrvDepth1[Zn4,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt1[Zn4]/RT3_LrvDepth1[Zn4,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt1[Zn4]+W_T3Upt1[Zn4])
    # RT3_L1W_RelUptperLrv[Zn4,Sp2] = if RT3_LrvDepth1[Zn4,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt1[Zn4]/RT3_LrvDepth1[Zn4,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt1[Zn4]+W_T3Upt1[Zn4])
    # RT3_L1W_RelUptperLrv[Zn4,Sp3] = if RT3_LrvDepth1[Zn4,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt1[Zn4]/RT3_LrvDepth1[Zn4,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt1[Zn4]+W_T2Upt1[Zn4])
    #
    # RT3_L2W_RelUptperLrv[Zn1,Sp1] = if RT3_LrvDepth2[Zn1,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt2[Zn1]/RT3_LrvDepth2[Zn1,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt2[Zn1]+W_T3Upt2[Zn1])
    # RT3_L2W_RelUptperLrv[Zn1,Sp2] = if RT3_LrvDepth2[Zn1,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt2[Zn1]/RT3_LrvDepth2[Zn1,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt2[Zn1]+W_T3Upt2[Zn1])
    # RT3_L2W_RelUptperLrv[Zn1,Sp3] = if RT3_LrvDepth2[Zn1,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt2[Zn1]/RT3_LrvDepth2[Zn1,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt2[Zn1]+W_T2Upt2[Zn1])
    # RT3_L2W_RelUptperLrv[Zn2,Sp1] = if RT3_LrvDepth2[Zn2,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt2[Zn2]/RT3_LrvDepth2[Zn2,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt2[Zn2]+W_T3Upt2[Zn2])
    # RT3_L2W_RelUptperLrv[Zn2,Sp2] = if RT3_LrvDepth2[Zn2,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt2[Zn2]/RT3_LrvDepth2[Zn2,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt2[Zn2]+W_T3Upt2[Zn2])
    # RT3_L2W_RelUptperLrv[Zn2,Sp3] = if RT3_LrvDepth2[Zn2,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt2[Zn2]/RT3_LrvDepth2[Zn2,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt2[Zn2]+W_T2Upt2[Zn2])
    # RT3_L2W_RelUptperLrv[Zn3,Sp1] = if RT3_LrvDepth2[Zn3,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt2[Zn3]/RT3_LrvDepth2[Zn3,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt2[Zn3]+W_T3Upt2[Zn3])
    # RT3_L2W_RelUptperLrv[Zn3,Sp2] = if RT3_LrvDepth2[Zn3,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt2[Zn3]/RT3_LrvDepth2[Zn3,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt2[Zn3]+W_T3Upt2[Zn3])
    # RT3_L2W_RelUptperLrv[Zn3,Sp3] = if RT3_LrvDepth2[Zn3,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt2[Zn3]/RT3_LrvDepth2[Zn3,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt2[Zn3]+W_T2Upt2[Zn3])
    # RT3_L2W_RelUptperLrv[Zn4,Sp1] = if RT3_LrvDepth2[Zn4,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt2[Zn4]/RT3_LrvDepth2[Zn4,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt2[Zn4]+W_T3Upt2[Zn4])
    # RT3_L2W_RelUptperLrv[Zn4,Sp2] = if RT3_LrvDepth2[Zn4,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt2[Zn4]/RT3_LrvDepth2[Zn4,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt2[Zn4]+W_T3Upt2[Zn4])
    # RT3_L2W_RelUptperLrv[Zn4,Sp3] = if RT3_LrvDepth2[Zn4,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt2[Zn4]/RT3_LrvDepth2[Zn4,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt2[Zn4]+W_T2Upt2[Zn4])
    #
    # RT3_L3W_RelUptperLrv[Zn1,Sp1] = if RT3_LrvDepth3[Zn1,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt3[Zn1]/RT3_LrvDepth3[Zn1,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt3[Zn1]+W_T3Upt3[Zn1])
    # RT3_L3W_RelUptperLrv[Zn1,Sp2] = if RT3_LrvDepth3[Zn1,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt3[Zn1]/RT3_LrvDepth3[Zn1,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt3[Zn1]+W_T3Upt3[Zn1])
    # RT3_L3W_RelUptperLrv[Zn1,Sp3] = if RT3_LrvDepth3[Zn1,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt3[Zn1]/RT3_LrvDepth3[Zn1,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt3[Zn1]+W_T2Upt3[Zn1])
    # RT3_L3W_RelUptperLrv[Zn2,Sp1] = if RT3_LrvDepth3[Zn2,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt3[Zn2]/RT3_LrvDepth3[Zn2,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt3[Zn2]+W_T3Upt3[Zn2])
    # RT3_L3W_RelUptperLrv[Zn2,Sp2] = if RT3_LrvDepth3[Zn2,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt3[Zn2]/RT3_LrvDepth3[Zn2,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt3[Zn2]+W_T3Upt3[Zn2])
    # RT3_L3W_RelUptperLrv[Zn2,Sp3] = if RT3_LrvDepth3[Zn2,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt3[Zn2]/RT3_LrvDepth3[Zn2,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt3[Zn2]+W_T2Upt3[Zn2])
    # RT3_L3W_RelUptperLrv[Zn3,Sp1] = if RT3_LrvDepth3[Zn3,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt3[Zn3]/RT3_LrvDepth3[Zn3,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt3[Zn3]+W_T3Upt3[Zn3])
    # RT3_L3W_RelUptperLrv[Zn3,Sp2] = if RT3_LrvDepth3[Zn3,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt3[Zn3]/RT3_LrvDepth3[Zn3,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt3[Zn3]+W_T3Upt3[Zn3])
    # RT3_L3W_RelUptperLrv[Zn3,Sp3] = if RT3_LrvDepth3[Zn3,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt3[Zn3]/RT3_LrvDepth3[Zn3,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt3[Zn3]+W_T2Upt3[Zn3])
    # RT3_L3W_RelUptperLrv[Zn4,Sp1] = if RT3_LrvDepth3[Zn4,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt3[Zn4]/RT3_LrvDepth3[Zn4,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt3[Zn4]+W_T3Upt3[Zn4])
    # RT3_L3W_RelUptperLrv[Zn4,Sp2] = if RT3_LrvDepth3[Zn4,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt3[Zn4]/RT3_LrvDepth3[Zn4,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt3[Zn4]+W_T3Upt3[Zn4])
    # RT3_L3W_RelUptperLrv[Zn4,Sp3] = if RT3_LrvDepth3[Zn4,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt3[Zn4]/RT3_LrvDepth3[Zn4,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt3[Zn4]+W_T2Upt3[Zn4])
    #
    # RT3_L4W_RelUptperLrv[Zn1,Sp1] = if RT3_LrvDepth4[Zn1,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt4[Zn1]/RT3_LrvDepth4[Zn1,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt4[Zn1]+W_T3Upt4[Zn1])
    # RT3_L4W_RelUptperLrv[Zn1,Sp2] = if RT3_LrvDepth4[Zn1,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt4[Zn1]/RT3_LrvDepth4[Zn1,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt4[Zn1]+W_T3Upt4[Zn1])
    # RT3_L4W_RelUptperLrv[Zn1,Sp3] = if RT3_LrvDepth4[Zn1,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt4[Zn1]/RT3_LrvDepth4[Zn1,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt4[Zn1]+W_T2Upt4[Zn1])
    # RT3_L4W_RelUptperLrv[Zn2,Sp1] = if RT3_LrvDepth4[Zn2,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt4[Zn2]/RT3_LrvDepth4[Zn2,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt4[Zn2]+W_T3Upt4[Zn2])
    # RT3_L4W_RelUptperLrv[Zn2,Sp2] = if RT3_LrvDepth4[Zn2,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt4[Zn2]/RT3_LrvDepth4[Zn2,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt4[Zn2]+W_T3Upt4[Zn2])
    # RT3_L4W_RelUptperLrv[Zn2,Sp3] = if RT3_LrvDepth4[Zn2,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt4[Zn2]/RT3_LrvDepth4[Zn2,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt4[Zn2]+W_T2Upt4[Zn2])
    # RT3_L4W_RelUptperLrv[Zn3,Sp1] = if RT3_LrvDepth4[Zn3,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt4[Zn3]/RT3_LrvDepth4[Zn3,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt4[Zn3]+W_T3Upt4[Zn3])
    # RT3_L4W_RelUptperLrv[Zn3,Sp2] = if RT3_LrvDepth4[Zn3,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt4[Zn3]/RT3_LrvDepth4[Zn3,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt4[Zn3]+W_T3Upt4[Zn3])
    # RT3_L4W_RelUptperLrv[Zn3,Sp3] = if RT3_LrvDepth4[Zn3,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt4[Zn3]/RT3_LrvDepth4[Zn3,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt4[Zn3]+W_T2Upt4[Zn3])
    # RT3_L4W_RelUptperLrv[Zn4,Sp1] = if RT3_LrvDepth4[Zn4,Sp1]>0 and RT3_AvgWUptperRoot[Sp1]>0 then (W_T1Upt4[Zn4]/RT3_LrvDepth4[Zn4,Sp1])/RT3_AvgWUptperRoot[Sp1] else 0*(W_T2Upt4[Zn4]+W_T3Upt4[Zn4])
    # RT3_L4W_RelUptperLrv[Zn4,Sp2] = if RT3_LrvDepth4[Zn4,Sp2]>0 and RT3_AvgWUptperRoot[Sp2]>0 then (W_T2Upt4[Zn4]/RT3_LrvDepth4[Zn4,Sp2])/RT3_AvgWUptperRoot[Sp2] else 0*(W_T1Upt4[Zn4]+W_T3Upt4[Zn4])
    # RT3_L4W_RelUptperLrv[Zn4,Sp3] = if RT3_LrvDepth4[Zn4,Sp3]>0 and RT3_AvgWUptperRoot[Sp3]>0 then (W_T3Upt4[Zn4]/RT3_LrvDepth4[Zn4,Sp3])/RT3_AvgWUptperRoot[Sp3] else 0*(W_T1Upt4[Zn4]+W_T2Upt4[Zn4])
    
    zonelayertree_df$RT3_AvgWUptperRoot <- rep(tree_df$RT3_AvgWUptperRoot, each = nzone * nlayer)
    zonelayertree_df$RT3_LW_RelUptperLrv <- ifelse(
      zonelayertree_df$RT3_LrvDepth > 0 &
        zonelayertree_df$RT3_AvgWUptperRoot > 0,
      (zonelayertree_df$W_Upt /
         zonelayertree_df$RT3_LrvDepth) / zonelayertree_df$RT3_AvgWUptperRoot,
      0
    )
    
    # RT_RhoTL1[Zone,Tree] = if RT_TLrv1[Zone,Tree]> 0 then 1/(RT_TDiam[Tree]*.5*SQRT(PI*(RT_TLrv1[Zone,Tree]))) else RT_StopGap
    # RT_RhoTL2[Zone,Tree] = if RT_TLrv2[Zone,Tree]> 0 then 1/(RT_TDiam[Tree]*.5*SQRT(PI*(RT_TLrv2[Zone,Tree]))) else RT_StopGap
    # RT_RhoTL3[Zone,Tree] = if RT_TLrv3[Zone,Tree]> 0 then 1/(RT_TDiam[Tree]*.5*SQRT(PI*(RT_TLrv3[Zone,Tree]))) else RT_StopGap
    # RT_RhoTL4[Zone,Tree] = if RT_TLrv4[Zone,Tree]> 0 then 1/(RT_TDiam[Tree]*.5*SQRT(PI*(RT_TLrv4[Zone,Tree]))) else RT_StopGap
    zonelayertree_df$RT_RhoTL <- ifelse(
      zonelayertree_df$RT_TLrv > 0,
      1 / (
        zonelayertree_df$RT_TDiam * .5 * sqrt(pi * zonelayertree_df$RT_TLrv)
      ),
      RT_StopGap
    )
    
    # RT_T_G1[Zone,Tree] = if RT_RhoTL1[Zone,Tree] <> RT_StopGap then (RT_RhoTL1[Zone,Tree]^2-1)/(0.5*(((1-(3*RT_RhoTL1[Zone,Tree]^2))/4)+((RT_RhoTL1[Zone,Tree]^4*LOGN(RT_RhoTL1[Zone,Tree]))/(RT_RhoTL1[Zone,Tree]^2-1)))) else 0
    # RT_T_G2[Zone,Tree] = if RT_RhoTL2[Zone,Tree] <> RT_StopGap then (RT_RhoTL2[Zone,Tree]^2-1)/(0.5*(((1-(3*RT_RhoTL2[Zone,Tree]^2))/4)+((RT_RhoTL2[Zone,Tree]^4*LOGN(RT_RhoTL2[Zone,Tree]))/(RT_RhoTL2[Zone,Tree]^2-1)))) else 0
    # RT_T_G3[Zone,Tree] = if RT_RhoTL3[Zone,Tree] <> RT_StopGap then (RT_RhoTL3[Zone,Tree]^2-1)/(0.5*(((1-(3*RT_RhoTL3[Zone,Tree]^2))/4)+((RT_RhoTL3[Zone,Tree]^4*LOGN(RT_RhoTL3[Zone,Tree]))/(RT_RhoTL3[Zone,Tree]^2-1)))) else 0
    # RT_T_G4[Zone,Tree] = if RT_RhoTL4[Zone,Tree] <> RT_StopGap then (RT_RhoTL4[Zone,Tree]^2-1)/(0.5*(((1-(3*RT_RhoTL4[Zone,Tree]^2))/4)+((RT_RhoTL4[Zone,Tree]^4*LOGN(RT_RhoTL4[Zone,Tree]))/(RT_RhoTL4[Zone,Tree]^2-1)))) else 0
    
    zonelayertree_df$RT_T_G <- ifelse(
      zonelayertree_df$RT_RhoTL != RT_StopGap,
      (zonelayertree_df$RT_RhoTL^2 -
         1) / (0.5 * (((
           1 - (3 * zonelayertree_df$RT_RhoTL^2)
         ) / 4) + ((
           zonelayertree_df$RT_RhoTL^4 * log(zonelayertree_df$RT_RhoTL)
         ) /
           (zonelayertree_df$RT_RhoTL^2 - 1)
         ))),
      0
    )
    
    # N_Diff1[Zone,SlNut] = N_DiffCoef[SlNut]*W_Theta1[Zone]*MAX(0.1*W_Theta1[Zone],(1.5*W_Theta1[Zone]-0.11))
    # N_Diff2[Zone,SlNut] = N_DiffCoef[SlNut]*W_Theta2[Zone]*MAX(0.1*W_Theta2[Zone],(1.5*W_Theta2[Zone]-0.11))
    # N_Diff3[Zone,SlNut] = N_DiffCoef[SlNut]*W_Theta3[Zone]*MAX(0.1*W_Theta3[Zone],(1.5*W_Theta3[Zone]-0.11))
    # N_Diff4[Zone,SlNut] = N_DiffCoef[SlNut]*W_Theta4[Zone]*MAX(0.1*W_Theta4[Zone],(1.5*W_Theta4[Zone]-0.11))
    zonelayernut_df$N_DiffCoef <- rep(nut_df$N_DiffCoef, each = nzone *
                                        nlayer)
    zonelayernut_df$W_Theta <- rep(zonelayer_df$W_Theta, nrow(nut_df))
    zonelayernut_df$N_Diff <- zonelayernut_df$N_DiffCoef * zonelayernut_df$W_Theta *
      pmax(0.1 * zonelayernut_df$W_Theta,
           (1.5 * zonelayernut_df$W_Theta - 0.11))
    
    zonenut_df$MN_FertDissFrac <- rep(nut_df$MN_FertDissFrac, each = nzone)
    # MN_FertDissF[Zone,SlNut] = MN_FertOnSoil[Zone,SlNut]*MN_FertDissFrac[SlNut]
    zonenut_df$MN_FertDissF <- zonenut_df$MN_FertOnSoil * zonenut_df$MN_FertDissFrac
    
    # W_RelDrain1[Zone] = if AF_DepthAct1[Zone] > 0 then W_Drain1[Zone]/(W_FieldCap1[Zone]*AF_DepthAct1[Zone]*1000) else 0
    # W_RelDrain2[Zone] = if AF_Depth2[Zone] > 0 then W_Drain2[Zone]/(W_FieldCap2[Zone]*AF_Depth2[Zone]*1000) else 0
    # W_RelDrain3[Zone] = if AF_Depth3[Zone] > 0 then W_Drain3[Zone]/(W_FieldCap3[Zone]*AF_Depth3[Zone]*1000)else 0
    # W_RelDrain4[Zone] = if AF_Depth4[Zone] > 0 then W_Drain4[Zone]/(W_FieldCap4[Zone]*AF_Depth4[Zone]*1000)else 0
    zonelayer_df$W_RelDrain <- ifelse(
      zonelayer_df$AF_Depth > 0,
      zonelayer_df$W_Drain / (zonelayer_df$W_FieldCap * zonelayer_df$AF_Depth *
                                1000),
      0
    )
    
    # N_StockZoneLayer[Zn1,1] = N_Stock1[Zn1,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn1,2] = N_Stock2[Zn1,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn1,3] = N_Stock3[Zn1,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn1,4] = N_Stock4[Zn1,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn2,1] = N_Stock1[Zn2,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn2,2] = N_Stock2[Zn2,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn2,3] = N_Stock3[Zn2,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn2,4] = N_Stock4[Zn2,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn3,1] = N_Stock1[Zn3,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn3,2] = N_Stock2[Zn3,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn3,3] = N_Stock3[Zn3,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn3,4] = N_Stock4[Zn3,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn4,1] = N_Stock1[Zn4,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn4,2] = N_Stock2[Zn4,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn4,3] = N_Stock3[Zn4,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # N_StockZoneLayer[Zn4,4] = N_Stock4[Zn4,N]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    zonelayer_df$N_StockZoneLayer <- zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Stock"]
    
    # MN2_SomMinExch[Zone,SoilLayer] = MN2_NSOMMinExch*(MN2_MinNutpool[Zone,SoilLayer]-N_StockZoneLayer[Zone,SoilLayer])
    zonelayer_df$MN2_SomMinExch <- MN2_NSOMMinExch * (zonelayer_df$MN2_MinNutpool - zonelayer_df$N_StockZoneLayer)
    
    # P_StockZoneLayer[Zn1,1] = N_Stock1[Zn1,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn1,2] = N_Stock2[Zn1,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn1,3] = N_Stock3[Zn1,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn1,4] = N_Stock4[Zn1,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn2,1] = N_Stock1[Zn2,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn2,2] = N_Stock2[Zn2,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn2,3] = N_Stock3[Zn2,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn2,4] = N_Stock4[Zn2,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn3,1] = N_Stock1[Zn3,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn3,2] = N_Stock2[Zn3,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn3,3] = N_Stock3[Zn3,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn3,4] = N_Stock4[Zn3,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn4,1] = N_Stock1[Zn4,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn4,2] = N_Stock2[Zn4,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn4,3] = N_Stock3[Zn4,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    # P_StockZoneLayer[Zn4,4] = N_Stock4[Zn4,P]+ 0*(N_Stock1[Zn1,P]+N_Stock2[Zn1,P]+N_Stock3[Zn1,P]+N_Stock4[Zn1,P])
    
    zonelayer_df$P_StockZoneLayer <- zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Stock"]
    
    # MP2_SomMinExch[Zone,SoilLayer] = MP2_SomMinExchBuffer*(MP2_MinNutpool[Zone,SoilLayer]-P_StockZoneLayer[Zone,SoilLayer])
    zonelayer_df$MP2_SomMinExch <- MP2_SomMinExchBuffer *
      (zonelayer_df$MP2_MinNutpool - zonelayer_df$P_StockZoneLayer)
    
    # N_SomMin1Exch[Zn1,N] = MN2_SomMinExch[Zn1,1]+0*MP2_SomMinExch[Zn1,1]
    # N_SomMin1Exch[Zn1,P] = 0*MN2_SomMinExch[Zn4,1]+MP2_SomMinExch[Zn1,1]
    # N_SomMin1Exch[Zn2,N] = MN2_SomMinExch[Zn2,1]+0*MP2_SomMinExch[Zn1,1]
    # N_SomMin1Exch[Zn2,P] = 0*MN2_SomMinExch[Zn4,1]+MP2_SomMinExch[Zn2,1]
    # N_SomMin1Exch[Zn3,N] = MN2_SomMinExch[Zn3,1]+0*MP2_SomMinExch[Zn1,1]
    # N_SomMin1Exch[Zn3,P] = 0*MN2_SomMinExch[Zn4,1]+MP2_SomMinExch[Zn3,1]
    # N_SomMin1Exch[Zn4,N] = MN2_SomMinExch[Zn4,1]+0*MP2_SomMinExch[Zn1,1]
    # N_SomMin1Exch[Zn4,P] = 0*MN2_SomMinExch[Zn4,1]+MP2_SomMinExch[Zn4,1]
    #
    # N_SomMin2Exch[Zn1,N] = MN2_SomMinExch[Zn1,2]+0*MP2_SomMinExch[Zn1,2]
    # N_SomMin2Exch[Zn1,P] = 0*MN2_SomMinExch[Zn1,2]+MP2_SomMinExch[Zn1,2]
    # N_SomMin2Exch[Zn2,N] = MN2_SomMinExch[Zn2,2]+0*MP2_SomMinExch[Zn2,2]
    # N_SomMin2Exch[Zn2,P] = 0*MN2_SomMinExch[Zn2,2]+MP2_SomMinExch[Zn2,2]
    # N_SomMin2Exch[Zn3,N] = MN2_SomMinExch[Zn3,2]+0*MP2_SomMinExch[Zn3,2]
    # N_SomMin2Exch[Zn3,P] = 0*MN2_SomMinExch[Zn3,2]+MP2_SomMinExch[Zn3,2]
    # N_SomMin2Exch[Zn4,N] = MN2_SomMinExch[Zn4,2]+0*MP2_SomMinExch[Zn4,2]
    # N_SomMin2Exch[Zn4,P] = 0*MN2_SomMinExch[Zn4,2]+MP2_SomMinExch[Zn4,2]
    #
    # N_SomMin3Exch[Zn1,N] = MN2_SomMinExch[Zn1,3]+0*MP2_SomMinExch[Zn1,3]
    # N_SomMin3Exch[Zn1,P] = 0*MN2_SomMinExch[Zn1,3]+MP2_SomMinExch[Zn1,3]
    # N_SomMin3Exch[Zn2,N] = MN2_SomMinExch[Zn2,3]+0*MP2_SomMinExch[Zn2,3]
    # N_SomMin3Exch[Zn2,P] = 0*MN2_SomMinExch[Zn2,3]+MP2_SomMinExch[Zn2,3]
    # N_SomMin3Exch[Zn3,N] = MN2_SomMinExch[Zn3,3]+0*MP2_SomMinExch[Zn3,3]
    # N_SomMin3Exch[Zn3,P] = 0*MN2_SomMinExch[Zn3,3]+MP2_SomMinExch[Zn3,3]
    # N_SomMin3Exch[Zn4,N] = MN2_SomMinExch[Zn4,3]+0*MP2_SomMinExch[Zn4,3]
    # N_SomMin3Exch[Zn4,P] = 0*MN2_SomMinExch[Zn4,3]+MP2_SomMinExch[Zn4,3]
    #
    # N_SomMin4Exch[Zn1,N] = MN2_SomMinExch[Zn1,4]+0*MP2_SomMinExch[Zn1,4]
    # N_SomMin4Exch[Zn1,P] = 0*MN2_SomMinExch[Zn1,4]+MP2_SomMinExch[Zn1,4]
    # N_SomMin4Exch[Zn2,N] = MN2_SomMinExch[Zn2,4]+0*MP2_SomMinExch[Zn2,4]
    # N_SomMin4Exch[Zn2,P] = 0*MN2_SomMinExch[Zn2,4]+MP2_SomMinExch[Zn2,4]
    # N_SomMin4Exch[Zn3,N] = MN2_SomMinExch[Zn3,4]+0*MP2_SomMinExch[Zn3,4]
    # N_SomMin4Exch[Zn3,P] = 0*MN2_SomMinExch[Zn3,4]+MP2_SomMinExch[Zn3,4]
    # N_SomMin4Exch[Zn4,N] = MN2_SomMinExch[Zn4,4]+0*MP2_SomMinExch[Zn4,4]
    # N_SomMin4Exch[Zn4,P] = 0*MN2_SomMinExch[Zn4,4]+MP2_SomMinExch[Zn4,4]
    
    zonelayernut_df$N_SomMinExch <- NA
    zonelayernut_df[zonelayernut_df$SlNut == "N", "N_SomMinExch"] <- zonelayer_df$MN2_SomMinExch
    zonelayernut_df[zonelayernut_df$SlNut == "P", "N_SomMinExch"] <- zonelayer_df$MP2_SomMinExch
    
    # MN_Mineralization[Zone,SlNut] = N_LittNmin1exchfact*(MN_MinNutpool[Zone,SlNut]-N_Stock1[Zone,SlNut])
    zonenut_df$MN_Mineralization <- N_LittNmin1exchfact * (zonenut_df$MN_MinNutpool - zonelayernut_df[zonelayernut_df$layer == 1, "N_Stock"])
    
    #TODO: layer 1,2 and 3,4 (nut = "N") were not consistent (?)
    # N_Soil1[Zn1,N] = max(0,(N_Stock1[Zn1,N])/(AF_DepthAct1[Zn1]*1000))-N_PStParam[PStMin_1]
    # N_Soil1[Zn1,P] = max(0,(N_Stock1[Zn1,P])/(AF_DepthAct1[Zn1]*1000)-N_PStParam[PStMin_1])/(N_PStParam[PStMax1]-N_PStParam[PStMin_1])
    # N_Soil1[Zn2,N] = max(0,(N_Stock1[Zn2,N])/(AF_DepthAct1[Zn2]*1000))-N_PStParam[PStMin_1]
    # N_Soil1[Zn2,P] = max(0,(N_Stock1[Zn2,P])/(AF_DepthAct1[Zn2]*1000)-N_PStParam[PStMin_1])/(N_PStParam[PStMax1]-N_PStParam[PStMin_1])
    # N_Soil1[Zn3,N] = max(0,(N_Stock1[Zn3,N])/(AF_DepthAct1[Zn3]*1000))-N_PStParam[PStMin_1]
    # N_Soil1[Zn3,P] = max(0,(N_Stock1[Zn3,P])/(AF_DepthAct1[Zn3]*1000)-N_PStParam[PStMin_1])/(N_PStParam[PStMax1]-N_PStParam[PStMin_1])
    # N_Soil1[Zn4,N] = max(0,(N_Stock1[Zn4,N])/(AF_DepthAct1[Zn4]*1000))-N_PStParam[PStMin_1]
    # N_Soil1[Zn4,P] = max(0,(N_Stock1[Zn4,P])/(AF_DepthAct1[Zn4]*1000)-N_PStParam[PStMin_1])/(N_PStParam[PStMax1]-N_PStParam[PStMin_1])
    # N_Soil2[Zn1,N] = max(0,(N_Stock2[Zn1,N])/(AF_Depth2[Zn1]*1000))-N_PStParam[PStMin_2]
    # N_Soil2[Zn1,P] = max(0,(N_Stock2[Zn1,P])/(AF_Depth2[Zn1]*1000)-N_PStParam[PStMin_2])/(N_PStParam[PStMax2]-N_PStParam[PStMin_2])
    # N_Soil2[Zn2,N] = max(0,(N_Stock2[Zn2,N])/(AF_Depth2 [Zn2]*1000))-N_PStParam[PStMin_2]
    # N_Soil2[Zn2,P] = max(0,(N_Stock2[Zn2,P])/(AF_Depth2[Zn2]*1000)-N_PStParam[PStMin_2])/(N_PStParam[PStMax2]-N_PStParam[PStMin_2])
    # N_Soil2[Zn3,N] = max(0,(N_Stock2[Zn3,N])/(AF_Depth2[Zn3]*1000))-N_PStParam[PStMin_2]
    # N_Soil2[Zn3,P] = max(0,(N_Stock2[Zn3,P])/(AF_Depth2[Zn3]*1000)-N_PStParam[PStMin_2])/(N_PStParam[PStMax2]-N_PStParam[PStMin_2])
    # N_Soil2[Zn4,N] = max(0,(N_Stock2[Zn4,N])/(AF_Depth2[Zn4]*1000))-N_PStParam[PStMin_2]
    # N_Soil2[Zn4,P] = max(0,(N_Stock2[Zn4,P])/(AF_Depth2[Zn4]*1000)-N_PStParam[PStMin_2])/(N_PStParam[PStMax2]-N_PStParam[PStMin_2])
    # N_Soil3[Zn1,N] = max(0,(N_Stock3[Zn1,N])/(AF_Depth3[Zn1]*1000))-0*N_PStParam[PStMin_3]
    # N_Soil3[Zn1,P] = max(0,(N_Stock3[Zn1,P])/(AF_Depth3[Zn1]*1000)-N_PStParam[PStMin_3])/(N_PStParam[PStMax3]-N_PStParam[PStMin_3])
    # N_Soil3[Zn2,N] = max(0,(N_Stock3[Zn2,N])/(AF_Depth3[Zn2]*1000))-0*N_PStParam[PStMin_3]
    # N_Soil3[Zn2,P] = max(0,(N_Stock3[Zn2,P])/(AF_Depth3[Zn2]*1000)-N_PStParam[PStMin_3])/(N_PStParam[PStMax3]-N_PStParam[PStMin_3])
    # N_Soil3[Zn3,N] = max(0,(N_Stock3[Zn3,N])/(AF_Depth3[Zn3]*1000))-0*N_PStParam[PStMin_3]
    # N_Soil3[Zn3,P] = max(0,(N_Stock3[Zn3,P])/(AF_Depth3[Zn3]*1000)-N_PStParam[PStMin_3])/(N_PStParam[PStMax3]-N_PStParam[PStMin_3])
    # N_Soil3[Zn4,N] = max(0,(N_Stock3[Zn4,N])/(AF_Depth3[Zn4]*1000))-0*N_PStParam[PStMin_3]
    # N_Soil3[Zn4,P] = max(0,(N_Stock3[Zn4,P])/(AF_Depth3[Zn4]*1000)-N_PStParam[PStMin_3])/(N_PStParam[PStMax3]-N_PStParam[PStMin_3])
    # N_Soil4[Zn1,N] = max(0,(N_Stock4[Zn1,N])/(AF_Depth4[Zn1]*1000))-0*N_PStParam[PStMin_4]
    # N_Soil4[Zn1,P] = max(0,(N_Stock4[Zn1,P])/(AF_Depth4[Zn1]*1000)-N_PStParam[PStMin_4])/(N_PStParam[PStMax4]-N_PStParam[PStMin_4])
    # N_Soil4[Zn2,N] = max(0,(N_Stock4[Zn2,N])/(AF_Depth4[Zn2]*1000))-0*N_PStParam[PStMin_4]
    # N_Soil4[Zn2,P] = max(0,(N_Stock4[Zn2,P])/(AF_Depth4[Zn2]*1000)-N_PStParam[PStMin_4])/(N_PStParam[PStMax4]-N_PStParam[PStMin_4])
    # N_Soil4[Zn3,N] = max(0,(N_Stock4[Zn3,N])/(AF_Depth4[Zn3]*1000))-0*N_PStParam[PStMin_4]
    # N_Soil4[Zn3,P] = max(0,(N_Stock4[Zn3,P])/(AF_Depth4[Zn3]*1000)-N_PStParam[PStMin_4])/(N_PStParam[PStMax4]-N_PStParam[PStMin_4])
    # N_Soil4[Zn4,N] = max(0,(N_Stock4[Zn4,N])/(AF_Depth4[Zn4]*1000))-0*N_PStParam[PStMin_4]
    # N_Soil4[Zn4,P] = max(0,(N_Stock4[Zn4,P])/(AF_Depth4[Zn4]*1000)-N_PStParam[PStMin_4])/(N_PStParam[PStMax4]-N_PStParam[PStMin_4])
    zonelayer_df$PStMin <- rep(layer_df$PStMin, each = nzone)
    zonelayer_df$PStMax <- rep(layer_df$PStMax, each = nzone)
    
    zonelayernut_df$N_Soil <- NA
    zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Soil"] <- pmax(0,
                                                                   (zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Stock"]) /
                                                                     (zonelayer_df$AF_Depth * 1000))
    zonelayernut_df[zonelayernut_df$SlNut == "N" &
                      zonelayernut_df$layer %in% c(1, 2), "N_Soil"] <- zonelayernut_df[zonelayernut_df$SlNut == "N" &
                                                                                        zonelayernut_df$layer %in% c(1, 2), "N_Soil"] - zonelayer_df[zonelayer_df$layer %in% c(1, 2), "PStMin"]
    zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Soil"] <- pmax(
      0,
      (zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Stock"]) / (zonelayer_df$AF_Depth *
                                                                     1000) - zonelayer_df$PStMin
    ) / (zonelayer_df$PStMax - zonelayer_df$PStMin)
    
    # N_KaPDef1[Zone] = GRAPH(N_Soil1[Zone,P])
    # N_KaPDef2[Zone] = GRAPH(N_Soil2[Zone,P])
    # N_KaPDef3[Zone] = GRAPH(N_Soil3[Zone,P])
    # N_KaPDef4[Zone] = GRAPH(N_Soil4[Zone,P])
    zln_P <- zonelayernut_df[zonelayernut_df$SlNut == "P", c("layer", "N_Soil")]
    zonelayer_df$N_KaPDef <- c(
      get_y_df(zln_P[zln_P$layer == 1, "N_Soil"], "N_KaPDef1"),
      get_y_df(zln_P[zln_P$layer == 2, "N_Soil"], "N_KaPDef2"),
      get_y_df(zln_P[zln_P$layer == 3, "N_Soil"], "N_KaPDef3"),
      get_y_df(zln_P[zln_P$layer == 4, "N_Soil"], "N_KaPDef4")
    )
    
    # N_CRhizVol1[Zone] = RT_CLrvMinM1[Zone]*PI*CQ_RtDiam[Zone]^2* ((1+RT_CRhizExt)^2-1)/4
    # N_CRhizVol2[Zone] = RT_CLrvMinM2[Zone]*PI*CQ_RtDiam[Zone]^2* ((1+RT_CRhizExt)^2-1)/4
    # N_CRhizVol3[Zone] = RT_CLrvMinM3[Zone]*PI*CQ_RtDiam[Zone]^2* ((1+RT_CRhizExt)^2-1)/4
    # N_CRhizVol4[Zone] = RT_CLrvMinM4[Zone]*PI*CQ_RtDiam[Zone]^2* ((1+RT_CRhizExt)^2-1)/4
    zonelayer_df$N_CRhizVol <- zonelayer_df$RT_CLrvMinM * pi * zonelayer_df$CQ_RtDiam^2 * ((1 + RT_CRhizExt)^2 -
                                                                                             1) / 4
    
    # N_CRhizKaPM1[Zone] = N_CRhizKaPMod[Zone]*N_CRhizVol1[Zone]
    # N_CRhizKaPM2[Zone] = N_CRhizKaPMod[Zone]*N_CRhizVol2[Zone]
    # N_CRhizKaPM3[Zone] = N_CRhizKaPMod[Zone]*N_CRhizVol3[Zone]
    # N_CRhizKaPM4[Zone] = N_CRhizKaPMod[Zone]*N_CRhizVol4[Zone]
    zonelayer_df$N_CRhizKaPMod <- rep(zone_df$N_CRhizKaPMod, nlayer)
    zonelayer_df$N_CRhizKaPM <- zonelayer_df$N_CRhizKaPMod * zonelayer_df$N_CRhizVol
    
    # RT_TRhizVol1[Zone,Tree] = RT_TLrvMinM1[Zone,Tree]*PI*RT_TDiam[Tree]^2* ((1+RT_TRhizExt[Tree])^2-1)/4
    # RT_TRhizVol2[Zone,Tree] = RT_TLrvMinM2[Zone,Tree]*PI*RT_TDiam[Tree]^2* ((1+RT_TRhizExt[Tree])^2-1)/4
    # RT_TRhizVol3[Zone,Tree] = RT_TLrvMinM3[Zone,Tree]*PI*RT_TDiam[Tree]^2* ((1+RT_TRhizExt[Tree])^2-1)/4
    # RT_TRhizVol4[Zone,Tree] = RT_TLrvMinM4[Zone,Tree]*PI*RT_TDiam[Tree]^2* ((1+RT_TRhizExt[Tree])^2-1)/4
    zonelayertree_df$RT_TRhizExt <- rep(tree_df$RT_TRhizExt, each = nzone *
                                          nlayer)
    zonelayertree_df$RT_TRhizVol <- zonelayertree_df$RT_TLrvMinM * pi *
      zonelayertree_df$RT_TDiam^2 * ((1 + zonelayertree_df$RT_TRhizExt)^2 - 1) /
      4
    
    # N_TRhizKaPM1[Zone,Tree] = N_TRhizKaPMod[Tree]*RT_TRhizVol1[Zone,Tree]
    # N_TRhizKaPM2[Zone,Tree] = N_TRhizKaPMod[Tree]*RT_TRhizVol2[Zone,Tree]
    # N_TRhizKaPM3[Zone,Tree] = N_TRhizKaPMod[Tree]*RT_TRhizVol3[Zone,Tree]
    # N_TRhizKaPM4[Zone,Tree] = N_TRhizKaPMod[Tree]*RT_TRhizVol4[Zone,Tree]
    zonelayertree_df$N_TRhizKaPMod <- rep(tree_df$N_TRhizKaPMod, each = nzone *
                                            nlayer)
    zonelayertree_df$N_TRhizKaPM <- zonelayertree_df$N_TRhizKaPMod * zonelayertree_df$RT_TRhizVol
    
    # N_RhizEffect1[Zone] = N_CRhizKaPM1[Zone]+ARRAYSUM(N_TRhizKaPM1[Zone,*])
    # N_RhizEffect2[Zone] = N_CRhizKaPM2[Zone]+ARRAYSUM(N_TRhizKaPM2[Zone,*])
    # N_RhizEffect3[Zone] = N_CRhizKaPM3[Zone]+ARRAYSUM(N_TRhizKaPM3[Zone,*])
    # N_RhizEffect4[Zone] = N_CRhizKaPM4[Zone]+ARRAYSUM(N_TRhizKaPM4[Zone,*])
    zonelayer_df$N_RhizEffect <- zonelayer_df$N_CRhizKaPM + aggregate(zonelayertree_df["N_TRhizKaPM"], zonelayertree_df[c("zone", "layer")], sum)$N_TRhizKaPM
    
    # N_KaP1[Zone] = N_KaPDef1[Zone]*1/(1+N_RhizEffect1[Zone])
    # N_KaP2[Zone] = N_KaPDef2[Zone]*1/(1+N_RhizEffect2[Zone])
    # N_KaP3[Zone] = N_KaPDef3[Zone]*1/(1+N_RhizEffect3[Zone])
    # N_KaP4[Zone] = N_KaPDef4[Zone]*1/(1+N_RhizEffect4[Zone])
    zonelayer_df$N_KaP <- zonelayer_df$N_KaPDef * 1 / (1 + zonelayer_df$N_RhizEffect)
    
    # N_KaLeach1[Zn1,N] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn1]*(N_KaNH41-N_KaNO31)+1))+0*N_KaP1[Zn1]
    # N_KaLeach1[Zn1,P] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn1]*(N_KaNH41-N_KaNO31)+1))*0+N_KaP1[Zn1]
    # N_KaLeach1[Zn2,N] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn2]*(N_KaNH41-N_KaNO31)+1))+0*N_KaP1[Zn2]
    # N_KaLeach1[Zn2,P] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn2]*(N_KaNH41-N_KaNO31)+1))*0+N_KaP1[Zn2]
    # N_KaLeach1[Zn3,N] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn3]*(N_KaNH41-N_KaNO31)+1))+0*N_KaP1[Zn3]
    # N_KaLeach1[Zn3,P] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn3]*(N_KaNH41-N_KaNO31)+1))*0+N_KaP1[Zn3]
    # N_KaLeach1[Zn4,N] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn4]*(N_KaNH41-N_KaNO31)+1))+0*N_KaP1[Zn4]
    # N_KaLeach1[Zn4,P] = (-1 + (N_KaNO31 + 1)*(N_KaNH41+1)/(N_KaNO31+N_FracNO31[Zn4]*(N_KaNH41-N_KaNO31)+1))*0+N_KaP1[Zn4]
    # N_KaLeach2[Zn1,N] =  -1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn1]*(N_KaNH42-N_KaNO32)+1) +0*N_KaP2[Zn1]
    # N_KaLeach2[Zn1,P] = (-1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn1]*(N_KaNH42-N_KaNO32)+1))*0+ N_KaP2[Zn1]
    # N_KaLeach2[Zn2,N] = -1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn2]*(N_KaNH42-N_KaNO32)+1) + 0*N_KaP2[Zn2]
    # N_KaLeach2[Zn2,P] = (-1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn2]*(N_KaNH42-N_KaNO32)+1))*0 + N_KaP2[Zn2]
    # N_KaLeach2[Zn3,N] = -1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn3]*(N_KaNH42-N_KaNO32)+1) + 0*N_KaP2[Zn3]
    # N_KaLeach2[Zn3,P] = (-1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn3]*(N_KaNH42-N_KaNO32)+1))*0 + N_KaP2[Zn3]
    # N_KaLeach2[Zn4,N] = -1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn4]*(N_KaNH42-N_KaNO32)+1) + 0*N_KaP2[Zn4]
    # N_KaLeach2[Zn4,P] = (-1 + (N_KaNO32 + 1)*(N_KaNH42+1)/(N_KaNO32+N_FracNO32[Zn4]*(N_KaNH42-N_KaNO32)+1))*0 + N_KaP2[Zn4]
    # N_KaLeach3[Zn1,N] = -1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn1]*(N_KaNH43-N_KaNO33)+1) + 0 * N_KaP3[Zn1]
    # N_KaLeach3[Zn1,P] = (-1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn1]*(N_KaNH43-N_KaNO33)+1))*0 + N_KaP3[Zn1]
    # N_KaLeach3[Zn2,N] = -1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn2]*(N_KaNH43-N_KaNO33)+1) + 0 * N_KaP3[Zn2]
    # N_KaLeach3[Zn2,P] = (-1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn2]*(N_KaNH43-N_KaNO33)+1))*0 + N_KaP3[Zn2]
    # N_KaLeach3[Zn3,N] = -1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn3]*(N_KaNH43-N_KaNO33)+1) + 0 * N_KaP3[Zn3]
    # N_KaLeach3[Zn3,P] = (-1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn3]*(N_KaNH43-N_KaNO33)+1))*0+N_KaP3[Zn3]
    # N_KaLeach3[Zn4,N] = -1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn4]*(N_KaNH43-N_KaNO33)+1) + 0 * N_KaP3[Zn4]
    # N_KaLeach3[Zn4,P] = (-1 + (N_KaNO33 + 1)*(N_KaNH43+1)/(N_KaNO33+N_FracNO33[Zn4]*(N_KaNH43-N_KaNO33)+1)) * 0 + N_KaP3[Zn4]
    # N_KaLeach4[Zn1,N] = -1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn1]*(N_KaNH44-N_KaNO34)+1) + 0*N_KaP4[Zn1]
    # N_KaLeach4[Zn1,P] = (-1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn1]*(N_KaNH44-N_KaNO34)+1)) * 0 + N_KaP4[Zn1]
    # N_KaLeach4[Zn2,N] = -1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn2]*(N_KaNH44-N_KaNO34)+1) + 0*N_KaP4[Zn2]
    # N_KaLeach4[Zn2,P] = (-1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn2]*(N_KaNH44-N_KaNO34)+1)) * 0 + N_KaP4[Zn2]
    # N_KaLeach4[Zn3,N] = -1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn3]*(N_KaNH44-N_KaNO34)+1) + 0*N_KaP4[Zn3]
    # N_KaLeach4[Zn3,P] = (-1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn3]*(N_KaNH44-N_KaNO34)+1)) * 0 +N_KaP4[Zn3]
    # N_KaLeach4[Zn4,N] = -1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn4]*(N_KaNH44-N_KaNO34)+1) + 0*N_KaP4[Zn4]
    # N_KaLeach4[Zn4,P] = (-1 + (N_KaNO34 + 1)*(N_KaNH44+1)/(N_KaNO34+N_FracNO34[Zn4]*(N_KaNH44-N_KaNO34)+1)) * 0 + N_KaP4[Zn4]
    
    zonelayer_df$N_KaNO3 <- rep(layer_df$N_KaNO3, each = nzone)
    zonelayer_df$N_KaNH4 <- rep(layer_df$N_KaNH4, each = nzone)
    
    zonelayernut_df$N_KaLeach <- NA
    zonelayernut_df[zonelayernut_df$SlNut == "N", "N_KaLeach"] <- -1 + (zonelayer_df$N_KaNO3 + 1) *
      (zonelayer_df$N_KaNH4 + 1) /
      (
        zonelayer_df$N_KaNO3 + zonelayer_df$N_FracNO3 * (zonelayer_df$N_KaNH4 - zonelayer_df$N_KaNO3) +
          1
      )
    zonelayernut_df[zonelayernut_df$SlNut == "P", "N_KaLeach"] <- zonelayer_df$N_KaP
    
    # N_LeachConc1[Zone,SlNut] = if W_RelDrain1[Zone]>0 then ((N_Stock1[Zone,SlNut]+MN_Mineralization[Zone,SlNut]+N_SomMin1Exch[Zone,SlNut])*(N_BypassMatrix1[Zone]^W_RelDrain1[Zone]) +(MN_FertDissF[Zone,SlNut])*(N_BypassMacro1[Zone]^W_RelDrain1[Zone]))/((W_FieldCap1[Zone]*AF_DepthAct1[Zone]*1000+W_V1Drain[Zone]+W_LatRecharge1[Zone])*(N_KaLeach1[Zone,SlNut]+1)) else 0
    # N_LeachConc2[Zone,SlNut] = if W_RelDrain2[Zone]>0 then ((N_Stock2[Zone,SlNut]+N_SomMin2Exch[Zone,SlNut])*(N_BypassMatrix2[Zone]^W_RelDrain2[Zone])+(N_VLeach1[Zone,SlNut])*(N_BypassMacro2[Zone]^W_RelDrain2[Zone]))/((W_FieldCap2[Zone]*AF_Depth2[Zone]*1000+W_V2Drain[Zone]+W_LatRecharge2[Zone])*(N_KaLeach2[Zone,SlNut]+1)) else 0
    # N_LeachConc3[Zone,SlNut] = if W_RelDrain3[Zone]>0 then ((N_Stock3[Zone,SlNut]+N_SomMin3Exch[Zone,SlNut])*(N_BypassMatrix3[Zone]^W_RelDrain3[Zone])+(N_VLeach2[Zone,SlNut])*(N_BypassMacro3[Zone]^W_RelDrain3[Zone]))/((W_FieldCap3[Zone]*AF_Depth3[Zone]*1000+W_V3Drain[Zone]+W_LatRecharge3[Zone])*(N_KaLeach3[Zone,SlNut]+1)) else 0
    # N_LeachConc4[Zone,SlNut] = if W_V4Drain[Zone]> 0 then ((N_Stock4[Zone,SlNut]+N_SomMin4Exch[Zone,SlNut])*(N_BypassMatrix4[Zone]^W_RelDrain4[Zone])+(N_VLeach3[Zone,SlNut])*(N_BypassMacro4[Zone]^W_RelDrain4[Zone]))/((W_FieldCap4[Zone]*AF_Depth4[Zone]*1000+W_V4Drain[Zone]+W_LatRecharge4[Zone])*(N_KaLeach4[Zone,SlNut]+1)) else 0
    
    zonelayernut_df$N_BypassMatrix <- rep(zonelayer_df$N_BypassMatrix, nrow(nut_df))
    zonelayernut_df$N_BypassMacro <- rep(zonelayer_df$N_BypassMacro, nrow(nut_df))
    zonelayernut_df$W_FieldCap <- rep(zonelayer_df$W_FieldCap, nrow(nut_df))
    zonelayernut_df$W_RelDrain <- rep(zonelayer_df$W_RelDrain, nrow(nut_df))
    zonelayernut_df$W_VDrain <- rep(zonelayer_df$W_VDrain, nrow(nut_df))
    zonelayernut_df$W_LatRecharge <- rep(zonelayer_df$W_LatRecharge, nrow(nut_df))
    
    zonelayernut_df$N_VLeach <- NA
    zonelayernut_df$N_LeachConc <- NA
    
    zl1n <- zonelayernut_df[zonelayernut_df$layer == 1, ]
    zonelayernut_df[zonelayernut_df$layer == 1, "N_LeachConc"] <-
      ifelse(zl1n$W_RelDrain > 0,
             ((
               zl1n$N_Stock + zonenut_df$MN_Mineralization + zl1n$N_SomMinExch
             ) *
               (zl1n$N_BypassMatrix^zl1n$W_RelDrain) +
               zonenut_df$MN_FertDissF * (zl1n$N_BypassMacro^zl1n$W_RelDrain)
             ) /
               ((
                 zl1n$W_FieldCap * zl1n$AF_Depth * 1000 + zl1n$W_VDrain + zl1n$W_LatRecharge
               ) * (zl1n$N_KaLeach + 1)
               ),
             0)
    
    zl1n <- zonelayernut_df[zonelayernut_df$layer == 1, ]
    # N_VLeach1[Zone,SlNut] = N_LeachConc1[Zone,SlNut]*W_V1Drain[Zone]
    zonelayernut_df[zonelayernut_df$layer == 1, "N_VLeach"] <- zl1n$N_LeachConc *
      zl1n$W_VDrain
    
    zl1n <- zonelayernut_df[zonelayernut_df$layer == 1, ]
    zl2n <- zonelayernut_df[zonelayernut_df$layer == 2, ]
    zonelayernut_df[zonelayernut_df$layer == 2, "N_LeachConc"] <-
      ifelse(zl2n$W_RelDrain > 0, ((zl2n$N_Stock + zl2n$N_SomMinExch) *
                                     (zl2n$N_BypassMatrix^zl2n$W_RelDrain) +
                                     zl1n$N_VLeach * (zl2n$N_BypassMacro^zl2n$W_RelDrain)
      ) /
        ((
          zl2n$W_FieldCap * zl2n$AF_Depth * 1000 + zl2n$W_VDrain + zl2n$W_LatRecharge
        ) * (zl2n$N_KaLeach + 1)
        ), 0)
    
    zl2n <- zonelayernut_df[zonelayernut_df$layer == 2, ]
    # N_VLeach2[Zone,SlNut] = N_LeachConc2[Zone,SlNut]*W_V2Drain[Zone]
    zonelayernut_df[zonelayernut_df$layer == 2, "N_VLeach"] <- zl2n$N_LeachConc *
      zl2n$W_VDrain
    
    zl2n <- zonelayernut_df[zonelayernut_df$layer == 2, ]
    zl3n <- zonelayernut_df[zonelayernut_df$layer == 3, ]
    zonelayernut_df[zonelayernut_df$layer == 3, "N_LeachConc"] <-
      ifelse(zl3n$W_RelDrain > 0, ((zl3n$N_Stock + zl3n$N_SomMinExch) *
                                     (zl3n$N_BypassMatrix^zl3n$W_RelDrain) +
                                     zl2n$N_VLeach * (zl3n$N_BypassMacro^zl3n$W_RelDrain)
      ) /
        ((
          zl3n$W_FieldCap * zl3n$AF_Depth * 1000 + zl3n$W_VDrain + zl3n$W_LatRecharge
        ) * (zl3n$N_KaLeach + 1)
        ), 0)
    
    zl3n <- zonelayernut_df[zonelayernut_df$layer == 3, ]
    # N_VLeach3[Zone,SlNut] = N_LeachConc3[Zone,SlNut]*W_V3Drain[Zone]
    zonelayernut_df[zonelayernut_df$layer == 3, "N_VLeach"] <- zl3n$N_LeachConc *
      zl3n$W_VDrain
    
    zl3n <- zonelayernut_df[zonelayernut_df$layer == 3, ]
    zl4n <- zonelayernut_df[zonelayernut_df$layer == 4, ]
    zonelayernut_df[zonelayernut_df$layer == 4, "N_LeachConc"] <-
      ifelse(zl4n$W_RelDrain > 0, ((zl4n$N_Stock + zl4n$N_SomMinExch) *
                                     (zl4n$N_BypassMatrix^zl4n$W_RelDrain) +
                                     zl3n$N_VLeach * (zl4n$N_BypassMacro^zl4n$W_RelDrain)
      ) /
        ((
          zl4n$W_FieldCap * zl4n$AF_Depth * 1000 + zl4n$W_VDrain + zl4n$W_LatRecharge
        ) * (zl4n$N_KaLeach + 1)
        ), 0)
    
    zl4n <- zonelayernut_df[zonelayernut_df$layer == 4, ]
    # N_VLeach4[Zone,SlNut] = N_LeachConc4[Zone,SlNut]*W_V4Drain[Zone]
    zonelayernut_df[zonelayernut_df$layer == 4, "N_VLeach"] <- zl4n$N_LeachConc *
      zl4n$W_VDrain
    
    # N_HLeach1[Zone,SlNut] = N_LeachConc1[Zone,SlNut]*W_H1Drain[Zone]
    # N_HLeach2[Zone,SlNut] = N_LeachConc2[Zone,SlNut]*W_H2Drain[Zone]
    # N_HLeach3[Zone,SlNut] = N_LeachConc3[Zone,SlNut]*W_H3Drain[Zone]
    # N_HLeach4[Zone,SlNut] = N_LeachConc4[Zone,SlNut]*W_H4Drain[Zone]
    zonelayernut_df$W_HDrain <- rep(zonelayer_df$W_HDrain, nrow(nut_df))
    zonelayernut_df$N_HLeach <- zonelayernut_df$N_LeachConc * zonelayernut_df$W_HDrain
    
    # N_AvgLeachConc1[SlNut] = max(0,AF_ZoneFrac[Zn1]*N_LeachConc1[Zn1,SlNut]+AF_ZoneFrac[Zn2]*N_LeachConc1[Zn2,SlNut]+AF_ZoneFrac[Zn3]*N_LeachConc1[Zn3,SlNut]+AF_ZoneFrac[Zn4]*N_LeachConc1[Zn4,SlNut])
    # N_AvgLeachConc2[SlNut] = max(0,AF_ZoneFrac[Zn1]*N_LeachConc2[Zn1,SlNut]+AF_ZoneFrac[Zn2]*N_LeachConc2[Zn2,SlNut]+AF_ZoneFrac[Zn3]*N_LeachConc2[Zn3,SlNut]+AF_ZoneFrac[Zn4]*N_LeachConc2[Zn4,SlNut])
    # N_AvgLeachConc3[SlNut] = max(0,AF_ZoneFrac[Zn1]*N_LeachConc3[Zn1,SlNut]+AF_ZoneFrac[Zn2]*N_LeachConc3[Zn2,SlNut]+AF_ZoneFrac[Zn3]*N_LeachConc3[Zn3,SlNut]+AF_ZoneFrac[Zn4]*N_LeachConc3[Zn4,SlNut])
    # N_AvgLeachConc4[SlNut] = max(0,AF_ZoneFrac[Zn1]*N_LeachConc4[Zn1,SlNut]+AF_ZoneFrac[Zn2]*N_LeachConc4[Zn2,SlNut]+AF_ZoneFrac[Zn3]*N_LeachConc4[Zn3,SlNut]+AF_ZoneFrac[Zn4]*N_LeachConc4[Zn4,SlNut])
    zonelayernut_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nlayer * nrow(nut_df))
    zonelayernut_df$N_LeachConc_frac <- zonelayernut_df$AF_ZoneFrac * zonelayernut_df$N_LeachConc
    layernut_df$N_AvgLeachConc <- pmax(0,
                                       aggregate(zonelayernut_df["N_LeachConc_frac"], zonelayernut_df[c("layer", "SlNut")], sum)$N_LeachConc_frac)
    
    # N_Lat4NutInflow1[SlNut] = LF_Lat4Inflow1*N_AvgLeachConc1[SlNut]*N_Lat4InflowRelConc
    # N_Lat4NutInflow2[SlNut] = LF_Lat4Inflow2*N_AvgLeachConc2[SlNut]*N_Lat4InflowRelConc
    # N_Lat4NutInflow3[SlNut] = LF_Lat4Inflow3*N_AvgLeachConc3[SlNut]*N_Lat4InflowRelConc
    # N_Lat4NutInflow4[SlNut] = LF_Lat4Inflow4*N_Lat4InflowRelConc*N_AvgLeachConc4[SlNut]
    layernut_df$LF_Lat4Inflow <- rep(layer_df$LF_Lat4Inflow, nrow(nut_df))
    layernut_df$N_Lat4NutInflow <- layernut_df$LF_Lat4Inflow * layernut_df$N_AvgLeachConc *
      N_Lat4InflowRelConc
    
    # GHG_EffWaterfPoreF[Zone] = if W_V1Drain[Zone] = 0 then W_WaterfilledPoreF1[Zone] else min(1,GHG_SatTimeDuringVDrainDay+W_WaterfilledPoreF1[Zone]*(1-GHG_SatTimeDuringVDrainDay))
    zl1 <- zonelayer_df[zonelayer_df$layer == 1, c("W_VDrain", "W_WaterfilledPoreF")]
    zone_df$GHG_EffWaterfPoreF <- ifelse(
      zl1$W_VDrain == 0,
      zl1$W_WaterfilledPoreF,
      pmin(
        1,
        GHG_SatTimeDuringVDrainDay + zl1$W_WaterfilledPoreF * (1 -
                                                                 GHG_SatTimeDuringVDrainDay)
      )
    )
    
    # GHG_N2O_EmFraction[Zone] =  (10^(0.030001*100*GHG_EffWaterfPoreF[Zone]-1.446925)/(1+ (10^(0.030001*100*GHG_EffWaterfPoreF[Zone]-1.446925))))
    zone_df$GHG_N2O_EmFraction <-  (10^(0.030001 * 100 * zone_df$GHG_EffWaterfPoreF -
                                          1.446925) / (1 + (
                                            10^(0.030001 * 100 * zone_df$GHG_EffWaterfPoreF - 1.446925)
                                          )))
    
    # GHG_NitOxEm1[Zone] = 24*10^(-5) * 0.7212* ( 1.5*(MN2_SomMinExch[Zone,1]+GHG_LittMinMultiplier*MN_Mineralization[Zone,N])/( AF_DepthAct1[Zone]*W_BDLayer[1])^1.1699)
    # GHG_NitOxEm2[Zone] = 24*10^(-5) * 0.7212* ( 1.5*MN2_SomMinExch[Zone,2]/( AF_Depth2[Zone]*W_BDLayer[2])^1.1699)
    # GHG_NitOxEm3[Zone] = 24*10^(-5) * 0.7212* ( 1.5*MN2_SomMinExch[Zone,3]/( AF_Depth3[Zone]*W_BDLayer[3])^1.1699)
    # GHG_NitOxEm4[Zone] = 24*10^(-5) * 0.7212* ( 1.5*MN2_SomMinExch[Zone,4]/( AF_Depth4[Zone]*W_BDLayer[4])^1.1699)
    
    zonelayer_df$MN2_SomMinExch_calc <- zonelayer_df$MN2_SomMinExch
    zonelayer_df[zonelayer_df$layer == 1, "MN2_SomMinExch_calc"] <- zonelayer_df[zonelayer_df$layer == 1, "MN2_SomMinExch"] + GHG_LittMinMultiplier *
      zonenut_df[zonenut_df$SlNut == "N", "MN_Mineralization"]
    zonelayer_df$GHG_NitOxEm <- 24 * 10^(-5) * 0.7212 * (
      1.5 * zonelayer_df$MN2_SomMinExch_calc / (zonelayer_df$AF_Depth * zonelayer_df$W_BDLayer)^1.1699
    )
    
    # GHG_N2O_Em[Zone] = GHG_N2O_EmFraction[Zone]*GHG_NitOxEm1[Zone]
    zone_df$GHG_N2O_Em <- zone_df$GHG_N2O_EmFraction * zonelayer_df[zonelayer_df$layer == 1, "GHG_NitOxEm"]
    
    # GHG_N2_per_NOx[Zone] = GRAPH(GHG_EffWaterfPoreF[Zone])
    zone_df$GHG_N2_per_NOx <- get_y_df(zone_df$GHG_EffWaterfPoreF, "GHG_N2_per_NOx")
    
    # GHG_N2_Em[Zone] = GHG_N2_per_NOx[Zone]*GHG_NitOxEm1[Zone]
    zone_df$GHG_N2_Em <- zone_df$GHG_N2_per_NOx * zonelayer_df[zonelayer_df$layer == 1, "GHG_NitOxEm"]
    
    # GHG_NO_Em[Zone] = (1-GHG_N2O_EmFraction[Zone])*GHG_NitOxEm1[Zone]
    zone_df$GHG_NO_Em <- (1 - zone_df$GHG_N2O_EmFraction) * zonelayer_df[zonelayer_df$layer == 1, "GHG_NitOxEm"]
    
    # GHG_NgasEmissionFlux[Zone] = GHG_N2O_Em[Zone]+GHG_N2_Em[Zone]+GHG_NO_Em[Zone]
    zone_df$GHG_NgasEmissionFlux <- zone_df$GHG_N2O_Em + zone_df$GHG_N2_Em +
      zone_df$GHG_NO_Em
    
    # N_NGassLoss1[Zone] = GHG_NgasEmissionFlux[Zone]*N_Use_NgassLossEst?
    # N_NgassLoss2[Zone] = N_Use_NgassLossEst?*GHG_NitOxEm2[Zone]
    # N_NgassLoss3[Zone] = N_Use_NgassLossEst?*GHG_NitOxEm3[Zone]
    # N_NgassLoss4[Zone] = N_Use_NgassLossEst?*GHG_NitOxEm4[Zone]
    zonelayer_df$N_NGassLoss <- N_Use_NgassLossEst_is * zonelayer_df$GHG_NitOxEm
    zonelayer_df[zonelayer_df$layer == 1, "N_NGassLoss"] <- N_Use_NgassLossEst_is *
      zone_df$GHG_NgasEmissionFlux
    
    # S&B_DeadWoodBurnFrac[Zone] = GRAPH(S&B_FireTempIncSurf[Zone])
    zone_df$SB_DeadWoodBurnFrac <- get_y_df(zone_df$SB_FireTempIncSurf, "SB_DeadWoodBurnFrac")
    zonepcomp_df$SB_DeadWoodBurnFrac <- rep(zone_df$SB_DeadWoodBurnFrac, nrow(pcomp_df))
    
    # S&B_WoodFNutMin[Zone,PlantComp] = (1-S&B_DW?[PlantComp])*S&B_DeadWoodBurnFrac[Zone]*(1-S&B_NutVolatFrac[Zone,PlantComp])*S&B_DeadWood[Zone,PlantComp]
    zonepcomp_df$SB_WoodFNutMin <- (1 - zonepcomp_df$SB_DW_is) * zonepcomp_df$SB_DeadWoodBurnFrac *
      (1 - zonepcomp_df$SB_NutVolatFrac) * zonepcomp_df$SB_DeadWood
    
    # S&B_MinNutRel[Zone,PlantComp] = S&B_WoodFNutMin[Zone,PlantComp]+S&B_MinNutRele[Zone,PlantComp]
    zonepcomp_df$SB_MinNutRel <- zonepcomp_df$SB_WoodFNutMin + zonepcomp_df$SB_MinNutRele
    
    # N_In1[Zn1,N] = MN_FertDissF[Zn1,N]-N_VLeach1[Zn1,N]+AF_LatInFlowRatio[Zn1]*N_HLeach1[Zn2,N]                    +S&B_MinNutRel[Zn1,N]+N_AtmosphDepos[N]-N_NGassLoss1[Zn1]
    # N_In1[Zn2,N] = MN_FertDissF[Zn2,N]-N_VLeach1[Zn2,N]+AF_LatInFlowRatio[Zn2]*N_HLeach1[Zn3,N]   -N_HLeach1[Zn2,N]+S&B_MinNutRel[Zn2,N]+N_AtmosphDepos[N]-N_NGassLoss1[Zn2]
    # N_In1[Zn3,N] = MN_FertDissF[Zn3,N]-N_VLeach1[Zn3,N]+AF_LatInFlowRatio[Zn3]*N_HLeach1[Zn4,N]   -N_HLeach1[Zn3,N]+S&B_MinNutRel[Zn3,N]+N_AtmosphDepos[N]-N_NGassLoss1[Zn3]
    # N_In1[Zn4,N] = MN_FertDissF[Zn4,N]-N_VLeach1[Zn4,N]+AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow1[N]-N_HLeach1[Zn4,N]+S&B_MinNutRel[Zn4,N]+N_AtmosphDepos[N]-N_NGassLoss1[Zn4]
    #
    # N_In1[Zn1,P] = MN_FertDissF[Zn1,P]-N_VLeach1[Zn1,P]+AF_LatInFlowRatio[Zn1]*N_HLeach1[Zn2,P]                    +S&B_MinNutRel[Zn1,P]+N_AtmosphDepos[P]
    # N_In1[Zn2,P] = MN_FertDissF[Zn2,P]-N_VLeach1[Zn2,P]+AF_LatInFlowRatio[Zn2]*N_HLeach1[Zn3,P]   -N_HLeach1[Zn2,P]+S&B_MinNutRel[Zn2,P]+N_AtmosphDepos[P]
    # N_In1[Zn3,P] = MN_FertDissF[Zn3,P]-N_VLeach1[Zn3,P]+AF_LatInFlowRatio[Zn3]*N_HLeach1[Zn4,P]   -N_HLeach1[Zn3,P]+S&B_MinNutRel[Zn3,P]+N_AtmosphDepos[P]
    # N_In1[Zn4,P] = MN_FertDissF[Zn4,P]-N_VLeach1[Zn4,P]+AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow1[P]-N_HLeach1[Zn4,P]+S&B_MinNutRel[Zn4,P]+N_AtmosphDepos[P]
    #
    #
    # N_In2[Zn1,N] = N_VLeach1[Zn1,N]-N_VLeach2[Zn1,N]+AF_LatInFlowRatio[Zn1]*N_HLeach2[Zn2,N]                    -N_NgassLoss2[Zn1]
    # N_In2[Zn2,N] = N_VLeach1[Zn2,N]-N_VLeach2[Zn2,N]+AF_LatInFlowRatio[Zn2]*N_HLeach2[Zn3,N]   -N_HLeach2[Zn2,N]-N_NgassLoss2[Zn2]
    # N_In2[Zn3,N] = N_VLeach1[Zn3,N]-N_VLeach2[Zn3,N]+AF_LatInFlowRatio[Zn3]*N_HLeach2[Zn4,N]   -N_HLeach2[Zn3,N]-N_NgassLoss2[Zn3]
    # N_In2[Zn4,N] = N_VLeach1[Zn4,N]-N_VLeach2[Zn4,N]+AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow2[N]-N_HLeach2[Zn4,N]-N_NgassLoss2[Zn4]
    #
    # N_In2[Zn1,P] = N_VLeach1[Zn1,P]-N_VLeach2[Zn1,P]+AF_LatInFlowRatio[Zn1]*N_HLeach2[Zn2,P]
    # N_In2[Zn2,P] = N_VLeach1[Zn2,P]-N_VLeach2[Zn2,P]+AF_LatInFlowRatio[Zn2]*N_HLeach2[Zn3,P]   -N_HLeach2[Zn2,P]
    # N_In2[Zn3,P] = N_VLeach1[Zn3,P]-N_VLeach2[Zn3,P]+AF_LatInFlowRatio[Zn3]*N_HLeach2[Zn4,P]   -N_HLeach2[Zn3,P]
    # N_In2[Zn4,P] = N_VLeach1[Zn4,P]-N_VLeach2[Zn4,P]+AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow2[P]-N_HLeach2[Zn4,P]
    #
    #
    # N_In3[Zn1,N] = N_VLeach2[Zn1,N]-N_VLeach3[Zn1,N]+AF_LatInFlowRatio[Zn1]*N_HLeach3[Zn2,N]                    -N_NgassLoss3[Zn1]
    # N_In3[Zn2,N] = N_VLeach2[Zn2,N]-N_VLeach3[Zn2,N]+AF_LatInFlowRatio[Zn2]*N_HLeach3[Zn3,N]   -N_HLeach3[Zn2,N]-N_NgassLoss3[Zn2]
    # N_In3[Zn3,N] = N_VLeach2[Zn3,N]-N_VLeach3[Zn3,N]+AF_LatInFlowRatio[Zn3]*N_HLeach3[Zn4,N]   -N_HLeach3[Zn3,N]-N_NgassLoss3[Zn3]
    # N_In3[Zn4,N] = N_VLeach2[Zn4,N]-N_VLeach3[Zn4,N]+AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow3[N]-N_HLeach3[Zn4,N]-N_NgassLoss3[Zn4]
    #
    # N_In3[Zn1,P] = N_VLeach2[Zn1,P]-N_VLeach3[Zn1,P]+AF_LatInFlowRatio[Zn1]*N_HLeach3[Zn2,P]
    # N_In3[Zn2,P] = N_VLeach2[Zn2,P]-N_VLeach3[Zn2,P]+AF_LatInFlowRatio[Zn2]*N_HLeach3[Zn3,P]   -N_HLeach3[Zn2,P]
    # N_In3[Zn3,P] = N_VLeach2[Zn3,P]-N_VLeach3[Zn3,P]+AF_LatInFlowRatio[Zn3]*N_HLeach3[Zn4,P]   -N_HLeach3[Zn3,P]
    # N_In3[Zn4,P] = N_VLeach2[Zn4,P]-N_VLeach3[Zn4,P]+AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow3[P]-N_HLeach3[Zn4,P]
    #
    #
    # N_In4[Zn1,N] = N_VLeach3[Zn1,N]                 +AF_LatInFlowRatio[Zn1]*N_HLeach4[Zn2,N]                    -N_NgassLoss4[Zn1]
    # N_In4[Zn2,N] = N_VLeach3[Zn2,N]                 +AF_LatInFlowRatio[Zn2]*N_HLeach4[Zn3,N]   -N_HLeach4[Zn2,N]-N_NgassLoss4[Zn2]
    # N_In4[Zn3,N] = N_VLeach3[Zn3,N]                 +AF_LatInFlowRatio[Zn3]*N_HLeach4[Zn4,N]   -N_HLeach4[Zn3,N]-N_NgassLoss4[Zn3]
    # N_In4[Zn4,N] = N_VLeach3[Zn4,N]                 +AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow4[N]-N_HLeach4[Zn4,N]-N_NgassLoss4[Zn4]
    #
    # N_In4[Zn1,P] = N_VLeach3[Zn1,P]                 +AF_LatInFlowRatio[Zn1]*N_HLeach4[Zn2,P]
    # N_In4[Zn2,P] = N_VLeach3[Zn2,P]                 +AF_LatInFlowRatio[Zn2]*N_HLeach4[Zn3,P]   -N_HLeach4[Zn2,P]
    # N_In4[Zn3,P] = N_VLeach3[Zn3,P]                 +AF_LatInFlowRatio[Zn3]*N_HLeach4[Zn4,P]   -N_HLeach4[Zn3,P]
    # N_In4[Zn4,P] = N_VLeach3[Zn4,P]                 +AF_LatInFlowRatio[Zn4]*N_Lat4NutInflow4[P]-N_HLeach4[Zn4,P]
    
    zonelayernut_df$N_VLeach_up <- NA
    zonelayernut_df[zonelayernut_df$layer %in% c(2:4), "N_VLeach_up"] <- zonelayernut_df[zonelayernut_df$layer %in% c(1:3), "N_VLeach"]
    zonelayernut_df[zonelayernut_df$layer == 1, "N_VLeach_up"] <- zonenut_df$MN_FertDissF
    
    zonelayernut_df$N_VLeach_wo_l4 <- zonelayernut_df$N_VLeach
    zonelayernut_df[zonelayernut_df$layer == 4, "N_VLeach_wo_l4"] <- 0
    
    zonelayernut_df$N_HLeach_right <- NA
    zonelayernut_df[zonelayernut_df$zone %in% c(1:3), "N_HLeach_right"] <- zonelayernut_df[zonelayernut_df$zone %in% c(2:4), "N_HLeach"]
    zonelayernut_df[zonelayernut_df$zone == 4, "N_HLeach_right"] <- layernut_df$N_Lat4NutInflow
    
    zonelayernut_df$N_HLeach_wo_z1 <- zonelayernut_df$N_HLeach
    zonelayernut_df[zonelayernut_df$zone == 1, ]$N_HLeach_wo_z1 <- 0
    
    zonelayernut_df$AF_LatInFlowRatio <- rep(zone_df$AF_LatInFlowRatio, nlayer *
                                               nrow(nut_df))
    
    zonelayernut_df$N_In <- zonelayernut_df$N_VLeach_up - zonelayernut_df$N_VLeach_wo_l4 +
      zonelayernut_df$AF_LatInFlowRatio * zonelayernut_df$N_HLeach_right - zonelayernut_df$N_HLeach_wo_z1
    
    zonenut_df$N_AtmosphDepos <- rep(nut_df$N_AtmosphDepos, each = nzone)
    
    zonelayernut_df[zonelayernut_df$SlNut == "N", "N_In"] <- zonelayernut_df[zonelayernut_df$SlNut == "N", "N_In"] - zonelayer_df$N_NGassLoss
    zonelayernut_df[zonelayernut_df$layer == 1, "N_In"] <- zonelayernut_df[zonelayernut_df$layer == 1, "N_In"] + zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "SB_MinNutRel"] +
      zonenut_df$N_AtmosphDepos
    
    # S&B_pHmodPsorp[Zone] = GRAPH(S&B_Topsoil_pH[Zone])
    zone_df$SB_pHmodPsorp <- get_y_df(zone_df$SB_Topsoil_pH, "SB_pHmodPsorp")
    
    # S&B_RelPSorption[Zone] = S&B_PsorpModifier[Zone]*S&B_pHmodPsorp[Zone]
    zone_df$SB_RelPSorption <- zone_df$SB_PsorpModifier * zone_df$SB_pHmodPsorp
    
    # N_Ka1[Zn1,N] = -W_Theta1[Zn1] + (N_KaNO31 +W_Theta1[Zn1])*(N_KaNH41+W_Theta1[Zn1])/(N_KaNO31 + N_FracNO31[Zn1] * (N_KaNH41-N_KaNO31) + W_Theta1[Zn1])+0*N_KaP1[Zn1]*S&B_RelPSorption[Zn1]
    # N_Ka1[Zn1,P] = N_KaP1[Zn1]*S&B_RelPSorption[Zn1]+ 0*(N_FracNO31[Zn1]+N_KaNH41+N_KaNO31+W_Theta1[Zn1])
    # N_Ka1[Zn2,N] = -W_Theta1[Zn2] + (N_KaNO31 +W_Theta1[Zn2])*(N_KaNH41+W_Theta1[Zn2])/(N_KaNO31 + N_FracNO31[Zn2] * (N_KaNH41-N_KaNO31) + W_Theta1[Zn2])+0*N_KaP1[Zn2]*S&B_RelPSorption[Zn2]
    # N_Ka1[Zn2,P] = N_KaP1[Zn2]*S&B_RelPSorption[Zn2]+ 0*(N_FracNO31[Zn2]+N_KaNH41+N_KaNO31+W_Theta1[Zn2])
    # N_Ka1[Zn3,N] = -W_Theta1[Zn3] + (N_KaNO31 +W_Theta1[Zn3])*(N_KaNH41+W_Theta1[Zn3])/(N_KaNO31 + N_FracNO31[Zn3] * (N_KaNH41-N_KaNO31) + W_Theta1[Zn3])+0*N_KaP1[Zn3]*S&B_RelPSorption[Zn3]
    # N_Ka1[Zn3,P] = N_KaP1[Zn3]*S&B_RelPSorption[Zn3]+ 0*(N_FracNO31[Zn3]+N_KaNH41+N_KaNO31+W_Theta1[Zn3])
    # N_Ka1[Zn4,N] = -W_Theta1[Zn4] + (N_KaNO31 +W_Theta1[Zn4])*(N_KaNH41+W_Theta1[Zn4])/(N_KaNO31 + N_FracNO31[Zn4] * (N_KaNH41-N_KaNO31) + W_Theta1[Zn4])+0*N_KaP1[Zn4]*S&B_RelPSorption[Zn4]
    # N_Ka1[Zn4,P] = N_KaP1[Zn4]*S&B_RelPSorption[Zn4]+ 0*(N_FracNO31[Zn4]+N_KaNH41+N_KaNO31+W_Theta1[Zn4])
    #
    # N_Ka2[Zn1,N] = -W_Theta2[Zn1] + (N_KaNO32 +W_Theta2[Zn1])*(N_KaNH42+W_Theta2[Zn1])/(N_KaNO32+N_FracNO32[Zn1]*(N_KaNH42-N_KaNO32)+W_Theta2[Zn1])+0*N_KaP2[Zn1]
    # N_Ka2[Zn1,P] = N_KaP2[Zn1]+ 0*(N_FracNO32[Zn1]+N_KaNH42+N_KaNO32+W_Theta2[Zn1])
    # N_Ka2[Zn2,N] = -W_Theta2[Zn2] + (N_KaNO32 +W_Theta2[Zn2])*(N_KaNH42+W_Theta2[Zn2])/(N_KaNO32+N_FracNO32[Zn2]*(N_KaNH42-N_KaNO32)+W_Theta2[Zn2])+0*N_KaP2[Zn2]
    # N_Ka2[Zn2,P] = N_KaP2[Zn2]+ 0*(N_FracNO32[Zn2]+N_KaNH42+N_KaNO32+W_Theta2[Zn2])
    # N_Ka2[Zn3,N] = -W_Theta2[Zn3] + (N_KaNO32 +W_Theta2[Zn3])*(N_KaNH42+W_Theta2[Zn3])/(N_KaNO32+N_FracNO32[Zn3]*(N_KaNH42-N_KaNO32)+W_Theta2[Zn3])+0*N_KaP2[Zn3]
    # N_Ka2[Zn3,P] = N_KaP2[Zn3]+ 0*(N_FracNO32[Zn3]+N_KaNH42+N_KaNO32+W_Theta2[Zn3])
    # N_Ka2[Zn4,N] = -W_Theta2[Zn4] + (N_KaNO32 +W_Theta2[Zn4])*(N_KaNH42+W_Theta2[Zn4])/(N_KaNO32+N_FracNO32[Zn4]*(N_KaNH42-N_KaNO32)+W_Theta2[Zn4])+0*N_KaP2[Zn4]
    # N_Ka2[Zn4,P] = N_KaP2[Zn4]+ 0*(N_FracNO32[Zn4]+N_KaNH42+N_KaNO32+W_Theta2[Zn4])
    # N_Ka3[Zn1,N] = -W_Theta3[Zn1] + (N_KaNO33 +W_Theta3[Zn1])*(N_KaNH43+W_Theta3[Zn1])/(N_KaNO33+N_FracNO33[Zn1]*(N_KaNH43-N_KaNO33)+W_Theta3[Zn1])+0*N_KaP3[Zn1]
    # N_Ka3[Zn1,P] = N_KaP3[Zn1]+ 0*(N_FracNO33[Zn1]+N_KaNH43+N_KaNO33+W_Theta3[Zn1])
    # N_Ka3[Zn2,N] = -W_Theta3[Zn2] + (N_KaNO33 +W_Theta3[Zn2])*(N_KaNH43+W_Theta3[Zn2])/(N_KaNO33+N_FracNO33[Zn2]*(N_KaNH43-N_KaNO33)+W_Theta3[Zn2])+0*N_KaP3[Zn2]
    # N_Ka3[Zn2,P] = N_KaP3[Zn2]+ 0*(N_FracNO33[Zn2]+N_KaNH43+N_KaNO33+W_Theta3[Zn2])
    # N_Ka3[Zn3,N] = -W_Theta3[Zn3] + (N_KaNO33 +W_Theta3[Zn3])*(N_KaNH43+W_Theta3[Zn3])/(N_KaNO33+N_FracNO33[Zn3]*(N_KaNH43-N_KaNO33)+W_Theta3[Zn3])+0*N_KaP3[Zn3]
    # N_Ka3[Zn3,P] = N_KaP3[Zn3]+ 0*(N_FracNO33[Zn3]+N_KaNH43+N_KaNO33+W_Theta3[Zn3])
    # N_Ka3[Zn4,N] = -W_Theta3[Zn4] + (N_KaNO33 +W_Theta3[Zn4])*(N_KaNH43+W_Theta3[Zn4])/(N_KaNO33+N_FracNO33[Zn4]*(N_KaNH43-N_KaNO33)+W_Theta3[Zn4])+0*N_KaP3[Zn4]
    # N_Ka3[Zn4,P] = N_KaP3[Zn4]+ 0*(N_FracNO33[Zn4]+N_KaNH43+N_KaNO33+W_Theta3[Zn4])
    # N_Ka4[Zn1,N] = -W_Theta4[Zn1] + (N_KaNO34 +W_Theta4[Zn1])*(N_KaNH44+W_Theta4[Zn1])/(N_KaNO34+N_FracNO34[Zn1]*(N_KaNH44-N_KaNO34)+W_Theta4[Zn1])+0*N_KaP4[Zn1]
    # N_Ka4[Zn1,P] = N_KaP4[Zn1]+ 0*(N_FracNO34[Zn1]+N_KaNH44+N_KaNO34+W_Theta4[Zn1])
    # N_Ka4[Zn2,N] = -W_Theta4[Zn2] + (N_KaNO34 +W_Theta4[Zn2])*(N_KaNH44+W_Theta4[Zn2])/(N_KaNO34+N_FracNO34[Zn2]*(N_KaNH44-N_KaNO34)+W_Theta4[Zn2])+0*N_KaP4[Zn2]
    # N_Ka4[Zn2,P] = N_KaP4[Zn1]+ 0*(N_FracNO34[Zn2]+N_KaNH44+N_KaNO34+W_Theta4[Zn2])
    # N_Ka4[Zn3,N] = -W_Theta4[Zn3] + (N_KaNO34 +W_Theta4[Zn3])*(N_KaNH44+W_Theta4[Zn3])/(N_KaNO34+N_FracNO34[Zn3]*(N_KaNH44-N_KaNO34)+W_Theta4[Zn3])+0*N_KaP4[Zn3]
    # N_Ka4[Zn3,P] = N_KaP4[Zn3]+ 0*(N_FracNO34[Zn3]+N_KaNH44+N_KaNO34+W_Theta4[Zn3])
    # N_Ka4[Zn4,N] = -W_Theta4[Zn4] + (N_KaNO34 +W_Theta4[Zn4])*(N_KaNH44+W_Theta4[Zn4])/(N_KaNO34+N_FracNO34[Zn4]*(N_KaNH44-N_KaNO34)+W_Theta4[Zn4])+0*N_KaP4[Zn4]
    # N_Ka4[Zn4,P] = N_KaP4[Zn4]+ 0*(N_FracNO34[Zn4]+N_KaNH44+N_KaNO34+W_Theta4[Zn4])
    
    zonelayernut_df$N_Ka <- NA
    zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Ka"] <- -zonelayer_df$W_Theta +
      (zonelayer_df$N_KaNO3 + zonelayer_df$W_Theta) * (zonelayer_df$N_KaNH4 + zonelayer_df$W_Theta) /
      (
        zonelayer_df$N_KaNO3 + zonelayer_df$N_FracNO3 * (zonelayer_df$N_KaNH4 -
                                                           zonelayer_df$N_KaNO3) + zonelayer_df$W_Theta
      )
    zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Ka"] <- zonelayer_df$N_KaP
    zonelayernut_df[zonelayernut_df$SlNut == "P" &
                      zonelayernut_df$layer == 1, "N_Ka"] <- zonelayer_df[zonelayer_df$layer == 1, "N_KaP"] * zone_df$SB_RelPSorption
    
    # N_Cterm1[Zone,SlNut] = MAX(0,(N_Stock1[Zone,SlNut]-N_LeachConc1[Zone,SlNut]*W_Drain1[Zone]+MIN(0,MN_Mineralization[Zone,SlNut]+N_SomMin1Exch[Zone,SlNut]))/(N_Ka1[Zone,SlNut]+W_Theta1[Zone]))
    # N_Cterm2[Zone,SlNut] = max(0,(N_Stock2[Zone,SlNut]                                        +min(0,N_In2[Zone,SlNut]            +N_SomMin2Exch[Zone,SlNut]))/(N_Ka2[Zone,SlNut]+W_Theta2[Zone]))
    # N_Cterm3[Zone,SlNut] = max(0,(N_Stock3[Zone,SlNut]                                        +min(0,N_In3[Zone,SlNut]            +N_SomMin3Exch[Zone,SlNut]))/(N_Ka3[Zone,SlNut]+W_Theta3[Zone]))
    # N_Cterm4[Zone,SlNut] = max(0,(N_Stock4[Zone,SlNut]                                        +min(0,N_In4[Zone,SlNut]            +N_SomMin4Exch[Zone,SlNut]))/(N_Ka4[Zone,SlNut]+W_Theta4[Zone]))
    zonelayernut_df$N_Stock_calc <- zonelayernut_df$N_Stock
    zl1n <- zonelayernut_df[zonelayernut_df$layer == 1, ]
    zonelayernut_df[zonelayernut_df$layer == 1, "N_Stock_calc"] <- zl1n$N_Stock - zl1n$N_LeachConc * rep(zonelayer_df[zonelayer_df$layer ==  1, "W_Drain"], nrow(nut_df))
    
    zonelayernut_df$N_In_calc <- zonelayernut_df$N_In
    zonelayernut_df[zonelayernut_df$layer == 1, "N_In_calc"] <- zonenut_df$MN_Mineralization
    
    zonelayernut_df$N_Cterm <- pmax(
      0,
      (
        zonelayernut_df$N_Stock_calc + pmin(
          0,
          zonelayernut_df$N_In_calc + zonelayernut_df$N_SomMinExch
        )
      ) / (zonelayernut_df$N_Ka + zonelayernut_df$W_Theta)
    )
    
    # N_TPUptPot1[Zone,Tree] = IF (RT_TLrv1[Zone,Tree]>0 AND RT_T_G1[Zone,Tree]<>0) THEN (PI*RT_TLrv1[Zone,Tree]*N_Diff1[Zone,P]*N_Cterm1[Zone,P]/(RT_T_G1[Zone,Tree])) ELSE (0)
    # N_TPUptPot2[Zone,Tree] = IF (RT_TLrv2[Zone,Tree]>0 AND RT_T_G2[Zone,Tree]<>0) THEN (PI*RT_TLrv2[Zone,Tree]*N_Diff2[Zone,P]*N_Cterm2[Zone,P]/(RT_T_G2[Zone,Tree])) ELSE (0)
    # N_TPUptPot3[Zone,Tree] = IF (RT_TLrv3[Zone,Tree]>0 AND RT_T_G3[Zone,Tree]<>0) THEN (PI*RT_TLrv3[Zone,Tree]*N_Diff3[Zone,P]*N_Cterm3[Zone,P]/(RT_T_G3[Zone,Tree])) ELSE (0)
    # N_TPUptPot4[Zone,Tree] = IF (RT_TLrv4[Zone,Tree]>0 AND RT_T_G4[Zone,Tree]<>0) THEN (PI*RT_TLrv4[Zone,Tree]*N_Diff4[Zone,P]*N_Cterm4[Zone,P]/(RT_T_G4[Zone,Tree])) ELSE (0)
    zonelayertree_df$N_Diff_P <- rep(zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Diff"], ntree)
    zonelayertree_df$N_Cterm_P <- rep(zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Cterm"], ntree)
    zonelayertree_df$N_TPUptPot <- ifelse(
      zonelayertree_df$RT_TLrv > 0 & zonelayertree_df$RT_T_G != 0,
      pi * zonelayertree_df$RT_TLrv * zonelayertree_df$N_Diff_P * zonelayertree_df$N_Cterm_P /
        zonelayertree_df$RT_T_G,
      0
    )
    
    # T_NDeficit[SlNut,Tree] = MAX(0,T_NTarget[SlNut,Tree] - T_NBiom[SlNut,Tree])
    treenut_df$T_NDeficit <- pmax(0, treenut_df$T_NTarget - treenut_df$T_NBiom)
    
    # T_NFix[N,Sp1] = if T_NFixResp[Sp1]>10^-9 then (if INT(T_NFixVariable?[Sp1]) = 1 then (if T_NTargetNbiomRatio[N,Sp1]> 0 then min(T_NDeficit[N,Sp1]*(1 - (T_NTargetNbiomRatio[N,Sp1])^(T_NFixResp[Sp1])),T_GroRes[DW,Sp1]*T_NFixDWMaxFrac[Sp1]/T_NFixDWUnitCost[Sp1]) else 0) else T_NDeficit[N,Sp1]*T_NFixDayFrac[Sp1] ) else 0
    # T_NFix[N,Sp2] = if T_NFixResp[Sp2]>10^-7 then (if INT(T_NFixVariable?[Sp2]) = 1 then (if T_NTargetNbiomRatio[N,Sp2]> 0 then min(T_NDeficit[N,Sp2]*(1 - (T_NTargetNbiomRatio[N,Sp2])^(T_NFixResp[Sp2])),T_GroRes[DW,Sp2]*T_NFixDWMaxFrac[Sp2]/T_NFixDWUnitCost[Sp2]) else 0) else T_NDeficit[N,Sp2]*T_NFixDayFrac[Sp2] ) else 0
    # T_NFix[N,Sp3] = if T_NFixResp[Sp3]>10^-7 then (if INT(T_NFixVariable?[Sp3]) = 1 then (if T_NTargetNbiomRatio[N,Sp3]> 0 then min(T_NDeficit[N,Sp3]*(1 - (T_NTargetNbiomRatio[N,Sp3])^(T_NFixResp[Sp3])),T_GroRes[DW,Sp3]*T_NFixDWMaxFrac[Sp3]/T_NFixDWUnitCost[Sp3]) else 0) else T_NDeficit[N,Sp3]*T_NFixDayFrac[Sp3] ) else 0
    
    # T_NFix[P,Sp1] = 0*(T_NTargetNbiomRatio[P,Sp3]+T_NFixResp[Sp3]+T_GroRes[DW,Sp3]+T_NFixDWMaxFrac[Sp3]+T_NFixDWUnitCost[Sp3]+ T_NDeficit[P,Sp3]+T_NFixDayFrac[Sp3] +T_NFixVariable?[Sp1])
    # T_NFix[P,Sp2] = 0*(T_NTargetNbiomRatio[P,Sp3]+T_NFixResp[Sp3]+T_GroRes[DW,Sp3]+T_NFixDWMaxFrac[Sp3]+T_NFixDWUnitCost[Sp3]+ T_NDeficit[P,Sp3]+T_NFixDayFrac[Sp3] +T_NFixVariable?[Sp2])
    # T_NFix[P,Sp3] = 0*(T_NTargetNbiomRatio[P,Sp3]+T_NFixResp[Sp3]+T_GroRes[DW,Sp3]+T_NFixDWMaxFrac[Sp3]+T_NFixDWUnitCost[Sp3]+ T_NDeficit[P,Sp3]+T_NFixDayFrac[Sp3] +T_NFixVariable?[Sp3])
    
    treenut_df$T_NFix <- 0
    treenut_N <- treenut_df[treenut_df$SlNut == "N", c("T_NTargetNbiomRatio", "T_NDeficit")]
    treenut_df[treenut_df$SlNut == "N", "T_NFix"] <- ifelse(
      tree_df$T_NFixResp > 10^-7,
      ifelse(
        floor(tree_df$T_NFixVariable_is) == 1,
        ifelse(
          treenut_N$T_NTargetNbiomRatio > 0,
          pmin(
            treenut_N$T_NDeficit * (1 - treenut_N$T_NTargetNbiomRatio^tree_df$T_NFixResp),
            treepcomp_df[treepcomp_df$PlantComp == "DW", "T_GroRes"] * tree_df$T_NFixDWMaxFrac /
              tree_df$T_NFixDWUnitCost
          ),
          0
        ),
        treenut_N$T_NDeficit * tree_df$T_NFixDayFrac
      ) ,
      0
    )
    
    # TP_NumberofParasites[Tree] = TP_IncludeTreeParasites?*TP_ParasitesPerM2ofBranch*(AF_ZoneFrac[Zn1]*LIGHT_TBAI1[Zn1,Tree]+ AF_ZoneFrac[Zn2]*LIGHT_TBAI1[Zn2,Tree]+ AF_ZoneFrac[Zn3]*LIGHT_TBAI1[Zn3,Tree]+ AF_ZoneFrac[Zn4]*LIGHT_TBAI1[Zn4,Tree])
    zonetree_df$LIGHT_TBAI_frac <- zonetree_df$AF_ZoneFrac * zonelayertree_df[zonelayertree_df$layer == 1, "LIGHT_TBAI"]
    tree_df$TP_NumberofParasites <- TP_IncludeTreeParasites_is * TP_ParasitesPerM2ofBranch *
      (aggregate(zonetree_df["LIGHT_TBAI_frac"], zonetree_df["tree_id"], sum)$LIGHT_TBAI_frac)
    
    # TP_RelWaterSupply[Tree] = if TP_WaterDemand[Tree] = 0 then 0 else min(1,TW_UptTot[Tree]/TP_WaterDemand[Tree])
    tree_df$TP_RelWaterSupply <- ifelse(
      tree_df$TP_WaterDemand == 0,
      0,
      pmin(1, tree_df$TW_UptTot / tree_df$TP_WaterDemand)
    )
    
    # TP_GrowthRate = TP_MaxSizePerparasite/TP_TimeToReachMaxSize
    TP_GrowthRate <- TP_MaxSizePerparasite / TP_TimeToReachMaxSize
    
    # TP_ParasiteGrowth[Tree,PlantComp] = If TP_NumberofParasites[Tree]>0 and TP_MaxSizePerparasite > 0 and TP_ParasiteBiomass[Tree,DW] > 0 then TP_RelWaterSupply[Tree]*TP_RelNutSupplyDelayed[Tree]*TP_GrowthRate*((TP_NumberofParasites[Tree]*TP_MaxSizePerparasite - TP_ParasiteBiomass[Tree,DW])/(TP_NumberofParasites[Tree]*TP_MaxSizePerparasite+TP_ParasiteBiomass[Tree,DW])) else 0
    treepcomp_df$TP_NumberofParasites <- rep(tree_df$TP_NumberofParasites, nrow(pcomp_df))
    treepcomp_df$TP_RelWaterSupply <- rep(tree_df$TP_RelWaterSupply, nrow(pcomp_df))
    treepcomp_df$TP_RelNutSupplyDelayed <- rep(tree_df$TP_RelNutSupplyDelayed, nrow(pcomp_df))
    treepcomp_df$TP_ParasiteBiomass_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "TP_ParasiteBiomass"], nrow(pcomp_df))
    
    treepcomp_df$TP_ParasiteGrowth <- ifelse(
      treepcomp_df$TP_NumberofParasites > 0 &
        TP_MaxSizePerparasite > 0 &
        treepcomp_df$TP_ParasiteBiomass_DW > 0,
      treepcomp_df$TP_RelWaterSupply *
        treepcomp_df$TP_RelNutSupplyDelayed * TP_GrowthRate *
        ((
          treepcomp_df$TP_NumberofParasites * TP_MaxSizePerparasite - treepcomp_df$TP_ParasiteBiomass_DW
        ) /
          (
            treepcomp_df$TP_NumberofParasites * TP_MaxSizePerparasite + treepcomp_df$TP_ParasiteBiomass_DW
          )
        ),
      0
    )
    
    # TP_Nutrient_Demand[Sp1,N] = TP_ParasiteGrowth[Sp1,DW]*TP_BiomNutrContent[N]
    # TP_Nutrient_Demand[Sp1,P] = TP_ParasiteGrowth[Sp1,DW]*TP_BiomNutrContent[P]
    # TP_Nutrient_Demand[Sp2,N] = TP_ParasiteGrowth[Sp2,DW]*TP_BiomNutrContent[N]
    # TP_Nutrient_Demand[Sp2,P] = TP_ParasiteGrowth[Sp2,DW]*TP_BiomNutrContent[P]
    # TP_Nutrient_Demand[Sp3,N] = TP_ParasiteGrowth[Sp3,DW]*TP_BiomNutrContent[N]
    # TP_Nutrient_Demand[Sp3,P] = TP_ParasiteGrowth[Sp3,DW]*TP_BiomNutrContent[P]
    treenut_df$TP_ParasiteGrowth_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "TP_ParasiteGrowth"], nrow(nut_df))
    treenut_df$TP_BiomNutrContent <- rep(pcomp_df[pcomp_df$PlantComp %in% c("N", "P"), "TP_BiomNutrContent"], each = ntree)
    treenut_df$TP_Nutrient_Demand <- treenut_df$TP_ParasiteGrowth_DW * treenut_df$TP_BiomNutrContent
    
    # T_NDemand[SlNut,Tree] = if T_DiesToday?[Tree] = 1 or TW_Posgro[Tree]<0.01 then 0 else (T_NDeficit[SlNut,Tree] - T_NFix[SlNut,Tree])*T_NDemandFrac[Tree]+TP_Nutrient_Demand[Tree,SlNut]
    treenut_df$T_DiesToday_is <- rep(tree_df$T_DiesToday_is, nrow(nut_df))
    treenut_df$TW_Posgro <- rep(tree_df$TW_Posgro, nrow(nut_df))
    treenut_df$T_NDemandFrac <- rep(tree_df$T_NDemandFrac, nrow(nut_df))
    
    treenut_df$T_NDemand <- ifelse(
      treenut_df$T_DiesToday_is == 1 | treenut_df$TW_Posgro < 0.01,
      0,
      (treenut_df$T_NDeficit - treenut_df$T_NFix) * treenut_df$T_NDemandFrac + treenut_df$TP_Nutrient_Demand
    )
    
    # T_NPDemandZn[Zone,Tree] = IF(RT_TField[Tree]>0)THEN(RT_TLra[Zone,Tree]*T_NDemand[P, Tree]/RT_TField[Tree])ELSE(0)
    zonetree_df$RT_TField <- rep(tree_df$RT_TField, each = nzone)
    zonetree_df$T_NDemand_P <- rep(treenut_df[treenut_df$SlNut == "P", "T_NDemand"], each = nzone)
    zonetree_df$T_NPDemandZn <- ifelse(
      zonetree_df$RT_TField > 0,
      zonetree_df$RT_TLra * zonetree_df$T_NDemand_P / zonetree_df$RT_TField,
      0
    )
    
    # T_NNDemandZn[Zone,Tree] = IF(RT_TField[Tree]>0)THEN(RT_TLra[Zone,Tree]*T_NDemand[N, Tree]/RT_TField[Tree])ELSE(0)
    zonetree_df$T_NDemand_N <- rep(treenut_df[treenut_df$SlNut == "N", "T_NDemand"], each = nzone)
    zonetree_df$T_NNDemandZn <- ifelse(
      zonetree_df$RT_TField > 0,
      zonetree_df$RT_TLra * zonetree_df$T_NDemand_N / zonetree_df$RT_TField,
      0
    )
    
    # N_UptPot1[Zone,SlNut] = IF( (RT_CLrv1[Zone]>0 OR ARRAYSUM(RT_TLrv1[Zone,*])>0)AND RT_TC_G1[Zone]<>0) THEN(MIN(N_Stock1[Zone,SlNut], (PI*(RT_CLrv1[Zone]+ARRAYSUM(RT_TLrv1[Zone,*]))*N_Diff1[Zone,SlNut]*N_Cterm1[Zone,N]/(RT_TC_G1[Zone])))) ELSE (0)
    # N_UptPot2[Zone,SlNut] = IF( (RT_CLrv2[Zone]>0 OR ARRAYSUM(RT_TLrv2[Zone,*])>0)AND RT_TC_G2[Zone]<>0) THEN(MIN(N_Stock2[Zone,SlNut], (PI*(RT_CLrv2[Zone]+ARRAYSUM(RT_TLrv2[Zone,*]))*N_Diff2[Zone,SlNut]*N_Cterm2[Zone,N]/(RT_TC_G2[Zone])))) ELSE (0)
    # N_UptPot3[Zone,SlNut] = IF( (RT_CLrv3[Zone]>0 OR ARRAYSUM(RT_TLrv3[Zone,*])>0)AND RT_TC_G3[Zone]<>0) THEN(MIN(N_Stock3[Zone,SlNut], (PI*(RT_CLrv3[Zone]+ARRAYSUM(RT_TLrv3[Zone,*]))*N_Diff3[Zone,SlNut]*N_Cterm3[Zone,N]/(RT_TC_G3[Zone])))) ELSE (0)
    # N_UptPot4[Zone,SlNut] = IF( (RT_CLrv4[Zone]>0 OR ARRAYSUM(RT_TLrv4[Zone,*])>0)AND RT_TC_G4[Zone]<>0) THEN(MIN(N_Stock4[Zone,SlNut], (PI*(RT_CLrv4[Zone]+ARRAYSUM(RT_TLrv4[Zone,*]))*N_Diff4[Zone,SlNut]*N_Cterm4[Zone,N]/(RT_TC_G4[Zone])))) ELSE (0)
    zonelayernut_df$RT_CLrv <- rep(zonelayer_df$RT_CLrv, nrow(nut_df))
    zonelayernut_df$RT_TLrv_sum <- rep(aggregate(zonelayertree_df["RT_TLrv"], zonelayertree_df[c("zone", "layer")], sum)$RT_TLrv,
                                       nrow(nut_df))
    zonelayernut_df$RT_TC_G <- rep(zonelayer_df$RT_TC_G, nrow(nut_df))
    zonelayernut_df$N_Cterm_N <- rep(zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Cterm"], nrow(nut_df))
    
    zonelayernut_df$N_UptPot <- ifelse(
      (
        zonelayernut_df$RT_CLrv > 0 |
          zonelayernut_df$RT_TLrv_sum > 0
      ) &
        zonelayernut_df$RT_TC_G != 0,
      pmin(
        zonelayernut_df$N_Stock,
        (
          pi * (zonelayernut_df$RT_CLrv + zonelayernut_df$RT_TLrv_sum) * zonelayernut_df$N_Diff * zonelayernut_df$N_Cterm_N /
            zonelayernut_df$RT_TC_G
        )
      ),
      0
    )
    
    # N_CUptPot1[Zone,SlNut] = IF (RT_CLrv1[Zone]>0 AND RT_C_G1[Zone]<>0) THEN (PI*RT_CLrv1[Zone]*N_Diff1[Zone,SlNut]*N_Cterm1[Zone,SlNut]/(RT_C_G1[Zone])) ELSE (0)
    # N_CUptPot2[Zone,SlNut] = IF (RT_CLrv2[Zone]>0 AND RT_C_G2[Zone]<>0) THEN (PI*RT_CLrv2[Zone]*N_Diff2[Zone,SlNut]*N_Cterm2[Zone,SlNut]/(RT_C_G2[Zone])) ELSE (0)
    # N_CUptPot3[Zone,SlNut] = IF (RT_CLrv3[Zone]>0 AND RT_C_G3[Zone]<>0) THEN (PI*RT_CLrv3[Zone]*N_Diff3[Zone,SlNut]*N_Cterm3[Zone,SlNut]/(RT_C_G3[Zone])) ELSE (0)
    # N_CUptPot4[Zone,SlNut] = IF (RT_CLrv4[Zone]>0 AND RT_C_G4[Zone]<>0) THEN (PI*RT_CLrv4[Zone]*N_Diff4[Zone,SlNut]*N_Cterm4[Zone,SlNut]/(RT_C_G4[Zone])) ELSE (0)
    zonelayernut_df$RT_C_G <- rep(zonelayer_df$RT_C_G, nrow(nut_df))
    zonelayernut_df$N_CUptPot <- ifelse (
      zonelayernut_df$RT_CLrv > 0 &
        zonelayernut_df$RT_C_G != 0,
      pi * zonelayernut_df$RT_CLrv * zonelayernut_df$N_Diff * zonelayernut_df$N_Cterm /
        zonelayernut_df$RT_C_G,
      0
    )
    
    # CW_UptTot[Zone] = W_CUpt1[Zone]+W_CUpt2[Zone]+W_CUpt3[Zone]+W_CUpt4[Zone]
    zone_df$CW_UptTot <- aggregate(zonelayer_df["W_CUpt"], zonelayer_df["zone"], sum)$W_CUpt
    
    # CW_Posgro[Zone] = If (CW_DemandPot[Zone]>0 and AF_RunWatLim?>0.5) THEN (CW_UptTot[Zone]/CW_DemandPot[Zone]) ELSE (1)
    zone_df$CW_Posgro <- ifelse(
      zone_df$CW_DemandPot > 0 &
        AF_RunWatLim_is > 0.5,
      zone_df$CW_UptTot / zone_df$CW_DemandPot,
      1
    )
    
    # C_NDeficit[Zone,SlNut] = MAX(0,C_NTarget[Zone,SlNut]-C_NBiom[Zone,SlNut])
    zonenut_df$C_NDeficit <- pmax(0, zonenut_df$C_NTarget - zonenut_df$C_NBiom)
    
    # C_NTargetNBiomRatio[Zone,SlNut] = IF(C_NTarget[Zone,SlNut]>0)THEN(C_NBiom[Zone,SlNut]/C_NTarget[Zone,SlNut])ELSE(0)
    zonenut_df$C_NTargetNBiomRatio <- ifelse(zonenut_df$C_NTarget > 0,
                                             zonenut_df$C_NBiom / zonenut_df$C_NTarget,
                                             0)
    
    # C_NFIX[Zone,SlNut] = if CQ_NFixRespCurr[Zone]>0 then
    # (if CQ_NFixVariable?Curr[Zone] = 1 then
    #   (if C_NTargetNBiomRatio[Zone,SlNut]> 0 then
    #     min(C_NDeficit[Zone,N]*(1 - (C_NTargetNBiomRatio[Zone,SlNut])^(CQ_NFixRespCurr[Zone])),C_GroRes[Zone,DW]*CQ_NFixDWMaxFracCurr[Zone]/CQ_NFixDWUnitCostCurr[Zone]) else 0) else
    #       C_NDeficit[Zone,SlNut]*CQ_NFixDailyFracCurr[Zone] ) else 0
    
    zonenut_df$CQ_NFixRespCurr <- rep(zone_df$CQ_NFixRespCurr, nrow(nut_df))
    zonenut_df$CQ_NFixVariable_is_Curr <- rep(zone_df$CQ_NFixVariable_is_Curr, nrow(nut_df))
    zonenut_df$C_NDeficit_N <- rep(zonenut_df[zonenut_df$SlNut == "N", "C_NDeficit"], nrow(nut_df))
    zonenut_df$C_GroRes_DW <- rep(zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_GroRes"], nrow((nut_df)))
    zonenut_df$CQ_NFixDWMaxFracCurr <- rep(zone_df$CQ_NFixDWMaxFracCurr, nrow((nut_df)))
    zonenut_df$CQ_NFixDWUnitCostCurr <- rep(zone_df$CQ_NFixDWUnitCostCurr, nrow((nut_df)))
    zonenut_df$CQ_NFixDailyFracCurr <-  rep(zone_df$CQ_NFixDailyFracCurr, nrow((nut_df)))
    
    zonenut_df$C_NFIX <- ifelse(
      zonenut_df$CQ_NFixRespCurr > 0,
      ifelse(
        zonenut_df$CQ_NFixVariable_is_Curr == 1,
        ifelse(
          zonenut_df$C_NTargetNBiomRatio > 0,
          pmin(
            zonenut_df$C_NDeficit_N * (
              1 - (zonenut_df$C_NTargetNBiomRatio)^(zonenut_df$CQ_NFixRespCurr)
            ),
            zonenut_df$C_GroRes_DW * zonenut_df$CQ_NFixDWMaxFracCurr / zonenut_df$CQ_NFixDWUnitCostCurr
          ),
          0
        ),
        zonenut_df$C_NDeficit * zonenut_df$CQ_NFixDailyFracCurr
      ),
      0
    )
    
    
    # C_NDemand[Zone,SlNut] = if C_PlantDiesToday?[Zone] = 0 or CW_Posgro[Zone]>0.01 then MAX(0,(C_NDeficit[Zone,SlNut]-C_NFIX[Zone,SlNut])*(1 - 0.5 * CQ_Stage[Zone])^2) else 0
    zonenut_df$C_PlantDiesToday_is <- rep(zone_df$C_PlantDiesToday_is, nrow(nut_df))
    zonenut_df$CW_Posgro <- rep(zone_df$CW_Posgro, nrow(nut_df))
    zonenut_df$CQ_Stage <- rep(zone_df$CQ_Stage, nrow(nut_df))
    
    zonenut_df$C_NDemand <- ifelse(
      zonenut_df$C_PlantDiesToday_is == 0 |
        zonenut_df$CW_Posgro > 0.01,
      pmax(
        0,
        (zonenut_df$C_NDeficit - zonenut_df$C_NFIX) * (1 - 0.5 * zonenut_df$CQ_Stage)^2
      ),
      0
    )
    
    # N_RhizTShare1[Zone,Tree] = if N_RhizEffect1[Zone] > 0 and (ARRAYSUM(RT_TLrvMinM1[Zone,*])+RT_CLrvMinM1[Zone]) > 0 then
    # (1-N_RtSynloc1)*N_TRhizKaPM1[Zone,Tree]/(N_RhizEffect1[Zone])+N_RtSynloc1*RT_TLrvMinM1[Zone,Tree]/(ARRAYSUM(RT_TLrvMinM1[Zone,*])+RT_CLrvMinM1[Zone]) else 0
    # N_RhizTShare2[Zone,Tree] = if N_RhizEffect2[Zone] > 0 and (ARRAYSUM(RT_TLrvMinM2[Zone,*])+RT_CLrvMinM2[Zone]) > 0 then
    # (1-N_RtSynloc2)*N_TRhizKaPM2[Zone,Tree]/(N_RhizEffect2[Zone])+N_RtSynloc2*RT_TLrvMinM2[Zone,Tree]/(ARRAYSUM(RT_TLrvMinM2[Zone,*])+RT_CLrvMinM2[Zone]) else 0
    # N_RhizTShare3[Zone,Tree] = if N_RhizEffect3[Zone] > 0 and (ARRAYSUM(RT_TLrvMinM3[Zone,*])+RT_CLrvMinM3[Zone]) > 0 then
    # (1-N_RtSynloc3)*N_TRhizKaPM3[Zone,Tree]/(N_RhizEffect3[Zone])+N_RtSynloc3*RT_TLrvMinM3[Zone,Tree]/(ARRAYSUM(RT_TLrvMinM3[Zone,*])+RT_CLrvMinM3[Zone]) else 0
    # N_RhizTShare4[Zone,Tree] = if N_RhizEffect4[Zone] > 0 and (ARRAYSUM(RT_TLrvMinM4[Zone,*])+RT_CLrvMinM4[Zone]) > 0 then
    # (1-N_RtSynloc4)*N_TRhizKaPM4[Zone,Tree]/(N_RhizEffect4[Zone])+N_RtSynloc4*RT_TLrvMinM4[Zone,Tree]/(ARRAYSUM(RT_TLrvMinM4[Zone,*])+RT_CLrvMinM4[Zone]) else 0
    
    zonelayertree_df$RT_TLrvMinM_sum <- aggregate(zonelayertree_df["RT_TLrvMinM"], zonelayertree_df[c("zone", "layer")], sum)$RT_TLrvMinM
    zonelayertree_df$N_RhizEffect <- rep(zonelayer_df$N_RhizEffect, ntree)
    zonelayertree_df$RT_CLrvMinM <- rep(zonelayer_df$RT_CLrvMinM, ntree)
    zonelayertree_df$N_RtSynloc <- rep(rep(layer_df$N_RtSynloc, each = nzone), ntree)
    
    zonelayertree_df$N_RhizTShare <- ifelse(
      zonelayertree_df$N_RhizEffect > 0 &
        (
          zonelayertree_df$RT_TLrvMinM_sum + zonelayertree_df$RT_CLrvMinM
        ) > 0,
      (1 - zonelayertree_df$N_RtSynloc) * zonelayertree_df$N_TRhizKaPM /
        zonelayertree_df$N_RhizEffect + zonelayertree_df$N_RtSynloc * zonelayertree_df$RT_TLrvMinM /
        (
          zonelayertree_df$RT_TLrvMinM_sum + zonelayertree_df$RT_CLrvMinM
        ),
      0
    )
    
    # N_TTPUptPot1[Zone,Tree] = IF(N_TPUptPot1[Zone,Tree]>0 AND T_NPDemandZn[Zone,Tree]>0) THEN  N_UptPot1[Zone,P] * ((N_TPUptPot1[Zone,Tree]* T_NPDemandZn[Zone,Tree] / (N_CUptPot1[Zone,P] * C_NDemand[Zone,P] + N_TPUptPot1[Zone,Tree] * T_NPDemandZn[Zone,Tree])) + N_RhizEffect1[Zone] * N_RhizTShare1[Zone,Tree]) / (1 + N_RhizEffect1[Zone]) ELSE (0)
    # N_TTPUptPot2[Zone,Tree] = IF(N_TPUptPot2[Zone,Tree]>0 AND T_NPDemandZn[Zone,Tree]>0) THEN  N_UptPot2[Zone,P] * ((N_TPUptPot2[Zone,Tree]* T_NPDemandZn[Zone,Tree] / (N_CUptPot2[Zone,P] * C_NDemand[Zone,P] + N_TPUptPot2[Zone,Tree] * T_NPDemandZn[Zone,Tree])) + N_RhizEffect2[Zone] * N_RhizTShare2[Zone,Tree]) / (1 + N_RhizEffect2[Zone]) ELSE (0)
    # N_TTPUptPot3[Zone,Tree] = IF(N_TPUptPot3[Zone,Tree]>0 AND T_NPDemandZn[Zone,Tree]>0) THEN  N_UptPot3[Zone,P] * ((N_TPUptPot3[Zone,Tree]* T_NPDemandZn[Zone,Tree] / (N_CUptPot3[Zone,P] * C_NDemand[Zone,P] + N_TPUptPot3[Zone,Tree] * T_NPDemandZn[Zone,Tree])) + N_RhizEffect3[Zone] * N_RhizTShare3[Zone,Tree]) / (1 + N_RhizEffect3[Zone]) ELSE (0)
    # N_TTPUptPot4[Zone,Tree] = IF(N_TPUptPot4[Zone,Tree]>0 AND T_NPDemandZn[Zone,Tree]>0) THEN  N_UptPot4[Zone,P] * ((N_TPUptPot4[Zone,Tree]* T_NPDemandZn[Zone,Tree] / (N_CUptPot4[Zone,P] * C_NDemand[Zone,P] + N_TPUptPot4[Zone,Tree] * T_NPDemandZn[Zone,Tree])) + N_RhizEffect4[Zone] * N_RhizTShare4[Zone,Tree]) / (1 + N_RhizEffect4[Zone]) ELSE (0)
    
    df <- zonetree_df[c("zone", "tree_id", "T_NPDemandZn", "T_NNDemandZn")]
    t_df <- df[rep(seq_len(nrow(df)), nlayer), ]
    t_df$layer <- rep(layer_df$layer, each = nrow(zonetree_df))
    t_df <- t_df[order(t_df$tree_id, t_df$layer, t_df$zone), ]
    zonelayertree_df[c("T_NPDemandZn", "T_NNDemandZn")] <- t_df[c("T_NPDemandZn", "T_NNDemandZn")]
    
    zonelayertree_df$N_UptPot_P <- rep(zonelayernut_df[zonelayernut_df$SlNut == "P", "N_UptPot"], ntree)
    zonelayertree_df$N_UptPot_N <- rep(zonelayernut_df[zonelayernut_df$SlNut == "N", "N_UptPot"], ntree)
    zonelayertree_df$N_CUptPot_P <- rep(zonelayernut_df[zonelayernut_df$SlNut == "P", "N_CUptPot"], ntree)
    zonelayertree_df$N_CUptPot_N <- rep(zonelayernut_df[zonelayernut_df$SlNut == "N", "N_CUptPot"], ntree)
    zonelayertree_df$C_NDemand_P <- rep(zonenut_df[zonenut_df$SlNut == "P", "C_NDemand"], nlayer *
                                          ntree)
    zonelayertree_df$C_NDemand_N <- rep(zonenut_df[zonenut_df$SlNut == "N", "C_NDemand"], nlayer *
                                          ntree)
    zonelayertree_df$N_RhizEffect <- rep(zonelayer_df$N_RhizEffect, ntree)
    
    zonelayertree_df$N_TTPUptPot <- ifelse(
      zonelayertree_df$N_TPUptPot > 0 & zonelayertree_df$T_NPDemandZn > 0,
      zonelayertree_df$N_UptPot_P * ((
        zonelayertree_df$N_TPUptPot * zonelayertree_df$T_NPDemandZn /
          (
            zonelayertree_df$N_CUptPot_P * zonelayertree_df$C_NDemand_P +
              zonelayertree_df$N_TPUptPot * zonelayertree_df$T_NPDemandZn
          )
      ) +
        zonelayertree_df$N_RhizEffect * zonelayertree_df$N_RhizTShare
      ) / (1 + zonelayertree_df$N_RhizEffect),
      0
    )
    
    # N_TPUptPotAct1[Zone,Tree] = MIN(N_TTPUptPot1[Zone,Tree],N_TPUptPot1[Zone,Tree])
    # N_TPUptPotAct2[Zone,Tree] = MIN(N_TTPUptPot2[Zone,Tree],N_TPUptPot2[Zone,Tree])
    # N_TPUptPotAct3[Zone,Tree] = MIN(N_TTPUptPot3[Zone,Tree],N_TPUptPot3[Zone,Tree])
    # N_TPUptPotAct4[Zone,Tree] = MIN(N_TTPUptPot4[Zone,Tree],N_TPUptPot4[Zone,Tree])
    zonelayertree_df$N_TPUptPotAct <- pmin(zonelayertree_df$N_TTPUptPot,
                                           zonelayertree_df$N_TPUptPot)
    
    # T_NPUptPot[Tree] = (N_TPUptPotAct1[Zn1, Tree]+N_TPUptPotAct2[Zn1, Tree]+N_TPUptPotAct3[Zn1, Tree]+N_TPUptPotAct4[Zn1, Tree])*AF_ZoneFrac[Zn1]+(N_TPUptPotAct1[Zn2, Tree]+N_TPUptPotAct2[Zn2, Tree]+N_TPUptPotAct3[Zn2, Tree]+N_TPUptPotAct4[Zn2, Tree])*AF_ZoneFrac[Zn2]+(N_TPUptPotAct1[Zn3, Tree]+N_TPUptPotAct2[Zn3, Tree]+N_TPUptPotAct3[Zn3, Tree]+N_TPUptPotAct4[Zn3, Tree])*AF_ZoneFrac[Zn3]+(N_TPUptPotAct1[Zn4, Tree]+N_TPUptPotAct2[Zn4, Tree]+N_TPUptPotAct3[Zn4, Tree]+N_TPUptPotAct4[Zn4, Tree])*AF_ZoneFrac[Zn4]
    zonetree_df$N_TPUptPotAct_sumf <- aggregate(zonelayertree_df["N_TPUptPotAct"], zonelayertree_df[c("zone", "tree_id")], sum)$N_TPUptPotAct * zonetree_df$AF_ZoneFrac
    tree_df$T_NPUptPot <- aggregate(zonetree_df["N_TPUptPotAct_sumf"], zonetree_df["tree_id"], sum)$N_TPUptPotAct_sumf
    
    # N_TNUptPot1[Zone,Tree] = IF (RT_TLrv1[Zone,Tree]>0 AND RT_T_G1[Zone,Tree]<>0) THEN (PI*RT_TLrv1[Zone,Tree]*N_Diff1[Zone,N]*N_Cterm1[Zone,N]/(RT_T_G1[Zone,Tree])) ELSE (0)
    # N_TNUptPot2[Zone,Tree] = IF (RT_TLrv2[Zone,Tree]>0 AND RT_T_G2[Zone,Tree]<>0) THEN (PI*RT_TLrv2[Zone,Tree]*N_Diff2[Zone,N]*N_Cterm2[Zone,N]/(RT_T_G2[Zone,Tree])) ELSE (0)
    # N_TNUptPot3[Zone,Tree] = IF (RT_TLrv3[Zone,Tree]>0 AND RT_T_G3[Zone,Tree]<>0) THEN (PI*RT_TLrv3[Zone,Tree]*N_Diff3[Zone,N]*N_Cterm3[Zone,N]/(RT_T_G3[Zone,Tree])) ELSE (0)
    # N_TNUptPot4[Zone,Tree] = IF (RT_TLrv4[Zone,Tree]>0 AND RT_T_G4[Zone,Tree]<>0) THEN (PI*RT_TLrv4[Zone,Tree]*N_Diff4[Zone,N]*N_Cterm4[Zone,N]/(RT_T_G4[Zone,Tree])) ELSE (0)
    zonelayertree_df$N_Diff_N <- rep(zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Diff"], ntree)
    zonelayertree_df$N_Cterm_N <- rep(zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Cterm"], ntree)
    
    zonelayertree_df$N_TNUptPot <- ifelse(
      zonelayertree_df$RT_TLrv > 0 & zonelayertree_df$RT_T_G != 0,
      pi * zonelayertree_df$RT_TLrv * zonelayertree_df$N_Diff_N * zonelayertree_df$N_Cterm_N /
        (zonelayertree_df$RT_T_G),
      0
    )
    
    # N_TTNUptPot1[Zone,Tree] = IF(N_TNUptPot1[Zone,Tree]>0 AND T_NNDemandZn[Zone,Tree]>0) THEN
    # N_UptPot1[Zone,N] * ((N_TNUptPot1[Zone,Tree]* T_NNDemandZn[Zone,Tree] / (N_CUptPot1[Zone,N] * C_NDemand[Zone,N] + N_TNUptPot1[Zone,Tree] * T_NNDemandZn[Zone,Tree]))) ELSE (0)
    # N_TTNUptPot2[Zone,Tree] = IF(N_TNUptPot2[Zone,Tree]>0 AND T_NNDemandZn[Zone,Tree]>0) THEN
    # N_UptPot2[Zone,N] * ((N_TNUptPot2[Zone,Tree]* T_NNDemandZn[Zone,Tree] / (N_CUptPot2[Zone,N] * C_NDemand[Zone,N] + N_TNUptPot2[Zone,Tree] * T_NNDemandZn[Zone,Tree]))) ELSE (0)
    # N_TTNUptPot3[Zone,Tree] = IF(N_TNUptPot3[Zone,Tree]>0 AND T_NNDemandZn[Zone,Tree]>0) THEN
    # N_UptPot3[Zone,N] * ((N_TNUptPot3[Zone,Tree]* T_NNDemandZn[Zone,Tree] / (N_CUptPot3[Zone,N] * C_NDemand[Zone,N] + N_TNUptPot3[Zone,Tree] * T_NNDemandZn[Zone,Tree]))) ELSE (0)
    # N_TTNUptPot4[Zone,Tree] = IF(N_TNUptPot4[Zone,Tree]>0 AND T_NNDemandZn[Zone,Tree]>0) THEN
    # N_UptPot4[Zone,N] * ((N_TNUptPot4[Zone,Tree]* T_NNDemandZn[Zone,Tree] / (N_CUptPot4[Zone,N] * C_NDemand[Zone,N] + N_TNUptPot4[Zone,Tree] * T_NNDemandZn[Zone,Tree]))) ELSE (0)
    zonelayertree_df$N_TTNUptPot <- ifelse(
      zonelayertree_df$N_TNUptPot > 0 & zonelayertree_df$T_NNDemandZn > 0,
      zonelayertree_df$N_UptPot_N * (
        zonelayertree_df$N_TNUptPot * zonelayertree_df$T_NNDemandZn /
          (
            zonelayertree_df$N_CUptPot_N * zonelayertree_df$C_NDemand_N + zonelayertree_df$N_TNUptPot * zonelayertree_df$T_NNDemandZn
          )
      ),
      0
    )
    
    # N_TNUptPotAct1[Zone,Tree] = MIN(N_TTNUptPot1[Zone,Tree],N_TNUptPot1[Zone,Tree])
    # N_TNUptPotAct2[Zone,Tree] = MIN(N_TTNUptPot2[Zone,Tree],N_TNUptPot2[Zone,Tree])
    # N_TNUptPotAct3[Zone,Tree] = MIN(N_TTNUptPot3[Zone,Tree],N_TNUptPot3[Zone,Tree])
    # N_TNUptPotAct4[Zone,Tree] = MIN(N_TTNUptPot4[Zone,Tree],N_TNUptPot4[Zone,Tree])
    zonelayertree_df$N_TNUptPotAct <- pmin(zonelayertree_df$N_TTNUptPot,
                                           zonelayertree_df$N_TNUptPot)
    
    # T_NNUptPotZn[Zone,Tree] = (N_TNUptPotAct1[Zone,Tree]+ N_TNUptPotAct2[Zone,Tree]+N_TNUptPotAct3[Zone,Tree]+N_TNUptPotAct4[Zone,Tree])*AF_ZoneFrac[Zone]
    zonetree_df$T_NNUptPotZn <- aggregate(zonelayertree_df["N_TNUptPotAct"], zonelayertree_df[c("zone", "tree_id")], sum)$N_TNUptPotAct * zonetree_df$AF_ZoneFrac
    
    # T_NNUptPot[Tree] = ARRAYSUM(T_NNUptPotZn[*,Tree])
    tree_df$T_NNUptPot <- aggregate(zonetree_df["T_NNUptPotZn"], zonetree_df["tree_id"], sum)$T_NNUptPotZn
    
    # T_NNUptDenoZn[Zone,Tree] = (RT_TLrv1[Zone,Tree]*N_TNUptPotAct1[Zone,Tree]+RT_TLrv2[Zone,Tree]*N_TNUptPotAct2[Zone,Tree]+RT_TLrv3[Zone,Tree]*N_TNUptPotAct3[Zone,Tree]+RT_TLrv4[Zone,Tree]*N_TNUptPotAct4[Zone,Tree])*AF_ZoneWidth[Zone]
    zonelayertree_df$N_TNUptPotAct_Rt <- zonelayertree_df$RT_TLrv * zonelayertree_df$N_TNUptPotAct
    zonetree_df$AF_ZoneWidth <- rep(zone_df$AF_ZoneWidth, ntree)
    zonetree_df$T_NNUptDenoZn <- aggregate(zonelayertree_df["N_TNUptPotAct_Rt"], zonelayertree_df[c("zone", "tree_id")], sum)$N_TNUptPotAct_Rt *
      zonetree_df$AF_ZoneWidth
    
    
    # T_NNUptDeno[Tree] = ARRAYSUM(T_NNUptDenoZn[*,Tree])
    tree_df$T_NNUptDeno <- aggregate(zonetree_df["T_NNUptDenoZn"], zonetree_df["tree_id"], sum)$T_NNUptDenoZn
    
    # T_NPUptDenoZn[Zone,Tree] = (RT_TLrv1[Zone,Tree]*N_TPUptPotAct1[Zone,Tree]+RT_TLrv2[Zone,Tree]*N_TPUptPotAct2[Zone,Tree]+RT_TLrv3[Zone,Tree]*N_TPUptPotAct3[Zone,Tree]+RT_TLrv4[Zone,Tree]*N_TPUptPotAct4[Zone,Tree])*AF_ZoneWidth[Zone]
    zonelayertree_df$N_TPUptPotAct_Rt <- zonelayertree_df$RT_TLrv * zonelayertree_df$N_TPUptPotAct
    zonetree_df$T_NPUptDenoZn <- aggregate(zonelayertree_df["N_TPUptPotAct_Rt"], zonelayertree_df[c("zone", "tree_id")], sum)$N_TPUptPotAct_Rt *
      zonetree_df$AF_ZoneWidth
    
    # T_NPUptDeno[Tree] = ARRAYSUM(T_NPUptDenoZn[*,Tree])
    tree_df$T_NPUptDeno <- aggregate(zonetree_df["T_NPUptDenoZn"], zonetree_df["tree_id"], sum)$T_NPUptDenoZn
    
    # N_T1Upt1[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp1]+(1-N_N?[SlNut])*T_NPUptPot[Sp1])> T_NDemand[SlNut,Sp1] THEN min(N_Stock1[Zone,SlNut],(T_NDemand[SlNut,Sp1]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct1[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct1[Zone,Sp1])*AF_ZoneWidth[Zone]*RT_TLrv1[Zone,Sp1]/(N_N?[SlNut]*T_NNUptDeno[Sp1]+(1-N_N?[SlNut])*T_NPUptDeno[Sp1]))) ELSE min(N_Stock1[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct1[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct1[Zone,Sp1])))ELSE 0
    # N_T2Upt1[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp2]+(1-N_N?[SlNut])*T_NPUptPot[Sp2])> T_NDemand[SlNut,Sp2] THEN min(N_Stock1[Zone,SlNut],(T_NDemand[SlNut,Sp2]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct1[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct1[Zone,Sp2])*AF_ZoneWidth[Zone]*RT_TLrv1[Zone,Sp2]/(N_N?[SlNut]*T_NNUptDeno[Sp2]+(1-N_N?[SlNut])*T_NPUptDeno[Sp2]))) ELSE min(N_Stock1[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct1[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct1[Zone,Sp2])))ELSE 0
    # N_T3Upt1[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp3]+(1-N_N?[SlNut])*T_NPUptPot[Sp3])> T_NDemand[SlNut,Sp3] THEN min(N_Stock1[Zone,SlNut],(T_NDemand[SlNut,Sp3]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct1[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct1[Zone,Sp3])*AF_ZoneWidth[Zone]*RT_TLrv1[Zone,Sp3]/(N_N?[SlNut]*T_NNUptDeno[Sp3]+(1-N_N?[SlNut])*T_NPUptDeno[Sp3]))) ELSE min(N_Stock1[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct1[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct1[Zone,Sp3])))ELSE 0
    #
    # N_T1Upt2[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp1]+(1-N_N?[SlNut])*T_NPUptPot[Sp1])> T_NDemand[SlNut,Sp1] THEN min(N_Stock2[Zone,SlNut],(T_NDemand[SlNut,Sp1]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct2[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct2[Zone,Sp1])*AF_ZoneWidth[Zone]*RT_TLrv2[Zone,Sp1]/(N_N?[SlNut]*T_NNUptDeno[Sp1]+(1-N_N?[SlNut])*T_NPUptDeno[Sp1]))) ELSE min(N_Stock2[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct2[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct2[Zone,Sp1])))ELSE 0
    # N_T2Upt2[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp2]+(1-N_N?[SlNut])*T_NPUptPot[Sp2])> T_NDemand[SlNut,Sp2] THEN min(N_Stock2[Zone,SlNut],(T_NDemand[SlNut,Sp2]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct2[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct2[Zone,Sp2])*AF_ZoneWidth[Zone]*RT_TLrv2[Zone,Sp2]/(N_N?[SlNut]*T_NNUptDeno[Sp2]+(1-N_N?[SlNut])*T_NPUptDeno[Sp2]))) ELSE min(N_Stock2[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct2[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct2[Zone,Sp2])))ELSE 0
    # N_T3Upt2[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp3]+(1-N_N?[SlNut])*T_NPUptPot[Sp3])> T_NDemand[SlNut,Sp3] THEN min(N_Stock2[Zone,SlNut],(T_NDemand[SlNut,Sp3]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct2[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct2[Zone,Sp3])*AF_ZoneWidth[Zone]*RT_TLrv2[Zone,Sp3]/(N_N?[SlNut]*T_NNUptDeno[Sp3]+(1-N_N?[SlNut])*T_NPUptDeno[Sp3]))) ELSE min(N_Stock2[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct2[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct2[Zone,Sp3])))ELSE 0
    #
    # N_T1Upt3[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp1]+(1-N_N?[SlNut])*T_NPUptPot[Sp1])> T_NDemand[SlNut,Sp1] THEN min(N_Stock3[Zone,SlNut],(T_NDemand[SlNut,Sp1]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct3[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct3[Zone,Sp1])*AF_ZoneWidth[Zone]*RT_TLrv3[Zone,Sp1]/(N_N?[SlNut]*T_NNUptDeno[Sp1]+(1-N_N?[SlNut])*T_NPUptDeno[Sp1]))) ELSE min(N_Stock3[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct3[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct3[Zone,Sp1])))ELSE 0
    # N_T2Upt3[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp2]+(1-N_N?[SlNut])*T_NPUptPot[Sp2])> T_NDemand[SlNut,Sp2] THEN min(N_Stock3[Zone,SlNut],(T_NDemand[SlNut,Sp2]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct3[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct3[Zone,Sp2])*AF_ZoneWidth[Zone]*RT_TLrv3[Zone,Sp2]/(N_N?[SlNut]*T_NNUptDeno[Sp2]+(1-N_N?[SlNut])*T_NPUptDeno[Sp2]))) ELSE min(N_Stock3[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct3[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct3[Zone,Sp2])))ELSE 0
    # N_T3Upt3[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp3]+(1-N_N?[SlNut])*T_NPUptPot[Sp3])> T_NDemand[SlNut,Sp3] THEN min(N_Stock3[Zone,SlNut],(T_NDemand[SlNut,Sp3]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct3[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct3[Zone,Sp3])*AF_ZoneWidth[Zone]*RT_TLrv3[Zone,Sp3]/(N_N?[SlNut]*T_NNUptDeno[Sp3]+(1-N_N?[SlNut])*T_NPUptDeno[Sp3]))) ELSE min(N_Stock3[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct3[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct3[Zone,Sp3])))ELSE 0
    #
    # N_T1Upt4[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp1]+(1-N_N?[SlNut])*T_NPUptPot[Sp1])> T_NDemand[SlNut,Sp1] THEN min(N_Stock4[Zone,SlNut],(T_NDemand[SlNut,Sp1]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct4[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct4[Zone,Sp1])*AF_ZoneWidth[Zone]*RT_TLrv4[Zone,Sp1]/(N_N?[SlNut]*T_NNUptDeno[Sp1]+(1-N_N?[SlNut])*T_NPUptDeno[Sp1]))) ELSE min(N_Stock4[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct4[Zone,Sp1]+(1-N_N?[SlNut])*N_TPUptPotAct4[Zone,Sp1])))ELSE 0
    # N_T2Upt4[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp2]+(1-N_N?[SlNut])*T_NPUptPot[Sp2])> T_NDemand[SlNut,Sp2] THEN min(N_Stock4[Zone,SlNut],(T_NDemand[SlNut,Sp2]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct4[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct4[Zone,Sp2])*AF_ZoneWidth[Zone]*RT_TLrv4[Zone,Sp2]/(N_N?[SlNut]*T_NNUptDeno[Sp2]+(1-N_N?[SlNut])*T_NPUptDeno[Sp2]))) ELSE min(N_Stock4[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct4[Zone,Sp2]+(1-N_N?[SlNut])*N_TPUptPotAct4[Zone,Sp2])))ELSE 0
    # N_T3Upt4[Zone,SlNut] = If (AF_ZoneFrac[Zone]>0) THEN (IF (N_N?[SlNut]*T_NNUptPot[Sp3]+(1-N_N?[SlNut])*T_NPUptPot[Sp3])> T_NDemand[SlNut,Sp3] THEN min(N_Stock4[Zone,SlNut],(T_NDemand[SlNut,Sp3]/AF_ZoneFrac[Zone]*(N_N?[SlNut]*N_TNUptPotAct4[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct4[Zone,Sp3])*AF_ZoneWidth[Zone]*RT_TLrv4[Zone,Sp3]/(N_N?[SlNut]*T_NNUptDeno[Sp3]+(1-N_N?[SlNut])*T_NPUptDeno[Sp3]))) ELSE min(N_Stock4[Zone,SlNut],(N_N?[SlNut]*N_TNUptPotAct4[Zone,Sp3]+(1-N_N?[SlNut])*N_TPUptPotAct4[Zone,Sp3])))ELSE 0
    
    zonelayertreenut_df$AF_ZoneFrac <- rep(zonelayertree_df$AF_ZoneFrac, nrow(nut_df))
    zonelayertreenut_df$N_N_is <- rep(nut_df$N_N_is, each = nrow(zonelayertree_df))
    zonelayertreenut_df$T_NNUptPot <- rep(rep(tree_df$T_NNUptPot, each = nzone *
                                                nlayer), nrow(nut_df))
    zonelayertreenut_df$T_NPUptPot <- rep(rep(tree_df$T_NPUptPot, each = nzone *
                                                nlayer), nrow(nut_df))
    zonelayertreenut_df$T_NNUptDeno <- rep(rep(tree_df$T_NNUptDeno, each = nzone *
                                                 nlayer),
                                           nrow(nut_df))
    zonelayertreenut_df$T_NPUptDeno <- rep(rep(tree_df$T_NPUptDeno, each = nzone *
                                                 nlayer),
                                           nrow(nut_df))
    zonelayertreenut_df$T_NDemand <- rep(treenut_df$T_NDemand, each = nzone *
                                           nlayer)
    zonelayertreenut_df$N_Stock <- c(rep(zonelayernut_df[zonelayernut_df$SlNut == "N", "N_Stock"], ntree),
                                     rep(zonelayernut_df[zonelayernut_df$SlNut == "P", "N_Stock"], ntree))
    zonelayertreenut_df$N_TNUptPotAct <- rep(zonelayertree_df$N_TNUptPotAct, nrow(nut_df))
    zonelayertreenut_df$N_TPUptPotAct <- rep(zonelayertree_df$N_TPUptPotAct, nrow(nut_df))
    zonelayertreenut_df$AF_ZoneWidth <- rep(zonelayertree_df$AF_ZoneWidth, nrow(nut_df))
    zonelayertreenut_df$RT_TLrv <- rep(zonelayertree_df$RT_TLrv, nrow(nut_df))
    
    zonelayertreenut_df$N_Upt <- ifelse(
      zonelayertreenut_df$AF_ZoneFrac > 0,
      ifelse(
        (
          zonelayertreenut_df$N_N_is * zonelayertreenut_df$T_NNUptPot + (1 - zonelayertreenut_df$N_N_is) * zonelayertreenut_df$T_NPUptPot
        ) > zonelayertreenut_df$T_NDemand,
        pmin(
          zonelayertreenut_df$N_Stock,
          (
            zonelayertreenut_df$T_NDemand /
              zonelayertreenut_df$AF_ZoneFrac *
              (
                zonelayertreenut_df$N_N_is * zonelayertreenut_df$N_TNUptPotAct + (1 - zonelayertreenut_df$N_N_is) * zonelayertreenut_df$N_TPUptPotAct
              ) * zonelayertreenut_df$AF_ZoneWidth * zonelayertreenut_df$RT_TLrv /
              (
                zonelayertreenut_df$N_N_is * zonelayertreenut_df$T_NNUptDeno + (1 - zonelayertreenut_df$N_N_is) *
                  zonelayertreenut_df$T_NPUptDeno
              )
          )
        ),
        pmin(
          zonelayertreenut_df$N_Stock,
          (
            zonelayertreenut_df$N_N_is * zonelayertreenut_df$N_TNUptPotAct + (1 - zonelayertreenut_df$N_N_is) *
              zonelayertreenut_df$N_TPUptPotAct
          )
        )
      ),
      0
    )
    
    # T_NUptTot[N,Sp1] =  AF_ZoneFrac[Zn1]* (N_T1Upt1[Zn1,N]+N_T1Upt2[Zn1,N]+N_T1Upt3[Zn1,N]+N_T1Upt4[Zn1,N])+ AF_ZoneFrac[Zn2]*  (N_T1Upt1[Zn2,N]+N_T1Upt2[Zn2,N]+N_T1Upt3[Zn2,N]+N_T1Upt4[Zn2,N])+ AF_ZoneFrac[Zn3]*  (N_T1Upt1[Zn3,N]+N_T1Upt2[Zn3,N]+N_T1Upt3[Zn3,N]+N_T1Upt4[Zn3,N])+ AF_ZoneFrac[Zn4]*   (N_T1Upt1[Zn4,N]+N_T1Upt2[Zn4,N]+N_T1Upt3[Zn4,N]+N_T1Upt4[Zn4,N])  + 0*(N_T2Upt1[Zn1,N]+N_T2Upt2[Zn1,N]+N_T2Upt3[Zn1,N]+N_T2Upt4[Zn1,N]+ N_T3Upt1[Zn1,N]+N_T3Upt2[Zn1,N]+N_T3Upt3[Zn1,N]+N_T3Upt4[Zn1,N])
    # T_NUptTot[N,Sp2] =  AF_ZoneFrac[Zn1]* (N_T2Upt1[Zn1,N]+N_T2Upt2[Zn1,N]+N_T2Upt3[Zn1,N]+N_T2Upt4[Zn1,N])+ AF_ZoneFrac[Zn2]*  (N_T2Upt1[Zn2,N]+N_T2Upt2[Zn2,N]+N_T2Upt3[Zn2,N]+N_T2Upt4[Zn2,N])+ AF_ZoneFrac[Zn3]*  (N_T2Upt1[Zn3,N]+N_T2Upt2[Zn3,N]+N_T2Upt3[Zn3,N]+N_T2Upt4[Zn3,N])+ AF_ZoneFrac[Zn4]*   (N_T2Upt1[Zn4,N]+N_T2Upt2[Zn4,N]+N_T2Upt3[Zn4,N]+N_T2Upt4[Zn4,N])  + 0*(N_T1Upt1[Zn1,N]+N_T1Upt2[Zn1,N]+N_T1Upt3[Zn1,N]+N_T1Upt4[Zn1,N]+ N_T3Upt1[Zn1,N]+N_T3Upt2[Zn1,N]+N_T3Upt3[Zn1,N]+N_T3Upt4[Zn1,N])
    # T_NUptTot[N,Sp3] =  AF_ZoneFrac[Zn1]* (N_T3Upt1[Zn1,N]+N_T3Upt2[Zn1,N]+N_T3Upt3[Zn1,N]+N_T3Upt4[Zn1,N])+ AF_ZoneFrac[Zn2]*  (N_T3Upt1[Zn2,N]+N_T3Upt2[Zn2,N]+N_T3Upt3[Zn2,N]+N_T3Upt4[Zn2,N])+ AF_ZoneFrac[Zn3]*  (N_T3Upt1[Zn3,N]+N_T3Upt2[Zn3,N]+N_T3Upt3[Zn3,N]+N_T3Upt4[Zn3,N])+ AF_ZoneFrac[Zn4]*   (N_T3Upt1[Zn4,N]+N_T3Upt2[Zn4,N]+N_T3Upt3[Zn4,N]+N_T3Upt4[Zn4,N])  + 0*(N_T2Upt1[Zn1,N]+N_T2Upt2[Zn1,N]+N_T2Upt3[Zn1,N]+N_T2Upt4[Zn1,N]+ N_T1Upt1[Zn1,N]+N_T1Upt2[Zn1,N]+N_T1Upt3[Zn1,N]+N_T1Upt4[Zn1,N])
    # T_NUptTot[P,Sp1] =  AF_ZoneFrac[Zn1]* (N_T1Upt1[Zn1,P]+N_T1Upt2[Zn1,P]+N_T1Upt3[Zn1,P]+N_T1Upt4[Zn1,P])+ AF_ZoneFrac[Zn2]*  (N_T1Upt1[Zn2,P]+N_T1Upt2[Zn2,P]+N_T1Upt3[Zn2,P]+N_T1Upt4[Zn2,P])+ AF_ZoneFrac[Zn3]*  (N_T1Upt1[Zn3,P]+N_T1Upt2[Zn3,P]+N_T1Upt3[Zn3,P]+N_T1Upt4[Zn3,P])+ AF_ZoneFrac[Zn4]*   (N_T1Upt1[Zn4,P]+N_T1Upt2[Zn4,P]+N_T1Upt3[Zn4,P]+N_T1Upt4[Zn4,P])  + 0*(N_T2Upt1[Zn1,P]+N_T2Upt2[Zn1,P]+N_T2Upt3[Zn1,P]+N_T2Upt4[Zn1,P]+ N_T3Upt1[Zn1,P]+N_T3Upt2[Zn1,P]+N_T3Upt3[Zn1,P]+N_T3Upt4[Zn1,P])
    # T_NUptTot[P,Sp2] =  AF_ZoneFrac[Zn1]* (N_T2Upt1[Zn1,P]+N_T2Upt2[Zn1,P]+N_T2Upt3[Zn1,P]+N_T2Upt4[Zn1,P])+ AF_ZoneFrac[Zn2]*  (N_T2Upt1[Zn2,P]+N_T2Upt2[Zn2,P]+N_T2Upt3[Zn2,P]+N_T2Upt4[Zn2,P])+ AF_ZoneFrac[Zn3]*  (N_T2Upt1[Zn3,P]+N_T2Upt2[Zn3,P]+N_T2Upt3[Zn3,P]+N_T2Upt4[Zn3,P])+ AF_ZoneFrac[Zn4]*   (N_T2Upt1[Zn4,P]+N_T2Upt2[Zn4,P]+N_T2Upt3[Zn4,P]+N_T2Upt4[Zn4,P])  + 0*(N_T1Upt1[Zn1,P]+N_T1Upt2[Zn1,P]+N_T1Upt3[Zn1,P]+N_T1Upt4[Zn1,P]+ N_T3Upt1[Zn1,P]+N_T3Upt2[Zn1,P]+N_T3Upt3[Zn1,P]+N_T3Upt4[Zn1,P])
    # T_NUptTot[P,Sp3] =  AF_ZoneFrac[Zn1]* (N_T3Upt1[Zn1,P]+N_T3Upt2[Zn1,P]+N_T3Upt3[Zn1,P]+N_T3Upt4[Zn1,P])+ AF_ZoneFrac[Zn2]*  (N_T3Upt1[Zn2,P]+N_T3Upt2[Zn2,P]+N_T3Upt3[Zn2,P]+N_T3Upt4[Zn2,P])+ AF_ZoneFrac[Zn3]*  (N_T3Upt1[Zn3,P]+N_T3Upt2[Zn3,P]+N_T3Upt3[Zn3,P]+N_T3Upt4[Zn3,P])+ AF_ZoneFrac[Zn4]*   (N_T3Upt1[Zn4,P]+N_T3Upt2[Zn4,P]+N_T3Upt3[Zn4,P]+N_T3Upt4[Zn4,P])  + 0*(N_T2Upt1[Zn1,P]+N_T2Upt2[Zn1,P]+N_T2Upt3[Zn1,P]+N_T2Upt4[Zn1,P]+ N_T1Upt1[Zn1,P]+N_T1Upt2[Zn1,P]+N_T1Upt3[Zn1,P]+N_T1Upt4[Zn1,P])
    zonetreenut_df$N_TUpt_ZnFrac <- aggregate(zonelayertreenut_df["N_Upt"], zonelayertreenut_df[c("zone", "tree_id", "SlNut")], sum)$N_Upt * rep(zone_df$AF_ZoneFrac, nrow(treenut_df))
    treenut_df$T_NUptTot <- aggregate(zonetreenut_df["N_TUpt_ZnFrac"], zonetreenut_df[c("tree_id", "SlNut")], sum)$N_TUpt_ZnFrac
    
    # RT3_AvgNutUptperRoot[SlNut,Tree] = if RT_TField[Tree]>0 then T_NUptTot[SlNut,Tree]/RT_TField[Tree] else 0
    treenut_df$RT_TField <- rep(tree_df$RT_TField, nrow(nut_df))
    treenut_df$RT3_AvgNutUptperRoot <- ifelse(treenut_df$RT_TField > 0 ,
                                              treenut_df$T_NUptTot / treenut_df$RT_TField,
                                              0)
    
    # RT3_L1N_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth1[Zn1,Sp1]> 0 then  (N_T1Upt1[Zn1,N]/RT3_LrvDepth1[Zn1,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt1[Zn1,N]+N_T3Upt1[Zn1,N])
    # RT3_L1N_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth1[Zn1,Sp2]> 0 then  (N_T2Upt1[Zn1,N]/RT3_LrvDepth1[Zn1,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt1[Zn1,N]+N_T3Upt1[Zn1,N])
    # RT3_L1N_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth1[Zn1,Sp3]> 0 then  (N_T3Upt1[Zn1,N]/RT3_LrvDepth1[Zn1,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt1[Zn1,N]+N_T2Upt1[Zn1,N])
    # RT3_L1N_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth1[Zn2,Sp1]> 0 then  (N_T1Upt1[Zn2,N]/RT3_LrvDepth1[Zn2,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt1[Zn2,N]+N_T3Upt1[Zn2,N])
    # RT3_L1N_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth1[Zn2,Sp2]> 0 then  (N_T2Upt1[Zn2,N]/RT3_LrvDepth1[Zn2,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt1[Zn2,N]+N_T3Upt1[Zn2,N])
    # RT3_L1N_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth1[Zn2,Sp3]> 0 then  (N_T3Upt1[Zn2,N]/RT3_LrvDepth1[Zn2,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt1[Zn2,N]+N_T2Upt1[Zn2,N])
    # RT3_L1N_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth1[Zn3,Sp1]> 0 then  (N_T1Upt1[Zn3,N]/RT3_LrvDepth1[Zn3,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt1[Zn3,N]+N_T3Upt1[Zn3,N])
    # RT3_L1N_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth1[Zn3,Sp2]> 0 then  (N_T2Upt1[Zn3,N]/RT3_LrvDepth1[Zn3,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt1[Zn3,N]+N_T3Upt1[Zn3,N])
    # RT3_L1N_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth1[Zn3,Sp3]> 0 then  (N_T3Upt1[Zn3,N]/RT3_LrvDepth1[Zn3,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt1[Zn3,N]+N_T2Upt1[Zn3,N])
    # RT3_L1N_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth1[Zn4,Sp1]> 0 then  (N_T1Upt1[Zn4,N]/RT3_LrvDepth1[Zn4,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt1[Zn4,N]+N_T3Upt1[Zn4,N])
    # RT3_L1N_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth1[Zn4,Sp2]> 0 then  (N_T2Upt1[Zn4,N]/RT3_LrvDepth1[Zn4,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt1[Zn4,N]+N_T3Upt1[Zn4,N])
    # RT3_L1N_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth1[Zn4,Sp3]> 0 then  (N_T3Upt1[Zn4,N]/RT3_LrvDepth1[Zn4,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt1[Zn4,N]+N_T2Upt1[Zn4,N])
    #
    # RT3_L1P_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth1[Zn1,Sp1]> 0 then  (N_T1Upt1[Zn1,P]/RT3_LrvDepth1[Zn1,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt1[Zn1,P]+N_T3Upt1[Zn1,P])
    # RT3_L1P_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth1[Zn1,Sp2]> 0 then  (N_T2Upt1[Zn1,P]/RT3_LrvDepth1[Zn1,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt1[Zn1,P]+N_T3Upt1[Zn1,P])
    # RT3_L1P_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth1[Zn1,Sp3]> 0 then  (N_T3Upt1[Zn1,P]/RT3_LrvDepth1[Zn1,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt1[Zn1,P]+N_T2Upt1[Zn1,P])
    # RT3_L1P_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth1[Zn2,Sp1]> 0 then  (N_T1Upt1[Zn2,P]/RT3_LrvDepth1[Zn2,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt1[Zn2,P]+N_T3Upt1[Zn2,P])
    # RT3_L1P_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth1[Zn2,Sp2]> 0 then  (N_T2Upt1[Zn2,P]/RT3_LrvDepth1[Zn2,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt1[Zn2,P]+N_T3Upt1[Zn2,P])
    # RT3_L1P_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth1[Zn2,Sp3]> 0 then  (N_T3Upt1[Zn2,P]/RT3_LrvDepth1[Zn2,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt1[Zn2,P]+N_T2Upt1[Zn2,P])
    # RT3_L1P_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth1[Zn3,Sp1]> 0 then  (N_T1Upt1[Zn3,P]/RT3_LrvDepth1[Zn3,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt1[Zn3,P]+N_T3Upt1[Zn3,P])
    # RT3_L1P_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth1[Zn3,Sp2]> 0 then  (N_T2Upt1[Zn3,P]/RT3_LrvDepth1[Zn3,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt1[Zn3,P]+N_T3Upt1[Zn3,P])
    # RT3_L1P_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth1[Zn3,Sp3]> 0 then  (N_T3Upt1[Zn3,P]/RT3_LrvDepth1[Zn3,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt1[Zn3,P]+N_T2Upt1[Zn3,P])
    # RT3_L1P_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth1[Zn4,Sp1]> 0 then  (N_T1Upt1[Zn4,P]/RT3_LrvDepth1[Zn4,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt1[Zn4,P]+N_T3Upt1[Zn4,P])
    # RT3_L1P_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth1[Zn4,Sp2]> 0 then  (N_T2Upt1[Zn4,P]/RT3_LrvDepth1[Zn4,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt1[Zn4,P]+N_T3Upt1[Zn4,P])
    # RT3_L1P_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth1[Zn4,Sp3]> 0 then  (N_T3Upt1[Zn4,P]/RT3_LrvDepth1[Zn4,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt1[Zn4,P]+N_T2Upt1[Zn4,P])
    #
    #
    # RT3_L2N_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth2[Zn1,Sp1]> 0 then  (N_T1Upt2[Zn1,N]/RT3_LrvDepth2[Zn1,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt2[Zn1,N]+N_T3Upt2[Zn1,N])
    # RT3_L2N_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth2[Zn1,Sp2]> 0 then  (N_T2Upt2[Zn1,N]/RT3_LrvDepth2[Zn1,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt2[Zn1,N]+N_T3Upt2[Zn1,N])
    # RT3_L2N_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth2[Zn1,Sp3]> 0 then  (N_T3Upt2[Zn1,N]/RT3_LrvDepth2[Zn1,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt2[Zn1,N]+N_T2Upt2[Zn1,N])
    # RT3_L2N_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth2[Zn2,Sp1]> 0 then  (N_T1Upt2[Zn2,N]/RT3_LrvDepth2[Zn2,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt2[Zn2,N]+N_T3Upt2[Zn2,N])
    # RT3_L2N_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth2[Zn2,Sp2]> 0 then  (N_T2Upt2[Zn2,N]/RT3_LrvDepth2[Zn2,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt2[Zn2,N]+N_T3Upt2[Zn2,N])
    # RT3_L2N_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth2[Zn2,Sp3]> 0 then  (N_T3Upt2[Zn2,N]/RT3_LrvDepth2[Zn2,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt2[Zn2,N]+N_T2Upt2[Zn2,N])
    # RT3_L2N_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth2[Zn3,Sp1]> 0 then  (N_T1Upt2[Zn3,N]/RT3_LrvDepth2[Zn3,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt2[Zn3,N]+N_T3Upt2[Zn3,N])
    # RT3_L2N_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth2[Zn3,Sp2]> 0 then  (N_T2Upt2[Zn3,N]/RT3_LrvDepth2[Zn3,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt2[Zn3,N]+N_T3Upt2[Zn3,N])
    # RT3_L2N_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth2[Zn3,Sp3]> 0 then  (N_T3Upt2[Zn3,N]/RT3_LrvDepth2[Zn3,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt2[Zn3,N]+N_T2Upt2[Zn3,N])
    # RT3_L2N_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth2[Zn4,Sp1]> 0 then  (N_T1Upt2[Zn4,N]/RT3_LrvDepth2[Zn4,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt2[Zn4,N]+N_T3Upt2[Zn4,N])
    # RT3_L2N_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth2[Zn4,Sp2]> 0 then  (N_T2Upt2[Zn4,N]/RT3_LrvDepth2[Zn4,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt2[Zn4,N]+N_T3Upt2[Zn4,N])
    # RT3_L2N_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth2[Zn4,Sp3]> 0 then  (N_T3Upt2[Zn4,N]/RT3_LrvDepth2[Zn4,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt2[Zn4,N]+N_T2Upt2[Zn4,N])
    #
    # RT3_L2P_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth2[Zn1,Sp1]> 0 then  (N_T1Upt2[Zn1,P]/RT3_LrvDepth2[Zn1,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt2[Zn1,P]+N_T3Upt2[Zn1,P])
    # RT3_L2P_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth2[Zn1,Sp2]> 0 then  (N_T2Upt2[Zn1,P]/RT3_LrvDepth2[Zn1,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt2[Zn1,P]+N_T3Upt2[Zn1,P])
    # RT3_L2P_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth2[Zn1,Sp3]> 0 then  (N_T3Upt2[Zn1,P]/RT3_LrvDepth2[Zn1,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt2[Zn1,P]+N_T2Upt2[Zn1,P])
    # RT3_L2P_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth2[Zn2,Sp1]> 0 then  (N_T1Upt2[Zn2,P]/RT3_LrvDepth2[Zn2,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt2[Zn2,P]+N_T3Upt2[Zn2,P])
    # RT3_L2P_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth2[Zn2,Sp2]> 0 then  (N_T2Upt2[Zn2,P]/RT3_LrvDepth2[Zn2,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt2[Zn2,P]+N_T3Upt2[Zn2,P])
    # RT3_L2P_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth2[Zn2,Sp3]> 0 then  (N_T3Upt2[Zn2,P]/RT3_LrvDepth2[Zn2,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt2[Zn2,P]+N_T2Upt2[Zn2,P])
    # RT3_L2P_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth2[Zn3,Sp1]> 0 then  (N_T1Upt2[Zn3,P]/RT3_LrvDepth2[Zn3,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt2[Zn3,P]+N_T3Upt2[Zn3,P])
    # RT3_L2P_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth2[Zn3,Sp2]> 0 then  (N_T2Upt2[Zn3,P]/RT3_LrvDepth2[Zn3,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt2[Zn3,P]+N_T3Upt2[Zn3,P])
    # RT3_L2P_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth2[Zn3,Sp3]> 0 then  (N_T3Upt2[Zn3,P]/RT3_LrvDepth2[Zn3,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt2[Zn3,P]+N_T2Upt2[Zn3,P])
    # RT3_L2P_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth2[Zn4,Sp1]> 0 then  (N_T1Upt2[Zn4,P]/RT3_LrvDepth2[Zn4,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt2[Zn4,P]+N_T3Upt2[Zn4,P])
    # RT3_L2P_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth2[Zn4,Sp2]> 0 then  (N_T2Upt2[Zn4,P]/RT3_LrvDepth2[Zn4,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt2[Zn4,P]+N_T3Upt2[Zn4,P])
    # RT3_L2P_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth2[Zn4,Sp3]> 0 then  (N_T3Upt2[Zn4,P]/RT3_LrvDepth2[Zn4,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt2[Zn4,P]+N_T2Upt2[Zn4,P])
    #
    #
    # RT3_L3N_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth3[Zn1,Sp1]> 0 then  (N_T1Upt3[Zn1,N]/RT3_LrvDepth3[Zn1,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt3[Zn1,N]+N_T3Upt3[Zn1,N])
    # RT3_L3N_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth3[Zn1,Sp2]> 0 then  (N_T2Upt3[Zn1,N]/RT3_LrvDepth3[Zn1,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt3[Zn1,N]+N_T3Upt3[Zn1,N])
    # RT3_L3N_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth3[Zn1,Sp3]> 0 then  (N_T3Upt3[Zn1,N]/RT3_LrvDepth3[Zn1,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt3[Zn1,N]+N_T2Upt3[Zn1,N])
    # RT3_L3N_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth3[Zn2,Sp1]> 0 then  (N_T1Upt3[Zn2,N]/RT3_LrvDepth3[Zn2,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt3[Zn2,N]+N_T3Upt3[Zn2,N])
    # RT3_L3N_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth3[Zn2,Sp2]> 0 then  (N_T2Upt3[Zn2,N]/RT3_LrvDepth3[Zn2,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt3[Zn2,N]+N_T3Upt3[Zn2,N])
    # RT3_L3N_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth3[Zn2,Sp3]> 0 then  (N_T3Upt3[Zn2,N]/RT3_LrvDepth3[Zn2,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt3[Zn2,N]+N_T2Upt3[Zn2,N])
    # RT3_L3N_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth3[Zn3,Sp1]> 0 then  (N_T1Upt3[Zn3,N]/RT3_LrvDepth3[Zn3,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt3[Zn3,N]+N_T3Upt3[Zn3,N])
    # RT3_L3N_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth3[Zn3,Sp2]> 0 then  (N_T2Upt3[Zn3,N]/RT3_LrvDepth3[Zn3,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt3[Zn3,N]+N_T3Upt3[Zn3,N])
    # RT3_L3N_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth3[Zn3,Sp3]> 0 then  (N_T3Upt3[Zn3,N]/RT3_LrvDepth3[Zn3,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt3[Zn3,N]+N_T2Upt3[Zn3,N])
    # RT3_L3N_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth3[Zn4,Sp1]> 0 then  (N_T1Upt3[Zn4,N]/RT3_LrvDepth3[Zn4,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt3[Zn4,N]+N_T3Upt3[Zn4,N])
    # RT3_L3N_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth3[Zn4,Sp2]> 0 then  (N_T2Upt3[Zn4,N]/RT3_LrvDepth3[Zn4,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt3[Zn4,N]+N_T3Upt3[Zn4,N])
    # RT3_L3N_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth3[Zn4,Sp3]> 0 then  (N_T3Upt3[Zn4,N]/RT3_LrvDepth3[Zn4,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt3[Zn4,N]+N_T2Upt3[Zn4,N])
    #
    # RT3_L3P_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth3[Zn1,Sp1]> 0 then  (N_T1Upt3[Zn1,P]/RT3_LrvDepth3[Zn1,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt3[Zn1,P]+N_T3Upt3[Zn1,P])
    # RT3_L3P_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth3[Zn1,Sp2]> 0 then  (N_T2Upt3[Zn1,P]/RT3_LrvDepth3[Zn1,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt3[Zn1,P]+N_T3Upt3[Zn1,P])
    # RT3_L3P_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth3[Zn1,Sp3]> 0 then  (N_T3Upt3[Zn1,P]/RT3_LrvDepth3[Zn1,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt3[Zn1,P]+N_T2Upt3[Zn1,P])
    # RT3_L3P_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth3[Zn2,Sp1]> 0 then  (N_T1Upt3[Zn2,P]/RT3_LrvDepth3[Zn2,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt3[Zn2,P]+N_T3Upt3[Zn2,P])
    # RT3_L3P_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth3[Zn2,Sp2]> 0 then  (N_T2Upt3[Zn2,P]/RT3_LrvDepth3[Zn2,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt3[Zn2,P]+N_T3Upt3[Zn2,P])
    # RT3_L3P_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth3[Zn2,Sp3]> 0 then  (N_T3Upt3[Zn2,P]/RT3_LrvDepth3[Zn2,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt3[Zn2,P]+N_T2Upt3[Zn2,P])
    # RT3_L3P_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth3[Zn3,Sp1]> 0 then  (N_T1Upt3[Zn3,P]/RT3_LrvDepth3[Zn3,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt3[Zn3,P]+N_T3Upt3[Zn3,P])
    # RT3_L3P_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth3[Zn3,Sp2]> 0 then  (N_T2Upt3[Zn3,P]/RT3_LrvDepth3[Zn3,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt3[Zn3,P]+N_T3Upt3[Zn3,P])
    # RT3_L3P_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth3[Zn3,Sp3]> 0 then  (N_T3Upt3[Zn3,P]/RT3_LrvDepth3[Zn3,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt3[Zn3,P]+N_T2Upt3[Zn3,P])
    # RT3_L3P_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth3[Zn4,Sp1]> 0 then  (N_T1Upt3[Zn4,P]/RT3_LrvDepth3[Zn4,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt3[Zn4,P]+N_T3Upt3[Zn4,P])
    # RT3_L3P_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth3[Zn4,Sp2]> 0 then  (N_T2Upt3[Zn4,P]/RT3_LrvDepth3[Zn4,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt3[Zn4,P]+N_T3Upt3[Zn4,P])
    # RT3_L3P_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth3[Zn4,Sp3]> 0 then  (N_T3Upt3[Zn4,P]/RT3_LrvDepth3[Zn4,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt3[Zn4,P]+N_T2Upt3[Zn4,P])
    #
    #
    # RT3_L4N_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth4[Zn1,Sp1]> 0 then  (N_T1Upt4[Zn1,N]/RT3_LrvDepth4[Zn1,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt4[Zn1,N]+N_T3Upt4[Zn1,N])
    # RT3_L4N_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth4[Zn1,Sp2]> 0 then  (N_T2Upt4[Zn1,N]/RT3_LrvDepth4[Zn1,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt4[Zn1,N]+N_T3Upt4[Zn1,N])
    # RT3_L4N_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth4[Zn1,Sp3]> 0 then  (N_T3Upt4[Zn1,N]/RT3_LrvDepth4[Zn1,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt4[Zn1,N]+N_T2Upt4[Zn1,N])
    # RT3_L4N_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth4[Zn2,Sp1]> 0 then  (N_T1Upt4[Zn2,N]/RT3_LrvDepth4[Zn2,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt4[Zn2,N]+N_T3Upt4[Zn2,N])
    # RT3_L4N_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth4[Zn2,Sp2]> 0 then  (N_T2Upt4[Zn2,N]/RT3_LrvDepth4[Zn2,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt4[Zn2,N]+N_T3Upt4[Zn2,N])
    # RT3_L4N_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth4[Zn2,Sp3]> 0 then  (N_T3Upt4[Zn2,N]/RT3_LrvDepth4[Zn2,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt4[Zn2,N]+N_T2Upt4[Zn2,N])
    # RT3_L4N_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth4[Zn3,Sp1]> 0 then  (N_T1Upt4[Zn3,N]/RT3_LrvDepth4[Zn3,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt4[Zn3,N]+N_T3Upt4[Zn3,N])
    # RT3_L4N_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth4[Zn3,Sp2]> 0 then  (N_T2Upt4[Zn3,N]/RT3_LrvDepth4[Zn3,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt4[Zn3,N]+N_T3Upt4[Zn3,N])
    # RT3_L4N_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth4[Zn3,Sp3]> 0 then  (N_T3Upt4[Zn3,N]/RT3_LrvDepth4[Zn3,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt4[Zn3,N]+N_T2Upt4[Zn3,N])
    # RT3_L4N_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[N,Sp1] > 0 and RT3_LrvDepth4[Zn4,Sp1]> 0 then  (N_T1Upt4[Zn4,N]/RT3_LrvDepth4[Zn4,Sp1])/RT3_AvgNutUptperRoot[N,Sp1] else 0*(N_T2Upt4[Zn4,N]+N_T3Upt4[Zn4,N])
    # RT3_L4N_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[N,Sp2] > 0 and RT3_LrvDepth4[Zn4,Sp2]> 0 then  (N_T2Upt4[Zn4,N]/RT3_LrvDepth4[Zn4,Sp2])/RT3_AvgNutUptperRoot[N,Sp2] else 0*(N_T1Upt4[Zn4,N]+N_T3Upt4[Zn4,N])
    # RT3_L4N_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[N,Sp3] > 0 and RT3_LrvDepth4[Zn4,Sp3]> 0 then  (N_T3Upt4[Zn4,N]/RT3_LrvDepth4[Zn4,Sp3])/RT3_AvgNutUptperRoot[N,Sp3] else 0*(N_T1Upt4[Zn4,N]+N_T2Upt4[Zn4,N])
    #
    # RT3_L4P_RelUptperLrv[Zn1,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth4[Zn1,Sp1]> 0 then  (N_T1Upt4[Zn1,P]/RT3_LrvDepth4[Zn1,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt4[Zn1,P]+N_T3Upt4[Zn1,P])
    # RT3_L4P_RelUptperLrv[Zn1,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth4[Zn1,Sp2]> 0 then  (N_T2Upt4[Zn1,P]/RT3_LrvDepth4[Zn1,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt4[Zn1,P]+N_T3Upt4[Zn1,P])
    # RT3_L4P_RelUptperLrv[Zn1,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth4[Zn1,Sp3]> 0 then  (N_T3Upt4[Zn1,P]/RT3_LrvDepth4[Zn1,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt4[Zn1,P]+N_T2Upt4[Zn1,P])
    # RT3_L4P_RelUptperLrv[Zn2,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth4[Zn2,Sp1]> 0 then  (N_T1Upt4[Zn2,P]/RT3_LrvDepth4[Zn2,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt4[Zn2,P]+N_T3Upt4[Zn2,P])
    # RT3_L4P_RelUptperLrv[Zn2,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth4[Zn2,Sp2]> 0 then  (N_T2Upt4[Zn2,P]/RT3_LrvDepth4[Zn2,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt4[Zn2,P]+N_T3Upt4[Zn2,P])
    # RT3_L4P_RelUptperLrv[Zn2,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth4[Zn2,Sp3]> 0 then  (N_T3Upt4[Zn2,P]/RT3_LrvDepth4[Zn2,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt4[Zn2,P]+N_T2Upt4[Zn2,P])
    # RT3_L4P_RelUptperLrv[Zn3,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth4[Zn3,Sp1]> 0 then  (N_T1Upt4[Zn3,P]/RT3_LrvDepth4[Zn3,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt4[Zn3,P]+N_T3Upt4[Zn3,P])
    # RT3_L4P_RelUptperLrv[Zn3,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth4[Zn3,Sp2]> 0 then  (N_T2Upt4[Zn3,P]/RT3_LrvDepth4[Zn3,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt4[Zn3,P]+N_T3Upt4[Zn3,P])
    # RT3_L4P_RelUptperLrv[Zn3,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth4[Zn3,Sp3]> 0 then  (N_T3Upt4[Zn3,P]/RT3_LrvDepth4[Zn3,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt4[Zn3,P]+N_T2Upt4[Zn3,P])
    # RT3_L4P_RelUptperLrv[Zn4,Sp1] = if  RT3_AvgNutUptperRoot[P,Sp1] > 0 and RT3_LrvDepth4[Zn4,Sp1]> 0 then  (N_T1Upt4[Zn4,P]/RT3_LrvDepth4[Zn4,Sp1])/RT3_AvgNutUptperRoot[P,Sp1] else 0*(N_T2Upt4[Zn4,P]+N_T3Upt4[Zn4,P])
    # RT3_L4P_RelUptperLrv[Zn4,Sp2] = if  RT3_AvgNutUptperRoot[P,Sp2] > 0 and RT3_LrvDepth4[Zn4,Sp2]> 0 then  (N_T2Upt4[Zn4,P]/RT3_LrvDepth4[Zn4,Sp2])/RT3_AvgNutUptperRoot[P,Sp2] else 0*(N_T1Upt4[Zn4,P]+N_T3Upt4[Zn4,P])
    # RT3_L4P_RelUptperLrv[Zn4,Sp3] = if  RT3_AvgNutUptperRoot[P,Sp3] > 0 and RT3_LrvDepth4[Zn4,Sp3]> 0 then  (N_T3Upt4[Zn4,P]/RT3_LrvDepth4[Zn4,Sp3])/RT3_AvgNutUptperRoot[P,Sp3] else 0*(N_T1Upt4[Zn4,P]+N_T2Upt4[Zn4,P])
    
    zonelayertreenut_df$RT3_AvgNutUptperRoot <- rep(treenut_df$RT3_AvgNutUptperRoot, each = nzone *
                                                      nlayer)
    zonelayertreenut_df$RT3_LrvDepth <- rep(zonelayertree_df$RT3_LrvDepth, nrow(nut_df))
    
    zonelayertreenut_df$RT3_RelUptperLrv <- ifelse(
      zonelayertreenut_df$RT3_AvgNutUptperRoot > 0 &
        zonelayertreenut_df$RT3_LrvDepth > 0,
      (
        zonelayertreenut_df$N_Upt /
          zonelayertreenut_df$RT3_LrvDepth
      ) / zonelayertreenut_df$RT3_AvgNutUptperRoot,
      0
    )
    
    # RT3_L1RelUptperLrv[Zone,Tree] = if RT3_CurrentStress[Tree] = 1 then RT3_L1W_RelUptperLrv[Zone,Tree] else if RT3_CurrentStress[Tree] = 2 then RT3_L1N_RelUptperLrv[Zone,Tree] else RT3_L1P_RelUptperLrv[Zone,Tree]
    # RT3_L2RelUptperLrv[Zone,Tree] = if RT3_CurrentStress[Tree] = 1 then RT3_L2W_RelUptperLrv[Zone,Tree] else if RT3_CurrentStress[Tree] = 2 then RT3_L2N_RelUptperLrv[Zone,Tree] else RT3_L2P_RelUptperLrv[Zone,Tree]
    # RT3_L3RelUptperLrv[Zone,Tree] = if RT3_CurrentStress[Tree] = 1 then RT3_L3W_RelUptperLrv[Zone,Tree] else if RT3_CurrentStress[Tree] = 2 then RT3_L3N_RelUptperLrv[Zone,Tree] else RT3_L3P_RelUptperLrv[Zone,Tree]
    # RT3_L4RelUptperLrv[Zone,Tree] = if RT3_CurrentStress[Tree] = 1 then RT3_L4W_RelUptperLrv[Zone,Tree] else if RT3_CurrentStress[Tree] = 2 then RT3_L4N_RelUptperLrv[Zone,Tree] else RT3_L4P_RelUptperLrv[Zone,Tree]
    zonelayertree_df$RT3_CurrentStress <- rep(tree_df$RT3_CurrentStress, each = nzone * nlayer)
    zonelayertree_df$RT3_LRelUptperLrv <- ifelse(
      zonelayertree_df$RT3_CurrentStress == 1,
      zonelayertree_df$RT3_LW_RelUptperLrv,
      ifelse(
        zonelayertree_df$RT3_CurrentStress == 2,
        zonelayertreenut_df[zonelayertreenut_df$SlNut == "N", ]$RT3_RelUptperLrv,
        zonelayertreenut_df[zonelayertreenut_df$SlNut == "P", ]$RT3_RelUptperLrv
      )
    )
    
    # RT3_RelUptWL1[Tree,Zone] = RT3_VoxVol[Zone,1]*RT3_L1RelUptperLrv[Zone,Tree]
    # RT3_RelUptWL2[Tree,Zone] = RT3_VoxVol[Zone,2]*RT3_L2RelUptperLrv[Zone,Tree]
    # RT3_RelUptWL3[Tree,Zone] = RT3_VoxVol[Zone,3]*RT3_L3RelUptperLrv[Zone,Tree]
    # RT3_RelUptWL4[Tree,Zone] = RT3_VoxVol[Zone,4]*RT3_L4RelUptperLrv[Zone,Tree]
    zonelayertree_df$RT3_RelUptWL <- zonelayertree_df$RT3_VoxVol * zonelayertree_df$RT3_LRelUptperLrv
    
    # RT3_RelUptTot[Tree] = ARRAYSUM(RT3_RelUptWL1[Tree,*])+ARRAYSUM(RT3_RelUptWL2[Tree,*])+ARRAYSUM(RT3_RelUptWL3[Tree,*])+ARRAYSUM(RT3_RelUptWL4[Tree,*])
    tree_df$RT3_RelUptTot <- aggregate(zonelayertree_df["RT3_RelUptWL"], zonelayertree_df["tree_id"], sum)$RT3_RelUptWL
    
    # RT3_FRAlloc1[Zone,Tree] = if RT3_RelUptTot[Tree]>0 then ((RT3_L1RelUptperLrv[Zone,Tree]/RT3_RelUptTot[Tree])^(1-RT3_PowerAllocRtL))*RT_L1FRLength[Zone,Tree]^RT3_PowerAllocRtL else 0
    # RT3_FRAlloc2[Zone,Tree] = if RT3_RelUptTot[Tree]>0 then ((RT3_L2RelUptperLrv[Zone,Tree]/RT3_RelUptTot[Tree])^(1-RT3_PowerAllocRtL))*RT_L2FRLength[Zone,Tree]^RT3_PowerAllocRtL else 0
    # RT3_FRAlloc3[Zone,Tree] = if RT3_RelUptTot[Tree]>0 then ((RT3_L3RelUptperLrv[Zone,Tree]/RT3_RelUptTot[Tree])^(1-RT3_PowerAllocRtL))*RT_L3FRLength[Zone,Tree]^RT3_PowerAllocRtL else 0
    # RT3_FRAlloc4[Zone,Tree] = if RT3_RelUptTot[Tree]>0 then ((RT3_L4RelUptperLrv[Zone,Tree]/RT3_RelUptTot[Tree])^(1-RT3_PowerAllocRtL))*RT_L4FRLength[Zone,Tree]^RT3_PowerAllocRtL else 0
    zonelayertree_df$RT3_RelUptTot <- rep(tree_df$RT3_RelUptTot, each = nzone *
                                            nlayer)
    zonelayertree_df$RT3_FRAlloc <- ifelse(
      zonelayertree_df$RT3_RelUptTot > 0,
      ((
        zonelayertree_df$RT3_LRelUptperLrv / zonelayertree_df$RT3_RelUptTot
      )^(1 - RT3_PowerAllocRtL)
      ) *
        zonelayertree_df$RT_FRLength^RT3_PowerAllocRtL,
      0
    )
    
    # RT3_RtAllocTot[Tree] = ARRAYSUM(RT3_FRAlloc1[*,Tree])+ARRAYSUM(RT3_FRAlloc2[*,Tree])+ARRAYSUM(RT3_FRAlloc3[*,Tree]) +ARRAYSUM(RT3_FRAlloc4[*,Tree])
    tree_df$RT3_RtAllocTot <- aggregate(zonelayertree_df["RT3_FRAlloc"], zonelayertree_df["tree_id"], sum)$RT3_FRAlloc
    
    # RT3_L1RtExp?[Zone,Tree] = if Rt3_LRV1[Zone,Tree]>RT3_AlphaLrv[Tree] then 1 else 0
    # RT3_L2RtExp?[Zone,Tree] = if Rt3_LRV2[Zone,Tree]>RT3_AlphaLrv[Tree] then 1 else 0
    # RT3_L3RtExp?[Zone,Tree] = if Rt3_LRV3[Zone,Tree]>RT3_AlphaLrv[Tree] then 1 else 0
    # RT3_L4RtExp?[Zone,Tree] = if Rt3_LRV4[Zone,Tree]>RT3_AlphaLrv[Tree] then 1 else 0
    zonelayertree_df$RT3_AlphaLrv <- rep(tree_df$RT3_AlphaLrv, each = nzone *
                                           nlayer)
    zonelayertree_df$RT3_RtExp_is <- ifelse(zonelayertree_df$Rt3_LRV > zonelayertree_df$RT3_AlphaLrv,
                                            1,
                                            0)
    
    # RT3_DepthWidthRatio1[Zone] = if AF_ZoneWidth[Zone] = 0 then 1 else AF_DepthAct1[Zone]/AF_ZoneWidth[Zone]
    # RT3_DepthWidthRatio2[Zone] = if AF_ZoneWidth[Zone] = 0 then 1 else AF_Depth2[Zone]/AF_ZoneWidth[Zone]
    # RT3_DepthWidthRatio3[Zone] = if AF_ZoneWidth[Zone] = 0 then 1 else AF_Depth3[Zone]/AF_ZoneWidth[Zone]
    # RT3_DepthWidthRatio4[Zone] = if AF_ZoneWidth[Zone] = 0 then 1 else AF_Depth4[Zone]/AF_ZoneWidth[Zone]
    zonelayer_df$RT3_DepthWidthRatio <- ifelse(
      zonelayer_df$AF_ZoneWidth == 0,
      1,
      zonelayer_df$AF_Depth / zonelayer_df$AF_ZoneWidth
    )
    
    # RT3_Beta1[Zone,Tree] = 1-((1-RT3_Beta0[Tree])/(100*RT3_DepthWidthRatio1[Zone]*AF_ZoneWidth[Zone]))*(1-RT3_LamHor0[Tree] *(1-RT3_DepthWidthRatio1[Zone]))
    # RT3_Beta2[Zone,Tree] = 1-((1-RT3_Beta0[Tree])/(100*RT3_DepthWidthRatio2[Zone]*AF_ZoneWidth[Zone]))*(1-RT3_LamHor0[Tree] *(1-RT3_DepthWidthRatio2[Zone]))
    # RT3_Beta3[Zone,Tree] = 1-((1-RT3_Beta0[Tree])/(100*RT3_DepthWidthRatio3[Zone]*AF_ZoneWidth[Zone]))*(1-RT3_LamHor0[Tree] *(1-RT3_DepthWidthRatio3[Zone]))
    # RT3_Beta4[Zone,Tree] = 1-((1-RT3_Beta0[Tree])/(100*RT3_DepthWidthRatio4[Zone]*AF_ZoneWidth[Zone]))*(1-RT3_LamHor0[Tree] *(1-RT3_DepthWidthRatio4[Zone]))
    zonelayertree_df$RT3_Beta0 <- rep(tree_df$RT3_Beta0, each = nzone *
                                        nlayer)
    zonelayertree_df$RT3_DepthWidthRatio <- rep(zonelayer_df$RT3_DepthWidthRatio, ntree)
    zonelayertree_df$RT3_LamHor0 <- rep(tree_df$RT3_LamHor0, each = nzone *
                                          nlayer)
    zonelayertree_df$RT3_Beta <- 1 - ((1 - zonelayertree_df$RT3_Beta0) /
                                        (
                                          100 * zonelayertree_df$RT3_DepthWidthRatio * zonelayertree_df$AF_ZoneWidth
                                        )
    ) * (1 - zonelayertree_df$RT3_LamHor0 * (1 - zonelayertree_df$RT3_DepthWidthRatio))
    
    # RT3_LamHor1[Zone,Tree] = RT3_LamHor0[Tree]*(RT3_DepthWidthRatio1[Zone])/(1-RT3_LamHor0[Tree]*(1-RT3_DepthWidthRatio1[Zone]))
    # RT3_LamHor2[Zone,Tree] = RT3_LamHor0[Tree]*(RT3_DepthWidthRatio2[Zone])/(1-RT3_LamHor0[Tree]*(1-RT3_DepthWidthRatio2[Zone]))
    # RT3_LamHor3[Zone,Tree] = RT3_LamHor0[Tree]*(RT3_DepthWidthRatio3[Zone])/(1-RT3_LamHor0[Tree]*(1-RT3_DepthWidthRatio3[Zone]))
    # RT3_LamHor4[Zone,Tree] = RT3_LamHor0[Tree]*(RT3_DepthWidthRatio4[Zone])/(1-RT3_LamHor0[Tree]*(1-RT3_DepthWidthRatio4[Zone]))
    zonelayertree_df$RT3_LamHor <- zonelayertree_df$RT3_LamHor0 * zonelayertree_df$RT3_DepthWidthRatio /
      (1 - zonelayertree_df$RT3_LamHor0 * (1 - zonelayertree_df$RT3_DepthWidthRatio))
    
    # RT3_Alloc1Down[Zone,Tree] = RT3_L1RtExp?[Zone,Tree]*(1-RT3_Beta1[Zone,Tree])*(1-RT3_LamHor1[Zone,Tree])*(RT3_LamGeotrop[Tree])
    # RT3_Alloc2Down[Zone,Tree] = RT3_L2RtExp?[Zone,Tree]*(1-RT3_Beta2[Zone,Tree])*(1-RT3_LamHor2[Zone,Tree])*(RT3_LamGeotrop[Tree])
    # RT3_Alloc3Down[Zone,Tree] = RT3_L3RtExp?[Zone,Tree]*(1-RT3_Beta3[Zone,Tree])*(1-RT3_LamHor3[Zone,Tree])*(RT3_LamGeotrop[Tree])
    zonelayertree_df$RT3_LamGeotrop <- rep(tree_df$RT3_LamGeotrop, each = nzone *
                                             nlayer)
    zonelayertree_df$RT3_AllocDown <- zonelayertree_df$RT3_RtExp_is *
      (1 - zonelayertree_df$RT3_Beta) * (1 - zonelayertree_df$RT3_LamHor) * zonelayertree_df$RT3_LamGeotrop
    
    # RT3_Alloc2Upw[Zone,Tree] = RT3_L2RtExp?[Zone,Tree]*(1-RT3_Beta2[Zone,Tree])*(1-RT3_LamHor2[Zone,Tree])*(1-RT3_LamGeotrop[Tree])
    # RT3_Alloc3Upw[Zone,Tree] = RT3_L3RtExp?[Zone,Tree]*(1-RT3_Beta3[Zone,Tree])*(1-RT3_LamHor3[Zone,Tree])*(1-RT3_LamGeotrop[Tree])
    # RT3_Alloc4Upw[Zone,Tree] = RT3_L4RtExp?[Zone,Tree]*(1-RT3_Beta4[Zone,Tree])*(1-RT3_LamHor4[Zone,Tree])*(1-RT3_LamGeotrop[Tree])
    zonelayertree_df$RT3_AllocUpw <- zonelayertree_df$RT3_RtExp_is * (1 -
                                                                        zonelayertree_df$RT3_Beta) * (1 - zonelayertree_df$RT3_LamHor) * (1 - zonelayertree_df$RT3_LamGeotrop)
    zonelayertree_df[zonelayertree_df$layer == 1, "RT3_AllocUpw"] <- 0
    
    # RT3_Alloc1Within[Zone,Tree] = 1-RT3_Alloc1Down[Zone,Tree]
    # RT3_Alloc2Within[Zone,Tree] = 1-RT3_Alloc2Down[Zone,Tree]-RT3_Alloc2Upw[Zone,Tree]
    # RT3_Alloc3Within[Zone,Tree] = 1-RT3_Alloc3Down[Zone,Tree]-RT3_Alloc3Upw[Zone,Tree]
    # RT3_Alloc4Within[Zn1,Sp1] = 1-RT3_Alloc4Upw[Zn1,Sp1]
    # RT3_Alloc4Within[Zn1,Sp2] = 1-RT3_Alloc4Upw[Zn1,Sp2]
    # RT3_Alloc4Within[Zn1,Sp3] = 1-RT3_Alloc4Upw[Zn1,Sp3]
    # RT3_Alloc4Within[Zn2,Sp1] = 1-RT3_Alloc4Upw[Zn2,Sp1]
    # RT3_Alloc4Within[Zn2,Sp2] = 1-RT3_Alloc4Upw[Zn2,Sp2]
    # RT3_Alloc4Within[Zn2,Sp3] = 1-RT3_Alloc4Upw[Zn2,Sp3]
    # RT3_Alloc4Within[Zn3,Sp1] = 1-RT3_Alloc4Upw[Zn3,Sp1]
    # RT3_Alloc4Within[Zn3,Sp2] = 1-RT3_Alloc4Upw[Zn3,Sp2]
    # RT3_Alloc4Within[Zn3,Sp3] = 1-RT3_Alloc4Upw[Zn3,Sp3]
    # RT3_Alloc4Within[Zn4,Sp1] = 1-RT3_Alloc4Upw[Zn4,Sp1]
    # RT3_Alloc4Within[Zn4,Sp2] = 1-RT3_Alloc4Upw[Zn4,Sp2]
    # RT3_Alloc4Within[Zn4,Sp3] = 1-RT3_Alloc4Upw[Zn4,Sp3]
    zonelayertree_df$RT3_AllocWithin <- 1 - zonelayertree_df$RT3_AllocDown - zonelayertree_df$RT3_AllocUpw
    zonelayertree_df[zonelayertree_df$layer == 4, "RT3_AllocWithin"] <- 1 - zonelayertree_df[zonelayertree_df$layer == 4, "RT3_AllocUpw"]
    
    # T_RootInc[PlantComp,Tree] = If RT_ATType[Tree] = 2 then IF T_GrowsToday?[Tree] = 0 then 0 else (T_RtConc[PlantComp,Tree]*T_RtAllocAct[Tree]*T_UnitConv[PlantComp]*T_CanBiomInc[PlantComp,Tree]/((1-T_RtAllocAct[Tree]))) else 0
    treepcomp_df$RT_ATType <- rep(tree_df$RT_ATType, nrow(pcomp_df))
    treepcomp_df$T_RootInc <- ifelse(
      treepcomp_df$RT_ATType == 2,
      ifelse(
        treepcomp_df$T_GrowsToday_is == 0,
        0,
        treepcomp_df$T_RtConc * treepcomp_df$T_RtAllocAct * treepcomp_df$T_UnitConv * treepcomp_df$T_CanBiomInc /
          ((1 - treepcomp_df$T_RtAllocAct))
      ),
      0
    )
    
    
    # RT3_CRincr[Tree] = min(T_RootInc[DW,Tree],max(0,RT3_CRTarget[Tree]-RT3_CoarseRt[Tree]))
    tree_df$RT3_CRincr <- pmin(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_RootInc"],
                               pmax(0, tree_df$RT3_CRTarget - tree_df$RT3_CoarseRt))
    
    # RT3_FineRootInc[Tree] = max(0,T_RootInc[DW,Tree]-RT3_CRincr[Tree])*T_SRLfineroots[Tree]
    tree_df$RT3_FineRootInc <- pmax(0, treepcomp_df[treepcomp_df$PlantComp == "DW", "T_RootInc"] - tree_df$RT3_CRincr) *
      tree_df$T_SRLfineroots
    
    # RT3_VoxHorExp1[Zone,Tree] = RT3_L1RtExp?[Zone,Tree]*(1-RT3_Beta1[Zone,Tree])*RT3_LamHor1[Zone,Tree]
    # RT3_VoxHorExp2[Zone,Tree] = RT3_L2RtExp?[Zone,Tree]*(1-RT3_Beta2[Zone,Tree])*RT3_LamHor2[Zone,Tree]
    # RT3_VoxHorExp3[Zone,Tree] = RT3_L3RtExp?[Zone,Tree]*(1-RT3_Beta3[Zone,Tree])*RT3_LamHor3[Zone,Tree]
    # RT3_VoxHorExp4[Zone,Tree] = RT3_L4RtExp?[Zone,Tree]*(1-RT3_Beta4[Zone,Tree])*RT3_LamHor4[Zone,Tree]
    zonelayertree_df$RT3_VoxHorExp <- zonelayertree_df$RT3_RtExp_is *
      (1 - zonelayertree_df$RT3_Beta) * zonelayertree_df$RT3_LamHor
    
    # RT3_L1FRtGr[Zn1,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(                                                RT3_FRAlloc1[Zn1,Sp1]*RT3_Alloc1Within[Zn1,Sp1]*(1-RT3_VoxHorExp1[Zn1,Sp1]/2)+  RT3_FRAlloc1[Zn2,Sp1]*RT3_Alloc1Within[Zn2,Sp1]*(RT3_VoxHorExp1[Zn2,Sp1]/2)+                                                                                RT3_FRAlloc2[Zn1,Sp1]*RT3_Alloc2Upw[Zn1,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L1FRtGr[Zn1,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(                                                RT3_FRAlloc1[Zn1,Sp2]*RT3_Alloc1Within[Zn1,Sp2]*(1-RT3_VoxHorExp1[Zn1,Sp2]/2)+  RT3_FRAlloc1[Zn2,Sp2]*RT3_Alloc1Within[Zn2,Sp2]*(RT3_VoxHorExp1[Zn2,Sp2]/2)+                                                                                RT3_FRAlloc2[Zn1,Sp2]*RT3_Alloc2Upw[Zn1,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L1FRtGr[Zn1,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(                                                RT3_FRAlloc1[Zn1,Sp3]*RT3_Alloc1Within[Zn1,Sp3]*(1-RT3_VoxHorExp1[Zn1,Sp3]/2)+  RT3_FRAlloc1[Zn2,Sp3]*RT3_Alloc1Within[Zn2,Sp3]*(RT3_VoxHorExp1[Zn2,Sp3]/2)+                                                                                RT3_FRAlloc2[Zn1,Sp3]*RT3_Alloc2Upw[Zn1,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L1FRtGr[Zn2,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(                                                RT3_FRAlloc1[Zn2,Sp1]*RT3_Alloc1Within[Zn2,Sp1]*(1-RT3_VoxHorExp1[Zn2,Sp1]  )+  RT3_FRAlloc1[Zn1,Sp1]*RT3_Alloc1Within[Zn1,Sp1]*(RT3_VoxHorExp1[Zn1,Sp1]/2)+  RT3_FRAlloc1[Zn3,Sp1]*RT3_Alloc1Within[Zn3,Sp1]*(RT3_VoxHorExp1[Zn3,Sp1]/2)+  RT3_FRAlloc2[Zn2,Sp1]*RT3_Alloc2Upw[Zn2,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L1FRtGr[Zn2,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(                                                RT3_FRAlloc1[Zn2,Sp2]*RT3_Alloc1Within[Zn2,Sp2]*(1-RT3_VoxHorExp1[Zn2,Sp2]  )+  RT3_FRAlloc1[Zn1,Sp2]*RT3_Alloc1Within[Zn1,Sp2]*(RT3_VoxHorExp1[Zn1,Sp2]/2)+  RT3_FRAlloc1[Zn3,Sp2]*RT3_Alloc1Within[Zn3,Sp2]*(RT3_VoxHorExp1[Zn3,Sp2]/2)+  RT3_FRAlloc2[Zn2,Sp2]*RT3_Alloc2Upw[Zn2,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L1FRtGr[Zn2,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(                                                RT3_FRAlloc1[Zn2,Sp3]*RT3_Alloc1Within[Zn2,Sp3]*(1-RT3_VoxHorExp1[Zn2,Sp3]  )+  RT3_FRAlloc1[Zn1,Sp3]*RT3_Alloc1Within[Zn1,Sp3]*(RT3_VoxHorExp1[Zn1,Sp3]/2)+  RT3_FRAlloc1[Zn3,Sp3]*RT3_Alloc1Within[Zn3,Sp3]*(RT3_VoxHorExp1[Zn3,Sp3]/2)+  RT3_FRAlloc2[Zn2,Sp3]*RT3_Alloc2Upw[Zn2,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L1FRtGr[Zn3,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(                                                RT3_FRAlloc1[Zn3,Sp1]*RT3_Alloc1Within[Zn3,Sp1]*(1-RT3_VoxHorExp1[Zn3,Sp1]  )+  RT3_FRAlloc1[Zn2,Sp1]*RT3_Alloc1Within[Zn2,Sp1]*(RT3_VoxHorExp1[Zn2,Sp1]/2)+  RT3_FRAlloc1[Zn4,Sp1]*RT3_Alloc1Within[Zn4,Sp1]*(RT3_VoxHorExp1[Zn4,Sp1]/2)+  RT3_FRAlloc2[Zn3,Sp1]*RT3_Alloc2Upw[Zn3,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L1FRtGr[Zn3,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(                                                RT3_FRAlloc1[Zn3,Sp2]*RT3_Alloc1Within[Zn3,Sp2]*(1-RT3_VoxHorExp1[Zn3,Sp2]  )+  RT3_FRAlloc1[Zn2,Sp2]*RT3_Alloc1Within[Zn2,Sp2]*(RT3_VoxHorExp1[Zn2,Sp2]/2)+  RT3_FRAlloc1[Zn4,Sp2]*RT3_Alloc1Within[Zn4,Sp2]*(RT3_VoxHorExp1[Zn4,Sp2]/2)+  RT3_FRAlloc2[Zn3,Sp2]*RT3_Alloc2Upw[Zn3,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L1FRtGr[Zn3,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(                                                RT3_FRAlloc1[Zn3,Sp3]*RT3_Alloc1Within[Zn3,Sp3]*(1-RT3_VoxHorExp1[Zn3,Sp3]  )+  RT3_FRAlloc1[Zn2,Sp3]*RT3_Alloc1Within[Zn2,Sp3]*(RT3_VoxHorExp1[Zn2,Sp3]/2)+  RT3_FRAlloc1[Zn4,Sp3]*RT3_Alloc1Within[Zn4,Sp3]*(RT3_VoxHorExp1[Zn4,Sp3]/2)+  RT3_FRAlloc2[Zn3,Sp3]*RT3_Alloc2Upw[Zn3,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L1FRtGr[Zn4,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(                                                RT3_FRAlloc1[Zn4,Sp1]*RT3_Alloc1Within[Zn4,Sp1]*(1-RT3_VoxHorExp1[Zn4,Sp1]/2)+  RT3_FRAlloc1[Zn3,Sp1]*RT3_Alloc1Within[Zn3,Sp1]*(RT3_VoxHorExp1[Zn3,Sp1]/2)+                                                                                RT3_FRAlloc2[Zn4,Sp1]*RT3_Alloc2Upw[Zn4,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L1FRtGr[Zn4,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(                                                RT3_FRAlloc1[Zn4,Sp2]*RT3_Alloc1Within[Zn4,Sp2]*(1-RT3_VoxHorExp1[Zn4,Sp2]/2)+  RT3_FRAlloc1[Zn3,Sp2]*RT3_Alloc1Within[Zn3,Sp2]*(RT3_VoxHorExp1[Zn3,Sp2]/2)+                                                                                RT3_FRAlloc2[Zn4,Sp2]*RT3_Alloc2Upw[Zn4,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L1FRtGr[Zn4,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(                                                RT3_FRAlloc1[Zn4,Sp3]*RT3_Alloc1Within[Zn4,Sp3]*(1-RT3_VoxHorExp1[Zn4,Sp3]/2)+  RT3_FRAlloc1[Zn3,Sp3]*RT3_Alloc1Within[Zn3,Sp3]*(RT3_VoxHorExp1[Zn3,Sp3]/2)+                                                                                RT3_FRAlloc2[Zn4,Sp3]*RT3_Alloc2Upw[Zn4,Sp3]))/RT3_RtAllocTot[Sp3]
    #
    # RT3_L2FRtGr[Zn1,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc1[Zn1,Sp1]*RT3_Alloc1Down[Zn1,Sp1]+  RT3_FRAlloc2[Zn1,Sp1]*RT3_Alloc2Within[Zn1,Sp1]*(1-RT3_VoxHorExp2[Zn1,Sp1]/2)+  RT3_FRAlloc2[Zn2,Sp1]*RT3_Alloc2Within[Zn2,Sp1]*(RT3_VoxHorExp2[Zn2,Sp1]/2)+                                                                                RT3_FRAlloc3[Zn1,Sp1]*RT3_Alloc3Upw[Zn1,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L2FRtGr[Zn1,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc1[Zn1,Sp2]*RT3_Alloc1Down[Zn1,Sp2]+  RT3_FRAlloc2[Zn1,Sp2]*RT3_Alloc2Within[Zn1,Sp2]*(1-RT3_VoxHorExp2[Zn1,Sp2]/2)+  RT3_FRAlloc2[Zn2,Sp2]*RT3_Alloc2Within[Zn2,Sp2]*(RT3_VoxHorExp2[Zn2,Sp2]/2)+                                                                                RT3_FRAlloc3[Zn1,Sp2]*RT3_Alloc3Upw[Zn1,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L2FRtGr[Zn1,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc1[Zn1,Sp3]*RT3_Alloc1Down[Zn1,Sp3]+  RT3_FRAlloc2[Zn1,Sp3]*RT3_Alloc2Within[Zn1,Sp3]*(1-RT3_VoxHorExp2[Zn1,Sp3]/2)+  RT3_FRAlloc2[Zn2,Sp3]*RT3_Alloc2Within[Zn2,Sp3]*(RT3_VoxHorExp2[Zn2,Sp3]/2)+                                                                                RT3_FRAlloc3[Zn1,Sp3]*RT3_Alloc3Upw[Zn1,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L2FRtGr[Zn2,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc1[Zn2,Sp1]*RT3_Alloc1Down[Zn2,Sp1]+  RT3_FRAlloc2[Zn2,Sp1]*RT3_Alloc2Within[Zn2,Sp1]*(1-RT3_VoxHorExp2[Zn2,Sp1]  )+  RT3_FRAlloc2[Zn1,Sp1]*RT3_Alloc2Within[Zn1,Sp1]*(RT3_VoxHorExp2[Zn1,Sp1]/2)+  RT3_FRAlloc2[Zn3,Sp1]*RT3_Alloc2Within[Zn3,Sp1]*(RT3_VoxHorExp2[Zn3,Sp1]/2)+  RT3_FRAlloc3[Zn2,Sp1]*RT3_Alloc3Upw[Zn2,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L2FRtGr[Zn2,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc1[Zn2,Sp2]*RT3_Alloc1Down[Zn2,Sp2]+  RT3_FRAlloc2[Zn2,Sp2]*RT3_Alloc2Within[Zn2,Sp2]*(1-RT3_VoxHorExp2[Zn2,Sp2]  )+  RT3_FRAlloc2[Zn1,Sp2]*RT3_Alloc2Within[Zn1,Sp2]*(RT3_VoxHorExp2[Zn1,Sp2]/2)+  RT3_FRAlloc2[Zn3,Sp2]*RT3_Alloc2Within[Zn3,Sp2]*(RT3_VoxHorExp2[Zn3,Sp2]/2)+  RT3_FRAlloc3[Zn2,Sp2]*RT3_Alloc3Upw[Zn2,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L2FRtGr[Zn2,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc1[Zn2,Sp3]*RT3_Alloc1Down[Zn2,Sp3]+  RT3_FRAlloc2[Zn2,Sp3]*RT3_Alloc2Within[Zn2,Sp3]*(1-RT3_VoxHorExp2[Zn2,Sp3]  )+  RT3_FRAlloc2[Zn1,Sp3]*RT3_Alloc2Within[Zn1,Sp3]*(RT3_VoxHorExp2[Zn1,Sp3]/2)+  RT3_FRAlloc2[Zn3,Sp3]*RT3_Alloc2Within[Zn3,Sp3]*(RT3_VoxHorExp2[Zn3,Sp3]/2)+  RT3_FRAlloc3[Zn2,Sp3]*RT3_Alloc3Upw[Zn2,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L2FRtGr[Zn3,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc1[Zn3,Sp1]*RT3_Alloc1Down[Zn3,Sp1]+  RT3_FRAlloc2[Zn3,Sp1]*RT3_Alloc2Within[Zn3,Sp1]*(1-RT3_VoxHorExp2[Zn3,Sp1]  )+  RT3_FRAlloc2[Zn2,Sp1]*RT3_Alloc2Within[Zn2,Sp1]*(RT3_VoxHorExp2[Zn2,Sp1]/2)+  RT3_FRAlloc2[Zn4,Sp1]*RT3_Alloc2Within[Zn4,Sp1]*(RT3_VoxHorExp2[Zn4,Sp1]/2)+  RT3_FRAlloc3[Zn3,Sp1]*RT3_Alloc3Upw[Zn3,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L2FRtGr[Zn3,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc1[Zn3,Sp2]*RT3_Alloc1Down[Zn3,Sp2]+  RT3_FRAlloc2[Zn3,Sp2]*RT3_Alloc2Within[Zn3,Sp2]*(1-RT3_VoxHorExp2[Zn3,Sp2]  )+  RT3_FRAlloc2[Zn2,Sp2]*RT3_Alloc2Within[Zn2,Sp2]*(RT3_VoxHorExp2[Zn2,Sp2]/2)+  RT3_FRAlloc2[Zn4,Sp2]*RT3_Alloc2Within[Zn4,Sp2]*(RT3_VoxHorExp2[Zn4,Sp2]/2)+  RT3_FRAlloc3[Zn3,Sp2]*RT3_Alloc3Upw[Zn3,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L2FRtGr[Zn3,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc1[Zn3,Sp3]*RT3_Alloc1Down[Zn3,Sp3]+  RT3_FRAlloc2[Zn3,Sp3]*RT3_Alloc2Within[Zn3,Sp3]*(1-RT3_VoxHorExp2[Zn3,Sp3]  )+  RT3_FRAlloc2[Zn2,Sp3]*RT3_Alloc2Within[Zn2,Sp3]*(RT3_VoxHorExp2[Zn2,Sp3]/2)+  RT3_FRAlloc2[Zn4,Sp3]*RT3_Alloc2Within[Zn4,Sp3]*(RT3_VoxHorExp2[Zn4,Sp3]/2)+  RT3_FRAlloc3[Zn3,Sp3]*RT3_Alloc3Upw[Zn3,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L2FRtGr[Zn4,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc1[Zn4,Sp1]*RT3_Alloc1Down[Zn4,Sp1]+  RT3_FRAlloc2[Zn4,Sp1]*RT3_Alloc2Within[Zn4,Sp1]*(1-RT3_VoxHorExp2[Zn4,Sp1]/2)+  RT3_FRAlloc2[Zn3,Sp1]*RT3_Alloc2Within[Zn3,Sp1]*(RT3_VoxHorExp2[Zn3,Sp1]/2)+                                                                                RT3_FRAlloc3[Zn4,Sp1]*RT3_Alloc3Upw[Zn4,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L2FRtGr[Zn4,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc1[Zn4,Sp2]*RT3_Alloc1Down[Zn4,Sp2]+  RT3_FRAlloc2[Zn4,Sp2]*RT3_Alloc2Within[Zn4,Sp2]*(1-RT3_VoxHorExp2[Zn4,Sp2]/2)+  RT3_FRAlloc2[Zn3,Sp2]*RT3_Alloc2Within[Zn3,Sp2]*(RT3_VoxHorExp2[Zn3,Sp2]/2)+                                                                                RT3_FRAlloc3[Zn4,Sp2]*RT3_Alloc3Upw[Zn4,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L2FRtGr[Zn4,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc1[Zn4,Sp3]*RT3_Alloc1Down[Zn4,Sp3]+  RT3_FRAlloc2[Zn4,Sp3]*RT3_Alloc2Within[Zn4,Sp3]*(1-RT3_VoxHorExp2[Zn4,Sp3]/2)+  RT3_FRAlloc2[Zn3,Sp3]*RT3_Alloc2Within[Zn3,Sp3]*(RT3_VoxHorExp2[Zn3,Sp3]/2)+                                                                                RT3_FRAlloc3[Zn4,Sp3]*RT3_Alloc3Upw[Zn4,Sp3]))/RT3_RtAllocTot[Sp3]
    #
    # RT3_L3FRtGr[Zn1,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc2[Zn1,Sp1]*RT3_Alloc2Down[Zn1,Sp1]+  RT3_FRAlloc3[Zn1,Sp1]*RT3_Alloc3Within[Zn1,Sp1]*(1-RT3_VoxHorExp3[Zn1,Sp1]/2)+  RT3_FRAlloc3[Zn2,Sp1]*RT3_Alloc3Within[Zn2,Sp1]*(RT3_VoxHorExp3[Zn2,Sp1]/2)+                                                                                RT3_FRAlloc4[Zn1,Sp1]*RT3_Alloc4Upw[Zn1,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L3FRtGr[Zn1,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc2[Zn1,Sp2]*RT3_Alloc2Down[Zn1,Sp2]+  RT3_FRAlloc3[Zn1,Sp2]*RT3_Alloc3Within[Zn1,Sp2]*(1-RT3_VoxHorExp3[Zn1,Sp2]/2)+  RT3_FRAlloc3[Zn2,Sp2]*RT3_Alloc3Within[Zn2,Sp2]*(RT3_VoxHorExp3[Zn2,Sp2]/2)+                                                                                RT3_FRAlloc4[Zn1,Sp2]*RT3_Alloc4Upw[Zn1,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L3FRtGr[Zn1,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc2[Zn1,Sp3]*RT3_Alloc2Down[Zn1,Sp3]+  RT3_FRAlloc3[Zn1,Sp3]*RT3_Alloc3Within[Zn1,Sp3]*(1-RT3_VoxHorExp3[Zn1,Sp3]/2)+  RT3_FRAlloc3[Zn2,Sp3]*RT3_Alloc3Within[Zn2,Sp3]*(RT3_VoxHorExp3[Zn2,Sp3]/2)+                                                                                RT3_FRAlloc4[Zn1,Sp3]*RT3_Alloc4Upw[Zn1,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L3FRtGr[Zn2,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc2[Zn2,Sp1]*RT3_Alloc2Down[Zn2,Sp1]+  RT3_FRAlloc3[Zn2,Sp1]*RT3_Alloc3Within[Zn2,Sp1]*(1-RT3_VoxHorExp3[Zn2,Sp1]  )+  RT3_FRAlloc3[Zn1,Sp1]*RT3_Alloc3Within[Zn1,Sp1]*(RT3_VoxHorExp3[Zn1,Sp1]/2)+  RT3_FRAlloc3[Zn3,Sp1]*RT3_Alloc3Within[Zn3,Sp1]*(RT3_VoxHorExp3[Zn3,Sp1]/2)+  RT3_FRAlloc4[Zn2,Sp1]*RT3_Alloc4Upw[Zn2,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L3FRtGr[Zn2,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc2[Zn2,Sp2]*RT3_Alloc2Down[Zn2,Sp2]+  RT3_FRAlloc3[Zn2,Sp2]*RT3_Alloc3Within[Zn2,Sp2]*(1-RT3_VoxHorExp3[Zn2,Sp2]  )+  RT3_FRAlloc3[Zn1,Sp2]*RT3_Alloc3Within[Zn1,Sp2]*(RT3_VoxHorExp3[Zn1,Sp2]/2)+  RT3_FRAlloc3[Zn3,Sp2]*RT3_Alloc3Within[Zn3,Sp2]*(RT3_VoxHorExp3[Zn3,Sp2]/2)+  RT3_FRAlloc4[Zn2,Sp2]*RT3_Alloc4Upw[Zn2,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L3FRtGr[Zn2,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc2[Zn2,Sp3]*RT3_Alloc2Down[Zn2,Sp3]+  RT3_FRAlloc3[Zn2,Sp3]*RT3_Alloc3Within[Zn2,Sp3]*(1-RT3_VoxHorExp3[Zn2,Sp3]  )+  RT3_FRAlloc3[Zn1,Sp3]*RT3_Alloc3Within[Zn1,Sp3]*(RT3_VoxHorExp3[Zn1,Sp3]/2)+  RT3_FRAlloc3[Zn3,Sp3]*RT3_Alloc3Within[Zn3,Sp3]*(RT3_VoxHorExp3[Zn3,Sp3]/2)+  RT3_FRAlloc4[Zn2,Sp3]*RT3_Alloc4Upw[Zn2,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L3FRtGr[Zn3,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc2[Zn3,Sp1]*RT3_Alloc2Down[Zn3,Sp1]+  RT3_FRAlloc3[Zn3,Sp1]*RT3_Alloc3Within[Zn3,Sp1]*(1-RT3_VoxHorExp3[Zn3,Sp1]  )+  RT3_FRAlloc3[Zn2,Sp1]*RT3_Alloc3Within[Zn2,Sp1]*(RT3_VoxHorExp3[Zn2,Sp1]/2)+  RT3_FRAlloc3[Zn4,Sp1]*RT3_Alloc3Within[Zn4,Sp1]*(RT3_VoxHorExp3[Zn4,Sp1]/2)+  RT3_FRAlloc4[Zn3,Sp1]*RT3_Alloc4Upw[Zn3,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L3FRtGr[Zn3,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc2[Zn3,Sp2]*RT3_Alloc2Down[Zn3,Sp2]+  RT3_FRAlloc3[Zn3,Sp2]*RT3_Alloc3Within[Zn3,Sp2]*(1-RT3_VoxHorExp3[Zn3,Sp2]  )+  RT3_FRAlloc3[Zn2,Sp2]*RT3_Alloc3Within[Zn2,Sp2]*(RT3_VoxHorExp3[Zn2,Sp2]/2)+  RT3_FRAlloc3[Zn4,Sp2]*RT3_Alloc3Within[Zn4,Sp2]*(RT3_VoxHorExp3[Zn4,Sp2]/2)+  RT3_FRAlloc4[Zn3,Sp2]*RT3_Alloc4Upw[Zn3,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L3FRtGr[Zn3,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc2[Zn3,Sp3]*RT3_Alloc2Down[Zn3,Sp3]+  RT3_FRAlloc3[Zn3,Sp3]*RT3_Alloc3Within[Zn3,Sp3]*(1-RT3_VoxHorExp3[Zn3,Sp3]  )+  RT3_FRAlloc3[Zn2,Sp3]*RT3_Alloc3Within[Zn2,Sp3]*(RT3_VoxHorExp3[Zn2,Sp3]/2)+  RT3_FRAlloc3[Zn4,Sp3]*RT3_Alloc3Within[Zn4,Sp3]*(RT3_VoxHorExp3[Zn4,Sp3]/2)+  RT3_FRAlloc4[Zn3,Sp3]*RT3_Alloc4Upw[Zn3,Sp3]))/RT3_RtAllocTot[Sp3]
    # RT3_L3FRtGr[Zn4,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc2[Zn4,Sp1]*RT3_Alloc2Down[Zn4,Sp1]+  RT3_FRAlloc3[Zn4,Sp1]*RT3_Alloc3Within[Zn4,Sp1]*(1-RT3_VoxHorExp3[Zn4,Sp1]/2)+  RT3_FRAlloc3[Zn3,Sp1]*RT3_Alloc3Within[Zn3,Sp1]*(RT3_VoxHorExp3[Zn3,Sp1]/2)+                                                                                RT3_FRAlloc4[Zn4,Sp1]*RT3_Alloc4Upw[Zn4,Sp1]))/RT3_RtAllocTot[Sp1]
    # RT3_L3FRtGr[Zn4,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc2[Zn4,Sp2]*RT3_Alloc2Down[Zn4,Sp2]+  RT3_FRAlloc3[Zn4,Sp2]*RT3_Alloc3Within[Zn4,Sp2]*(1-RT3_VoxHorExp3[Zn4,Sp2]/2)+  RT3_FRAlloc3[Zn3,Sp2]*RT3_Alloc3Within[Zn3,Sp2]*(RT3_VoxHorExp3[Zn3,Sp2]/2)+                                                                                RT3_FRAlloc4[Zn4,Sp2]*RT3_Alloc4Upw[Zn4,Sp2]))/RT3_RtAllocTot[Sp2]
    # RT3_L3FRtGr[Zn4,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc2[Zn4,Sp3]*RT3_Alloc2Down[Zn4,Sp3]+  RT3_FRAlloc3[Zn4,Sp3]*RT3_Alloc3Within[Zn4,Sp3]*(1-RT3_VoxHorExp3[Zn4,Sp3]/2)+  RT3_FRAlloc3[Zn3,Sp3]*RT3_Alloc3Within[Zn3,Sp3]*(RT3_VoxHorExp3[Zn3,Sp3]/2)+                                                                                RT3_FRAlloc4[Zn4,Sp3]*RT3_Alloc4Upw[Zn4,Sp3]))/RT3_RtAllocTot[Sp3]
    #
    # RT3_L4FRtGr[Zn1,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc3[Zn1,Sp1]*RT3_Alloc3Down[Zn1,Sp1]+  RT3_FRAlloc4[Zn1,Sp1]*RT3_Alloc4Within[Zn1,Sp1]*(1-RT3_VoxHorExp4[Zn1,Sp1]/2)+  RT3_FRAlloc4[Zn2,Sp1]*RT3_Alloc4Within[Zn2,Sp1]*(RT3_VoxHorExp4[Zn2,Sp1]/2)                                                                                                                             ))/RT3_RtAllocTot[Sp1]
    # RT3_L4FRtGr[Zn1,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc3[Zn1,Sp2]*RT3_Alloc3Down[Zn1,Sp2]+  RT3_FRAlloc4[Zn1,Sp2]*RT3_Alloc4Within[Zn1,Sp2]*(1-RT3_VoxHorExp4[Zn1,Sp2]/2)+  RT3_FRAlloc4[Zn2,Sp2]*RT3_Alloc4Within[Zn2,Sp2]*(RT3_VoxHorExp4[Zn2,Sp2]/2)                                                                                                                             ))/RT3_RtAllocTot[Sp2]
    # RT3_L4FRtGr[Zn1,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc3[Zn1,Sp3]*RT3_Alloc3Down[Zn1,Sp3]+  RT3_FRAlloc4[Zn1,Sp3]*RT3_Alloc4Within[Zn1,Sp3]*(1-RT3_VoxHorExp4[Zn1,Sp3]/2)+  RT3_FRAlloc4[Zn2,Sp3]*RT3_Alloc4Within[Zn2,Sp3]*(RT3_VoxHorExp4[Zn2,Sp3]/2)                                                                                                                             ))/RT3_RtAllocTot[Sp3]
    # RT3_L4FRtGr[Zn2,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc3[Zn2,Sp1]*RT3_Alloc3Down[Zn2,Sp1]+  RT3_FRAlloc4[Zn2,Sp1]*RT3_Alloc4Within[Zn2,Sp1]*(1-RT3_VoxHorExp4[Zn2,Sp1]  )+  RT3_FRAlloc4[Zn1,Sp1]*RT3_Alloc4Within[Zn1,Sp1]*(RT3_VoxHorExp4[Zn1,Sp1]/2)+  RT3_FRAlloc4[Zn3,Sp1]*RT3_Alloc4Within[Zn3,Sp1]*(RT3_VoxHorExp4[Zn3,Sp1]/2)                                               ))/RT3_RtAllocTot[Sp1]
    # RT3_L4FRtGr[Zn2,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc3[Zn2,Sp2]*RT3_Alloc3Down[Zn2,Sp2]+  RT3_FRAlloc4[Zn2,Sp2]*RT3_Alloc4Within[Zn2,Sp2]*(1-RT3_VoxHorExp4[Zn2,Sp2]  )+  RT3_FRAlloc4[Zn1,Sp2]*RT3_Alloc4Within[Zn1,Sp2]*(RT3_VoxHorExp4[Zn1,Sp2]/2)+  RT3_FRAlloc4[Zn3,Sp2]*RT3_Alloc4Within[Zn3,Sp2]*(RT3_VoxHorExp4[Zn3,Sp2]/2)                                               ))/RT3_RtAllocTot[Sp2]
    # RT3_L4FRtGr[Zn2,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc3[Zn2,Sp3]*RT3_Alloc3Down[Zn2,Sp3]+  RT3_FRAlloc4[Zn2,Sp3]*RT3_Alloc4Within[Zn2,Sp3]*(1-RT3_VoxHorExp4[Zn2,Sp3]  )+  RT3_FRAlloc4[Zn1,Sp3]*RT3_Alloc4Within[Zn1,Sp3]*(RT3_VoxHorExp4[Zn1,Sp3]/2)+  RT3_FRAlloc4[Zn3,Sp3]*RT3_Alloc4Within[Zn3,Sp3]*(RT3_VoxHorExp4[Zn3,Sp3]/2)                                               ))/RT3_RtAllocTot[Sp3]
    # RT3_L4FRtGr[Zn3,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc3[Zn3,Sp1]*RT3_Alloc3Down[Zn3,Sp1]+  RT3_FRAlloc4[Zn3,Sp1]*RT3_Alloc4Within[Zn3,Sp1]*(1-RT3_VoxHorExp4[Zn3,Sp1]  )+  RT3_FRAlloc4[Zn2,Sp1]*RT3_Alloc4Within[Zn2,Sp1]*(RT3_VoxHorExp4[Zn2,Sp1]/2)+  RT3_FRAlloc4[Zn4,Sp1]*RT3_Alloc4Within[Zn4,Sp1]*(RT3_VoxHorExp4[Zn4,Sp1]/2)                                               ))/RT3_RtAllocTot[Sp1]
    # RT3_L4FRtGr[Zn3,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc3[Zn3,Sp2]*RT3_Alloc3Down[Zn3,Sp2]+  RT3_FRAlloc4[Zn3,Sp2]*RT3_Alloc4Within[Zn3,Sp2]*(1-RT3_VoxHorExp4[Zn3,Sp2]  )+  RT3_FRAlloc4[Zn2,Sp2]*RT3_Alloc4Within[Zn2,Sp2]*(RT3_VoxHorExp4[Zn2,Sp2]/2)+  RT3_FRAlloc4[Zn4,Sp2]*RT3_Alloc4Within[Zn4,Sp2]*(RT3_VoxHorExp4[Zn4,Sp2]/2)                                               ))/RT3_RtAllocTot[Sp2]
    # RT3_L4FRtGr[Zn3,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc3[Zn3,Sp3]*RT3_Alloc3Down[Zn3,Sp3]+  RT3_FRAlloc4[Zn3,Sp3]*RT3_Alloc4Within[Zn3,Sp3]*(1-RT3_VoxHorExp4[Zn3,Sp3]  )+  RT3_FRAlloc4[Zn2,Sp3]*RT3_Alloc4Within[Zn2,Sp3]*(RT3_VoxHorExp4[Zn2,Sp3]/2)+  RT3_FRAlloc4[Zn4,Sp3]*RT3_Alloc4Within[Zn4,Sp3]*(RT3_VoxHorExp4[Zn4,Sp3]/2)                                               ))/RT3_RtAllocTot[Sp3]
    # RT3_L4FRtGr[Zn4,Sp1] = if RT3_RtAllocTot[Sp1]=0 then 0 else (RT3_FineRootInc[Sp1]*(RT3_FRAlloc3[Zn4,Sp1]*RT3_Alloc3Down[Zn4,Sp1]+  RT3_FRAlloc4[Zn4,Sp1]*RT3_Alloc4Within[Zn4,Sp1]*(1-RT3_VoxHorExp4[Zn4,Sp1]/2)+  RT3_FRAlloc4[Zn3,Sp1]*RT3_Alloc4Within[Zn3,Sp1]*(RT3_VoxHorExp4[Zn3,Sp1]/2)                                                                                                                             ))/RT3_RtAllocTot[Sp1]
    # RT3_L4FRtGr[Zn4,Sp2] = if RT3_RtAllocTot[Sp2]=0 then 0 else (RT3_FineRootInc[Sp2]*(RT3_FRAlloc3[Zn4,Sp2]*RT3_Alloc3Down[Zn4,Sp2]+  RT3_FRAlloc4[Zn4,Sp2]*RT3_Alloc4Within[Zn4,Sp2]*(1-RT3_VoxHorExp4[Zn4,Sp2]/2)+  RT3_FRAlloc4[Zn3,Sp2]*RT3_Alloc4Within[Zn3,Sp2]*(RT3_VoxHorExp4[Zn3,Sp2]/2)                                                                                                                             ))/RT3_RtAllocTot[Sp2]
    # RT3_L4FRtGr[Zn4,Sp3] = if RT3_RtAllocTot[Sp3]=0 then 0 else (RT3_FineRootInc[Sp3]*(RT3_FRAlloc3[Zn4,Sp3]*RT3_Alloc3Down[Zn4,Sp3]+  RT3_FRAlloc4[Zn4,Sp3]*RT3_Alloc4Within[Zn4,Sp3]*(1-RT3_VoxHorExp4[Zn4,Sp3]/2)+  RT3_FRAlloc4[Zn3,Sp3]*RT3_Alloc4Within[Zn3,Sp3]*(RT3_VoxHorExp4[Zn3,Sp3]/2)                                                                                                                             ))/RT3_RtAllocTot[Sp3]
    zonelayertree_df$RT3_RtAllocTot <- rep(tree_df$RT3_RtAllocTot, each = nzone *
                                             nlayer)
    
    zonelayertree_df$RT3_AllocDown_FRA <- zonelayertree_df$RT3_FRAlloc * zonelayertree_df$RT3_AllocDown
    zonelayertree_df$RT3_AllocDown_calc <- 0
    zonelayertree_df[zonelayertree_df$layer %in% c(2:4), "RT3_AllocDown_calc"] <- zonelayertree_df[zonelayertree_df$layer %in% c(1:3), "RT3_AllocDown_FRA"]
    
    zonelayertree_df$RT3_VoxHorExp_z14half <- zonelayertree_df$RT3_VoxHorExp
    zonelayertree_df[zonelayertree_df$zone %in% c(1, 4), "RT3_VoxHorExp_z14half"] <- zonelayertree_df[zonelayertree_df$zone %in% c(1, 4), "RT3_VoxHorExp"] /
      2
    
    zonelayertree_df$RT3_AllocWithin_calc <- zonelayertree_df$RT3_FRAlloc * zonelayertree_df$RT3_AllocWithin *
      (zonelayertree_df$RT3_VoxHorExp / 2)
    zonelayertree_df$RT3_AllocWithin_calc_zswitch <- NA
    zonelayertree_df[zonelayertree_df$zone == 1, "RT3_AllocWithin_calc_zswitch"] <- zonelayertree_df[zonelayertree_df$zone == 2, "RT3_AllocWithin_calc"]
    zonelayertree_df[zonelayertree_df$zone == 2, "RT3_AllocWithin_calc_zswitch"] <- zonelayertree_df[zonelayertree_df$zone == 1, "RT3_AllocWithin_calc"]
    zonelayertree_df[zonelayertree_df$zone == 3, "RT3_AllocWithin_calc_zswitch"] <- zonelayertree_df[zonelayertree_df$zone == 2, "RT3_AllocWithin_calc"]
    zonelayertree_df[zonelayertree_df$zone == 4, "RT3_AllocWithin_calc_zswitch"] <- zonelayertree_df[zonelayertree_df$zone == 3, "RT3_AllocWithin_calc"]
    zonelayertree_df[zonelayertree_df$zone %in% c(2, 3), "RT3_AllocWithin_calc_zswitch"] <- zonelayertree_df[zonelayertree_df$zone %in% c(2, 3), "RT3_AllocWithin_calc_zswitch"] + zonelayertree_df[zonelayertree_df$zone %in% c(3, 4), "RT3_AllocWithin_calc"]
    
    zonelayertree_df$RT3_AllocUpw_calc <- 0
    zonelayertree_df$RT3_AllocUpw_FRA <- zonelayertree_df$RT3_FRAlloc *
      zonelayertree_df$RT3_AllocUpw
    zonelayertree_df[zonelayertree_df$layer %in% c(1:3), "RT3_AllocUpw_calc"] <- zonelayertree_df[zonelayertree_df$layer %in% c(2:4), "RT3_AllocUpw_FRA"]
    
    zonelayertree_df$RT3_LFRtGr <- ifelse(
      zonelayertree_df$RT3_RtAllocTot == 0,
      0,
      (
        zonelayertree_df$RT3_FineRootInc * (
          zonelayertree_df$RT3_AllocDown_calc +
            zonelayertree_df$RT3_FRAlloc * zonelayertree_df$RT3_AllocWithin * (1 - zonelayertree_df$RT3_VoxHorExp_z14half) +
            zonelayertree_df$RT3_AllocWithin_calc_zswitch +
            zonelayertree_df$RT3_AllocUpw_calc
        )
      ) / zonelayertree_df$RT3_RtAllocTot
    )
    
    # RT3_DecFrac_L1[Zone,Tree] = ((RT3_SoilTL1[Zone]/20)^RT3_TempRespforRtD)/RT_T_MeanResTime[Tree]
    # RT3_DecFrac_L2[Zone,Tree] = ((RT3_SoilTL2[Zone]/20)^RT3_TempRespforRtD)/RT_T_MeanResTime[Tree]
    # RT3_DecFrac_L3[Zone,Tree] = ((RT3_SoilTL3[Zone]/20)^RT3_TempRespforRtD)/RT_T_MeanResTime[Tree]
    # RT3_DecFrac_L4[Zone,Tree] = ((RT3_SoilTL4[Zone]/20)^RT3_TempRespforRtD)/RT_T_MeanResTime[Tree]
    zonelayertree_df$RT3_SoilT <- rep(zonelayer_df$RT3_SoilT, ntree)
    zonelayertree_df$RT_T_MeanResTime <- rep(tree_df$RT_T_MeanResTime, each = nzone *
                                               nlayer)
    zonelayertree_df$RT3_DecFrac <- ((zonelayertree_df$RT3_SoilT / 20)^RT3_TempRespforRtD) /
      zonelayertree_df$RT_T_MeanResTime
    
    # RT3_L1FRtMort[Zone,Tree] = RT_L1FRLength[Zone,Tree]*RT3_DecFrac_L1[Zone,Tree]
    # RT3_L2FRtMort[Zone,Tree] = RT_L2FRLength[Zone,Tree]*RT3_DecFrac_L2[Zone,Tree]
    # RT3_L3FRtMort[Zone,Tree] = RT_L3FRLength[Zone,Tree]*RT3_DecFrac_L3[Zone,Tree]
    # RT3_L4FRtMort[Zone,Tree] = RT_L4FRLength[Zone,Tree]*RT3_DecFrac_L4[Zone,Tree]
    zonelayertree_df$RT3_FRtMort <- zonelayertree_df$RT_FRLength * zonelayertree_df$RT3_DecFrac
    
    
    
    # RT_TSpecrolT1[Zone,SoilLayer] = T_SRLfineroots[Sp1]
    # RT_TSpecrolT2[Zone,SoilLayer] = T_SRLfineroots[Sp2]
    # RT_TSpecrolT3[Zone,SoilLayer] = T_SRLfineroots[Sp3]
    zonelayertree_df$RT_TSpecrol <- rep(tree_df$T_SRLfineroots, each = nzone *
                                          nlayer)
    
    
    # T_Root_Drv_T1[Zn1,1] = if RT_TSpecrolT1[Zn1,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn1,Sp1]/RT_TSpecrolT1[Zn1,1]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn1,2] = if RT_TSpecrolT1[Zn1,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn1,Sp1]/RT_TSpecrolT1[Zn1,2]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn1,3] = if RT_TSpecrolT1[Zn1,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn1,Sp1]/RT_TSpecrolT1[Zn1,3]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn1,4] = if RT_TSpecrolT1[Zn1,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn1,Sp1]/RT_TSpecrolT1[Zn1,4]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn2,1] = if RT_TSpecrolT1[Zn2,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn2,Sp1]/RT_TSpecrolT1[Zn2,1]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn2,2] = if RT_TSpecrolT1[Zn2,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn2,Sp1]/RT_TSpecrolT1[Zn2,1]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn2,3] = if RT_TSpecrolT1[Zn2,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn2,Sp1]/RT_TSpecrolT1[Zn2,3]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn2,4] = if RT_TSpecrolT1[Zn2,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn2,Sp1]/RT_TSpecrolT1[Zn2,4]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn3,1] = if RT_TSpecrolT1[Zn3,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn3,Sp1]/RT_TSpecrolT1[Zn3,1]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn3,2] = if RT_TSpecrolT1[Zn3,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn3,Sp1]/RT_TSpecrolT1[Zn3,2]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn3,3] = if RT_TSpecrolT1[Zn3,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn3,Sp1]/RT_TSpecrolT1[Zn3,3]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn3,4] = if RT_TSpecrolT1[Zn3,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn3,Sp1]/RT_TSpecrolT1[Zn3,4]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn4,1] = if RT_TSpecrolT1[Zn4,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn4,Sp1]/RT_TSpecrolT1[Zn4,1]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn4,2] = if RT_TSpecrolT1[Zn4,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn4,Sp1]/RT_TSpecrolT1[Zn4,2]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn4,3] = if RT_TSpecrolT1[Zn4,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn4,Sp1]/RT_TSpecrolT1[Zn4,3]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T1[Zn4,4] = if RT_TSpecrolT1[Zn4,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn4,Sp1]/RT_TSpecrolT1[Zn4,4]+ 0*(RT_TLrvL1[Zn1,Sp1]+RT_TLrvL2[Zn1,Sp1]+RT_TLrvL3[Zn1,Sp1]+RT_TLrvL4[Zn1,Sp1])
    # T_Root_Drv_T2[Zn1,1] = if RT_TSpecrolT2[Zn1,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn1,Sp2]/RT_TSpecrolT2[Zn1,1]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn1,2] = if RT_TSpecrolT2[Zn1,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn1,Sp2]/RT_TSpecrolT2[Zn1,2]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn1,3] = if RT_TSpecrolT2[Zn1,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn1,Sp2]/RT_TSpecrolT2[Zn1,3]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn1,4] = if RT_TSpecrolT2[Zn1,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn1,Sp2]/RT_TSpecrolT2[Zn1,4]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn2,1] = if RT_TSpecrolT2[Zn2,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn2,Sp2]/RT_TSpecrolT2[Zn2,1]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn2,2] = if RT_TSpecrolT2[Zn2,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn2,Sp2]/RT_TSpecrolT2[Zn2,2]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn2,3] = if RT_TSpecrolT2[Zn2,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn2,Sp2]/RT_TSpecrolT2[Zn2,3]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn2,4] = if RT_TSpecrolT2[Zn2,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn2,Sp2]/RT_TSpecrolT2[Zn2,4]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn3,1] = if RT_TSpecrolT2[Zn3,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn3,Sp2]/RT_TSpecrolT2[Zn3,1]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn3,2] = if RT_TSpecrolT2[Zn3,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn3,Sp2]/RT_TSpecrolT2[Zn3,2]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn3,3] = if RT_TSpecrolT2[Zn3,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn3,Sp2]/RT_TSpecrolT2[Zn3,3]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn3,4] = if RT_TSpecrolT2[Zn3,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn3,Sp2]/RT_TSpecrolT2[Zn3,4]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn4,1] = if RT_TSpecrolT2[Zn4,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn4,Sp2]/RT_TSpecrolT2[Zn4,1]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn4,2] = if RT_TSpecrolT2[Zn4,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn4,Sp2]/RT_TSpecrolT2[Zn4,2]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn4,3] = if RT_TSpecrolT2[Zn4,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn4,Sp2]/RT_TSpecrolT2[Zn4,3]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T2[Zn4,4] = if RT_TSpecrolT2[Zn4,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn4,Sp2]/RT_TSpecrolT2[Zn4,4]+ 0*(RT_TLrvL1[Zn1,Sp2]+RT_TLrvL2[Zn1,Sp2]+RT_TLrvL3[Zn1,Sp2]+RT_TLrvL4[Zn1,Sp2])
    # T_Root_Drv_T3[Zn1,1] = if RT_TSpecrolT3[Zn1,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn1,Sp3]/RT_TSpecrolT3[Zn1,1]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn1,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn1,2] = if RT_TSpecrolT3[Zn1,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn1,Sp3]/RT_TSpecrolT3[Zn1,2]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn1,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn1,3] = if RT_TSpecrolT3[Zn1,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn1,Sp3]/RT_TSpecrolT3[Zn1,3]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn1,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn1,4] = if RT_TSpecrolT3[Zn1,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn1,Sp3]/RT_TSpecrolT3[Zn1,4]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn1,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn2,1] = if RT_TSpecrolT3[Zn2,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn2,Sp3]/RT_TSpecrolT3[Zn2,1]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn2,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn2,2] = if RT_TSpecrolT3[Zn2,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn2,Sp3]/RT_TSpecrolT3[Zn2,2]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn2,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn2,3] = if RT_TSpecrolT3[Zn2,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn2,Sp3]/RT_TSpecrolT3[Zn2,3]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn2,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn2,4] = if RT_TSpecrolT3[Zn2,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn2,Sp3]/RT_TSpecrolT3[Zn2,4]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn2,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn3,1] = if RT_TSpecrolT3[Zn3,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn3,Sp3]/RT_TSpecrolT3[Zn3,1]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn3,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn3,2] = if RT_TSpecrolT3[Zn3,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn3,Sp3]/RT_TSpecrolT3[Zn3,2]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn3,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn3,3] = if RT_TSpecrolT3[Zn3,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn3,Sp3]/RT_TSpecrolT3[Zn3,3]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn3,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn3,4] = if RT_TSpecrolT3[Zn3,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn3,Sp3]/RT_TSpecrolT3[Zn3,4]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn3,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn4,1] = if RT_TSpecrolT3[Zn4,1] = 0 then 0 else 0.01*RT_TLrvL1[Zn4,Sp3]/RT_TSpecrolT3[Zn4,1]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn4,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn4,2] = if RT_TSpecrolT3[Zn4,2] = 0 then 0 else 0.01*RT_TLrvL2[Zn4,Sp3]/RT_TSpecrolT3[Zn4,2]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn4,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn4,3] = if RT_TSpecrolT3[Zn4,3] = 0 then 0 else 0.01*RT_TLrvL3[Zn4,Sp3]/RT_TSpecrolT3[Zn4,3]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn4,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    # T_Root_Drv_T3[Zn4,4] = if RT_TSpecrolT3[Zn4,4] = 0 then 0 else 0.01*RT_TLrvL4[Zn4,Sp3]/RT_TSpecrolT3[Zn4,4]+ 0*(RT_TLrvL1[Zn1,Sp3]+RT_TLrvL2[Zn4,Sp3]+RT_TLrvL3[Zn1,Sp3]+RT_TLrvL4[Zn1,Sp3])
    zonelayertree_df$T_Root_Drv <- ifelse(
      zonelayertree_df$RT_TSpecrol == 0,
      0,
      0.01 * zonelayertree_df$RT_TLrv / zonelayertree_df$RT_TSpecrol
    )
    
    # T_Root_Dra_T1_ZnL[Zone,SoilLayer] = 1000*AF_Depths[SoilLayer]*T_Root_Drv_T1[Zone,SoilLayer]
    # T_Root_Dra_T2_ZnL[Zone,SoilLayer] = 1000*AF_Depths[SoilLayer]*T_Root_Drv_T2[Zone,SoilLayer]
    # T_Root_Dra_T3_ZnL[Zone,SoilLayer] = 1000*AF_Depths[SoilLayer]*T_Root_Drv_T3[Zone,SoilLayer]
    zonelayertree_df$AF_Depths <- rep(rep(layer_df$AF_Depths, each = nzone), ntree)
    zonelayertree_df$T_Root_Dra_ZnL <- 1000 * zonelayertree_df$AF_Depths * zonelayertree_df$T_Root_Drv
    
    # T_RootInp_T1_ZnL[Zone,SoilLayer] = T_Root_Dra_T1_ZnL[Zone,SoilLayer]*(if time = T_PlantTime[Sp1] then 1 else (if time > T_PlantTime[Sp1] then 1/RT_T_MeanResTime[Sp1] else 0))
    # T_Root_Inp_T2_ZnL[Zone,SoilLayer] = T_Root_Dra_T2_ZnL[Zone,SoilLayer]*(if time = T_PlantTime[Sp2] then 1 else (if time > T_PlantTime[Sp2] then 1/RT_T_MeanResTime[Sp2] else 0))
    # T_Root_Inp_T3_ZnL[Zone,SoilLayer] = T_Root_Dra_T3_ZnL[Zone,SoilLayer]*(if time = T_PlantTime[Sp3] then 1 else (if time > T_PlantTime[Sp3] then 1/RT_T_MeanResTime[Sp3] else 0))
    zonelayertree_df$T_PlantTime <- rep(tree_df$T_PlantTime, each = nzone *
                                          nlayer)
    zonelayertree_df$T_Root_Inp_ZnL <- zonelayertree_df$T_Root_Dra_ZnL * ifelse(
      time == zonelayertree_df$T_PlantTime,
      1,
      ifelse(
        time > zonelayertree_df$T_PlantTime,
        1 / zonelayertree_df$RT_T_MeanResTime,
        0
      )
    )
    
    # T_Root_T1_DWInc[Zone,SoilLayer] = if RT_ATType[Sp1] < 2 then T_RootInp_T1_ZnL[Zone,SoilLayer] else T_RootInc[DW,Sp1]*T_T1RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T2_DWInc[Zone,SoilLayer] = if RT_ATType[Sp2] < 2 then T_Root_Inp_T2_ZnL[Zone,SoilLayer] else T_RootInc[DW,Sp2]*T_T2RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T3_DWInc[Zone,SoilLayer] = if RT_ATType[Sp3] < 2 then T_Root_Inp_T3_ZnL[Zone,SoilLayer] else T_RootInc[DW,Sp3]*T_T3RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T1_NInc[Zone,SoilLayer] = if RT_ATType[Sp1] < 2 then T_RootInp_T1_ZnL[Zone,SoilLayer]*(T_UnitConv[N]*T_RtConc[N,Sp1]) else T_RootInc[N,Sp1]*T_T1RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T2_NInc[Zone,SoilLayer] = if RT_ATType[Sp2] < 2 then T_Root_Inp_T2_ZnL[Zone,SoilLayer]*(T_UnitConv[N]*T_RtConc[N,Sp2]) else T_RootInc[N,Sp2]*T_T2RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T3_NInc[Zone,SoilLayer] = if RT_ATType[Sp3] < 2 then T_Root_Inp_T3_ZnL[Zone,SoilLayer]*(T_UnitConv[N]*T_RtConc[N,Sp3]) else T_RootInc[N,Sp3]*T_T3RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T1_PInc[Zone,SoilLayer] = if RT_ATType[Sp1] < 2 then T_RootInp_T1_ZnL[Zone,SoilLayer]*(T_UnitConv[P]*T_RtConc[P,Sp1]) else T_RootInc[P,Sp1]*T_T1RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T2_PInc[Zone,SoilLayer] = if RT_ATType[Sp2] < 2 then T_Root_Inp_T2_ZnL[Zone,SoilLayer]*(T_UnitConv[P]*T_RtConc[P,Sp2]) else T_RootInc[P,Sp2]*T_T2RelRtIncrTyp2[Zone,SoilLayer]
    # T_Root_T3_PInc[Zone,SoilLayer] = if RT_ATType[Sp3] < 2 then T_Root_Inp_T3_ZnL[Zone,SoilLayer]*(T_UnitConv[P]*T_RtConc[P,Sp3]) else T_RootInc[P,Sp3]*T_T3RelRtIncrTyp2[Zone,SoilLayer]
    zonelayertreepcomp_df$RT_ATType <- rep(rep(tree_df$RT_ATType, each = nzone *
                                                 nlayer),
                                           nrow(pcomp_df))
    zonelayertreepcomp_df$T_Root_Inp_ZnL <- rep(zonelayertree_df$T_Root_Inp_ZnL, nrow(pcomp_df))
    zonelayertreepcomp_df$T_RootInc <- rep(treepcomp_df$T_RootInc, each = nzone *
                                             nlayer)
    zonelayertreepcomp_df$T_T1RelRtIncrTyp2 <- rep(zonelayertree_df$T_RelRtIncrTyp2, nrow(pcomp_df))
    zonelayertreepcomp_df$T_Root_Inc <- ifelse(
      zonelayertreepcomp_df$RT_ATType < 2,
      zonelayertreepcomp_df$T_Root_Inp_ZnL,
      zonelayertreepcomp_df$T_RootInc * zonelayertreepcomp_df$T_RelRtIncrTyp2
    )
    
    
    
    # RT_TRelChangeV[Tree] = IF(RT_ATType[Tree]=2 AND T_Prun[DW, Tree]=0 AND T_LfTwig[DW,Tree]>0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree])THEN((T_RootInc[DW, Tree])*1000*RT_TSRL[Tree]/RT_TlraX0Curr[Tree])ELSE(0)
    # RT_TRelChangeH[Tree] = IF(RT_ATType[Tree]=2 AND T_Prun[DW, Tree]=0 AND T_LfTwig[DW,Tree]>0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree])THEN((T_RootInc[DW, Tree])*1000*RT_TSRL[Tree]/RT_TlraX0Curr[Tree])ELSE(0)
    tree_df$RT_TRelChangeH <- ifelse(
      tree_df$RT_ATType == 2 &
        treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Prun"] == 0 &
        treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LfTwig"] > 0 &
        tree_df$T_PrunLapse > tree_df$T_PrunRecov,
      treepcomp_df[treepcomp_df$PlantComp == "DW", "T_RootInc"] *
        1000 * tree_df$RT_TSRL / tree_df$RT_TlraX0Curr,
      0
    )
    #TODO: confirm that this is equals
    tree_df$RT_TRelChangeV <- tree_df$RT_TRelChangeH
    
    # T_NT1UptZn[Zone,SlNut] = N_T1Upt1[Zone,SlNut]+N_T1Upt2[Zone,SlNut]+N_T1Upt3[Zone,SlNut]+N_T1Upt4[Zone,SlNut]
    # T_NT2UptZn[Zone,SlNut] = N_T2Upt1[Zone,SlNut]+N_T2Upt2[Zone,SlNut]+N_T2Upt3[Zone,SlNut]+N_T2Upt4[Zone,SlNut]
    # T_NT3UptZn[Zone,SlNut] = N_T3Upt1[Zone,SlNut]+N_T3Upt2[Zone,SlNut]+N_T3Upt3[Zone,SlNut]+N_T3Upt4[Zone,SlNut]
    zonetreenut_df$T_NUptZn <- aggregate(zonelayertreenut_df["N_Upt"], zonelayertreenut_df[c("zone", "tree_id", "SlNut")], sum)$N_Upt
    
    # T_NUptTree[N,Sp1] = T_NT1UptZn[Zn1,N]*AF_ZoneFrac[Zn1]+T_NT1UptZn[Zn2,N]*AF_ZoneFrac[Zn2]+T_NT1UptZn[Zn3,N]*AF_ZoneFrac[Zn3]+T_NT1UptZn[Zn4,N]*AF_ZoneFrac[Zn4]+0*(T_NT2UptZn[Zn1,N]+T_NT2UptZn[Zn2,N]+T_NT2UptZn[Zn3,N]+T_NT2UptZn[Zn4,N]+T_NT3UptZn[Zn1,N]+T_NT3UptZn[Zn2,N]+T_NT3UptZn[Zn3,N]+T_NT3UptZn[Zn4,N])
    # T_NUptTree[N,Sp2] = T_NT2UptZn[Zn1,N]*AF_ZoneFrac[Zn1]+T_NT2UptZn[Zn2,N]*AF_ZoneFrac[Zn2]+T_NT2UptZn[Zn3,N]*AF_ZoneFrac[Zn3]+T_NT2UptZn[Zn4,N]*AF_ZoneFrac[Zn4]+0*(T_NT1UptZn[Zn1,N]+T_NT1UptZn[Zn2,N]+T_NT1UptZn[Zn3,N]+T_NT1UptZn[Zn4,N]+T_NT3UptZn[Zn1,N]+T_NT3UptZn[Zn2,N]+T_NT3UptZn[Zn3,N]+T_NT3UptZn[Zn4,N])
    # T_NUptTree[N,Sp3] = T_NT3UptZn[Zn1,N]*AF_ZoneFrac[Zn1]+T_NT3UptZn[Zn2,N]*AF_ZoneFrac[Zn2]+T_NT3UptZn[Zn3,N]*AF_ZoneFrac[Zn3]+T_NT3UptZn[Zn4,N]*AF_ZoneFrac[Zn4]+0*(T_NT2UptZn[Zn1,N]+T_NT2UptZn[Zn2,N]+T_NT2UptZn[Zn3,N]+T_NT2UptZn[Zn4,N]+T_NT1UptZn[Zn1,N]+T_NT1UptZn[Zn2,N]+T_NT1UptZn[Zn3,N]+T_NT1UptZn[Zn4,N])
    # T_NUptTree[P,Sp1] = T_NT1UptZn[Zn1,P]*AF_ZoneFrac[Zn1]+T_NT1UptZn[Zn2,P]*AF_ZoneFrac[Zn2]+T_NT1UptZn[Zn3,P]*AF_ZoneFrac[Zn3]+T_NT1UptZn[Zn4,P]*AF_ZoneFrac[Zn4]+0*(T_NT2UptZn[Zn1,P]+T_NT2UptZn[Zn2,P]+T_NT2UptZn[Zn3,P]+T_NT2UptZn[Zn4,P]+T_NT3UptZn[Zn1,P]+T_NT3UptZn[Zn2,P]+T_NT3UptZn[Zn3,P]+T_NT3UptZn[Zn4,P])
    # T_NUptTree[P,Sp2] = T_NT2UptZn[Zn1,P]*AF_ZoneFrac[Zn1]+T_NT2UptZn[Zn2,P]*AF_ZoneFrac[Zn2]+T_NT2UptZn[Zn3,P]*AF_ZoneFrac[Zn3]+T_NT2UptZn[Zn4,P]*AF_ZoneFrac[Zn4]+0*(T_NT1UptZn[Zn1,P]+T_NT1UptZn[Zn2,P]+T_NT1UptZn[Zn3,P]+T_NT1UptZn[Zn4,P]+T_NT3UptZn[Zn1,P]+T_NT3UptZn[Zn2,P]+T_NT3UptZn[Zn3,P]+T_NT3UptZn[Zn4,P])
    # T_NUptTree[P,Sp3] = T_NT3UptZn[Zn1,P]*AF_ZoneFrac[Zn1]+T_NT3UptZn[Zn2,P]*AF_ZoneFrac[Zn2]+T_NT3UptZn[Zn3,P]*AF_ZoneFrac[Zn3]+T_NT3UptZn[Zn4,P]*AF_ZoneFrac[Zn4]+0*(T_NT1UptZn[Zn1,P]+T_NT1UptZn[Zn2,P]+T_NT1UptZn[Zn3,P]+T_NT1UptZn[Zn4,P]+T_NT2UptZn[Zn1,P]+T_NT2UptZn[Zn2,P]+T_NT2UptZn[Zn3,P]+T_NT2UptZn[Zn4,P])
    zonetreenut_df$AF_ZoneFrac <- rep(zonetree_df$AF_ZoneFrac, nrow(nut_df))
    zonetreenut_df$T_NUptZn_Frac <- zonetreenut_df$T_NUptZn * zonetreenut_df$AF_ZoneFrac
    treenut_df$T_NUptTree <- aggregate(zonetreenut_df["T_NUptZn_Frac"], zonetreenut_df[c("tree_id", "SlNut")], sum)$T_NUptZn_Frac
    
    # RT_TAmountH[Zone,Tree] = RT_TLrv1[Zone,Tree]*AF_DepthAct1[Zone]+RT_TLrv2[Zone,Tree]*AF_Depth2[Zone]+RT_TLrv3[Zone,Tree]*AF_Depth3[Zone]+RT_TLrv4[Zone,Tree]*AF_Depth4[Zone]
    zonelayertree_df$RT_TLrv_depth <- zonelayertree_df$RT_TLrv * zonelayertree_df$AF_Depth
    zonetree_df$RT_TAmountH <- aggregate(zonelayertree_df["RT_TLrv_depth"], zonelayertree_df[c("zone", "tree_id")], sum)$RT_TLrv_depth
    
    # RT_TAmountHTree[Sp1] = RT_TAmountH[Zn1,Sp1]*AF_ZoneFrac[Zn1]+RT_TAmountH[Zn2,Sp1]*AF_ZoneFrac[Zn2]+RT_TAmountH[Zn3,Sp1]*AF_ZoneFrac[Zn3]+RT_TAmountH[Zn4,Sp1]*AF_ZoneFrac[Zn4]
    # RT_TAmountHTree[Sp2] = RT_TAmountH[Zn1,Sp2]*AF_ZoneFrac[Zn1]+RT_TAmountH[Zn2,Sp2]*AF_ZoneFrac[Zn2]+RT_TAmountH[Zn3,Sp2]*AF_ZoneFrac[Zn3]+RT_TAmountH[Zn4,Sp2]*AF_ZoneFrac[Zn4]
    # RT_TAmountHTree[Sp3] = RT_TAmountH[Zn1,Sp3]*AF_ZoneFrac[Zn1]+RT_TAmountH[Zn2,Sp3]*AF_ZoneFrac[Zn2]+RT_TAmountH[Zn3,Sp3]*AF_ZoneFrac[Zn3]+RT_TAmountH[Zn4,Sp3]*AF_ZoneFrac[Zn4]
    zonetree_df$RT_TAmountH_Frac <- zonetree_df$RT_TAmountH * zonetree_df$AF_ZoneFrac
    tree_df$RT_TAmountHTree <- aggregate(zonetree_df["RT_TAmountH_Frac"], zonetree_df["tree_id"], sum)$RT_TAmountH_Frac
    
    treenut_df$RT_ATType <- rep(tree_df$RT_ATType, nrow(nut_df))
    
    # T_NUptRelH[SlNut,Tree] = IF( RT_ATType[Tree]=2 AND T_LfTwig[DW,Tree]>0 AND T_Prun[DW, Tree]=0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree] AND T_NUptTot[SlNut,Tree]>0)  THEN (AF_DepthAvg1*T_NUptTree[SlNut,Tree]/RT_TAmountHTree[Tree]+AF_DepthAvg2*T_NUptTree[SlNut,Tree]/RT_TAmountHTree[Tree]-AF_DepthAvg3*T_NUptTree[SlNut,Tree]/RT_TAmountHTree[Tree]-AF_DepthAvg4*T_NUptTree[SlNut,Tree]/RT_TAmountHTree[Tree])/(((AF_DepthAvg1+AF_DepthAvg2+AF_DepthAvg3+AF_DepthAvg4)*T_NUptTot[SlNut,Tree])/RT_TField[Tree])ELSE(1)
    treenut_df$T_LfTwig_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LfTwig"], nrow(nut_df))
    tree_df$T_Prun_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Prun"]
    treenut_df$T_Prun_DW <- rep(tree_df$T_Prun_DW, nrow(nut_df))
    treenut_df$T_PrunLapse <- rep(tree_df$T_PrunLapse, nrow(nut_df))
    treenut_df$T_PrunRecov <- rep(tree_df$T_PrunRecov, nrow(nut_df))
    treenut_df$RT_TAmountHTree <- rep(tree_df$RT_TAmountHTree, nrow(nut_df))
    
    treenut_df$T_NUptRelH <- ifelse(
      treenut_df$RT_ATType == 2 &
        treenut_df$T_LfTwig_DW > 0 &
        treenut_df$T_Prun_DW == 0 &
        treenut_df$T_PrunLapse > treenut_df$T_PrunRecov &
        treenut_df$T_NUptTot > 0,
      (
        layer_df[layer_df$layer == 1, ]$AF_DepthAvg * treenut_df$T_NUptTree / treenut_df$RT_TAmountHTree +
          layer_df[layer_df$layer == 2, ]$AF_DepthAvg * treenut_df$T_NUptTree /
          treenut_df$RT_TAmountHTree -
          layer_df[layer_df$layer == 3, ]$AF_DepthAvg * treenut_df$T_NUptTree /
          treenut_df$RT_TAmountHTree -
          layer_df[layer_df$layer == 4, ]$AF_DepthAvg * treenut_df$T_NUptTree /
          treenut_df$RT_TAmountHTree
      ) / ((
        sum(layer_df$AF_DepthAvg) * treenut_df$T_NUptTot
      ) / treenut_df$RT_TField),
      1
    )
    
    #TODO: to be check whether TW_UptTree and TW_UptTot are equal
    # TW_T1UptZn[Zone] = W_T1Upt1[Zone]+W_T1Upt2[Zone]+W_T1Upt3[Zone]+W_T1Upt4[Zone]
    # TW_T2UptZn[Zone] = W_T2Upt1[Zone]+W_T2Upt2[Zone]+W_T2Upt3[Zone]+W_T2Upt4[Zone]
    # TW_T3UptZn[Zone] = W_T3Upt1[Zone]+W_T3Upt2[Zone]+W_T3Upt3[Zone]+W_T3Upt4[Zone]
    zonetree_df$TW_UptZn <- zonetree_df$W_Upt_sum
    
    
    # TW_UptTree[Sp1] = TW_T1UptZn[Zn1]*AF_ZoneFrac[Zn1]+TW_T1UptZn[Zn2]*AF_ZoneFrac[Zn2]+TW_T1UptZn[Zn3]*AF_ZoneFrac[Zn3]+TW_T1UptZn[Zn3]*AF_ZoneFrac[Zn3]+0*(TW_T2UptZn[Zn1]+TW_T2UptZn[Zn2]+TW_T2UptZn[Zn3]+TW_T2UptZn[Zn4]+TW_T3UptZn[Zn1]+TW_T3UptZn[Zn2]+TW_T3UptZn[Zn3]+TW_T3UptZn[Zn4])
    # TW_UptTree[Sp2] = TW_T2UptZn[Zn1]*AF_ZoneFrac[Zn1]+TW_T2UptZn[Zn2]*AF_ZoneFrac[Zn2]+TW_T2UptZn[Zn3]*AF_ZoneFrac[Zn3]+TW_T2UptZn[Zn3]*AF_ZoneFrac[Zn3]+0*(TW_T1UptZn[Zn1]+TW_T1UptZn[Zn2]+TW_T1UptZn[Zn3]+TW_T1UptZn[Zn4]+TW_T3UptZn[Zn1]+TW_T3UptZn[Zn2]+TW_T3UptZn[Zn3]+TW_T3UptZn[Zn4])
    # TW_UptTree[Sp3] = TW_T3UptZn[Zn1]*AF_ZoneFrac[Zn1]+TW_T3UptZn[Zn2]*AF_ZoneFrac[Zn2]+TW_T3UptZn[Zn3]*AF_ZoneFrac[Zn3]+TW_T3UptZn[Zn3]*AF_ZoneFrac[Zn3]+0*(TW_T2UptZn[Zn1]+TW_T2UptZn[Zn2]+TW_T2UptZn[Zn3]+TW_T2UptZn[Zn4]+TW_T1UptZn[Zn1]+TW_T1UptZn[Zn2]+TW_T1UptZn[Zn3]+TW_T1UptZn[Zn4])
    tree_df$TW_UptTree <- tree_df$TW_UptTot
    
    # TW_UptRelH[Tree] = IF( RT_ATType[Tree]=2 AND T_LfTwig[DW,Tree]>0 AND T_Prun[DW, Tree]=0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree] AND TW_UptTot[Tree]>0)  THEN (AF_DepthAvg1*TW_UptTree[Tree]/RT_TAmountHTree[Tree]+AF_DepthAvg2*TW_UptTree[Tree]/RT_TAmountHTree[Tree]-AF_DepthAvg3*TW_UptTree[Tree]/RT_TAmountHTree[Tree]-AF_DepthAvg4*TW_UptTree[Tree]/RT_TAmountHTree[Tree])/(((AF_DepthAvg1+AF_DepthAvg2+AF_DepthAvg3+AF_DepthAvg4)*TW_UptTot[Tree])/RT_TField[Tree])ELSE(1)
    tree_df$TW_UptRelH <- ifelse(
      tree_df$RT_ATType == 2 &
        tree_df$T_LfTwig_DW > 0 &
        tree_df$T_Prun_DW == 0 &
        tree_df$T_PrunLapse > tree_df$T_PrunRecov &
        tree_df$TW_UptTot > 0,
      (
        layer_df[layer_df$layer == 1, ]$AF_DepthAvg * tree_df$TW_UptTree / tree_df$RT_TAmountHTree +
          layer_df[layer_df$layer == 2, ]$AF_DepthAvg * tree_df$TW_UptTree /
          tree_df$RT_TAmountHTree -
          layer_df[layer_df$layer == 3, ]$AF_DepthAvg * tree_df$TW_UptTree /
          tree_df$RT_TAmountHTree -
          layer_df[layer_df$layer == 4, ]$AF_DepthAvg * tree_df$TW_UptTree /
          tree_df$RT_TAmountHTree
      ) /
        ((
          sum(layer_df$AF_DepthAvg) * tree_df$TW_UptTot
        ) / tree_df$RT_TField),
      1
    )
    
    # RT_TUptRelH[Tree] = IF (T_NPosgro[N, Tree]< 1 OR T_NPosgro[P, Tree] <1 OR TW_Posgro[Tree] <1) THEN IF (min(T_NPosgro[N, Tree],T_NPosgro[P, Tree],TW_Posgro[Tree])=T_NPosgro[N, Tree]) THEN T_NUptRelH[N, Tree] ELSE if (min(T_NPosgro[N, Tree],T_NPosgro[P, Tree],TW_Posgro[Tree])=T_NPosgro[P, Tree]) then T_NUptRelH[P, Tree] ELSE  TW_UptRelH[Tree] ELSE 1
    
    tree_df$RT_TUptRelH <- ifelse(
      tree_df$T_NPosgro_N < 1 |
        tree_df$T_NPosgro_P < 1 | tree_df$TW_Posgro < 1,
      ifelse(
        pmin(
          tree_df$T_NPosgro_N,
          tree_df$T_NPosgro_P,
          tree_df$TW_Posgro
        ) == tree_df$T_NPosgro_N,
        treenut_df[treenut_df$SlNut == "N", ]$T_NUptRelH,
        ifelse(
          pmin(
            tree_df$T_NPosgro_N,
            tree_df$T_NPosgro_P,
            tree_df$TW_Posgro
          ) == tree_df$T_NPosgro_P,
          treenut_df[treenut_df$SlNut == "P", ]$T_NUptRelH,
          tree_df$TW_UptRelH
        )
      ),
      1
    )
    
    # RT_TDistShapeD[Tree] = IF(RT_ATType[Tree]=2 AND T_Prun[DW, Tree]=0 AND T_LfTwig[DW,Tree]>0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree])THEN (MIN(1+RT_TRelChangeH[Tree], MAX((1+RT_TRelChangeH[Tree])^-1, RT_TUptRelH[Tree]^-RT_TDistResp[Tree])))ELSE(1)
    tree_df$RT_TDistShapeD <- ifelse(
      tree_df$RT_ATType == 2 &
        tree_df$T_Prun_DW == 0 &
        tree_df$T_LfTwig_DW > 0 &
        tree_df$T_PrunLapse > tree_df$T_PrunRecov,
      pmin(
        1 + tree_df$RT_TRelChangeH,
        pmax((1 + tree_df$RT_TRelChangeH)^-1,
             tree_df$RT_TUptRelH^-tree_df$RT_TDistResp
        )
      ),
      1
    )
    
    # RT_TDistShapeInc[Tree] = if T_DiesToday?[Tree] = 1 then - RT_TDistShapeAct[Tree] else IF(RT_ATType[Tree]=2)THEN(RT_TDistShapeAct[Tree]*(RT_TDistShapeD[Tree]-1))ELSE(0)
    tree_df$RT_TDistShapeInc <- ifelse(
      tree_df$T_DiesToday_is == 1,
      -tree_df$RT_TDistShapeAct,
      ifelse(
        tree_df$RT_ATType == 2,
        tree_df$RT_TDistShapeAct * (tree_df$RT_TDistShapeD - 1),
        0
      )
    )
    
    # RT_TDistShapeActInitPlantTime[Tree] = if time = T_PlantTime[Tree] then RT_TDistShapeC[Tree] else 0
    tree_df$RT_TDistShapeActInitPlantTime <- ifelse(time == tree_df$T_PlantTime, tree_df$RT_TDistShapeC, 0)
    
    
    # RT_TAmountV1[Tree] = AF_ZoneFrac[Zn1]*AF_DepthAct1[Zn1]*RT_TLrv1[Zn1, Tree]+AF_ZoneFrac[Zn2]*AF_DepthAct1[Zn2]*RT_TLrv1[Zn2, Tree]+AF_ZoneFrac[Zn3]*AF_DepthAct1[Zn3]*RT_TLrv1[Zn3, Tree]+AF_ZoneFrac[Zn4]*AF_DepthAct1[Zn4]*RT_TLrv1[Zn4, Tree]
    # RT_TAmountV2[Tree] = AF_ZoneFrac[Zn1]*AF_Depth2[Zn1]*RT_TLrv2[Zn1, Tree]+AF_ZoneFrac[Zn2]*AF_Depth2[Zn2]*RT_TLrv2[Zn2, Tree]+AF_ZoneFrac[Zn3]*AF_Depth2[Zn3]*RT_TLrv2[Zn3, Tree]+AF_ZoneFrac[Zn4]*AF_Depth2[Zn4]*RT_TLrv2[Zn4, Tree]
    # RT_TAmountV3[Tree] = AF_ZoneFrac[Zn1]*AF_Depth3[Zn1]*RT_TLrv3[Zn1, Tree]+AF_ZoneFrac[Zn2]*AF_Depth3[Zn2]*RT_TLrv3[Zn2, Tree]+AF_ZoneFrac[Zn3]*AF_Depth3[Zn3]*RT_TLrv3[Zn3, Tree]+AF_ZoneFrac[Zn4]*AF_Depth3[Zn4]*RT_TLrv3[Zn4, Tree]
    # RT_TAmountV4[Tree] = AF_ZoneFrac[Zn1]*AF_Depth4[Zn1]*RT_TLrv4[Zn1, Tree]+AF_ZoneFrac[Zn2]*AF_Depth4[Zn2]*RT_TLrv4[Zn2, Tree]+AF_ZoneFrac[Zn3]*AF_Depth4[Zn3]*RT_TLrv4[Zn3, Tree]+AF_ZoneFrac[Zn4]*AF_Depth4[Zn4]*RT_TLrv4[Zn4, Tree]
    zonelayertree_df$RT_TLrv_Depth_Frac <- zonelayertree_df$AF_ZoneFrac * zonelayertree_df$AF_Depth * zonelayertree_df$RT_TLrv
    layertree_df$RT_TAmountV <- aggregate(zonelayertree_df["RT_TLrv_Depth_Frac"], zonelayertree_df[c("layer", "tree_id")], sum)$RT_TLrv_Depth_Frac
    
    # T_NUpt1[N,Sp1] = N_T1Upt1[Zn1,N]*AF_ZoneFrac[Zn1]+N_T1Upt1[Zn2,N]*AF_ZoneFrac[Zn2]+N_T1Upt1[Zn3,N]*AF_ZoneFrac[Zn3]+N_T1Upt1[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt1[Zn1,N]+N_T2Upt1[Zn2,N]+N_T2Upt1[Zn3,N]+N_T2Upt1[Zn4,N]+N_T3Upt1[Zn1,N]+N_T3Upt1[Zn2,N]+N_T3Upt1[Zn3,N]+N_T3Upt1[Zn4,N])
    # T_NUpt1[N,Sp2] = N_T2Upt1[Zn1,N]*AF_ZoneFrac[Zn1]+N_T2Upt1[Zn2,N]*AF_ZoneFrac[Zn2]+N_T2Upt1[Zn3,N]*AF_ZoneFrac[Zn3]+N_T2Upt1[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T1Upt1[Zn1,N]+N_T1Upt1[Zn2,N]+N_T1Upt1[Zn3,N]+N_T1Upt1[Zn4,N]+N_T3Upt1[Zn1,N]+N_T3Upt1[Zn2,N]+N_T3Upt1[Zn3,N]+N_T3Upt1[Zn4,N])
    # T_NUpt1[N,Sp3] = N_T3Upt1[Zn1,N]*AF_ZoneFrac[Zn1]+N_T3Upt1[Zn2,N]*AF_ZoneFrac[Zn2]+N_T3Upt1[Zn3,N]*AF_ZoneFrac[Zn3]+N_T3Upt1[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt1[Zn1,N]+N_T2Upt1[Zn2,N]+N_T2Upt1[Zn3,N]+N_T2Upt1[Zn4,N]+N_T1Upt1[Zn1,N]+N_T1Upt1[Zn2,N]+N_T1Upt1[Zn3,N]+N_T1Upt1[Zn4,N])
    # T_NUpt1[P,Sp1] = N_T1Upt1[Zn1,P]*AF_ZoneFrac[Zn1]+N_T1Upt1[Zn2,P]*AF_ZoneFrac[Zn2]+N_T1Upt1[Zn3,P]*AF_ZoneFrac[Zn3]+N_T1Upt1[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt1[Zn1,P]+N_T2Upt1[Zn2,P]+N_T2Upt1[Zn3,P]+N_T2Upt1[Zn4,P]+N_T3Upt1[Zn1,P]+N_T3Upt1[Zn2,P]+N_T3Upt1[Zn3,P]+N_T3Upt1[Zn4,P])
    # T_NUpt1[P,Sp2] = N_T2Upt1[Zn1,P]*AF_ZoneFrac[Zn1]+N_T2Upt1[Zn2,P]*AF_ZoneFrac[Zn2]+N_T2Upt1[Zn3,P]*AF_ZoneFrac[Zn3]+N_T2Upt1[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T1Upt1[Zn1,P]+N_T1Upt1[Zn2,P]+N_T1Upt1[Zn3,P]+N_T1Upt1[Zn4,P]+N_T3Upt1[Zn1,P]+N_T3Upt1[Zn2,P]+N_T3Upt1[Zn3,P]+N_T3Upt1[Zn4,P])
    # T_NUpt1[P,Sp3] = N_T3Upt1[Zn1,P]*AF_ZoneFrac[Zn1]+N_T3Upt1[Zn2,P]*AF_ZoneFrac[Zn2]+N_T3Upt1[Zn3,P]*AF_ZoneFrac[Zn3]+N_T3Upt1[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt1[Zn1,P]+N_T2Upt1[Zn2,P]+N_T2Upt1[Zn3,P]+N_T2Upt1[Zn4,P]+N_T1Upt1[Zn1,P]+N_T1Upt1[Zn2,P]+N_T1Upt1[Zn3,P]+N_T1Upt1[Zn4,P])
    # T_NUpt2[N,Sp1] = N_T1Upt2[Zn1,N]*AF_ZoneFrac[Zn1]+N_T1Upt2[Zn2,N]*AF_ZoneFrac[Zn2]+N_T1Upt2[Zn3,N]*AF_ZoneFrac[Zn3]+N_T1Upt2[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt2[Zn1,N]+N_T2Upt2[Zn2,N]+N_T2Upt2[Zn3,N]+N_T2Upt2[Zn4,N]+N_T3Upt2[Zn1,N]+N_T3Upt2[Zn2,N]+N_T3Upt2[Zn3,N]+N_T3Upt2[Zn4,N])
    # T_NUpt2[N,Sp2] = N_T2Upt2[Zn1,N]*AF_ZoneFrac[Zn1]+N_T2Upt2[Zn2,N]*AF_ZoneFrac[Zn2]+N_T2Upt2[Zn3,N]*AF_ZoneFrac[Zn3]+N_T2Upt2[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T1Upt2[Zn1,N]+N_T1Upt2[Zn2,N]+N_T1Upt2[Zn3,N]+N_T1Upt2[Zn4,N]+N_T3Upt2[Zn1,N]+N_T3Upt2[Zn2,N]+N_T3Upt2[Zn3,N]+N_T3Upt2[Zn4,N])
    # T_NUpt2[N,Sp3] = N_T3Upt2[Zn1,N]*AF_ZoneFrac[Zn1]+N_T3Upt2[Zn2,N]*AF_ZoneFrac[Zn2]+N_T3Upt2[Zn3,N]*AF_ZoneFrac[Zn3]+N_T3Upt2[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt2[Zn1,N]+N_T2Upt2[Zn2,N]+N_T2Upt2[Zn3,N]+N_T2Upt2[Zn4,N]+N_T1Upt2[Zn1,N]+N_T1Upt2[Zn2,N]+N_T1Upt2[Zn3,N]+N_T1Upt2[Zn4,N])
    # T_NUpt2[P,Sp1] = N_T1Upt2[Zn1,P]*AF_ZoneFrac[Zn1]+N_T1Upt2[Zn2,P]*AF_ZoneFrac[Zn2]+N_T1Upt2[Zn3,P]*AF_ZoneFrac[Zn3]+N_T1Upt2[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt2[Zn1,P]+N_T2Upt2[Zn2,P]+N_T2Upt2[Zn3,P]+N_T2Upt2[Zn4,P]+N_T3Upt2[Zn1,P]+N_T3Upt2[Zn2,P]+N_T3Upt2[Zn3,P]+N_T3Upt2[Zn4,P])
    # T_NUpt2[P,Sp2] = N_T2Upt2[Zn1,P]*AF_ZoneFrac[Zn1]+N_T2Upt2[Zn2,P]*AF_ZoneFrac[Zn2]+N_T2Upt2[Zn3,P]*AF_ZoneFrac[Zn3]+N_T2Upt2[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T1Upt2[Zn1,P]+N_T1Upt2[Zn2,P]+N_T1Upt2[Zn3,P]+N_T1Upt2[Zn4,P]+N_T3Upt2[Zn1,P]+N_T3Upt2[Zn2,P]+N_T3Upt2[Zn3,P]+N_T3Upt2[Zn4,P])
    # T_NUpt2[P,Sp3] = N_T3Upt2[Zn1,P]*AF_ZoneFrac[Zn1]+N_T3Upt2[Zn2,P]*AF_ZoneFrac[Zn2]+N_T3Upt2[Zn3,P]*AF_ZoneFrac[Zn3]+N_T3Upt2[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt2[Zn1,P]+N_T2Upt2[Zn2,P]+N_T2Upt2[Zn3,P]+N_T2Upt2[Zn4,P]+N_T1Upt2[Zn1,P]+N_T1Upt2[Zn2,P]+N_T1Upt2[Zn3,P]+N_T1Upt2[Zn4,P])
    # T_NUpt3[N,Sp1] = N_T1Upt3[Zn1,N]*AF_ZoneFrac[Zn1]+N_T1Upt3[Zn2,N]*AF_ZoneFrac[Zn2]+N_T1Upt3[Zn3,N]*AF_ZoneFrac[Zn3]+N_T1Upt3[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt3[Zn1,N]+N_T2Upt3[Zn2,N]+N_T2Upt3[Zn3,N]+N_T2Upt3[Zn4,N]+N_T3Upt3[Zn1,N]+N_T3Upt3[Zn2,N]+N_T3Upt3[Zn3,N]+N_T3Upt3[Zn4,N])
    # T_NUpt3[N,Sp2] = N_T2Upt3[Zn1,N]*AF_ZoneFrac[Zn1]+N_T2Upt3[Zn2,N]*AF_ZoneFrac[Zn2]+N_T2Upt3[Zn3,N]*AF_ZoneFrac[Zn3]+N_T2Upt3[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T1Upt3[Zn1,N]+N_T1Upt3[Zn2,N]+N_T1Upt3[Zn3,N]+N_T1Upt3[Zn4,N]+N_T3Upt3[Zn1,N]+N_T3Upt3[Zn2,N]+N_T3Upt3[Zn3,N]+N_T3Upt3[Zn4,N])
    # T_NUpt3[N,Sp3] = N_T3Upt3[Zn1,N]*AF_ZoneFrac[Zn1]+N_T3Upt3[Zn2,N]*AF_ZoneFrac[Zn2]+N_T3Upt3[Zn3,N]*AF_ZoneFrac[Zn3]+N_T3Upt3[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T1Upt3[Zn1,N]+N_T1Upt3[Zn2,N]+N_T1Upt3[Zn3,N]+N_T1Upt3[Zn4,N]+N_T2Upt3[Zn1,N]+N_T2Upt3[Zn2,N]+N_T2Upt3[Zn3,N]+N_T2Upt3[Zn4,N])
    # T_NUpt3[P,Sp1] = N_T1Upt3[Zn1,P]*AF_ZoneFrac[Zn1]+N_T1Upt3[Zn2,P]*AF_ZoneFrac[Zn2]+N_T1Upt3[Zn3,P]*AF_ZoneFrac[Zn3]+N_T1Upt3[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt3[Zn1,P]+N_T2Upt3[Zn2,P]+N_T2Upt3[Zn3,P]+N_T2Upt3[Zn4,P]+N_T3Upt3[Zn1,P]+N_T3Upt3[Zn2,P]+N_T3Upt3[Zn3,P]+N_T3Upt3[Zn4,P])
    # T_NUpt3[P,Sp2] = N_T2Upt3[Zn1,P]*AF_ZoneFrac[Zn1]+N_T2Upt3[Zn2,P]*AF_ZoneFrac[Zn2]+N_T2Upt3[Zn3,P]*AF_ZoneFrac[Zn3]+N_T2Upt3[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T1Upt3[Zn1,P]+N_T1Upt3[Zn2,P]+N_T1Upt3[Zn3,P]+N_T1Upt3[Zn4,P]+N_T3Upt3[Zn1,P]+N_T3Upt3[Zn2,P]+N_T3Upt3[Zn3,P]+N_T3Upt3[Zn4,P])
    # T_NUpt3[P,Sp3] = N_T3Upt3[Zn1,P]*AF_ZoneFrac[Zn1]+N_T3Upt3[Zn2,P]*AF_ZoneFrac[Zn2]+N_T3Upt3[Zn3,P]*AF_ZoneFrac[Zn3]+N_T3Upt3[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt3[Zn1,P]+N_T2Upt3[Zn2,P]+N_T2Upt3[Zn3,P]+N_T2Upt3[Zn4,P]+N_T1Upt3[Zn1,P]+N_T1Upt3[Zn2,P]+N_T1Upt3[Zn3,P]+N_T1Upt3[Zn4,P])
    # T_NUpt4[N,Sp1] = N_T1Upt4[Zn1,N]*AF_ZoneFrac[Zn1]+N_T1Upt4[Zn2,N]*AF_ZoneFrac[Zn2]+N_T1Upt4[Zn3,N]*AF_ZoneFrac[Zn3]+N_T1Upt4[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt4[Zn1,N]+N_T2Upt4[Zn2,N]+N_T2Upt4[Zn3,N]+N_T2Upt4[Zn4,N]+N_T3Upt4[Zn1,N]+N_T3Upt4[Zn2,N]+N_T3Upt4[Zn3,N]+N_T3Upt4[Zn4,N])
    # T_NUpt4[N,Sp2] = N_T2Upt4[Zn1,N]*AF_ZoneFrac[Zn1]+N_T2Upt4[Zn2,N]*AF_ZoneFrac[Zn2]+N_T2Upt4[Zn3,N]*AF_ZoneFrac[Zn3]+N_T2Upt4[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T1Upt4[Zn1,N]+N_T1Upt4[Zn2,N]+N_T1Upt4[Zn3,N]+N_T1Upt4[Zn4,N]+N_T3Upt4[Zn1,N]+N_T3Upt4[Zn2,N]+N_T3Upt4[Zn3,N]+N_T3Upt4[Zn4,N])
    # T_NUpt4[N,Sp3] = N_T3Upt4[Zn1,N]*AF_ZoneFrac[Zn1]+N_T3Upt4[Zn2,N]*AF_ZoneFrac[Zn2]+N_T3Upt4[Zn3,N]*AF_ZoneFrac[Zn3]+N_T3Upt4[Zn4,N]*AF_ZoneFrac[Zn4]+0*(N_T2Upt4[Zn1,N]+N_T2Upt4[Zn2,N]+N_T2Upt4[Zn3,N]+N_T2Upt4[Zn4,N]+N_T1Upt4[Zn1,N]+N_T1Upt4[Zn2,N]+N_T1Upt4[Zn3,N]+N_T1Upt4[Zn4,N])
    # T_NUpt4[P,Sp1] = N_T1Upt4[Zn1,P]*AF_ZoneFrac[Zn1]+N_T1Upt4[Zn2,P]*AF_ZoneFrac[Zn2]+N_T1Upt4[Zn3,P]*AF_ZoneFrac[Zn3]+N_T1Upt4[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt4[Zn1,P]+N_T2Upt4[Zn2,P]+N_T2Upt4[Zn3,P]+N_T2Upt4[Zn4,P]+N_T3Upt4[Zn1,P]+N_T3Upt4[Zn2,P]+N_T3Upt4[Zn3,P]+N_T3Upt4[Zn4,P])
    # T_NUpt4[P,Sp2] = N_T2Upt4[Zn1,P]*AF_ZoneFrac[Zn1]+N_T2Upt4[Zn2,P]*AF_ZoneFrac[Zn2]+N_T2Upt4[Zn3,P]*AF_ZoneFrac[Zn3]+N_T2Upt4[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T1Upt4[Zn1,P]+N_T1Upt4[Zn2,P]+N_T1Upt4[Zn3,P]+N_T1Upt4[Zn4,P]+N_T3Upt4[Zn1,P]+N_T3Upt4[Zn2,P]+N_T3Upt4[Zn3,P]+N_T3Upt4[Zn4,P])
    # T_NUpt4[P,Sp3] = N_T3Upt4[Zn1,P]*AF_ZoneFrac[Zn1]+N_T3Upt4[Zn2,P]*AF_ZoneFrac[Zn2]+N_T3Upt4[Zn3,P]*AF_ZoneFrac[Zn3]+N_T3Upt4[Zn4,P]*AF_ZoneFrac[Zn4]+0*(N_T2Upt4[Zn1,P]+N_T2Upt4[Zn2,P]+N_T2Upt4[Zn3,P]+N_T2Upt4[Zn4,P]+N_T1Upt4[Zn1,P]+N_T1Upt4[Zn2,P]+N_T1Upt4[Zn3,P]+N_T1Upt4[Zn4,P])
    zonelayertreenut_df$N_Upt_Frac <- zonelayertreenut_df$N_Upt * zonelayertreenut_df$AF_ZoneFrac
    layertreenut_df$T_NUpt <- aggregate(zonelayertreenut_df["N_Upt_Frac"], zonelayertreenut_df[c("layer", "tree_id", "SlNut")], sum)$N_Upt_Frac
    
    # T_NUptRelV1[SlNut,Tree] = IF( RT_TAmountV1[Tree]>0.0001)THEN(100*AF_DepthAvg1*(T_NUpt1[SlNut,Tree])/RT_TAmountV1[Tree])ELSE(0)
    # T_NUptRelV2[SlNut,Tree] = IF( RT_TAmountV2[Tree]>0.0001)THEN(100*AF_DepthAvg2*(T_NUpt2[SlNut,Tree])/RT_TAmountV2[Tree])ELSE(0)
    # T_NUptRelV3[SlNut,Tree] = IF( RT_TAmountV3[Tree]>0.0001)THEN(100*AF_DepthAvg3*(T_NUpt3[SlNut,Tree])/RT_TAmountV3[Tree])ELSE(0)
    # T_NUptRelV4[SlNut,Tree] = IF( RT_TAmountV4[Tree]>0.0001)THEN(100*AF_DepthAvg4*(T_NUpt4[SlNut,Tree])/RT_TAmountV4[Tree])ELSE(0)
    layertreenut_df$RT_TAmountV <- rep(layertree_df$RT_TAmountV, nrow(nut_df))
    layertreenut_df$AF_DepthAvg <- rep(layer_df$AF_DepthAvg, ntree * nrow(nut_df))
    layertreenut_df$T_NUptRelV <- ifelse(
      layertreenut_df$RT_TAmountV > 0.0001,
      100 * layertreenut_df$AF_DepthAvg * (layertreenut_df$T_NUpt) / layertreenut_df$RT_TAmountV,
      0
    )
    
    # T_NUptRelV[SlNut,Tree] = IF( RT_ATType[Tree]=2 AND T_LfTwig[DW,Tree]>0 AND T_Prun[DW, Tree]=0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree] AND T_NUptTot[SlNut,Tree] >0)  THEN ((T_NUptRelV1[SlNut,Tree]+T_NUptRelV2[SlNut,Tree]-T_NUptRelV3[SlNut,Tree]-T_NUptRelV4[SlNut,Tree])/((AF_DepthAvg1+AF_DepthAvg2+AF_DepthAvg3+AF_DepthAvg4)*T_NUptTot[SlNut,Tree])/RT_TField[Tree])ELSE(1)
    treenut_df$AF_DepthAvg_sum <- aggregate(layertreenut_df["AF_DepthAvg"], layertreenut_df[c("tree_id", "SlNut")], sum)$AF_DepthAvg
    treenut_df$T_NUptRelV <- ifelse(
      treenut_df$RT_ATType == 2 &
        treenut_df$T_LfTwig_DW > 0 &
        treenut_df$T_Prun_DW == 0 &
        treenut_df$T_PrunLapse > treenut_df$T_PrunRecov &
        treenut_df$T_NUptTot > 0,
      (
        layertreenut_df[layertreenut_df$layer == 1, ]$T_NUptRelV +
          layertreenut_df[layertreenut_df$layer == 2, ]$T_NUptRelV -
          layertreenut_df[layertreenut_df$layer == 3, ]$T_NUptRelV -
          layertreenut_df[layertreenut_df$layer == 4, ]$T_NUptRelV
      ) / (treenut_df$AF_DepthAvg_sum * treenut_df$T_NUptTot) / treenut_df$RT_TField,
      1
    )
    
    # TW_Upt1[Sp1] = W_T1Upt1[Zn1]*AF_ZoneFrac[Zn1]+W_T1Upt1[Zn2]*AF_ZoneFrac[Zn2]+W_T1Upt1[Zn3]*AF_ZoneFrac[Zn3]+W_T1Upt1[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T2Upt1[Zn1]+W_T2Upt1[Zn2]+W_T2Upt1[Zn3]+W_T2Upt1[Zn4]+W_T3Upt1[Zn1]+W_T3Upt1[Zn2]+W_T3Upt1[Zn3]+W_T3Upt1[Zn4])
    # TW_Upt1[Sp2] = W_T2Upt1[Zn1]*AF_ZoneFrac[Zn1]+W_T2Upt1[Zn2]*AF_ZoneFrac[Zn2]+W_T2Upt1[Zn3]*AF_ZoneFrac[Zn3]+W_T2Upt1[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T1Upt1[Zn1]+W_T1Upt1[Zn2]+W_T1Upt1[Zn3]+W_T1Upt1[Zn4]+W_T3Upt1[Zn1]+W_T3Upt1[Zn2]+W_T3Upt1[Zn3]+W_T3Upt1[Zn4])
    # TW_Upt1[Sp3] = W_T3Upt1[Zn1]*AF_ZoneFrac[Zn1]+W_T3Upt1[Zn2]*AF_ZoneFrac[Zn2]+W_T3Upt1[Zn3]*AF_ZoneFrac[Zn3]+W_T3Upt1[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T2Upt1[Zn1]+W_T2Upt1[Zn2]+W_T2Upt1[Zn3]+W_T2Upt1[Zn4]+W_T1Upt1[Zn1]+W_T1Upt1[Zn2]+W_T1Upt1[Zn3]+W_T1Upt1[Zn4])
    # TW_Upt2[Sp1] = W_T1Upt2[Zn1]*AF_ZoneFrac[Zn1]+W_T1Upt2[Zn2]*AF_ZoneFrac[Zn2]+W_T1Upt2[Zn3]*AF_ZoneFrac[Zn3]+W_T1Upt2[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T2Upt2[Zn1]+W_T2Upt2[Zn2]+W_T2Upt2[Zn3]+W_T2Upt2[Zn4]+W_T3Upt2[Zn1]+W_T3Upt2[Zn2]+W_T3Upt2[Zn3]+W_T3Upt2[Zn4])
    # TW_Upt2[Sp2] = W_T2Upt2[Zn1]*AF_ZoneFrac[Zn1]+W_T2Upt2[Zn2]*AF_ZoneFrac[Zn2]+W_T2Upt2[Zn3]*AF_ZoneFrac[Zn3]+W_T2Upt2[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T1Upt2[Zn1]+W_T1Upt2[Zn2]+W_T1Upt2[Zn3]+W_T1Upt2[Zn4]+W_T3Upt2[Zn1]+W_T3Upt2[Zn2]+W_T3Upt2[Zn3]+W_T3Upt2[Zn4])
    # TW_Upt2[Sp3] = W_T3Upt2[Zn1]*AF_ZoneFrac[Zn1]+W_T3Upt2[Zn2]*AF_ZoneFrac[Zn2]+W_T3Upt2[Zn3]*AF_ZoneFrac[Zn3]+W_T3Upt2[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T2Upt2[Zn1]+W_T2Upt2[Zn2]+W_T2Upt2[Zn3]+W_T2Upt2[Zn4]+W_T1Upt2[Zn1]+W_T1Upt2[Zn2]+W_T1Upt2[Zn3]+W_T1Upt2[Zn4])
    # TW_Upt3[Sp1] = W_T1Upt3[Zn1]*AF_ZoneFrac[Zn1]+W_T1Upt3[Zn2]*AF_ZoneFrac[Zn2]+W_T1Upt3[Zn3]*AF_ZoneFrac[Zn3]+W_T1Upt3[Zn4]*AF_ZoneFrac[Zn4]+ 0*(W_T2Upt3[Zn1]+W_T2Upt3[Zn2]+W_T2Upt3[Zn3]+W_T2Upt3[Zn4]+W_T3Upt3[Zn1]+W_T3Upt3[Zn2]+W_T3Upt3[Zn3]+W_T3Upt3[Zn4])
    # TW_Upt3[Sp2] = W_T2Upt3[Zn1]*AF_ZoneFrac[Zn1]+W_T2Upt3[Zn2]*AF_ZoneFrac[Zn2]+W_T2Upt3[Zn3]*AF_ZoneFrac[Zn3]+W_T2Upt3[Zn4]*AF_ZoneFrac[Zn4]+ 0*(W_T1Upt3[Zn1]+W_T1Upt3[Zn2]+W_T1Upt3[Zn3]+W_T1Upt3[Zn4]+W_T3Upt3[Zn1]+W_T3Upt3[Zn2]+W_T3Upt3[Zn3]+W_T3Upt3[Zn4])
    # TW_Upt3[Sp3] = W_T3Upt3[Zn1]*AF_ZoneFrac[Zn1]+W_T3Upt3[Zn2]*AF_ZoneFrac[Zn2]+W_T3Upt3[Zn3]*AF_ZoneFrac[Zn3]+W_T3Upt3[Zn4]*AF_ZoneFrac[Zn4]+ 0*(W_T2Upt3[Zn1]+W_T2Upt3[Zn2]+W_T2Upt3[Zn3]+W_T2Upt3[Zn4]+W_T1Upt3[Zn1]+W_T1Upt3[Zn2]+W_T1Upt3[Zn3]+W_T1Upt3[Zn4])
    # TW_Upt4[Sp1] = W_T1Upt4[Zn1]*AF_ZoneFrac[Zn1]+W_T1Upt4[Zn2]*AF_ZoneFrac[Zn2]+W_T1Upt4[Zn3]*AF_ZoneFrac[Zn3]+W_T1Upt4[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T2Upt4[Zn1]+W_T2Upt4[Zn2]+W_T2Upt4[Zn3]+W_T2Upt4[Zn4]+W_T3Upt4[Zn1]+W_T3Upt4[Zn2]+W_T3Upt4[Zn3]+W_T3Upt4[Zn4])
    # TW_Upt4[Sp2] = W_T2Upt4[Zn1]*AF_ZoneFrac[Zn1]+W_T2Upt4[Zn2]*AF_ZoneFrac[Zn2]+W_T2Upt4[Zn3]*AF_ZoneFrac[Zn3]+W_T2Upt4[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T1Upt4[Zn1]+W_T1Upt4[Zn2]+W_T1Upt4[Zn3]+W_T1Upt4[Zn4]+W_T3Upt4[Zn1]+W_T3Upt4[Zn2]+W_T3Upt4[Zn3]+W_T3Upt4[Zn4])
    # TW_Upt4[Sp3] = W_T3Upt4[Zn1]*AF_ZoneFrac[Zn1]+W_T3Upt4[Zn2]*AF_ZoneFrac[Zn2]+W_T3Upt4[Zn3]*AF_ZoneFrac[Zn3]+W_T3Upt4[Zn4]*AF_ZoneFrac[Zn4]+0*(W_T2Upt4[Zn1]+W_T2Upt4[Zn2]+W_T2Upt4[Zn3]+W_T2Upt4[Zn4]+W_T1Upt4[Zn1]+W_T1Upt4[Zn2]+W_T1Upt4[Zn3]+W_T1Upt4[Zn4])
    zonelayertree_df$W_Upt_Frac <- zonelayertree_df$W_Upt * zonelayertree_df$AF_ZoneFrac
    layertree_df$TW_Upt <- aggregate(zonelayertree_df["W_Upt_Frac"], zonelayertree_df[c("layer", "tree_id")], sum)$W_Upt_Frac
    
    # TW_UptRelV1[Tree] = IF( RT_TAmountV1[Tree]>0.0001)THEN(100*AF_DepthAvg1*(TW_Upt1[Tree])/RT_TAmountV1[Tree])ELSE(0)
    # TW_UptRelV2[Tree] = IF( RT_TAmountV2[Tree]>0.0001)THEN(100*AF_DepthAvg2*(TW_Upt2[Tree])/RT_TAmountV2[Tree])ELSE(0)
    # TW_UptRelV3[Tree] = IF( RT_TAmountV3[Tree]>0.0001)THEN(100*AF_DepthAvg3*TW_Upt3[Tree]/RT_TAmountV3[Tree])ELSE(0)
    # TW_UptRelV4[Tree] = IF( RT_TAmountV4[Tree]>0.0001)THEN(100*AF_DepthAvg4*(TW_Upt4[Tree])/RT_TAmountV4[Tree])ELSE(0)
    layertree_df$AF_DepthAvg <- rep(layer_df$AF_DepthAvg, ntree)
    layertree_df$TW_UptRelV <- ifelse(
      layertree_df$RT_TAmountV > 0.0001,
      100 * layertree_df$AF_DepthAvg * (layertree_df$TW_Upt) / layertree_df$RT_TAmountV,
      0
    )
    
    # TW_UptRelV[Tree] = IF( RT_ATType[Tree]=2 AND T_LfTwig[DW,Tree]>0 AND T_Prun[DW, Tree]=0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree] AND TW_UptTot[Tree]>0)  THEN ((TW_UptRelV1[Tree]+TW_UptRelV2[Tree]-TW_UptRelV3[Tree]-TW_UptRelV4[Tree])/((AF_DepthAvg1+AF_DepthAvg2+AF_DepthAvg3+AF_DepthAvg4)*TW_UptTot[Tree])/RT_TField[Tree])ELSE(1)
    tree_df$TW_UptRelV <- ifelse(
      tree_df$RT_ATType == 2 &
        tree_df$T_LfTwig_DW > 0 &
        tree_df$T_Prun_DW == 0 &
        tree_df$T_PrunLapse > tree_df$T_PrunRecov &
        tree_df$TW_UptTot > 0,
      (
        layertree_df[layertree_df$layer == 1, ]$TW_UptRelV +
          layertree_df[layertree_df$layer == 2, ]$TW_UptRelV -
          layertree_df[layertree_df$layer == 3, ]$TW_UptRelV -
          layertree_df[layertree_df$layer == 4, ]$TW_UptRelV
      ) / (sum(layer_df$AF_DepthAvg) * tree_df$TW_UptTot) / tree_df$RT_TField,
      1
    )
    
    # RT_TUptRelV[Tree] = IF (T_NPosgro[N, Tree] < 1 OR T_NPosgro[P, Tree] < 1 OR TW_Posgro[Tree] <1) THEN IF (MIN(T_NPosgro[N, Tree],T_NPosgro[P, Tree],TW_Posgro[Tree]) = T_NPosgro[N, Tree]) then T_NUptRelV[N, Tree] else if (MIN(T_NPosgro[N, Tree],T_NPosgro[P, Tree],TW_Posgro[Tree]) = T_NPosgro[P, Tree]) then T_NUptRelV[P, Tree] else TW_UptRelV[Tree] ELSE 1
    tree_df$RT_TUptRelV <- ifelse (
      tree_df$T_NPosgro_N < 1 |
        tree_df$T_NPosgro_P < 1 | tree_df$TW_Posgro < 1,
      ifelse (
        pmin(
          tree_df$T_NPosgro_N,
          tree_df$T_NPosgro_P,
          tree_df$TW_Posgro
        ) == tree_df$T_NPosgro_N,
        treenut_df[treenut_df$SlNut == "N", ]$T_NUptRelV,
        ifelse (
          pmin(
            tree_df$T_NPosgro_N,
            tree_df$T_NPosgro_P,
            tree_df$TW_Posgro
          ) == tree_df$T_NPosgro_P,
          treenut_df[treenut_df$SlNut == "P", ]$T_NUptRelV,
          tree_df$TW_UptRelV
        )
      ),
      1
    )
    
    # RT_TDecDepthD[Tree] = IF(RT_ATType[Tree]=2 AND T_Prun[DW, Tree]=0 AND T_LfTwig[DW,Tree]>0 AND T_PrunLapse[Tree]>T_PrunRecov[Tree])THEN (MIN(1+RT_TRelChangeV[Tree], MAX((1+RT_TRelChangeV[Tree])^-1, RT_TUptRelV[Tree]^-RT_TDistResp[Tree])))ELSE(1)
    tree_df$RT_TDecDepthD <- ifelse(
      tree_df$RT_ATType == 2 &
        tree_df$T_Prun_DW == 0 &
        tree_df$T_LfTwig_DW > 0 &
        tree_df$T_PrunLapse > tree_df$T_PrunRecov,
      pmin(
        1 + tree_df$RT_TRelChangeV,
        pmax((1 + tree_df$RT_TRelChangeV)^-1,
             tree_df$RT_TUptRelV^-tree_df$RT_TDistResp
        )
      ),
      1
    )
    
    # RT_TDecDepthInc[Tree] = if T_DiesToday?[Tree]= 1 then - RT_TDecDepthAct[Tree] else IF(RT_ATType[Tree]=2)THEN(RT_TDecDepthAct[Tree]*(RT_TDecDepthD[Tree]-1))ELSE(0)
    tree_df$RT_TDecDepthInc <- ifelse(
      tree_df$T_DiesToday_is == 1,
      -tree_df$RT_TDecDepthAct,
      ifelse(
        tree_df$RT_ATType == 2,
        tree_df$RT_TDecDepthAct * (tree_df$RT_TDecDepthD - 1),
        0
      )
    )
    
    # RT_TDecDepthActInitPlantTree[Tree] = if time = T_PlantTime[Tree] then RT_TDecDepthC[Tree] else 0
    tree_df$RT_TDecDepthActInitPlantTree <- ifelse(time == tree_df$T_PlantTime, tree_df$RT_TDecDepthC, 0)
    
    # T_Sequen[Tree] = if ((T_Stage[Tree,VegGen] = 0) and( time > T_PlantTime[Tree] + 2)) then 1 else if T_Stage[Tree,VegGen] >= 2   then 1 else 0
    tree_df$T_Sequen <- ifelse ((tree_df$T_Stage_VegGen == 0) &
                                  (time > tree_df$T_PlantTime + 2),
                                1,
                                ifelse(tree_df$T_Stage_VegGen >= 2, 1, 0)
    )
    
    
    
    # C_RtAllocAct[Zone,SoilLayer] = IF RT_ACType<2  then 0 else if CQ_Stage[Zone]>0.05THEN(CQ_CRtAllocCurr[Zone] +(0.98 - CQ_CRtAllocCurr[Zone] )*(1 -( min(MIN(C_NPosgro[Zone,N],C_NPosgro[Zone,P]), CW_Posgro[Zone]))^(.0001 + RT_CRtAllocRespCurr[Zone]))) else CQ_CRtAllocCurr[Zone]
    zonelayer_df$CQ_Stage <- rep(zone_df$CQ_Stage, nlayer)
    zonelayer_df$CQ_CRtAllocCurr <- rep(zone_df$CQ_CRtAllocCurr, nlayer)
    zonelayer_df$C_NPosgro_N <- rep(zone_df$C_NPosgro_N, nlayer)
    zonelayer_df$C_NPosgro_P <- rep(zone_df$C_NPosgro_P, nlayer)
    zonelayer_df$CW_Posgro <- rep(zone_df$CW_Posgro, nlayer)
    zonelayer_df$RT_CRtAllocRespCurr <- rep(zone_df$RT_CRtAllocRespCurr, nlayer)
    
    zonelayer_df$C_RtAllocAct <- ifelse(
      zonelayer_df$RT_ACType < 2,
      0,
      ifelse(
        zonelayer_df$CQ_Stage > 0.05,
        zonelayer_df$CQ_CRtAllocCurr + (0.98 - zonelayer_df$CQ_CRtAllocCurr) *
          (1 - (pmin(
            pmin(zonelayer_df$C_NPosgro_N, zonelayer_df$C_NPosgro_P),
            zonelayer_df$CW_Posgro
          ))^(
            .0001 + zonelayer_df$RT_CRtAllocRespCurr
          )),
        zonelayer_df$CQ_CRtAllocCurr
      )
    )
    
    # N_TNUptDem1[Zone] = N_TNUptPot1[Zone,Sp1]*T_NNDemandZn[Zone,Sp1]+N_TNUptPot1[Zone,Sp2]*T_NNDemandZn[Zone,Sp2]+N_TNUptPot1[Zone,Sp3]*T_NNDemandZn[Zone,Sp3]
    # N_TNUptDem2[Zone] = N_TNUptPot2[Zone,Sp1]*T_NNDemandZn[Zone,Sp1]+N_TNUptPot2[Zone,Sp2]*T_NNDemandZn[Zone,Sp2]+N_TNUptPot2[Zone,Sp3]*T_NNDemandZn[Zone,Sp3]
    # N_TNUptDem3[Zone] = N_TNUptPot3[Zone,Sp1]*T_NNDemandZn[Zone,Sp1]+N_TNUptPot3[Zone,Sp2]*T_NNDemandZn[Zone,Sp2]+N_TNUptPot3[Zone,Sp3]*T_NNDemandZn[Zone,Sp3]
    # N_TNUptDem4[Zone] = N_TNUptPot4[Zone,Sp1]*T_NNDemandZn[Zone,Sp1]+N_TNUptPot4[Zone,Sp2]*T_NNDemandZn[Zone,Sp2]+N_TNUptPot4[Zone,Sp3]*T_NNDemandZn[Zone,Sp3]
    zonelayertree_df$N_TNUptPot_Demand <- zonelayertree_df$N_TNUptPot * zonelayertree_df$T_NNDemandZn
    zonelayer_df$N_TNUptDem <- aggregate(zonelayertree_df["N_TNUptPot_Demand"], zonelayertree_df[c("zone", "layer")], sum)$N_TNUptPot_Demand
    
    # N_RhizCShare1[Zone] = 1-ARRAYSUM(N_RhizTShare1[Zone,*])
    # N_RhizCShare2[Zone] = 1-ARRAYSUM(N_RhizTShare2[Zone,*])
    # N_RhizCShare3[Zone] = 1-ARRAYSUM(N_RhizTShare3[Zone,*])
    # N_RhizCShare4[Zone] = 1-ARRAYSUM(N_RhizTShare4[Zone,*])
    zonelayer_df$N_RhizTShare_sum <- aggregate(zonelayertree_df["N_RhizTShare"], zonelayertree_df[c("zone", "layer")], sum)$N_RhizTShare
    zonelayer_df$N_RhizCShare <- 1 - zonelayer_df$N_RhizTShare_sum
    
    # N_CTUptPot1[Zn1,N] = IF(N_CUptPot1[Zn1,N]>0 AND C_NDemand[Zn1,N]>0) THEN N_UptPot1[Zn1,N] * ((N_CUptPot1[Zn1,N] * C_NDemand[Zn1,N] / (N_CUptPot1[Zn1,N] * C_NDemand[Zn1,N] + N_TNUptDem1[Zn1]+0*(N_TPUptDem1[Zn1]+ N_RhizEffect1[Zn1]+N_RhizCShare1[Zn1])))) ELSE (0)
    # N_CTUptPot1[Zn1,P] = IF(N_CUptPot1[Zn1,P]>0 AND C_NDemand[Zn1,P]>0) THEN N_UptPot1[Zn1,P] * ((N_CUptPot1[Zn1,P] * C_NDemand[Zn1,P] / (N_CUptPot1[Zn1,P] * C_NDemand[Zn1,P] + 0*N_TNUptDem1[Zn1]+N_TPUptDem1[Zn1])) + N_RhizEffect1[Zn1] * N_RhizCShare1[Zn1]) / (1 + N_RhizEffect1[Zn1]) ELSE (0)
    # N_CTUptPot1[Zn2,N] = IF(N_CUptPot1[Zn2,N]>0 AND C_NDemand[Zn2,N]>0) THEN N_UptPot1[Zn2,N] * ((N_CUptPot1[Zn2,N] * C_NDemand[Zn2,N] / (N_CUptPot1[Zn2,N] * C_NDemand[Zn2,N] + N_TNUptDem1[Zn2]+0*(N_TPUptDem1[Zn2]+N_RhizEffect1[Zn2]+N_RhizCShare1[Zn2])))) ELSE (0)
    # N_CTUptPot1[Zn2,P] = IF(N_CUptPot1[Zn2,P]>0 AND C_NDemand[Zn2,P]>0) THEN N_UptPot1[Zn2,P] * ((N_CUptPot1[Zn2,P] * C_NDemand[Zn2,P] / (N_CUptPot1[Zn2,P] * C_NDemand[Zn2,P] + 0*N_TNUptDem1[Zn2]+N_TPUptDem1[Zn2])) + N_RhizEffect1[Zn2] * N_RhizCShare1[Zn2]) / (1 + N_RhizEffect1[Zn2]) ELSE (0)
    # N_CTUptPot1[Zn3,N] = IF(N_CUptPot1[Zn3,N]>0 AND C_NDemand[Zn3,N]>0) THEN N_UptPot1[Zn3,N] * ((N_CUptPot1[Zn3,N] * C_NDemand[Zn3,N] / (N_CUptPot1[Zn3,N] * C_NDemand[Zn3,N] + N_TNUptDem1[Zn3]+0*(N_TPUptDem1[Zn3]+N_RhizEffect1[Zn3]+N_RhizCShare1[Zn3])))) ELSE (0)
    # N_CTUptPot1[Zn3,P] = IF(N_CUptPot1[Zn3,P]>0 AND C_NDemand[Zn3,P]>0) THEN N_UptPot1[Zn3,P] * ((N_CUptPot1[Zn3,P] * C_NDemand[Zn3,P] / (N_CUptPot1[Zn3,P] * C_NDemand[Zn3,P] + 0*N_TNUptDem1[Zn3]+N_TPUptDem1[Zn3])) + N_RhizEffect1[Zn3] * N_RhizCShare1[Zn3]) / (1 + N_RhizEffect1[Zn3]) ELSE (0)
    # N_CTUptPot1[Zn4,N] = IF(N_CUptPot1[Zn4,N]>0 AND C_NDemand[Zn4,N]>0) THEN N_UptPot1[Zn4,N] * ((N_CUptPot1[Zn4,N] * C_NDemand[Zn4,N] / (N_CUptPot1[Zn4,N] * C_NDemand[Zn4,N] + N_TNUptDem1[Zn4]+0*(N_TPUptDem1[Zn4]+N_RhizCShare1[Zn4]+N_RhizEffect1[Zn4]))))ELSE (0)
    # N_CTUptPot1[Zn4,P] = IF(N_CUptPot1[Zn4,P]>0 AND C_NDemand[Zn4,P]>0) THEN N_UptPot1[Zn4,P] * ((N_CUptPot1[Zn4,P] * C_NDemand[Zn4,P] / (N_CUptPot1[Zn4,P] * C_NDemand[Zn4,P] + 0*N_TNUptDem1[Zn4]+N_TPUptDem1[Zn4])) + N_RhizEffect1[Zn4] * N_RhizCShare1[Zn4]) / (1 + N_RhizEffect1[Zn4]) ELSE (0)
    # N_CTUptPot2[Zn1,N] = IF(N_CUptPot2[Zn1,N]>0 AND C_NDemand[Zn1,N]>0) THEN N_UptPot2[Zn1,N] * ((N_CUptPot2[Zn1,N] * C_NDemand[Zn1,N] / (N_CUptPot2[Zn1,N] * C_NDemand[Zn1,N] + N_TNUptDem2[Zn1]+0*(N_TPUptDem2[Zn1] + N_RhizEffect2[Zn1] + N_RhizCShare2[Zn1])))) ELSE (0)
    # N_CTUptPot2[Zn1,P] = IF(N_CUptPot2[Zn1,P]>0 AND C_NDemand[Zn1,P]>0) THEN N_UptPot2[Zn1,P] * ((N_CUptPot2[Zn1,P] * C_NDemand[Zn1,P] / (N_CUptPot2[Zn1,P] * C_NDemand[Zn1,P] + 0*N_TNUptDem2[Zn1]+N_TPUptDem2[Zn1])) + N_RhizEffect2[Zn1] * N_RhizCShare2[Zn1]) / (1 + N_RhizEffect2[Zn1]) ELSE (0)
    # N_CTUptPot2[Zn2,N] = IF(N_CUptPot2[Zn2,N]>0 AND C_NDemand[Zn2,N]>0) THEN N_UptPot2[Zn2,N] * ((N_CUptPot2[Zn2,N] * C_NDemand[Zn2,N] / (N_CUptPot2[Zn2,N] * C_NDemand[Zn2,N] + N_TNUptDem2[Zn2]+0*(N_TPUptDem2[Zn2]+N_RhizEffect2[Zn2]+N_RhizCShare2[Zn2])))) ELSE (0)
    # N_CTUptPot2[Zn2,P] = IF(N_CUptPot2[Zn2,P]>0 AND C_NDemand[Zn2,P]>0) THEN N_UptPot2[Zn2,P] * ((N_CUptPot2[Zn2,P] * C_NDemand[Zn2,P] / (N_CUptPot2[Zn2,P] * C_NDemand[Zn2,P] + 0*N_TNUptDem2[Zn2]+N_TPUptDem2[Zn2])) + N_RhizEffect2[Zn2] * N_RhizCShare2[Zn2]) / (1 + N_RhizEffect2[Zn2]) ELSE (0)
    # N_CTUptPot2[Zn3,N] = IF(N_CUptPot2[Zn3,N]>0 AND C_NDemand[Zn3,N]>0) THEN N_UptPot2[Zn3,N] * ((N_CUptPot2[Zn3,N] * C_NDemand[Zn3,N] / (N_CUptPot2[Zn3,N] * C_NDemand[Zn3,N] + N_TNUptDem2[Zn3]+0*(N_TPUptDem2[Zn3] + N_RhizEffect2[Zn3]+ N_RhizCShare2[Zn3])))) ELSE (0)
    # N_CTUptPot2[Zn3,P] = IF(N_CUptPot2[Zn3,P]>0 AND C_NDemand[Zn3,P]>0) THEN N_UptPot2[Zn3,P] * ((N_CUptPot2[Zn3,P] * C_NDemand[Zn3,P] / (N_CUptPot2[Zn3,P] * C_NDemand[Zn3,P] + 0*N_TNUptDem2[Zn3]+N_TPUptDem2[Zn3])) + N_RhizEffect2[Zn3] * N_RhizCShare2[Zn3]) / (1 + N_RhizEffect2[Zn3]) ELSE (0)
    # N_CTUptPot2[Zn4,N] = IF(N_CUptPot2[Zn4,N]>0 AND C_NDemand[Zn4,N]>0) THEN N_UptPot2[Zn4,N] * ((N_CUptPot2[Zn4,N] * C_NDemand[Zn4,N] / (N_CUptPot2[Zn4,N] * C_NDemand[Zn4,N] + N_TNUptDem2[Zn4]+0*(N_TPUptDem2[Zn4] + N_RhizEffect2[Zn4] + N_RhizCShare2[Zn4])))) ELSE (0)
    # N_CTUptPot2[Zn4,P] = IF(N_CUptPot2[Zn4,P]>0 AND C_NDemand[Zn4,P]>0) THEN N_UptPot2[Zn4,P] * ((N_CUptPot2[Zn4,P] * C_NDemand[Zn4,P] / (N_CUptPot2[Zn4,P] * C_NDemand[Zn4,P] + 0*N_TNUptDem2[Zn4]+N_TPUptDem2[Zn4])) + N_RhizEffect2[Zn4] * N_RhizCShare2[Zn4]) / (1 + N_RhizEffect2[Zn4]) ELSE (0)
    # N_CTUptPot3[Zn1,N] = IF(N_CUptPot3[Zn1,N]>0 AND C_NDemand[Zn1,N]>0) THEN N_UptPot3[Zn1,N] * ((N_CUptPot3[Zn1,N] * C_NDemand[Zn1,N] / (N_CUptPot3[Zn1,N] * C_NDemand[Zn1,N] + N_TNUptDem3[Zn1]+0*(N_TPUptDem3[Zn1] + N_RhizEffect3[Zn1]+ N_RhizCShare3[Zn1])))) ELSE (0)
    # N_CTUptPot3[Zn1,P] = IF(N_CUptPot3[Zn1,P]>0 AND C_NDemand[Zn1,P]>0) THEN N_UptPot3[Zn1,P] * ((N_CUptPot3[Zn1,P] * C_NDemand[Zn1,P] / (N_CUptPot3[Zn1,P] * C_NDemand[Zn1,P] + 0*N_TNUptDem3[Zn1]+N_TPUptDem3[Zn1])) + N_RhizEffect3[Zn1] * N_RhizCShare3[Zn1]) / (1 + N_RhizEffect3[Zn1]) ELSE (0)
    # N_CTUptPot3[Zn2,N] = IF(N_CUptPot3[Zn2,N]>0 AND C_NDemand[Zn2,N]>0) THEN N_UptPot3[Zn2,N] * ((N_CUptPot3[Zn2,N] * C_NDemand[Zn2,N] / (N_CUptPot3[Zn2,N] * C_NDemand[Zn2,N] + N_TNUptDem3[Zn2]+0*(N_TPUptDem3[Zn2] + N_RhizEffect3[Zn2] +N_RhizCShare3[Zn2])))) ELSE (0)
    # N_CTUptPot3[Zn2,P] = IF(N_CUptPot3[Zn2,P]>0 AND C_NDemand[Zn2,P]>0) THEN N_UptPot3[Zn2,P] * ((N_CUptPot3[Zn2,P] * C_NDemand[Zn2,P] / (N_CUptPot3[Zn2,P] * C_NDemand[Zn2,P] + 0*N_TNUptDem3[Zn2]+N_TPUptDem3[Zn2])) + N_RhizEffect3[Zn2] * N_RhizCShare3[Zn2]) / (1 + N_RhizEffect3[Zn2]) ELSE (0)
    # N_CTUptPot3[Zn3,N] = IF(N_CUptPot3[Zn3,N]>0 AND C_NDemand[Zn3,N]>0) THEN N_UptPot3[Zn3,N] * ((N_CUptPot3[Zn3,N] * C_NDemand[Zn3,N] / (N_CUptPot3[Zn3,N] * C_NDemand[Zn3,N] + N_TNUptDem3[Zn3]+0*(N_TPUptDem3[Zn3] + N_RhizEffect3[Zn3]+ N_RhizCShare3[Zn3])))) ELSE (0)
    # N_CTUptPot3[Zn3,P] = IF(N_CUptPot3[Zn3,P]>0 AND C_NDemand[Zn3,P]>0) THEN N_UptPot3[Zn3,P] * ((N_CUptPot3[Zn3,P] * C_NDemand[Zn3,P] / (N_CUptPot3[Zn3,P] * C_NDemand[Zn3,P] + 0*N_TNUptDem3[Zn3]+N_TPUptDem3[Zn3])) + N_RhizEffect3[Zn3] * N_RhizCShare3[Zn3]) / (1 + N_RhizEffect3[Zn3]) ELSE (0)
    # N_CTUptPot3[Zn4,N] = IF(N_CUptPot3[Zn4,N]>0 AND C_NDemand[Zn4,N]>0) THEN N_UptPot3[Zn4,N] * ((N_CUptPot3[Zn4,N] * C_NDemand[Zn4,N] / (N_CUptPot3[Zn4,N] * C_NDemand[Zn4,N] + N_TNUptDem3[Zn4]+0*(N_TPUptDem3[Zn4] + N_RhizEffect3[Zn4]+ N_RhizCShare3[Zn4])))) ELSE (0)
    # N_CTUptPot3[Zn4,P] = IF(N_CUptPot3[Zn4,P]>0 AND C_NDemand[Zn4,P]>0) THEN N_UptPot3[Zn4,P] * ((N_CUptPot3[Zn4,P] * C_NDemand[Zn4,P] / (N_CUptPot3[Zn4,P] * C_NDemand[Zn4,P] + 0*N_TNUptDem3[Zn4]+N_TPUptDem3[Zn4])) + N_RhizEffect3[Zn4] * N_RhizCShare3[Zn4]) / (1 + N_RhizEffect3[Zn4]) ELSE (0)
    # N_CTUptPot4[Zn1,N] = IF(N_CUptPot4[Zn1,N]>0 AND C_NDemand[Zn1,N]>0) THEN N_UptPot4[Zn1,N] * ((N_CUptPot4[Zn1,N] * C_NDemand[Zn1,N] / (N_CUptPot4[Zn1,N] * C_NDemand[Zn1,N] + N_TNUptDem4[Zn1]+0*(N_TPUptDem4[Zn1] + N_RhizEffect4[Zn1] + N_RhizCShare4[Zn1])))) ELSE (0)
    # N_CTUptPot4[Zn1,P] = IF(N_CUptPot4[Zn1,P]>0 AND C_NDemand[Zn1,P]>0) THEN N_UptPot4[Zn1,P] * ((N_CUptPot4[Zn1,P] * C_NDemand[Zn1,P] / (N_CUptPot4[Zn1,P] * C_NDemand[Zn1,P] + 0*N_TNUptDem4[Zn1]+N_TPUptDem4[Zn1])) + N_RhizEffect4[Zn1] * N_RhizCShare4[Zn1]) / (1 + N_RhizEffect4[Zn1]) ELSE (0)
    # N_CTUptPot4[Zn2,N] = IF(N_CUptPot4[Zn2,N]>0 AND C_NDemand[Zn2,N]>0) THEN N_UptPot4[Zn2,N] * ((N_CUptPot4[Zn2,N] * C_NDemand[Zn2,N] / (N_CUptPot4[Zn2,N] * C_NDemand[Zn2,N] + N_TNUptDem4[Zn2]+0*(N_TPUptDem4[Zn2] + N_RhizEffect4[Zn2] + N_RhizCShare4[Zn2])))) ELSE (0)
    # N_CTUptPot4[Zn2,P] = IF(N_CUptPot4[Zn2,P]>0 AND C_NDemand[Zn2,P]>0) THEN N_UptPot4[Zn2,P] * ((N_CUptPot4[Zn2,P] * C_NDemand[Zn2,P] / (N_CUptPot4[Zn2,P] * C_NDemand[Zn2,P] + 0*N_TNUptDem4[Zn2]+N_TPUptDem4[Zn2])) + N_RhizEffect4[Zn2] * N_RhizCShare4[Zn2]) / (1 + N_RhizEffect4[Zn2]) ELSE (0)
    # N_CTUptPot4[Zn3,N] = IF(N_CUptPot4[Zn3,N]>0 AND C_NDemand[Zn3,N]>0) THEN N_UptPot4[Zn3,N] * ((N_CUptPot4[Zn3,N] * C_NDemand[Zn3,N] / (N_CUptPot4[Zn3,N] * C_NDemand[Zn3,N] + N_TNUptDem4[Zn3]+0*(N_TPUptDem4[Zn3] + N_RhizEffect4[Zn3]+ N_RhizCShare4[Zn3])))) ELSE (0)
    # N_CTUptPot4[Zn3,P] = IF(N_CUptPot4[Zn3,P]>0 AND C_NDemand[Zn3,P]>0) THEN N_UptPot4[Zn3,P] * ((N_CUptPot4[Zn3,P] * C_NDemand[Zn3,P] / (N_CUptPot4[Zn3,P] * C_NDemand[Zn3,P] + 0*N_TNUptDem4[Zn3]+N_TPUptDem4[Zn3])) + N_RhizEffect4[Zn3] * N_RhizCShare4[Zn3]) / (1 + N_RhizEffect4[Zn3]) ELSE (0)
    # N_CTUptPot4[Zn4,N] = IF(N_CUptPot4[Zn4,N]>0 AND C_NDemand[Zn4,N]>0) THEN N_UptPot4[Zn4,N] * ((N_CUptPot4[Zn4,N] * C_NDemand[Zn4,N] / (N_CUptPot4[Zn4,N] * C_NDemand[Zn4,N] + N_TNUptDem4[Zn4]+0*(N_TPUptDem4[Zn4] + N_RhizEffect4[Zn4] + N_RhizCShare4[Zn4])))) ELSE (0)
    # N_CTUptPot4[Zn4,P] = IF(N_CUptPot4[Zn4,P]>0 AND C_NDemand[Zn4,P]>0) THEN N_UptPot4[Zn4,P] * ((N_CUptPot4[Zn4,P] * C_NDemand[Zn4,P] / (N_CUptPot4[Zn4,P] * C_NDemand[Zn4,P] + 0*N_TNUptDem4[Zn4]+N_TPUptDem4[Zn4])) + N_RhizEffect4[Zn4] * N_RhizCShare4[Zn4]) / (1 + N_RhizEffect4[Zn4]) ELSE (0)
    zonelayernut_df$N_CTUptPot <- NA
    zonelayer_df$C_NDemand_N <- rep(zonenut_df[zonenut_df$SlNut == "N", "C_NDemand"], nlayer)
    zonelayer_df$C_NDemand_P <- rep(zonenut_df[zonenut_df$SlNut == "P", "C_NDemand"], nlayer)
    zln_N <- zonelayernut_df[zonelayernut_df$SlNut == "N", c("N_CUptPot", "N_UptPot")]
    zln_P <- zonelayernut_df[zonelayernut_df$SlNut == "P", c("N_CUptPot", "N_UptPot")]
    
    zonelayernut_df[zonelayernut_df$SlNut == "N", "N_CTUptPot"] <- ifelse(
      zln_N$N_CUptPot > 0 &
        zonelayer_df$C_NDemand_N > 0,
      zln_N$N_UptPot * (
        zln_N$N_CUptPot * zonelayer_df$C_NDemand_N / (
          zln_N$N_CUptPot * zonelayer_df$C_NDemand_N + zonelayer_df$N_TNUptDem
        )
      ),
      0
    )
    zonelayernut_df[zonelayernut_df$SlNut == "P", "N_CTUptPot"] <- ifelse(
      zln_P$N_CUptPot > 0 &
        zonelayer_df$C_NDemand_P > 0,
      zln_P$N_UptPot * ((
        zln_P$N_CUptPot * zonelayer_df$C_NDemand_P / (
          zln_P$N_CUptPot * zonelayer_df$C_NDemand_P + zonelayer_df$N_TPUptDem
        )
      ) + zonelayer_df$N_RhizEffect * zonelayer_df$N_RhizCShare
      ) / (1 + zonelayer_df$N_RhizEffect),
      0
    )
    
    # N_CUptPotAct1[Zone,SlNut] = MIN(N_CTUptPot1[Zone,SlNut],N_CUptPot1[Zone,SlNut])
    # N_CUptPotAct2[Zone,SlNut] = MIN(N_CTUptPot2[Zone,SlNut],N_CUptPot2[Zone,SlNut])
    # N_CUptPotAct3[Zone,SlNut] = MIN(N_CTUptPot3[Zone,SlNut],N_CUptPot3[Zone,SlNut])
    # N_CUptPotAct4[Zone,SlNut] = MIN(N_CTUptPot4[Zone,SlNut],N_CUptPot4[Zone,SlNut])
    zonelayernut_df$N_CUptPotAct <- pmin(zonelayernut_df$N_CTUptPot, zonelayernut_df$N_CUptPot)
    
    # C_NUptDeno[Zone,SlNut] = RT_CLrv1[Zone]*N_CUptPotAct1[Zone,SlNut]+RT_CLrv2[Zone]*N_CUptPotAct2[Zone,SlNut]+RT_CLrv3[Zone]*N_CUptPotAct3[Zone,SlNut]+RT_CLrv4[Zone]*N_CUptPotAct4[Zone,SlNut]
    zonelayernut_df$N_CUptPotAct_CLrv <- zonelayernut_df$RT_CLrv * zonelayernut_df$N_CUptPotAct
    zonenut_df$C_NUptDeno <- aggregate(zonelayernut_df["N_CUptPotAct_CLrv"], zonelayernut_df[c("zone", "SlNut")], sum)$N_CUptPotAct_CLrv
    
    # C_NUptPot[Zone,SlNut] = N_CUptPotAct1[Zone,SlNut]+N_CUptPotAct2[Zone,SlNut]+N_CUptPotAct3[Zone,SlNut]+N_CUptPotAct4[Zone,SlNut]
    zonenut_df$C_NUptPot <- aggregate(zonelayernut_df["N_CUptPotAct"], zonelayernut_df[c("zone", "SlNut")], sum)$N_CUptPotAct
    
    # N_CUpt1[Zone,SlNut] = IF(C_NUptDeno[Zone,SlNut]>0)THEN(IF(C_NUptPot[Zone,SlNut]>C_NDemand[Zone,SlNut])THEN(C_NDemand[Zone,SlNut]*N_CUptPotAct1[Zone,SlNut]*RT_CLrv1[Zone]/C_NUptDeno[Zone,SlNut])ELSE(N_CUptPotAct1[Zone,SlNut]))ELSE(0)
    # N_CUpt2[Zone,SlNut] = IF(C_NUptDeno[Zone,SlNut]>0)THEN(IF(C_NUptPot[Zone,SlNut]>C_NDemand[Zone,SlNut])THEN(C_NDemand[Zone,SlNut]*N_CUptPotAct2[Zone,SlNut]*RT_CLrv2[Zone]/C_NUptDeno[Zone,SlNut])ELSE(N_CUptPotAct2[Zone,SlNut]))ELSE(0)
    # N_CUpt3[Zone,SlNut] = IF(C_NUptDeno[Zone,SlNut]>0)THEN(IF(C_NUptPot[Zone,SlNut]>C_NDemand[Zone,SlNut])THEN(C_NDemand[Zone,SlNut]*N_CUptPotAct3[Zone,SlNut]*RT_CLrv3[Zone]/C_NUptDeno[Zone,SlNut])ELSE(N_CUptPotAct3[Zone,SlNut]))ELSE(0)
    # N_CUpt4[Zone,SlNut] = IF(C_NUptDeno[Zone,SlNut]>0)THEN(IF(C_NUptPot[Zone,SlNut]>C_NDemand[Zone,SlNut])THEN(C_NDemand[Zone,SlNut]*N_CUptPotAct4[Zone,SlNut]*RT_CLrv4[Zone]/C_NUptDeno[Zone,SlNut])ELSE(N_CUptPotAct4[Zone,SlNut]))ELSE(0)
    zn_N <- zonenut_df[zonenut_df$SlNut == "N", c("zone", "C_NUptDeno", "C_NUptPot", "C_NDemand")]
    zn_P <- zonenut_df[zonenut_df$SlNut == "P", c("zone", "C_NUptDeno", "C_NUptPot", "C_NDemand")]
    zonelayernut_df$C_NUptDeno <- c(rep(zn_N$C_NUptDeno, nlayer),
                                    rep(zn_P$C_NUptDeno, nlayer))
    zonelayernut_df$C_NUptPot <- c(rep(zn_N$C_NUptPot, nlayer), rep(zn_P$C_NUptPot, nlayer))
    zonelayernut_df$C_NDemand <- c(rep(zn_N$C_NDemand, nlayer), rep(zn_P$C_NDemand, nlayer))
    
    zonelayernut_df$N_CUpt <- ifelse(
      zonelayernut_df$C_NUptDeno > 0,
      ifelse(
        zonelayernut_df$C_NUptPot > zonelayernut_df$C_NDemand,
        zonelayernut_df$C_NDemand * zonelayernut_df$N_CUptPotAct * zonelayernut_df$RT_CLrv /
          zonelayernut_df$C_NUptDeno,
        zonelayernut_df$N_CUptPotAct
      ),
      0
    )
    
    # C_NUptTot[Zone,SlNut] = N_CUpt1[Zone,SlNut]+N_CUpt2[Zone,SlNut]+N_CUpt3[Zone,SlNut]+N_CUpt4[Zone,SlNut]
    zonenut_df$C_NUptTot <- aggregate(zonelayernut_df["N_CUpt"], zonelayernut_df[c("zone", "SlNut")], sum)$N_CUpt
    
    # C_Init[Zone,PlantComp] = IF(TIME=(int(CA_PlantTime[Zone]) )) and  P_PrevCropOK? =  1 THEN AF_Crop?*CQ_GSeedCurr[Zone]*C_UnitConv[PlantComp]*C_SeedConc[PlantComp] else 0
    zonepcomp_df$CA_PlantTime <- rep(zone_df$CA_PlantTime, nrow(pcomp_df))
    zonepcomp_df$P_PrevCropOK_is <- P_PrevCropOK_is
    zonepcomp_df$CQ_GSeedCurr <- rep(zone_df$CQ_GSeedCurr, nrow(pcomp_df))
    zonepcomp_df$C_UnitConv <- rep(pcomp_df$C_UnitConv, each = nzone)
    # zonepcomp_df$C_SeedConc <- rep(pcomp_df$C_SeedConc, each = nzone)
    
    zonepcomp_df$C_Init <- ifelse(
      time == floor(zonepcomp_df$CA_PlantTime)  &
        zonepcomp_df$P_PrevCropOK_is ==  1,
      AF_Crop_is * zonepcomp_df$CQ_GSeedCurr * zonepcomp_df$C_UnitConv * zonepcomp_df$C_SeedConc,
      0
    )
    
    # C_BiomInc[Zn1,DW]=  C_Init[Zn1,DW] + (C_PotGroRed[Zn1]*MIN(CW_Posgro[Zn1],C_NPosgro[Zn1,N],C_NPosgro[Zn1,P])) + 0*(C_NUptTot[Zn1,N]+C_NFIX[Zn1,N])
    # C_BiomInc[Zn1,N] =  C_Init[Zn1,N]+   C_NUptTot[Zn1,N]+C_NFIX[Zn1,N]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn1,P] =  C_Init[Zn1,P]+   C_NUptTot[Zn1,P]+C_NFIX[Zn1,P]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn2,DW]=  C_Init[Zn2,DW] + (C_PotGroRed[Zn2]*MIN(CW_Posgro[Zn2],C_NPosgro[Zn2,N],C_NPosgro[Zn2,P])) + 0*(C_NUptTot[Zn2,N]+C_NFIX[Zn2,N])
    # C_BiomInc[Zn2,N] =  C_Init[Zn2,N]+   C_NUptTot[Zn2,N]+C_NFIX[Zn2,N]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn2,P] =  C_Init[Zn2,P]+   C_NUptTot[Zn2,P]+C_NFIX[Zn2,P]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn3,DW]=  C_Init[Zn3,DW] + (C_PotGroRed[Zn3]*MIN(CW_Posgro[Zn3],C_NPosgro[Zn3,N],C_NPosgro[Zn3,P])) + 0*(C_NUptTot[Zn3,N]+C_NFIX[Zn1,N])
    # C_BiomInc[Zn3,N] =  C_Init[Zn3,N]+   C_NUptTot[Zn3,N]+C_NFIX[Zn3,N]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn3,P] =  C_Init[Zn3,P]+   C_NUptTot[Zn3,P]+C_NFIX[Zn3,P]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn4,DW]=  C_Init[Zn4,DW] + (C_PotGroRed[Zn4]*MIN(CW_Posgro[Zn4],C_NPosgro[Zn4,N],C_NPosgro[Zn4,P])) + 0*(C_NUptTot[Zn4,N]+C_NFIX[Zn1,N])
    # C_BiomInc[Zn4,N] =  C_Init[Zn4,N]  + C_NUptTot[Zn4,N]+C_NFIX[Zn4,N]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    # C_BiomInc[Zn4,P] =  C_Init[Zn4,P]+   C_NUptTot[Zn4,P]+C_NFIX[Zn4,P]+ 0*(C_PotGroRed[Zn1]+CW_Posgro[Zn1]+C_NPosgro[Zn1,N])
    zonepcomp_df$C_BiomInc <- NA
    zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomInc"] <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Init"] + (
      zone_df$C_PotGroRed * pmin(
        zone_df$CW_Posgro,
        zone_df$C_NPosgro_N,
        zone_df$C_NPosgro_P
      )
    )
    zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_BiomInc"] <-  zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_Init"] + zonenut_df$C_NUptTot + zonenut_df$C_NFIX
    
    # C_RootGrowth[Zone,PlantComp] = IF C_PlantDiesToday?[Zone]=0 then C_GroResMobFrac*C_BiomInc[Zone,PlantComp]*(ARRAYSUM(C_RtAllocAct[Zone,*]))/(1-ARRAYSUM(C_RtAllocAct[Zone,*])) else 0
    zone_df$C_RtAllocAct_sum <- aggregate(zonelayer_df["C_RtAllocAct"], zonelayer_df["zone"], sum)$C_RtAllocAct
    zonepcomp_df$C_RtAllocAct_sum <- rep(zone_df$C_RtAllocAct_sum, nrow(pcomp_df))
    zonepcomp_df$C_RootGrowth <- ifelse(
      zonepcomp_df$C_PlantDiesToday_is == 0,
      C_GroResMobFrac * zonepcomp_df$C_BiomInc * zonepcomp_df$C_RtAllocAct_sum /
        (1 - zonepcomp_df$C_RtAllocAct_sum),
      0
    )
    
    
    
    # C_RtIncr_DW[Zone,SoilLayer] = C_RtAllocAct[Zone,SoilLayer]*(C_Init[Zone,DW]+C_RootGrowth[Zone,DW])
    # C_RtIncr_N[Zone,SoilLayer] = C_RtAllocAct[Zone,SoilLayer]*(C_Init[Zone,N]+C_RootGrowth[Zone,N])
    # C_RtIncr_P[Zone,SoilLayer] = C_RtAllocAct[Zone,SoilLayer]*(C_Init[Zone,P]+C_RootGrowth[Zone,P])
    zonelayerpcomp_df$C_RtAllocAct <- rep(zonelayer_df$C_RtAllocAct)
    zp_DW <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", ]
    zp_N <- zonepcomp_df[zonepcomp_df$PlantComp == "N", ]
    zp_P <- zonepcomp_df[zonepcomp_df$PlantComp == "P", ]
    zonelayerpcomp_df$C_Init <- c(rep(zp_DW$C_Init, nlayer),
                                  rep(zp_N$C_Init, nlayer),
                                  rep(zp_P$C_Init, nlayer))
    zonelayerpcomp_df$C_RootGrowth <- c(
      rep(zp_DW$C_RootGrowth, nlayer),
      rep(zp_N$C_RootGrowth, nlayer),
      rep(zp_P$C_RootGrowth, nlayer)
    )
    
    zonelayerpcomp_df$C_RtIncr <- zonelayerpcomp_df$C_RtAllocAct * (zonelayerpcomp_df$C_Init + zonelayerpcomp_df$C_RootGrowth)
    
    
    
    # RT_CRelChange[Zone] = IF(RT_ACType=2 AND CQ_Stage[Zone]>0.07  AND RT_CLraCurr[Zone]>0)THEN((ARRAYSUM(C_RtIncr_DW[Zone,*])-ARRAYSUM(C_RtDecay_DW[Zone,*]))*1000*RT_CSRLCurr[Zone]/RT_CLraCurr[Zone])ELSE(0)
    zonelayer_df$C_RtIncr_DW <- zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "DW", "C_RtIncr"]
    zone_df$C_RtIncr_DW_sum <- aggregate(zonelayer_df["C_RtIncr_DW"], zonelayer_df["zone"], sum)$C_RtIncr_DW
    zonelayer_df$C_RtDecay_DW <- zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "DW", "C_RtDecay"]
    zone_df$C_RtDecay_DW_sum <- aggregate(zonelayer_df["C_RtDecay_DW"], zonelayer_df["zone"], sum)$C_RtDecay_DW
    
    zone_df$RT_CRelChange <- ifelse(
      zone_df$RT_ACType == 2 &
        zone_df$CQ_Stage > 0.07  &
        zone_df$RT_CLraCurr > 0,
      (zone_df$C_RtIncr_DW_sum - zone_df$C_RtDecay_DW_sum) * 1000 * zone_df$RT_CSRLCurr /
        zone_df$RT_CLraCurr,
      0
    )
    
    # C_NUptRelDeno[Zone,SlNut] = ((AF_HGW1[Zone]+AF_HGW2[Zone]+AF_HGW3[Zone]+AF_HGW4[Zone])*(N_CUpt1[Zone,SlNut]+N_CUpt2[Zone,SlNut]+N_CUpt3[Zone,SlNut]+N_CUpt4[Zone,SlNut]))
    zone_df$AF_HGW_sum <- aggregate(zonelayer_df["AF_HGW"], zonelayer_df["zone"], sum)$AF_HGW
    zonenut_df$AF_HGW_sum <- rep(zone_df$AF_HGW_sum, nrow(nut_df))
    zonenut_df$N_CUpt_sum <- aggregate(zonelayernut_df["N_CUpt"], zonelayernut_df[c("zone", "SlNut")] , sum)$N_CUpt
    zonenut_df$C_NUptRelDeno <- zonenut_df$AF_HGW_sum * zonenut_df$N_CUpt_sum
    
    #TODO: make sure the rep array is updated after the value updated "on the dynamic loop!"
    
    # C_NUptRel1[Zone,SlNut] = IF( RT_CAmount1[Zone]>0.0001)THEN(100*AF_HGW1[Zone]*N_CUpt1[Zone,SlNut]/RT_CAmount1[Zone])ELSE(0)
    # C_NUptRel2[Zone,SlNut] = IF( RT_CAmount2[Zone]>0.0001)THEN(100*AF_HGW2[Zone]*N_CUpt2[Zone,SlNut]/RT_CAmount2[Zone])ELSE(0)
    # C_NUptRel3[Zone,SlNut] = IF( RT_CAmount3[Zone]>0.0001)THEN(100*AF_HGW3[Zone]*N_CUpt3[Zone,SlNut]/RT_CAmount3[Zone])ELSE(0)
    # C_NUptRel4[Zone,SlNut] = IF( RT_CAmount4[Zone]>0.0001)THEN(100*AF_HGW4[Zone]*N_CUpt4[Zone,SlNut]/RT_CAmount4[Zone])ELSE(0)
    zonelayernut_df$RT_CAmount <- rep(zonelayer_df$RT_CAmount, nrow(nut_df))
    zonelayernut_df$AF_HGW <- rep(zonelayer_df$AF_HGW, nrow(nut_df))
    zonelayernut_df$C_NUptRel <- ifelse(
      zonelayernut_df$RT_CAmount > 0.0001,
      100 * zonelayernut_df$AF_HGW * zonelayernut_df$N_CUpt / zonelayernut_df$RT_CAmount,
      0
    )
    
    # C_NUptRel[Zone,SlNut] = IF(CQ_Stage[Zone]>0.1  AND RT_ACType=2 AND C_NUptRelDeno[Zone,SlNut]>0)  THEN ((C_NUptRel1[Zone,SlNut]+C_NUptRel2[Zone,SlNut]+C_NUptRel3[Zone,SlNut]+C_NUptRel4[Zone,SlNut])*RT_CAmount[Zone]/C_NUptRelDeno[Zone,SlNut])ELSE(1)
    zonenut_df$RT_CAmount <- rep(zone_df$RT_CAmount, nrow(nut_df))
    zonenut_df$RT_ACType <- RT_ACType
    zonenut_df$C_NUptRel_sum <- aggregate(zonelayernut_df["C_NUptRel"], zonelayernut_df[c("zone", "SlNut")], sum)$C_NUptRel
    zonenut_df$C_NUptRel <- ifelse(
      zonenut_df$CQ_Stage > 0.1  &
        zonenut_df$RT_ACType == 2 & zonenut_df$C_NUptRelDeno > 0,
      zonenut_df$C_NUptRel_sum * zonenut_df$RT_CAmount / zonenut_df$C_NUptRelDeno,
      1
    )
    
    # CW_UptRelDeno[Zone] = ((AF_HGW1[Zone]+AF_HGW2[Zone]+AF_HGW3[Zone]+AF_HGW4[Zone])*(W_CUpt1[Zone]+W_CUpt2[Zone]+W_CUpt3[Zone]+W_CUpt4[Zone]))
    # zone_df$AF_HGW_sum <- aggregate(zonelayer_df["AF_HGW"], zonelayer_df["zone"], sum)$AF_HGW
    # zonenut_df$AF_HGW_sum <- rep(zone_df$AF_HGW_sum, nrow(nut_df))
    zone_df$N_CUpt_sum <- aggregate(zonelayer_df["W_CUpt"], zonelayer_df[c("zone")] , sum)$W_CUpt
    zone_df$CW_UptRelDeno <- zone_df$AF_HGW_sum * zone_df$N_CUpt_sum
    
    # CW_UptRel1[Zone] = IF(RT_CAmount1[Zone]>0.0001)THEN (100*AF_HGW1[Zone]*W_CUpt1[Zone]/RT_CAmount1[Zone]) ELSE(0)
    # CW_UptRel2[Zone] = IF(RT_CAmount2[Zone]>0.0001)THEN (100*AF_HGW2[Zone]*W_CUpt2[Zone]/RT_CAmount2[Zone]) ELSE(0)
    # CW_UptRel3[Zone] = IF(RT_CAmount3[Zone]>0.0001)THEN (100*AF_HGW3[Zone]*W_CUpt3[Zone]/RT_CAmount3[Zone]) ELSE(0)
    # CW_UptRel4[Zone] = IF(RT_CAmount4[Zone]>0.0001)THEN (100*AF_HGW4[Zone]*W_CUpt4[Zone]/RT_CAmount4[Zone]) ELSE(0)
    zonelayer_df$CW_UptRel <- ifelse(
      zonelayer_df$RT_CAmount > 0.0001,
      100 * zonelayer_df$AF_HGW * zonelayer_df$W_CUpt / zonelayer_df$RT_CAmount,
      0
    )
    
    # CW_UptRel[Zone] = IF(CQ_Stage[Zone]>0.05 AND  RT_ACType=2 AND CW_UptRelDeno[Zone]>0)  THEN ((CW_UptRel1[Zone]+CW_UptRel2[Zone]+CW_UptRel3[Zone]+CW_UptRel4[Zone])*RT_CAmount[Zone]/CW_UptRelDeno[Zone])ELSE(1)
    zone_df$CW_UptRel_sum <- aggregate(zonelayer_df["CW_UptRel"], zonelayer_df["zone"], sum)$CW_UptRel
    zone_df$CW_UptRel <- ifelse(
      zone_df$CQ_Stage > 0.05 &
        zone_df$RT_ACType == 2 & zone_df$CW_UptRelDeno > 0,
      zone_df$CW_UptRel_sum * zone_df$RT_CAmount / zone_df$CW_UptRelDeno,
      1
    )
    
    # RT_CUptRel[Zone] = If (C_NPosgro[Zone,N]< 1 OR C_NPosgro[Zone,P] <1 OR CW_Posgro[Zone] <1) then if  (min(C_NPosgro[Zone,N],C_NPosgro[Zone,P],CW_Posgro[Zone])=C_NPosgro[Zone,N]) then C_NUptRel[Zone,N] else if (min(C_NPosgro[Zone,N],C_NPosgro[Zone,P],CW_Posgro[Zone])=C_NPosgro[Zone,P]) then C_NUptRel[Zone,P] else CW_UptRel[Zone] else 1
    zone_df$C_NUptRel_N <- zonenut_df[zonenut_df$SlNut == "N", "C_NUptRel"]
    zone_df$C_NUptRel_P <- zonenut_df[zonenut_df$SlNut == "P", "C_NUptRel"]
    
    zone_df$RT_CUptRel <- ifelse (
      zone_df$C_NPosgro_N < 1 |
        zone_df$C_NPosgro_P < 1 | zone_df$CW_Posgro < 1,
      ifelse  (
        pmin(
          zone_df$C_NPosgro_N,
          zone_df$C_NPosgro_P,
          zone_df$CW_Posgro
        ) == zone_df$C_NPosgro_N,
        zone_df$C_NUptRel_N,
        ifelse (
          pmin(
            zone_df$C_NPosgro_N,
            zone_df$C_NPosgro_P,
            zone_df$CW_Posgro
          ) == zone_df$C_NPosgro_P,
          zone_df$C_NUptRel_P,
          zone_df$CW_UptRel
        )
      ),
      1
    )
    
    # RT_CDecDepthD[Zone] = IF(RT_ACType=2 AND CQ_Stage[Zone]>0 )THEN (MIN(1+RT_CRelChange[Zone], MAX((1+RT_CRelChange[Zone])^-1, RT_CUptRel[Zone]^-RT_CDistResp[Zone])))ELSE(1)
    zone_df$RT_CDecDepthD <- ifelse(
      zone_df$RT_ACType == 2 &
        zone_df$CQ_Stage > 0,
      pmin(
        1 + zone_df$RT_CRelChange,
        pmax((1 + zone_df$RT_CRelChange)^-1,
             zone_df$RT_CUptRel^-zone_df$RT_CDistResp
        )
      ),
      1
    )
    
    # RT_CDecDepthInc[Zone] = if C_PlantDiesToday?[Zone] = 1 then - RT_CDecDepthAct[Zone] else IF(RT_ACType=2)THEN IF CQ_Stage[Zone]<2 THEN (RT_CDecDepthAct[Zone]*(RT_CDecDepthD[Zone]-1)) ELSE-RT_CDecDepthAct[Zone] ELSE 0
    zone_df$RT_CDecDepthInc <- ifelse(
      zone_df$C_PlantDiesToday_is == 1,
      -zone_df$RT_CDecDepthAct,
      ifelse(
        zone_df$RT_ACType == 2,
        ifelse(
          zone_df$CQ_Stage < 2,
          (zone_df$RT_CDecDepthAct * (zone_df$RT_CDecDepthD - 1)),
          -zone_df$RT_CDecDepthAct
        ),
        0
      )
    )
    
    # RT_CDecDepth_ActInitSeason[Zone] = If TIME= CA_PlantTime[Zone] THEN RT_CDecDepthC[Zone] ELSE 0
    zone_df$RT_CDecDepth_ActInitSeason <- ifelse(time == zone_df$CA_PlantTime, zone_df$RT_CDecDepthC, 0)
    
    
    
    # T_WoodHarvest[PlantComp,Tree] = if time = int(S&B_SlashTime[Tree]) then T_SapWood[PlantComp,Tree]*T_SlashSellWoodFrac[Tree]/dt else
    #   if time = T_WoodHarvDay[Tree] then T_SapWood[PlantComp,Tree] * T_WoodHarvFrac[Tree]/dt else if T_StemDiam[Tree]>T_DiamTreshHarv[Tree] then T_SapWood[PlantComp,Tree] * T_WoodHarvFrac[Tree]/dt else
    #     if T_SapWood[DW, Tree] = 0 then 0 else
    #       if T_Prun[DW, Tree]> 0 then max(0,(T_WoodH[Tree]*(1-T_WoodFracHRemain[Tree])))*pi*T_StemDiam[Tree]^2*T_WoodDens[Tree]*T_TreesperHa[Tree]*T_UnitConv[PlantComp]*T_WoodConc[PlantComp,Tree]/(10^8*4)else 0
    treepcomp_df$T_SlashSellWoodFrac <- rep(tree_df$T_SlashSellWoodFrac, nrow(pcomp_df))
    treepcomp_df$T_WoodHarvFrac <- rep(tree_df$T_WoodHarvFrac, nrow(pcomp_df))
    treepcomp_df$T_StemDiam <- rep(tree_df$T_StemDiam, nrow(pcomp_df))
    treepcomp_df$T_DiamTreshHarv <- rep(tree_df$T_DiamTreshHarv, nrow(pcomp_df))
    tree_df$T_Prun_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Prun"]
    treepcomp_df$T_Prun_DW <- rep(tree_df$T_Prun_DW, nrow(pcomp_df))
    treepcomp_df$T_WoodH <- rep(tree_df$T_WoodH, nrow(pcomp_df))
    treepcomp_df$T_WoodFracHRemain <- rep(tree_df$T_WoodFracHRemain, nrow(pcomp_df))
    treepcomp_df$T_WoodDens <- rep(tree_df$T_WoodDens, nrow(pcomp_df))
    
    treepcomp_df$T_WoodHarvest <- ifelse(
      time == floor(treepcomp_df$SB_SlashTime),
      treepcomp_df$T_SapWood * treepcomp_df$T_SlashSellWoodFrac,
      ifelse(
        time == treepcomp_df$T_WoodHarvDay,
        treepcomp_df$T_SapWood * treepcomp_df$T_WoodHarvFrac,
        ifelse(
          treepcomp_df$T_StemDiam > treepcomp_df$T_DiamTreshHarv,
          treepcomp_df$T_SapWood * treepcomp_df$T_WoodHarvFrac,
          ifelse(
            treepcomp_df$T_SapWood_DW == 0,
            0,
            ifelse(
              treepcomp_df$T_Prun_DW > 0,
              pmax(0, (
                treepcomp_df$T_WoodH * (1 - treepcomp_df$T_WoodFracHRemain)
              )) * pi *  treepcomp_df$T_StemDiam^2 *  treepcomp_df$T_WoodDens * treepcomp_df$T_Treesperha *
                treepcomp_df$T_UnitConv * treepcomp_df$T_WoodConc / (10^8 * 4),
              0
            )
          )
        )
      )
    )
    
    # T_GroResLoss[PlantComp,Tree] = IF T_DiesToday?[Tree]=1 THEN T_GroRes[PlantComp,Tree] ELSE IF TIME=T_WoodHarvDay[Tree] THEN T_GroRes[PlantComp,Tree]*T_WoodHarvFrac[Tree] ELSE 0
    treepcomp_df$T_GroResLoss <- ifelse(
      treepcomp_df$T_DiesToday_is == 1,
      treepcomp_df$T_GroRes,
      ifelse(
        time == treepcomp_df$T_WoodHarvDay,
        treepcomp_df$T_GroRes * treepcomp_df$T_WoodHarvFrac,
        0
      )
    )
    
    # T_WoodHCurr[Tree] = IF T_StemDiam[Tree]>0 THEN(4*T_SapWood[DW,Tree]*10000/T_TreesperHa[Tree])/(T_WoodDens[Tree]*pi*(T_StemDiam[Tree]/100)^2) ELSE 0
    tree_df$T_WoodHCurr <- ifelse(
      tree_df$T_StemDiam > 0,
      (4 * T_SapWood[DW, Tree] * 10000 / T_TreesperHa[Tree]) / (T_WoodDens[Tree] *
                                                                  pi * (T_StemDiam[Tree] / 100)^2),
      0
    )
    
    
    # T_WoodHInc[Tree] = if (time=T_PlantTime[Tree]) then T_WoodHInit[Tree] else if T_ApplyPalm?[Tree] = 1 then TF_TrunkHIncr[Tree] else (IF T_DiesToday?[Tree] THEN -T_WoodH[Tree]
    # ELSE if T_ApplyFBA?[Tree]=1 then if  T_WoodHarvest[DW,Tree]>0  then -(T_WoodHarvest[DW,Tree]+T_GroResLoss[DW,Tree])*10000/(T_TreesperHa[Tree]*T_WoodDens[Tree]*pi*(T_StemDiam[Tree]/(2*100))^2)
    # else if T_StemDiam[Tree]>0 then max(T_WoodHCurr[Tree]-T_WoodH[Tree],0) else 0 else if T_WoodHarvest[DW,Tree]>0 then -(T_GroResLoss[DW,Tree]+T_WoodHarvFrac[Tree])*T_WoodH[Tree] else (T_CanBiomInc[DW,Tree]*T_LWR[Tree])/(T_LAIMax[Tree]*T_CanWidthMax[Tree]))
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_WoodHarvest", "T_GroResLoss", "T_CanBiomInc")]
    tree_df$T_WoodHInc <- ifelse (
      time == tree_df$T_PlantTime,
      tree_df$T_WoodHInit,
      ifelse(
        tree_df$T_ApplyPalm_is == 1,
        tree_df$TF_TrunkHIncr,
        ifelse(
          tree_df$T_DiesToday_is == 1,
          -tree_df$T_WoodH,
          ifelse(
            tree_df$T_ApplyFBA_is == 1,
            ifelse(
              tp_DW$T_WoodHarvest > 0,
              -(tp_DW$T_WoodHarvest + tp_DW$T_GroResLoss) * 10000 / (
                tree_df$T_Treesperha *
                  tree_df$T_WoodDens * pi * (tree_df$T_StemDiam / (2 * 100))^2
              ),
              ifelse(
                tree_df$T_StemDiam >
                  0,
                pmax(tree_df$T_WoodHCurr - tree_df$T_WoodH, 0),
                0
              )
            ),
            ifelse(
              tp_DW$T_WoodHarvest > 0,
              -(tp_DW$T_GroResLoss + tree_df$T_WoodHarvFrac) * tree_df$T_WoodH,
              (tp_DW$T_CanBiomInc * tree_df$T_LWR) / (tree_df$T_LAIMax * tree_df$T_CanWidthMax)
            )
          )
        )
      )
    )
    
    # C_StLeafInc[Zone,PlantComp] = IF (C_PlantDiesToday?[Zone]=0 )THEN(C_GroResMobFrac *(1-CQ_CHarvAllocCurr[Zone])*C_GroRes[Zone,PlantComp]-CQ_RemobFrac[Zone]*C_BiomStLv[Zone,PlantComp])ELSE(0)
    zonepcomp_df$C_StLeafInc <- ifelse (
      zonepcomp_df$C_PlantDiesToday_is == 0,
      C_GroResMobFrac * (1 - zonepcomp_df$CQ_CHarvAllocCurr) * zonepcomp_df$C_GroRes - zonepcomp_df$CQ_RemobFrac * zonepcomp_df$C_BiomStLv,
      0
    )
    
    # C_HeightInc[Zone] = if (CQ_Stage[Zone] < 1) then (CQ_HBiomConvCurr[Zone] * C_StLeafInc[Zone,DW]) else 0
    zone_df$C_HeightInc <- ifelse (zone_df$CQ_Stage < 1,
                                   zone_df$CQ_HBiomConvCurr * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_StLeafInc"],
                                   0)
    
    # C_HeightDec[Zone] = if (int(CQ_Stage[Zone]) = 2 and CQ_StageAfterHarvest[Zone]=0) then C_Height[Zone] /dt  else 0
    zone_df$C_HeightDec <- ifelse (
      floor(zone_df$CQ_Stage) == 2 &
        zone_df$CQ_StageAfterHarvest == 0,
      zone_df$C_Height,
      0
    )
    
    
    # T_StageInc[Sp1,VegGen] = if T_DiesToday?[Sp1] = 1 then -T_Stage[Sp1,VegGen]/dt elseif time = int(T_PlantTime[Sp1]) then T_InitStage[Sp1] else  if T_Prun[DW, Sp1]>0 then T_StageAftPrun?[Sp1,VegGen]*(T_StageAftPrun[Sp1]-T_Stage[Sp1,VegGen])/ dt else     if (T_Stage[Sp1,VegGen] >=2 ) then ((-T_Stage[Sp1,VegGen]+1)/dt) else      if (T_Stage[Sp1,VegGen] > 0 and T_Stage[Sp1,VegGen] < 1) then min(1-T_Stage[Sp1,VegGen], (1/(T_TimeVeg[Sp1]))) else         if (T_Stage[Sp1,VegGen] >=1 and T_Stage[Sp1,VegGen] < 2) then (1/(T_TimeGenCycle[Sp1])) else           if T_Stage[Sp1,VegGen]>=1 and (mod (Time,365)  > T_DOYFlwBeg[Sp1] and mod (Time,365)  < T_DOYFlwEnd[Sp1]) then (1/T_TimeGenCycle[Sp1]) else 0 *(T_LfTwig[DW,Sp1]+T_CanBiomInc[DW,Sp1])
    # T_StageInc[Sp2,VegGen] = if T_DiesToday?[Sp2] = 1 then -T_Stage[Sp2,VegGen]/dt elseif time = int(T_PlantTime[Sp2]) then T_InitStage[Sp2] else  if T_Prun[DW, Sp2]>0 then T_StageAftPrun?[Sp2,VegGen]*(T_StageAftPrun[Sp2]-T_Stage[Sp2,VegGen])/ dt else     if (T_Stage[Sp2,VegGen] >=2 ) then ((-T_Stage[Sp2,VegGen]+1)/dt) else      if (T_Stage[Sp2,VegGen] > 0 and T_Stage[Sp2,VegGen] < 1) then min(1-T_Stage[Sp2,VegGen], (1/(T_TimeVeg[Sp2]))) else         if (T_Stage[Sp2,VegGen] >=1 and T_Stage[Sp2,VegGen] < 2) then (1/(T_TimeGenCycle[Sp2])) else           if T_Stage[Sp2,VegGen]>= 1 and (mod (Time,365)  > T_DOYFlwBeg[Sp2] and mod (Time,365)  < T_DOYFlwEnd[Sp2]) then (1/T_TimeGenCycle[Sp2]) else 0 *(T_LfTwig[DW,Sp1]+T_CanBiomInc[DW,Sp1])
    # T_StageInc[Sp3,VegGen] = if T_DiesToday?[Sp3] = 1 then -T_Stage[Sp3,VegGen]/dt elseif time = int(T_PlantTime[Sp3]) then T_InitStage[Sp3] else  if T_Prun[DW, Sp3]>0 then T_StageAftPrun?[Sp3,VegGen]*(T_StageAftPrun[Sp3]-T_Stage[Sp3,VegGen])/ dt else     if (T_Stage[Sp3,VegGen] >=2 ) then ((-T_Stage[Sp3,VegGen]+1)/dt) else      if (T_Stage[Sp3,VegGen] > 0 and T_Stage[Sp3,VegGen] < 1) then min(1-T_Stage[Sp3,VegGen], (1/(T_TimeVeg[Sp3]))) else         if (T_Stage[Sp3,VegGen] >=1 and T_Stage[Sp3,VegGen] < 2) then (1/(T_TimeGenCycle[Sp3])) else           if T_Stage[Sp3,VegGen]>= 1 and (mod (Time,365)  > T_DOYFlwBeg[Sp3] and mod (Time,365)  < T_DOYFlwEnd[Sp3]) then (1/T_TimeGenCycle[Sp3]) else 0 *( T_LfTwig[DW,Sp1]+T_CanBiomInc[DW,Sp1])
    #
    # T_StageInc[Sp1,LeafAge] = if T_LfTwig[DW,Sp1]+T_CanBiomInc[DW,Sp1]> 0 then -T_Stage[Sp1,LeafAge]+(T_CanBiomInc[DW,Sp1]+T_LfTwig[DW,Sp1]*(T_Stage[Sp1,LeafAge]+1))/(T_LfTwig[DW,Sp1]+T_CanBiomInc[DW,Sp1]) else -T_Stage[Sp1,LeafAge]+0*(T_StageAftPrun?[Sp1,LeafAge]*T_Stage[Sp1,LeafAge]+T_DiesToday?[Sp1]+T_DOYFlwBeg[Sp1]+T_DOYFlwEnd[Sp1]+T_InitStage[Sp1]+T_PlantTime[Sp1]+T_Prun[DW,Sp1]+T_StageAftPrun[Sp1]+T_TimeGenCycle[Sp1]+T_TimeVeg[Sp1])
    # T_StageInc[Sp2,LeafAge] = if T_LfTwig[DW,Sp2]+T_CanBiomInc[DW,Sp2]> 0 then -T_Stage[Sp2,LeafAge]+(T_CanBiomInc[DW,Sp2]+T_LfTwig[DW,Sp2]*(T_Stage[Sp2,LeafAge]+1))/(T_LfTwig[DW,Sp2]+T_CanBiomInc[DW,Sp2]) else -T_Stage[Sp2,LeafAge]+0*(T_StageAftPrun?[Sp2,LeafAge]*T_Stage[Sp1,LeafAge]+T_DiesToday?[Sp1]+T_DOYFlwBeg[Sp1]+T_DOYFlwEnd[Sp1]+T_InitStage[Sp1]+T_PlantTime[Sp1]+T_Prun[DW,Sp1]+T_StageAftPrun[Sp1]+T_TimeGenCycle[Sp1]+T_TimeVeg[Sp1])
    # T_StageInc[Sp3,LeafAge] = if T_LfTwig[DW,Sp3]+T_CanBiomInc[DW,Sp3]> 0 then -T_Stage[Sp3,LeafAge]+(T_CanBiomInc[DW,Sp3]+T_LfTwig[DW,Sp3]*(T_Stage[Sp3,LeafAge]+1))/(T_LfTwig[DW,Sp3]+T_CanBiomInc[DW,Sp3]) else -T_Stage[Sp3,LeafAge]+0*(T_StageAftPrun?[Sp3,LeafAge]*T_Stage[Sp1,LeafAge]+T_DiesToday?[Sp1]+T_DOYFlwBeg[Sp1]+T_DOYFlwEnd[Sp1]+T_InitStage[Sp1]+T_PlantTime[Sp1]+T_Prun[DW,Sp1]+T_StageAftPrun[Sp1]+T_TimeGenCycle[Sp1]+T_TimeVeg[Sp1])
    treestage_df$T_StageInc <- NA
    ts_VG <- treestage_df[treestage_df$Tree_Stage == "VegGen", c("tree_id", "T_Stage")]
    treestage_df[treestage_df$Tree_Stage == "VegGen", "T_StageInc"] <- ifelse(
      tree_df$T_DiesToday_is == 1,
      -ts_VG$T_Stage,
      ifelse(
        time == floor(tree_df$T_PlantTime),
        tree_df$T_InitStage,
        ifelse(
          tree_df$T_Prun_DW > 0,
          ts_VG$T_StageAftPrun_is * (tree_df$T_StageAftPrun - ts_VG$T_Stage),
          ifelse (
            ts_VG$T_Stage >= 2,
            -ts_VG$T_Stage + 1,
            ifelse(
              ts_VG$T_Stage > 0 &
                ts_VG$T_Stage < 1,
              pmin(1 - ts_VG$T_Stage, 1 / tree_df$T_TimeVeg),
              ifelse (
                ts_VG$T_Stage >= 1 &
                  ts_VG$T_Stage < 2,
                1 / tree_df$T_TimeGenCycle,
                ifelse(
                  ts_VG$T_Stage >= 1 &
                    ((time %% 365)  > tree_df$T_DOYFlwBeg &
                       (time %% 365)  < tree_df$T_DOYFlwEnd
                    ),
                  1 / tree_df$T_TimeGenCycle,
                  0
                )
              )
            )
          )
        )
      )
    )
    
    ts_LA <- treestage_df[treestage_df$Tree_Stage == "LeafAge", c("tree_id", "T_Stage")]
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_LfTwig", "T_CanBiomInc")]
    treestage_df[treestage_df$Tree_Stage == "LeafAge", "T_StageInc"] <- ifelse(
      tp_DW$T_LfTwig + tp_DW$T_CanBiomInc > 0,
      -ts_LA$T_Stage +
        (tp_DW$T_CanBiomInc + tp_DW$T_LfTwig * (ts_LA$T_Stage + 1)) / (tp_DW$T_LfTwig + tp_DW$T_CanBiomInc),
      -ts_LA$T_Stage
    )
    
    
    # TW_PDryFactRUpd[Tree] = if T_LfTwig[DW,Tree] = 0 then -TW_DryFactPower[Tree] + TW_DryFactPowerInit[Tree] else if TW_Best?[Tree,1] = 1 or TW_Best?[Tree,2] = 1 or TW_Best?[Tree,9] = 1 or TW_Best?[Tree,10] = 1 then (if (TW_DryFactPower[Tree] +TW_DryFactPowerRangeChange) < TW_DryPowerMax then +TW_DryFactPowerRangeChange else 0) else if TW_Best?[Tree,5] = 1 or TW_Best?[Tree,6] = 1 and (1+TW_DryFactPowerRangeChange)<>0 then (TW_DryFactPower[Tree]/(1+TW_DryFactPowerRangeChange))-TW_DryFactPower[Tree] else if TW_Best?[Tree,3] = 1 or TW_Best?[Tree,4] = 1 or TW_Best?[Tree,7] = 1 or TW_Best?[Tree,8] = 1 then 0 else 0
    TW_DryPowerMax <- CW_DryPowerMax
    TW_DryPowerMin <- CW_DryPowerMin
    
    tree_df$TW_PDryFactRUpd <- ifelse(
      tp_DW$T_LfTwig == 0,
      -tree_df$TW_DryFactPower + tree_df$TW_DryFactPowerInit,
      ifelse(
        treebuf_df[treebuf_df$buf_id == 1, ]$TW_Best_is == 1 |
          treebuf_df[treebuf_df$buf_id == 2, ]$TW_Best_is == 1 |
          treebuf_df[treebuf_df$buf_id == 9, ]$TW_Best_is == 1 |
          treebuf_df[treebuf_df$buf_id == 10, ]$TW_Best_is == 1,
        ifelse(
          (tree_df$TW_DryFactPower + TW_DryFactPowerRangeChange) < TW_DryPowerMax,
          TW_DryFactPowerRangeChange,
          0
        ),
        ifelse(
          treebuf_df[treebuf_df$buf_id == 5, ]$TW_Best_is == 1 |
            treebuf_df[treebuf_df$buf_id == 6, ]$TW_Best_is == 1 &
            (1 + TW_DryFactPowerRangeChange) != 0,
          (tree_df$TW_DryFactPower / (1 + TW_DryFactPowerRangeChange)) - tree_df$TW_DryFactPower,
          ifelse(
            treebuf_df[treebuf_df$buf_id == 3, ]$TW_Best_is == 1 |
              treebuf_df[treebuf_df$buf_id == 4, ]$TW_Best_is == 1 |
              treebuf_df[treebuf_df$buf_id == 7, ]$TW_Best_is == 1 |
              treebuf_df[treebuf_df$buf_id == 8, ]$TW_Best_is == 1,
            0,
            0
          )
        )
      )
    )
    
    # CW_DryFactRangeUpdate[Zone] = if CQ_Stage[Zone]=0 then  -CW_DryFactRangePower[Zone]+CW_DryFactRangePowerStart
    # else if ((CW_Best[Zone,1]=1) or (CW_Best[Zone,2]=1) or (CW_Best[Zone,9]=1) or (CW_Best[Zone,10]=1)) then
    # ((1+CW_DryFactRangeChange)*CW_DryFactRangePower[Zone])-CW_DryFactRangePower[Zone] else  if ((CW_Best[Zone,5]=1) or (CW_Best[Zone,6]=1)) then
    # (CW_DryFactRangePower[Zone]/(1+CW_DryFactRangeChange))-CW_DryFactRangePower[Zone]
    # else if ((CW_Best[Zone,3]=1) or (CW_Best[Zone,4]=1)) or ((CW_Best[Zone,7]=1) or (CW_Best[Zone,8]=1)) then CW_DryFactRangePower[Zone]-CW_DryFactRangePower[Zone] else 0
    zone_df$CW_DryFactRangeUpdate <- ifelse(
      zone_df$CQ_Stage == 0,
      -zone_df$CW_DryFactRangePower + CW_DryFactRangePowerStart,
      ifelse ((treebuf_df[treebuf_df$buf_id == 1, ]$CW_Best[Zone, 1] == 1) |
                (treebuf_df[treebuf_df$buf_id == 2, ]$CW_Best[Zone, 2] == 1) |
                (treebuf_df[treebuf_df$buf_id == 9, ]$CW_Best == 1) |
                (treebuf_df[treebuf_df$buf_id == 10, ]$CW_Best[Zone, 10] == 1),
              ((1 + CW_DryFactRangeChange) * zone_df$CW_DryFactRangePower) - zone_df$CW_DryFactRangePower,
              ifelse ((treebuf_df[treebuf_df$buf_id == 5, ]$CW_Best == 1) |
                        (treebuf_df[treebuf_df$buf_id == 6, ]$CW_Best == 1),
                      (zone_df$CW_DryFactRangePower / (1 + CW_DryFactRangeChange)) - zone_df$CW_DryFactRangePower,
                      ifelse(
                        ((treebuf_df[treebuf_df$buf_id == 3, ]$CW_Best == 1) |
                           (treebuf_df[treebuf_df$buf_id == 4, ]$CW_Best[Zone, 4] == 1)) |
                          ((treebuf_df[treebuf_df$buf_id == 7, ]$CW_Best == 1) |
                             (treebuf_df[treebuf_df$buf_id == 8, ]$CW_Best == 1)),
                        zone_df$CW_DryFactRangePower - zone_df$CW_DryFactRangePower,
                        0
                      )
              )
      )
    )
    
    # CA_CropSequen[Zone] = if CQ_Stage[Zone] >= 2 and CQ_StageAfterHarvest[Zone]= 0  and CQ_CropWeedSwitch[Zone] <> CQ_WeedType then 1 else if ((CQ_Stage[Zone] = 0) and( time > CA_PlantTime[Zone] + 2)) then 1 else 0
    zone_df$CA_CropSequen <- ifelse(
      zone_df$CQ_Stage >= 2 &
        zone_df$CQ_StageAfterHarvest == 0 &
        zone_df$CQ_CropWeedSwitch != CQ_WeedType,
      1,
      ifelse ((zone_df$CQ_Stage = 0) &
                (time > zone_df$CA_PlantTime + 2), 1, 0)
    )
    
    
    
    # PD_CFrugConst[Zone] = if CQ_CropType[Zone]=1 then PD_CFrugivory[Type1] else if CQ_CropType[Zone]=2 then PD_CFrugivory[Type2] else if CQ_CropType[Zone]=3 then PD_CFrugivory[Type3] else if CQ_CropType[Zone]=4 then PD_CFrugivory[Type4] else if CQ_CropType[Zone]=5 then PD_CFrugivory[Type5] else 0
    zone_df$PD_CFrugConst <- crop_df[zone_df$CQ_CropType, "PD_CFrugivory"]
    
    # PD_CFrugImp[Zone,Animals] = PD_NastiesinPlot[Animals]*PD_CFrugivore?[Animals]*PD_CropsEaten?[Zone,Animals]
    zoneanimal_df$PD_NastiesinPlot <- rep(animal_df$PD_NastiesinPlot, each = nzone)
    zoneanimal_df$PD_CFrugivore_is <- rep(animal_df$PD_CFrugivore_is, each = nzone)
    zoneanimal_df$PD_CFrugImp <- zoneanimal_df$PD_NastiesinPlot * zoneanimal_df$PD_CFrugivore_is * zoneanimal_df$PD_CropsEaten_is
    
    # PD_CFrugiVFrac[Zone] = min(1,PD_CFrugConst[Zone]+AF_DynPestImpacts?*ARRAYSUM(PD_CFrugImp[Zone,*]))
    zone_df$PD_CFrugImp_sum <- aggregate(zoneanimal_df["PD_CFrugImp"], zoneanimal_df["zone"], sum)$PD_CFrugImp
    zone_df$PD_CFrugiVFrac <- pmin(1,
                                   zone_df$PD_CFrugConst + AF_DynPestImpacts_is * zone_df$PD_CFrugImp_sum)
    
    # C_FruitLoss[Zone,PlantComp] = if time = int(S&B_SlashTime[Sp1]) or time = int(S&B_SlashTime[Sp2]) or time = int(S&B_SlashTime[Sp3]) or time = int(CA_PlantTime[Zone]) or S&B_Fire? = 1 or (CQ_WeedZn?[Zone]=1 and C_PlantDiesToday?[Zone]=1) then C_YieldCurr[Zone,PlantComp]/dt else PD_CFrugiVFrac[Zone]*C_YieldCurr[Zone,PlantComp]
    zonepcomp_df$SB_SlashTime_Sp1 <- tree_df[tree_df$tree_id == 1, "SB_SlashTime"]
    zonepcomp_df$SB_SlashTime_Sp2 <- tree_df[tree_df$tree_id == 2, "SB_SlashTime"]
    zonepcomp_df$SB_SlashTime_Sp3 <- tree_df[tree_df$tree_id == 3, "SB_SlashTime"]
    zonepcomp_df$SB_Fire_is <- SB_Fire_is
    zonepcomp_df$CQ_WeedZn_is <- rep(zone_df$CQ_WeedZn_is, nrow(pcomp_df))
    zonepcomp_df$PD_CFrugiVFrac <- rep(zone_df$PD_CFrugiVFrac, nrow(pcomp_df))
    
    zonepcomp_df$C_FruitLoss <- ifelse(
      time == floor(zonepcomp_df$SB_SlashTime_Sp1) |
        time == floor(zonepcomp_df$SB_SlashTime_Sp3) |
        time == floor(zonepcomp_df$SB_SlashTime_Sp3) |
        time == floor(zonepcomp_df$CA_PlantTime) |
        zonepcomp_df$SB_Fire_is == 1 |
        (
          zonepcomp_df$CQ_WeedZn_is == 1 &
            zonepcomp_df$C_PlantDiesToday_is == 1
        ),
      zonepcomp_df$C_YieldCurr ,
      zonepcomp_df$PD_CFrugiVFrac * zonepcomp_df$C_YieldCurr
    )
    
    # C_ResidLast[Zone,PlantComp] = if C_PlantDiesToday?[Zone] = 1 then C_GroRes[Zone,PlantComp]/dt else 0
    zonepcomp_df$C_ResidLast <- ifelse(zonepcomp_df$C_PlantDiesToday_is == 1,
                                       zonepcomp_df$C_GroRes,
                                       0)
    
    # S&B_FirMortSeedBank[Zone] = GRAPH(S&B_FireTempIncTopSoil[Zone])
    zone_df$SB_FirMortSeedBank <- get_y_df(zone_df$SB_FireTempIncTopSoil, "SB_FirMortSeedBank")
    zonepcomp_df$SB_FirMortSeedBank <- rep(zone_df$SB_FirMortSeedBank, nrow(pcomp_df))
    
    # C_WeedSeedDecay[Zone,PlantComp] = min(1,C_DailyWeedSeedDecayFrac+S&B_FirMortSeedBank[Zone])*C_WeedSeedBank[Zone,PlantComp]
    zonepcomp_df$C_WeedSeedDecay <- pmin(1,
                                         C_DailyWeedSeedDecayFrac + zonepcomp_df$SB_FirMortSeedBank) * zonepcomp_df$C_WeedSeedBank
    # C_ResidMulch[Zone,PlantComp] = C_FruitLoss[Zone,PlantComp]+C_ResidLast[Zone,PlantComp]+C_StLeaveMulch[Zone,PlantComp]+C_WeedSeedDecay[Zone,PlantComp]
    zonepcomp_df$C_ResidMulch <- zonepcomp_df$C_FruitLoss + zonepcomp_df$C_ResidLast + zonepcomp_df$C_StLeaveMulch + zonepcomp_df$C_WeedSeedDecay
    
    # TF_MaleDWloss[Tree,Fruitbunch] = if TF_NewLeaf?[Tree] = 1 and TF_BunchGender[Tree,Fruitbunch] < 2 then TF_BunchWeight_kgpbunch[Tree,Fruitbunch]/dt else 0
    treefruit_df$TF_NewLeaf_is <- rep(tree_df$TF_NewLeaf_is, length(Fruitbunch))
    treefruit_df$TF_MaleDWloss <- ifelse(
      treefruit_df$TF_NewLeaf_is == 1 &
        treefruit_df$TF_BunchGender < 2,
      treefruit_df$TF_BunchWeight_kgpbunch,
      0
    )
    
    # TF_PollinationEffectiveness = GRAPH(Rain)
    TF_PollinationEffectiveness <- get_y_df(Rain, "TF_PollinationEffectiveness")
    
    # TF_FruitNumbLoss[Tree,Fruitbunch] = if TF_FruitWaterPot[Tree]>TF_CritFruitWaterPot[Tree] then TF_PollinationStage[Fruitbunch]*(1-TF_PollinationEffectiveness) else TF_PollinationStage[Fruitbunch]*(1-TF_PollinationEffectiveness)+TF_FruitsperBunch[Tree,Fruitbunch]*TF_WatStressAbortFrac[Tree]*TF_StageAbortSens[Tree,Fruitbunch]
    treefruit_df$TF_FruitWaterPot <- rep(tree_df$TF_FruitWaterPot, length(Fruitbunch))
    treefruit_df$TF_CritFruitWaterPot <- rep(tree_df$TF_CritFruitWaterPot, length(Fruitbunch))
    treefruit_df$TF_PollinationStage <- rep(fruit_df$TF_PollinationStage, each = ntree)
    treefruit_df$TF_WatStressAbortFrac <- rep(tree_df$TF_WatStressAbortFrac, length(Fruitbunch))
    
    treefruit_df$TF_FruitNumbLoss <- ifelse(
      treefruit_df$TF_FruitWaterPot > treefruit_df$TF_CritFruitWaterPot,
      treefruit_df$TF_PollinationStage *
        (1 - TF_PollinationEffectiveness),
      treefruit_df$TF_PollinationStage *
        (1 - TF_PollinationEffectiveness) + treefruit_df$TF_FruitsperBunch * treefruit_df$TF_WatStressAbortFrac *
        treefruit_df$TF_StageAbortSens
    )
    
    
    # TF_FruitAbDWLoss[Tree,Fruitbunch] = TF_BunchWeight_kgpbunch[Tree,Fruitbunch]*(TF_FruitNumbLoss[Tree,Fruitbunch]^TF_AbRelSizePow[Tree])
    treefruit_df$TF_AbRelSizePow <- rep(tree_df$TF_AbRelSizePow, length(Fruitbunch))
    treefruit_df$TF_FruitAbDWLoss <- treefruit_df$TF_BunchWeight_kgpbunch *
      (treefruit_df$TF_FruitNumbLoss^treefruit_df$TF_AbRelSizePow)
    
    # TF_FruitLitterFalloAm[Tree,Fruitbunch] = TF_MaleDWloss[Tree,Fruitbunch]+TF_FruitAbDWLoss[Tree,Fruitbunch]
    treefruit_df$TF_FruitLitterFalloAm <- treefruit_df$TF_MaleDWloss + treefruit_df$TF_FruitAbDWLoss
    
    # PD_TFrugImp[Tree,Animals] = PD_TFrugivore?[Animals]*PD_TEatenBy?[Tree,Animals]*PD_NastiesinPlot[Animals]
    treeanimal_df$PD_TFrugivore_is <- rep(animal_df$PD_TFrugivore_is, each = ntree)
    treeanimal_df$PD_TFrugImp <- treeanimal_df$PD_TFrugivore_is * treeanimal_df$PD_TEatenBy_is * treeanimal_df$PD_NastiesinPlot
    tree_df$PD_TFrugImp_sum <- aggregate(treeanimal_df["PD_TFrugImp"], treeanimal_df["tree_id"], sum)$PD_TFrugImp
    
    # PD_TFrugVFrac[Tree] = min(1,PD_TFrugiv&Abort[Tree]+AF_DynPestImpacts?*ARRAYSUM(PD_TFrugImp[Tree,*]))
    tree_df$PD_TFrugVFrac <- pmin(1,
                                  tree_df$PD_TFrugiv_Abort + AF_DynPestImpacts_is * tree_df$PD_TFrugImp_sum)
    
    # T_GenLitStage[Tree] = GRAPH(T_Stage[Tree,VegGen])
    tree_df$T_GenLitStage <- get_y_df(treestage_df[treestage_df$Tree_Stage == "VegGen", "T_Stage"], "T_GenLitStage")
    
    # T_Frug_and_Littfall[PlantComp,Tree] = if T_ApplyPalm?[Tree]=1 then arraysum(TF_FruitLitterFalloAm[Tree,*]) * T_TreesperHa[Tree]/10^4 else if T_DiesToday?[Tree] = 1 then T_Fruit[PlantComp,Tree]/dt else T_Fruit[PlantComp,Tree]*PD_TFrugVFrac[Tree]+T_GenLitFracMax[Tree]*T_GenLitStage[Tree]*T_Fruit[PlantComp,Tree]
    tree_df$TF_FruitLitterFalloAm_sum <- aggregate(treefruit_df["TF_FruitLitterFalloAm"], treefruit_df["tree_id"], sum)$TF_FruitLitterFalloAm
    treepcomp_df$TF_FruitLitterFalloAm_sum <- rep(tree_df$TF_FruitLitterFalloAm_sum, nrow(pcomp_df))
    treepcomp_df$PD_TFrugVFrac <- rep(tree_df$PD_TFrugVFrac, nrow(pcomp_df))
    treepcomp_df$T_GenLitFracMax <- rep(tree_df$T_GenLitFracMax, nrow(pcomp_df))
    treepcomp_df$T_GenLitStage <- rep(tree_df$T_GenLitStage, nrow(pcomp_df))
    
    treepcomp_df$T_Frug_and_Littfall <- ifelse(
      treepcomp_df$T_ApplyPalm_is == 1,
      treepcomp_df$TF_FruitLitterFalloAm_sum * treepcomp_df$T_Treesperha / 10^4,
      ifelse(
        treepcomp_df$T_DiesToday_is == 1,
        treepcomp_df$T_Fruit,
        treepcomp_df$T_Fruit * treepcomp_df$PD_TFrugVFrac + treepcomp_df$T_GenLitFracMax *
          treepcomp_df$T_GenLitStage * treepcomp_df$T_Fruit
      )
    )
    
    # TF_BunchWeightHarvest[Sp1,Ripe] = if TF_NewLeaf?[Sp1] = 1 and TF_BunchGender[Sp1,Ripe] = 2 then TF_BunchWeight_kgpbunch[Sp1,Ripe]/dt else 0
    # TF_BunchWeightHarvest[Sp1,Ripe_1] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_2] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_3] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_4] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_5] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_6] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_7] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_8] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_9] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_10] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_11] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Ripe_12] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Early_fruit] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Pollinated] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis_1] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis_2] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis_3] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis_4] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis_5] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp1,Anthesis_6] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe] = if TF_NewLeaf?[Sp2] = 1 and TF_BunchGender[Sp2,Ripe] = 2 then TF_BunchWeight_kgpbunch[Sp2,Ripe]/dt else 0
    # TF_BunchWeightHarvest[Sp2,Ripe_1] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_2] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_3] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_4] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_5] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_6] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_7] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_8] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_9] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_10] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_11] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Ripe_12] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Early_fruit] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Pollinated] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis_1] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis_2] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis_3] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis_4] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis_5] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp2,Anthesis_6] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe] = if TF_NewLeaf?[Sp3] = 1 and TF_BunchGender[Sp3,Ripe] = 2 then TF_BunchWeight_kgpbunch[Sp3,Ripe]/dt else 0
    # TF_BunchWeightHarvest[Sp3,Ripe_1] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_2] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_3] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_4] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_5] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_6] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_7] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_8] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_9] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_10] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_11] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Ripe_12] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Early_fruit] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Pollinated] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis_1] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis_2] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis_3] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis_4] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis_5] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    # TF_BunchWeightHarvest[Sp3,Anthesis_6] = 0*(TF_NewLeaf?[Sp1]+TF_BunchWeight_kgpbunch[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe])
    
    treefruit_df$TF_BunchWeightHarvest <- 0
    tf_Ripe <- treefruit_df[treefruit_df$Fruitbunch == "Ripe", ]
    treefruit_df[treefruit_df$Fruitbunch == "Ripe", ]$TF_BunchWeightHarvest <- ifelse(
      tree_df$TF_NewLeaf_is == 1 &
        tf_Ripe$TF_BunchGender == 2,
      tf_Ripe$TF_BunchWeight_kgpbunch,
      0
    )
    
    # T_RipeFruitHarvest[PlantComp,Tree] = if T_ApplyPalm?[Tree] then TF_BunchWeightHarvest[Tree,Ripe] * T_TreesperHa[Tree]/10^4 else if (T_Stage[Tree,VegGen]>=2)then(T_Fruit[PlantComp,Tree])  else(0)
    tree_df$TF_BunchWeightHarvest_ripe <- treefruit_df[treefruit_df$Fruitbunch == "Ripe", ]$TF_BunchWeightHarvest
    treepcomp_df$TF_BunchWeightHarvest_ripe <- rep(tree_df$TF_BunchWeightHarvest_ripe, nrow(pcomp_df))
    treepcomp_df$T_Stage_VegGen <- rep(tree_df$T_Stage_VegGen, nrow(pcomp_df))
    treepcomp_df$T_RipeFruitHarvest <- ifelse(
      treepcomp_df$T_ApplyPalm_is == 1,
      treepcomp_df$TF_BunchWeightHarvest_ripe * treepcomp_df$T_Treesperha / 10^4,
      ifelse (treepcomp_df$T_Stage_VegGen >=
                2, treepcomp_df$T_Fruit, 0)
    )
    
    # T_PrunFruit[PlantComp,Tree] = if T_Prun[DW, Tree]> 0 then T_PrunFrac[Tree]*T_Fruit[PlantComp,Tree]/dt  else 0
    treepcomp_df$T_PrunFrac <- rep(tree_df$T_PrunFrac, nrow(pcomp_df))
    treepcomp_df$T_PrunFruit <- ifelse(treepcomp_df$T_Prun_DW > 0,
                                       treepcomp_df$T_PrunFrac * treepcomp_df$T_Fruit,
                                       0)
    
    # T_PrunHarvFracD[Sp1] = GRAPH(T_PrunPast)
    tree_df$T_PrunHarvFracD <- get_T_PrunHarvFracD(T_PrunPast)
    
    # T_PrunHarvInc[PlantComp,Tree] = (1-T_PrunType?)* T_PrunHarvFracC[Tree]*(T_Prun[PlantComp,Tree] + T_PrunFruit[PlantComp,Tree]) + T_PrunType?*T_PrunHarvFracD[Tree] *(T_Prun[PlantComp,Tree]+T_PrunFruit[PlantComp,Tree])
    treepcomp_df$T_PrunHarvFracC <- rep(tree_df$T_PrunHarvFracC, nrow(pcomp_df))
    treepcomp_df$T_PrunHarvFracD <- rep(tree_df$T_PrunHarvFracD, nrow(pcomp_df))
    
    treepcomp_df$T_PrunHarvInc <-  (1 - T_PrunType_is) * treepcomp_df$T_PrunHarvFracC *
      (treepcomp_df$T_Prun + treepcomp_df$T_PrunFruit) +
      T_PrunType_is * treepcomp_df$T_PrunHarvFracD * (treepcomp_df$T_Prun +
                                                        treepcomp_df$T_PrunFruit)
    
    # T_PrunMulch[PlantComp,Tree] = T_Herbivory[PlantComp,Tree]+ T_Frug_and_Littfall[PlantComp,Tree]  + (1 - T_FruitHarvFrac[Tree]) * T_RipeFruitHarvest[PlantComp,Tree] + T_Prun[PlantComp,Tree] + T_PrunFruit[PlantComp,Tree] - T_PrunHarvInc[PlantComp,Tree]
    treepcomp_df$T_FruitHarvFrac <- rep(tree_df$T_FruitHarvFrac, nrow(pcomp_df))
    
    treepcomp_df$T_PrunMulch <- treepcomp_df$T_Herbivory + treepcomp_df$T_Frug_and_Littfall  +
      (1 - treepcomp_df$T_FruitHarvFrac) * treepcomp_df$T_RipeFruitHarvest +
      treepcomp_df$T_Prun + treepcomp_df$T_PrunFruit - treepcomp_df$T_PrunHarvInc
    
    # S&B_DeadWoodLitTransfer[Zone,PlantComp] = S&B_DailyDeadWoodLitTransfer*S&B_DeadWood[Zone,PlantComp]
    zonepcomp_df$SB_DeadWoodLitTransfer <- SB_DailyDeadWoodLitTransfer * zonepcomp_df$SB_DeadWood
    
    # MC_LitterAmount[Zone] = C_ResidMulch[Zone,DW]+(T_LifallInc[DW,Sp1]*T_LifallWtAct[Zone,Sp1]+T_LifallInc[DW,Sp2]*T_LifallWtAct[Zone,Sp2]+T_LifallInc[DW,Sp3]*T_LifallWtAct[Zone,Sp3])+(T_PrunMulch[DW,Sp1]*T_PrunWtAct[Zone,Sp1]+T_PrunMulch[DW,Sp2]*T_PrunWtAct[Zone,Sp2]+T_PrunMulch[DW,Sp3]*T_PrunWtAct[Zone,Sp3])+S&B_NecromLitTransf[Zone,DW]+S&B_DeadWoodLitTransfer[Zone,DW]/1000
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_LifallInc", "T_PrunMulch")]
    tp_DW <- tp_DW[rep(seq_len(nrow(tp_DW)), each = nzone), ]
    zonetree_df[c("T_LifallInc_DW", "T_PrunMulch_DW")] <- tp_DW
    zonetree_df$T_LifallInc_DW_WtAct <- zonetree_df$T_LifallInc_DW * zonetree_df$T_LifallWtAct
    zonetree_df$T_PrunMulch_DW_WtAct <- zonetree_df$T_PrunMulch_DW * zonetree_df$T_PrunWtAct
    sum_df <- aggregate(zonetree_df[c("T_LifallInc_DW_WtAct", "T_PrunMulch_DW_WtAct")], zonetree_df["zone"], sum)
    zp_DW <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", ]
    zone_df$MC_LitterAmount <- zp_DW$C_ResidMulch + sum_df$T_LifallInc_DW_WtAct +
      sum_df$T_PrunMulch_DW_WtAct + zp_DW$SB_NecromLitTransf + zp_DW$SB_DeadWoodLitTransfer /
      1000
    
    # CA_FertAppDoY = GRAPH(CA_PastFertApp)
    CA_FertAppDoY <- get_y_df(CA_PastFertApp, "CA_FertAppDoY")
    
    # CA_FertAppYear = GRAPH(CA_PastFertApp)
    CA_FertAppYear <- get_y_df(CA_PastFertApp, "CA_FertAppYear")
    
    # CA_FertAppTime = CA_FertAppDoY + 365*CA_FertAppYear-CA_DOYStart
    CA_FertAppTime <- CA_FertAppDoY + 365 * CA_FertAppYear - CA_DOYStart
    
    # CA_FertApp = if time = int(CA_FertAppTime) then 1 else 0
    CA_FertApp <- ifelse(time == floor(CA_FertAppTime), 1 , 0)
    
    # CA_ExtOrgApply?[1] = GRAPH(CA_PastFertApp)
    # CA_ExtOrgApply?[2] = GRAPH(CA_PastFertApp)
    inp_df$CA_ExtOrgApply_is <- get_y_df(CA_PastFertApp, "CA_ExtOrgApply_is")
    
    # CA_FertAmount[Zn1] = GRAPH(CA_PastFertApp)
    # CA_FertAmount[Zn2] = GRAPH(CA_PastFertApp)
    # CA_FertAmount[Zn3] = GRAPH(CA_PastFertApp)
    # CA_FertAmount[Zn4] = GRAPH(CA_PastFertApp)
    zone_df$CA_FertAmount <- get_y_df(CA_PastFertApp, "CA_FertAmount")
    
    # CA_ExtOrgAppZn[ExtOrgInputs,Zone] = if CA_FertApp = 1 then CA_ExtOrgApply?[ExtOrgInputs]*CA_FertAmount[Zone] else 0
    zoneinp_df$CA_FertApp <- CA_FertApp
    zoneinp_df$CA_ExtOrgApply_is <- rep(inp_df$CA_ExtOrgApply_is, each = nzone)
    zoneinp_df$CA_FertAmount <- rep(zone_df$CA_FertAmount, nrow(inp_df))
    
    zoneinp_df$CA_ExtOrgAppZn <- ifelse(
      zoneinp_df$CA_FertApp == 1,
      zoneinp_df$CA_ExtOrgApply_is * zoneinp_df$CA_FertAmount,
      0
    )
    
    # MC_LitterC[Zone] = MC_Carbon*1000*MC_LitterAmount[Zone]+CA_ExtOrgAppZn[1,Zone]*MC_CExtOrg[1]+CA_ExtOrgAppZn[2,Zone]*MC_CExtOrg[2]
    zoneinp_df$CA_ExtOrgAppZn_x <-  zoneinp_df$CA_ExtOrgAppZn * rep(inp_df$MC_CExtOrg, each = nzone)
    zone_df$CA_ExtOrgAppZn_sum <- aggregate(zoneinp_df["CA_ExtOrgAppZn_x"], zoneinp_df["zone"], sum)$CA_ExtOrgAppZn_x
    zone_df$MC_LitterC <- MC_Carbon * 1000 * zone_df$MC_LitterAmount + zone_df$CA_ExtOrgAppZn_sum
    
    # T_NLifallInc[N,Sp1] = T_LifallInc[N,Sp1]
    # T_NLifallInc[N,Sp2] = T_LifallInc[N,Sp2]
    # T_NLifallInc[N,Sp3] = T_LifallInc[N,Sp3]
    # T_NLifallInc[P,Sp1] = T_LifallInc[P,Sp1]
    # T_NLifallInc[P,Sp2] = T_LifallInc[P,Sp2]
    # T_NLifallInc[P,Sp3] = T_LifallInc[P,Sp3]
    treenut_df$T_NLifallInc <- treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), "T_LifallInc"]
    
    # T_NPrunMulch[N,Sp1] = T_PrunMulch[N,Sp1]
    # T_NPrunMulch[N,Sp2] = T_PrunMulch[N,Sp2]
    # T_NPrunMulch[N,Sp3] = T_PrunMulch[N,Sp3]
    # T_NPrunMulch[P,Sp1] = T_PrunMulch[P,Sp1]
    # T_NPrunMulch[P,Sp2] = T_PrunMulch[P,Sp2]
    # T_NPrunMulch[P,Sp3] = T_PrunMulch[P,Sp3]
    treenut_df$T_NPrunMulch <- treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), "T_PrunMulch"]
    
    # C_NResidMulch[Zn1,N] = C_ResidMulch[Zn1,N]
    # C_NResidMulch[Zn1,P] = C_ResidMulch[Zn1,P]
    # C_NResidMulch[Zn2,N] = C_ResidMulch[Zn2,N]
    # C_NResidMulch[Zn2,P] = C_ResidMulch[Zn2,P]
    # C_NResidMulch[Zn3,N] = C_ResidMulch[Zn3,N]
    # C_NResidMulch[Zn3,P] = C_ResidMulch[Zn3,P]
    # C_NResidMulch[Zn4,N] = C_ResidMulch[Zn4,N]
    # C_NResidMulch[Zn4,P] = C_ResidMulch[Zn4,P]
    zonenut_df$C_NResidMulch <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_ResidMulch"]
    
    # C_NNecroLitF[Zn1,N] = S&B_NecromLitTransf[Zn1,N]+S&B_DeadWoodLitTransfer[Zn1,N]
    # C_NNecroLitF[Zn1,P] = S&B_NecromLitTransf[Zn1,P]+S&B_DeadWoodLitTransfer[Zn1,P]
    # C_NNecroLitF[Zn2,N] = S&B_NecromLitTransf[Zn2,N]+S&B_DeadWoodLitTransfer[Zn2,N]
    # C_NNecroLitF[Zn2,P] = S&B_NecromLitTransf[Zn2,P]+S&B_DeadWoodLitTransfer[Zn2,P]
    # C_NNecroLitF[Zn3,N] = S&B_NecromLitTransf[Zn3,N]+S&B_DeadWoodLitTransfer[Zn3,N]
    # C_NNecroLitF[Zn3,P] = S&B_NecromLitTransf[Zn3,P]+S&B_DeadWoodLitTransfer[Zn3,P]
    # C_NNecroLitF[Zn4,N] = S&B_NecromLitTransf[Zn4,N]+S&B_DeadWoodLitTransfer[Zn4,N]
    # C_NNecroLitF[Zn4,P] = S&B_NecromLitTransf[Zn4,P]+S&B_DeadWoodLitTransfer[Zn4,P]
    zonenut_df$C_NNecroLitF <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "SB_NecromLitTransf"] + zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "SB_DeadWoodLitTransfer"]
    
    # MN_LitInpN[Zone,SlNut] = C_NResidMulch[Zone,SlNut]+T_NLifallInc[SlNut,Sp1]*T_LifallWtAct[Zone,Sp1]+T_NLifallInc[SlNut,Sp2]*T_LifallWtAct[Zone,Sp2]+T_NLifallInc[SlNut,Sp3]*T_LifallWtAct[Zone,Sp3]
    # + T_NPrunMulch[SlNut,Sp1]*T_PrunWtAct[Zone,Sp1]+ T_NPrunMulch[SlNut,Sp2]*T_PrunWtAct[Zone,Sp2]+ T_NPrunMulch[SlNut,Sp3]*T_PrunWtAct[Zone,Sp3]+ C_NNecroLitF[Zone,SlNut]
    tn_col <- c("T_NLifallInc", "T_NPrunMulch")
    zonetreenut_df[tn_col] <- treenut_df[tn_col][rep(seq_len(nrow(treenut_df)), each = nzone), ]
    zt_col <- c("T_LifallWtAct", "T_PrunWtAct")
    zonetreenut_df[zt_col] <- zonetree_df[zt_col][rep(seq_len(nrow(zonetree_df)), nrow(nut_df)), ]
    zonetreenut_df$T_NLifallInc_Act <- zonetreenut_df$T_NLifallInc * zonetreenut_df$T_LifallWtAct
    zonetreenut_df$T_NPrunMulch_Act <- zonetreenut_df$T_NPrunMulch * zonetreenut_df$T_PrunWtAct
    sum_col <- c("T_NLifallInc_Act", "T_NPrunMulch_Act")
    zonenut_df[c("T_NLifallInc_Act_sum", "T_NPrunMulch_Act_sum")] <- aggregate(zonetreenut_df[sum_col], zonetreenut_df[c("zone", "SlNut")], sum)[sum_col]
    zonenut_df$MN_LitInpN <- zonenut_df$C_NResidMulch + zonenut_df$T_NLifallInc_Act_sum + zonenut_df$T_NPrunMulch_Act_sum + zonenut_df$C_NNecroLitF
    
    # MN_LitterNConc[Zone,SlNut] = IF(MC_LitterAmount[Zone]>0 OR CA_ExtOrgAppZn[1,Zone]>0 OR CA_ExtOrgAppZn[2,Zone]>0)THEN(MN_LitInpN[Zone,SlNut]/(MC_LitterAmount[Zone]*1000+CA_ExtOrgAppZn[1,Zone]+CA_ExtOrgAppZn[2,Zone]))ELSE(0)
    zonenut_df$MC_LitterAmount <- rep(zone_df$MC_LitterAmount, nrow(nut_df))
    zone_df$CA_ExtOrgAppZn_inp1 <- zoneinp_df[zoneinp_df$ExtOrgInputs == 1, "CA_ExtOrgAppZn"]
    zone_df$CA_ExtOrgAppZn_inp2 <- zoneinp_df[zoneinp_df$ExtOrgInputs == 2, "CA_ExtOrgAppZn"]
    zonenut_df$CA_ExtOrgAppZn_inp1 <- rep(zone_df$CA_ExtOrgAppZn_inp1, nrow(nut_df))
    zonenut_df$CA_ExtOrgAppZn_inp2 <- rep(zone_df$CA_ExtOrgAppZn_inp2, nrow(nut_df))
    
    zonenut_df$MN_LitterNConc <- ifelse(
      zonenut_df$MC_LitterAmount > 0 |
        zonenut_df$CA_ExtOrgAppZn_inp1 > 0 |
        zonenut_df$CA_ExtOrgAppZn_inp2 >
        0,
      zonenut_df$MN_LitInpN / (
        zonenut_df$MC_LitterAmount * 1000 + zonenut_df$CA_ExtOrgAppZn_inp1 + zonenut_df$CA_ExtOrgAppZn_inp2
      ),
      0
    )
    
    # MC_LitterLignPolyp[Zone] = IF(MC_LitterAmount[Zone]>0 or CA_ExtOrgAppZn[1,Zone]>0 or CA_ExtOrgAppZn[2,Zone]>0)
    # THEN((CA_ExtOrgAppZn[1,Zone]*(MC_LignExtOrg[1]+MC_PolypExtOrg[1])+CA_ExtOrgAppZn[2,Zone]*(MC_LignExtOrg[2]+MC_PolypExtOrg[2])+(CQ_LignResidCurr[Zone]+CQ_PolyResid[Zone])*C_ResidMulch[Zone,DW]+((T_LignLifall[Sp1]+T_PolypLifall[Sp1])*T_LifallInc[DW,Sp1]*T_LifallWtAct[Zone,Sp1]+(T_LignLifall[Sp2]+T_PolypLifall[Sp2])*T_LifallInc[DW,Sp2]*T_LifallWtAct[Zone,Sp2]+(T_LignLifall[Sp3]+T_PolypLifall[Sp3])*T_LifallInc[DW,Sp3]*T_LifallWtAct[Zone,Sp3])+((T_LignPrun[Sp1]+T_PolypPrun[Sp1])*T_PrunMulch[DW,Sp1]*T_PrunWtAct[Zone,Sp1]+(T_LignPrun[Sp2]+T_PolypPrun[Sp2])*T_PrunMulch[DW,Sp2]*T_PrunWtAct[Zone,Sp2]+(T_LignPrun[Sp3]+T_PolypPrun[Sp3])*T_PrunMulch[DW,Sp3]*T_PrunWtAct[Zone,Sp3]))/(MC_LitterAmount[Zone]+CA_ExtOrgAppZn[1,Zone]+CA_ExtOrgAppZn[2,Zone]))ELSE(0)
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_LifallInc", "T_PrunMulch")]
    inp_df$MC_Lign_Polyp <- inp_df$MC_LignExtOrg + inp_df$MC_PolypExtOrg
    zoneinp_df$CA_ExtOrgAppZn_Lign_Polyp <- zoneinp_df$CA_ExtOrgAppZn * rep(inp_df$MC_Lign_Polyp, each = nzone)
    tree_df$T_Lign_Polyp_LifallInc <- (tree_df$T_LignLifall + tree_df$T_PolypLifall) * tp_DW$T_LifallInc
    tree_df$T_Lign_Polyp_PrunMulch <- (tree_df$T_LignPrun + tree_df$T_PolypPrun) * tp_DW$T_PrunMulch
    zonetree_df$T_LifallWtAct_xLifallInc <- zonetree_df$T_LifallWtAct * rep(tree_df$T_Lign_Polyp_LifallInc, each = nzone)
    zonetree_df$T_PrunWtAct_xPrunMulch <- zonetree_df$T_PrunWtAct * rep(tree_df$T_Lign_Polyp_PrunMulch, each = nzone)
    
    zone_df$MC_LitterLignPolyp <- ifelse(
      zone_df$MC_LitterAmount > 0 |
        zone_df$CA_ExtOrgAppZn_inp1 > 0 |
        zone_df$CA_ExtOrgAppZn_inp2 > 0,
      (
        aggregate(zoneinp_df["CA_ExtOrgAppZn_Lign_Polyp"], zoneinp_df["zone"], sum)$CA_ExtOrgAppZn_Lign_Polyp +
          (zone_df$CQ_LignResidCurr + zone_df$CQ_PolyResid) * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_ResidMulch"] +
          aggregate(zonetree_df["T_LifallWtAct_xLifallInc"], zonetree_df["zone"], sum)$T_LifallWtAct_xLifallInc +
          aggregate(zonetree_df["T_PrunWtAct_xPrunMulch"], zonetree_df["zone"], sum)$T_PrunWtAct_xPrunMulch
      ) / (
        zone_df$MC_LitterAmount + zone_df$CA_ExtOrgAppZn_inp1 + zone_df$CA_ExtOrgAppZn_inp2
      ),
      0
    )
    
    
    # MC_SplitMet[Zone] = IF(MN_LitterNConc[Zone,N]>0)THEN MAX((0.85 - 0.018*MC_LitterLignPolyp[Zone]/MN_LitterNConc[Zone,N]),0)ELSE(0)
    zn_N <- zonenut_df[zonenut_df$SlNut == "N", c("zone", "MN_LitterNConc")]
    zone_df$MC_SplitMet <- ifelse(zn_N$MN_LitterNConc > 0, pmax((
      0.85 - 0.018 *
        zone_df$MC_LitterLignPolyp / zn_N$MN_LitterNConc
    ),
    0
    ), 0)
    
    # MC_MetabIn[Zone] = MC_LitterC[Zone]*MC_SplitMet[Zone]
    zone_df$MC_MetabIn <- zone_df$MC_LitterC * zone_df$MC_SplitMet
    
    # MC_StrucIn[Zone] = MC_LitterC[Zone]-MC_MetabIn[Zone]
    zone_df$MC_StrucIn <- zone_df$MC_LitterC - zone_df$MC_MetabIn
    
    # MC_StrucLig[Zone] = MC_LitterLignPolyp[Zone]/(1-MC_SplitMet[Zone])
    zone_df$MC_StrucLig <- zone_df$MC_LitterLignPolyp / (1 - zone_df$MC_SplitMet)
    
    # MC_LitTemp[Zone] = Temp[Zone,1]
    zone_df$MC_LitTemp <- zonelayer_df[zonelayer_df$layer == 1, "Temp"]
    
    # MC_LitTempLim[Zone] = GRAPH(MC_LitTemp[Zone])
    zone_df$MC_LitTempLim <- get_y_df(zone_df$MC_LitTemp, "MC_LitTempLim")
    
    # MC_ThetaLitter[Zone] = W_Theta1[Zone]
    zone_df$MC_ThetaLitter <- zonelayer_df[zonelayer_df$layer == 1, "W_Theta"]
    
    # W_ThetaPMax[Zone] = GRAPH(W_PMax)
    zone_df$W_ThetaPMax <- get_y_df(W_PMax, "W_ThetaPMax")
    
    # MC_ThetaLim[Zone] = MAX(0,MIN(MIN(MAX(0,3.33*MC_ThetaLitter[Zone]/W_ThetaPMax[Zone])-0.667,1),-1.2*MC_ThetaLitter[Zone]/W_ThetaPMax[Zone]+1.9))
    zone_df$MC_ThetaLim <- pmax(0,
                                pmin(
                                  pmin(
                                    pmax(0, 3.33 * zone_df$MC_ThetaLitter / zone_df$W_ThetaPMax) - 0.667,
                                    1
                                  ),
                                  -1.2 * zone_df$MC_ThetaLitter / zone_df$W_ThetaPMax + 1.9
                                ))
    
    # MC_kStrucCur[Zone] = MC_RelKStrucLit*MC2_kStruc*EXP(-3.0*MC_StrucLig[Zone])*MC_LitTempLim[Zone]*MC_ThetaLim[Zone]
    zone_df$MC_kStrucCur <- MC_RelKStrucLit * MC2_kStruc *
      exp(-3.0 * zone_df$MC_StrucLig) * zone_df$MC_LitTempLim * zone_df$MC_ThetaLim
    
    # S&B_SurfLitBurnFrac[Zone] = GRAPH(S&B_FireTempIncSurf[Zone])
    zone_df$SB_SurfLitBurnFrac <- get_y_df(zone_df$SB_FireTempIncSurf, "SB_SurfLitBurnFrac")
    
    # MC_StrucActCO2In[Zone] = MC_Struc[Zone]*((1-MC_StrucLig[Zone])*MC_kStrucCur[Zone]*(1-MC_EffStrucAct)+S&B_SurfLitBurnFrac[Zone])
    zone_df$MC_StrucActCO2In <- zone_df$MC_Struc * ((1 - zone_df$MC_StrucLig) *
                                                      zone_df$MC_kStrucCur * (1 - MC_EffStrucAct) + zone_df$SB_SurfLitBurnFrac
    )
    
    # MC_StrucSlwCO2In[Zone] = (MC_Struc[Zone]-MC_StrucActCO2In[Zone])*MC_StrucLig[Zone]*MC_kStrucCur[Zone]*(1-MC_EffStrucSlw)
    zone_df$MC_StrucSlwCO2In <- (zone_df$MC_Struc - zone_df$MC_StrucActCO2In) * zone_df$MC_StrucLig * zone_df$MC_kStrucCur *
      (1 - MC_EffStrucSlw)
    
    # MN_CNActAct[Zone,SlNut] = IF(TIME>1)THEN (if MN_Act[Zone,SlNut]>0 then (MC_Act[Zone]/MN_Act[Zone,SlNut])  else 100)  ELSE(MN_CNAct*MN_NutRatAct[SlNut])
    zonenut_df$MC_Act <- rep(zone_df$MC_Act, nrow(nut_df))
    zonenut_df$MN_NutRatAct <- rep(nut_df$MN_NutRatAct, each = nzone)
    zonenut_df$MN_CNActAct <- ifelse(
      time > 1,
      ifelse(
        zonenut_df$MN_Act > 0,
        zonenut_df$MC_Act / zonenut_df$MN_Act,
        100
      ),
      MN_CNAct * zonenut_df$MN_NutRatAct
    )
    
    # MC_ActDecomDec[Zone,SlNut] = MAX(0,1+MIN(0,-2*(MN_CNActAct[Zone,SlNut]-MN_CNAct*MN_NutRatAct[SlNut])/MN_CNAct*MN_NutRatAct[SlNut]-0.25))
    zonenut_df$MC_ActDecomDec <- pmax(0, 1 + pmin(
      0,
      -2 * (
        zonenut_df$MN_CNActAct - MN_CNAct * zonenut_df$MN_NutRatAct
      ) / MN_CNAct * zonenut_df$MN_NutRatAct - 0.25
    ))
    
    # MC_ActDecomDecMin[Zone] = MIN(MC_ActDecomDec[Zone,N],MC_ActDecomDec[Zone,P])
    zone_df$MC_ActDecomDecMin <- pmin(zonenut_df[zonenut_df$SlNut == "N", "MC_ActDecomDec"], zonenut_df[zonenut_df$SlNut == "P", "MC_ActDecomDec"])
    
    # MC_StrucActF[Zone] = (MC_Struc[Zone]-MC_StrucActCO2In[Zone]-MC_StrucSlwCO2In[Zone])*(1-MC_StrucLig[Zone])*MC_kStrucCur[Zone]*MC_EffStrucAct*MC_ActDecomDecMin[Zone]
    zone_df$MC_StrucActF <- (zone_df$MC_Struc - zone_df$MC_StrucActCO2In -
                               zone_df$MC_StrucSlwCO2In) * (1 - zone_df$MC_StrucLig) * zone_df$MC_kStrucCur *
      MC_EffStrucAct * zone_df$MC_ActDecomDecMin
    
    # MN_CNSlwAct[Zone,SlNut] = IF(TIME>1)THEN(if MN_Slw[Zone,SlNut]>0 then MC_Slw[Zone]/MN_Slw[Zone,SlNut] else 0)ELSE(MN_CNSlw*MN_NutRatSlw[SlNut])
    zonenut_df$MC_Slw <- rep(zone_df$MC_Slw, nrow(nut_df))
    zonenut_df$MN_CNSlwAct <- ifelse(
      time > 1,
      ifelse(
        zonenut_df$MN_Slw > 0,
        zonenut_df$MC_Slw / zonenut_df$MN_Slw,
        0
      ),
      MN_CNSlw * zonenut_df$MN_NutRatSlw
    )
    
    # MC_SlwDecomDecMin[Zone,SlNut] = MAX(0,1+MIN(0,-2*(MN_CNSlwAct[Zone,SlNut]-MN_CNSlw*MN_NutRatSlw[SlNut])/MN_CNSlw*MN_NutRatSlw[SlNut]-0.25))
    zonenut_df$MC_SlwDecomDecMin <- pmax(0, 1 + pmin(
      0,
      -2 * (
        zonenut_df$MN_CNSlwAct - MN_CNSlw * zonenut_df$MN_NutRatSlw
      ) / MN_CNSlw * zonenut_df$MN_NutRatSlw - 0.25
    ))
    
    # MC_SlwDecomDec[Zone] = MIN(MC_SlwDecomDecMin[Zone,N],MC_SlwDecomDecMin[Zone,P])
    zone_df$MC_SlwDecomDec <- pmin(zonenut_df[zonenut_df$SlNut == "N", "MC_SlwDecomDecMin"],
                                   zonenut_df[zonenut_df$SlNut == "P", "MC_SlwDecomDecMin"])
    
    # MC_StructSlwF_act[Zone] = MC_StrucLig[Zone]*MC_kStrucCur[Zone]*MC_EffStrucSlw*MC_SlwDecomDec[Zone]
    zone_df$MC_StructSlwF_act <- zone_df$MC_StrucLig * zone_df$MC_kStrucCur * MC_EffStrucSlw *
      zone_df$MC_SlwDecomDec
    
    # MC_StrucSlwF[Zone] = (MC_Struc[Zone]-MC_StrucActCO2In[Zone]-MC_StrucSlwCO2In[Zone]-MC_StrucActF[Zone])*MC_StructSlwF_act[Zone]
    zone_df$MC_StrucSlwF <- (
      zone_df$MC_Struc - zone_df$MC_StrucActCO2In - zone_df$MC_StrucSlwCO2In - zone_df$MC_StrucActF
    ) * zone_df$MC_StructSlwF_act
    
    # E_PloughDoY = GRAPH(E_PloughPast)
    E_PloughDoY <- get_y_df(E_PloughPast, "E_PloughDoY")
    
    # E_PloughY = GRAPH(E_PloughPast)
    E_PloughY <- get_y_df(E_PloughPast, "E_PloughY")
    
    # E_PloughTimeCal = E_PloughDoY+365*(E_PloughY)-CA_DOYStart
    E_PloughTimeCal <- E_PloughDoY + 365 * (E_PloughY) - CA_DOYStart
    
    # E_PloughTime?[Zone] = if time = int(E_PloughTimeCal) or (time = int(CA_PlantTime[Zone]-E_IntvPloughPlant) and E_PloughBefPlant? = 1) then 1 else 0
    zone_df$E_PloughTime_is <- ifelse(time == floor(E_PloughTimeCal) |
                                        (
                                          time == floor(zone_df$CA_PlantTime - E_IntvPloughPlant) &
                                            E_PloughBefPlant_is == 1
                                        ),
                                      1,
                                      0)
    
    # MC2_TillageEvent[Zone] = if E_PloughTime?[Zone] = 1 then E_TillZone?[Zone] else 0
    zone_df$MC2_TillageEvent <- ifelse(zone_df$E_PloughTime_is == 1, zone_df$E_TillZone_is, 0)
    
    # MC2_LitSomTrans[Zone,CENT_Pools] = min(1,MC2_RainTransfer[CENT_Pools]*RAIN_Infiltr[Zone]+S_LFoodForWorms[Zone]*MC2_WormTransfer[CENT_Pools]+MC2_TillageEvent[Zone]*MC2_SoilTillTransfer[CENT_Pools])
    zonecpools_df$MC2_RainTransfer <- rep(cpools_df$MC2_RainTransfer, each = nzone)
    zonecpools_df$RAIN_Infiltr <- rep(zone_df$RAIN_Infiltr, nrow(cpools_df))
    zonecpools_df$S_LFoodForWorms <- rep(zone_df$S_LFoodForWorms, nrow(cpools_df))
    zonecpools_df$MC2_WormTransfer <- rep(cpools_df$MC2_WormTransfer, each = nzone)
    zonecpools_df$MC2_TillageEvent <- rep(zone_df$MC2_TillageEvent, nrow(cpools_df))
    zonecpools_df$MC2_SoilTillTransfer <- rep(cpools_df$MC2_SoilTillTransfer, each = nzone)
    
    zonecpools_df$MC2_LitSomTrans <- pmin(
      1,
      zonecpools_df$MC2_RainTransfer * zonecpools_df$RAIN_Infiltr +
        zonecpools_df$S_LFoodForWorms * zonecpools_df$MC2_WormTransfer + zonecpools_df$MC2_TillageEvent *
        zonecpools_df$MC2_SoilTillTransfer
    )
    
    
    # MC_Str_LitSomTrans[Zone] = MC2_LitSomTrans[Zone,Str]*(MC_Struc[Zone]+MC_StrucIn[Zone]-MC_StrucActCO2In[Zone]-MC_StrucSlwCO2In[Zone]-MC_StrucActF[Zone]-MC_StrucSlwF[Zone])
    zone_df$MC_Str_LitSomTrans <- zonecpools_df[zonecpools_df$CENT_Pools == "Str", ]$MC2_LitSomTrans *
      (
        zone_df$MC_Struc + zone_df$MC_StrucIn - zone_df$MC_StrucActCO2In - zone_df$MC_StrucSlwCO2In -
          zone_df$MC_StrucActF - zone_df$MC_StrucSlwF
      )
    
    
    
    # MN_CNStrucActual[Zone,SlNut] = if MN_LitInpN[Zone,SlNut] > 0.01 then max(MC_StrucIn[Zone]/MN_LitInpN[Zone,N],MN_CNStruc*MN_NutRatStruc[SlNut]) else MN_CNStruc*MN_NutRatStruc[SlNut]
    zonenut_df$MC_StrucIn <- rep(zone_df$MC_StrucIn, nrow(nut_df))
    zonenut_df$MN_LitInpN_N <- rep(zonenut_df[zonenut_df$SlNut == "N", ]$MN_LitInpN, nrow(nut_df))
    zonenut_df$MN_CNStrucActual <- ifelse(
      zonenut_df$MN_LitInpN > 0.01,
      pmax(
        zonenut_df$MC_StrucIn / zonenut_df$MN_LitInpN_N,
        MN_CNStruc * zonenut_df$MN_NutRatStruc
      ),
      MN_CNStruc * zonenut_df$MN_NutRatStruc
    )
    
    # MN_StrucIn[Zone,SlNut] = IF MN_CNStrucActual[Zone,SlNut] > 0 THEN MC_StrucIn[Zone]/MN_CNStrucActual[Zone,SlNut] ELSE 0
    zonenut_df$MN_StrucIn <- ifelse(
      zonenut_df$MN_CNStrucActual > 0,
      zonenut_df$MC_StrucIn / zonenut_df$MN_CNStrucActual,
      0
    )
    
    # MN_DecActSt[Zone,SlNut] = MC_StrucActF[Zone]/(MC_EffStrucAct*MN_CNStruc*MN_NutRatStruc[SlNut])
    zonenut_df$MC_StrucActF <- rep(zone_df$MC_StrucActF, nrow(nut_df))
    zonenut_df$MN_DecActSt <- zonenut_df$MC_StrucActF / (MC_EffStrucAct * MN_CNStruc *
                                                           zonenut_df$MN_NutRatStruc)
    
    # MN_DemActSt[Zone,SlNut] = MC_StrucActF[Zone]/(MN_CNAct*MN_NutRatAct[SlNut])
    zonenut_df$MN_DemActSt <- zonenut_df$MC_StrucActF / (MN_CNAct *
                                                           zonenut_df$MN_NutRatAct)
    
    # MN_StrucActF[Zone,SlNut] = MIN(MN_DecActSt[Zone,SlNut],MN_DemActSt[Zone,SlNut])
    zonenut_df$MN_StrucActF <- pmin(zonenut_df$MN_DecActSt, zonenut_df$MN_DemActSt)
    
    # MN_DecStrucSlw[Zone,SlNut] = MC_StrucSlwF[Zone]/(MC_EffStrucSlw*MN_CNStruc*MN_NutRatStruc[SlNut])
    zonenut_df$MC_StrucSlwF <- rep(zone_df$MC_StrucSlwF, nrow(nut_df))
    zonenut_df$MN_DecStrucSlw <- zonenut_df$MC_StrucSlwF / (MC_EffStrucSlw *
                                                              MN_CNStruc * zonenut_df$MN_NutRatStruc)
    
    # MN_DemStrucSlw[Zone,SlNut] = MC_StrucSlwF[Zone]/(MN_CNSlw*MN_NutRatSlw[SlNut])
    zonenut_df$MN_DemStrucSlw <- zonenut_df$MC_StrucSlwF / (MN_CNSlw *
                                                              zonenut_df$MN_NutRatSlw)
    
    # MN_StrucSlwF[Zone,SlNut] = MIN(MN_DecStrucSlw[Zone,SlNut],MN_DemStrucSlw[Zone,SlNut])
    zonenut_df$MN_StrucSlwF <- pmin(zonenut_df$MN_DecStrucSlw, zonenut_df$MN_DemStrucSlw)
    
    # MC__StrLitSomTransFrac[Zone] = if MC_Struc[Zone] = 0 then 0 else MC_Str_LitSomTrans[Zone]/MC_Struc[Zone]
    zone_df$MC_StrLitSomTransFrac <- ifelse(zone_df$MC_Struc == 0,
                                            0,
                                            zone_df$MC_Str_LitSomTrans / zone_df$MC_Struc)
    
    # MN_Str_LitSomTrans[Zone,SlNut] = MN_Struc[Zone,SlNut]*MC__StrLitSomTransFrac[Zone]
    zonenut_df$MC_StrLitSomTransFrac <- rep(zone_df$MC_StrLitSomTransFrac, nrow(nut_df))
    zonenut_df$MN_Str_LitSomTrans <- zonenut_df$MN_Struc * zonenut_df$MC_StrLitSomTransFrac
    
    # MN_StrucMinF[Zone,SlNut] = (MN_DecStrucSlw[Zone,SlNut]-MN_StrucSlwF[Zone,SlNut])+(MN_DecActSt[Zone,SlNut]-MN_StrucActF[Zone,SlNut])+S&B_SurfLitBurnFrac[Zone]*(MN_Struc[Zone,SlNut]-MN_StrucActF[Zone,SlNut]-MN_StrucSlwF[Zone,SlNut])
    zonenut_df$SB_SurfLitBurnFrac <- rep(zone_df$SB_SurfLitBurnFrac, nrow(nut_df))
    zonenut_df$MN_StrucMinF <- (zonenut_df$MN_DecStrucSlw - zonenut_df$MN_StrucSlwF) +
      (zonenut_df$MN_DecActSt - zonenut_df$MN_StrucActF) +
      zonenut_df$SB_SurfLitBurnFrac * (zonenut_df$MN_Struc - zonenut_df$MN_StrucActF -
                                         zonenut_df$MN_StrucSlwF)
    
    
    
    # MC_kMetabCur[Zone] = MC2_kMetab*MC_RelKMetabLit*MC_LitTempLim[Zone]*MC_ThetaLim[Zone]
    zone_df$MC_kMetabCur <- MC2_kMetab * MC_RelKMetabLit *
      zone_df$MC_LitTempLim * zone_df$MC_ThetaLim
    
    # MC_MetabCO2In[Zone] = MC_Metab[Zone]*(MC_kMetabCur[Zone]*(1-MC_EffMetab)+S&B_SurfLitBurnFrac[Zone])
    zone_df$MC_MetabCO2In <- zone_df$MC_Metab * (zone_df$MC_kMetabCur *
                                                   (1 - MC_EffMetab) + zone_df$SB_SurfLitBurnFrac)
    
    # MC_MetabActF[Zone] = (MC_Metab[Zone]-MC_MetabCO2In[Zone])*MC_kMetabCur[Zone]*MC_EffMetab*MC_ActDecomDecMin[Zone]
    zone_df$MC_MetabActF <- (zone_df$MC_Metab - zone_df$MC_MetabCO2In) *
      zone_df$MC_kMetabCur * MC_EffMetab * zone_df$MC_ActDecomDecMin
    
    # MC_Met_LitSomTrans[Zone] = MC2_LitSomTrans[Zone,Met]*(MC_Metab[Zone]+MC_MetabIn[Zone]-MC_MetabActF[Zone]-MC_MetabCO2In[Zone])
    zone_df$MC_Met_LitSomTrans <- zonecpools_df[zonecpools_df$CENT_Pools == "Met", ]$MC2_LitSomTrans * (
      zone_df$MC_Metab +
        zone_df$MC_MetabIn - zone_df$MC_MetabActF - zone_df$MC_MetabCO2In
    )
    # MN_ExtOrgInpN[Zone,SlNut] = CA_ExtOrgAppZn[1,Zone]*MN_ExtOrgN[1,SlNut]+CA_ExtOrgAppZn[2,Zone]*MN_ExtOrgN[2,SlNut]
    zonenut_df$MN_ExtOrgInpN <- zoneinp_df[zoneinp_df$ExtOrgInputs == 1, "CA_ExtOrgAppZn"] * nutinp_df[nutinp_df$ExtOrgInputs == 1, ]$MN_ExtOrgN +
      zoneinp_df[zoneinp_df$ExtOrgInputs == 2, "CA_ExtOrgAppZn"] * nutinp_df[nutinp_df$ExtOrgInputs == 2, ]$MN_ExtOrgN
    
    # MN_MetabIn[Zone,SlNut] = MN_ExtOrgInpN[Zone,SlNut]+MN_LitInpN[Zone,SlNut]-MN_StrucIn[Zone,SlNut]
    zonenut_df$MN_MetabIn <- zonenut_df$MN_ExtOrgInpN + zonenut_df$MN_LitInpN -
      zonenut_df$MN_StrucIn
    
    # MN_CNMetab[Zone,SlNut] = IF(MN_Metab[Zone,SlNut]>0)THEN(MC_Metab[Zone]/MN_Metab[Zone,SlNut])ELSE(0)
    zonenut_df$MC_Metab <- rep(zone_df$MC_Metab, nrow(nut_df))
    zonenut_df$MN_CNMetab <- ifelse(zonenut_df$MN_Metab > 0,
                                    zonenut_df$MC_Metab / zonenut_df$MN_Metab,
                                    0)
    
    # MN_DecActMet[Zone,SlNut] = IF(MN_CNMetab[Zone,SlNut]>0)THEN(MC_MetabActF[Zone]/(MC_EffMetab*MN_CNMetab[Zone,SlNut]))ELSE(0)
    zonenut_df$MC_MetabActF <- rep(zone_df$MC_MetabActF, nrow(nut_df))
    zonenut_df$MN_DecActMet <- ifelse(
      zonenut_df$MN_CNMetab > 0,
      zonenut_df$MC_MetabActF / (MC_EffMetab * zonenut_df$MN_CNMetab),
      0
    )
    
    # MN_DemActMet[Zone,SlNut] = MC_MetabActF[Zone]/(MN_CNAct*MN_NutRatAct[SlNut])
    zonenut_df$MN_DemActMet <- zonenut_df$MC_MetabActF / (MN_CNAct *
                                                            zonenut_df$MN_NutRatAct)
    
    # MN_MetabActF[Zone,SlNut] = MIN(MN_DecActMet[Zone,SlNut],MN_DemActMet[Zone,SlNut])
    zonenut_df$MN_MetabActF <- pmin(zonenut_df$MN_DecActMet, zonenut_df$MN_DemActMet)
    
    # MC_MetLitSomTransFrac[Zone] = if MC_Metab[Zone] = 0 then 0 else MC_Met_LitSomTrans[Zone]/MC_Metab[Zone]
    zone_df$MC_MetLitSomTransFrac <- ifelse(zone_df$MC_Metab == 0,
                                            0,
                                            zone_df$MC_Met_LitSomTrans / zone_df$MC_Metab)
    
    # MN_Met_LitSomTrans[Zone,SlNut] = MN_Metab[Zone,SlNut]*MC_MetLitSomTransFrac[Zone]
    zonenut_df$MC_MetLitSomTransFrac <- rep(zone_df$MC_MetLitSomTransFrac, nrow(nut_df))
    zonenut_df$MN_Met_LitSomTrans <- zonenut_df$MN_Metab * zonenut_df$MC_MetLitSomTransFrac
    
    # MN_MetabMinF[Zone,SlNut] = MN_DecActMet[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*(MN_Metab[Zone,SlNut]-MN_MetabActF[Zone,SlNut])
    zonenut_df$MN_MetabMinF <- zonenut_df$MN_DecActMet + zonenut_df$SB_SurfLitBurnFrac *
      (zonenut_df$MN_Metab - zonenut_df$MN_MetabActF)
    
    
    
    # MC_kActCur[Zone] = MC_RelKActLit*MC2_kAct*(1-0.75*MC_TextLitLayer)*MC_LitTempLim[Zone]*MC_ThetaLim[Zone]
    zone_df$MC_kActCur <- MC_RelKActLit * MC2_kAct *
      (1 - 0.75 * MC_TextLitLayer) * zone_df$MC_LitTempLim * zone_df$MC_ThetaLim
    
    # MC_ActCO2In[Zone] = MC_Act[Zone]*(MC_kActCur[Zone]*MC_ActResp+S&B_SurfLitBurnFrac[Zone])
    zone_df$MC_ActCO2In <- zone_df$MC_Act * (zone_df$MC_kActCur * MC_ActResp +
                                               zone_df$SB_SurfLitBurnFrac)
    
    # MC_ActSlw[Zone] = (MC_Act[Zone]-MC_ActCO2In[Zone])*MC_kActCur[Zone]*MC_EffActSlw
    zone_df$MC_ActSlw <- (zone_df$MC_Act - zone_df$MC_ActCO2In) * zone_df$MC_kActCur *
      MC_EffActSlw
    
    # MC_kSlwCur[Zone] = MC_RelKSlwLit*MC2_kSlw*MC_LitTempLim[Zone]*MC_ThetaLim[Zone]
    zone_df$MC_kSlwCur <- MC_RelKSlwLit * MC2_kSlw *
      zone_df$MC_LitTempLim * zone_df$MC_ThetaLim
    
    # MC_SlwAct[Zone] = MC_Slw[Zone]*MC_kSlwCur[Zone]*MC_EffSlwAct
    zone_df$MC_SlwAct <- zone_df$MC_Slw * zone_df$MC_kSlwCur * MC_EffSlwAct
    
    # MC_ActSlwF[Zone] = MC_ActSlw[Zone]-MC_SlwAct[Zone]
    zone_df$MC_ActSlwF <- zone_df$MC_ActSlw - zone_df$MC_SlwAct
    
    # MC_ActPass[Zone] = (MC_Act[Zone]-MC_ActCO2In[Zone]-MC_ActSlw[Zone])*MC_kActCur[Zone]*0.004
    zone_df$MC_ActPass <- (zone_df$MC_Act - zone_df$MC_ActCO2In - zone_df$MC_ActSlw) * zone_df$MC_kActCur *
      0.004
    
    # MC_kPassCur[Zone] = MC_RelKPassLit*MC2_kPass*MC_LitTempLim[Zone]*MC_ThetaLim[Zone]
    zone_df$MC_kPassCur <- MC_RelKPassLit * MC2_kPass *
      zone_df$MC_LitTempLim * zone_df$MC_ThetaLim
    
    # MC_PassAct[Zone] = MC_Pass[Zone]*MC_kPassCur[Zone]*MC_EffPass
    zone_df$MC_PassAct <- zone_df$MC_Pass * zone_df$MC_kPassCur * MC_EffPass
    
    # MC_ActPassF[Zone] = MC_ActPass[Zone]-MC_PassAct[Zone]
    zone_df$MC_ActPassF <- zone_df$MC_ActPass - zone_df$MC_PassAct
    
    # MC_Act_LitSomTrans[Zone] = MC2_LitSomTrans[Zone,Actv]*(MC_Act[Zone]+MC_StrucActF[Zone]+MC_MetabActF[Zone] -MC_ActCO2In[Zone]-MC_ActSlwF[Zone]-MC_ActPassF[Zone])
    zone_df$MC_Act_LitSomTrans <- zonecpools_df[zonecpools_df$CENT_Pools == "Actv", ]$MC2_LitSomTrans *
      (
        zone_df$MC_Act + zone_df$MC_StrucActF + zone_df$MC_MetabActF - zone_df$MC_ActCO2In -
          zone_df$MC_ActSlwF - zone_df$MC_ActPassF
      )
    
    # MC_ActSlw[Zone] = (MC_Act[Zone]-MC_ActCO2In[Zone])*MC_kActCur[Zone]*MC_EffActSlw
    zone_df$MC_ActSlw <- (zone_df$MC_Act - zone_df$MC_ActCO2In) * zone_df$MC_kActCur *
      MC_EffActSlw
    
    # MN_ActSlw[Zone,SlNut] = MC_ActSlw[Zone]/(MN_CNSlw*MN_NutRatSlw[SlNut])
    zonenut_df$MC_ActSlw <- rep(zone_df$MC_ActSlw, nrow(nut_df))
    zonenut_df$MN_ActSlw <- zonenut_df$MC_ActSlw / (MN_CNSlw * zonenut_df$MN_NutRatSlw)
    
    # MN_SlwAct[Zone,SlNut] = MC_SlwAct[Zone]/(MN_CNAct*MN_NutRatAct[SlNut])
    zonenut_df$MC_SlwAct <- rep(zone_df$MC_SlwAct, nrow(nut_df))
    zonenut_df$MN_SlwAct <- zonenut_df$MC_SlwAct / (MN_CNAct *
                                                      zonenut_df$MN_NutRatAct)
    
    # MN_ActSlwF[Zone,SlNut] = MAX(0,MN_ActSlw[Zone,SlNut])-MAX(0,MN_SlwAct[Zone,SlNut])
    zonenut_df$MN_ActSlwF <- pmax(0, zonenut_df$MN_ActSlw) - pmax(0, zonenut_df$MN_SlwAct)
    
    # MN_ActPass[Zone,SlNut] = MC_ActPass[Zone]/(MN_CNPass*MN_NutRatPas[SlNut])
    zonenut_df$MC_ActPass <- rep(zone_df$MC_ActPass, nrow(nut_df))
    zonenut_df$MN_ActPass <- zonenut_df$MC_ActPass / (MN_CNPass *
                                                        zonenut_df$MN_NutRatPas)
    
    # MN_PassAct[Zone,SlNut] = MC_PassAct[Zone]/(MN_CNAct*MN_NutRatAct[SlNut])
    zonenut_df$MC_PassAct <- rep(zone_df$MC_PassAct, nrow(nut_df))
    zonenut_df$MN_PassAct <- zonenut_df$MC_PassAct / (MN_CNAct *
                                                        zonenut_df$MN_NutRatAct)
    
    # MN_ActPassF[Zone,SlNut] = MAX(0,MN_ActPass[Zone,SlNut])-MAX(0,MN_PassAct[Zone,SlNut])
    zonenut_df$MN_ActPassF <- pmax(0, zonenut_df$MN_ActPass) - pmax(0, zonenut_df$MN_PassAct)
    
    # MN_DecAct[Zone,SlNut] = if MC_EffActSlw <> 0 and MN_CNActAct[Zone,SlNut] <> 0 then MC_ActSlw[Zone]/(MC_EffActSlw*MN_CNActAct[Zone,SlNut]) else 0
    zonenut_df$MC_EffActSlw <- MC_EffActSlw
    zonenut_df$MN_DecAct <- ifelse(
      zonenut_df$MC_EffActSlw != 0 &
        zonenut_df$MN_CNActAct != 0,
      zonenut_df$MC_ActSlw / (MC_EffActSlw * zonenut_df$MN_CNActAct),
      0
    )
    
    # MN_ActMin[Zone,SlNut] = MIN(MAX(0,MN_DecAct[Zone,SlNut]-MN_ActSlw[Zone,SlNut]-MN_ActPass[Zone,SlNut]),MN_Act[Zone,SlNut])
    zonenut_df$MN_ActMin <- pmin(
      pmax(
        0,
        zonenut_df$MN_DecAct - zonenut_df$MN_ActSlw - zonenut_df$MN_ActPass
      ),
      zonenut_df$MN_Act
    )
    
    # MN_ImmobAct[Zone,SlNut] = MIN(MN_MinNutpool[Zone,SlNut],MAX(0,MN_DemActMet[Zone,SlNut]-MN_DecActMet[Zone,SlNut])+MAX(0,MN_DemActSt[Zone,SlNut]-MN_DecActSt[Zone,SlNut])+MAX(0,MN_Act[Zone,SlNut]*MN_CNActAct[Zone,SlNut]*(1/(MN_CNAct*MN_NutRatAct[SlNut]) - 1/MN_CNActAct[Zone,SlNut]) ))
    zonenut_df$MN_ImmobAct <- pmin(
      zonenut_df$MN_MinNutpool,
      pmax(0, zonenut_df$MN_DemActMet - zonenut_df$MN_DecActMet) +
        pmax(0, zonenut_df$MN_DemActSt -
               zonenut_df$MN_DecActSt) + pmax(
                 0,
                 zonenut_df$MN_Act * zonenut_df$MN_CNActAct * (
                   1 / (MN_CNAct * zonenut_df$MN_NutRatAct) - 1 / zonenut_df$MN_CNActAct
                 )
               )
    )
    
    # MN_ActMinF[Zone,SlNut] = IF (MN_ActMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Act[Zone,SlNut]-MN_ImmobAct[Zone,SlNut])>0 THEN MIN((MN_ActMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Act[Zone,SlNut]-MN_ImmobAct[Zone,SlNut]),MN_ActMin[Zone,SlNut]) ELSE IF (MN_ActMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Act[Zone,SlNut]-MN_ImmobAct[Zone,SlNut])=0 THEN 0 ELSE -MIN(ABS(MN_ActMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Act[Zone,SlNut]-MN_ImmobAct[Zone,SlNut]),MN_MinNutpool[Zone,SlNut]-MN_Mineralization[Zone,SlNut])
    
    zonenut_df$MN_ActMinF_a <- zonenut_df$MN_ActMin + zonenut_df$SB_SurfLitBurnFrac *
      zonenut_df$MN_Act - zonenut_df$MN_ImmobAct
    
    zonenut_df$MN_ActMinF <- ifelse(
      zonenut_df$MN_ActMinF_a > 0,
      pmin(zonenut_df$MN_ActMinF_a, zonenut_df$MN_ActMin),
      ifelse(
        zonenut_df$MN_ActMinF_a == 0,
        0,
        -pmin(
          abs(zonenut_df$MN_ActMinF_a),
          zonenut_df$MN_MinNutpool - zonenut_df$MN_Mineralization
        )
      )
    )
    
    # MC_ActLitSomTransFrac[Zone] = if MC_Act[Zone]= 0 then 0 else MC_Act_LitSomTrans[Zone]/MC_Act[Zone]
    zone_df$MC_ActLitSomTransFrac <- ifelse(zone_df$MC_Act == 0,
                                            0,
                                            zone_df$MC_Act_LitSomTrans / zone_df$MC_Act)
    
    # MN_Act_LitSomTrans[Zone,SlNut] = MN_Act[Zone,SlNut]*MC_ActLitSomTransFrac[Zone]
    zonenut_df$MC_ActLitSomTransFrac <- rep(zone_df$MC_ActLitSomTransFrac, nrow(nut_df))
    zonenut_df$MN_Act_LitSomTrans <- zonenut_df$MN_Act * zonenut_df$MC_ActLitSomTransFrac
    
    
    
    # MC_SlwPassF[Zone] = MC_Slw[Zone]*MC_kSlwCur[Zone]*MC_EffSlwPass
    zone_df$MC_SlwPassF <- zone_df$MC_Slw * zone_df$MC_kSlwCur * MC_EffSlwPass
    
    # MC_SlwCO2In[Zone] = MC_Slw[Zone]*(MC_kSlwCur[Zone]*(1-MC_EffSlwAct-MC_EffSlwPass)+S&B_SurfLitBurnFrac[Zone])
    zone_df$MC_SlwCO2In <- zone_df$MC_Slw * (
      zone_df$MC_kSlwCur * (1 - MC_EffSlwAct - MC_EffSlwPass) +
        zone_df$SB_SurfLitBurnFrac
    )
    
    # MC_Slw_LitSomTrans[Zone] = MC2_LitSomTrans[Zone,Slow]*(MC_Slw[Zone]+MC_StrucSlwF[Zone]+MC_ActSlwF[Zone]-MC_SlwPassF[Zone]-MC_SlwCO2In[Zone]   )
    zone_df$MC_Slw_LitSomTrans <- zonecpools_df[zonecpools_df$CENT_Pools == "Slow", ]$MC2_LitSomTrans *
      (
        zone_df$MC_Slw + zone_df$MC_StrucSlwF + zone_df$MC_ActSlwF - zone_df$MC_SlwPassF -
          zone_df$MC_SlwCO2In
      )
    
    # MN_SlwPassF[Zone,SlNut] = MC_SlwPassF[Zone]/(MN_CNPass*MN_NutRatPas[SlNut])
    zonenut_df$MC_SlwPassF <- rep(zone_df$MC_SlwPassF, nrow(nut_df))
    zonenut_df$MN_SlwPassF <- zonenut_df$MC_SlwPassF / (MN_CNPass *
                                                          zonenut_df$MN_NutRatPas)
    
    # MN_DecSlw[Zone,SlNut] = if MN_CNSlwAct[Zone,SlNut]> 0 then MC_SlwPassF[Zone]/(MC_EffSlwPass*MN_CNSlwAct[Zone,SlNut]) else 0
    zonenut_df$MN_DecSlw <- ifelse(
      zonenut_df$MN_CNSlwAct > 0,
      zonenut_df$MC_SlwPassF / (MC_EffSlwPass * zonenut_df$MN_CNSlwAct),
      0
    )
    
    # MN_SlwMin[Zone,SlNut] = MAX(0,MN_DecSlw[Zone,SlNut]-MN_SlwAct[Zone,SlNut]-MN_SlwPassF[Zone,SlNut])
    zonenut_df$MN_SlwMin <- pmax(0,
                                 zonenut_df$MN_DecSlw - zonenut_df$MN_SlwAct - zonenut_df$MN_SlwPassF)
    
    # MN_ImmobStrucSlw[Zone,SlNut] = MIN(MN_MinNutpool[Zone,SlNut]-MN_ImmobAct[Zone,SlNut],MAX(0,MN_DemStrucSlw[Zone,SlNut]-MN_DecStrucSlw[Zone,SlNut])+MAX(0, MN_Slw[Zone,SlNut]*MN_CNSlwAct[Zone,SlNut]*(1/(MN_CNSlw*MN_NutRatSlw[SlNut]) - 1/MN_CNSlwAct[Zone,SlNut]) ))
    zonenut_df$MN_ImmobStrucSlw <- pmin(
      zonenut_df$MN_MinNutpool - zonenut_df$MN_ImmobAct,
      pmax(0, zonenut_df$MN_DemStrucSlw -
             zonenut_df$MN_DecStrucSlw) +
        pmax(
          0,
          zonenut_df$MN_Slw * zonenut_df$MN_CNSlwAct * (
            1 / (MN_CNSlw * zonenut_df$MN_NutRatSlw) - 1 / zonenut_df$MN_CNSlwAct
          )
        )
    )
    
    # MN_SlwMinF[Zone,SlNut] = IF (MN_SlwMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Slw[Zone,SlNut]-MN_ImmobStrucSlw[Zone,SlNut])>0 THEN MIN( (MN_SlwMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Slw[Zone,SlNut]-MN_ImmobStrucSlw[Zone,SlNut]),MN_Slw[Zone,SlNut]) ELSE IF (MN_SlwMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Slw[Zone,SlNut]-MN_ImmobStrucSlw[Zone,SlNut])=0 THEN 0 ELSE MAX((MN_SlwMin[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Slw[Zone,SlNut]-MN_ImmobStrucSlw[Zone,SlNut]),-MN_MinNutpool[Zone,SlNut])
    zonenut_df$MN_SlwMinF_a <- zonenut_df$MN_SlwMin + zonenut_df$SB_SurfLitBurnFrac * zonenut_df$MN_Slw -
      zonenut_df$MN_ImmobStrucSlw
    
    zonenut_df$MN_SlwMinF <- ifelse(
      zonenut_df$MN_SlwMinF_a > 0,
      pmin(zonenut_df$MN_SlwMinF_a, zonenut_df$MN_Slw),
      ifelse(
        zonenut_df$MN_SlwMinF_a == 0,
        0,
        pmax(zonenut_df$MN_SlwMinF_a, -zonenut_df$MN_MinNutpool)
      )
    )
    
    # MC_SlwLitSomTransFrac[Zone] = if MC_Slw[Zone] = 0 then 0 else MC_Slw_LitSomTrans[Zone]/MC_Slw[Zone]
    zone_df$MC_SlwLitSomTransFrac <- ifelse(zone_df$MC_Slw == 0,
                                            0,
                                            zone_df$MC_Slw_LitSomTrans / zone_df$MC_Slw)
    
    # MN_Slw_LitSomTrans[Zone,SlNut] = MC_SlwLitSomTransFrac[Zone]*MN_Slw[Zone,SlNut]
    zonenut_df$MC_SlwLitSomTransFrac <- rep(zone_df$MC_SlwLitSomTransFrac, nrow(nut_df))
    zonenut_df$MN_Slw_LitSomTrans <- zonenut_df$MC_SlwLitSomTransFrac *
      zonenut_df$MN_Slw
    
    # MC_PassCO2In[Zone] = MC_Pass[Zone]*(MC_kPassCur[Zone]*(1-MC_EffPass)+S&B_SurfLitBurnFrac[Zone])
    zone_df$MC_PassCO2In <- zone_df$MC_Pass * (zone_df$MC_kPassCur * (1 -
                                                                        MC_EffPass) + zone_df$SB_SurfLitBurnFrac)
    
    # MC_Pas_LitSomTrans[Zone] = MC2_LitSomTrans[Zone,Pass]*(MC_Pass[Zone]+MC_SlwPassF[Zone]-MC_PassCO2In[Zone])
    zone_df$MC_Pas_LitSomTrans <- zonecpools_df[zonecpools_df$CENT_Pools == "Pass", ]$MC2_LitSomTrans *
      (zone_df$MC_Pass + zone_df$MC_SlwPassF - zone_df$MC_PassCO2In)
    
    # MC_PassLitSomTransFrac[Zone] = if MC_Pass[Zone]= 0 then 0 else MC_Pas_LitSomTrans[Zone]/MC_Pass[Zone]
    zone_df$MC_PassLitSomTransFrac <- ifelse(zone_df$MC_Pass == 0,
                                             0,
                                             zone_df$MC_Pas_LitSomTrans / zone_df$MC_Pass)
    
    # MN_Pas_LitSomTrans[Zone,SlNut] = MN_Pass[Zone,SlNut]*MC_PassLitSomTransFrac[Zone]
    zonenut_df$MC_PassLitSomTransFrac <- rep(zone_df$MC_PassLitSomTransFrac, nrow(nut_df))
    zonenut_df$MN_Pas_LitSomTrans <- zonenut_df$MN_Pass * zonenut_df$MC_PassLitSomTransFrac
    
    # MN_DecPass[Zone,SlNut] = MC_PassAct[Zone]/(MC_EffPass*MN_CNPass*MN_NutRatPas[SlNut])
    zonenut_df$MN_DecPass <- zonenut_df$MC_PassAct / (MC_EffPass *
                                                        MN_CNPass * zonenut_df$MN_NutRatPas)
    
    # MN_PasMinF[Zone,SlNut] = MN_DecPass[Zone,SlNut]-MN_PassAct[Zone,SlNut]+S&B_SurfLitBurnFrac[Zone]*MN_Pass[Zone,SlNut]
    zonenut_df$MN_PasMinF <- zonenut_df$MN_DecPass - zonenut_df$MN_PassAct + zonenut_df$SB_SurfLitBurnFrac * zonenut_df$MN_Pass
    
    
    
    # T_RtDec_DW[Zone,SoilLayer] = T_Root_T1_DWdecay[Zone,SoilLayer]+T_Root_T2_DWdecay[Zone,SoilLayer]+T_Root_T3_DWdecay[Zone,SoilLayer]
    # T_RtDec_N[Zone,SoilLayer] = T_Root_T1_Ndecay[Zone,SoilLayer]+T_Root_T2_Ndecay[Zone,SoilLayer]+T_Root_T3_Ndecay[Zone,SoilLayer]
    # T_RtDec_P[Zone,SoilLayer] = T_Root_T1_Pdecay[Zone,SoilLayer]+T_Root_T2_Pdecay[Zone,SoilLayer]+T_Root_T3_Pdecay[Zone,SoilLayer]
    zonelayerpcomp_df$T_RtDec <-  aggregate(zonelayertreepcomp_df["T_Root_decay"], zonelayertreepcomp_df[c("zone", "layer", "PlantComp")], sum)$T_Root_decay
    
    # MC2_InputRtAmount[Zone,SoilLayer] = T_RtDec_DW[Zone,SoilLayer]+C_RtDecay_DW[Zone,SoilLayer]
    zonelayer_df$MC2_InputRtAmount <- zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "DW", "T_RtDec"] +
      zonelayer_df$C_RtDecay_DW
    
    # MC2_OrgInpC[Zone,SoilLayer] = MC_Carbon*1000*MC2_InputRtAmount[Zone,SoilLayer]
    zonelayer_df$MC2_OrgInpC <- MC_Carbon * 1000 * zonelayer_df$MC2_InputRtAmount
    
    # T_RtDec_LignPoly[Zone,SoilLayer] = T_Root_T1_DWdecay[Zone,SoilLayer]*(T_LignRt[Sp1]+T_PolypRt[Sp1])+T_Root_T2_DWdecay[Zone,SoilLayer]*(T_LignRt[Sp2]+T_PolypRt[Sp2])+T_Root_T3_DWdecay[Zone,SoilLayer]*(T_LignRt[Sp3]+T_PolypRt[Sp3])
    zonelayertree_df$T_Root_decay_DW <- zonelayertreepcomp_df[zonelayertreepcomp_df$PlantComp == "DW", "T_Root_decay"]
    tree_df$T_LignRT_PolypRt <- tree_df$T_LignRt + tree_df$T_PolypRt
    zonelayertree_df$T_Root_decay_DW_Light <- zonelayertree_df$T_Root_decay_DW * rep(tree_df$T_LignRT_PolypRt, each = nzone *
                                                                                       nlayer)
    zonelayer_df$T_RtDec_LignPoly <- aggregate(zonelayertree_df["T_Root_decay_DW_Light"], zonelayertree_df[c("zone", "layer")], sum)$T_Root_decay_DW_Light
    
    # MC2_InputLign[Zone,SoilLayer] = IF(MC2_InputRtAmount[Zone,SoilLayer]>0)THEN T_RtDec_LignPoly[Zone,SoilLayer]+(CQ_LignRootResCurr[Zone]+CQ_PolyRt[Zone])*C_RtDecay_DW[Zone,SoilLayer]/MC2_InputRtAmount[Zone,SoilLayer] ELSE(0)
    zonelayer_df$CQ_LignRootResCurr <- rep(zone_df$CQ_LignRootResCurr, nlayer)
    zonelayer_df$CQ_PolyRt <- rep(zone_df$CQ_PolyRt, nlayer)
    zonelayer_df$MC2_InputLign <- ifelse(
      zonelayer_df$MC2_InputRtAmount > 0,
      zonelayer_df$T_RtDec_LignPoly +
        (zonelayer_df$CQ_LignRootResCurr +
           zonelayer_df$CQ_PolyRt) * zonelayer_df$C_RtDecay_DW / zonelayer_df$MC2_InputRtAmount,
      0
    )
    
    # MC2_SplitMet[Zone,SoilLayer] = IF(MN_LitterNConc[Zone,N]>0)THEN(0.85 - 0.018*MC2_InputLign[Zone,SoilLayer]/MN_LitterNConc[Zone,N])ELSE(10^-6)
    zonelayer_df$MN_LitterNConc_N <- rep(zonenut_df[zonenut_df$SlNut == "N", "MN_LitterNConc"], nlayer)
    zonelayer_df$MC2_SplitMet <- ifelse(
      zonelayer_df$MN_LitterNConc_N > 0,
      0.85 - 0.018 * zonelayer_df$MC2_InputLign / zonelayer_df$MN_LitterNConc_N,
      10^-6
    )
    
    # MC2_MetabIn[Zone,SoilLayer] = MC2_OrgInpC[Zone,SoilLayer]*MC2_SplitMet[Zone,SoilLayer]
    zonelayer_df$MC2_MetabIn <- zonelayer_df$MC2_OrgInpC * zonelayer_df$MC2_SplitMet
    
    # W_H1RelDr[Zone] = If W_Stock1[Zone]>0 then W_H1Drain[Zone]/W_Stock1[Zone] else 0
    # W_H2RelDr[Zone] = If W_Stock2[Zone]>0 then W_H2Drain[Zone]/W_Stock2[Zone] else 0
    # W_H3RelDr[Zone] = If W_Stock3[Zone]>0 then W_H3Drain[Zone]/W_Stock3[Zone] else 0
    # W_H4RellDr[Zone] = If W_Stock4[Zone]>0 then W_H4Drain[Zone]/W_Stock4[Zone] else 0
    zonelayer_df$W_HRelDr <- ifelse(zonelayer_df$W_Stock > 0,
                                    zonelayer_df$W_HDrain / zonelayer_df$W_Stock,
                                    0)
    
    
    #TODO: the IF part was not consistent
    # MC2_RH1Drain[Zone] = W_H1RelDr[Zone]
    # MC2_RH2Drain[Zone] = iF AF_Depth2[Zone]>0 THEN (AF_DepthAct1[Zone]/AF_Depth2[Zone])*W_H2RelDr[Zone] ELSE 0
    # MC2_RH3Drain[Zone] = IF AF_Depth2[Zone]>0 THEN (AF_Depth2[Zone]/AF_Depth3[Zone])*W_H3RelDr[Zone] ELSE 0
    # MC2_RH4Drain[Zone] = IF AF_Depth3[Zone]>0 THEN (AF_Depth3[Zone]/AF_Depth4[Zone])*W_H4RellDr[Zone] eLSE 0
    zonelayer_df$MC2_RHDrain <- zonelayer_df$W_HRelDr
    zl24 <- zonelayer_df[zonelayer_df$layer %in% c(2:4), c("AF_Depth", "W_HRelDr")]
    zonelayer_df[zonelayer_df$layer %in% c(2:4), "MC2_RHDrain"] <- ifelse(zl24$AF_Depth >
                                                                           0,
                                                                         (zonelayer_df[zonelayer_df$layer %in% c(1:3), "AF_Depth"] / zl24$AF_Depth) *
                                                                           zl24$W_HRelDr,
                                                                         0)
    
    
    # MC2_Met_LayerTrans[Zn1,1] = (MC2_RH1Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn1,1]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn1,2] = (MC2_RH2Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn1,2]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn1,3] = (MC2_RH3Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH1Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn1,3]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn1,4] = (MC2_RH4Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH1Drain[Zn1]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn1,4]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn2,1] = (MC2_RH1Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn2,1]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn2,2] = (MC2_RH2Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn2,2]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn2,3] = (MC2_RH3Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH1Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn2,3]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn2,4] = (MC2_RH4Drain[Zn2]+0*(W_Rh2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH1Drain[Zn2]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn2,4]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn3,1] = (MC2_RH1Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn3,1]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn3,2] = (MC2_RH2Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn3,2]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn3,3] = (MC2_RH3Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH1Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn3,3]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn3,4] = (MC2_RH4Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH1Drain[Zn3]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn3,4]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn4,1] = (MC2_RH1Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn4,1]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn4,2] = (MC2_RH2Drain[Zn4]+0*(MC2_RH1Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn4,2]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn4,3] = (MC2_RH3Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH1Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn4,3]*MC2_WormTransfer[Met]
    # MC2_Met_LayerTrans[Zn4,4] = (MC2_RH4Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH1Drain[Zn4]))*MC2_RainTransfer[Met]+S_SOMFoodForWorms[Zn4,4]*MC2_WormTransfer[Met]
    
    # MC2_Act_LayerTrans[Zn1,1] = (MC2_RH1Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn1,1]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn1,2] = (MC2_RH2Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn1,2]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn1,3] = (MC2_RH3Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH1Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn1,3]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn1,4] = (MC2_RH4Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH1Drain[Zn1]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn1,4]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn2,1] = (MC2_RH1Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn2,1]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn2,2] = (MC2_RH2Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn2,2]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn2,3] = (MC2_RH3Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH1Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn2,3]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn2,4] = (MC2_RH4Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH1Drain[Zn2]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn2,4]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn3,1] = (MC2_RH1Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn3,1]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn3,2] = (MC2_RH2Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn3,2]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn3,3] = (MC2_RH3Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH1Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn3,3]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn3,4] = (MC2_RH4Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH1Drain[Zn3]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn3,4]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn4,1] = (MC2_RH1Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn4,1]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn4,2] = (MC2_RH2Drain[Zn4]+0*(MC2_RH1Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn4,2]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn4,3] = (MC2_RH3Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH1Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn4,3]*MC2_WormTransfer[Actv]
    # MC2_Act_LayerTrans[Zn4,4] = (MC2_RH4Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH1Drain[Zn4]))*MC2_RainTransfer[Actv]+S_SOMFoodForWorms[Zn4,4]*MC2_WormTransfer[Actv]
    
    # MC2_Slow_LayerTrans[Zn1,1] = (MC2_RH1Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn1,1]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn1,2] = (MC2_RH2Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn1,2]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn1,3] = (MC2_RH3Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH1Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn1,3]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn1,4] = (MC2_RH4Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH1Drain[Zn1]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn1,4]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn2,1] = (MC2_RH1Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn2,1]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn2,2] = (MC2_RH2Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn2,2]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn2,3] = (MC2_RH3Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH1Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn2,3]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn2,4] = (MC2_RH4Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH1Drain[Zn2]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn2,4]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn3,1] = (MC2_RH1Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn3,1]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn3,2] = (MC2_RH2Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn3,2]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn3,3] = (MC2_RH3Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH1Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn3,3]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn3,4] = (MC2_RH4Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH1Drain[Zn3]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn3,4]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn4,1] = (MC2_RH1Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn4,1]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn4,2] = (MC2_RH2Drain[Zn4]+0*(MC2_RH1Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn4,2]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn4,3] = (MC2_RH3Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH1Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn4,3]*MC2_WormTransfer[Slow]
    # MC2_Slow_LayerTrans[Zn4,4] = (MC2_RH4Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH1Drain[Zn4]))*MC2_RainTransfer[Slow]+S_SOMFoodForWorms[Zn4,4]*MC2_WormTransfer[Slow]
    
    # MC2_Struc_LayerTrans[Zn1,1] = (MC2_RH1Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn1,1]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn1,2] = (MC2_RH2Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn1,2]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn1,3] = (MC2_RH3Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH1Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn1,3]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn1,4] = (MC2_RH4Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH1Drain[Zn1]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn1,4]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn2,1] = (MC2_RH1Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn2,1]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn2,2] = (MC2_RH2Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn2,2]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn2,3] = (MC2_RH3Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH1Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn2,3]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn2,4] = (MC2_RH4Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH1Drain[Zn2]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn2,4]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn3,1] = (MC2_RH1Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn3,1]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn3,2] = (MC2_RH2Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn3,2]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn3,3] = (MC2_RH3Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH1Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn3,3]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn3,4] = (MC2_RH4Drain[Zn3]+0*(MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH1Drain[Zn3]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn3,4]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn4,1] = (MC2_RH1Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn4,1]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn4,2] = (MC2_RH2Drain[Zn4]+0*(MC2_RH1Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn4,2]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn4,3] = (MC2_RH3Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH1Drain[Zn4]+MC2_RH4Drain[Zn4]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn4,3]*MC2_WormTransfer[Str]
    # MC2_Struc_LayerTrans[Zn4,4] = (MC2_RH4Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH1Drain[Zn4]))*MC2_RainTransfer[Str]+S_SOMFoodForWorms[Zn4,4]*MC2_WormTransfer[Str]
    
    # MC2_Pass_LayerTrans[Zn1,1] = (MC2_RH1Drain[Zn1]+0*(MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn1,1]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn1,2] = (MC2_RH2Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH3Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn1,2]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn1,3] = (MC2_RH3Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH2Drain[Zn1]+MC2_RH4Drain[Zn1]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn1,3]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn1,4] = (MC2_RH4Drain[Zn1]+0*(MC2_RH1Drain[Zn1]+MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn1,4]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn2,1] = (MC2_RH1Drain[Zn2]+0*(MC2_RH2Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn2,1]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn2,2] = (MC2_RH2Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn2,2]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn2,3] = (MC2_RH3Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH2Drain[Zn2]+MC2_RH4Drain[Zn2]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn2,3]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn2,4] = (MC2_RH4Drain[Zn2]+0*(MC2_RH1Drain[Zn2]+MC2_RH3Drain[Zn2]+MC2_RH2Drain[Zn2]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn2,4]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn3,1] = (MC2_RH1Drain[Zn3]+0*(MC2_RH3Drain[Zn3]+MC2_RH2Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn3,1]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn3,2] = (MC2_RH2Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH3Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn3,2]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn3,3] = (MC2_RH3Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH2Drain[Zn3]+MC2_RH4Drain[Zn3]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn3,3]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn3,4] = (MC2_RH4Drain[Zn3]+0*(MC2_RH1Drain[Zn3]+MC2_RH2Drain[Zn3]+MC2_RH3Drain[Zn3]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn3,4]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn4,1] = (MC2_RH1Drain[Zn4]+0*(MC2_RH4Drain[Zn1]+MC2_RH2Drain[Zn1]+MC2_RH3Drain[Zn1]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn4,1]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn4,2] = (MC2_RH2Drain[Zn4]+0*(MC2_RH1Drain[Zn4]+MC2_RH4Drain[Zn4]+MC2_RH3Drain[Zn4]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn4,2]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn4,3] = (MC2_RH3Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH1Drain[Zn4]+W_Rh4Drain[Zn4]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn4,3]*MC2_WormTransfer[Pass]
    # MC2_Pass_LayerTrans[Zn4,4] = (MC2_RH4Drain[Zn4]+0*(MC2_RH2Drain[Zn4]+MC2_RH3Drain[Zn4]+MC2_RH1Drain[Zn4]))*MC2_RainTransfer[Pass]+S_SOMFoodForWorms[Zn4,4]*MC2_WormTransfer[Pass]
    
    zonelayercpools_df$MC2_RHDrain <- rep(zonelayer_df$MC2_RHDrain, nrow(cpools_df))
    zonelayercpools_df$S_SOMFoodForWorms <- rep(zonelayer_df$S_SOMFoodForWorms, nrow(cpools_df))
    zonelayercpools_df$MC2_RainTransfer <- rep(cpools_df$MC2_RainTransfer, nrow(zonelayer_df))
    zonelayercpools_df$MC2_WormTransfer <- rep(cpools_df$MC2_WormTransfer, nrow(zonelayer_df))
    zonelayercpools_df$MC2_LayerTrans <- zonelayercpools_df$MC2_RHDrain * zonelayercpools_df$MC2_RainTransfer + zonelayercpools_df$S_SOMFoodForWorms * zonelayercpools_df$MC2_WormTransfer
    
    
    # MC2_Met_SomTrans[Zn1,1] = MC_Met_LitSomTrans[Zn1]                                                - MC2_Metab[Zn1,1]*MC2_Met_LayerTrans[Zn1,1]
    # MC2_Met_SomTrans[Zn1,2] = 0*MC_Met_LitSomTrans[Zn1] + MC2_Metab[Zn1,1]*MC2_Met_LayerTrans[Zn1,1] - MC2_Metab[Zn1,2]*MC2_Met_LayerTrans[Zn1,2]
    # MC2_Met_SomTrans[Zn1,3] = 0*MC_Met_LitSomTrans[Zn1] + MC2_Metab[Zn1,2]*MC2_Met_LayerTrans[Zn1,2] - MC2_Metab[Zn1,3]*MC2_Met_LayerTrans[Zn1,3]
    # MC2_Met_SomTrans[Zn1,4] = 0*MC_Met_LitSomTrans[Zn1] + MC2_Metab[Zn1,3]*MC2_Met_LayerTrans[Zn1,3] - MC2_Metab[Zn1,4]*MC2_Met_LayerTrans[Zn1,4]
    # MC2_Met_SomTrans[Zn2,1] = MC_Met_LitSomTrans[Zn2]                                                - MC2_Metab[Zn2,1]*MC2_Met_LayerTrans[Zn2,1]
    # MC2_Met_SomTrans[Zn2,2] = 0*MC_Met_LitSomTrans[Zn2] + MC2_Metab[Zn2,1]*MC2_Met_LayerTrans[Zn2,1] - MC2_Metab[Zn2,2]*MC2_Met_LayerTrans[Zn2,2]
    # MC2_Met_SomTrans[Zn2,3] = 0*MC_Met_LitSomTrans[Zn2] + MC2_Metab[Zn2,2]*MC2_Met_LayerTrans[Zn2,2] - MC2_Metab[Zn2,3]*MC2_Met_LayerTrans[Zn2,3]
    # MC2_Met_SomTrans[Zn2,4] = 0*MC_Met_LitSomTrans[Zn2] + MC2_Metab[Zn2,3]*MC2_Met_LayerTrans[Zn2,3] - MC2_Metab[Zn2,4]*MC2_Met_LayerTrans[Zn2,4]
    # MC2_Met_SomTrans[Zn3,1] = MC_Met_LitSomTrans[Zn3]                                                - MC2_Metab[Zn3,1]*MC2_Met_LayerTrans[Zn3,1]
    # MC2_Met_SomTrans[Zn3,2] = 0*MC_Met_LitSomTrans[Zn3] + MC2_Metab[Zn3,1]*MC2_Met_LayerTrans[Zn3,1] - MC2_Metab[Zn3,2]*MC2_Met_LayerTrans[Zn3,2]
    # MC2_Met_SomTrans[Zn3,3] = 0*MC_Met_LitSomTrans[Zn3] + MC2_Metab[Zn3,2]*MC2_Met_LayerTrans[Zn3,2] - MC2_Metab[Zn3,3]*MC2_Met_LayerTrans[Zn3,3]
    # MC2_Met_SomTrans[Zn3,4] = 0*MC_Met_LitSomTrans[Zn3] + MC2_Metab[Zn3,3]*MC2_Met_LayerTrans[Zn3,3] - MC2_Metab[Zn3,4]*MC2_Met_LayerTrans[Zn3,4]
    # MC2_Met_SomTrans[Zn4,1] = MC_Met_LitSomTrans[Zn4]                                                - MC2_Metab[Zn4,1]*MC2_Met_LayerTrans[Zn4,1]
    # MC2_Met_SomTrans[Zn4,2] = 0*MC_Met_LitSomTrans[Zn4] + MC2_Metab[Zn4,1]*MC2_Met_LayerTrans[Zn4,1] - MC2_Metab[Zn4,2]*MC2_Met_LayerTrans[Zn4,2]
    # MC2_Met_SomTrans[Zn4,3] = 0*MC_Met_LitSomTrans[Zn4] + MC2_Metab[Zn4,2]*MC2_Met_LayerTrans[Zn4,2] - MC2_Metab[Zn4,3]*MC2_Met_LayerTrans[Zn4,3]
    # MC2_Met_SomTrans[Zn4,4] = 0*MC_Met_LitSomTrans[Zn4] + MC2_Metab[Zn4,3]*MC2_Met_LayerTrans[Zn4,3] - MC2_Metab[Zn4,4]*MC2_Met_LayerTrans[Zn4,4]
    
    # MC2_Act_SomTrans[Zn1,1] = MC_Act_LitSomTrans[Zn1]- MC2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1]
    # MC2_Act_SomTrans[Zn1,2] = 0*MC_Act_LitSomTrans[Zn1]+ MC2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1]- MC2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2]
    # MC2_Act_SomTrans[Zn1,3] = 0*MC_Act_LitSomTrans[Zn1]+ MC2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2]- MC2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3]
    # MC2_Act_SomTrans[Zn1,4] = 0*MC_Act_LitSomTrans[Zn1]+ MC2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3]- MC2_Act[Zn1,4]*MC2_Act_LayerTrans[Zn1,4]
    # MC2_Act_SomTrans[Zn2,1] = MC_Act_LitSomTrans[Zn2]- MC2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1]
    # MC2_Act_SomTrans[Zn2,2] = 0*MC_Act_LitSomTrans[Zn2]+ MC2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1]- MC2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2]
    # MC2_Act_SomTrans[Zn2,3] = 0*MC_Act_LitSomTrans[Zn2]+ MC2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2]- MC2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3]
    # MC2_Act_SomTrans[Zn2,4] = 0*MC_Act_LitSomTrans[Zn2]+ MC2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3]- MC2_Act[Zn2,4]*MC2_Act_LayerTrans[Zn2,4]
    # MC2_Act_SomTrans[Zn3,1] = MC_Act_LitSomTrans[Zn3]- MC2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1]
    # MC2_Act_SomTrans[Zn3,2] = 0*MC_Act_LitSomTrans[Zn3]+ MC2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1]- MC2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2]
    # MC2_Act_SomTrans[Zn3,3] = 0*MC_Act_LitSomTrans[Zn3]+ MC2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2]- MC2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3]
    # MC2_Act_SomTrans[Zn3,4] = 0*MC_Act_LitSomTrans[Zn3]+ MC2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3]- MC2_Act[Zn3,4]*MC2_Act_LayerTrans[Zn3,4]
    # MC2_Act_SomTrans[Zn4,1] = MC_Act_LitSomTrans[Zn4]- MC2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1]
    # MC2_Act_SomTrans[Zn4,2] = 0*MC_Act_LitSomTrans[Zn4]+ MC2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1]- MC2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2]
    # MC2_Act_SomTrans[Zn4,3] = 0*MC_Act_LitSomTrans[Zn4]+ MC2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2]- MC2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3]
    # MC2_Act_SomTrans[Zn4,4] = 0*MC_Act_LitSomTrans[Zn4]+ MC2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3]- MC2_Act[Zn4,4]*MC2_Act_LayerTrans[Zn4,4]
    
    # MC2_Slw_SomTrans[Zn1,1] =                                             +MC_Slw_LitSomTrans[Zn1]- MC2_Slw[Zn1,1]*MC2_Slow_LayerTrans[Zn1,1]
    # MC2_Slw_SomTrans[Zn1,2] = 0*MC_Slw_LitSomTrans[Zn1]+ MC2_Slw[Zn1,1]*MC2_Slow_LayerTrans[Zn1,1]- MC2_Slw[Zn1,2]*MC2_Slow_LayerTrans[Zn1,2]
    # MC2_Slw_SomTrans[Zn1,3] = 0*MC_Slw_LitSomTrans[Zn1]+ MC2_Slw[Zn1,2]*MC2_Slow_LayerTrans[Zn1,2]- MC2_Slw[Zn1,3]*MC2_Slow_LayerTrans[Zn1,3]
    # MC2_Slw_SomTrans[Zn1,4] = 0*MC_Slw_LitSomTrans[Zn1]+ MC2_Slw[Zn1,3]*MC2_Slow_LayerTrans[Zn1,3]- MC2_Slw[Zn1,4]*MC2_Slow_LayerTrans[Zn1,4]
    # MC2_Slw_SomTrans[Zn2,1] =                                              MC_Slw_LitSomTrans[Zn2]- MC2_Slw[Zn2,1]*MC2_Slow_LayerTrans[Zn2,1]
    # MC2_Slw_SomTrans[Zn2,2] = 0*MC_Slw_LitSomTrans[Zn2]+ MC2_Slw[Zn2,1]*MC2_Slow_LayerTrans[Zn2,1]- MC2_Slw[Zn2,2]*MC2_Slow_LayerTrans[Zn2,2]
    # MC2_Slw_SomTrans[Zn2,3] = 0*MC_Slw_LitSomTrans[Zn2]+ MC2_Slw[Zn2,2]*MC2_Slow_LayerTrans[Zn2,2]- MC2_Slw[Zn2,3]*MC2_Slow_LayerTrans[Zn2,3]
    # MC2_Slw_SomTrans[Zn2,4] = 0*MC_Slw_LitSomTrans[Zn2]+ MC2_Slw[Zn2,3]*MC2_Slow_LayerTrans[Zn2,3]- MC2_Slw[Zn2,4]*MC2_Slow_LayerTrans[Zn2,4]
    # MC2_Slw_SomTrans[Zn3,1] =                                              MC_Slw_LitSomTrans[Zn3]- MC2_Slw[Zn3,1]*MC2_Slow_LayerTrans[Zn3,1]
    # MC2_Slw_SomTrans[Zn3,2] = 0*MC_Slw_LitSomTrans[Zn3]+ MC2_Slw[Zn3,1]*MC2_Slow_LayerTrans[Zn3,1]- MC2_Slw[Zn3,2]*MC2_Slow_LayerTrans[Zn3,2]
    # MC2_Slw_SomTrans[Zn3,3] = 0*MC_Slw_LitSomTrans[Zn3]+ MC2_Slw[Zn3,2]*MC2_Slow_LayerTrans[Zn3,2]- MC2_Slw[Zn3,3]*MC2_Slow_LayerTrans[Zn3,3]
    # MC2_Slw_SomTrans[Zn3,4] = 0*MC_Slw_LitSomTrans[Zn3]+ MC2_Slw[Zn3,3]*MC2_Slow_LayerTrans[Zn3,3]- MC2_Slw[Zn3,4]*MC2_Slow_LayerTrans[Zn3,4]
    # MC2_Slw_SomTrans[Zn4,1] =                                              MC_Slw_LitSomTrans[Zn4]- MC2_Slw[Zn4,1]*MC2_Slow_LayerTrans[Zn4,1]
    # MC2_Slw_SomTrans[Zn4,2] = 0*MC_Slw_LitSomTrans[Zn4]+ MC2_Slw[Zn4,1]*MC2_Slow_LayerTrans[Zn4,1]- MC2_Slw[Zn4,2]*MC2_Slow_LayerTrans[Zn4,2]
    # MC2_Slw_SomTrans[Zn4,3] = 0*MC_Slw_LitSomTrans[Zn4]+ MC2_Slw[Zn4,2]*MC2_Slow_LayerTrans[Zn4,2]- MC2_Slw[Zn4,3]*MC2_Slow_LayerTrans[Zn4,3]
    # MC2_Slw_SomTrans[Zn4,4] = 0*MC_Slw_LitSomTrans[Zn4]+ MC2_Slw[Zn4,3]*MC2_Slow_LayerTrans[Zn4,3]- MC2_Slw[Zn4,4]*MC2_Slow_LayerTrans[Zn4,4]
    
    # MC2_Struc_SomT[Zn1,1] =                                                 MC_Str_LitSomTrans[Zn1]- MC2_Struc[Zn1,1]*MC2_Struc_LayerTrans[Zn1,1]
    # MC2_Struc_SomT[Zn1,2] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn1,1]*MC2_Struc_LayerTrans[Zn1,1]- MC2_Struc[Zn1,2]*MC2_Struc_LayerTrans[Zn1,2]
    # MC2_Struc_SomT[Zn1,3] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn1,2]*MC2_Struc_LayerTrans[Zn1,2]- MC2_Struc[Zn1,3]*MC2_Struc_LayerTrans[Zn1,3]
    # MC2_Struc_SomT[Zn1,4] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn1,3]*MC2_Struc_LayerTrans[Zn1,3]- MC2_Struc[Zn1,4]*MC2_Struc_LayerTrans[Zn1,4]
    # MC2_Struc_SomT[Zn2,1] =                                                 MC_Str_LitSomTrans[Zn2]- MC2_Struc[Zn2,1]*MC2_Struc_LayerTrans[Zn2,1]
    # MC2_Struc_SomT[Zn2,2] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn2,1]*MC2_Struc_LayerTrans[Zn2,1]- MC2_Struc[Zn2,2]*MC2_Struc_LayerTrans[Zn2,2]
    # MC2_Struc_SomT[Zn2,3] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn2,2]*MC2_Struc_LayerTrans[Zn2,2]- MC2_Struc[Zn2,3]*MC2_Struc_LayerTrans[Zn2,3]
    # MC2_Struc_SomT[Zn2,4] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn2,3]*MC2_Struc_LayerTrans[Zn2,3]- MC2_Struc[Zn2,4]*MC2_Struc_LayerTrans[Zn2,4]
    # MC2_Struc_SomT[Zn3,1] =                                                 MC_Str_LitSomTrans[Zn3]- MC2_Struc[Zn3,1]*MC2_Struc_LayerTrans[Zn3,1]
    # MC2_Struc_SomT[Zn3,2] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn3,1]*MC2_Struc_LayerTrans[Zn3,1]- MC2_Struc[Zn3,2]*MC2_Struc_LayerTrans[Zn3,2]
    # MC2_Struc_SomT[Zn3,3] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn3,2]*MC2_Struc_LayerTrans[Zn3,2]- MC2_Struc[Zn3,3]*MC2_Struc_LayerTrans[Zn3,3]
    # MC2_Struc_SomT[Zn3,4] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn3,3]*MC2_Struc_LayerTrans[Zn3,3]- MC2_Struc[Zn3,4]*MC2_Struc_LayerTrans[Zn3,4]
    # MC2_Struc_SomT[Zn4,1] =                                                 MC_Str_LitSomTrans[Zn4]- MC2_Struc[Zn4,1]*MC2_Struc_LayerTrans[Zn4,1]
    # MC2_Struc_SomT[Zn4,2] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn4,1]*MC2_Struc_LayerTrans[Zn4,1]- MC2_Struc[Zn4,2]*MC2_Struc_LayerTrans[Zn4,2]
    # MC2_Struc_SomT[Zn4,3] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn4,2]*MC2_Struc_LayerTrans[Zn4,2]- MC2_Struc[Zn4,3]*MC2_Struc_LayerTrans[Zn4,3]
    # MC2_Struc_SomT[Zn4,4] = 0*MC_Str_LitSomTrans[Zn1]+ MC2_Struc[Zn4,3]*MC2_Struc_LayerTrans[Zn4,3]- MC2_Struc[Zn4,4]*MC2_Struc_LayerTrans[Zn4,4]
    
    # MC2_Pass_SomTrans[Zn1,1] = MC_Pas_LitSomTrans[Zn1]- MC2_Pass[Zn1,1]*MC2_Pass_LayerTrans[Zn1,1]
    # MC2_Pass_SomTrans[Zn1,2] = 0*MC_Pas_LitSomTrans[Zn1]+ MC2_Pass[Zn1,1]*MC2_Pass_LayerTrans[Zn1,1]- MC2_Pass[Zn1,2]*MC2_Pass_LayerTrans[Zn1,2]
    # MC2_Pass_SomTrans[Zn1,3] = 0*MC_Pas_LitSomTrans[Zn1]+ MC2_Pass[Zn1,2]*MC2_Pass_LayerTrans[Zn1,2]- MC2_Pass[Zn1,3]*MC2_Pass_LayerTrans[Zn1,3]
    # MC2_Pass_SomTrans[Zn1,4] = 0*MC_Pas_LitSomTrans[Zn1]+ MC2_Pass[Zn1,3]*MC2_Pass_LayerTrans[Zn1,3]- MC2_Pass[Zn1,4]*MC2_Pass_LayerTrans[Zn1,4]
    # MC2_Pass_SomTrans[Zn2,1] = MC_Pas_LitSomTrans[Zn2]- MC2_Pass[Zn2,1]*MC2_Pass_LayerTrans[Zn2,1]
    # MC2_Pass_SomTrans[Zn2,2] = 0*MC_Pas_LitSomTrans[Zn2]+ MC2_Pass[Zn2,1]*MC2_Pass_LayerTrans[Zn2,1]- MC2_Pass[Zn2,2]*MC2_Pass_LayerTrans[Zn2,2]
    # MC2_Pass_SomTrans[Zn2,3] = 0*MC_Pas_LitSomTrans[Zn2]+ MC2_Pass[Zn2,2]*MC2_Pass_LayerTrans[Zn2,2]- MC2_Pass[Zn2,3]*MC2_Pass_LayerTrans[Zn2,3]
    # MC2_Pass_SomTrans[Zn2,4] = 0*MC_Pas_LitSomTrans[Zn2]+ MC2_Pass[Zn2,3]*MC2_Pass_LayerTrans[Zn2,3]- MC2_Pass[Zn2,4]*MC2_Pass_LayerTrans[Zn2,4]
    # MC2_Pass_SomTrans[Zn3,1] = +MC_Pas_LitSomTrans[Zn3]- MC2_Pass[Zn3,1]*MC2_Pass_LayerTrans[Zn3,1]
    # MC2_Pass_SomTrans[Zn3,2] = 0*MC_Pas_LitSomTrans[Zn3]+ MC2_Pass[Zn3,1]*MC2_Pass_LayerTrans[Zn3,1]- MC2_Pass[Zn3,2]*MC2_Pass_LayerTrans[Zn3,2]
    # MC2_Pass_SomTrans[Zn3,3] = 0*MC_Pas_LitSomTrans[Zn3]+ MC2_Pass[Zn3,2]*MC2_Pass_LayerTrans[Zn3,2]- MC2_Pass[Zn3,3]*MC2_Pass_LayerTrans[Zn3,3]
    # MC2_Pass_SomTrans[Zn3,4] = 0*MC_Pas_LitSomTrans[Zn3]+ MC2_Pass[Zn3,3]*MC2_Pass_LayerTrans[Zn3,3]- MC2_Pass[Zn3,4]*MC2_Pass_LayerTrans[Zn3,4]
    # MC2_Pass_SomTrans[Zn4,1] = MC_Pas_LitSomTrans[Zn4]- MC2_Pass[Zn4,1]*MC2_Pass_LayerTrans[Zn4,1]
    # MC2_Pass_SomTrans[Zn4,2] = 0*MC_Pas_LitSomTrans[Zn4]+ MC2_Pass[Zn4,1]*MC2_Pass_LayerTrans[Zn4,1]- MC2_Pass[Zn4,2]*MC2_Pass_LayerTrans[Zn4,2]
    # MC2_Pass_SomTrans[Zn4,3] = 0*MC_Pas_LitSomTrans[Zn4]+ MC2_Pass[Zn4,2]*MC2_Pass_LayerTrans[Zn4,2]- MC2_Pass[Zn4,3]*MC2_Pass_LayerTrans[Zn4,3]
    # MC2_Pass_SomTrans[Zn4,4] = 0*MC_Pas_LitSomTrans[Zn4]+ MC2_Pass[Zn4,3]*MC2_Pass_LayerTrans[Zn4,3]- MC2_Pass[Zn4,4]*MC2_Pass_LayerTrans[Zn4,4]
    
    # zonelayer_df$MC2_Met_SomTrans <- NA
    # zonelayer_df$MC2_Metab_Layer <- zonelayer_df$MC2_Metab - zonelayer_df$MC2_Met_LayerTrans
    # zonelayer_df[zonelayer_df$layer == 1, ]$MC2_Met_SomTrans <- zone_df$MC_Met_LitSomTrans - zonelayer_df[zonelayer_df$layer == 1, ]$MC2_Metab_Layer
    # zonelayer_df[zonelayer_df$layer %in% c(2:4), ]$MC2_Met_SomTrans <- zonelayer_df[zonelayer_df$layer %in% c(1:3), ]$MC2_Metab_Layer - zonelayer_df[zonelayer_df$layer %in% c(2:4), ]$MC2_Metab_Layer
    #
    
    
    zonelayercpools_df$MC2_cpools <- c(
      zonelayer_df$MC2_Metab,
      zonelayer_df$MC2_Struc,
      zonelayer_df$MC2_Act,
      zonelayer_df$MC2_Slw,
      zonelayer_df$MC2_Pass
    )
    zonelayercpools_df$MC2_cpools_Layer <- zonelayercpools_df$MC2_cpools * zonelayercpools_df$MC2_LayerTrans
    zonecpools_df$MC_LitSomTrans <- c(
      zone_df$MC_Met_LitSomTrans,
      zone_df$MC_Str_LitSomTrans,
      zone_df$MC_Act_LitSomTrans,
      zone_df$MC_Slw_LitSomTrans,
      zone_df$MC_Pas_LitSomTrans
    )
    
    zonelayercpools_df$MC2_SomTrans <- NA
    zonelayercpools_df[zonelayercpools_df$layer == 1, ]$MC2_SomTrans <- zonecpools_df$MC_LitSomTrans - zonelayercpools_df[zonelayer_df$layer == 1, ]$MC2_cpools_Layer
    zonelayercpools_df[zonelayercpools_df$layer %in% c(2:4), ]$MC2_SomTrans <- zonelayercpools_df[zonelayercpools_df$layer %in% c(1:3), ]$MC2_cpools_Layer - zonelayercpools_df[zonelayercpools_df$layer %in% c(2:4), ]$MC2_cpools_Layer
    
    
    
    
    # MC2_TempLim[Zone,SoilLayer] = GRAPH(Temp[Zone,SoilLayer])
    zonelayer_df$MC2_TempLim <- get_y_df(zonelayer_df$Temp, "MC2_TempLim")
    
    # MC2_Theta[Zn1,1] = W_Theta1[Zn1]+0*(W_Theta2[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn1,2] = W_Theta2[Zn1]+0*(W_Theta1[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn1,3] = W_Theta3[Zn1]+0*(W_Theta1[Zn1]+W_Theta2[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn1,4] = W_Theta4[Zn1]+0*(W_Theta1[Zn1]+W_Theta3[Zn1]+W_Theta2[Zn1])
    # MC2_Theta[Zn2,1] = W_Theta1[Zn2]+0*(W_Theta2[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn2,2] = W_Theta2[Zn2]+0*(W_Theta1[Zn2]+W_Theta3[Zn2]+W_Theta4[Zn2])
    # MC2_Theta[Zn2,3] = W_Theta3[Zn2]+0*(W_Theta1[Zn1]+W_Theta2[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn2,4] = W_Theta4[Zn2]+0*(W_Theta1[Zn1]+W_Theta2[Zn1]+W_Theta3[Zn1])
    # MC2_Theta[Zn3,1] = W_Theta1[Zn3]+0*(W_Theta2[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn3,2] = W_Theta2[Zn3]+0*(W_Theta1[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn3,3] = W_Theta3[Zn3]+0*(W_Theta2[Zn1]+W_Theta1[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn3,4] = W_Theta4[Zn3]+0*(W_Theta2[Zn1]+W_Theta3[Zn1]+W_Theta1[Zn1])
    # MC2_Theta[Zn4,1] = W_Theta1[Zn4]+0*(W_Theta2[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn4,2] = W_Theta2[Zn4]+0*(W_Theta1[Zn1]+W_Theta3[Zn1]+W_Theta4[Zn1])
    # MC2_Theta[Zn4,3] = W_Theta3[Zn4]+0*(W_Theta2[Zn4]+W_Theta1[Zn4]+W_Theta4[Zn4])
    # MC2_Theta[Zn4,4] = W_Theta4[Zn4]+0*(W_Theta1[Zn4]+W_Theta3[Zn4]+W_Theta2[Zn4])
    zonelayer_df$MC2_Theta <- zonelayer_df$W_Theta
    
    # MC2_ThetaLim[Zone,SoilLayer] = MAX(0,MIN(MIN(MAX(0,3.33*MC2_Theta[Zone,SoilLayer]/W_ThetaPMax[Zone])-0.667,1),-1.2*MC2_Theta[Zone,SoilLayer]/W_ThetaPMax[Zone]+1.9))
    zonelayer_df$W_ThetaPMax <- rep(zone_df$W_ThetaPMax, nlayer)
    zonelayer_df$W_Theta_by_PMax <-  zonelayer_df$MC2_Theta / zonelayer_df$W_ThetaPMax
    zonelayer_df$MC2_ThetaLim <- pmax(0, pmin(
      pmin(pmax(
        0, 3.33 * zonelayer_df$W_Theta_by_PMax
      ) - 0.667, 1),
      -1.2 * zonelayer_df$W_Theta_by_PMax + 1.9
    ))
    
    # MC2_kMetabCur[Zone,SoilLayer] = MC2_kMetab*MC2_TempLim[Zone,SoilLayer]*MC2_ThetaLim[Zone,SoilLayer]
    zonelayer_df$MC2_kMetabCur <- MC2_kMetab * zonelayer_df$MC2_TempLim *
      zonelayer_df$MC2_ThetaLim
    
    # S&B_SOMBurnFrac[Zone] = GRAPH(S&B_FireTempIncTopSoil[Zone])
    zone_df$SB_SOMBurnFrac <- get_y_df(zone_df$SB_FireTempIncTopSoil, "SB_SOMBurnFrac")
    
    # MN2_MinDueToS&B[Zn1,1] = S&B_SOMBurnFrac[Zn1]
    # MN2_MinDueToS&B[Zn1,2] = 0*S&B_SOMBurnFrac[Zn1]
    # MN2_MinDueToS&B[Zn1,3] = 0*S&B_SOMBurnFrac[Zn1]
    # MN2_MinDueToS&B[Zn1,4] = 0*S&B_SOMBurnFrac[Zn1]
    # MN2_MinDueToS&B[Zn2,1] = S&B_SOMBurnFrac[Zn2]
    # MN2_MinDueToS&B[Zn2,2] = 0*S&B_SOMBurnFrac[Zn2]
    # MN2_MinDueToS&B[Zn2,3] = 0*S&B_SOMBurnFrac[Zn2]
    # MN2_MinDueToS&B[Zn2,4] = 0*S&B_SOMBurnFrac[Zn2]
    # MN2_MinDueToS&B[Zn3,1] = S&B_SOMBurnFrac[Zn3]
    # MN2_MinDueToS&B[Zn3,2] = 0*S&B_SOMBurnFrac[Zn3]
    # MN2_MinDueToS&B[Zn3,3] = 0*S&B_SOMBurnFrac[Zn3]
    # MN2_MinDueToS&B[Zn3,4] = 0*S&B_SOMBurnFrac[Zn3]
    # MN2_MinDueToS&B[Zn4,1] = S&B_SOMBurnFrac[Zn4]
    # MN2_MinDueToS&B[Zn4,2] = 0*S&B_SOMBurnFrac[Zn4]
    # MN2_MinDueToS&B[Zn4,3] = 0*S&B_SOMBurnFrac[Zn4]
    # MN2_MinDueToS&B[Zn4,4] = 0*S&B_SOMBurnFrac[Zn4]
    zonelayer_df$MN2_MinDueToSB <- 0
    zonelayer_df[zonelayer_df$layer == 1, "MN2_MinDueToSB"] <- zone_df$SB_SOMBurnFrac
    
    # MC2_MetabCO2In[Zone,SoilLayer] = MC2_Metab[Zone,SoilLayer]*(MC2_kMetabCur[Zone,SoilLayer]*(1-MC_EffMetab)+MN2_MinDueToS&B[Zone,SoilLayer])
    zonelayer_df$MC2_MetabCO2In <- zonelayer_df$MC2_Metab * (zonelayer_df$MC2_kMetabCur * (1 - MC_EffMetab) + zonelayer_df$MN2_MinDueToSB)
    
    # MN2_CNActAct_N[Zone,SoilLayer] = IF(TIME>1)THEN (if MN2_Act[Zone,SoilLayer]>0 then (MC2_Act[Zone,SoilLayer]/MN2_Act[Zone,SoilLayer])  else 100)  ELSE(MN_CNAct*MN_NutRatAct[N])
    MN_NutRatAct_N <- nut_df[nut_df$SlNut == "N", "MN_NutRatAct"]
    zonelayer_df$MN2_CNActAct_N <- ifelse(
      zonelayer_df$time > 1,
      ifelse(
        zonelayer_df$MN2_Act > 0,
        zonelayer_df$MC2_Act / zonelayer_df$MN2_Act,
        100
      ),
      MN_CNAct * MN_NutRatAct_N
    )
    
    # MC2_ActDecomDec[Zone,SoilLayer] = MAX(0,1+MIN(0,-2*(MN2_CNActAct_N[Zone,SoilLayer]-MN_CNAct*MN_NutRatAct[N])/MN_CNAct*MN_NutRatAct[N]-0.25))
    zonelayer_df$MC2_ActDecomDec <- pmax(0, 1 + pmin(
      0,
      -2 * (zonelayer_df$MN2_CNActAct_N - MN_CNAct * MN_NutRatAct_N) / MN_CNAct * MN_NutRatAct_N - 0.25
    ))
    
    #TODO: confirm: the min params contain similar value?
    # MC2_ActDecomDecMin[Zone,SoilLayer] = MIN(MC2_ActDecomDec[Zone,SoilLayer],MC2_ActDecomDec[Zone,SoilLayer])
    zonelayer_df$MC2_ActDecomDecMin <- pmin(zonelayer_df$MC2_ActDecomDec,
                                            zonelayer_df$MC2_ActDecomDec)
    
    # MC2_MetabActF[Zone,SoilLayer] = (MC2_Metab[Zone,SoilLayer]-MC2_MetabCO2In[Zone,SoilLayer])*MC2_kMetabCur[Zone,SoilLayer]*MC_EffMetab*MC2_ActDecomDecMin[Zone,SoilLayer]
    zonelayer_df$MC2_MetabActF <- (zonelayer_df$MC2_Metab - zonelayer_df$MC2_MetabCO2In) *
      zonelayer_df$MC2_kMetabCur * MC_EffMetab * zonelayer_df$MC2_ActDecomDecMin
    
    
    
    # MC2_StrucLig[Zone,SoilLayer] = MC2_InputLign[Zone,SoilLayer]/(1-MC2_SplitMet[Zone,SoilLayer])
    zonelayer_df$MC2_StrucLig <- zonelayer_df$MC2_InputLign / (1 - zonelayer_df$MC2_SplitMet)
    
    # MC2_kStrucCur[Zone,SoilLayer] = MC2_kStruc*EXP(-3.0*MC2_StrucLig[Zone,SoilLayer])*MC2_TempLim[Zone,SoilLayer]*MC2_ThetaLim[Zone,SoilLayer]
    zonelayer_df$MC2_kStrucCur <- MC2_kStruc * exp(-3.0 *
                                                     zonelayer_df$MC2_StrucLig) * zonelayer_df$MC2_TempLim * zonelayer_df$MC2_ThetaLim
    
    # MC2_StrucActCO2In[Zone,SoilLayer] = MC2_Struc[Zone,SoilLayer]*((1-MC2_StrucLig[Zone,SoilLayer])*MC2_kStrucCur[Zone,SoilLayer]*(1-MC2_EffStrucAc)+MN2_MinDueToS&B[Zone,SoilLayer])
    zonelayer_df$MC2_StrucActCO2In <- zonelayer_df$MC2_Struc * ((1 - zonelayer_df$MC2_StrucLig) *
                                                                  zonelayer_df$MC2_kStrucCur * (1 - MC2_EffStrucAc) + zonelayer_df$MN2_MinDueToSB
    )
    
    # MC_StrucSlwCO2In_SOM[Zone,SoilLayer] = (MC2_Struc[Zone,SoilLayer]-MC2_StrucActCO2In[Zone,SoilLayer])*MC2_StrucLig[Zone,SoilLayer]*MC2_kStrucCur[Zone,SoilLayer]*(1-MC_EffStrucSlwSOM)
    zonelayer_df$MC_StrucSlwCO2In_SOM <- (zonelayer_df$MC2_Struc - zonelayer_df$MC2_StrucActCO2In) *
      zonelayer_df$MC2_StrucLig * zonelayer_df$MC2_kStrucCur * (1 - MC_EffStrucSlwSOM)
    
    # MC2_StrucActF[Zone,SoilLayer] = (MC2_Struc[Zone,SoilLayer]-MC2_StrucActCO2In[Zone,SoilLayer]-MC_StrucSlwCO2In_SOM[Zone,SoilLayer])*(1-MC2_StrucLig[Zone,SoilLayer])*MC2_kStrucCur[Zone,SoilLayer]*MC2_EffStrucAc*MC2_ActDecomDecMin[Zone,SoilLayer]
    zonelayer_df$MC2_StrucActF <- (
      zonelayer_df$MC2_Struc - zonelayer_df$MC2_StrucActCO2In - zonelayer_df$MC_StrucSlwCO2In_SOM
    ) *
      (1 - zonelayer_df$MC2_StrucLig) * zonelayer_df$MC2_kStrucCur * MC2_EffStrucAc *
      zonelayer_df$MC2_ActDecomDecMin
    
    # MC2_kActCur[Zone,SoilLayer] = MC2_kAct*(1-0.75*(MC2_Clay+MC2_Silt))*MC2_TempLim[Zone,SoilLayer]*MC2_ThetaLim[Zone,SoilLayer]
    zonelayer_df$MC2_kActCur <- MC2_kAct * (1 - 0.75 * (MC2_Clay +
                                                          MC2_Silt)) * zonelayer_df$MC2_TempLim * zonelayer_df$MC2_ThetaLim
    
    # MC2_ActResp = 0.85 - 0.68*(MC2_Clay+MC2_Silt)
    MC2_ActResp <- 0.85 - 0.68 * (MC2_Clay + MC2_Silt)
    
    # MC2_ActCO2In[Zone,SoilLayer] = MC2_Act[Zone,SoilLayer]*(MC2_kActCur[Zone,SoilLayer]*MC2_ActResp+MN2_MinDueToS&B[Zone,SoilLayer])
    zonelayer_df$MC2_ActCO2In <- zonelayer_df$MC2_Act * (zonelayer_df$MC2_kActCur *
                                                           MC2_ActResp + zonelayer_df$MN2_MinDueToSB)
    
    # MC2_EffActSlw = (1-MC2_ActResp-0.004)
    MC2_EffActSlw <- (1 - MC2_ActResp - 0.004)
    
    # MC2_ActSlw[Zone,SoilLayer] = MC2_Act[Zone,SoilLayer]*MC2_kActCur[Zone,SoilLayer]*MC2_EffActSlw
    zonelayer_df$MC2_ActSlw <- zonelayer_df$MC2_Act * zonelayer_df$MC2_kActCur * MC2_EffActSlw
    
    # MC2_kSlwCur[Zone,SoilLayer] = MC2_kSlw*MC2_TempLim[Zone,SoilLayer]*MC2_ThetaLim[Zone,SoilLayer]
    zonelayer_df$MC2_kSlwCur <- MC2_kSlw * zonelayer_df$MC2_TempLim *
      zonelayer_df$MC2_ThetaLim
    
    # MC2_SlwAct[Zone,SoilLayer] = MC2_Slw[Zone,SoilLayer]*MC2_kSlwCur[Zone,SoilLayer]*MC2_EffSlwAct
    zonelayer_df$MC2_SlwAct <- zonelayer_df$MC2_Slw * zonelayer_df$MC2_kSlwCur * MC2_EffSlwAct
    
    # MC2_ActSlwF[Zone,SoilLayer] = MC2_ActSlw[Zone,SoilLayer]-MC2_SlwAct[Zone,SoilLayer]
    zonelayer_df$MC2_ActSlwF <- zonelayer_df$MC2_ActSlw - zonelayer_df$MC2_SlwAct
    
    # MC2_ActPass[Zone,SoilLayer] = MC2_Act[Zone,SoilLayer]*MC2_kActCur[Zone,SoilLayer]*0.004
    zonelayer_df$MC2_ActPass <- zonelayer_df$MC2_Act * zonelayer_df$MC2_kActCur *
      0.004
    
    # MC2_kPassCur[Zone,SoilLayer] = MC2_kPass*MC2_TempLim[Zone,SoilLayer]*MC2_ThetaLim[Zone,SoilLayer]
    zonelayer_df$MC2_kPassCur <- MC2_kPass * zonelayer_df$MC2_TempLim *
      zonelayer_df$MC2_ThetaLim
    
    # MC2_PassAct[Zone,SoilLayer] = MC2_Pass[Zone,SoilLayer]*MC2_kPassCur[Zone,SoilLayer]*MC2_EffPass
    zonelayer_df$MC2_PassAct <- zonelayer_df$MC2_Pass * zonelayer_df$MC2_kPassCur *
      MC2_EffPass
    
    # MC2_ActPassF[Zone,SoilLayer] = MC2_ActPass[Zone,SoilLayer]-MC2_PassAct[Zone,SoilLayer]
    zonelayer_df$MC2_ActPassF <- zonelayer_df$MC2_ActPass - zonelayer_df$MC2_PassAct
    
    
    # MC2_SlwDecomDecMin[Zone,SlNut] = MAX(0,1+MIN(0,-2*(MN_CNSlwAct[Zone,SlNut]-MN_CNSlw*MN_NutRatSlw[SlNut])/MN_CNSlw*MN_NutRatSlw[SlNut]-0.25))
    zonenut_df$MC2_SlwDecomDecMin <- pmax(0, 1 + pmin(
      0,
      -2 * (
        zonenut_df$MN_CNSlwAct - MN_CNSlw * zonenut_df$MN_NutRatSlw
      ) / MN_CNSlw * zonenut_df$MN_NutRatSlw - 0.25
    ))
    
    # MC2_SlwDecomDec[Zone] = MIN(MC2_SlwDecomDecMin[Zone,N],MC2_SlwDecomDecMin[Zone,P])
    zone_df$MC2_SlwDecomDec <- pmin(zonenut_df[zonenut_df$SlNut == "N", ]$MC2_SlwDecomDecMin,
                                    zonenut_df[zonenut_df$SlNut == "P", ]$MC2_SlwDecomDecMin)
    
    # MC2_StrucSlwF[Zone,SoilLayer] = (MC2_Struc[Zone,SoilLayer]-MC2_StrucActCO2In[Zone,SoilLayer]-MC_StrucSlwCO2In_SOM[Zone,SoilLayer]-MC2_StrucActF[Zone,SoilLayer])*MC2_StrucLig[Zone,SoilLayer]*MC2_kStrucCur[Zone,SoilLayer]*MC_EffStrucSlwSOM*MC2_SlwDecomDec[Zone]
    zonelayer_df$MC2_SlwDecomDec <- rep(zone_df$MC2_SlwDecomDec, nlayer)
    zonelayer_df$MC2_StrucSlwF <- (
      zonelayer_df$MC2_Struc - zonelayer_df$MC2_StrucActCO2In - zonelayer_df$MC_StrucSlwCO2In_SOM -
        zonelayer_df$MC2_StrucActF
    ) *
      zonelayer_df$MC2_StrucLig * zonelayer_df$MC2_kStrucCur * MC_EffStrucSlwSOM *
      zonelayer_df$MC2_SlwDecomDec
    
    # MC2_KSlowPassCurr[Zone,SoilLayer] = MC2_kPass*(1-0.75*(MC2_Clay+MC2_Silt))*MC2_TempLim[Zone,SoilLayer]*MC2_ThetaLim[Zone,SoilLayer]
    zonelayer_df$MC2_KSlowPassCurr <- MC2_kPass * (1 - 0.75 *
                                                     (MC2_Clay + MC2_Silt)) * zonelayer_df$MC2_TempLim * zonelayer_df$MC2_ThetaLim
    
    # MC2_SlwPassF[Zone,SoilLayer] = MC2_Slw[Zone,SoilLayer]*MC2_KSlowPassCurr[Zone,SoilLayer]*MC_EffSlwPass
    zonelayer_df$MC2_SlwPassF <- zonelayer_df$MC2_Slw * zonelayer_df$MC2_KSlowPassCurr * MC_EffSlwPass
    
    # MC2_SlwCO2In[Zone,SoilLayer] = MC2_Slw[Zone,SoilLayer]*(MC2_kSlwCur[Zone,SoilLayer]*(1-MC2_EffSlwAct-MC_EffSlwPass)+MN2_MinDueToS&B[Zone,SoilLayer])
    zonelayer_df$MC2_SlwCO2In <- zonelayer_df$MC2_Slw * (
      zonelayer_df$MC2_kSlwCur * (1 - MC2_EffSlwAct - MC_EffSlwPass) + zonelayer_df$MN2_MinDueToSB
    )
    
    # MC2_StrucIn[Zone,SoilLayer] = MC2_OrgInpC[Zone,SoilLayer]-MC2_MetabIn[Zone,SoilLayer]
    zonelayer_df$MC2_StrucIn <- zonelayer_df$MC2_OrgInpC - zonelayer_df$MC2_MetabIn
    
    # MC2_PassCO2In[Zone,SoilLayer] = MC2_Pass[Zone,SoilLayer]*(MC2_kPassCur[Zone,SoilLayer]*(1-MC2_EffPass)+MN2_MinDueToS&B[Zone,SoilLayer])
    zonelayer_df$MC2_PassCO2In <- zonelayer_df$MC2_Pass * (zonelayer_df$MC2_kPassCur * (1 - MC2_EffPass) + zonelayer_df$MN2_MinDueToSB)
    
    # PD_ChangeAnPop[Animals] = -(1-PD_ResidenceinPlot?[Animals])*PD_NastiesinPlot[Animals]+PD_PopulOutside[Animals]*(1-max(1,PD_FenceQ*PD_JumptheFence?[Animals]))
    animal_df$PD_ChangeAnPop <- -(1 - animal_df$PD_ResidenceinPlot_is) *
      animal_df$PD_NastiesinPlot + animal_df$PD_PopulOutside * (1 - max(1, PD_FenceQ *
                                                                          animal_df$PD_JumptheFence_is))
    
    # C_BiomHarvestEvent = if time = int(C_BiomHarvestDay) then +1 else if time > C_BiomHarvestDay +1 then +1 else 0
    C_BiomHarvestEvent <- ifelse(time == floor(C_BiomHarvestDay),
                                 1,
                                 ifelse(time > C_BiomHarvestDay + 1, 1, 0))
    
    # T_PrunEvent = if time = int(T_PrunDay) then +1 else if time > T_PrunDay +1 then +1 else 0
    T_PrunEvent <- ifelse(time == floor(T_PrunDay), 1, ifelse(time > T_PrunDay +
                                                                1, 1, 0))
    
    # TF_Full_canopy_no_of_leaves[Tree] = 40 - max(0,(min(4380,TF_AgeofPalm[Tree])-2555)/(4380-2555))*(40-30)
    tree_df$TF_Full_canopy_no_of_leaves <- 40 - pmax(0, (pmin(4380, tree_df$TF_AgeofPalm) -
                                                           2555) / (4380 - 2555)) * (40 - 30)
    
    # TF_PotLeaffall[Tree] = GRAPH(TF_AgeofPalm[Tree])
    tree_df$TF_PotLeaffall <- get_y_df(tree_df$TF_AgeofPalm, "TF_PotLeaffall")
    
    # TF_LeafTurnOver[Tree] = if TF_PhyllochronStressed[Tree]> 0 then TF_PotLeaffall[Tree]/TF_PhyllochronStressed[Tree] else 0
    tree_df$TF_LeafTurnOver <- ifelse(
      tree_df$TF_PhyllochronStressed > 0,
      tree_df$TF_PotLeaffall / tree_df$TF_PhyllochronStressed,
      0
    )
    
    # TF_LeaffallClockTicks?[Tree] = if Simulation_Time<T_PlantTime[Tree] then 0 else if Simulation_Time - TF_LeaffallTime[Tree] >=TF_LeafTurnOver[Tree] then TF_LeafTurnOver[Tree] else 0
    tree_df$TF_LeaffallClockTicks_is <- ifelse(
      Simulation_Time < tree_df$T_PlantTime,
      0,
      ifelse(
        Simulation_Time - tree_df$TF_LeaffallTime >= tree_df$TF_LeafTurnOver,
        tree_df$TF_LeafTurnOver,
        0
      )
    )
    
    # TF_NewLeaffall?[Tree] = if TF_CurrentLeafNo[Tree]>TF_Full_canopy_no_of_leaves[Tree] then (if TF_LeaffallClockTicks?[Tree] <> 0 then 1 else 0 ) else 0
    tree_df$TF_NewLeaffall_is <- ifelse(
      tree_df$TF_CurrentLeafNo > tree_df$TF_Full_canopy_no_of_leaves,
      ifelse(tree_df$TF_LeaffallClockTicks_is != 0, 1, 0) ,
      0
    )
    
    # T_RootDecay[PlantComp,Tree] = If RT_T_MeanResTime[Tree]>0 then T_RtType2Biomass[PlantComp,Tree]/RT_T_MeanResTime[Tree] else 0
    treepcomp_df$RT_T_MeanResTime <- rep(tree_df$RT_T_MeanResTime, nrow(pcomp_df))
    treepcomp_df$T_RootDecay <- ifelse(
      treepcomp_df$RT_T_MeanResTime > 0,
      treepcomp_df$T_RtType2Biomass / treepcomp_df$RT_T_MeanResTime,
      0
    )
    
    
    # T_FruitAllocDyn = GRAPH(time)
    T_FruitAllocDyn <- get_y_df(time, "T_FruitAllocDyn")
    
    # TF_TotFemS[Tree,Fruitbunch] = max(0,(TF_BunchGender[Tree,Fruitbunch]-1))*TF_FemSinkperFruit[Tree,Fruitbunch]*TF_FruitsperBunch[Tree,Fruitbunch]
    treefruit_df$TF_TotFemS <- pmax(0, (treefruit_df$TF_BunchGender -
                                          1)) * treefruit_df$TF_FemSinkperFruit * treefruit_df$TF_FruitsperBunch
    
    # TF_TotMaleS[Tree,Fruitbunch] = mod(TF_BunchGender[Tree,Fruitbunch],2)*TF_MaleSinkperBunch[Tree,Fruitbunch]
    treefruit_df$TF_TotMaleS <- (treefruit_df$TF_BunchGender %% 2) * treefruit_df$TF_MaleSinkperBunch
    
    # TF_TotFlowerSink[Tree] = ARRAYSUM(TF_TotFemS[*,*])+ARRAYSUM(TF_TotMaleS[*,*])
    tree_df$TF_TotFlowerSink <- sum(treefruit_df$TF_TotFemS) + sum(treefruit_df$TF_TotMaleS)
    
    # TF_BunchweightIncrTarget[Tree,Fruitbunch] = if TF_AgeofPalm[Tree]=0 then 0 else if T_Stage[Tree,VegGen]>1 and TF_TotFlowerSink[Tree] > 0 then
    # (max(0,((TF_BunchGender[Tree,Fruitbunch]-1))*TF_FemSinkperFruit[Tree,Fruitbunch]*TF_FruitsperBunch[Tree,Fruitbunch]+ mod(TF_BunchGender[Tree,Fruitbunch],2)*TF_MaleSinkperBunch[Tree,Fruitbunch])/TF_TotFlowerSink[Tree])*T_GroRes[DW,Tree]*T_RelFruitAllocMax[Tree] else 0
    treefruit_df$TF_AgeofPalm <- rep(tree_df$TF_AgeofPalm, nrow(fruit_df))
    treefruit_df$T_Stage_VegGen <- rep(tree_df$T_Stage_VegGen, nrow(fruit_df))
    treefruit_df$TF_TotFlowerSink <- rep(tree_df$TF_TotFlowerSink, nrow(fruit_df))
    treefruit_df$T_GroRes_DW <- rep(tree_df$T_GroRes_DW, nrow(fruit_df))
    treefruit_df$T_RelFruitAllocMax <- rep(tree_df$T_RelFruitAllocMax, nrow(fruit_df))
    
    treefruit_df$TF_BunchweightIncrTarget <- ifelse(
      treefruit_df$TF_AgeofPalm == 0,
      0,
      ifelse(
        treefruit_df$T_Stage_VegGen > 1 &
          treefruit_df$TF_TotFlowerSink > 0,
        (
          pmax(
            0,
            (treefruit_df$TF_BunchGender - 1) * treefruit_df$TF_FemSinkperFruit * treefruit_df$TF_FruitsperBunch +
              (treefruit_df$TF_BunchGender %% 2) * treefruit_df$TF_MaleSinkperBunch
          ) / treefruit_df$TF_TotFlowerSink
        ) *
          treefruit_df$T_GroRes_DW * treefruit_df$T_RelFruitAllocMax[Tree],
        0
      )
    )
    
    # TF_FruitDemand[PlantComp,Tree] = if T_GroRes[PlantComp,Tree] = 0 then 0 else ARRAYSUM(TF_BunchweightIncrTarget[Tree,*])*(T_GroRes[PlantComp,Tree]/T_GroRes[DW,Tree])
    tree_df$TF_BunchweightIncrTarget_sum <- aggregate(treefruit_df["TF_BunchweightIncrTarget"], treefruit_df["tree_id"], sum)$TF_BunchweightIncrTarget
    treepcomp_df$TF_BunchweightIncrTarget_sum <- rep(tree_df$TF_BunchweightIncrTarget_sum, nrow(pcomp_df))
    treepcomp_df$TF_FruitDemand <- ifelse(
      treepcomp_df$T_GroRes == 0,
      0,
      treepcomp_df$TF_BunchweightIncrTarget_sum * (treepcomp_df$T_GroRes / treepcomp_df$T_GroRes_DW)
    )
    
    # T_FruitInc[PlantComp,Tree] = if T_GrowsToday?[Tree] = 0 then 0 else if T_Stage[Tree,VegGen] <= 1 then 0 else
    #       if T_ApplyPalm?[Tree] < 1 then T_GroRes[PlantComp,Tree]*T_RelFruitAllocMax[Tree]*T_FruitAllocStage[Tree]*T_GroResFrac[Tree]*T_FruitAllocDyn else
    #         if T_GroRes[DW,Tree] > 0 then min(T_GroRes[PlantComp,Tree]*T_RelFruitAllocMax[Tree],TF_FruitDemand[PlantComp,Tree]) else 0
    
    treepcomp_df$T_FruitInc <-
      ifelse(
        treepcomp_df$T_GrowsToday_is == 0,
        0,
        ifelse(
          treepcomp_df$T_Stage_VegGen <= 1,
          0,
          ifelse(
            treepcomp_df$T_ApplyPalm_is < 1,
            treepcomp_df$T_GroRes * treepcomp_df$T_RelFruitAllocMax * treepcomp_df$T_FruitAllocStage *
              treepcomp_df$T_GroResFrac * T_FruitAllocDyn,
            ifelse(
              treepcomp_df$T_GroRes_DW > 0,
              pmin(
                treepcomp_df$T_GroRes * treepcomp_df$T_RelFruitAllocMax,
                treepcomp_df$TF_FruitDemand
              ),
              0
            )
          )
        )
      )
    
    
    # T_Height[Tree] = MIN(T_CanH[Tree],T_CanHMax[Tree])+T_WoodH[Tree]
    tree_df$T_Height <- pmin(tree_df$T_CanH, tree_df$T_CanHMax) + tree_df$T_WoodH
    
    # T_FruitHarvFracHeight[Tree] = if T_Height[Tree]> T_FruitLossHeight[Tree] then 1-(0.075*(T_Height[Tree]-T_FruitLossHeight[Tree])) else 1
    tree_df$T_FruitHarvFracHeight <- ifelse(tree_df$T_Height > tree_df$T_FruitLossHeight,
                                            1 -
                                              (0.075 * (
                                                tree_df$T_Height - tree_df$T_FruitLossHeight
                                              )),
                                            1)
    
    # TF_FruitHarvFrac[Tree] = if TF_PalmTrunkHeight[Tree] > TF_FruitLossHeight[Tree] then 1-(0.075*(TF_PalmTrunkHeight[Tree]-TF_FruitLossHeight[Tree])) else 1
    tree_df$TF_FruitHarvFrac <- ifelse(tree_df$TF_PalmTrunkHeight > tree_df$TF_FruitLossHeight,
                                       1 - (
                                         0.075 * (tree_df$TF_PalmTrunkHeight - tree_df$TF_FruitLossHeight)
                                       ),
                                       1)
    
    # T_FruitHarvInc[PlantComp,Tree] = if T_ApplyPalm?[Tree]<1 then T_FruitHarvFracHeight[Tree]*T_FruitHarvFrac[Tree]*T_RipeFruitHarvest[PlantComp,Tree] else TF_FruitHarvFrac[Tree]*T_RipeFruitHarvest[PlantComp,Tree]
    treepcomp_df$T_FruitHarvFracHeight <- rep(tree_df$T_FruitHarvFracHeight, nrow(pcomp_df))
    treepcomp_df$TF_FruitHarvFrac <- rep(tree_df$TF_FruitHarvFrac, nrow(pcomp_df))
    treepcomp_df$T_FruitHarvInc <- ifelse(
      treepcomp_df$T_ApplyPalm_is < 1,
      treepcomp_df$T_FruitHarvFracHeight * treepcomp_df$T_FruitHarvFrac * treepcomp_df$T_RipeFruitHarvest,
      treepcomp_df$TF_FruitHarvFrac *
        treepcomp_df$T_RipeFruitHarvest
    )
    
    
    
    # T_GroInit[PlantComp,Tree] =  IF TIME = INT(T_PlantTime[Tree]) and AF_AnyTrees? = 1 THEN (if RT_ATType[Tree] < 2 then
    #   T_GroResInit[Tree]*T_UnitConv[PlantComp]*T_GroResConc[PlantComp,Tree]*T_TreesperHa[Tree]/10000 ELSE
    #   T_GroResInit[Tree]*T_UnitConv[PlantComp]*T_GroResConc[PlantComp,Tree]*(1 - T_RtAllocInit[Tree] ) ) else 0
    treepcomp_df$T_GroResInit <- rep(tree_df$T_GroResInit, nrow(pcomp_df))
    treepcomp_df$T_RtAllocInit <- rep(tree_df$T_RtAllocInit, nrow(pcomp_df))
    
    treepcomp_df$T_GroInit <-  ifelse(
      time == floor(treepcomp_df$T_PlantTime) &
        treepcomp_df$AF_AnyTrees_is == 1,
      ifelse(
        treepcomp_df$RT_ATType < 2,
        treepcomp_df$T_GroResInit * treepcomp_df$T_UnitConv * treepcomp_df$T_GroResConc *
          treepcomp_df$T_Treesperha / 10000,
        treepcomp_df$T_GroResInit *
          treepcomp_df$T_UnitConv * treepcomp_df$T_GroResConc * (1 - treepcomp_df$T_RtAllocInit)
      ),
      0
    )
    
    # T_LightPosGrow[Tree] = if T_RelLightMaxGr[Tree]>0 then T_Light[Tree]/T_RelLightMaxGr[Tree] else 0
    tree_df$T_LightPosGrow <- ifelse(tree_df$T_RelLightMaxGr > 0,
                                     tree_df$T_Light / tree_df$T_RelLightMaxGr,
                                     0)
    
    # T_GroResInc[DW,Sp1] =  T_GroInit[DW,Sp1] + (1-T_DiesToday?[Sp1])*(T_GroMax[Sp1]*T_LightPosGrow[Sp1]*MIN(MIN(T_NPosgro[N,Sp1],T_NPosgro[P,Sp1]),TW_Posgro[Sp1]))+ 0 * (T_NUptTot[N,Sp1]+T_NFix[N,Sp1]+RT_TParasitFrac[Zn1,Sp1]+TP_Nutrient_Demand[Sp1,N])
    # T_GroResInc[DW,Sp2] =  T_GroInit[DW,Sp2] + (1-T_DiesToday?[Sp2])*(T_GroMax[Sp2]*T_LightPosGrow[Sp2]*MIN(MIN(T_NPosgro[N,Sp2],T_NPosgro[P,Sp2]),TW_Posgro[Sp2]))+ 0 * (T_NUptTot[N,Sp1]+T_NFix[N,Sp2]+RT_TParasitFrac[Zn1,Sp1]+TP_Nutrient_Demand[Sp2,N])
    # T_GroResInc[DW,Sp3] =  T_GroInit[DW,Sp3] + (1-T_DiesToday?[Sp3])*(T_GroMax[Sp3]*T_LightPosGrow[Sp3]*MIN(MIN(T_NPosgro[N,Sp3],T_NPosgro[P,Sp3]),TW_Posgro[Sp3]))+ 0 * (T_NUptTot[N,Sp3]+T_NFix[N,Sp3]+RT_TParasitFrac[Zn1,Sp1]+TP_Nutrient_Demand[Sp3,N])
    # T_GroResInc[N,Sp1] =  T_GroInit[N,Sp1] + MAX(0, T_NUptTot[N,Sp1]- TP_Nutrient_Demand[Sp1,N])+T_NFix[N,Sp1]+ARRAYMEAN(RT_TParasitFrac[*,Sp2])*T_NFix[N,Sp2]+ 0*T_DiesToday?[Sp1]*(T_GroMax[Sp1]+T_LightPosGrow[Sp1]+T_NPosgro[N,Sp1]+TW_Posgro[Sp1])
    # T_GroResInc[N,Sp2] =  T_GroInit[N,Sp2] + MAX(0, T_NUptTot[N,Sp2]- TP_Nutrient_Demand[Sp2,N])+T_NFix[N,Sp2]-ARRAYMEAN(RT_TParasitFrac[*,Sp2])*T_NFix[N,Sp2]+ 0*T_DiesToday?[Sp2]*(T_GroMax[Sp2]+T_LightPosGrow[Sp2]+T_NPosgro[N,Sp2]+TW_Posgro[Sp2])
    # T_GroResInc[N,Sp3] =  T_GroInit[N,Sp3] + MAX(0, T_NUptTot[N,Sp3]- TP_Nutrient_Demand[Sp3,N])+T_NFix[N,Sp3]+ 0*T_DiesToday?[Sp3]*(T_GroMax[Sp3]+T_LightPosGrow[Sp3]+RT_TParasitFrac[Zn1,Sp1]+T_NPosgro[N,Sp3]+TW_Posgro[Sp2])
    # T_GroResInc[P,Sp1] =  T_GroInit[P,Sp1] + MAX(0, T_NUptTot[P,Sp1]- TP_Nutrient_Demand[Sp1,P])+T_NFix[P,Sp1]+ 0*T_DiesToday?[Sp1]* (T_NPosgro[N,Sp1] + TW_Posgro[Sp2] +T_GroMax[Sp1] + T_LightPosGrow[Sp1]+RT_TParasitFrac[Zn1,Sp1])
    # T_GroResInc[P,Sp2] =  T_GroInit[P,Sp2] + MAX(0, T_NUptTot[P,Sp2]- TP_Nutrient_Demand[Sp2,P])+T_NFix[P,Sp2]+ 0*T_DiesToday?[Sp2]* (T_NPosgro[N,Sp2] + TW_Posgro[Sp2] +T_GroMax[Sp2] + T_LightPosGrow[Sp2]+RT_TParasitFrac[Zn1,Sp1])
    # T_GroResInc[P,Sp3] =  T_GroInit[P,Sp3] + MAX(0, T_NUptTot[P,Sp3]- TP_Nutrient_Demand[Sp3,P])+T_NFix[P,Sp3]+ 0*T_DiesToday?[Sp3]* (T_NPosgro[N,Sp3] + TW_Posgro[Sp3] +T_GroMax[Sp3] + T_LightPosGrow[Sp3]+RT_TParasitFrac[Zn1,Sp1])
    tree_df$T_GroResInc_xDW <- (1 - tree_df$T_DiesToday_is) * (tree_df$T_GroMax *
                                                                 tree_df$T_LightPosGrow * pmin(
                                                                   pmin(tree_df$T_NPosgro_N, tree_df$T_NPosgro_P),
                                                                   tree_df$TW_Posgro
                                                                 ))
    tn_N <- treenut_df[treenut_df$SlNut == "N", ]
    #TODO: confirm the  calc below (not consistent between trees)
    RT_TParasitFrac_N <- mean(zonetree_df[zonetree_df$tree_id == 2, "RT_TParasitFrac"]) * tn_N[tn_N$tree_id == 2, "T_NFix"]
    tree_df$T_GroResInc_xN <-  pmax(0, tn_N$T_NUptTot - tn_N$TP_Nutrient_Demand) + tn_N$T_NFix + c(RT_TParasitFrac_N, -RT_TParasitFrac_N, 0)
    tn_P <- treenut_df[treenut_df$SlNut == "P", ]
    tree_df$T_GroResInc_xP <-  pmax(0, tn_P$T_NUptTot - tn_P$TP_Nutrient_Demand) + tn_P$T_NFix
    treepcomp_df$T_GroResInc <- treepcomp_df$T_GroInit + c(tree_df$T_GroResInc_xDW,
                                                           tree_df$T_GroResInc_xN,
                                                           tree_df$T_GroResInc_xP)
    
    # T_BarkThickness = GRAPH(Time)
    T_BarkThickness <- get_y_df(time, "T_BarkThickness")
    
    # T_TargetLatexStock[PlantComp,Tree] = 0.314*((T_StemDiam[Tree]+T_BarkThickness)^2 - T_StemDiam[Tree]^2)*(T_Height[Tree])*T_MaxBarkLatexContent
    treepcomp_df$T_Height <- rep(tree_df$T_Height, nrow(pcomp_df))
    treepcomp_df$T_TargetLatexStock <- 0.314 * ((treepcomp_df$T_StemDiam + T_BarkThickness)^2 - treepcomp_df$T_StemDiam^2) *
      (treepcomp_df$T_Height) * T_MaxBarkLatexContent
    
    # T_PotResUseLatexForm[PlantComp,Tree] = min(T_GroRes[DW,Tree]*T_MaxGrowthUtFrac,(1+T_LatexFormResp)*(max(0,T_TargetLatexStock[DW,Tree]-T_LatexStock[DW,Tree]))/T_LatexRecoveryTime)
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_TargetLatexStock", "T_LatexStock")]
    treepcomp_df$T_TargetLatexStock_DW <- rep(tp_DW$T_TargetLatexStock, nrow(pcomp_df))
    treepcomp_df$T_LatexStock_DW <- rep(tp_DW$T_LatexStock, nrow(pcomp_df))
    treepcomp_df$T_PotResUseLatexForm <- pmin(
      treepcomp_df$T_GroRes_DW * T_MaxGrowthUtFrac,
      (1 + T_LatexFormResp) *
        (
          pmax(
            0,
            treepcomp_df$T_TargetLatexStock_DW - treepcomp_df$T_LatexStock_DW
          )
        ) / T_LatexRecoveryTime
    )
    
    # T_DayofYear = mod(time+CA_DOYStart,365)
    T_DayofYear <- time + CA_DOYStart %% 365
    
    # T_Temp = GRAPH(T_DayofYear)
    T_Temp <- get_y_df(T_DayofYear, "T_Temp")
    
    # T_TempRespMaint = GRAPH(T_Temp)
    T_TempRespMaint <- get_y_df(T_Temp, "T_TempRespMaint")
    
    # T_MaintResp[PlantComp,Tree] = (T_CanMaintResp*T_LfTwig[DW,Tree]+(1-T_LWR[Tree])*T_LfTwig[DW,Tree]*T_WoodMaintResp+T_LatexMaintResp*T_LatexStock[DW,Tree]+T_sapWood[DW,Tree]*T_WoodMaintResp)*T_TempRespMaint
    treepcomp_df$T_MaintResp <- (
      T_CanMaintResp * treepcomp_df$T_LfTwig_DW + (1 - treepcomp_df$T_LWR) *
        treepcomp_df$T_LfTwig_DW * T_WoodMaintResp +
        T_LatexMaintResp * treepcomp_df$T_LatexStock_DW + treepcomp_df$T_SapWood_DW *
        T_WoodMaintResp
    ) * T_TempRespMaint
    
    # T_PotResUseGrowth[Tree] = T_GroRes[DW,Tree]*T_MaxGrowthUtFrac*(1+T_GrowthResp)
    tree_df$T_PotResUseGrowth <- tree_df$T_GroRes_DW * T_MaxGrowthUtFrac *
      (1 + T_GrowthResp)
    
    # T_LatexFormAlloc[PlantComp,Tree] = if T_PotResUseLatexForm[DW,Tree]> 0 then min(T_PotResUseLatexForm[DW,Tree],max(0,T_GroRes[DW,Tree]*T_MaxUseFrac-T_MaintResp[DW,Tree])*(T_PotResUseLatexForm[DW,Tree]^(1/T_RelLatexFormPriority)/(T_PotResUseGrowth[Tree]+T_PotResUseLatexForm[DW,Tree]^(1/T_RelLatexFormPriority)))) else 0
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", c("T_PotResUseLatexForm", "T_MaintResp")]
    treepcomp_df$T_PotResUseLatexForm_DW <- rep(tp_DW$T_PotResUseLatexForm, nrow(pcomp_df))
    treepcomp_df$T_MaintResp_DW <- rep(tp_DW$T_MaintResp, nrow(pcomp_df))
    treepcomp_df$T_PotResUseGrowth <- rep(tree_df$T_PotResUseGrowth, nrow(pcomp_df))
    treepcomp_df$T_LatexFormAlloc <- ifelse(
      treepcomp_df$T_PotResUseLatexForm_DW > 0,
      pmin(
        treepcomp_df$T_PotResUseLatexForm_DW,
        pmax(
          0,
          treepcomp_df$T_GroRes_DW * T_MaxUseFrac - treepcomp_df$T_MaintResp_DW
        ) * (
          treepcomp_df$T_PotResUseLatexForm_DW^(1 / T_RelLatexFormPriority) /
            (
              treepcomp_df$T_PotResUseGrowth + treepcomp_df$T_PotResUseLatexForm_DW^(1 /
                                                                                       T_RelLatexFormPriority)
            )
        )
      ),
      0
    )
    
    # T_LatexFormation[DW,Sp1] = (T_LatexFormAlloc[DW,Sp1]/(1+T_LatexFormResp))*(0+T_Rubber?[Sp1])
    # T_LatexFormation[DW,Sp2] = (T_LatexFormAlloc[DW,Sp2]/(1+T_LatexFormResp))*(0+T_Rubber?[Sp2])
    # T_LatexFormation[DW,Sp3] = (T_LatexFormAlloc[DW,Sp3]/(1+T_LatexFormResp))*(0+T_Rubber?[Sp3])
    # T_LatexFormation[N,Sp1] = ((T_LatexFormAlloc[N,Sp1]/(1+T_LatexFormResp))*(1-T_Rubber?[Sp1]))*0
    # T_LatexFormation[N,Sp2] = ((T_LatexFormAlloc[N,Sp2]/(1+T_LatexFormResp))*(1-T_Rubber?[Sp2]))*0
    # T_LatexFormation[N,Sp3] = ((T_LatexFormAlloc[N,Sp3]/(1+T_LatexFormResp))*(1-T_Rubber?[Sp3]))*0
    # T_LatexFormation[P,Sp1] = ((T_LatexFormAlloc[P,Sp1]/(1+T_LatexFormResp))*(1-T_Rubber?[Sp1]))*0
    # T_LatexFormation[P,Sp2] = ((T_LatexFormAlloc[P,Sp2]/(1+T_LatexFormResp))*(1-T_Rubber?[Sp2]))*0
    # T_LatexFormation[P,Sp3] = ((T_LatexFormAlloc[P,Sp3]/(1+T_LatexFormResp))*(1-T_Rubber?[Sp3]))*0
    treepcomp_df$T_LatexFormation <- 0
    treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LatexFormation"] <- (treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LatexFormAlloc"] /
                                                                          (1 + T_LatexFormResp)) * tree_df$T_Rubber_is
    
    # T_Respiration[DW,Sp1] = T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    # T_Respiration[DW,Sp2] = T_NFix[N,Sp2]*T_NFixDWUnitCost[Sp2]
    # T_Respiration[DW,Sp3] = T_NFix[N,Sp3]*T_NFixDWUnitCost[Sp3]
    # T_Respiration[N,Sp1] = 0*T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    # T_Respiration[N,Sp2] = 0*T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    # T_Respiration[N,Sp3] = 0*T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    # T_Respiration[P,Sp1] = 0*T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    # T_Respiration[P,Sp2] = 0*T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    # T_Respiration[P,Sp3] = 0*T_NFix[N,Sp1]*T_NFixDWUnitCost[Sp1]
    treepcomp_df$T_Respiration <- 0
    treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Respiration"] <- treenut_df[treenut_df$SlNut == "N", "T_NFix"] * tree_df$T_NFixDWUnitCost
    
    # T_GroResStorInc[PlantComp,Tree] = if T_GrowsToday?[Tree] = 0 then 0  else if T_ApplyPalm?[Tree] = 0 then 0 else
    #     if T_GroRes[PlantComp,Tree]>max(TF_FruitDemand[PlantComp,Tree]/T_RelFruitAllocMax[Tree],TF_VegDemand[PlantComp,Tree]/T_GroResFrac[Tree]) then T_GrowResStorFrac[Tree]*T_GroRes[PlantComp,Tree]-T_GrowResMobFrac[Tree]*T_GrowStor[PlantComp,Tree] else -T_GrowResMobFrac[Tree]*T_GrowStor[PlantComp,Tree]
    treepcomp_df$T_GrowResStorFrac <- rep(tree_df$T_GrowResStorFrac, nrow(pcomp_df))
    treepcomp_df$T_GrowResMobFrac <- rep(tree_df$T_GrowResMobFrac, nrow(pcomp_df))
    treepcomp_df$T_GroResStorInc <- ifelse(
      treepcomp_df$T_GrowsToday_is == 0,
      0,
      ifelse(
        treepcomp_df$T_ApplyPalm_is == 0,
        0,
        ifelse(
          treepcomp_df$T_GroRes > pmax(
            treepcomp_df$TF_FruitDemand / treepcomp_df$T_RelFruitAllocMax,
            treepcomp_df$TF_VegDemand / treepcomp_df$T_GroResFrac
          ),
          treepcomp_df$T_GrowResStorFrac * treepcomp_df$T_GroRes -
            treepcomp_df$T_GrowResMobFrac * treepcomp_df$T_GrowStor,
          -treepcomp_df$T_GrowResMobFrac * treepcomp_df$T_GrowStor
        )
      )
    )
    
    # T_TargHeartWood[PlantComp,Tree] = T_WoodConc[PlantComp,Tree]*(T_HeartWoodDiam[Tree]^2)*3.14*T_WoodDens[Tree]*T_WoodH[Tree]
    treepcomp_df$T_HeartWoodDiam <- rep(tree_df$T_HeartWoodDiam, nrow(pcomp_df))
    treepcomp_df$T_TargHeartWood <- treepcomp_df$T_WoodConc * (treepcomp_df$T_HeartWoodDiam^2) *
      3.14 * treepcomp_df$T_WoodDens * treepcomp_df$T_WoodH
    
    # T_HeartWoodInc[PlantComp,Tree] = if T_HeartWoodAllocAftPruned?=1 and T_Prun[PlantComp,Tree]>0 then T_SapWood[PlantComp,Tree] else min(max(T_TargHeartWood[PlantComp,Tree]-T_HeartWood[PlantComp,Tree],0),T_SapWood[PlantComp,Tree])
    treepcomp_df$T_HeartWoodAllocAftPruned_is <- T_HeartWoodAllocAftPruned_is
    treepcomp_df$T_HeartWoodInc <- ifelse(
      treepcomp_df$T_HeartWoodAllocAftPruned_is == 1 &
        treepcomp_df$T_Prun > 0,
      treepcomp_df$T_SapWood,
      pmin(
        pmax(
          treepcomp_df$T_TargHeartWood - treepcomp_df$T_HeartWood,
          0
        ),
        treepcomp_df$T_SapWood
      )
    )
    
    # T_DynTappingFrac = GRAPH(Time)
    T_DynTappingFrac <- get_y_df(time, "T_DynTappingFrac")
    
    # T_ModifiedDynTappingFrac = T_TappingFracMultiplier*T_DynTappingFrac
    T_ModifiedDynTappingFrac <- T_TappingFracMultiplier * T_DynTappingFrac
    
    # T_LatexPotProd = GRAPH(time)
    T_LatexPotProd <- get_y_df(time, "T_LatexPotProd")
    
    # T_PanelQuality[Tree] = IF T_PanelAvailable[Tree]>0 THEN T_PanelQuality1[Tree] ELSE IF T_SecTimePanelAvailable[Tree]>0 THEN T_PanelQuality2[Tree] ELSE 0
    tree_df$T_PanelQuality <- ifelse(
      tree_df$T_PanelAvailable > 0,
      tree_df$T_PanelQuality1,
      ifelse(
        tree_df$T_SecTimePanelAvailable > 0,
        tree_df$T_PanelQuality2,
        0
      )
    )
    
    # T_GirthMax[Tree] = 2*3.14*T_StemDiam[Tree]/2
    tree_df$T_GirthMax <- 2 * 3.14 * tree_df$T_StemDiam / 2
    
    # T_GirthMinforTappingcm = 2*3.14*T_MinDiamforTappingcm/2
    T_GirthMinforTappingcm <- 2 * 3.14 * T_MinDiamforTappingcm /
      2
    
    # T_RestDaysperTappingday = GRAPH(T_DayofYear)
    T_RestDaysperTappingday <- get_y_df(T_DayofYear, "T_RestDaysperTappingday")
    
    # T_TappingDay?[Tree] = if T_Tapatall? < 1 then 0 else if T_PanelQuality[Tree] = 0 then 0 else if T_GirthMax[Tree]<T_GirthMinforTappingcm then 0 else if mod(time,int(T_RestDaysperTappingday+1)) = 1 then 1 else 0
    tree_df$T_TappingDay_is <- ifelse(T_Tapatall_is < 1,
                                      0,
                                      ifelse(
                                        tree_df$T_PanelQuality == 0,
                                        0,
                                        ifelse(
                                          tree_df$T_GirthMax < T_GirthMinforTappingcm,
                                          0,
                                          ifelse((
                                            time %% floor(T_RestDaysperTappingday + 1)
                                          ) == 1, 1, 0)
                                        )
                                      ))
    
    # T_TapThisTree?[Tree] = if T_ExpRetToLab[Tree] > T_ExpRetThresh then 1 else 0
    tree_df$T_TapThisTree_is <- ifelse(tree_df$T_ExpRetToLab > T_ExpRetThresh, 1, 0)
    
    # T_Tapping[DW,Sp1] = if T_BrownBast?=1 then T_LatexStock[DW,Sp1]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp1]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp1] else T_LatexStock[DW,Sp1]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp1]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp1]
    # T_Tapping[DW,Sp2] = if T_BrownBast?=1 then T_LatexStock[DW,Sp2]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp2]*T_TapThisTree?[Sp2]*T_PanelQuality[Sp2] else T_LatexStock[DW,Sp2]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp2]*T_TapThisTree?[Sp2]*T_PanelQuality[Sp2]
    # T_Tapping[DW,Sp3] = if T_BrownBast?=1 then T_LatexStock[DW,Sp3]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp3]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp3] else T_LatexStock[DW,Sp3]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp3]*T_TapThisTree?[Sp3]*T_PanelQuality[Sp3]
    # T_Tapping[N,Sp1] = if T_BrownBast?=1 then 0*(T_LatexStock[N,Sp1]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp1]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp1]) else 0*(T_LatexStock[N,Sp1]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp1]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp1])
    # T_Tapping[N,Sp2] = if T_BrownBast?=1 then 0*(T_LatexStock[N,Sp2]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp2]*T_TapThisTree?[Sp2]*T_PanelQuality[Sp2]) else 0*(T_LatexStock[N,Sp2]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp2]*T_TapThisTree?[Sp2]*T_PanelQuality[Sp2])
    # T_Tapping[N,Sp3] = if T_BrownBast?=1 then 0*(T_LatexStock[N,Sp3]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp3]*T_TapThisTree?[Sp3]*T_PanelQuality[Sp3]) else 0*(T_LatexStock[N,Sp3]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp3]*T_TapThisTree?[Sp3]*T_PanelQuality[Sp3])
    # T_Tapping[P,Sp1] = if T_BrownBast?=1 then 0*(T_LatexStock[P,Sp1]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp1]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp1]) else 0*(T_LatexStock[P,Sp1]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp1]*T_TapThisTree?[Sp1]*T_PanelQuality[Sp1])
    # T_Tapping[P,Sp2] = if T_BrownBast?=1 then 0*(T_LatexStock[P,Sp2]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp2]*T_TapThisTree?[Sp2]*T_PanelQuality[Sp2]) else 0*(T_LatexStock[P,Sp2]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp2]*T_TapThisTree?[Sp2]*T_PanelQuality[Sp2])
    # T_Tapping[P,Sp3] = if T_BrownBast?=1 then 0*(T_LatexStock[P,Sp3]*T_ModifiedDynTappingFrac*T_LatexPotProd*T_TappingDay?[Sp3]*T_TapThisTree?[Sp3]*T_PanelQuality[Sp3]) else 0*(T_LatexStock[P,Sp3]*T_TappingFrac*T_LatexPotProd*T_TappingDay?[Sp3]*T_TapThisTree?[Sp3]*T_PanelQuality[Sp1])
    tree_df$T_BrownBast_is <- T_BrownBast_is
    treepcomp_df$T_Tapping <- 0
    tree_df$T_Tapping_a <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LatexStock"] * T_LatexPotProd * tree_df$T_TappingDay_is *
      tree_df$T_TapThisTree_is * tree_df$T_PanelQuality
    treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Tapping"] <- ifelse(
      tree_df$T_BrownBast_is == 1,
      tree_df$T_Tapping_a * T_ModifiedDynTappingFrac,
      tree_df$T_Tapping_a * T_TappingFrac
    )
    
    # T_LifallTreeDies[PlantComp,Tree] = if T_DiesToday?[Tree] = 1 then T_LifallCum[PlantComp,Tree] else 0
    treepcomp_df$T_LifallTreeDies <- ifelse(treepcomp_df$T_DiesToday_is == 1,
                                            treepcomp_df$T_LifallCum,
                                            0)
    
    # T_PrunCumTreeDies[PlantComp,Tree] = if T_DiesToday?[Tree] = 1 then T_PrunCum[PlantComp,Tree] else 0
    treepcomp_df$T_PrunCumTreeDies <- ifelse(treepcomp_df$T_DiesToday_is == 1,
                                             treepcomp_df$T_PrunCum,
                                             0)
    
    # T_Root_Dra_ZoneTree[Zn1,Sp1] = ARRAYSUM(T_Root_Dra_T1_ZnL[Zn1,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn1,Sp2] = ARRAYSUM(T_Root_Dra_T2_ZnL[Zn1,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn1,Sp3] = ARRAYSUM(T_Root_Dra_T3_ZnL[Zn1,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn2,Sp1] = ARRAYSUM(T_Root_Dra_T1_ZnL[Zn2,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn2,Sp2] = ARRAYSUM(T_Root_Dra_T2_ZnL[Zn2,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn2,Sp3] = ARRAYSUM(T_Root_Dra_T3_ZnL[Zn2,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn3,Sp1] = ARRAYSUM(T_Root_Dra_T1_ZnL[Zn3,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn3,Sp2] = ARRAYSUM(T_Root_Dra_T2_ZnL[Zn3,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn3,Sp3] = ARRAYSUM(T_Root_Dra_T3_ZnL[Zn3,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn4,Sp1] = ARRAYSUM(T_Root_Dra_T1_ZnL[Zn4,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn4,Sp2] = ARRAYSUM(T_Root_Dra_T2_ZnL[Zn4,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    # T_Root_Dra_ZoneTree[Zn4,Sp3] = ARRAYSUM(T_Root_Dra_T3_ZnL[Zn4,*])+ 0*(T_Root_Dra_T1_ZnL[Zn1,1]+T_Root_Dra_T2_ZnL[Zn1,1]+T_Root_Dra_T3_ZnL[Zn1,1])
    zonetree_df$T_Root_Dra_ZoneTree <- aggregate(zonelayertree_df["T_Root_Dra_ZnL"], zonelayertree_df[c("zone", "tree_id")], sum)$T_Root_Dra_ZnL
    
    # T_Root_Dra_Tree[Tree] = AF_ZoneFrac[Zn1]*T_Root_Dra_ZoneTree[Zn1,Tree]+AF_ZoneFrac[Zn2]*T_Root_Dra_ZoneTree[Zn2,Tree]+AF_ZoneFrac[Zn3]*T_Root_Dra_ZoneTree[Zn3,Tree]+AF_ZoneFrac[Zn4]*T_Root_Dra_ZoneTree[Zn4,Tree]
    zonetree_df$T_Root_Dra_ZoneTree_Frac <- zonetree_df$AF_ZoneFrac *
      zonetree_df$T_Root_Dra_ZoneTree
    tree_df$T_Root_Dra_Tree <- aggregate(zonetree_df["T_Root_Dra_ZoneTree_Frac"], zonetree_df["tree_id"], sum)$T_Root_Dra_ZoneTree_Frac
    
    # T_RtType0Input[PlantComp,Tree] = If RT_T_MeanResTime[Sp1] = 0 then 0 else If RT_ATType[Tree]<2 then (if time = T_PlantTime[Tree] then 1 else  (if time > T_PlantTime[Tree] then 1/RT_T_MeanResTime[Tree] else 0))*T_Root_Dra_Tree[Tree]*T_RtConc[PlantComp,Tree]*T_UnitConv[PlantComp] else 0
    treepcomp_df$RT_T_MeanResTime_Sp1 <- tree_df[tree_df$tree_id == 1, "RT_T_MeanResTime"]
    treepcomp_df$T_Root_Dra_Tree <- rep(tree_df$T_Root_Dra_Tree, nrow(pcomp_df))
    treepcomp_df$T_RtType0Input <- ifelse(
      treepcomp_df$RT_T_MeanResTime_Sp1 == 0,
      0,
      ifelse(
        treepcomp_df$RT_ATType < 2,
        ifelse(
          time == treepcomp_df$T_PlantTime,
          1,
          ifelse(
            time > treepcomp_df$T_PlantTime,
            1 / treepcomp_df$RT_T_MeanResTime,
            0
          )
        ) *
          treepcomp_df$T_Root_Dra_Tree *
          treepcomp_df$T_RtConc * treepcomp_df$T_UnitConv,
        0
      )
    )
    
    # T_WoodInit[PlantComp,Tree] = if time =  T_PlantTime[Tree] and  AF_AnyTrees?=1 then T_WoodBiomInit[Tree]*T_UnitConv[PlantComp]*T_WoodConc[PlantComp,Tree]*T_TreesperHa[Tree]/10000 else 0
    treepcomp_df$T_WoodBiomInit <- rep(tree_df$T_WoodBiomInit, nrow(pcomp_df))
    treepcomp_df$T_WoodInit <- ifelse(
      time ==  treepcomp_df$T_PlantTime &
        treepcomp_df$AF_AnyTrees_is == 1,
      treepcomp_df$T_WoodBiomInit * treepcomp_df$T_UnitConv * treepcomp_df$T_WoodConc *
        treepcomp_df$T_Treesperha / 10000,
      0
    )
    
    # T_WoodIni[PlantComp,Tree] = T_WoodInit[PlantComp,Tree]
    treepcomp_df$T_WoodIni <- treepcomp_df$T_WoodInit
    
    # PDTLigImp[Tree,Animals] = PD_NastiesinPlot[Animals]*PD_TEatenBy?[Tree,Animals]*PD_TLignovore?[Animals]
    treeanimal_df$PD_TLignovore_is <- rep(animal_df$PD_TLignovore_is, each = ntree)
    treeanimal_df$PDTLigImp <- treeanimal_df$PD_NastiesinPlot * treeanimal_df$PD_TEatenBy_is *
      treeanimal_df$PD_TLignovore_is
    
    # PD_TLigVFrac[Tree] = min(1,PD_TLignovory[Tree]+AF_DynPestImpacts?*ARRAYSUM(PDTLigImp[Tree,*]))
    tree_df$PDTLigImp <- aggregate(treeanimal_df["PDTLigImp"], treeanimal_df["tree_id"], sum)$PDTLigImp
    tree_df$PD_TLigVFrac <- pmin(1,
                                 tree_df$PD_TLignovory + AF_DynPestImpacts_is * tree_df$PDTLigImp)
    
    # T_Lignovory[PlantComp,Tree] = T_SapWood[PlantComp,Tree]*PD_TLigVFrac[Tree]
    treepcomp_df$PD_TLigVFrac <- rep(tree_df$PD_TLigVFrac, nrow(pcomp_df))
    treepcomp_df$T_Lignovory <- treepcomp_df$T_SapWood * treepcomp_df$PD_TLigVFrac
    
    # T_WoodSlashed[PlantComp,Tree] = if time = int(S&B_SlashTime[Tree]) or  T_DiesToday?[Tree] = 1 then (1-T_SlashSellWoodFrac[Tree])*T_SapWood[PlantComp,Tree]/DT else 0
    treepcomp_df$T_WoodSlashed <- ifelse(
      time == floor(treepcomp_df$SB_SlashTime) |
        treepcomp_df$T_DiesToday_is == 1,
      (1 - treepcomp_df$T_SlashSellWoodFrac) * treepcomp_df$T_SapWood,
      0
    )
    
    # TF_InitFruitspBunch[Tree] = GRAPH(TF_CurrentLeafNo[Tree])
    tree_df$TF_InitFruitspBunch <- get_y_df(tree_df$TF_CurrentLeafNo, "TF_InitFruitspBunch")
    
    # TF_FruitNoPassOn[Sp1,Ripe] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe]+TF_FruitsperBunch[Sp1,Ripe_1] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe]
    # TF_FruitNoPassOn[Sp1,Ripe_1] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_1]+TF_FruitsperBunch[Sp1,Ripe_2] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_1]
    # TF_FruitNoPassOn[Sp1,Ripe_2] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_2]+TF_FruitsperBunch[Sp1,Ripe_3] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_2]
    # TF_FruitNoPassOn[Sp1,Ripe_3] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_3]+TF_FruitsperBunch[Sp1,Ripe_4] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_3]
    # TF_FruitNoPassOn[Sp1,Ripe_4] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_4]+TF_FruitsperBunch[Sp1,Ripe_5] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_4]
    # TF_FruitNoPassOn[Sp1,Ripe_5] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_5]+TF_FruitsperBunch[Sp1,Ripe_6] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_5]
    # TF_FruitNoPassOn[Sp1,Ripe_6] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_6]+TF_FruitsperBunch[Sp1,Ripe_7] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_6]
    # TF_FruitNoPassOn[Sp1,Ripe_7] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_7]+TF_FruitsperBunch[Sp1,Ripe_8] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_7]
    # TF_FruitNoPassOn[Sp1,Ripe_8] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_8]+TF_FruitsperBunch[Sp1,Ripe_9] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_8]
    # TF_FruitNoPassOn[Sp1,Ripe_9] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_9]+TF_FruitsperBunch[Sp1,Ripe_10] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_9]
    # TF_FruitNoPassOn[Sp1,Ripe_10] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_10]+TF_FruitsperBunch[Sp1,Ripe_11] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_10]
    # TF_FruitNoPassOn[Sp1,Ripe_11] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_11]+TF_FruitsperBunch[Sp1,Ripe_12] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_11]
    # TF_FruitNoPassOn[Sp1,Ripe_12] = if TF_NewLeaf?[Sp1] =1 then - TF_FruitsperBunch[Sp1,Ripe_12]+TF_FruitsperBunch[Sp1,Early_fruit] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Ripe_12]
    # TF_FruitNoPassOn[Sp1,Early_fruit] = if TF_NewLeaf?[Sp1] = 1 then  -TF_FruitsperBunch[Sp1,Early_fruit] + TF_FruitsperBunch[Sp1,Pollinated] else 0*TF_BunchGender[Sp1,Early_fruit]*TF_InitFruitspBunch[Sp1]
    # TF_FruitNoPassOn[Sp1,Pollinated] = if TF_NewLeaf?[Sp1] = 1 then  -TF_FruitsperBunch[Sp1,Pollinated] + TF_FruitsperBunch[Sp1,Anthesis] else 0*TF_BunchGender[Sp1,Pollinated]*TF_InitFruitspBunch[Sp1]
    # TF_FruitNoPassOn[Sp1,Anthesis] = if TF_NewLeaf?[Sp1] = 1 then  - TF_FruitsperBunch[Sp1,Anthesis] + TF_FruitsperBunch[Sp1,Anthesis_1] else 0*TF_BunchGender[Sp1,Anthesis]*TF_InitFruitspBunch[Sp1]
    # TF_FruitNoPassOn[Sp1,Anthesis_1] = if TF_NewLeaf?[Sp1] = 1 then  - TF_FruitsperBunch[Sp1,Anthesis_1] + TF_FruitsperBunch[Sp1,Anthesis_2] else 0*TF_BunchGender[Sp1,Anthesis_1]*TF_InitFruitspBunch[Sp1]
    # TF_FruitNoPassOn[Sp1,Anthesis_2] = if TF_NewLeaf?[Sp1] = 1 then  - TF_FruitsperBunch[Sp1,Anthesis_2] + TF_FruitsperBunch[Sp1,Anthesis_3] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Anthesis_2]
    # TF_FruitNoPassOn[Sp1,Anthesis_3] = if TF_NewLeaf?[Sp1] = 1 then  - TF_FruitsperBunch[Sp1,Anthesis_3] + TF_FruitsperBunch[Sp1,Anthesis_4] else 0*TF_BunchGender[Sp1,Anthesis_3]*TF_InitFruitspBunch[Sp1]
    # TF_FruitNoPassOn[Sp1,Anthesis_4] = if TF_NewLeaf?[Sp1] = 1 then  - TF_FruitsperBunch[Sp1,Anthesis_4] + TF_FruitsperBunch[Sp1,Anthesis_5] else 0*TF_BunchGender[Sp1,Anthesis_4]*TF_InitFruitspBunch[Sp1]
    # TF_FruitNoPassOn[Sp1,Anthesis_5] = if TF_NewLeaf?[Sp1] = 1 then  - TF_FruitsperBunch[Sp1,Anthesis_5] + TF_FruitsperBunch[Sp1,Anthesis_6] else 0*TF_InitFruitspBunch[Sp1]*TF_BunchGender[Sp1,Anthesis_5]
    # TF_FruitNoPassOn[Sp1,Anthesis_6] = if TF_NewLeaf?[Sp1] = 1 then  -TF_FruitsperBunch[Sp1,Anthesis_6] + TF_InitFruitspBunch[Sp1]*(TF_BunchGender[Sp1,Anthesis_6]-1) else 0
    # TF_FruitNoPassOn[Sp2,Ripe] = if TF_NewLeaf?[Sp2] = 1 then -TF_FruitsperBunch[Sp2,Ripe]+TF_FruitsperBunch[Sp2,Ripe_1] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe]
    # TF_FruitNoPassOn[Sp2,Ripe_1] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_1]+TF_FruitsperBunch[Sp2,Ripe_2] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_1]
    # TF_FruitNoPassOn[Sp2,Ripe_2] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_2]+TF_FruitsperBunch[Sp2,Ripe_3] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_2]
    # TF_FruitNoPassOn[Sp2,Ripe_3] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_3]+TF_FruitsperBunch[Sp2,Ripe_4] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_3]
    # TF_FruitNoPassOn[Sp2,Ripe_4] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_4]+TF_FruitsperBunch[Sp2,Ripe_5] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_4]
    # TF_FruitNoPassOn[Sp2,Ripe_5] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_5]+TF_FruitsperBunch[Sp2,Ripe_6] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_5]
    # TF_FruitNoPassOn[Sp2,Ripe_6] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_6]+TF_FruitsperBunch[Sp2,Ripe_7] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_6]
    # TF_FruitNoPassOn[Sp2,Ripe_7] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_7]+TF_FruitsperBunch[Sp2,Ripe_8] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_7]
    # TF_FruitNoPassOn[Sp2,Ripe_8] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_8]+TF_FruitsperBunch[Sp2,Ripe_9] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_8]
    # TF_FruitNoPassOn[Sp2,Ripe_9] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_9]+TF_FruitsperBunch[Sp2,Ripe_10] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_9]
    # TF_FruitNoPassOn[Sp2,Ripe_10] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_10]+TF_FruitsperBunch[Sp2,Ripe_11] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_10]
    # TF_FruitNoPassOn[Sp2,Ripe_11] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_11]+TF_FruitsperBunch[Sp2,Ripe_12] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_11]
    # TF_FruitNoPassOn[Sp2,Ripe_12] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Ripe_12]+TF_FruitsperBunch[Sp2,Early_fruit] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Ripe_12]
    # TF_FruitNoPassOn[Sp2,Early_fruit] = if TF_NewLeaf?[Sp2] = 1 then-TF_FruitsperBunch[Sp2,Early_fruit] + TF_FruitsperBunch[Sp2,Pollinated] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Early_fruit]
    # TF_FruitNoPassOn[Sp2,Pollinated] = if TF_NewLeaf?[Sp2] = 1 then -TF_FruitsperBunch[Sp2,Pollinated] + TF_FruitsperBunch[Sp2,Anthesis] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Pollinated]
    # TF_FruitNoPassOn[Sp2,Anthesis] = if TF_NewLeaf?[Sp2] = 1 then - TF_FruitsperBunch[Sp2,Anthesis] + TF_FruitsperBunch[Sp2,Anthesis_1] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Anthesis]
    # TF_FruitNoPassOn[Sp2,Anthesis_1] = if TF_NewLeaf?[Sp2] = 1 then - TF_FruitsperBunch[Sp2,Anthesis_1] + TF_FruitsperBunch[Sp2,Anthesis_2] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Anthesis_1]
    # TF_FruitNoPassOn[Sp2,Anthesis_2] = if TF_NewLeaf?[Sp2] = 1 then- TF_FruitsperBunch[Sp2,Anthesis_2] + TF_FruitsperBunch[Sp2,Anthesis_3] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Anthesis_2]
    # TF_FruitNoPassOn[Sp2,Anthesis_3] = if TF_NewLeaf?[Sp2] = 1 then - TF_FruitsperBunch[Sp2,Anthesis_3] + TF_FruitsperBunch[Sp2,Anthesis_4] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Anthesis_3]
    # TF_FruitNoPassOn[Sp2,Anthesis_4] = if TF_NewLeaf?[Sp2] = 1 then- TF_FruitsperBunch[Sp2,Anthesis_4] + TF_FruitsperBunch[Sp2,Anthesis_5] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Anthesis_4]
    # TF_FruitNoPassOn[Sp2,Anthesis_5] = if TF_NewLeaf?[Sp2] = 1 then - TF_FruitsperBunch[Sp2,Anthesis_5] + TF_FruitsperBunch[Sp2,Anthesis_6] else 0*TF_InitFruitspBunch[Sp2]*TF_BunchGender[Sp2,Anthesis_5]
    # TF_FruitNoPassOn[Sp2,Anthesis_6] = if TF_NewLeaf?[Sp2] = 1 then  -TF_FruitsperBunch[Sp2,Anthesis_6] + TF_InitFruitspBunch[Sp2]*(TF_BunchGender[Sp2,Anthesis_6]-1) else 0
    # TF_FruitNoPassOn[Sp3,Ripe] = if TF_NewLeaf?[Sp3] = 1 then -TF_FruitsperBunch[Sp3,Ripe] +TF_FruitsperBunch[Sp3,Ripe_1] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe]
    # TF_FruitNoPassOn[Sp3,Ripe_1] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_1]+TF_FruitsperBunch[Sp3,Ripe_2] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_1]
    # TF_FruitNoPassOn[Sp3,Ripe_2] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_2]+TF_FruitsperBunch[Sp3,Ripe_3] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_2]
    # TF_FruitNoPassOn[Sp3,Ripe_3] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_3]+TF_FruitsperBunch[Sp3,Ripe_4] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_3]
    # TF_FruitNoPassOn[Sp3,Ripe_4] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_4]+TF_FruitsperBunch[Sp3,Ripe_5] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_4]
    # TF_FruitNoPassOn[Sp3,Ripe_5] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_5]+TF_FruitsperBunch[Sp3,Ripe_6] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_5]
    # TF_FruitNoPassOn[Sp3,Ripe_6] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_6]+TF_FruitsperBunch[Sp3,Ripe_7] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_6]
    # TF_FruitNoPassOn[Sp3,Ripe_7] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_7]+TF_FruitsperBunch[Sp3,Ripe_8] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_7]
    # TF_FruitNoPassOn[Sp3,Ripe_8] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_8]+TF_FruitsperBunch[Sp3,Ripe_9] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_8]
    # TF_FruitNoPassOn[Sp3,Ripe_9] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_9]+TF_FruitsperBunch[Sp3,Ripe_10] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_9]
    # TF_FruitNoPassOn[Sp3,Ripe_10] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_10]+TF_FruitsperBunch[Sp3,Ripe_11] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_10]
    # TF_FruitNoPassOn[Sp3,Ripe_11] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_11]+TF_FruitsperBunch[Sp3,Ripe_12] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_11]
    # TF_FruitNoPassOn[Sp3,Ripe_12] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Ripe_12]+TF_FruitsperBunch[Sp3,Early_fruit] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Ripe_12]
    # TF_FruitNoPassOn[Sp3,Early_fruit] = if TF_NewLeaf?[Sp3] = 1 then-TF_FruitsperBunch[Sp3,Early_fruit] + TF_FruitsperBunch[Sp3,Pollinated] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Early_fruit]
    # TF_FruitNoPassOn[Sp3,Pollinated] = if TF_NewLeaf?[Sp3] = 1 then -TF_FruitsperBunch[Sp3,Pollinated] + TF_FruitsperBunch[Sp3,Anthesis] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Pollinated]
    # TF_FruitNoPassOn[Sp3,Anthesis] = if TF_NewLeaf?[Sp3] = 1 then - TF_FruitsperBunch[Sp3,Anthesis] + TF_FruitsperBunch[Sp3,Anthesis_1] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Anthesis]
    # TF_FruitNoPassOn[Sp3,Anthesis_1] = if TF_NewLeaf?[Sp3] = 1 then- TF_FruitsperBunch[Sp3,Anthesis_1] + TF_FruitsperBunch[Sp3,Anthesis_2] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Anthesis_1]
    # TF_FruitNoPassOn[Sp3,Anthesis_2] = if TF_NewLeaf?[Sp3] = 1 then - TF_FruitsperBunch[Sp3,Anthesis_2] + TF_FruitsperBunch[Sp3,Anthesis_3] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Anthesis_2]
    # TF_FruitNoPassOn[Sp3,Anthesis_3] = if TF_NewLeaf?[Sp3] = 1 then - TF_FruitsperBunch[Sp3,Anthesis_3] + TF_FruitsperBunch[Sp3,Anthesis_4] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Anthesis_3]
    # TF_FruitNoPassOn[Sp3,Anthesis_4] = if TF_NewLeaf?[Sp3] = 1  then - TF_FruitsperBunch[Sp3,Anthesis_4] + TF_FruitsperBunch[Sp3,Anthesis_5] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Anthesis_4]
    # TF_FruitNoPassOn[Sp3,Anthesis_5] = if TF_NewLeaf?[Sp3] =1 then - TF_FruitsperBunch[Sp3,Anthesis_5] + TF_FruitsperBunch[Sp3,Anthesis_6] else 0*TF_InitFruitspBunch[Sp3]*TF_BunchGender[Sp3,Anthesis_5]
    # TF_FruitNoPassOn[Sp3,Anthesis_6] = if TF_NewLeaf?[Sp3] = 1 then  -TF_FruitsperBunch[Sp3,Anthesis_6] + TF_InitFruitspBunch[Sp3]*(TF_BunchGender[Sp3,Anthesis_6]-1) else 0
    treefruit_df$TF_FruitsperBunch_up <- NA
    treefruit_df[treefruit_df$Fruitbunch != "Anthesis_6", "TF_FruitsperBunch_up"] <- treefruit_df[treefruit_df$Fruitbunch != "Ripe", "TF_FruitsperBunch"]
    treefruit_df[treefruit_df$Fruitbunch == "Anthesis_6", "TF_FruitsperBunch_up"] <- tree_df$TF_InitFruitspBunch *
      (treefruit_df[treefruit_df$Fruitbunch == "Anthesis_6", "TF_BunchGender"] - 1)
    treefruit_df$TF_FruitNoPassOn <- ifelse(
      treefruit_df$TF_NewLeaf_is == 1,
      -treefruit_df$TF_FruitsperBunch + treefruit_df$TF_FruitsperBunch_up,
      0
    )
    
    # T_WoodHarvEvent[Tree] = if time = int(T_WoodHarvDay[Tree]) then +1 else if time > T_WoodHarvDay[Tree] +1 then +1 else 0
    tree_df$T_WoodHarvEvent <- ifelse(
      time == floor(tree_df$T_WoodHarvDay),
      1,
      ifelse(time > tree_df$T_WoodHarvDay + 1, 1, 0)
    )
    
    # S&B_FirIndPmobiliz[Zone] = GRAPH(S&B_FireTempIncTopSoil[Zone])
    zone_df$SB_FirIndPmobiliz <- get_y_df(zone_df$SB_FireTempIncTopSoil, "SB_FirIndPmobiliz")
    
    # N_NutMobil1[Zone,SlNut] = N_ImmobileNut1[Zone,SlNut]*min(1,(1-(1/(1+N_CNutMob[Zone,SlNut]* N_CRhizVol1[Zone]+ RT_TRhizVol1[Zone,Sp1]*T_NutMob[Sp1,SlNut]+RT_TRhizVol1[Zone,Sp2]*T_NutMob[Sp2,SlNut]+RT_TRhizVol1[Zone,Sp3]*T_NutMob[Sp3,SlNut] ))+N_Nutmob1[SlNut]+S&B_FirIndPmobiliz[Zone]))
    # N_NutMobil2[Zone,SlNut] = N_ImmobileNut2[Zone,SlNut]*min(1,(1-(1/(1+N_CNutMob[Zone,SlNut]* N_CRhizVol2[Zone]+ RT_TRhizVol2[Zone,Sp1]*T_NutMob[Sp1,SlNut]+RT_TRhizVol2[Zone,Sp2]*T_NutMob[Sp2,SlNut]+RT_TRhizVol2[Zone,Sp3]*T_NutMob[Sp3,SlNut] ))+N_Nutmob2[SlNut]))
    # N_NutMobil3[Zone,SlNut] = N_ImmobileNut3[Zone,SlNut]*min(1,(1-(1/(1+N_CNutMob[Zone,SlNut]* N_CRhizVol3[Zone]+ RT_TRhizVol3[Zone,Sp1]*T_NutMob[Sp1,SlNut]+RT_TRhizVol3[Zone,Sp2]*T_NutMob[Sp2,SlNut]+RT_TRhizVol3[Zone,Sp3]*T_NutMob[Sp3,SlNut] ))+N_Nutmob3[SlNut]))
    # N_NutMobil4[Zone,SlNut] = N_ImmobileNut4[Zone,SlNut]*min(1,(1-(1/(1+N_CNutMob[Zone,SlNut]* N_CRhizVol4[Zone]+ RT_TRhizVol4[Zone,Sp1]*T_NutMob[Sp1,SlNut]+RT_TRhizVol4[Zone,Sp2]*T_NutMob[Sp2,SlNut]+RT_TRhizVol4[Zone,Sp3]*T_NutMob[Sp3,SlNut] ))+N_Nutmob4[SlNut]))
    zonelayernut_df$N_CNutMob <- c(rep(zonenut_df[zonenut_df$SlNut == "N", "N_CNutMob"], nlayer),
                                   rep(zonenut_df[zonenut_df$SlNut == "P", "N_CNutMob"], nlayer))
    zonelayernut_df$N_CRhizVol <- rep(zonelayer_df$N_CRhizVol, nrow(nut_df))
    zonelayernut_df$N_Nutmob <- rep(layernut_df$N_Nutmob, each = nzone)
    
    zonelayertreenut_df$RT_TRhizVol_Nut <- rep(zonelayertree_df$RT_TRhizVol, nrow(nut_df)) * rep(treenut_df$T_NutMob, each = nzone * nlayer)
    zonelayernut_df$RT_TRhizVol_Nut_sum <- aggregate(zonelayertreenut_df["RT_TRhizVol_Nut"], zonelayertreenut_df[c("zone", "layer", "SlNut")], sum)$RT_TRhizVol_Nut
    zonelayernut_df$N_NutMobil_a <- 1 - (
      1 / (
        1 + zonelayernut_df$N_CNutMob * zonelayernut_df$N_CRhizVol + zonelayernut_df$RT_TRhizVol_Nut_sum
      )
    ) + zonelayernut_df$N_Nutmob
    zonelayernut_df[zonelayernut_df$layer == 1, "N_NutMobil_a"] <- zonelayernut_df[zonelayernut_df$layer == 1, "N_NutMobil_a"] + rep(zone_df$SB_FirIndPmobiliz, nrow(nut_df))
    zonelayernut_df$N_NutMobil <-  zonelayernut_df$N_ImmobileNut * pmin(1, zonelayernut_df$N_NutMobil_a)
    
    # N_LatOutFlow11[Zn1,N] = N_HLeach1[Zn1,N]
    # N_LatOutFlow11[Zn1,P] = N_HLeach1[Zn1,P]
    # N_LatOutFlow11[Zn2,N] = 0*N_HLeach1[Zn1,N]
    # N_LatOutFlow11[Zn2,P] = 0*N_HLeach1[Zn1,N]
    # N_LatOutFlow11[Zn3,N] = 0*N_HLeach1[Zn1,N]
    # N_LatOutFlow11[Zn3,P] = 0*N_HLeach1[Zn1,N]
    # N_LatOutFlow11[Zn4,N] = 0*N_HLeach1[Zn1,N]
    # N_LatOutFlow11[Zn4,P] = 0*N_HLeach1[Zn1,N]
    # N_LatOutFlow21[Zn1,N] = N_HLeach2[Zn1,N]
    # N_LatOutFlow21[Zn1,P] = N_HLeach2[Zn1,P]
    # N_LatOutFlow21[Zn2,N] = 0*N_HLeach2[Zn4,P]
    # N_LatOutFlow21[Zn2,P] = 0*N_HLeach2[Zn4,P]
    # N_LatOutFlow21[Zn3,N] = 0*N_HLeach2[Zn4,P]
    # N_LatOutFlow21[Zn3,P] = 0*N_HLeach2[Zn4,P]
    # N_LatOutFlow21[Zn4,N] = 0*N_HLeach2[Zn4,P]
    # N_LatOutFlow21[Zn4,P] = 0*N_HLeach2[Zn4,P]
    # N_LatOutFlow31[Zn1,N] = N_HLeach3[Zn1,N]
    # N_LatOutFlow31[Zn1,P] = N_HLeach3[Zn1,P]
    # N_LatOutFlow31[Zn2,N] = 0*N_HLeach3[Zn4,P]
    # N_LatOutFlow31[Zn2,P] = 0*N_HLeach3[Zn4,P]
    # N_LatOutFlow31[Zn3,N] = 0*N_HLeach3[Zn4,P]
    # N_LatOutFlow31[Zn3,P] = 0*N_HLeach3[Zn4,P]
    # N_LatOutFlow31[Zn4,N] = 0*N_HLeach3[Zn4,P]
    # N_LatOutFlow31[Zn4,P] = 0*N_HLeach3[Zn4,P]
    # N_LatOutFlow41[Zn1,N] = N_HLeach4[Zn1,N]
    # N_LatOutFlow41[Zn1,P] = N_HLeach4[Zn1,P]
    # N_LatOutFlow41[Zn2,N] = 0*N_HLeach4[Zn4,P]
    # N_LatOutFlow41[Zn2,P] = 0*N_HLeach4[Zn4,P]
    # N_LatOutFlow41[Zn3,N] = 0*N_HLeach4[Zn4,P]
    # N_LatOutFlow41[Zn3,P] = 0*N_HLeach4[Zn4,P]
    # N_LatOutFlow41[Zn4,N] = 0*N_HLeach4[Zn4,P]
    # N_LatOutFlow41[Zn4,P] = 0*N_HLeach4[Zn4,P]
    
    zonelayernut_df$N_LatOutFlow_1 <- zonelayernut_df$N_HLeach
    zonelayernut_df[zonelayernut_df$zone != 1, ]$N_LatOutFlow_1 <- 0
    
    # N_LeachOutx4[Zone,SlNut] = N_VLeach4[Zone,SlNut]
    zonenut_df$N_LeachOutx4 <- zonelayernut_df[zonelayernut_df$layer == 4, "N_VLeach"]
    
    # S&B_BurntWood[Zone,PlantComp] = S&B_DW?[PlantComp]*S&B_DeadWood[Zone,PlantComp]*S&B_DeadWoodBurnFrac[Zone]*(1-S&B_AerosolFrac[Zone])
    zonepcomp_df$SB_BurntWood <- zonepcomp_df$SB_DW_is * zonepcomp_df$SB_DeadWood * zonepcomp_df$SB_DeadWoodBurnFrac *
      (1 - zonepcomp_df$SB_AerosolFrac)
    
    # S&B_Ash[Zone] = (S&B_NecromassBurn[Zone,DW]*S&B_LeafAshCont)+S&B_BurntWood[Zone,DW]*S&B_WoodAshCont
    zp_DW <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", c("SB_NecromassBurn", "SB_BurntWood")]
    zone_df$SB_Ash <- (zp_DW$SB_NecromassBurn * SB_LeafAshCont) + zp_DW$SB_BurntWood *
      SB_WoodAshCont
    
    # S&B_pH_change[Zone] = S&B_pHChangePerCationInput*S&B_Ash[Zone]/AF_DepthAct1[Zone] - S&B_pHRecFrac*(S&B_Topsoil_pH[Zone]-S&B_InitialpH)
    zone_df$SB_pH_change <- SB_pHChangePerCationInput * zone_df$SB_Ash /
      zonelayer_df[zonelayer_df$layer == 1, "AF_Depth"] - SB_pHRecFrac *
      (zone_df$SB_Topsoil_pH - SB_InitialpH)
    
    # RT3_CRdecay[Tree] = RT3_CoarseRtDecayCoeff[Tree]*RT3_CoarseRt[Tree]
    tree_df$RT3_CRdecay <- tree_df$RT3_CoarseRtDecayCoeff * tree_df$RT3_CoarseRt
    
    
    # C_WeedSeedInflux[Zone,PlantComp] = if AF_SimulateWeeds? = 1 then C_WeedSeedExtInflux*C_SeedConc[PlantComp]*C_UnitConv[PlantComp] else 0
    zonepcomp_df$AF_SimulateWeeds_is <- AF_SimulateWeeds_is
    zonepcomp_df$C_WeedSeedInflux <- ifelse(
      zonepcomp_df$AF_SimulateWeeds_is == 1,
      C_WeedSeedExtInflux * zonepcomp_df$C_SeedConc * zonepcomp_df$C_UnitConv,
      0
    )
    
    # C_WeedSeedFall[Zone,PlantComp] = if (int(CQ_Stage[Zone])) >= 2 and CQ_WeedZn?[Zone]=1 then C_YieldCurr[Zone,PlantComp]/dt else 0
    zonepcomp_df$CQ_Stage <- rep(zone_df$CQ_Stage, nrow(pcomp_df))
    zonepcomp_df$C_WeedSeedFall <- ifelse(
      floor(zonepcomp_df$CQ_Stage) >= 2 &
        zonepcomp_df$CQ_WeedZn_is == 1,
      zonepcomp_df$C_YieldCurr,
      0
    )
    
    # C_WeedGermin[Zone,PlantComp] = if CQ_WeedRestart?[Zone] = 1 then C_WeedGermFrac*C_WeedSeedBank[Zone,PlantComp] ELSE 0
    zonepcomp_df$CQ_WeedRestaRT_is <- rep(zone_df$CQ_WeedRestaRT_is, nrow(pcomp_df))
    zonepcomp_df$C_WeedGermin <- ifelse(
      zonepcomp_df$CQ_WeedRestaRT_is == 1,
      C_WeedGermFrac * zonepcomp_df$C_WeedSeedBank,
      0
    )
    
    # MN2_CNMetab[Zone,SoilLayer] = IF(MN2_Metab[Zone,SoilLayer]>0)THEN(MC2_Metab[Zone,SoilLayer]/MN2_Metab[Zone,SoilLayer])ELSE(0)
    zonelayer_df$MN2_CNMetab <- ifelse(zonelayer_df$MN2_Metab > 0,
                                       zonelayer_df$MC2_Metab / zonelayer_df$MN2_Metab,
                                       0)
    
    # MN2_DecActMet[Zone,SoilLayer] = IF(MN2_CNMetab[Zone,SoilLayer]>0)THEN(MC2_MetabActF[Zone,SoilLayer]/(MC_EffMetab*MN2_CNMetab[Zone,SoilLayer]))ELSE(0)
    zonelayer_df$MN2_DecActMet <- ifelse(
      zonelayer_df$MN2_CNMetab > 0,
      zonelayer_df$MC2_MetabActF / (MC_EffMetab * zonelayer_df$MN2_CNMetab),
      0
    )
    
    # MN2_DemActMet_N[Zone,SoilLayer] = MC2_MetabActF[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[N])
    zonelayer_df$MN2_DemActMet_N <- zonelayer_df$MC2_MetabActF / (MN_CNAct *
                                                                    MN_NutRatAct_N)
    
    # MN2_MetabActF[Zone,SoilLayer] = MIN(MN2_DecActMet[Zone,SoilLayer],MN2_DemActMet_N[Zone,SoilLayer])
    zonelayer_df$MN2_MetabActF <- pmin(zonelayer_df$MN2_DecActMet,
                                       zonelayer_df$MN2_DemActMet_N)
    
    
    # MN2_DemActSt[Zone,SoilLayer] = MC2_StrucActF[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[N])
    zonelayer_df$MN2_DemActSt <- zonelayer_df$MC2_StrucActF / (MN_CNAct *
                                                                 MN_NutRatAct_N)
    
    # MN2_DecActSt_N[Zone,SoilLayer] = MC2_StrucActF[Zone,SoilLayer]/(MC_EffStrucAct*MN_CNStruc*MN_NutRatStruc[N])
    zonelayer_df$MN2_DecActSt_N <- zonelayer_df$MC2_StrucActF / (MC_EffStrucAct *
                                                                   MN_CNStruc * nut_df[nut_df$SlNut == "N", "MN_NutRatStruc"])
    
    # MN2_StrucActF[Zone,SoilLayer] = MIN(MN2_DecActSt_N[Zone,SoilLayer],MN2_DemActSt[Zone,SoilLayer])
    zonelayer_df$MN2_StrucActF <- pmin(zonelayer_df$MN2_DecActSt_N, zonelayer_df$MN2_DemActSt)
    
    # MN2_Met_SomTrans[Zn1,1] = MN_Met_LitSomTrans[Zn1,N]- MN2_Metab[Zn1,1]*MC2_Met_LayerTrans[Zn1,1]
    # MN2_Met_SomTrans[Zn1,2] = 0*MN_Met_LitSomTrans[Zn1,N]+ MN2_Metab[Zn1,1]*MC2_Met_LayerTrans[Zn1,1]- MN2_Metab[Zn1,2]*MC2_Met_LayerTrans[Zn1,2]
    # MN2_Met_SomTrans[Zn1,3] = 0*MN_Met_LitSomTrans[Zn1,N]+ MN2_Metab[Zn1,2]*MC2_Met_LayerTrans[Zn1,2]- MN2_Metab[Zn1,3]*MC2_Met_LayerTrans[Zn1,3]
    # MN2_Met_SomTrans[Zn1,4] = 0*MN_Met_LitSomTrans[Zn1,N]+ MN2_Metab[Zn1,3]*MC2_Met_LayerTrans[Zn1,3]- MN2_Metab[Zn1,4]*MC2_Met_LayerTrans[Zn1,4]
    # MN2_Met_SomTrans[Zn2,1] = MN_Met_LitSomTrans[Zn2,N]- MN2_Metab[Zn2,1]*MC2_Met_LayerTrans[Zn2,1]
    # MN2_Met_SomTrans[Zn2,2] = 0*MN_Met_LitSomTrans[Zn2,N]+ MN2_Metab[Zn2,1]*MC2_Met_LayerTrans[Zn2,1]- MN2_Metab[Zn2,2]*MC2_Met_LayerTrans[Zn2,2]
    # MN2_Met_SomTrans[Zn2,3] = 0*MN_Met_LitSomTrans[Zn2,N]+ MN2_Metab[Zn2,2]*MC2_Met_LayerTrans[Zn2,2]- MN2_Metab[Zn2,3]*MC2_Met_LayerTrans[Zn2,3]
    # MN2_Met_SomTrans[Zn2,4] = 0*MN_Met_LitSomTrans[Zn2,N]+ MN2_Metab[Zn2,3]*MC2_Met_LayerTrans[Zn2,3]- MN2_Metab[Zn2,4]*MC2_Met_LayerTrans[Zn2,4]
    # MN2_Met_SomTrans[Zn3,1] = MN_Met_LitSomTrans[Zn3,N]- MN2_Metab[Zn3,1]*MC2_Met_LayerTrans[Zn3,1]
    # MN2_Met_SomTrans[Zn3,2] = 0*MN_Met_LitSomTrans[Zn3,N]+ MN2_Metab[Zn3,1]*MC2_Met_LayerTrans[Zn3,1]- MN2_Metab[Zn3,2]*MC2_Met_LayerTrans[Zn3,2]
    # MN2_Met_SomTrans[Zn3,3] = 0*MN_Met_LitSomTrans[Zn3,N]+ MN2_Metab[Zn3,2]*MC2_Met_LayerTrans[Zn3,2]- MN2_Metab[Zn3,3]*MC2_Met_LayerTrans[Zn3,3]
    # MN2_Met_SomTrans[Zn3,4] = 0*MN_Met_LitSomTrans[Zn3,N]+ MN2_Metab[Zn3,3]*MC2_Met_LayerTrans[Zn3,3]- MN2_Metab[Zn3,4]*MC2_Met_LayerTrans[Zn3,4]
    # MN2_Met_SomTrans[Zn4,1] = MN_Met_LitSomTrans[Zn4,N]- MN2_Metab[Zn4,1]*MC2_Met_LayerTrans[Zn4,1]
    # MN2_Met_SomTrans[Zn4,2] = 0*MN_Met_LitSomTrans[Zn4,N]+ MN2_Metab[Zn4,1]*MC2_Met_LayerTrans[Zn4,1]- MN2_Metab[Zn4,2]*MC2_Met_LayerTrans[Zn4,2]
    # MN2_Met_SomTrans[Zn4,3] = 0*MN_Met_LitSomTrans[Zn4,N]+ MN2_Metab[Zn4,2]*MC2_Met_LayerTrans[Zn4,2]- MN2_Metab[Zn4,3]*MC2_Met_LayerTrans[Zn4,3]
    # MN2_Met_SomTrans[Zn4,4] = 0*MN_Met_LitSomTrans[Zn4,N]+ MN2_Metab[Zn4,3]*MC2_Met_LayerTrans[Zn4,3]- MN2_Metab[Zn4,4]*MC2_Met_LayerTrans[Zn4,4]
    #
    # MN2_Struc_SomTrans[Zn1,1] = MN_Str_LitSomTrans[Zn1,N]- MN2_Struc[Zn1,1]*MC2_Struc_LayerTrans[Zn1,1]
    # MN2_Struc_SomTrans[Zn1,2] = 0*MN_Str_LitSomTrans[Zn1,N]+ MN2_Struc[Zn1,1]*MC2_Struc_LayerTrans[Zn1,1]- MN2_Struc[Zn1,2]*MC2_Struc_LayerTrans[Zn1,2]
    # MN2_Struc_SomTrans[Zn1,3] = 0*MN_Str_LitSomTrans[Zn1,N]+ MN2_Struc[Zn1,2]*MC2_Struc_LayerTrans[Zn1,2]- MN2_Struc[Zn1,3]*MC2_Struc_LayerTrans[Zn1,3]
    # MN2_Struc_SomTrans[Zn1,4] = 0*MN_Str_LitSomTrans[Zn1,N]+ MN2_Struc[Zn1,3]*MC2_Struc_LayerTrans[Zn1,3]- MN2_Struc[Zn1,4]*MC2_Struc_LayerTrans[Zn1,4]
    # MN2_Struc_SomTrans[Zn2,1] = MN_Str_LitSomTrans[Zn2,N]- MN2_Struc[Zn2,1]*MC2_Struc_LayerTrans[Zn2,1]
    # MN2_Struc_SomTrans[Zn2,2] = 0*MN_Str_LitSomTrans[Zn2,N]+ MN2_Struc[Zn2,1]*MC2_Struc_LayerTrans[Zn2,1]- MN2_Struc[Zn2,2]*MC2_Struc_LayerTrans[Zn2,2]
    # MN2_Struc_SomTrans[Zn2,3] = 0*MN_Str_LitSomTrans[Zn2,N]+ MN2_Struc[Zn2,2]*MC2_Struc_LayerTrans[Zn2,2]- MN2_Struc[Zn2,3]*MC2_Struc_LayerTrans[Zn2,3]
    # MN2_Struc_SomTrans[Zn2,4] = 0*MN_Str_LitSomTrans[Zn2,N]+ MN2_Struc[Zn2,3]*MC2_Struc_LayerTrans[Zn2,3]- MN2_Struc[Zn2,4]*MC2_Struc_LayerTrans[Zn2,4]
    # MN2_Struc_SomTrans[Zn3,1] = MN_Str_LitSomTrans[Zn3,N]- MN2_Struc[Zn3,1]*MC2_Struc_LayerTrans[Zn3,1]
    # MN2_Struc_SomTrans[Zn3,2] = 0*MN_Str_LitSomTrans[Zn3,N]+ MN2_Struc[Zn3,1]*MC2_Struc_LayerTrans[Zn3,1]- MN2_Struc[Zn3,2]*MC2_Struc_LayerTrans[Zn3,2]
    # MN2_Struc_SomTrans[Zn3,3] = 0*MN_Str_LitSomTrans[Zn3,N]+ MN2_Struc[Zn3,2]*MC2_Struc_LayerTrans[Zn3,2]- MN2_Struc[Zn3,3]*MC2_Struc_LayerTrans[Zn3,3]
    # MN2_Struc_SomTrans[Zn3,4] = 0*MN_Str_LitSomTrans[Zn3,N]+ MN2_Struc[Zn3,3]*MC2_Struc_LayerTrans[Zn3,3]- MN2_Struc[Zn3,4]*MC2_Struc_LayerTrans[Zn3,4]
    # MN2_Struc_SomTrans[Zn4,1] = MN_Str_LitSomTrans[Zn4,N]- MN2_Struc[Zn4,1]*MC2_Struc_LayerTrans[Zn4,1]
    # MN2_Struc_SomTrans[Zn4,2] = 0*MN_Str_LitSomTrans[Zn4,N]+ MN2_Struc[Zn4,1]*MC2_Struc_LayerTrans[Zn4,1]- MN2_Struc[Zn4,2]*MC2_Struc_LayerTrans[Zn4,2]
    # MN2_Struc_SomTrans[Zn4,3] = 0*MN_Str_LitSomTrans[Zn4,N]+ MN2_Struc[Zn4,2]*MC2_Struc_LayerTrans[Zn4,2]- MN2_Struc[Zn4,3]*MC2_Struc_LayerTrans[Zn4,3]
    # MN2_Struc_SomTrans[Zn4,4] = 0*MN_Str_LitSomTrans[Zn4,N]+ MN2_Struc[Zn4,3]*MC2_Struc_LayerTrans[Zn4,3]- MN2_Struc[Zn4,4]*MC2_Struc_LayerTrans[Zn4,4]
    #
    # MN2_Act_SomTrans[Zn1,1] = MN_Act_LitSomTrans[Zn1,N]                                            - MN2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1]
    # MN2_Act_SomTrans[Zn1,2] = 0*MN_Act_LitSomTrans[Zn1,N]+ MN2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1]- MN2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2]
    # MN2_Act_SomTrans[Zn1,3] = 0*MN_Act_LitSomTrans[Zn1,N]+ MN2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2]- MN2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3]
    # MN2_Act_SomTrans[Zn1,4] = 0*MN_Act_LitSomTrans[Zn1,N]+ MN2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3]- MN2_Act[Zn1,4]*MC2_Act_LayerTrans[Zn1,4]
    # MN2_Act_SomTrans[Zn2,1] = MN_Act_LitSomTrans[Zn2,N]                                            - MN2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1]
    # MN2_Act_SomTrans[Zn2,2] = 0*MN_Act_LitSomTrans[Zn2,N]+ MN2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1]- MN2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2]
    # MN2_Act_SomTrans[Zn2,3] = 0*MN_Act_LitSomTrans[Zn2,N]+ MN2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2]- MN2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3]
    # MN2_Act_SomTrans[Zn2,4] = 0*MN_Act_LitSomTrans[Zn2,N]+ MN2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3]- MN2_Act[Zn2,4]*MC2_Act_LayerTrans[Zn2,4]
    # MN2_Act_SomTrans[Zn3,1] = MN_Act_LitSomTrans[Zn3,N]                                            - MN2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1]
    # MN2_Act_SomTrans[Zn3,2] = 0*MN_Act_LitSomTrans[Zn3,N]+ MN2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1]- MN2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2]
    # MN2_Act_SomTrans[Zn3,3] = 0*MN_Act_LitSomTrans[Zn3,N]+ MN2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2]- MN2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3]
    # MN2_Act_SomTrans[Zn3,4] = 0*MN_Act_LitSomTrans[Zn3,N]+ MN2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3]- MN2_Act[Zn3,4]*MC2_Act_LayerTrans[Zn3,4]
    # MN2_Act_SomTrans[Zn4,1] = MN_Act_LitSomTrans[Zn4,N]                                            - MN2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1]
    # MN2_Act_SomTrans[Zn4,2] = 0*MN_Act_LitSomTrans[Zn4,N]+ MN2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1]- MN2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2]
    # MN2_Act_SomTrans[Zn4,3] = 0*MN_Act_LitSomTrans[Zn4,N]+ MN2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2]- MN2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3]
    # MN2_Act_SomTrans[Zn4,4] = 0*MN_Act_LitSomTrans[Zn4,N]+ MN2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3]- MN2_Act[Zn4,4]*MC2_Act_LayerTrans[Zn4,4]
    #
    # MN2_Slw_SomTrans[Zn1,1] = MN_Slw_LitSomTrans[Zn1,N]- MN2_Slw[Zn1,1]*MC2_Slow_LayerTrans[Zn1,1]
    # MN2_Slw_SomTrans[Zn1,2] = 0*MN_Slw_LitSomTrans[Zn1,N]+ MN2_Slw[Zn1,1]*MC2_Slow_LayerTrans[Zn1,1]- MN2_Slw[Zn1,2]*MC2_Slow_LayerTrans[Zn1,2]
    # MN2_Slw_SomTrans[Zn1,3] = 0*MN_Slw_LitSomTrans[Zn1,N]+ MN2_Slw[Zn1,2]*MC2_Slow_LayerTrans[Zn1,2]- MN2_Slw[Zn1,3]*MC2_Slow_LayerTrans[Zn1,3]
    # MN2_Slw_SomTrans[Zn1,4] = 0*MN_Slw_LitSomTrans[Zn1,N]+ MN2_Slw[Zn1,3]*MC2_Slow_LayerTrans[Zn1,3]- MN2_Slw[Zn1,4]*MC2_Slow_LayerTrans[Zn1,4]
    # MN2_Slw_SomTrans[Zn2,1] = MN_Slw_LitSomTrans[Zn2,N]- MN2_Slw[Zn2,1]*MC2_Slow_LayerTrans[Zn2,1]
    # MN2_Slw_SomTrans[Zn2,2] = 0*MN_Slw_LitSomTrans[Zn2,N]+ MN2_Slw[Zn2,1]*MC2_Slow_LayerTrans[Zn2,1]- MN2_Slw[Zn2,2]*MC2_Slow_LayerTrans[Zn2,2]
    # MN2_Slw_SomTrans[Zn2,3] = 0*MN_Slw_LitSomTrans[Zn2,N]+ MN2_Slw[Zn2,2]*MC2_Slow_LayerTrans[Zn2,2]- MN2_Slw[Zn2,3]*MC2_Slow_LayerTrans[Zn2,3]
    # MN2_Slw_SomTrans[Zn2,4] = 0*MN_Slw_LitSomTrans[Zn2,N]+ MN2_Slw[Zn2,3]*MC2_Slow_LayerTrans[Zn2,3]- MN2_Slw[Zn2,4]*MC2_Slow_LayerTrans[Zn2,4]
    # MN2_Slw_SomTrans[Zn3,1] = MN_Slw_LitSomTrans[Zn3,N]- MN2_Slw[Zn3,1]*MC2_Slow_LayerTrans[Zn3,1]
    # MN2_Slw_SomTrans[Zn3,2] = 0*MN_Slw_LitSomTrans[Zn3,N]+ MN2_Slw[Zn3,1]*MC2_Slow_LayerTrans[Zn3,1]- MN2_Slw[Zn3,2]*MC2_Slow_LayerTrans[Zn3,2]
    # MN2_Slw_SomTrans[Zn3,3] = 0*MN_Slw_LitSomTrans[Zn3,N]+ MN2_Slw[Zn3,2]*MC2_Slow_LayerTrans[Zn3,2]- MN2_Slw[Zn3,3]*MC2_Slow_LayerTrans[Zn3,3]
    # MN2_Slw_SomTrans[Zn3,4] = 0*MN_Slw_LitSomTrans[Zn3,N]+ MN2_Slw[Zn3,3]*MC2_Slow_LayerTrans[Zn3,3]- MN2_Slw[Zn3,4]*MC2_Slow_LayerTrans[Zn3,4]
    # MN2_Slw_SomTrans[Zn4,1] = MN_Slw_LitSomTrans[Zn4,N]- MN2_Slw[Zn4,1]*MC2_Slow_LayerTrans[Zn4,1]
    # MN2_Slw_SomTrans[Zn4,2] = 0*MN_Slw_LitSomTrans[Zn4,N]+ MN2_Slw[Zn4,1]*MC2_Slow_LayerTrans[Zn4,1]- MN2_Slw[Zn4,2]*MC2_Slow_LayerTrans[Zn4,2]
    # MN2_Slw_SomTrans[Zn4,3] = 0*MN_Slw_LitSomTrans[Zn4,N]+ MN2_Slw[Zn4,2]*MC2_Slow_LayerTrans[Zn4,2]- MN2_Slw[Zn4,3]*MC2_Slow_LayerTrans[Zn4,3]
    # MN2_Slw_SomTrans[Zn4,4] = 0*MN_Slw_LitSomTrans[Zn4,N]+ MN2_Slw[Zn4,3]*MC2_Slow_LayerTrans[Zn4,3]- MN2_Slw[Zn4,4]*MC2_Slow_LayerTrans[Zn4,4]
    #
    # MN2_Pas_SomTrans[Zn1,1] = MN_Pas_LitSomTrans[Zn1,N]- MN2_Pass[Zn1,1]*MC2_Pass_LayerTrans[Zn1,1]
    # MN2_Pas_SomTrans[Zn1,2] = 0*MN_Pas_LitSomTrans[Zn1,N]+ MN2_Pass[Zn1,1]*MC2_Pass_LayerTrans[Zn1,1]- MN2_Pass[Zn1,2]*MC2_Pass_LayerTrans[Zn1,2]
    # MN2_Pas_SomTrans[Zn1,3] = 0*MN_Pas_LitSomTrans[Zn1,N]+ MN2_Pass[Zn1,2]*MC2_Pass_LayerTrans[Zn1,2]- MN2_Pass[Zn1,3]*MC2_Pass_LayerTrans[Zn1,3]
    # MN2_Pas_SomTrans[Zn1,4] = 0*MN_Pas_LitSomTrans[Zn1,N]+ MN2_Pass[Zn1,3]*MC2_Pass_LayerTrans[Zn1,3]- MN2_Pass[Zn1,4]*MC2_Pass_LayerTrans[Zn1,4]
    # MN2_Pas_SomTrans[Zn2,1] = MN_Pas_LitSomTrans[Zn2,N]- MN2_Pass[Zn2,1]*MC2_Pass_LayerTrans[Zn2,1]
    # MN2_Pas_SomTrans[Zn2,2] = 0*MN_Pas_LitSomTrans[Zn2,N]+ MN2_Pass[Zn2,1]*MC2_Pass_LayerTrans[Zn2,1]- MN2_Pass[Zn2,2]*MC2_Pass_LayerTrans[Zn2,2]
    # MN2_Pas_SomTrans[Zn2,3] = 0*MN_Pas_LitSomTrans[Zn2,N]+ MN2_Pass[Zn2,2]*MC2_Pass_LayerTrans[Zn2,2]- MN2_Pass[Zn2,3]*MC2_Pass_LayerTrans[Zn2,3]
    # MN2_Pas_SomTrans[Zn2,4] = 0*MN_Pas_LitSomTrans[Zn2,N]+ MN2_Pass[Zn2,3]*MC2_Pass_LayerTrans[Zn2,3]- MN2_Pass[Zn2,4]*MC2_Pass_LayerTrans[Zn2,4]
    # MN2_Pas_SomTrans[Zn3,1] = MN_Pas_LitSomTrans[Zn3,N]- MN2_Pass[Zn3,1]*MC2_Pass_LayerTrans[Zn3,1]
    # MN2_Pas_SomTrans[Zn3,2] = 0*MN_Pas_LitSomTrans[Zn3,N]+ MN2_Pass[Zn3,1]*MC2_Pass_LayerTrans[Zn3,1]- MN2_Pass[Zn3,2]*MC2_Pass_LayerTrans[Zn3,2]
    # MN2_Pas_SomTrans[Zn3,3] = 0*MN_Pas_LitSomTrans[Zn3,N]+ MN2_Pass[Zn3,2]*MC2_Pass_LayerTrans[Zn3,2]- MN2_Pass[Zn3,3]*MC2_Pass_LayerTrans[Zn3,3]
    # MN2_Pas_SomTrans[Zn3,4] = 0*MN_Pas_LitSomTrans[Zn3,N]+ MN2_Pass[Zn3,3]*MC2_Pass_LayerTrans[Zn3,3]- MN2_Pass[Zn3,4]*MC2_Pass_LayerTrans[Zn3,4]
    # MN2_Pas_SomTrans[Zn4,1] = MN_Pas_LitSomTrans[Zn4,N]- MN2_Pass[Zn4,1]*MC2_Pass_LayerTrans[Zn4,1]
    # MN2_Pas_SomTrans[Zn4,2] = 0*MN_Pas_LitSomTrans[Zn4,N]+ MN2_Pass[Zn4,1]*MC2_Pass_LayerTrans[Zn4,1]- MN2_Pass[Zn4,2]*MC2_Pass_LayerTrans[Zn4,2]
    # MN2_Pas_SomTrans[Zn4,3] = 0*MN_Pas_LitSomTrans[Zn4,N]+ MN2_Pass[Zn4,2]*MC2_Pass_LayerTrans[Zn4,2]- MN2_Pass[Zn4,3]*MC2_Pass_LayerTrans[Zn4,3]
    # MN2_Pas_SomTrans[Zn4,4] = 0*MN_Pas_LitSomTrans[Zn4,N]+ MN2_Pass[Zn4,3]*MC2_Pass_LayerTrans[Zn4,3]- MN2_Pass[Zn4,4]*MC2_Pass_LayerTrans[Zn4,4]
    
    zonelayercpools_df$MN2_cpools <- c(
      zonelayer_df$MN2_Metab,
      zonelayer_df$MN2_Struc,
      zonelayer_df$MN2_Act,
      zonelayer_df$MN2_Slw,
      zonelayer_df$MN2_Pass
    )
    zonelayercpools_df$MN2_cpools_Layer <- zonelayercpools_df$MN2_cpools * zonelayercpools_df$MC2_LayerTrans
    zn_N <- zonenut_df[zonenut_df$SlNut == "N", ]
    zonecpools_df$MN_LitSomTrans_N <- c(
      zn_N$MN_Met_LitSomTrans,
      zn_N$MN_Str_LitSomTrans,
      zn_N$MN_Act_LitSomTrans,
      zn_N$MN_Slw_LitSomTrans,
      zn_N$MN_Pas_LitSomTrans
    )
    
    zonelayercpools_df$MN2_SomTrans <- NA
    zonelayercpools_df[zonelayercpools_df$layer == 1, "MN2_SomTrans"] <- zonecpools_df$MN_LitSomTrans_N - zonelayercpools_df[zonelayer_df$layer == 1, "MN2_cpools_Layer"]
    zonelayercpools_df[zonelayercpools_df$layer %in% c(2:4), "MN2_SomTrans"] <- zonelayercpools_df[zonelayercpools_df$layer %in% c(1:3), "MN2_cpools_Layer"] - zonelayercpools_df[zonelayercpools_df$layer %in% c(2:4), "MN2_cpools_Layer"]
    
    # MN2_DecAct[Zone,SoilLayer] = MC2_ActSlw[Zone,SoilLayer]/(MC2_EffActSlw*MN2_CNActAct_N[Zone,SoilLayer])
    zonelayer_df$MN2_DecAct <- zonelayer_df$MC2_ActSlw / (MC2_EffActSlw *
                                                            zonelayer_df$MN2_CNActAct_N)
    
    # MN2_ActSlw[Zone,SoilLayer] = MC2_ActSlw[Zone,SoilLayer]/(MN_CNSlw*MN_NutRatSlw[N])
    zonelayer_df$MN2_ActSlw <- zonelayer_df$MC2_ActSlw / (MN_CNSlw * nut_df[nut_df$SlNut == "N", "MN_NutRatSlw"])
    
    # MN2_ActPass[Zone,SoilLayer] = MC2_ActPass[Zone,SoilLayer]/(MN_CNPass*MN_NutRatPas[N])
    zonelayer_df$MN2_ActPass <- zonelayer_df$MC2_ActPass / (MN_CNPass * nut_df[nut_df$SlNut == "N", "MN_NutRatPas"])
    
    # MN2_ActMin[Zone,SoilLayer] = MIN(MAX(0,MN2_DecAct[Zone,SoilLayer]-MN2_ActSlw[Zone,SoilLayer]-MN2_ActPass[Zone,SoilLayer]),MN2_Act[Zone,SoilLayer])
    zonelayer_df$MN2_ActMin <- pmin(
      pmax(
        0,
        zonelayer_df$MN2_DecAct - zonelayer_df$MN2_ActSlw - zonelayer_df$MN2_ActPass
      ),
      zonelayer_df$MN2_Act
    )
    
    # MN2_ImmobAct[Zone,SoilLayer] = MIN(MN_MinNutpool[Zone,N], MAX(0,MN2_DemActMet_N[Zone,SoilLayer]-MN2_DecActMet[Zone,SoilLayer])+MAX(0,MN2_DemActSt[Zone,SoilLayer]-MN2_DecActSt_N[Zone,SoilLayer])+MAX(0,MN2_Act[Zone,SoilLayer]*MN2_CNActAct_N[Zone,SoilLayer]*(1/(MN_CNAct*MN_NutRatAct[N]) - 1/MN2_CNActAct_N[Zone,SoilLayer]) ))
    zonelayer_df$MN_MinNutpool_N <- rep(zonenut_df[zonenut_df$SlNut == "N", "MN_MinNutpool"], nlayer)
    zonelayer_df$MN2_ImmobAct <- pmin(
      zonelayer_df$MN_MinNutpool_N,
      pmax(
        0,
        zonelayer_df$MN2_DemActMet_N -
          zonelayer_df$MN2_DecActMet
      ) +
        pmax(
          0,
          zonelayer_df$MN2_DemActSt - zonelayer_df$MN2_DecActSt_N
        ) +
        pmax(
          0,
          zonelayer_df$MN2_Act * zonelayer_df$MN2_CNActAct_N * (
            1 / (MN_CNAct * nut_df[nut_df$SlNut == "N", "MN_NutRatAct"]) - 1 /
              zonelayer_df$MN2_CNActAct_N
          )
        )
    )
    
    # MN2_ActMinF[Zone,SoilLayer] = IF (MN2_ActMin[Zone,SoilLayer]-MN2_ImmobAct[Zone,SoilLayer]+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Act[Zone,SoilLayer])>0
    # THEN MIN((MN2_ActMin[Zone,SoilLayer]+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Act[Zone,SoilLayer]-MN2_ImmobAct[Zone,SoilLayer]),MN2_Act[Zone,SoilLayer])
    # ELSE IF (MN2_ActMin[Zone,SoilLayer]-MN2_ImmobAct[Zone,SoilLayer]+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Act[Zone,SoilLayer])=0
    # THEN 0 ELSE -MIN(ABS(MN2_ActMin[Zone,SoilLayer]-MN2_ImmobAct[Zone,SoilLayer] +MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Act[Zone,SoilLayer]),MN2_MinNutpool[Zone,SoilLayer])
    zonelayer_df$MN2_ActMinF_a <- zonelayer_df$MN2_ActMin - zonelayer_df$MN2_ImmobAct + zonelayer_df$MN2_MinDueToSB * zonelayer_df$MN2_Act
    zonelayer_df$MN2_ActMinF <- ifelse(
      zonelayer_df$MN2_ActMinF_a > 0,
      pmin(zonelayer_df$MN2_ActMinF_a, zonelayer_df$MN2_Act),
      ifelse(
        zonelayer_df$MN2_ActMinF_a == 0,
        0,
        -pmin(
          abs(zonelayer_df$MN2_ActMinF_a),
          zonelayer_df$MN2_MinNutpool
        )
      )
    )
    
    # MN2_SlwAct[Zone,SoilLayer] = MC2_SlwAct[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[N])
    zonelayer_df$MN2_SlwAct <- zonelayer_df$MC2_SlwAct / (MN_CNAct * nut_df[nut_df$SlNut == "N", "MN_NutRatAct"])
    
    # MN2_ActSlwF[Zone,SoilLayer] = MAX(0,MN2_ActSlw[Zone,SoilLayer])-MAX(0,MN2_SlwAct[Zone,SoilLayer])
    zonelayer_df$MN2_ActSlwF <- pmax(0, zonelayer_df$MN2_ActSlw) - pmax(0, zonelayer_df$MN2_SlwAct)
    
    # MN2_PassAct[Zone,SoilLayer] = MC2_PassAct[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[N])
    zonelayer_df$MN2_PassAct <- zonelayer_df$MC2_PassAct / (MN_CNAct * nut_df[nut_df$SlNut == "N", "MN_NutRatAct"])
    
    # MN2_ActPassF[Zone,SoilLayer] = MAX(0,MN2_ActPass[Zone,SoilLayer])-MAX(0,MN2_PassAct[Zone,SoilLayer])
    zonelayer_df$MN2_ActPassF <- pmax(0, zonelayer_df$MN2_ActPass) - pmax(0, zonelayer_df$MN2_PassAct)
    
    # MN2_OrgInpRtN[Zone,SoilLayer] = C_RtDecay_N[Zone,SoilLayer]+T_RtDec_N[Zone,SoilLayer]
    zlp_N <- zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "N", c("C_RtDecay", "T_RtDec")]
    zonelayer_df$MN2_OrgInpRtN <- zlp_N$C_RtDecay + zlp_N$T_RtDec
    
    # MN2_StrucIn[Zone,SoilLayer] = IF(MN2_OrgInpRtN[Zone,SoilLayer]>10^-5)THEN(MC2_StrucIn[Zone,SoilLayer]/(MN_CNStruc*MN_NutRatStruc[N]))ELSE(0)
    zonelayer_df$MN2_StrucIn <- ifelse(
      zonelayer_df$MN2_OrgInpRtN > 10^-5,
      zonelayer_df$MC2_StrucIn / (MN_CNStruc * nut_df[nut_df$SlNut == "N", "MN_NutRatStruc"]),
      0
    )
    
    # MN2_MetabIn[Zone,SoilLayer] = MN2_OrgInpRtN[Zone,SoilLayer]-MN2_StrucIn[Zone,SoilLayer]
    zonelayer_df$MN2_MetabIn <- zonelayer_df$MN2_OrgInpRtN - zonelayer_df$MN2_StrucIn
    
    # MN2_MetabMinF[Zone,SoilLayer] = MN2_DecActMet[Zone,SoilLayer]-MN2_MetabActF[Zone,SoilLayer]+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Metab[Zone,SoilLayer]
    zonelayer_df$MN2_MetabMinF <- zonelayer_df$MN2_DecActMet - zonelayer_df$MN2_MetabActF +
      zonelayer_df$MN2_MinDueToSB * zonelayer_df$MN2_Metab
    
    # MN2_OrgN_leaching[Zone] = MN2_Metab[Zone,4]*MC2_Met_LayerTrans[Zone,4]+MN2_Struc[Zone,4]*MC2_Struc_LayerTrans[Zone,4]+MN2_Act[Zone,4]*MC2_Act_LayerTrans[Zone,4]+MN2_Slw[Zone,4]*MC2_Slow_LayerTrans[Zone,4]+MN2_Pass[Zone,4]*MC2_Pass_LayerTrans[Zone,4]
    zl4c <- zonelayercpools_df[zonelayercpools_df$layer == 4, c("zone", "MN2_cpools", "MC2_LayerTrans")]
    zone_df$MN2_OrgN_leaching <- aggregate(zl4c$MN2_cpools * zl4c$MC2_LayerTrans, zl4c["zone"], sum)[[2]]
    
    # MN2_DecStrucSlw[Zone,SoilLayer] = MC2_StrucSlwF[Zone,SoilLayer]/(MC_EffStrucSlw*MN_CNStruc*MN_NutRatStruc[N])
    zonelayer_df$MN2_DecStrucSlw <- zonelayer_df$MC2_StrucSlwF / (MC_EffStrucSlw * MN_CNStruc *
                                                                    nut_df[nut_df$SlNut == "N", "MN_NutRatStruc"])
    
    # MN2_DemStrucSlw[Zone,SoilLayer] = MC2_StrucSlwF[Zone,SoilLayer]/(MN_CNSlw*MN_NutRatSlw[N])
    zonelayer_df$MN2_DemStrucSlw <- zonelayer_df$MC2_StrucSlwF / (MN_CNSlw * nut_df[nut_df$SlNut == "N", "MN_NutRatSlw"])
    
    # MN2_StrucSlwF[Zone,SoilLayer] = MIN(MN2_DecStrucSlw[Zone,SoilLayer],MN2_DemStrucSlw[Zone,SoilLayer])
    zonelayer_df$MN2_StrucSlwF <- pmin(zonelayer_df$MN2_DecStrucSlw,
                                       zonelayer_df$MN2_DemStrucSlw)
    
    # MN2_StrucMinF[Zone,SoilLayer] = (MN2_DecStrucSlw[Zone,SoilLayer]-MN2_StrucSlwF[Zone,SoilLayer])+(MN2_DecActSt_N[Zone,SoilLayer]-MN2_StrucActF[Zone,SoilLayer])+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Struc[Zone,SoilLayer]
    zonelayer_df$MN2_StrucMinF <- (zonelayer_df$MN2_DecStrucSlw - zonelayer_df$MN2_StrucSlwF) +
      (zonelayer_df$MN2_DecActSt_N - zonelayer_df$MN2_StrucActF) + zonelayer_df$MN2_MinDueToSB *
      zonelayer_df$MN2_Struc
    
    # MN2_SlwPassF[Zone,SoilLayer] = MC2_SlwPassF[Zone,SoilLayer]/(MN_CNPass*MN_NutRatPas[N])
    zonelayer_df$MN2_SlwPassF <- zonelayer_df$MC2_SlwPassF / (MN_CNPass * nut_df[nut_df$SlNut == "N", "MN_NutRatPas"])
    
    # MN2_CNSlwAct_N[Zone,SoilLayer] = IF(TIME>1)THEN(MC2_Slw[Zone,SoilLayer]/MN2_Slw[Zone,SoilLayer])ELSE(MN_CNSlw*MN_NutRatSlw[N])
    zonelayer_df$MN2_CNSlwAct_N <- ifelse(
      time > 1,
      zonelayer_df$MC2_Slw / zonelayer_df$MN2_Slw,
      MN_CNSlw * nut_df[nut_df$SlNut == "N", "MN_NutRatSlw"]
    )
    
    # MN2_DecSlw[Zone,SoilLayer] = IF (MC_EffSlwPass*MN2_CNSlwAct_N[Zone,SoilLayer])>0 THEN MC2_SlwPassF[Zone,SoilLayer]/(MC_EffSlwPass*MN2_CNSlwAct_N[Zone,SoilLayer]) ELSE 0
    zonelayer_df$MN2_DecSlw <- ifelse(
      (MC_EffSlwPass * zonelayer_df$MN2_CNSlwAct_N) > 0 ,
      zonelayer_df$MC2_SlwPassF / (MC_EffSlwPass * zonelayer_df$MN2_CNSlwAct_N),
      0
    )
    
    # MN2_SlwMin[Zone,SoilLayer] = MAX(0,MN2_DecSlw[Zone,SoilLayer]-MN2_SlwAct[Zone,SoilLayer]-MN2_SlwPassF[Zone,SoilLayer])
    zonelayer_df$MN2_SlwMin <- pmax(
      0,
      zonelayer_df$MN2_DecSlw - zonelayer_df$MN2_SlwAct - zonelayer_df$MN2_SlwPassF
    )
    
    # MN2_ImmobStrucSlw[Zone,SoilLayer] =
    #   MIN(MN_MinNutpool[Zone,N]-MN2_ImmobAct[Zone,SoilLayer],
    #       MAX(0,MN2_DemStrucSlw[Zone,SoilLayer]-MN2_DecStrucSlw[Zone,SoilLayer])+
    #         MAX(0, MN2_Slw[Zone,SoilLayer]*MN2_CNSlwAct_N[Zone,SoilLayer]*(1/(MN_CNSlw*MN_NutRatSlw[N]) - 1/MN2_CNSlwAct_N[Zone,SoilLayer]) ))
    zonelayer_df$MN2_ImmobStrucSlw <-
      pmin(
        zonelayer_df$MN_MinNutpool_N - zonelayer_df$MN2_ImmobAct,
        pmax(
          0,
          zonelayer_df$MN2_DemStrucSlw - zonelayer_df$MN2_DecStrucSlw
        ) +
          pmax(
            0,
            zonelayer_df$MN2_Slw * zonelayer_df$MN2_CNSlwAct_N * (
              1 / (MN_CNSlw * nut_df[nut_df$SlNut == "N", "MN_NutRatSlw"]) - 1 /
                zonelayer_df$MN2_CNSlwAct_N
            )
          )
      )
    
    # MN2_SlwMinF[Zone,SoilLayer] = (MN2_SlwMin[Zone,SoilLayer]-MN2_ImmobStrucSlw[Zone,SoilLayer])+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Slw[Zone,SoilLayer]
    zonelayer_df$MN2_SlwMinF <- (zonelayer_df$MN2_SlwMin - zonelayer_df$MN2_ImmobStrucSlw) +
      zonelayer_df$MN2_MinDueToSB * zonelayer_df$MN2_Slw
    
    # MN2_DecPass[Zone,SoilLayer] = MC2_PassAct[Zone,SoilLayer]*(MC_EffPass*MN_CNPass*MN_NutRatPas[N])
    zonelayer_df$MN2_DecPass <- zonelayer_df$MC2_PassAct * (MC_EffPass *
                                                              MN_CNPass * nut_df[nut_df$SlNut == "N", "MN_NutRatPas"])
    
    # MN2_PassMinF[Zone,SoilLayer] = MN2_DecPass[Zone,SoilLayer]-MN2_PassAct[Zone,SoilLayer]+MN2_MinDueToS&B[Zone,SoilLayer]*MN2_Pass[Zone,SoilLayer]
    zonelayer_df$MN2_PassMinF <- zonelayer_df$MN2_DecPass - zonelayer_df$MN2_PassAct +
      zonelayer_df$MN2_MinDueToSB * zonelayer_df$MN2_Pass
    
    # T_TodayRettoLab[Tree] = T_Tapping[DW,Tree]*T_TappDOW
    tree_df$T_TodayRettoLab <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Tapping"] * T_TappDOW
    
    # T_ChExpRettoLabour[Tree] = if T_TappingDay?[Tree] = 0 then 0 else if  T_TodayRettoLab[Tree]> 0 then (1-T_MemExpY)*(T_TodayRettoLab[Tree] - T_ExpRetToLab[Tree]) else (T_RecoveryExp)*T_ExpRetThresh
    tree_df$T_ChExpRettoLabour <- ifelse(
      tree_df$T_TappingDay_is == 0,
      0,
      ifelse(
        tree_df$T_TodayRettoLab > 0,
        (1 - T_MemExpY) * (tree_df$T_TodayRettoLab - tree_df$T_ExpRetToLab),
        T_RecoveryExp * T_ExpRetThresh
      )
    )
    
    # CA_ImmDOY[N] = GRAPH(CA_PastImmInp[N])
    # CA_ImmDOY[P] = GRAPH(CA_PastImmInp[P])
    nut_df$CA_ImmDoY <- c(
      get_y_df(nut_df$CA_PastImmInp[1], "CA_ImmDOY_N"),
      get_y_df(nut_df$CA_PastImmInp[2], "CA_ImmDOY_P")
    )
    
    # CA_ImmY[N] = GRAPH(CA_PastImmInp[N])
    # CA_ImmY[P] = GRAPH(CA_PastImmInp[P])
    nut_df$CA_ImmY <- c(
      get_y_df(nut_df$CA_PastImmInp[1], "CA_ImmY_N"),
      get_y_df(nut_df$CA_PastImmInp[2], "CA_ImmY_P")
    )
    
    # CA_ImmTime[SlNut] = CA_ImmDoY[SlNut] + 365*CA_ImmY[SlNut]-CA_DOYStart
    nut_df$CA_ImmTime <- nut_df$CA_ImmDoY + 365 * nut_df$CA_ImmY - CA_DOYStart
    
    # CA_ImmApp[SlNut] = if time = int(CA_ImmTime[SlNut]) then 1 else 0
    nut_df$CA_ImmApp <- ifelse(time == floor(nut_df$CA_ImmTime), 1, 0)
    
    # CA_ImmAmount[SlNut,Zone] = GRAPH(CA_PastImmInp[SlNut])
    nut_df$CA_ImmAmount <- get_y_df(nut_df$CA_PastImmInp, "CA_ImmAmount")
    
    # CA_ImmInput[SlNut,Zone] = if CA_ImmApp[SlNut]= 1 then CA_ImmAmount[SlNut,Zone] else 0
    zonenut_df$CA_ImmApp <- rep(nut_df$CA_ImmApp, each = nzone)
    zonenut_df$CA_ImmAmount <- rep(nut_df$CA_ImmAmount, each = nzone)
    zonenut_df$CA_ImmInput <- ifelse(zonenut_df$CA_ImmApp == 1, zonenut_df$CA_ImmAmount, 0)
    
    # N_ImmInput[Zone,SlNut] = CA_ImmInput[SlNut,Zone]
    zonenut_df$N_ImmInput <- zonenut_df$CA_ImmInput
    
    # N_ImmobileNut1[Zone,SlNut](t) = N_ImmobileNut1[Zone,SlNut](t - dt) + (N_ImmInput[Zone,SlNut] - N_NutMobil1[Zone,SlNut]) * dt
    # N_ImmobileNut2[Zone,SlNut](t) = N_ImmobileNut2[Zone,SlNut](t - dt) + (- N_NutMobil2[Zone,SlNut]) * dt
    # N_ImmobileNut3[Zone,SlNut](t) = N_ImmobileNut3[Zone,SlNut](t - dt) + (- N_NutMobil3[Zone,SlNut]) * dt
    # N_ImmobileNut4[Zone,SlNut](t) = N_ImmobileNut4[Zone,SlNut](t - dt) + (- N_NutMobil4[Zone,SlNut]) * dt
    zonelayernut_df$N_ImmobileNut <- zonelayernut_df$N_ImmobileNut - zonelayernut_df$N_NutMobil
    zonelayernut_df[zonelayernut_df$layer == 1, ]$N_ImmobileNut <- zonelayernut_df[zonelayernut_df$layer == 1, "N_ImmobileNut"] + zonenut_df$N_ImmInput
    
    
    # C_Root_DW[Zone,SoilLayer](t) = C_Root_DW[Zone,SoilLayer](t - dt) + (C_RtIncr_DW[Zone,SoilLayer] - C_RtDecay_DW[Zone,SoilLayer]) * dt
    # C_Root_N[Zone,SoilLayer](t) = C_Root_N[Zone,SoilLayer](t - dt) + (C_RtIncr_N[Zone,SoilLayer] - C_RtDecay_N[Zone,SoilLayer]) * dt
    # C_Root_P[Zone,SoilLayer](t) = C_Root_P[Zone,SoilLayer](t - dt) + (C_RtIncr_P[Zone,SoilLayer] - C_RtDecay_P[Zone,SoilLayer]) * dt
    zonelayerpcomp_df$C_Root <- zonelayerpcomp_df$C_Root + (zonelayerpcomp_df$C_RtIncr - zonelayerpcomp_df$C_RtDecay)
    
    # BC_WeedSeeds = 1000*MC_Carbon*(AF_ZoneFrac[Zn1]*C_WeedSeedBank[Zn1,DW]+AF_ZoneFrac[Zn2]*C_WeedSeedBank[Zn2,DW]+AF_ZoneFrac[Zn3]*C_WeedSeedBank[Zn3,DW]+AF_ZoneFrac[Zn4]*C_WeedSeedBank[Zn4,DW])
    BC_WeedSeeds <- 1000 * MC_Carbon * sum(zone_df$AF_ZoneFrac * zp_DW$C_WeedSeedBank)
    
    # BC_Crop = 1000*MC_Carbon*(
    #   AF_ZoneFrac[Zn1]*(1-CQ_WeedZn?[Zn1])*(C_BiomStLv[Zn1,DW]+ARRAYSUM(C_Root_DW[Zn1,*])+C_YieldCurr[Zn1,DW]+C_GroRes[Zn1,DW])+
    #     AF_ZoneFrac[Zn2]*(1-CQ_WeedZn?[Zn2])*(C_BiomStLv[Zn2,DW]+ARRAYSUM(C_Root_DW[Zn1,*])+C_YieldCurr[Zn2,DW]+C_GroRes[Zn2,DW])+
    #     AF_ZoneFrac[Zn3]*(1-CQ_WeedZn?[Zn3])*(C_BiomStLv[Zn3,DW]+ARRAYSUM(C_Root_DW[Zn1,*])+C_YieldCurr[Zn3,DW]+C_GroRes[Zn3,DW])+
    #     AF_ZoneFrac[Zn4]*(1-CQ_WeedZn?[Zn4])*(C_BiomStLv[Zn4,DW]+ARRAYSUM(C_Root_DW[Zn1,*])+C_YieldCurr[Zn4,DW]+C_GroRes[Zn4,DW]))
    zonelayer_df$C_Root_DW <- zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "DW", "C_Root"]
    zone_df$C_Root_DW_zone <- aggregate(zonelayer_df["C_Root_DW"], zonelayer_df["zone"], sum)$C_Root_DW
    zp_DW <- zonepcomp_df[zonepcomp_df$PlantComp == "DW", ]
    BC_Crop <- 1000 * MC_Carbon * sum(
      zone_df$AF_ZoneFrac * (1 - zone_df$CQ_WeedZn_is) * (
        zp_DW$C_BiomStLv + zone_df$C_Root_DW_zone + zp_DW$C_YieldCurr + zp_DW$C_GroRes
      )
    )
    
    # BC_Weed = 1000*MC_Carbon*(
    #   AF_ZoneFrac[Zn1]*((CQ_WeedZn?[Zn1])*(C_BiomStLv[Zn1,DW]+ARRAYSUM(C_Root_DW[Zn1,*])+C_YieldCurr[Zn1,DW]+C_GroRes[Zn1,DW]))
    #   +AF_ZoneFrac[Zn2]*((CQ_WeedZn?[Zn2])*(C_BiomStLv[Zn2,DW]+ARRAYSUM(C_Root_DW[Zn2,*])+C_YieldCurr[Zn2,DW]+C_GroRes[Zn2,DW]))
    #   +AF_ZoneFrac[Zn3]*((CQ_WeedZn?[Zn3])*(C_BiomStLv[Zn3,DW]+ARRAYSUM(C_Root_DW[Zn3,*])+C_YieldCurr[Zn3,DW]+C_GroRes[Zn3,DW]))
    #   +AF_ZoneFrac[Zn4]*((CQ_WeedZn?[Zn4])*(C_BiomStLv[Zn4,DW]+ARRAYSUM(C_Root_DW[Zn4,*])+C_YieldCurr[Zn4,DW]+C_GroRes[Zn4,DW])))
    BC_Weed <- 1000 * MC_Carbon * sum(zone_df$AF_ZoneFrac * (
      zone_df$CQ_WeedZn_is * (
        zp_DW$C_BiomStLv + zone_df$C_Root_DW_zone + zp_DW$C_YieldCurr + zp_DW$C_GroRes
      )
    ))
    
    # C_Yield[Zone,PlantComp] = if (int(CQ_Stage[Zone])) >= 2 and CQ_WeedZn?[Zone]=0 then C_YieldCurr[Zone,PlantComp]/dt else 0
    zonepcomp_df$C_Yield <- ifelse (
      floor(zonepcomp_df$CQ_Stage) >= 2 &
        zonepcomp_df$CQ_WeedZn_is == 0,
      zonepcomp_df$C_YieldCurr,
      0
    )
    
    # CA_FertApply?[N] = GRAPH(CA_PastFertApp)
    nut_df$CA_FertApply_is <- get_y_df(CA_PastFertApp, "CA_FertApply_is")
    
    # CA_PastFertApp(t) = CA_PastFertApp(t - dt) + (CA_FertApp) * dt
    CA_PastFertApp <- CA_PastFertApp + (CA_FertApp)
    
    # C_CropDayAc[Zone] = if CQ_Stage[Zone] = 0 then 0 else if CQ_WeedZn?[Zone] = 0  then 1 else 0
    zone_df$C_CropDayAc <- ifelse(zone_df$CQ_Stage == 0,
                                  0,
                                  ifelse(zone_df$CQ_WeedZn_is == 0, 1, 0))
    
    # C_CurLimFac[Zn1,Water] = if CQ_Stage[Zn1] = 0 then 0 elseif CQ_WeedZn?[Zn1] = 0  then if CW_Posgro[Zn1]   <=MIN(C_NPosgro[Zn1,N],C_NPosgro[Zn1,P]) and CW_Posgro[Zn1]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn1,N] =     if CQ_Stage[Zn1] = 0 then 0 elseif CQ_WeedZn?[Zn1] = 0  then if C_NPosgro[Zn1,N] <=MIN(CW_Posgro[Zn1],C_NPosgro[Zn1,P]) and C_NPosgro[Zn1,N]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn1,P] =     if CQ_Stage[Zn1] = 0 then 0 elseif CQ_WeedZn?[Zn1] = 0  then if C_NPosgro[Zn1,P] <=MIN(CW_Posgro[Zn1],C_NPosgro[Zn1,N]) and C_NPosgro[Zn1,P]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn2,Water] = if CQ_Stage[Zn2] = 0 then 0 elseif CQ_WeedZn?[Zn2] = 0  then if CW_Posgro[Zn2]   <=MIN(C_NPosgro[Zn2,N],C_NPosgro[Zn2,P]) and CW_Posgro[Zn2]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn2,N] =     if CQ_Stage[Zn2] = 0 then 0 elseif CQ_WeedZn?[Zn2] = 0  then if C_NPosgro[Zn2,N] <=MIN(CW_Posgro[Zn2],C_NPosgro[Zn2,P]) and C_NPosgro[Zn2,N]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn2,P] =     if CQ_Stage[Zn2] = 0 then 0 elseif CQ_WeedZn?[Zn2] = 0  then if C_NPosgro[Zn2,P] <=MIN(CW_Posgro[Zn2],C_NPosgro[Zn2,N]) and C_NPosgro[Zn1,P]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn3,Water] = if CQ_Stage[Zn3] = 0 then 0 elseif CQ_WeedZn?[Zn3] = 0  then if CW_Posgro[Zn3]   <=MIN(C_NPosgro[Zn3,N],C_NPosgro[Zn3,P]) and CW_Posgro[Zn3]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn3,N] =     if CQ_Stage[Zn3] = 0 then 0 elseif CQ_WeedZn?[Zn3] = 0  then if C_NPosgro[Zn3,N] <=MIN(CW_Posgro[Zn3],C_NPosgro[Zn3,P]) and C_NPosgro[Zn3,N]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn3,P] =     if CQ_Stage[Zn3] = 0 then 0 elseif CQ_WeedZn?[Zn3] = 0  then if C_NPosgro[Zn3,P] <=MIN(CW_Posgro[Zn3],C_NPosgro[Zn3,N]) and C_NPosgro[Zn3,P]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn4,Water] = if CQ_Stage[Zn4] = 0 then 0 elseif CQ_WeedZn?[Zn4] = 0  then if CW_Posgro[Zn4]   <=MIN(C_NPosgro[Zn4,N],C_NPosgro[Zn4,P]) and CW_Posgro[Zn4]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn4,N] =     if CQ_Stage[Zn4] = 0 then 0 elseif CQ_WeedZn?[Zn4] = 0  then if C_NPosgro[Zn4,N] <=MIN(CW_Posgro[Zn4],C_NPosgro[Zn4,P]) and C_NPosgro[Zn4,N]<C_StressAccLim then 1 else 0 else 0
    # C_CurLimFac[Zn4,P] =     if CQ_Stage[Zn4] = 0 then 0 elseif CQ_WeedZn?[Zn4] = 0  then if C_NPosgro[Zn4,P] <=MIN(CW_Posgro[Zn4],C_NPosgro[Zn4,N]) and C_NPosgro[Zn4,P]<C_StressAccLim then 1 else 0 else 0
    zonelimit_df$CQ_Stage <- rep(zone_df$CQ_Stage, length(Limiting_Factors))
    zonelimit_df$CQ_WeedZn_is <- rep(zone_df$CQ_WeedZn_is, length(Limiting_Factors))
    zonelimit_df$C_Posgro <- c(zone_df$CW_Posgro,
                               zone_df$C_NPosgro_N,
                               zone_df$C_NPosgro_P)
    zonelimit_df$C_Posgro_limit1 <- c(zone_df$C_NPosgro_N,
                                      zone_df$C_NPosgro_P,
                                      zone_df$CW_Posgro)
    zonelimit_df$C_Posgro_limit2 <- c(zone_df$C_NPosgro_P,
                                      zone_df$CW_Posgro,
                                      zone_df$C_NPosgro_N)
    
    zonelimit_df$C_CurLimFac <- ifelse(zonelimit_df$CQ_Stage == 0,
                                       0,
                                       ifelse(
                                         zonelimit_df$CQ_WeedZn_is == 0,
                                         ifelse(
                                           zonelimit_df$C_Posgro <= min(
                                             zonelimit_df$C_Posgro_limit1,
                                             zonelimit_df$C_Posgro_limit2
                                           ) &
                                             zonelimit_df$C_Posgro < C_StressAccLim,
                                           1,
                                           0
                                         ),
                                         0
                                       ))
    
    # CENT_SOMCTot = AF_ZoneFrac[Zn1]*(MC_Slw[Zn1]+MC_Pass[Zn1]+MC_Act[Zn1])+
    #   AF_ZoneFrac[Zn2]*(MC_Slw[Zn2]+MC_Pass[Zn2]+MC_Act[Zn2])+
    #   AF_ZoneFrac[Zn3]*(MC_Slw[Zn3]+MC_Pass[Zn3]+MC_Act[Zn3])+
    #   AF_ZoneFrac[Zn4]*(MC_Slw[Zn4]+MC_Pass[Zn4]+MC_Act[Zn4])+
    #   AF_ZoneFrac[Zn1]*(ARRAYSUM(MC2_Slw[Zn1,*])+ARRAYSUM(MC2_Pass[Zn1,*])+ARRAYSUM(MC2_Act[Zn1,*]))+
    #   AF_ZoneFrac[Zn2]*(ARRAYSUM(MC2_Slw[Zn2,*])+ARRAYSUM(MC2_Pass[Zn2,*])+ARRAYSUM(MC2_Act[Zn2,*]))+
    #   AF_ZoneFrac[Zn3]*(ARRAYSUM(MC2_Slw[Zn3,*])+ARRAYSUM(MC2_Pass[Zn3,*])+ARRAYSUM(MC2_Act[Zn3,*]))+
    #   AF_ZoneFrac[Zn4]*(ARRAYSUM(MC2_Slw[Zn4,*])+ARRAYSUM(MC2_Pass[Zn4,*])+ARRAYSUM(MC2_Act[Zn4,*]))
    CENT_SOMCTot <-  sum(zone_df$AF_ZoneFrac * (zone_df$MC_Slw + zone_df$MC_Pass + zone_df$MC_Act)) +
      sum(zone_df$AF_ZoneFrac * (
        aggregate(
          zonelayer_df$MC2_Slw + zonelayer_df$MC2_Pass + zonelayer_df$MC2_Act,
          zonelayer_df["zone"],
          sum
        )[[2]]
      ))
    
    # CENT_MetStrCTot = AF_ZoneFrac[Zn1]*(MC_Metab[Zn1]+ MC_Struc[Zn1])+
    #   AF_ZoneFrac[Zn2]*(MC_Metab[Zn2]+ MC_Struc[Zn2])+
    #   AF_ZoneFrac[Zn3]*(MC_Metab[Zn3]+ MC_Struc[Zn3])+
    #   AF_ZoneFrac[Zn4]*(MC_Metab[Zn4]+ MC_Struc[Zn4])+
    #   AF_ZoneFrac[Zn1]*(ARRAYSUM(MC2_Metab[Zn1,*])+ARRAYSUM(MC2_Struc[Zn1,*]))+
    #   AF_ZoneFrac[Zn2]*(ARRAYSUM(MC2_Metab[Zn2,*])+ARRAYSUM(MC2_Struc[Zn2,*]))+
    #   AF_ZoneFrac[Zn3]*(ARRAYSUM(MC2_Metab[Zn3,*])+ARRAYSUM(MC2_Struc[Zn3,*]))+
    #   AF_ZoneFrac[Zn4]*(ARRAYSUM(MC2_Metab[Zn4,*])+ARRAYSUM(MC2_Struc[Zn4,*]))
    CENT_MetStrCTot <-  sum(zone_df$AF_ZoneFrac * (zone_df$MC_Metab + zone_df$MC_Struc)) +
      sum(zone_df$AF_ZoneFrac * (
        aggregate(
          zonelayer_df$MC2_Metab + zonelayer_df$MC2_Struc,
          zonelayer_df["zone"],
          sum
        )[[2]]
      ))
    
    # BC_SOM = (CENT_MetStrCTot+CENT_SOMCTot)
    BC_SOM <- (CENT_MetStrCTot + CENT_SOMCTot)
    
    # E_CoverSum[Zone] = CQ_CovEffCurr[Zone]*C_LAI[Zone]+E_CovEffT[Sp1]*T_LAIEff[Zone,Sp1]+E_CovEffT[Sp2]*T_LAIEff[Zone,Sp2]+E_CovEffT[Sp3]*T_LAIEff[Zone,Sp3]+E_CovEffLitter*MC_Struc[Zone]
    zone_df$E_CoverSum <- zone_df$CQ_CovEffCurr * zone_df$C_LAI +
      aggregate(rep(tree_df$E_CovEffT, each = nzone) * zonetree_df$T_LAIEff,
                zonetree_df["zone"],
                sum)[[2]] +
      E_CovEffLitter * zone_df$MC_Struc
    
    # MC2_OrgC_Leaching[Zone] = MC2_Metab[Zone,4]*MC2_Met_LayerTrans[Zone,4]+MC2_Struc[Zone,4]*MC2_Struc_LayerTrans[Zone,4]+MC2_Act[Zone,4]*MC2_Act_LayerTrans[Zone,4]+MC2_Slw[Zone,4]*MC2_Slow_LayerTrans[Zone,4]+MC2_Pass[Zone,4]*MC2_Pass_LayerTrans[Zone,4]
    zl4c <- zonelayercpools_df[zonelayercpools_df$layer == 4, ]
    zone_df$MC2_OrgC_Leaching <- aggregate(zl4c$MC2_cpools * zl4c$MC2_LayerTrans, zl4c["zone"], sum)[[2]]
    
    # C_Respiration[Zn1,DW] = CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]+C_ApplyMaintResp?*C_MaintResp[Zn1]
    # C_Respiration[Zn1,N] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn1,P] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn2,DW] = CQ_NFixDWUnitCostCurr[Zn2]*C_NFIX[Zn2,N]+C_ApplyMaintResp?*C_MaintResp[Zn2]
    # C_Respiration[Zn2,N] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn2,P] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn3,DW] = CQ_NFixDWUnitCostCurr[Zn3]*C_NFIX[Zn3,N]+C_ApplyMaintResp?*C_MaintResp[Zn3]
    # C_Respiration[Zn3,N] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn3,P] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn4,DW] = CQ_NFixDWUnitCostCurr[Zn4]*C_NFIX[Zn4,N]+C_ApplyMaintResp?*C_MaintResp[Zn4]
    # C_Respiration[Zn4,N] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    # C_Respiration[Zn4,P] = 0*(CQ_NFixDWUnitCostCurr[Zn1]*C_NFIX[Zn1,N]*C_ApplyMaintResp?*C_MaintResp[Zn4])
    zonepcomp_df$C_Respiration <- 0
    zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Respiration"] <- zone_df$CQ_NFixDWUnitCostCurr *  zonenut_df[zonenut_df$SlNut == "N", "C_NFIX"] +
      C_ApplyMaintResp_is * zone_df$C_MaintResp
    
    # BC_CdailyRespforFix = 1000*MC_Carbon*(AF_ZoneFrac[Zn1]*C_Respiration[Zn1,DW]+AF_ZoneFrac[Zn2]*C_Respiration[Zn2,DW]+AF_ZoneFrac[Zn3]*C_Respiration[Zn3,DW]+AF_ZoneFrac[Zn4]*C_Respiration[Zn4,DW])
    zone_df$C_Respiration_zone <- zone_df$AF_ZoneFrac * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Respiration"]
    BC_CdailyRespforFix = 1000 * MC_Carbon * sum(zone_df$C_Respiration_zone)
    
    # BC_SeedInc = MC_Carbon*1000*(AF_ZoneFrac[Zn1]*C_Init[Zn1,DW]+AF_ZoneFrac[Zn2]*C_Init[Zn2,DW]+AF_ZoneFrac[Zn3]*C_Init[Zn3,DW]+AF_ZoneFrac[Zn4]*C_Init[Zn4,DW])
    zone_df$C_Init_zone <- zone_df$AF_ZoneFrac * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Init"]
    BC_SeedInc <- MC_Carbon * 1000 * sum(zone_df$C_Init_zone)
    
    # BC_CPhotoInc = 1000*MC_Carbon*(AF_ZoneFrac[Zn1]*C_BiomInc[Zn1,DW]+AF_ZoneFrac[Zn2]*C_BiomInc[Zn2,DW]+AF_ZoneFrac[Zn3]*C_BiomInc[Zn3,DW]+AF_ZoneFrac[Zn4]*C_BiomInc[Zn4,DW])-BC_SeedInc
    zone_df$C_BiomInc_zone <- zone_df$AF_ZoneFrac * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomInc"]
    BC_CPhotoInc = 1000 * MC_Carbon * sum(zone_df$C_BiomInc_zone) -
      BC_SeedInc
    
    # CA_ExtOrg[ExtOrgInputs] = if CA_FertApp = 1 then AF_ZoneFrac[Zn1]*CA_ExtOrgAppZn[ExtOrgInputs,Zn1]+ AF_ZoneFrac[Zn2]*CA_ExtOrgAppZn[ExtOrgInputs,Zn2]+ AF_ZoneFrac[Zn3]*CA_ExtOrgAppZn[ExtOrgInputs,Zn3]+ AF_ZoneFrac[Zn4]*CA_ExtOrgAppZn[ExtOrgInputs,Zn4] else 0
    inp_df$CA_FertApp <- CA_FertApp
    zoneinp_df$CA_ExtOrgAppZn_zone <- rep(zone_df$AF_ZoneFrac, nrow(inp_df)) * zoneinp_df$CA_ExtOrgAppZn
    inp_df$CA_ExtOrg <- ifelse(
      inp_df$CA_FertApp == 1,
      aggregate(zoneinp_df["CA_ExtOrgAppZn_zone"], zoneinp_df["ExtOrgInputs"], sum)$CA_ExtOrgAppZn_zone,
      0
    )
    
    # BC_ExtOrgAcc = MC_CExtOrg[1]*CA_ExtOrg[1]+MC_CExtOrg[2]*CA_ExtOrg[2]
    BC_ExtOrgAcc <- sum(inp_df$MC_CExtOrg * inp_df$CA_ExtOrg)
    
    # BC_Tree = MC_Carbon*1000*(ARRAYSUM(T_LfTwig[DW,*])+ARRAYSUM(T_GroRes[DW,*])+ARRAYSUM(T_SapWood[DW,*])+ARRAYSUM(T_Fruit[DW,*])+ARRAYSUM(T_HeartWood[DW,*])+ARRAYSUM(T_LatexStock[DW,*])+ARRAYSUM(T_Root_DWtot[*]))
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", ]
    BC_Tree <- MC_Carbon * 1000 * sum(
      tp_DW$T_LfTwig + tp_DW$T_GroRes + tp_DW$T_SapWood + tp_DW$T_Fruit + tp_DW$T_HeartWood +
        tp_DW$T_LatexStock + tree_df$T_Root_DWtot
    )
    
    # BC_DWDeadWood[PlantComp] = AF_ZoneFrac[Zn1]* (S&B_DeadWood[Zn1,PlantComp])+AF_ZoneFrac[Zn2]* (S&B_DeadWood[Zn2,PlantComp])+AF_ZoneFrac[Zn3]* (S&B_DeadWood[Zn3,PlantComp])+AF_ZoneFrac[Zn4]* (S&B_DeadWood[Zn4,PlantComp] )
    pcomp_df$BC_DWDeadWood <- aggregate(rep(zone_df$AF_ZoneFrac, nrow(pcomp_df)) * zonepcomp_df$SB_DeadWood,
                                        zonepcomp_df["PlantComp"],
                                        sum)[[2]]
    
    # BC_NecromasC = MC_Carbon*1000*(BC_DWFineNecroM[DW]+BC_DWDeadWood[DW])
    p_DW <- pcomp_df[pcomp_df$PlantComp == "DW", c("BC_DWFineNecroM", "BC_DWDeadWood")]
    BC_NecromasC <- MC_Carbon * 1000 * (p_DW$BC_DWFineNecroM + p_DW$BC_DWDeadWood)
    
    # BC_CurrentCStock = BC_Crop+BC_Tree+BC_Weed+BC_WeedSeeds+BC_SOM+BC_NecromasC
    BC_CurrentCStock <- BC_Crop + BC_Tree + BC_Weed + BC_WeedSeeds + BC_SOM +
      BC_NecromasC
    
    # BC_CstockChange =  (BC_CurrentCStock-BC_TimeAvg_CStock)*dt/(TIME+DT)
    BC_CstockChange <-  (BC_CurrentCStock - BC_TimeAvg_CStock) / time
    
    
    # BC_TPhotoInc = 1000*MC_Carbon*(ARRAYSUM(T_GroResInc[DW,*])-ARRAYSUM(T_GroInit[DW,*]))
    BC_TPhotoInc = 1000 * MC_Carbon * (sum(tp_DW$T_GroResInc) -
                                         sum(tp_DW$T_GroInit))
    
    # T_RootInit[PlantComp,Tree] = (if RT_ATType[Tree] < 2 then 0 else T_GroResInit[Tree])*T_RtAllocInit[Tree]*T_RtConc[PlantComp,Tree]*T_UnitConv[PlantComp]
    treepcomp_df$T_RootInit <- ifelse(treepcomp_df$RT_ATType < 2, 0, treepcomp_df$T_GroResInit) *
      treepcomp_df$T_RtAllocInit * treepcomp_df$T_RtConc * treepcomp_df$T_UnitConv
    
    # BC_TSeedInc = If ARRAYSUM(T_GroInit[DW,*]) = 0 then 0 else 1000*MC_Carbon*(ARRAYSUM(T_GroInit[DW,*])+ARRAYSUM(T_CanBiomIni[DW,*])+ARRAYSUM(T_WoodIni[DW,*])+ARRAYSUM(T_RootInit[DW,*]))
    BC_TSeedInc <- ifelse(sum(tp_DW$T_GroInit) == 0,
                          0,
                          1000 * MC_Carbon * (
                            sum(tp_DW$T_GroInit) + sum(tp_DW$T_CanBiomIni) + sum(tp_DW$T_WoodIni) +
                              sum(tp_DW$T_RootInit)
                          ))
    
    # T_RespforFixF = ARRAYSUM(T_Respiration[DW,*])*MC_Carbon*1000
    T_RespforFixF = sum(tp_DW$T_Respiration) * MC_Carbon * 1000
    
    # BC_WeedCInflux = 1000*MC_Carbon*(
    #   AF_ZoneFrac[Zn1]*C_WeedSeedInflux[Zn1,DW]+
    #     AF_ZoneFrac[Zn2]*C_WeedSeedInflux[Zn2,DW]+
    #     AF_ZoneFrac[Zn3]*C_WeedSeedInflux[Zn3,DW]+
    #     AF_ZoneFrac[Zn4]*C_WeedSeedInflux[Zn4,DW])
    BC_WeedCInflux <- 1000 * MC_Carbon * sum(zone_df$AF_ZoneFrac *
                                               zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_WeedSeedInflux"])
    
    # C_NInit[Zn1,N] = C_Init[Zn1,N]+C_WeedSeedInflux[Zn1,N]
    # C_NInit[Zn1,P] = C_Init[Zn1,P]+C_WeedSeedInflux[Zn1,P]
    # C_NInit[Zn2,N] = C_Init[Zn2,N]+C_WeedSeedInflux[Zn2,N]
    # C_NInit[Zn2,P] = C_Init[Zn2,P]+C_WeedSeedInflux[Zn2,P]
    # C_NInit[Zn3,N] = C_Init[Zn3,N]+C_WeedSeedInflux[Zn3,N]
    # C_NInit[Zn3,P] = C_Init[Zn3,P]+C_WeedSeedInflux[Zn3,P]
    # C_NInit[Zn4,N] = C_Init[Zn4,N]+C_WeedSeedInflux[Zn4,N]
    # C_NInit[Zn4,P] = C_Init[Zn4,P]+C_WeedSeedInflux[Zn4,P]
    zp_NP <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), c("C_Init","C_WeedSeedInflux")]
    zonenut_df$C_NInit <- zp_NP$C_Init + zp_NP$C_WeedSeedInflux
    
    # BN_CBiomInc[SlNut] = (AF_ZoneFrac[Zn1]*C_NInit[Zn1,SlNut]+AF_ZoneFrac[Zn2]*C_NInit[Zn2,SlNut]+AF_ZoneFrac[Zn3]*C_NInit[Zn3,SlNut]+AF_ZoneFrac[Zn4]*C_NInit[Zn4,SlNut])
    nut_df$BN_CBiomInc <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$C_NInit,
                                    zonenut_df["SlNut"],
                                    sum)[[2]]
    
    # BN_CBiomInit[SlNut](t) = BN_CBiomInit[SlNut](t - dt) + (BN_CBiomInc[SlNut]) * dt
    nut_df$BN_CBiomInit <- nut_df$BN_CBiomInit + (nut_df$BN_CBiomInc)
    
    # BN_CUptTot[SlNut] = AF_ZoneFrac[Zn1]*C_NUptTot[Zn1,SlNut]+AF_ZoneFrac[Zn2]*C_NUptTot[Zn2,SlNut]+AF_ZoneFrac[Zn3]*C_NUptTot[Zn3,SlNut]+AF_ZoneFrac[Zn4]*C_NUptTot[Zn4,SlNut]
    nut_df$BN_CUptTot <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$C_NUptTot,
                                   zonenut_df["SlNut"],
                                   sum)[[2]]
    
    # BN_CUptInc[SlNut] = BN_CUptTot[SlNut]
    nut_df$BN_CUptInc <- nut_df$BN_CUptTot
    
    # BN_ExtOrgAcc[SlNut] = CA_ExtOrg[1]*MN_ExtOrgN[1,SlNut]+CA_ExtOrg[2]*MN_ExtOrgN[2,SlNut]
    nutinp_df$CA_ExtOrg <- rep(inp_df$CA_ExtOrg, each = nrow(inp_df))
    nut_df$BN_ExtOrgAcc <- aggregate(nutinp_df$CA_ExtOrg * nutinp_df$MN_ExtOrgN,
                                     nutinp_df["SlNut"],
                                     sum)[[2]]
    
    # CA_FertNZn[Zone,SlNut] = if CA_FertApp= 1 and P_PrevCropOK? = 1 then CA_FertApply?[SlNut]*CA_FertAmount[Zone] else 0
    zonenut_df$CA_FertApp <- CA_FertApp
    zonenut_df$P_PrevCropOK_is <- P_PrevCropOK_is
    zonenut_df$CA_FertApply_is <- rep(nut_df$CA_FertApply_is, each = nzone)
    zonenut_df$CA_FertAmount <- rep(zone_df$CA_FertAmount, nrow(nut_df))
    zonenut_df$CA_FertNZn <- ifelse(
      zonenut_df$CA_FertApp == 1 &
        zonenut_df$P_PrevCropOK_is == 1,
      zonenut_df$CA_FertApply_is * zonenut_df$CA_FertAmount,
      0
    )
    
    # CA_FertN[SlNut] = if CA_FertApp= 1 and P_PrevCropOK? = 1 then AF_ZoneFrac[Zn1]*CA_FertNZn[Zn1,SlNut] +  AF_ZoneFrac[Zn2]*CA_FertNZn[Zn2,SlNut]+  AF_ZoneFrac[Zn3]*CA_FertNZn[Zn3,SlNut] +  AF_ZoneFrac[Zn4]*CA_FertNZn[Zn4,SlNut] else 0
    nut_df$P_PrevCropOK_is <- P_PrevCropOK_is
    nut_df$CA_FertN <- ifelse(
      nut_df$CA_FertApply_is == 1 & nut_df$P_PrevCropOK_is == 1,
      aggregate(
        zonenut_df$AF_ZoneFrac * zonenut_df$CA_FertNZn,
        zonenut_df["SlNut"],
        sum
      )[[2]],
      0
    )
    
    # BN_Fert[SlNut] = CA_FertN[SlNut]
    nut_df$BN_Fert <- nut_df$CA_FertN
    
    # BN_ImmInput[SlNut] = AF_ZoneFrac[Zn1]*CA_ImmInput[SlNut,Zn1]+AF_ZoneFrac[Zn2]*CA_ImmInput[SlNut,Zn2]+AF_ZoneFrac[Zn3]*CA_ImmInput[SlNut,Zn3]+AF_ZoneFrac[Zn4]*CA_ImmInput[SlNut,Zn4]
    nut_df$BN_ImmInput <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$CA_ImmInput,
                                    zonenut_df["SlNut"],
                                    sum)[[2]]
    
    # BN_ImmInputF[SlNut] = BN_ImmInput[SlNut]
    nut_df$BN_ImmInputF <- nut_df$BN_ImmInput
    
    # RAIN_RunOffZn[Zn1] = RAIN_Runoff10+0*(RAIN_Runoff21+RAIN_Runoff32+RAIN_Runoff43)
    # RAIN_RunOffZn[Zn2] = RAIN_Runoff21+0*(RAIN_Runoff10+RAIN_Runoff32+RAIN_Runoff43)
    # RAIN_RunOffZn[Zn3] = RAIN_Runoff32+0*(RAIN_Runoff10+RAIN_Runoff21+RAIN_Runoff43)
    # RAIN_RunOffZn[Zn4] = 0*(RAIN_Runoff10+RAIN_Runoff21+RAIN_Runoff32)+RAIN_Runoff43
    zone_df$RAIN_RunOffZn <- c(RAIN_Runoff10,
                               RAIN_Runoff21,
                               RAIN_Runoff32,
                               RAIN_Runoff43)
    
    # MN_RunOffFert[Zone,SlNut] = if MN_LatFlowFertKm > 0 then (1-MN_FertDissFrac[SlNut])*MN_FertOnSoil[Zone,SlNut]*RAIN_RunOffZn[Zone]/(RAIN_RunOffZn[Zone]+MN_LatFlowFertKm) else 0
    zonenut_df$MN_LatFlowFertKm <- MN_LatFlowFertKm
    zonenut_df$RAIN_RunOffZn <- rep(zone_df$RAIN_RunOffZn)
    zonenut_df$MN_RunOffFert <- ifelse(
      zonenut_df$MN_LatFlowFertKm > 0,
      (1 - zonenut_df$MN_FertDissFrac) * zonenut_df$MN_FertOnSoil * zonenut_df$RAIN_RunOffZn /
        (zonenut_df$RAIN_RunOffZn + zonenut_df$MN_LatFlowFertKm),
      0
    )
    
    # BN_RunOff[SlNut] = MN_RunOffFert[Zn1,SlNut]
    nut_df$BN_RunOff <- zonenut_df[zonenut_df$zone == 1, "MN_RunOffFert"]
    
    # BN_StocksTotInit[SlNut] = BN_SOMInit[SlNut]+BN_LitInit[SlNut]+BN_StockInit[SlNut]+BN_ImmInit[SlNut]
    nut_df$BN_StocksTotInit <- nut_df$BN_SOMInit + nut_df$BN_LitInit + nut_df$BN_StockInit +
      nut_df$BN_ImmInit
    
    # BN_TreeInc[N] = T_CanInit[N,Sp1]+T_GroInit[N,Sp1]+T_WoodIni[N,Sp1]+T_RootInit[N,Sp1]+T_CanInit[N,Sp2]+T_GroInit[N,Sp2]+T_WoodIni[N,Sp2]+T_RootInit[N,Sp2]+T_CanInit[N,Sp3]+T_GroInit[N,Sp3]+T_WoodIni[N,Sp3]+T_RootInit[N,Sp3]
    # BN_TreeInc[P] = T_CanInit[P,Sp1]+T_GroInit[P,Sp1]+T_WoodIni[P,Sp1]+T_RootInit[P,Sp1]+T_CanInit[P,Sp2]+T_GroInit[P,Sp2]+T_WoodIni[P,Sp2]+T_RootInit[P,Sp2]+T_CanInit[P,Sp3]+T_GroInit[P,Sp3]+T_WoodIni[P,Sp3]+T_RootInit[P,Sp3]
    tp_NP <- treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), c("PlantComp", "T_CanInit","T_GroInit","T_WoodIni","T_RootInit")]
    nut_df$BN_TreeInc <- aggregate(
      tp_NP$T_CanInit + tp_NP$T_GroInit + tp_NP$T_WoodIni +
        tp_NP$T_RootInit,
      tp_NP["PlantComp"],
      sum
    )[[2]]
    
    # BN_TUptInc[SlNut,Tree] = T_NUptTot[SlNut,Tree]
    treenut_df$BN_TUptInc <- treenut_df$T_NUptTot
    
    # E_Erosiveness = GRAPH(E_SoilType)
    E_Erosiveness <- get_y_df(E_SoilType, "E_Erosiveness")
    
    # E_Rain05[Zone] = RAIN_In[Zone]*E_RainFac
    zone_df$E_Rain05 <- zone_df$RAIN_In * E_RainFac
    
    # E_SlopeFac[Zone] = GRAPH(AF_SlopeCurr[Zone])
    zone_df$E_SlopeFac <- get_y_df(zone_df$AF_SlopeCurr, "E_SlopeFac")
    
    # E_ErosUSLE[Zone] = (E_Erosiveness*E_Rain05[Zone]*(1- min(1,E_CoverSum[Zone]))*E_SlopeFac[Zone])/365*10
    zone_df$E_ErosUSLE <- (E_Erosiveness * zone_df$E_Rain05 * (1 - pmin(1, zone_df$E_CoverSum)) *
                             zone_df$E_SlopeFac) / 365 * 10
    
    # E_SoilMovPlou[Zone] = if E_PloughTime?[Zone]=1  then E_TillZone?[Zone]*E_SoilMovperPlou else 0
    zone_df$E_SoilMovPlou <- ifelse(zone_df$E_PloughTime_is == 1,
                                    zone_df$E_TillZone_is * E_SoilMovperPlou,
                                    0)
    
    # RAIN_EventRunoff[Zone] = RAIN_RunOffZn[Zone]
    zone_df$RAIN_EventRunoff <- zone_df$RAIN_RunOffZn
    
    # E_CoverFac[Zone] = min(1,E_CoverSum[Zone])
    zone_df$E_CoverFac <- pmin(1, zone_df$E_CoverSum)
    
    # E_SedConcinRunOff[Zone] = 2700*SIN(arctan(AF_SlopeCurr[Zone]/100))*(1.0-(E_CoverFac[Zone]))*E_EntrailmentCoeffBarePlot*(EXP(-15*E_CoverFac[Zone]))/100
    zone_df$E_SedConcinRunOff <- 2700 * sin(atan(zone_df$AF_SlopeCurr / 100)) *
      (1.0 - (zone_df$E_CoverFac)) * E_EntrailmentCoeffBarePlot * (exp(-15 *
                                                                         zone_df$E_CoverFac)) / 100
    
    # E_ErosRose[Zone] = (RAIN_EventRunoff[Zone]*E_SedConcinRunOff[Zone])/10
    zone_df$E_ErosRose <- (zone_df$RAIN_EventRunoff * zone_df$E_SedConcinRunOff) /
      10
    
    # E_SoilMoveCurr[Zone] = if E_ErosiType = 1 then  MIN(BS_SoilCurrZn[Zone],E_ErosUSLE[Zone]+E_SoilMovPlou[Zone]) else MIN(BS_SoilCurrZn[Zone],E_ErosRose[Zone]+E_SoilMovPlou[Zone])
    zone_df$E_ErosiType <- E_ErosiType
    zone_df$E_SoilMoveCurr <- ifelse(
      E_ErosiType == 1,
      pmin(
        zone_df$BS_SoilCurrZn,
        zone_df$E_ErosUSLE + zone_df$E_SoilMovPlou
      ),
      pmin(
        zone_df$BS_SoilCurrZn,
        zone_df$E_ErosRose + zone_df$E_SoilMovPlou
      )
    )
    
    # E_SedConAvg = AF_ZoneFrac[Zn1]*E_SedConcinRunOff[Zn1]+AF_ZoneFrac[Zn2]*E_SedConcinRunOff[Zn2]+AF_ZoneFrac[Zn3]*E_SedConcinRunOff[Zn3]+AF_ZoneFrac[Zn4]*E_SedConcinRunOff[Zn4]
    E_SedConAvg <- sum(zone_df$AF_ZoneFrac * zone_df$E_SedConcinRunOff)
    
    # E_SoilInflow[Zn1] = E_SoilMoveCurr[Zn2]*AF_LatInFlowRatio[Zn1]+0*(E_RelSedConcRunOn+E_SedConAvg+LF_RunOn)
    # E_SoilInflow[Zn2] = E_SoilMoveCurr[Zn3]*AF_LatInFlowRatio[Zn2]+0*(E_RelSedConcRunOn+E_SedConAvg+LF_RunOn)
    # E_SoilInflow[Zn3] = E_SoilMoveCurr[Zn4]*AF_LatInFlowRatio[Zn3]+0*(E_RelSedConcRunOn+E_SedConAvg+LF_RunOn)
    # E_SoilInflow[Zn4] = LF_RunOn*E_SedConAvg*E_RelSedConcRunOn*AF_LatInFlowRatio[Zn4]+0*E_SoilMoveCurr[Zn4]
    zone_df$E_SoilInflow <- c(zone_df[zone_df$zone %in% c(2:4), "E_SoilMoveCurr"],
                              LF_RunOn * E_SedConAvg * E_RelSedConcRunOn) *
      zone_df$AF_LatInFlowRatio
    
    # E_SoilLoss[Zone] = E_SoilMoveCurr[Zone]
    zone_df$E_SoilLoss <- zone_df$E_SoilMoveCurr
    
    # BS_SoilIncr[Zone] = E_SoilInflow[Zone]-E_SoilLoss[Zone]
    zone_df$BS_SoilIncr <- zone_df$E_SoilInflow - zone_df$E_SoilLoss
    
    # BW_Evap = AF_ZoneFrac[Zn1]*EVAP_Surf[Zn1]+AF_ZoneFrac[Zn2]*EVAP_Surf[Zn2]+AF_ZoneFrac[Zn3]*EVAP_Surf[Zn3]+AF_ZoneFrac[Zn4]*EVAP_Surf[Zn4]
    BW_Evap <- sum(zone_df$AF_ZoneFrac * zone_df$EVAP_Surf)
    
    # BW_RunOff = RAIN_RunOff
    BW_RunOff <- RAIN_RunOff
    
    # BW_RunOn = LF_RunOn/AF_ZoneTot
    BW_RunOn <- LF_RunOn / AF_ZoneTot
    
    # BW_UptC = (1-CQ_WeedZn?[Zn1])*CW_UptTot[Zn1]*AF_ZoneFrac[Zn1]+(1-CQ_WeedZn?[Zn2])*CW_UptTot[Zn2]*AF_ZoneFrac[Zn2]+(1-CQ_WeedZn?[Zn3])*CW_UptTot[Zn3]*AF_ZoneFrac[Zn3]+(1-CQ_WeedZn?[Zn4])*AF_ZoneFrac[Zn4]*CW_UptTot[Zn4]
    BW_UptC <- sum((1 - zone_df$CQ_WeedZn_is) * zone_df$CW_UptTot * zone_df$AF_ZoneFrac)
    
    # BW_UptT[Tree] = TW_UptTot[Tree]'
    tree_df$BW_UptT <- tree_df$TW_UptTot
    
    # BW_WeedEvap = CQ_WeedZn?[Zn1]*CW_UptTot[Zn1]*AF_ZoneFrac[Zn1]+CQ_WeedZn?[Zn2]*CW_UptTot[Zn2]*AF_ZoneFrac[Zn2]+CQ_WeedZn?[Zn3]*CW_UptTot[Zn3]*AF_ZoneFrac[Zn3]+CQ_WeedZn?[Zn4]*CW_UptTot[Zn4]*AF_ZoneFrac[Zn4]
    BW_WeedEvap <- sum(zone_df$CQ_WeedZn_is * zone_df$CW_UptTot * zone_df$AF_ZoneFrac)
    
    
    # C_AgYieldAcc[Zn1,Type1] = if CQ_CType[Zn1] = 1 then C_Yield[Zn1,DW]/(1-CQ_AgronYieldMoistFrac[Zn1]) else 0
    # C_AgYieldAcc[Zn1,Type2] = if CQ_CType[Zn1] = 2 then C_Yield[Zn1,DW]/(1-CQ_AgronYieldMoistFrac[Zn1]) else 0
    # C_AgYieldAcc[Zn1,Type3] = if CQ_CType[Zn1] = 3 then C_Yield[Zn1,DW]/(1-CQ_AgronYieldMoistFrac[Zn1]) else 0
    # C_AgYieldAcc[Zn1,Type4] = if CQ_CType[Zn1] = 4 then C_Yield[Zn1,DW]/(1-CQ_AgronYieldMoistFrac[Zn1]) else 0
    # C_AgYieldAcc[Zn1,Type5] = if CQ_CType[Zn1] = 5 then C_Yield[Zn1,DW]/(1-CQ_AgronYieldMoistFrac[Zn1]) else 0
    # C_AgYieldAcc[Zn2,Type1] = if CQ_CType[Zn2] = 1 then C_Yield[Zn2,DW]/(1-CQ_AgronYieldMoistFrac[Zn2]) else 0
    # C_AgYieldAcc[Zn2,Type2] = if CQ_CType[Zn2] = 2 then C_Yield[Zn2,DW]/(1-CQ_AgronYieldMoistFrac[Zn2]) else 0
    # C_AgYieldAcc[Zn2,Type3] = if CQ_CType[Zn2] = 3 then C_Yield[Zn2,DW]/(1-CQ_AgronYieldMoistFrac[Zn2]) else 0
    # C_AgYieldAcc[Zn2,Type4] = if CQ_CType[Zn2] = 4 then C_Yield[Zn2,DW]/(1-CQ_AgronYieldMoistFrac[Zn2]) else 0
    # C_AgYieldAcc[Zn2,Type5] = if CQ_CType[Zn2] = 5 then C_Yield[Zn2,DW]/(1-CQ_AgronYieldMoistFrac[Zn2]) else 0
    # C_AgYieldAcc[Zn3,Type1] = if CQ_CType[Zn3] = 1 then C_Yield[Zn3,DW]/(1-CQ_AgronYieldMoistFrac[Zn3]) else 0
    # C_AgYieldAcc[Zn3,Type2] = if CQ_CType[Zn3] = 2 then C_Yield[Zn3,DW]/(1-CQ_AgronYieldMoistFrac[Zn3]) else 0
    # C_AgYieldAcc[Zn3,Type3] = if CQ_CType[Zn3] = 3 then C_Yield[Zn3,DW]/(1-CQ_AgronYieldMoistFrac[Zn3]) else 0
    # C_AgYieldAcc[Zn3,Type4] = if CQ_CType[Zn3] = 4 then C_Yield[Zn3,DW]/(1-CQ_AgronYieldMoistFrac[Zn3]) else 0
    # C_AgYieldAcc[Zn3,Type5] = if CQ_CType[Zn3] = 5 then C_Yield[Zn3,DW]/(1-CQ_AgronYieldMoistFrac[Zn3]) else 0
    # C_AgYieldAcc[Zn4,Type1] = if CQ_CType[Zn4] = 1 then C_Yield[Zn4,DW]/(1-CQ_AgronYieldMoistFrac[Zn4]) else 0
    # C_AgYieldAcc[Zn4,Type2] = if CQ_CType[Zn4] = 2 then C_Yield[Zn4,DW]/(1-CQ_AgronYieldMoistFrac[Zn4]) else 0
    # C_AgYieldAcc[Zn4,Type3] = if CQ_CType[Zn4] = 3 then C_Yield[Zn4,DW]/(1-CQ_AgronYieldMoistFrac[Zn4]) else 0
    # C_AgYieldAcc[Zn4,Type4] = if CQ_CType[Zn4] = 4 then C_Yield[Zn4,DW]/(1-CQ_AgronYieldMoistFrac[Zn4]) else 0
    # C_AgYieldAcc[Zn4,Type5] = if CQ_CType[Zn4] = 5 then C_Yield[Zn4,DW]/(1-CQ_AgronYieldMoistFrac[Zn4]) else 0
    zone_df$C_AgYieldAcc <- ifelse(
      zone_df$CQ_CType == 1,
      zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Yield"] / (1 - zone_df$CQ_AgronYieldMoistFrac),
      0
    )
    zonecrop_df$C_AgYieldAcc <- rep(zone_df$C_AgYieldAcc, ncrop)
    
    # C_YieldInc[Zone,PlantComp] = IF(C_PlantDiesToday?[Zone]=0)THEN( C_GroResMobFrac*CQ_CHarvAllocCurr[Zone]*C_GroRes[Zone,PlantComp])ELSE(0)
    zonepcomp_df$C_YieldInc <- ifelse(
      zonepcomp_df$C_PlantDiesToday_is == 0,
      C_GroResMobFrac * zonepcomp_df$CQ_CHarvAllocCurr * zonepcomp_df$C_GroRes,
      0
    )
    
    # CW_HydFluxPosTot[Zone] = CW_PotFluxSum[Zone]*CW_ScalingFacPos[Zone]
    zone_df$CW_HydFluxPosTot <- zone_df$CW_PotFluxSum * zone_df$CW_ScalingFacPos
    
    # CENT_ExtInpNInc[SlNut] = AF_ZoneFrac[Zn1]*(MN_ExtOrgInpN[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(MN_ExtOrgInpN[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(MN_ExtOrgInpN[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(MN_ExtOrgInpN[Zn4,SlNut])
    nut_df$CENT_ExtInpNInc <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$MN_ExtOrgInpN,
                                        zonenut_df["SlNut"],
                                        sum)[[2]]
    
    # CENT_LitterNInc[SlNut] = AF_ZoneFrac[Zn1]*(MN_LitInpN[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(MN_LitInpN[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(MN_LitInpN[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(MN_LitInpN[Zn4,SlNut])
    nut_df$CENT_LitterNInc <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$MN_LitInpN,
                                        zonenut_df["SlNut"],
                                        sum)[[2]]
    
    # CENT_NInc[SlNut] = AF_ZoneFrac[Zn1]*MN_Mineralization[Zn1,SlNut]+AF_ZoneFrac[Zn2]*MN_Mineralization[Zn2,SlNut]+AF_ZoneFrac[Zn3]*MN_Mineralization[Zn3,SlNut]+AF_ZoneFrac[Zn4]*MN_Mineralization[Zn4,SlNut]
    nut_df$CENT_NInc <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$MN_Mineralization,
                                  zonenut_df["SlNut"],
                                  sum)[[2]]
    
    # MN_TotLitSomTrans[Zone,SlNut] = MN_Act_LitSomTrans[Zone,SlNut]+MN_Met_LitSomTrans[Zone,SlNut]+MN_Pas_LitSomTrans[Zone,SlNut]+MN_Slw_LitSomTrans[Zone,SlNut]+MN_Str_LitSomTrans[Zone,SlNut]
    zonenut_df$MN_TotLitSomTrans <- zonenut_df$MN_Act_LitSomTrans + zonenut_df$MN_Met_LitSomTrans + zonenut_df$MN_Pas_LitSomTrans +
      zonenut_df$MN_Slw_LitSomTrans + zonenut_df$MN_Str_LitSomTrans
    
    # Cent2LitSomAcc[SlNut] = AF_ZoneFrac[Zn1]*MN_TotLitSomTrans[Zn1,SlNut]+AF_ZoneFrac[Zn2]*MN_TotLitSomTrans[Zn2,SlNut]+AF_ZoneFrac[Zn3]*MN_TotLitSomTrans[Zn3,SlNut]+AF_ZoneFrac[Zn4]*MN_TotLitSomTrans[Zn4,SlNut]
    nut_df$Cent2LitSomAcc <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$MN_TotLitSomTrans,
                                       zonenut_df["SlNut"],
                                       sum)[[2]]
    
    
    
    # MN2_CentMinFlows[Zn1,N] = arraysum(MN2_SomMinExch[Zn1,*]) + 0*arraysum(MP2_SomMinExch[Zn1,*])
    # MN2_CentMinFlows[Zn1,P] = 0*arraysum(MN2_SomMinExch[Zn1,*]) + arraysum(MP2_SomMinExch[Zn1,*])
    # MN2_CentMinFlows[Zn2,N] = arraysum(MN2_SomMinExch[Zn2,*]) +0* arraysum(MP2_SomMinExch[Zn2,*])
    # MN2_CentMinFlows[Zn2,P] = 0*arraysum(MN2_SomMinExch[Zn2,*]) + arraysum(MP2_SomMinExch[Zn2,*])
    # MN2_CentMinFlows[Zn3,N] = arraysum(MN2_SomMinExch[Zn3,*]) + 0*arraysum(MP2_SomMinExch[Zn3,*])
    # MN2_CentMinFlows[Zn3,P] = 0*arraysum(MN2_SomMinExch[Zn3,*]) + arraysum(MP2_SomMinExch[Zn3,*])
    # MN2_CentMinFlows[Zn4,N] = arraysum(MN2_SomMinExch[Zn4,*]) + 0*arraysum(MP2_SomMinExch[Zn4,*])
    # MN2_CentMinFlows[Zn4,P] = 0*arraysum(MN2_SomMinExch[Zn4,*]) + arraysum(MP2_SomMinExch[Zn4,*])
    zonenut_df$MN2_CentMinFlows <- NA
    zonenut_df[zonenut_df$SlNut == "N", "MN2_CentMinFlows"] <- aggregate(zonelayer_df["MN2_SomMinExch"], zonelayer_df["zone"], sum)$MN2_SomMinExch
    zonenut_df[zonenut_df$SlNut == "P", "MN2_CentMinFlows"] <- aggregate(zonelayer_df["MP2_SomMinExch"], zonelayer_df["zone"], sum)$MP2_SomMinExch
    
    # CENT2_Ninc[SlNut] = AF_ZoneFrac[Zn1]*MN2_CentMinFlows[Zn1,SlNut]+AF_ZoneFrac[Zn2]*MN2_CentMinFlows[Zn2,SlNut]+AF_ZoneFrac[Zn3]*MN2_CentMinFlows[Zn3,SlNut]+AF_ZoneFrac[Zn4]*MN2_CentMinFlows[Zn4,SlNut]
    nut_df$CENT2_Ninc <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$MN2_CentMinFlows,
                                   zonenut_df["SlNut"],
                                   sum)[[2]]
    
    # MP2_OrgInpRtP[Zone,SoilLayer] = C_RtDecay_P[Zone,SoilLayer]+T_RtDec_P[Zone,SoilLayer]
    zonelayer_df$MP2_OrgInpRtP <- zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "P", "C_RtDecay"] + zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "P", "T_RtDec"]
    
    # CENT2_SOMNInc[N] = AF_ZoneFrac[Zn1]*(ARRAYSUM(MN2_OrgInpRtN[Zn1,*]))+AF_ZoneFrac[Zn2]*(ARRAYSUM(MN2_OrgInpRtN[Zn2,*]))+AF_ZoneFrac[Zn3]*(ARRAYSUM(MN2_OrgInpRtN[Zn3,*]))+AF_ZoneFrac[Zn4]*(ARRAYSUM(MN2_OrgInpRtN[Zn4,*]))+0*MP2_OrgInpRtP[Zn1,1]
    # CENT2_SOMNInc[P] = AF_ZoneFrac[Zn1]* ARRAYSUM(MP2_OrgInpRtP[Zn1,*])+ AF_ZoneFrac[Zn2]* ARRAYSUM(MP2_OrgInpRtP[Zn2,*]) +AF_ZoneFrac[Zn3]* ARRAYSUM(MP2_OrgInpRtP[Zn3,*])+ AF_ZoneFrac[Zn4]* ARRAYSUM(MP2_OrgInpRtP[Zn4,*])+0*MN2_OrgInpRtN[Zn1,1]
    nut_df$CENT2_SOMNInc <- NA
    nut_df[nut_df$SlNut == "N", ]$CENT2_SOMNInc <- sum(
      zone_df$AF_ZoneFrac *
        aggregate(zonelayer_df$MN2_OrgInpRtN, zonelayer_df["zone"], sum)[[2]]
    )
    nut_df[nut_df$SlNut == "P", ]$CENT2_SOMNInc <- sum(
      zone_df$AF_ZoneFrac *
        aggregate(zonelayer_df$MP2_OrgInpRtP, zonelayer_df["zone"], sum)[[2]]
    )
    
    # CW_YDayWUotChange[Zone] = if RT_CAmount[Zone]<>0 then -CW_DemandPerRoot[Zone]+CW_DemandPot[Zone]/RT_CAmount[Zone] else 0
    zone_df$CW_YDayWUotChange <- ifelse(
      zone_df$RT_CAmount != 0,
      -zone_df$CW_DemandPerRoot + zone_df$CW_DemandPot / zone_df$RT_CAmount,
      0
    )
    
    # E_PloughEvent = if time = int(E_PloughTimeCal) then +1 else if time > E_PloughTimeCal +1 then +1 else 0
    E_PloughEvent <- ifelse(time == floor(E_PloughTimeCal),
                            1,
                            ifelse(time > E_PloughTimeCal + 1, 1, 0))
    
    # EVAP_SlashInit[Zone] = EVAP_InitSlashM*S&B_SlashVegetation[Zone,DW]-S&B_DailyNecromLitTransfer*EVAP_SlashWater[Zone]
    zone_df$EVAP_SlashInit <- EVAP_InitSlashM * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_SlashVegetation"] - SB_DailyNecromLitTransfer * zone_df$EVAP_SlashWater
    
    # S&B_DeadWoodIncr[Zone,PlantComp] = ARRAYSUM(T_WoodSlashed[PlantComp,*])
    zonepcomp_df$SB_DeadWoodIncr <- rep(aggregate(treepcomp_df$T_WoodSlashed, treepcomp_df["PlantComp"], sum)[[2]],
                                        each = nzone)
    
    # EVAP_InitWoodMoist[Zone] = EVAP_InitWoodM*S&B_DeadWoodIncr[Zone,DW]-S&B_DailyDeadWoodLitTransfer*EVAP_WoodMoist[Zone]
    zone_df$EVAP_InitWoodMoist <- EVAP_InitWoodM * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "SB_DeadWoodIncr"] - SB_DailyDeadWoodLitTransfer *
      zone_df$EVAP_WoodMoist
    
    # EVAP_FromDeadWood[Zone] = EVAP_WoodDryFact*(S&B_FirEvapS&W[Zone])*EVAP_WoodMoist[Zone]+min(max(0,EVAP_Pot-RAIN_InterceptEvapAvg-EVAP_SlashEvap[Zone]-EVAP_Surf[Zone]),EVAP_WoodMoist[Zone])
    zone_df$EVAP_FromDeadWood <- EVAP_WoodDryFact * zone_df$SB_FirEvapSW * zone_df$EVAP_WoodMoist +
      pmin(
        pmax(
          0,
          EVAP_Pot - RAIN_InterceptEvapAvg - zone_df$EVAP_SlashEvap - zone_df$EVAP_Surf
        ),
        zone_df$EVAP_WoodMoist
      )
    
    # TW_UptTotAll = ARRAYSUM(TW_UptTot[*])
    TW_UptTotAll <- sum(tree_df$TW_UptTot)
    
    # EVAP_TTranspHist = -EVAP_YesterdayTTransp+TW_UptTotAll
    EVAP_TTranspHist <- -EVAP_YesterdayTTransp + TW_UptTotAll
    
    # G_GrazeAccess[Zone] = if G_Graze_Zn_?[Zone] = 1 then 1 else if CQ_Stage[Zone]<>0 then 0 else if G_Graze_Offseason? = 1 then 1 else 0
    zone_df$G_Graze_Offseason_is <- G_Graze_Offseason_is
    zone_df$G_GrazeAccess <- ifelse(zone_df$G_Graze_Zn_is == 1,
                                    1,
                                    ifelse(
                                      zone_df$CQ_Stage != 0,
                                      0,
                                      ifelse(zone_df$G_Graze_Offseason_is == 1, 1, 0)
                                    ))
    
    # G_BiomDep[Zone] = GRAPH(C_BiomStLv[Zone,DW])
    zone_df$G_BiomDep <- get_y_df(zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomStLv"], "G_BiomDep")
    
    # G_Ndep[Zone] = GRAPH(C_BiomStLv[Zone,N]/(C_BiomStLv[Zone,DW]+0.0001))
    zone_df$G_Ndep <- get_y_df(zonepcomp_df[zonepcomp_df$PlantComp == "N", "C_BiomStLv"] /
                                 (zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomStLv"] + 0.0001),
                               "G_Ndep")
    
    # G_StageDep[Zone] = GRAPH(CQ_Stage[Zone])
    zone_df$G_StageDep <- get_y_df(zone_df$CQ_Stage, "G_StageDep")
    
    # G_AttrractGrasStL[Zone] = G_GrazeAccess[Zone]*C_BiomStLv[Zone,DW]*AF_ZoneFrac[Zone]*G_BiomDep[Zone]*G_Ndep[Zone]*G_StageDep[Zone]
    zone_df$G_AttrractGrasStL <- zone_df$G_GrazeAccess * zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_BiomStLv"] * zone_df$AF_ZoneFrac * zone_df$G_BiomDep * zone_df$G_Ndep * zone_df$G_StageDep
    
    # G_Pasture_Available = ARRAYSUM(G_AttrractGrasStL[*])
    G_Pasture_Available <- sum(zone_df$G_AttrractGrasStL)
    
    # G_GrazeToday? = if G_Grazing_Cycle<>0 then  if mod(time,G_Grazing_Cycle)=0 then G_Grazing_Cycle else 0 else 0
    G_GrazeToday_is <- ifelse(G_Grazing_Cycle != 0, ifelse((time %% G_Grazing_Cycle) == 0, G_Grazing_Cycle, 0), 0)
    
    # G_GrazingPressure = if G_Pasture_Available> 0 then G_GrazeToday? * G_StockingRate_per_ha*0.0001*G_StockingRate_per_ha* G_DayDempKgDay[DW]*G_SLU/G_Pasture_Available else 0
    G_GrazingPressure <- ifelse(
      G_Pasture_Available > 0,
      G_GrazeToday_is * G_StockingRate_per_ha * 0.0001 * G_StockingRate_per_ha * pcomp_df[pcomp_df$PlantComp == "DW", "G_DayDempKgDay"] *
        G_SLU / G_Pasture_Available,
      0
    )
    
    # G_ZoneGrazeFrac[Zone] = if G_Pasture_Available> 0 then G_GrazingPressure*G_AttrractGrasStL[Zone]/G_Pasture_Available else 0
    zone_df$G_ZoneGrazeFrac <- ifelse(
      G_Pasture_Available > 0,
      G_GrazingPressure * zone_df$G_AttrractGrasStL / G_Pasture_Available,
      0
    )
    
    # G_GrazedPerZone[Zone,PlantComp] = C_BiomStLv[Zone,PlantComp]*G_ZoneGrazeFrac[Zone]
    zonepcomp_df$G_ZoneGrazeFrac <- rep(zone_df$G_ZoneGrazeFrac, nrow(pcomp_df))
    zonepcomp_df$G_GrazedPerZone <- zonepcomp_df$C_BiomStLv * zonepcomp_df$G_ZoneGrazeFrac
    
    # G_BiomassGrazed[PlantComp] = AF_ZoneFrac[Zn1]*G_GrazedPerZone[Zn1,PlantComp]+AF_ZoneFrac[Zn2]*G_GrazedPerZone[Zn2,PlantComp]+AF_ZoneFrac[Zn3]*G_GrazedPerZone[Zn3,PlantComp]+AF_ZoneFrac[Zn4]*G_GrazedPerZone[Zn4,PlantComp]
    zonepcomp_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nrow(pcomp_df))
    pcomp_df$G_BiomassGrazed <- aggregate(zonepcomp_df$AF_ZoneFrac * zonepcomp_df$G_GrazedPerZone,
                                          zonepcomp_df["PlantComp"],
                                          sum)[[2]]
    
    # G_Feed_Sufficiency[PlantComp] = if (G_StockingRate_per_ha*G_DayDempKgDay[PlantComp])>0 then G_BiomassGrazed[PlantComp]/(G_StockingRate_per_ha*G_DayDempKgDay[PlantComp]) else 0
    pcomp_df$G_Feed_Sufficiency <- ifelse (
      G_StockingRate_per_ha * pcomp_df$G_DayDempKgDay > 0,
      pcomp_df$G_BiomassGrazed / (G_StockingRate_per_ha *
                                    pcomp_df$G_DayDempKgDay),
      0
    )
    
    # G_ManureProd[DW] = G_BiomassGrazed[DW]*(1-G_AnimRespFrac[DW]-G_AnmWGfrac[DW])
    # G_ManureProd[N] = G_BiomassGrazed[N]*(1-G_AnimRespFrac[N]-G_AnmWGfrac[N])
    # G_ManureProd[P] = G_BiomassGrazed[P]*(1-G_AnimRespFrac[P]-G_AnmWGfrac[P])
    pcomp_df$G_ManureProd <- pcomp_df$G_BiomassGrazed * (1 - pcomp_df$G_AnimRespFrac -
                                                           pcomp_df$G_AnmWGfrac)
    
    # G_GrazeResp[DW] = G_BiomassGrazed[DW]*G_AnimRespFrac[DW]
    # G_GrazeResp[N] = G_BiomassGrazed[N]*G_AnimRespFrac[N]
    # G_GrazeResp[P] = G_BiomassGrazed[P]*G_AnimRespFrac[P]
    pcomp_df$G_GrazeResp <- pcomp_df$G_BiomassGrazed * pcomp_df$G_AnimRespFrac
    
    # G_Animal_Weight_Gain[DW] = G_BiomassGrazed[DW]*G_AnmWGfrac[DW]
    # G_Animal_Weight_Gain[N] = G_BiomassGrazed[N]*G_AnmWGfrac[N]
    # G_Animal_Weight_Gain[P] = G_BiomassGrazed[P]*G_AnmWGfrac[P]
    pcomp_df$G_Animal_Weight_Gain <- pcomp_df$G_BiomassGrazed * pcomp_df$G_AnmWGfrac
    
    # GHG_AnaerobIndicCh[Zone] = GHG_AnaerobMem*GHG_AnaerobIndic[Zone]-(1-GHG_AnaerobMem)*(
    #   GHG_AnaerobLayerW[1]*MAX(0,W_WaterfilledPoreF1[Zone]-GHG_AnaeroThresh)+
    #     GHG_AnaerobLayerW[2]*MAX(0,W_WaterfilledPoreF2[Zone]-GHG_AnaeroThresh)+
    #     GHG_AnaerobLayerW[3]*MAX(0,W_WaterfilledPoreF3[Zone]-GHG_AnaeroThresh)+
    #     GHG_AnaerobLayerW[4]*MAX(0,W_WaterfilledPoreF4[Zone]-GHG_AnaeroThresh))
    zonelayer_df$GHG_AnaerobLayerW <- rep(layer_df$GHG_AnaerobLayerW, each = nzone)
    zone_df$GHG_AnaerobIndicCh <- GHG_AnaerobMem * zone_df$GHG_AnaerobIndic -
      (1 - GHG_AnaerobMem) *
      aggregate(
        zonelayer_df$GHG_AnaerobLayerW * pmax(0, zonelayer_df$W_WaterfilledPoreF - GHG_AnaeroThresh),
        zonelayer_df["zone"],
        sum
      )[[2]]
    
    # GHG_CH4FluxZn[Zone] = -GHG_PotCH4oxid+(GHG_PotCH4oxid-GHG_PotCH4Em)*(1-GHG_EffWaterfPoreF[Zone])/(1-GHG_EffWaterfPoreF[Zone]+GHG_CH4_Km)
    zone_df$GHG_CH4FluxZn <- -GHG_PotCH4oxid + (GHG_PotCH4oxid - GHG_PotCH4Em) *
      (1 - zone_df$GHG_EffWaterfPoreF) / (1 - zone_df$GHG_EffWaterfPoreF + GHG_CH4_Km)
    
    # W_H1DrainF = W_H1Drain[Zn1]
    # W_H2DrainF = W_H2Drain[Zn1]
    # W_H3DrainF = W_H3Drain[Zn1]
    # W_H4DrainF = W_H4Drain[Zn1]
    layer_df$W_HDrainF <- zonelayer_df[zonelayer_df$zone == 1, "W_HDrain"]
    
    # LF_LatAc1 = LF_Lat4Inflow1
    # LF_LatAc2 = LF_Lat4Inflow2
    # LF_LatAc3 = LF_Lat4Inflow3
    # LF_LatAc4 = LF_Lat4Inflow4
    layer_df$LF_LatAc <- layer_df$LF_Lat4Inflow
    
    # LIGHT_CRefRelCap[Zone] = 1-EXP(-CQ_kLightCurr[Zone]*C_LAI[Zone])
    zone_df$LIGHT_CRefRelCap <- 1 - exp(-zone_df$CQ_kLightCurr * zone_df$C_LAI)
    
    # LIGHT_CCapRelInc[Zone] = if CQ_WeedZn?[Zone] = 1 then 0 else if LIGHT_CRefRelCap[Zone] = 0 then 0 else if LIGHT_CRelCap[Zone] > CQ_RelLightMaxCurr[Zone] then 1 else min(LIGHT_CRelCap[Zone],CQ_RelLightMaxCurr[Zone])/min(LIGHT_CRefRelCap[Zone],CQ_RelLightMaxCurr[Zone])
    zone_df$LIGHT_CCapRelInc <- ifelse(zone_df$CQ_WeedZn_is == 1,
                                       0,
                                       ifelse(
                                         zone_df$LIGHT_CRefRelCap == 0,
                                         0,
                                         ifelse(
                                           zone_df$LIGHT_CRelCap > zone_df$CQ_RelLightMaxCurr,
                                           1,
                                           pmin(zone_df$LIGHT_CRelCap, zone_df$CQ_RelLightMaxCurr) / pmin(zone_df$LIGHT_CRefRelCap, zone_df$CQ_RelLightMaxCurr)
                                         )
                                       ))
    
    # MN_FertNZn[Zone,SlNut] = CA_FertNZn[Zone,SlNut]
    zonenut_df$MN_FertNZn <- zonenut_df$CA_FertNZn
    
    # MN_LatFlowFert[Zn1,N] = -MN_RunOffFert[Zn2,N]*AF_LatInFlowRatio[Zn1]+MN_RunOffFert[Zn1,N]
    # MN_LatFlowFert[Zn1,P] = -MN_RunOffFert[Zn2,P]*AF_LatInFlowRatio[Zn1]+MN_RunOffFert[Zn1,P]
    # MN_LatFlowFert[Zn2,N] = -MN_RunOffFert[Zn3,N]*AF_LatInFlowRatio[Zn2]+MN_RunOffFert[Zn2,N]
    # MN_LatFlowFert[Zn2,P] = -MN_RunOffFert[Zn3,P]*AF_LatInFlowRatio[Zn2]+MN_RunOffFert[Zn2,P]
    # MN_LatFlowFert[Zn3,N] = -MN_RunOffFert[Zn4,N]*AF_LatInFlowRatio[Zn3]+MN_RunOffFert[Zn3,N]
    # MN_LatFlowFert[Zn3,P] = -MN_RunOffFert[Zn4,P]*AF_LatInFlowRatio[Zn3]+MN_RunOffFert[Zn3,P]
    # MN_LatFlowFert[Zn4,N] = MN_RunOffFert[Zn4,N]+0*AF_LatInFlowRatio[Zn4]
    # MN_LatFlowFert[Zn4,P] = MN_RunOffFert[Zn4,P]+0*AF_LatInFlowRatio[Zn4]
    zonenut_df$MN_RunOffFeRT_right <- NA
    zonenut_df[zonenut_df$zone %in% c(1, 2, 3), "MN_RunOffFeRT_right"] <- zonenut_df[zonenut_df$zone %in% c(2, 3, 4), "MN_RunOffFert"]
    zonenut_df$AF_LatInFlowRatio <- rep(zone_df$AF_LatInFlowRatio, nrow(nut_df))
    zonenut_df$MN_LatFlowFert <- -zonenut_df$MN_RunOffFeRT_right * zonenut_df$AF_LatInFlowRatio +
      zonenut_df$MN_RunOffFert
    zonenut_df[zonenut_df$zone == 4, "MN_LatFlowFert"] <- zonenut_df[zonenut_df$zone == 4, "MN_RunOffFert"]
    
    # MP2_CNMetab[Zone,SoilLayer] = IF(MP2_Metab[Zone,SoilLayer]>0)THEN(MC2_Metab[Zone,SoilLayer]/MP2_Metab[Zone,SoilLayer])ELSE(0)
    zonelayer_df$MP2_CNMetab <- ifelse(zonelayer_df$MP2_Metab > 0,
                                       zonelayer_df$MC2_Metab / zonelayer_df$MP2_Metab,
                                       0)
    
    # MP2_DecActMet[Zone,SoilLayer] = IF(MP2_CNMetab[Zone,SoilLayer]>0)THEN(MC2_MetabActF[Zone,SoilLayer]/(MC_EffMetab*MP2_CNMetab[Zone,SoilLayer]))ELSE(0)
    zonelayer_df$MP2_DecActMet <- ifelse(
      zonelayer_df$MP2_CNMetab > 0,
      zonelayer_df$MC2_MetabActF / (MC_EffMetab * zonelayer_df$MP2_CNMetab),
      0
    )
    
    # MP2_DemActMet_P[Zone,SoilLayer] = MC2_MetabActF[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[P])
    zonelayer_df$MP2_DemActMet_P <- zonelayer_df$MC2_MetabActF / (MN_CNAct *
                                                                    nut_df[nut_df$SlNut == "P", "MN_NutRatAct"])
    
    # MP2_MetabActF[Zone,SoilLayer] = MIN(MP2_DecActMet[Zone,SoilLayer],MP2_DemActMet_P[Zone,SoilLayer])
    zonelayer_df$MP2_MetabActF <- pmin(zonelayer_df$MP2_DecActMet,
                                       zonelayer_df$MP2_DemActMet_P)
    
    # MP2_DecActStP[Zone,SoilLayer] = MC2_StrucActF[Zone,SoilLayer]/(MC_EffStrucAct*MN_CNStruc*MN_NutRatStruc[P])
    zonelayer_df$MP2_DecActStP <- zonelayer_df$MC2_StrucActF / (MC_EffStrucAct * MN_CNStruc * nut_df[nut_df$SlNut == "P", "MN_NutRatStruc"])
    
    # MP2_DemActSt[Zone,SoilLayer] = MC2_StrucActF[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[P])
    zonelayer_df$MP2_DemActSt <- zonelayer_df$MC2_StrucActF / (MN_CNAct * nut_df[nut_df$SlNut == "P", "MN_NutRatAct"])
    
    # MP2_StrucActF[Zone,SoilLayer] = MIN(MP2_DecActStP[Zone,SoilLayer],MP2_DemActSt[Zone,SoilLayer])
    zonelayer_df$MP2_StrucActF <- pmin(zonelayer_df$MP2_DecActStP, zonelayer_df$MP2_DemActSt)
    
    # MP2_Act_SomTrans[Zn1,1] = (MN_Act_LitSomTrans[Zn1,P]-MP2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1])
    # MP2_Act_SomTrans[Zn1,2] = (0*MN_Act_LitSomTrans[Zn1,N]+MP2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1]-MP2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2])
    # MP2_Act_SomTrans[Zn1,3] = (0*MN_Act_LitSomTrans[Zn1,N]+MP2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2]-MP2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3])
    # MP2_Act_SomTrans[Zn1,4] = (0*MN_Act_LitSomTrans[Zn1,N]+MP2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3]-MP2_Act[Zn1,4]*MC2_Act_LayerTrans[Zn1,4])
    # MP2_Act_SomTrans[Zn2,1] = (MN_Act_LitSomTrans[Zn2,P]-MP2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1])
    # MP2_Act_SomTrans[Zn2,2] = (0*MN_Act_LitSomTrans[Zn2,N]+MP2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1]-MP2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2])
    # MP2_Act_SomTrans[Zn2,3] = (0*MN_Act_LitSomTrans[Zn2,N]+MP2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2]-MP2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3])
    # MP2_Act_SomTrans[Zn2,4] = (0*MN_Act_LitSomTrans[Zn2,N]+MP2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3]-MP2_Act[Zn2,4]*MC2_Act_LayerTrans[Zn2,4])
    # MP2_Act_SomTrans[Zn3,1] = (MN_Act_LitSomTrans[Zn3,P]-MP2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1])
    # MP2_Act_SomTrans[Zn3,2] = (0*MN_Act_LitSomTrans[Zn3,N]+MP2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1]-MP2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2])
    # MP2_Act_SomTrans[Zn3,3] = (0*MN_Act_LitSomTrans[Zn3,N]+MP2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2]-MP2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3])
    # MP2_Act_SomTrans[Zn3,4] = (0*MN_Act_LitSomTrans[Zn3,N]+MP2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3]-MP2_Act[Zn3,4]*MC2_Act_LayerTrans[Zn3,4])
    # MP2_Act_SomTrans[Zn4,1] = (MN_Act_LitSomTrans[Zn4,P]-MP2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1])
    # MP2_Act_SomTrans[Zn4,2] = (0*MN_Act_LitSomTrans[Zn4,N]+MP2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1]-MP2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2])
    # MP2_Act_SomTrans[Zn4,3] = (0*MN_Act_LitSomTrans[Zn4,N]+MP2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2]-MP2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3])
    # MP2_Act_SomTrans[Zn4,4] = (0*MN_Act_LitSomTrans[Zn4,N]+MP2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3]-MP2_Act[Zn4,4]*MC2_Act_LayerTrans[Zn4,4])
    zonelayer_df$MP2_Act_SomTrans <- NA
    zonelayer_df[zonelayer_df$layer == 1, "MP2_Act_SomTrans"] <- zonenut_df[zonenut_df$SlNut == "P", "MN_Act_LitSomTrans"] - zonelayer_df[zonelayer_df$layer == 1, "MP2_Act"] *
      zonelayercpools_df[zonelayercpools_df$layer == 1 &
                           zonelayercpools_df$CENT_Pools == "Actv", "MC2_LayerTrans"]
    zonelayer_df$MP2_Act_trans <- zonelayer_df$MP2_Act * zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Actv", "MC2_LayerTrans"]
    zonelayer_df[zonelayer_df$layer %in% c(2:4), "MP2_Act_SomTrans"] <- zonelayer_df[zonelayer_df$layer %in% c(1:3), "MP2_Act_trans"] - zonelayer_df[zonelayer_df$layer %in% c(2:4), "MP2_Act_trans"]
    
    # MP2_CNActAct[Zone,SoilLayer] = IF(TIME>1)THEN (if MP2_Act[Zone,SoilLayer]>0 then (MC2_Act[Zone,SoilLayer]/MP2_Act[Zone,SoilLayer])  else 100)  ELSE(MN_CNAct*MN_NutRatAct[P])
    zonelayer_df$MP2_CNActAct <- ifelse(
      time > 1,
      ifelse(
        zonelayer_df$MP2_Act > 0,
        zonelayer_df$MC2_Act / zonelayer_df$MP2_Act,
        100
      ),
      MN_CNAct * nut_df[nut_df$SlNut == "P", "MN_NutRatAct"]
    )
    
    # MP2_DecAct[Zone,SoilLayer] = MC2_ActSlw[Zone,SoilLayer]/(MC2_EffActSlw*MP2_CNActAct[Zone,SoilLayer])
    zonelayer_df$MP2_DecAct <- zonelayer_df$MC2_ActSlw / (MC2_EffActSlw * zonelayer_df$MP2_CNActAct)
    
    # MP2_ActSlw[Zone,SoilLayer] = MC2_ActSlw[Zone,SoilLayer]/(MN_CNSlw*MN_NutRatSlw[P])
    zonelayer_df$MP2_ActSlw <- zonelayer_df$MC2_ActSlw / (MN_CNSlw *
                                                            nut_df[nut_df$SlNut == "P", "MN_NutRatSlw"])
    
    # MP2_ActPass[Zone,SoilLayer] = MC2_ActPass[Zone,SoilLayer]/(MN_CNPass*MN_NutRatPas[P])
    zonelayer_df$MP2_ActPass <- zonelayer_df$MC2_ActPass / (MN_CNPass *
                                                              nut_df[nut_df$SlNut == "P", "MN_NutRatPas"])
    
    # MP2_ActMin[Zone,SoilLayer] = MIN(MAX(0,MP2_DecAct[Zone,SoilLayer]-MP2_ActSlw[Zone,SoilLayer]-MP2_ActPass[Zone,SoilLayer]),MP2_Act[Zone,SoilLayer])
    zonelayer_df$MP2_ActMin <- pmin(
      pmax(
        0,
        zonelayer_df$MP2_DecAct - zonelayer_df$MP2_ActSlw - zonelayer_df$MP2_ActPass
      ),
      zonelayer_df$MP2_Act
    )
    
    # MP2_ImmobAct[Zone,SoilLayer] = MIN(MN_MinNutpool[Zone,P],MAX(0,MP2_DemActMet_P[Zone,SoilLayer]-MP2_DecActMet[Zone,SoilLayer])+MAX(0,MP2_DemActSt[Zone,SoilLayer]-MP2_DecActStP[Zone,SoilLayer])+MAX(0,MP2_Act[Zone,SoilLayer]*MP2_CNActAct[Zone,SoilLayer]*(1/(MN_CNAct*MN_NutRatAct[P]) - 1/MP2_CNActAct[Zone,SoilLayer]) ))
    zonelayer_df$MP2_ImmobAct <- pmin(
      zonenut_df[zonenut_df$SlNut == "P", "MN_MinNutpool"],
      pmax(
        0,
        zonelayer_df$MP2_DemActMet_P - zonelayer_df$MP2_DecActMet
      )
      + pmax(0, zonelayer_df$MP2_DemActSt - zonelayer_df$MP2_DecActStP) +
        pmax(
          0,
          zonelayer_df$MP2_Act * zonelayer_df$MP2_CNActAct * (
            1 / (MN_CNAct * nut_df[nut_df$SlNut == "P", "MN_NutRatAct"]) - 1 /
              zonelayer_df$MP2_CNActAct
          )
        )
    )
    
    # MP2_MinDueToS&B[Zn1,1] = S&B_SOMBurnFrac[Zn1]
    # MP2_MinDueToS&B[Zn1,2] = 0*S&B_SOMBurnFrac[Zn1]
    # MP2_MinDueToS&B[Zn1,3] = 0*S&B_SOMBurnFrac[Zn1]
    # MP2_MinDueToS&B[Zn1,4] = 0*S&B_SOMBurnFrac[Zn1]
    # MP2_MinDueToS&B[Zn2,1] = S&B_SOMBurnFrac[Zn2]
    # MP2_MinDueToS&B[Zn2,2] = 0*S&B_SOMBurnFrac[Zn2]
    # MP2_MinDueToS&B[Zn2,3] = 0*S&B_SOMBurnFrac[Zn2]
    # MP2_MinDueToS&B[Zn2,4] = 0*S&B_SOMBurnFrac[Zn2]
    # MP2_MinDueToS&B[Zn3,1] = S&B_SOMBurnFrac[Zn3]
    # MP2_MinDueToS&B[Zn3,2] = 0*S&B_SOMBurnFrac[Zn3]
    # MP2_MinDueToS&B[Zn3,3] = 0*S&B_SOMBurnFrac[Zn3]
    # MP2_MinDueToS&B[Zn3,4] = 0*S&B_SOMBurnFrac[Zn3]
    # MP2_MinDueToS&B[Zn4,1] = S&B_SOMBurnFrac[Zn4]
    # MP2_MinDueToS&B[Zn4,2] = 0*S&B_SOMBurnFrac[Zn4]
    # MP2_MinDueToS&B[Zn4,3] = 0*S&B_SOMBurnFrac[Zn4]
    # MP2_MinDueToS&B[Zn4,4] = 0*S&B_SOMBurnFrac[Zn4]
    zonelayer_df$MP2_MinDueToSB <- 0
    zonelayer_df[zonelayer_df$layer == 1, "MP2_MinDueToSB"] <- zone_df$SB_SOMBurnFrac
    
    # MP2_ActMinF[Zone,SoilLayer] = IF (MP2_ActMin[Zone,SoilLayer]-MP2_ImmobAct[Zone,SoilLayer]+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Act[Zone,SoilLayer])>0 THEN MIN((MP2_ActMin[Zone,SoilLayer]+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Act[Zone,SoilLayer]-MP2_ImmobAct[Zone,SoilLayer]),MP2_Act[Zone,SoilLayer]) ELSE IF (MP2_ActMin[Zone,SoilLayer]-MP2_ImmobAct[Zone,SoilLayer]+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Act[Zone,SoilLayer])=0 THEN 0 ELSE -MIN(ABS(MP2_ActMin[Zone,SoilLayer]-MP2_ImmobAct[Zone,SoilLayer] +MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Act[Zone,SoilLayer]),MP2_MinNutpool[Zone,SoilLayer])
    zonelayer_df$MP2_ActMinF_a <- zonelayer_df$MP2_ActMin - zonelayer_df$MP2_ImmobAct + zonelayer_df$MP2_MinDueToSB * zonelayer_df$MP2_Act
    zonelayer_df$MP2_ActMinF <- ifelse (
      zonelayer_df$MP2_ActMinF_a > 0,
      pmin((
        zonelayer_df$MP2_ActMin + zonelayer_df$MP2_MinDueToSB * zonelayer_df$MP2_Act -
          zonelayer_df$MP2_ImmobAct
      ),
      zonelayer_df$MP2_Act
      ),
      ifelse (
        zonelayer_df$MP2_ActMinF_a == 0,
        0,
        -pmin(
          abs(zonelayer_df$MP2_ActMinF_a),
          zonelayer_df$MP2_MinNutpool
        )
      )
    )
    
    # MP2_PassAct[Zone,SoilLayer] = MC2_PassAct[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[P])
    zonelayer_df$MP2_PassAct <- zonelayer_df$MC2_PassAct / (MN_CNAct * nut_df[nut_df$SlNut == "P", "MN_NutRatAct"])
    
    # MP2_ActPassF[Zone,SoilLayer] = MAX(0,MP2_ActPass[Zone,SoilLayer])-MAX(0,MP2_PassAct[Zone,SoilLayer])
    zonelayer_df$MP2_ActPassF <- pmax(0, zonelayer_df$MP2_ActPass) - pmax(0, zonelayer_df$MP2_PassAct)
    
    # MP2_SlwAct[Zone,SoilLayer] = MC2_SlwAct[Zone,SoilLayer]/(MN_CNAct*MN_NutRatAct[P])
    zonelayer_df$MP2_SlwAct <- zonelayer_df$MC2_SlwAct / (MN_CNAct * nut_df[nut_df$SlNut == "P", "MN_NutRatAct"])
    
    # MP2_ActSlwF[Zone,SoilLayer] = MAX(0,MP2_ActSlw[Zone,SoilLayer])-MAX(0,MP2_SlwAct[Zone,SoilLayer])
    zonelayer_df$MP2_ActSlwF <- pmax(0, zonelayer_df$MP2_ActSlw) - pmax(0, zonelayer_df$MP2_SlwAct)
    
    # MP2_StrucIn[Zone,SoilLayer] = IF(MP2_OrgInpRtP[Zone,SoilLayer]>10^-7)THEN(MC2_StrucIn[Zone,SoilLayer]/(MN_CNStruc*MN_NutRatStruc[P]))ELSE(0)
    zonelayer_df$MP2_StrucIn <- ifelse(
      zonelayer_df$MP2_OrgInpRtP > 10^-7,
      zonelayer_df$MC2_StrucIn / (MN_CNStruc * nut_df[nut_df$SlNut == "P", "MN_NutRatStruc"]),
      0
    )
    
    # MP2_MetabIn[Zone,SoilLayer] = MP2_OrgInpRtP[Zone,SoilLayer]-MP2_StrucIn[Zone,SoilLayer]
    zonelayer_df$MP2_MetabIn <- zonelayer_df$MP2_OrgInpRtP - zonelayer_df$MP2_StrucIn
    
    # MP2_Met_SomTrans[Zn1,1] = (MN_Met_LitSomTrans[Zn1,P]-MP2_Metab[Zn1,1]*MC2_Met_LayerTrans[Zn1,1])
    # MP2_Met_SomTrans[Zn1,2] = (0*MN_Met_LitSomTrans[Zn1,N]+MP2_Metab[Zn1,1]*MC2_Met_LayerTrans[Zn1,1]-MP2_Metab[Zn1,2]*MC2_Met_LayerTrans[Zn1,2])
    # MP2_Met_SomTrans[Zn1,3] = (0*MN_Met_LitSomTrans[Zn1,N]+MP2_Metab[Zn1,2]*MC2_Met_LayerTrans[Zn1,2]-MP2_Metab[Zn1,3]*MC2_Met_LayerTrans[Zn1,3])
    # MP2_Met_SomTrans[Zn1,4] = (0*MN_Met_LitSomTrans[Zn1,N]+MP2_Metab[Zn1,3]*MC2_Met_LayerTrans[Zn1,3]-MP2_Metab[Zn1,4]*MC2_Met_LayerTrans[Zn1,4])
    # MP2_Met_SomTrans[Zn2,1] = (MN_Met_LitSomTrans[Zn2,P]-MP2_Metab[Zn2,1]*MC2_Met_LayerTrans[Zn2,1])
    # MP2_Met_SomTrans[Zn2,2] = (0*MN_Met_LitSomTrans[Zn2,N]+MP2_Metab[Zn2,1]*MC2_Met_LayerTrans[Zn2,1]-MP2_Metab[Zn2,2]*MC2_Met_LayerTrans[Zn2,2])
    # MP2_Met_SomTrans[Zn2,3] = (0*MN_Met_LitSomTrans[Zn2,N]+MP2_Metab[Zn2,2]*MC2_Met_LayerTrans[Zn2,2]-MP2_Metab[Zn2,3]*MC2_Met_LayerTrans[Zn2,3])
    # MP2_Met_SomTrans[Zn2,4] = (0*MN_Met_LitSomTrans[Zn2,N]+MP2_Metab[Zn2,3]*MC2_Met_LayerTrans[Zn2,3]-MP2_Metab[Zn2,4]*MC2_Met_LayerTrans[Zn2,4])
    # MP2_Met_SomTrans[Zn3,1] = (MN_Met_LitSomTrans[Zn3,P]-MP2_Metab[Zn3,1]*MC2_Met_LayerTrans[Zn3,1])
    # MP2_Met_SomTrans[Zn3,2] = (0*MN_Met_LitSomTrans[Zn3,N]+MP2_Metab[Zn3,1]*MC2_Met_LayerTrans[Zn3,1]-MP2_Metab[Zn3,2]*MC2_Met_LayerTrans[Zn3,2])
    # MP2_Met_SomTrans[Zn3,3] = (0*MN_Met_LitSomTrans[Zn3,N]+MP2_Metab[Zn3,2]*MC2_Met_LayerTrans[Zn3,2]-MP2_Metab[Zn3,3]*MC2_Met_LayerTrans[Zn3,3])
    # MP2_Met_SomTrans[Zn3,4] = (0*MN_Met_LitSomTrans[Zn3,N]+MP2_Metab[Zn3,3]*MC2_Met_LayerTrans[Zn3,3]-MP2_Metab[Zn3,4]*MC2_Met_LayerTrans[Zn3,4])
    # MP2_Met_SomTrans[Zn4,1] = (MN_Met_LitSomTrans[Zn4,P]-MP2_Metab[Zn4,1]*MC2_Met_LayerTrans[Zn4,1])
    # MP2_Met_SomTrans[Zn4,2] = (0*MN_Met_LitSomTrans[Zn4,N]+MP2_Metab[Zn4,1]*MC2_Met_LayerTrans[Zn4,1]-MP2_Metab[Zn4,2]*MC2_Met_LayerTrans[Zn4,2])
    # MP2_Met_SomTrans[Zn4,3] = (0*MN_Met_LitSomTrans[Zn4,N]+MP2_Metab[Zn4,2]*MC2_Met_LayerTrans[Zn4,2]-MP2_Metab[Zn4,3]*MC2_Met_LayerTrans[Zn4,3])
    # MP2_Met_SomTrans[Zn4,4] = (0*MN_Met_LitSomTrans[Zn4,N]+MP2_Metab[Zn4,3]*MC2_Met_LayerTrans[Zn4,3]-MP2_Metab[Zn4,4]*MC2_Met_LayerTrans[Zn4,4])
    
    # MP2_Str_SomTrans[Zn1,1] = (MN_Str_LitSomTrans[Zn1,P]-MP2_Struc[Zn1,1]*MC2_Struc_LayerTrans[Zn1,1])
    # MP2_Str_SomTrans[Zn1,2] = (0*MN_Str_LitSomTrans[Zn1,N]+MP2_Struc[Zn1,1]*MC2_Struc_LayerTrans[Zn1,1]-MP2_Struc[Zn1,2]*MC2_Struc_LayerTrans[Zn1,2])
    # MP2_Str_SomTrans[Zn1,3] = (0*MN_Str_LitSomTrans[Zn1,N]+MP2_Struc[Zn1,2]*MC2_Struc_LayerTrans[Zn1,2]-MP2_Struc[Zn1,3]*MC2_Struc_LayerTrans[Zn1,3])
    # MP2_Str_SomTrans[Zn1,4] = (0*MN_Str_LitSomTrans[Zn1,N]+MP2_Struc[Zn1,3]*MC2_Struc_LayerTrans[Zn1,3]-MP2_Struc[Zn1,4]*MC2_Struc_LayerTrans[Zn1,4])
    # MP2_Str_SomTrans[Zn2,1] = (MN_Str_LitSomTrans[Zn2,P]-MP2_Struc[Zn2,1]*MC2_Struc_LayerTrans[Zn2,1])
    # MP2_Str_SomTrans[Zn2,2] = (0*MN_Str_LitSomTrans[Zn2,N]+MP2_Struc[Zn2,1]*MC2_Struc_LayerTrans[Zn2,1]-MP2_Struc[Zn2,2]*MC2_Struc_LayerTrans[Zn2,2])
    # MP2_Str_SomTrans[Zn2,3] = (0*MN_Str_LitSomTrans[Zn2,N]+MP2_Struc[Zn2,2]*MC2_Struc_LayerTrans[Zn2,2]-MP2_Struc[Zn2,3]*MC2_Struc_LayerTrans[Zn2,3])
    # MP2_Str_SomTrans[Zn2,4] = (0*MN_Str_LitSomTrans[Zn2,N]+MP2_Struc[Zn2,3]*MC2_Struc_LayerTrans[Zn2,3]-MP2_Struc[Zn2,4]*MC2_Struc_LayerTrans[Zn2,4])
    # MP2_Str_SomTrans[Zn3,1] = (MN_Str_LitSomTrans[Zn3,P]-MP2_Struc[Zn3,1]*MC2_Struc_LayerTrans[Zn3,1])
    # MP2_Str_SomTrans[Zn3,2] = (0*MN_Str_LitSomTrans[Zn3,N]+MP2_Struc[Zn3,1]*MC2_Struc_LayerTrans[Zn3,1]-MP2_Struc[Zn3,2]*MC2_Struc_LayerTrans[Zn3,2])
    # MP2_Str_SomTrans[Zn3,3] = (0*MN_Str_LitSomTrans[Zn3,N]+MP2_Struc[Zn3,2]*MC2_Struc_LayerTrans[Zn3,2]-MP2_Struc[Zn3,3]*MC2_Struc_LayerTrans[Zn3,3])
    # MP2_Str_SomTrans[Zn3,4] = (0*MN_Str_LitSomTrans[Zn3,N]+MP2_Struc[Zn3,3]*MC2_Struc_LayerTrans[Zn3,3]-MP2_Struc[Zn3,4]*MC2_Struc_LayerTrans[Zn3,4])
    # MP2_Str_SomTrans[Zn4,1] = (MN_Str_LitSomTrans[Zn4,P]-MP2_Struc[Zn4,1]*MC2_Struc_LayerTrans[Zn4,1])
    # MP2_Str_SomTrans[Zn4,2] = (0*MN_Str_LitSomTrans[Zn4,N]+MP2_Struc[Zn4,1]*MC2_Struc_LayerTrans[Zn4,1]-MP2_Struc[Zn4,2]*MC2_Struc_LayerTrans[Zn4,2])
    # MP2_Str_SomTrans[Zn4,3] = (0*MN_Str_LitSomTrans[Zn4,N]+MP2_Struc[Zn4,2]*MC2_Struc_LayerTrans[Zn4,2]-MP2_Struc[Zn4,3]*MC2_Struc_LayerTrans[Zn4,3])
    # MP2_Str_SomTrans[Zn4,4] = (0*MN_Str_LitSomTrans[Zn4,N]+MP2_Struc[Zn4,3]*MC2_Struc_LayerTrans[Zn4,3]-MP2_Struc[Zn4,4]*MC2_Struc_LayerTrans[Zn4,4])
    
    # MP2_Act_SomTrans[Zn1,1] = (MN_Act_LitSomTrans[Zn1,P]-MP2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1])
    # MP2_Act_SomTrans[Zn1,2] = (0*MN_Act_LitSomTrans[Zn1,N]+MP2_Act[Zn1,1]*MC2_Act_LayerTrans[Zn1,1]-MP2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2])
    # MP2_Act_SomTrans[Zn1,3] = (0*MN_Act_LitSomTrans[Zn1,N]+MP2_Act[Zn1,2]*MC2_Act_LayerTrans[Zn1,2]-MP2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3])
    # MP2_Act_SomTrans[Zn1,4] = (0*MN_Act_LitSomTrans[Zn1,N]+MP2_Act[Zn1,3]*MC2_Act_LayerTrans[Zn1,3]-MP2_Act[Zn1,4]*MC2_Act_LayerTrans[Zn1,4])
    # MP2_Act_SomTrans[Zn2,1] = (MN_Act_LitSomTrans[Zn2,P]-MP2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1])
    # MP2_Act_SomTrans[Zn2,2] = (0*MN_Act_LitSomTrans[Zn2,N]+MP2_Act[Zn2,1]*MC2_Act_LayerTrans[Zn2,1]-MP2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2])
    # MP2_Act_SomTrans[Zn2,3] = (0*MN_Act_LitSomTrans[Zn2,N]+MP2_Act[Zn2,2]*MC2_Act_LayerTrans[Zn2,2]-MP2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3])
    # MP2_Act_SomTrans[Zn2,4] = (0*MN_Act_LitSomTrans[Zn2,N]+MP2_Act[Zn2,3]*MC2_Act_LayerTrans[Zn2,3]-MP2_Act[Zn2,4]*MC2_Act_LayerTrans[Zn2,4])
    # MP2_Act_SomTrans[Zn3,1] = (MN_Act_LitSomTrans[Zn3,P]-MP2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1])
    # MP2_Act_SomTrans[Zn3,2] = (0*MN_Act_LitSomTrans[Zn3,N]+MP2_Act[Zn3,1]*MC2_Act_LayerTrans[Zn3,1]-MP2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2])
    # MP2_Act_SomTrans[Zn3,3] = (0*MN_Act_LitSomTrans[Zn3,N]+MP2_Act[Zn3,2]*MC2_Act_LayerTrans[Zn3,2]-MP2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3])
    # MP2_Act_SomTrans[Zn3,4] = (0*MN_Act_LitSomTrans[Zn3,N]+MP2_Act[Zn3,3]*MC2_Act_LayerTrans[Zn3,3]-MP2_Act[Zn3,4]*MC2_Act_LayerTrans[Zn3,4])
    # MP2_Act_SomTrans[Zn4,1] = (MN_Act_LitSomTrans[Zn4,P]-MP2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1])
    # MP2_Act_SomTrans[Zn4,2] = (0*MN_Act_LitSomTrans[Zn4,N]+MP2_Act[Zn4,1]*MC2_Act_LayerTrans[Zn4,1]-MP2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2])
    # MP2_Act_SomTrans[Zn4,3] = (0*MN_Act_LitSomTrans[Zn4,N]+MP2_Act[Zn4,2]*MC2_Act_LayerTrans[Zn4,2]-MP2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3])
    # MP2_Act_SomTrans[Zn4,4] = (0*MN_Act_LitSomTrans[Zn4,N]+MP2_Act[Zn4,3]*MC2_Act_LayerTrans[Zn4,3]-MP2_Act[Zn4,4]*MC2_Act_LayerTrans[Zn4,4])
    
    # MP2_Slw_SomTrans[Zn1,1] = (MN_Slw_LitSomTrans[Zn1,P]-MP2_Slw[Zn1,1]*MC2_Slow_LayerTrans[Zn1,1])
    # MP2_Slw_SomTrans[Zn1,2] = (0*MN_Slw_LitSomTrans[Zn1,N]+MP2_Slw[Zn1,1]*MC2_Slow_LayerTrans[Zn1,1]-MP2_Slw[Zn1,2]*MC2_Slow_LayerTrans[Zn1,2])
    # MP2_Slw_SomTrans[Zn1,3] = (0*MN_Slw_LitSomTrans[Zn1,N]+MP2_Slw[Zn1,2]*MC2_Slow_LayerTrans[Zn1,2]-MP2_Slw[Zn1,3]*MC2_Slow_LayerTrans[Zn1,3])
    # MP2_Slw_SomTrans[Zn1,4] = (0*MN_Slw_LitSomTrans[Zn1,N]+MP2_Slw[Zn1,3]*MC2_Slow_LayerTrans[Zn1,3]-MP2_Slw[Zn1,4]*MC2_Slow_LayerTrans[Zn1,4])
    # MP2_Slw_SomTrans[Zn2,1] = (MN_Slw_LitSomTrans[Zn2,P]-MP2_Slw[Zn2,1]*MC2_Slow_LayerTrans[Zn2,1])
    # MP2_Slw_SomTrans[Zn2,2] = (0*MN_Slw_LitSomTrans[Zn2,N]+MP2_Slw[Zn2,1]*MC2_Slow_LayerTrans[Zn2,1]-MP2_Slw[Zn2,2]*MC2_Slow_LayerTrans[Zn2,2])
    # MP2_Slw_SomTrans[Zn2,3] = (0*MN_Slw_LitSomTrans[Zn2,N]+MP2_Slw[Zn2,2]*MC2_Slow_LayerTrans[Zn2,2]-MP2_Slw[Zn2,3]*MC2_Slow_LayerTrans[Zn2,3])
    # MP2_Slw_SomTrans[Zn2,4] = (0*MN_Slw_LitSomTrans[Zn2,N]+MP2_Slw[Zn2,3]*MC2_Slow_LayerTrans[Zn2,3]-MP2_Slw[Zn2,4]*MC2_Slow_LayerTrans[Zn2,4])
    # MP2_Slw_SomTrans[Zn3,1] = (MN_Slw_LitSomTrans[Zn3,P]-MP2_Slw[Zn3,1]*MC2_Slow_LayerTrans[Zn3,1])
    # MP2_Slw_SomTrans[Zn3,2] = (0*MN_Slw_LitSomTrans[Zn3,N]+MP2_Slw[Zn3,1]*MC2_Slow_LayerTrans[Zn3,1]-MP2_Slw[Zn3,2]*MC2_Slow_LayerTrans[Zn3,2])
    # MP2_Slw_SomTrans[Zn3,3] = (0*MN_Slw_LitSomTrans[Zn3,N]+MP2_Slw[Zn3,2]*MC2_Slow_LayerTrans[Zn3,2]-MP2_Slw[Zn3,3]*MC2_Slow_LayerTrans[Zn3,3])
    # MP2_Slw_SomTrans[Zn3,4] = (0*MN_Slw_LitSomTrans[Zn3,N]+MP2_Slw[Zn3,3]*MC2_Slow_LayerTrans[Zn3,3]-MP2_Slw[Zn3,4]*MC2_Slow_LayerTrans[Zn3,4])
    # MP2_Slw_SomTrans[Zn4,1] = (MN_Slw_LitSomTrans[Zn4,P]-MP2_Slw[Zn4,1]*MC2_Slow_LayerTrans[Zn4,1])
    # MP2_Slw_SomTrans[Zn4,2] = (0*MN_Slw_LitSomTrans[Zn4,N]+MP2_Slw[Zn4,1]*MC2_Slow_LayerTrans[Zn4,1]-MP2_Slw[Zn4,2]*MC2_Slow_LayerTrans[Zn4,2])
    # MP2_Slw_SomTrans[Zn4,3] = (0*MN_Slw_LitSomTrans[Zn4,N]+MP2_Slw[Zn4,2]*MC2_Slow_LayerTrans[Zn4,2]-MP2_Slw[Zn4,3]*MC2_Slow_LayerTrans[Zn4,3])
    # MP2_Slw_SomTrans[Zn4,4] = (0*MN_Slw_LitSomTrans[Zn4,N]+MP2_Slw[Zn4,3]*MC2_Slow_LayerTrans[Zn4,3]-MP2_Slw[Zn4,4]*MC2_Slow_LayerTrans[Zn4,4])
    
    # MP2_Pas_SomTrans[Zn1,1] = (MN_Pas_LitSomTrans[Zn1,P]-MP2_Pass[Zn1,1]*MC2_Pass_LayerTrans[Zn1,1])
    # MP2_Pas_SomTrans[Zn1,2] = (0*MN_Pas_LitSomTrans[Zn1,P]+MP2_Pass[Zn1,1]*MC2_Pass_LayerTrans[Zn1,1]-MP2_Pass[Zn1,2]*MC2_Pass_LayerTrans[Zn1,2])
    # MP2_Pas_SomTrans[Zn1,3] = (0*MN_Pas_LitSomTrans[Zn1,P]+MP2_Pass[Zn1,2]*MC2_Pass_LayerTrans[Zn1,2]-MP2_Pass[Zn1,3]*MC2_Pass_LayerTrans[Zn1,3])
    # MP2_Pas_SomTrans[Zn1,4] = (0*MN_Pas_LitSomTrans[Zn1,P]+MP2_Pass[Zn1,3]*MC2_Pass_LayerTrans[Zn1,3]-MP2_Pass[Zn1,4]*MC2_Pass_LayerTrans[Zn1,4])
    # MP2_Pas_SomTrans[Zn2,1] = (MN_Pas_LitSomTrans[Zn2,P]-MP2_Pass[Zn2,1]*MC2_Pass_LayerTrans[Zn2,1])
    # MP2_Pas_SomTrans[Zn2,2] = (0*MN_Pas_LitSomTrans[Zn2,P]+MP2_Pass[Zn2,1]*MC2_Pass_LayerTrans[Zn2,1]-MP2_Pass[Zn2,2]*MC2_Pass_LayerTrans[Zn2,2])
    # MP2_Pas_SomTrans[Zn2,3] = (0*MN_Pas_LitSomTrans[Zn2,P]+MP2_Pass[Zn2,2]*MC2_Pass_LayerTrans[Zn2,2]-MP2_Pass[Zn2,3]*MC2_Pass_LayerTrans[Zn2,3])
    # MP2_Pas_SomTrans[Zn2,4] = (0*MN_Pas_LitSomTrans[Zn2,P]+MP2_Pass[Zn2,3]*MC2_Pass_LayerTrans[Zn2,3]-MP2_Pass[Zn2,4]*MC2_Pass_LayerTrans[Zn2,4])
    # MP2_Pas_SomTrans[Zn3,1] = (MN_Pas_LitSomTrans[Zn3,P]-MP2_Pass[Zn3,1]*MC2_Pass_LayerTrans[Zn3,1])
    # MP2_Pas_SomTrans[Zn3,2] = (0*MN_Pas_LitSomTrans[Zn3,P]+MP2_Pass[Zn3,1]*MC2_Pass_LayerTrans[Zn3,1]-MP2_Pass[Zn3,2]*MC2_Pass_LayerTrans[Zn3,2])
    # MP2_Pas_SomTrans[Zn3,3] = (0*MN_Pas_LitSomTrans[Zn3,P]+MP2_Pass[Zn3,2]*MC2_Pass_LayerTrans[Zn3,2]-MP2_Pass[Zn3,3]*MC2_Pass_LayerTrans[Zn3,3])
    # MP2_Pas_SomTrans[Zn3,4] = (0*MN_Pas_LitSomTrans[Zn3,P]+MP2_Pass[Zn3,3]*MC2_Pass_LayerTrans[Zn3,3]-MP2_Pass[Zn3,4]*MC2_Pass_LayerTrans[Zn3,4])
    # MP2_Pas_SomTrans[Zn4,1] = (MN_Pas_LitSomTrans[Zn4,P]-MP2_Pass[Zn4,1]*MC2_Pass_LayerTrans[Zn4,1])
    # MP2_Pas_SomTrans[Zn4,2] = (0*MN_Pas_LitSomTrans[Zn4,P]+MP2_Pass[Zn4,1]*MC2_Pass_LayerTrans[Zn4,1]-MP2_Pass[Zn4,2]*MC2_Pass_LayerTrans[Zn4,2])
    # MP2_Pas_SomTrans[Zn4,3] = (0*MN_Pas_LitSomTrans[Zn4,P]+MP2_Pass[Zn4,2]*MC2_Pass_LayerTrans[Zn4,2]-MP2_Pass[Zn4,3]*MC2_Pass_LayerTrans[Zn4,3])
    # MP2_Pas_SomTrans[Zn4,4] = (0*MN_Pas_LitSomTrans[Zn4,P]+MP2_Pass[Zn4,3]*MC2_Pass_LayerTrans[Zn4,3]-MP2_Pass[Zn4,4]*MC2_Pass_LayerTrans[Zn4,4])
    zonelayercpools_df$MP2_cpools <- c(
      zonelayer_df$MP2_Metab,
      zonelayer_df$MP2_Struc,
      zonelayer_df$MP2_Act,
      zonelayer_df$MP2_Slw,
      zonelayer_df$MP2_Pass
    )
    zonelayercpools_df$MP2_cpools_Layer <- zonelayercpools_df$MP2_cpools * zonelayercpools_df$MC2_LayerTrans
    zn_P <- zonenut_df[zonenut_df$SlNut == "P", c("MN_Met_LitSomTrans",
                                                  "MN_Str_LitSomTrans",
                                                  "MN_Act_LitSomTrans",
                                                  "MN_Slw_LitSomTrans",
                                                  "MN_Pas_LitSomTrans")]
    zonecpools_df$MN_LitSomTrans_P <- c(
      zn_P$MN_Met_LitSomTrans,
      zn_P$MN_Str_LitSomTrans,
      zn_P$MN_Act_LitSomTrans,
      zn_P$MN_Slw_LitSomTrans,
      zn_P$MN_Pas_LitSomTrans
    )
    
    zonelayercpools_df$MP2_SomTrans <- NA
    zonelayercpools_df[zonelayercpools_df$layer == 1, "MP2_SomTrans"] <- zonecpools_df$MN_LitSomTrans_P - zonelayercpools_df[zonelayer_df$layer == 1, "MP2_cpools_Layer"]
    zonelayercpools_df[zonelayercpools_df$layer %in% c(2:4), "MP2_SomTrans"] <- zonelayercpools_df[zonelayercpools_df$layer %in% c(1:3), "MP2_cpools_Layer"] - zonelayercpools_df[zonelayercpools_df$layer %in% c(2:4), "MP2_cpools_Layer"]
    
    # MP_MetabMinF[Zone,SoilLayer] = MP2_DecActMet[Zone,SoilLayer]-MP2_MetabActF[Zone,SoilLayer]+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Metab[Zone,SoilLayer]
    zonelayer_df$Mp_MetabMinF <- zonelayer_df$MP2_DecActMet - zonelayer_df$MP2_MetabActF +
      zonelayer_df$MP2_MinDueToSB * zonelayer_df$MP2_Metab
    
    # MP2_CPSlwAct[Zone,SoilLayer] = IF(TIME>1)THEN(MC2_Slw[Zone,SoilLayer]/MP2_Slw[Zone,SoilLayer])ELSE(MN_CNSlw*MN_NutRatSlw[P])
    zonelayer_df$MP2_CPSlwAct <- ifelse(
      time > 1,
      zonelayer_df$MC2_Slw / zonelayer_df$MP2_Slw,
      MN_CNSlw * nut_df[nut_df$SlNut == "P", "MN_NutRatSlw"]
    )
    
    # MP2_DecSlw[Zone,SoilLayer] = IF (MC_EffSlwPass*MP2_CPSlwAct[Zone,SoilLayer])>0 THEN MC2_SlwPassF[Zone,SoilLayer]/(MC_EffSlwPass*MP2_CPSlwAct[Zone,SoilLayer]) ELSE 0
    zonelayer_df$MP2_DecSlw <- ifelse(
      MC_EffSlwPass * zonelayer_df$MP2_CPSlwAct > 0,
      zonelayer_df$MC2_SlwPassF / (MC_EffSlwPass * zonelayer_df$MP2_CPSlwAct),
      0
    )
    
    # MP2_SlwPassF[Zone,SoilLayer] = MC2_SlwPassF[Zone,SoilLayer]/(MN_CNPass*MN_NutRatPas[P])
    zonelayer_df$MP2_SlwPassF <- zonelayer_df$MC2_SlwPassF / (MN_CNPass *
                                                                nut_df[nut_df$SlNut == "P", "MN_NutRatPas"])
    
    # MP2_SlwMin[Zone,SoilLayer] = MAX(0,MP2_DecSlw[Zone,SoilLayer]-MP2_SlwAct[Zone,SoilLayer]-MP2_SlwPassF[Zone,SoilLayer])
    zonelayer_df$MP2_SlwMin <- pmax(
      0,
      zonelayer_df$MP2_DecSlw - zonelayer_df$MP2_SlwAct - zonelayer_df$MP2_SlwPassF
    )
    
    # MP2_DemStrucSlw[Zone,SoilLayer] = MC2_StrucSlwF[Zone,SoilLayer]/(MN_CNSlw*MN_NutRatSlw[P])
    zonelayer_df$MP2_DemStrucSlw <- zonelayer_df$MC2_StrucSlwF / (MN_CNSlw * nut_df[nut_df$SlNut == "P", "MN_NutRatSlw"])
    
    # MP2_DecStrucSlw[Zone,SoilLayer] = MC2_StrucSlwF[Zone,SoilLayer]/(MC_EffStrucSlw*MN_CNStruc*MN_NutRatStruc[P])
    zonelayer_df$MP2_DecStrucSlw <- zonelayer_df$MC2_StrucSlwF / (MC_EffStrucSlw * MN_CNStruc *
                                                                    nut_df[nut_df$SlNut == "P", "MN_NutRatStruc"])
    
    # MP2_ImmobStrucSlw[Zone,SoilLayer] = MIN(MN_MinNutpool[Zone,P]-MP2_ImmobAct[Zone,SoilLayer],MAX(0,MP2_DemStrucSlw[Zone,SoilLayer]-MP2_DecStrucSlw[Zone,SoilLayer])+MAX(0, MP2_Slw[Zone,SoilLayer]*MP2_CPSlwAct[Zone,SoilLayer]*(1/(MN_CNSlw*MN_NutRatSlw[P]) - 1/MP2_CPSlwAct[Zone,SoilLayer]) ))
    zonelayer_df$MN_MinNutpool <- rep(zonenut_df[zonenut_df$SlNut == "P", "MN_MinNutpool"], nlayer)
    zonelayer_df$MP2_ImmobStrucSlw <-
      pmin(
        zonelayer_df$MN_MinNutpool - zonelayer_df$MP2_ImmobAct,
        pmax(
          0,
          zonelayer_df$MP2_DemStrucSlw - zonelayer_df$MP2_DecStrucSlw
        ) +
          pmax(
            0,
            zonelayer_df$MP2_Slw * zonelayer_df$MP2_CPSlwAct * (
              1 / (MN_CNSlw * nut_df[nut_df$SlNut == "P", "MN_NutRatSlw"]) - 1 /
                zonelayer_df$MP2_CPSlwAct
            )
          )
      )
    
    # MP2_SlwMinF[Zone,SoilLayer] = (MP2_SlwMin[Zone,SoilLayer]-MP2_ImmobStrucSlw[Zone,SoilLayer])+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Slw[Zone,SoilLayer]
    zonelayer_df$MP2_SlwMinF <- (zonelayer_df$MP2_SlwMin - zonelayer_df$MP2_ImmobStrucSlw) +
      zonelayer_df$MP2_MinDueToSB * zonelayer_df$MP2_Slw
    
    # MP2_DecPass[Zone,SoilLayer] = MC2_PassAct[Zone,SoilLayer]*(MC_EffPass*MN_CNPass*MN_NutRatPas[P])
    zonelayer_df$MP2_DecPass <- zonelayer_df$MC2_PassAct * (MC_EffPass * MN_CNPass * nut_df[nut_df$SlNut == "P", "MN_NutRatPas"])
    
    # MP2_PassMinF[Zone,SoilLayer] = MP2_DecPass[Zone,SoilLayer]-MP2_PassAct[Zone,SoilLayer]+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Pass[Zone,SoilLayer]
    zonelayer_df$MP2_PassMinF <- zonelayer_df$MP2_DecPass - zonelayer_df$MP2_PassAct +
      zonelayer_df$MP2_MinDueToSB * zonelayer_df$MP2_Pass
    
    # MP2_StrucSlwF[Zone,SoilLayer] = MIN(MP2_DecStrucSlw[Zone,SoilLayer],MP2_DemStrucSlw[Zone,SoilLayer])
    zonelayer_df$MP2_StrucSlwF <- pmin(zonelayer_df$MP2_DecStrucSlw,
                                       zonelayer_df$MP2_DemStrucSlw)
    
    # MP2_StrucMinF[Zone,SoilLayer] = (MP2_DecStrucSlw[Zone,SoilLayer]-MP2_StrucSlwF[Zone,SoilLayer])+(MP2_DecActStP[Zone,SoilLayer]-MP2_StrucActF[Zone,SoilLayer])+MP2_MinDueToS&B[Zone,SoilLayer]*MP2_Struc[Zone,SoilLayer]
    zonelayer_df$MP2_StrucMinF <- (zonelayer_df$MP2_DecStrucSlw - zonelayer_df$MP2_StrucSlwF) +
      (zonelayer_df$MP2_DecActStP - zonelayer_df$MP2_StrucActF) + zonelayer_df$MP2_MinDueToSB *
      zonelayer_df$MP2_Struc
    
    # MP2_OrgP_Leaching[Zone] = MP2_Metab[Zone,4]*MC2_Met_LayerTrans[Zone,4]+MP2_Struc[Zone,4]*MC2_Struc_LayerTrans[Zone,4]+MP2_Act[Zone,4]*MC2_Act_LayerTrans[Zone,4]+MP2_Slw[Zone,4]*MC2_Slow_LayerTrans[Zone,4]+MP2_Pass[Zone,4]*MC2_Pass_LayerTrans[Zone,4]
    zone_df$MP2_OrgP_Leaching <- aggregate(
      zonelayercpools_df[zonelayercpools_df$layer == 4, ]$MP2_cpools * zonelayercpools_df[zonelayercpools_df$layer == 4, ]$MC2_LayerTrans,
      zonecpools_df["zone"],
      sum
    )[[2]]
    
    # N_AtmInp[SlNut] = N_AtmosphDepos[SlNut]
    nut_df$N_AtmInp <- nut_df$N_AtmosphDepos
    
    # N_LatInFlow1[SlNut] = N_Lat4NutInflow1[SlNut]*AF_LatInFlowRatio[Zn4]
    # N_LatInFlow2[SlNut] = N_Lat4NutInflow2[SlNut]*AF_LatInFlowRatio[Zn4]
    # N_LatInFlow3[SlNut] = N_Lat4NutInflow3[SlNut]*AF_LatInFlowRatio[Zn4]
    # N_LatInFlow4[SlNut] = N_Lat4NutInflow4[SlNut]*AF_LatInFlowRatio[Zn4]
    layernut_df$N_LatInFlow <- layernut_df$N_Lat4NutInflow * zone_df[zone_df$zone == 4, "AF_LatInFlowRatio"]
    
    
    #TODO: the if part doesn't haave logic statement
    # N15_Cupt1[Zone] = If N_Stock1[Zone,N]> 0 then N_CUpt1[Zone,N]*N15_Stock1[Zone]/N_Stock1[Zone,N] else 0
    # N15_Cupt2[Zone] = if N_Stock2[Zone,N] then N_CUpt2[Zone,N]*N15_Stock2[Zone]/N_Stock2[Zone,N] else 0
    # N15_Cupt3[Zone] = if N_Stock3[Zone,N] then N_CUpt3[Zone,N]*N15_Stock3[Zone]/N_Stock3[Zone,N] else 0
    # N15_Cupt4[Zone] = if N_Stock4[Zone,N] then N_CUpt4[Zone,N]*N15_Stock4[Zone]/N_Stock4[Zone,N] else 0
    zln_N <- zonelayernut_df[zonelayernut_df$SlNut == "N", ]
    zonelayer_df$N15_Cupt <- ifelse(zln_N$N_Stock > 0,
                                    zln_N$N_CUpt * zonelayer_df$N15_Stock / zln_N$N_Stock,
                                    0)
    
    # N15_C_Incr[Zone] = N15_Cupt1[Zone]+N15_Cupt2[Zone]+N15_Cupt3[Zone]+N15_Cupt4[Zone]
    zone_df$N15_C_Incr <- aggregate(zonelayer_df$N15_Cupt, zonelayer_df["zone"], sum)[[2]]
    
    # N15_C_StLvIncr[Zone] = if C_GroRes[Zone,N]>0 then C_StLeafInc[Zone,N]*N15_C_GroRes[Zone]/C_GroRes[Zone,N] else 0
    zp_N <- zonepcomp_df[zonepcomp_df$PlantComp == "N", ]
    zone_df$N15_C_StLvIncr <- ifelse(zp_N$C_GroRes > 0,
                                     zp_N$C_StLeafInc * zone_df$N15_C_GroRes / zp_N$C_GroRes,
                                     0)
    
    # N15_C_RtIncr[Zone] = if C_GroRes[Zone,N]>0 then C_RootGrowth[Zone,N]*N15_C_GroRes[Zone]/C_GroRes[Zone,N] else 0
    zone_df$N15_C_RtIncr <- ifelse(zp_N$C_GroRes > 0,
                                   zp_N$C_RootGrowth * zone_df$N15_C_GroRes / zp_N$C_GroRes,
                                   0)
    
    # N15_C_FrtInc[Zone] = if C_GroRes[Zone,N]>0 then C_YieldInc[Zone,N]*N15_C_GroRes[Zone]/C_GroRes[Zone,N] else 0
    zone_df$N15_C_FrtInc <- ifelse(zp_N$C_GroRes > 0,
                                   zp_N$C_YieldInc * zone_df$N15_C_GroRes / zp_N$C_GroRes,
                                   0)
    
    # N15_C_residlast[Zone] = if C_GroRes[Zone,N]>0 then C_ResidLast[Zone,N]*N15_C_GroRes[Zone]/C_GroRes[Zone,N] else 0
    zone_df$N15_C_residlast <- ifelse(zp_N$C_GroRes > 0,
                                      zp_N$C_ResidLast * zone_df$N15_C_GroRes / zp_N$C_GroRes,
                                      0)
    
    # N15_C_FruitLoss[Zone] = if C_YieldCurr[Zone,N]>0 then C_FruitLoss[Zone,N]*N15_C_YieldCurr[Zone]/C_YieldCurr[Zone,N] else 0
    zone_df$N15_C_FruitLoss <- ifelse(
      zp_N$C_YieldCurr > 0,
      zp_N$C_FruitLoss * zone_df$N15_C_YieldCurr / zp_N$C_YieldCurr,
      0
    )
    
    # N15_C_StLvMulch[Zone] = if C_BiomStLv[Zone,N]>0 then C_StLeaveMulch[Zone,N]*N15_C_StLv[Zone]/C_BiomStLv[Zone,N] else 0
    zone_df$N15_C_StLvMulch <- ifelse(zp_N$C_BiomStLv > 0,
                                      zp_N$C_StLeaveMulch * zone_df$N15_C_StLv / zp_N$C_BiomStLv,
                                      0)
    
    # N15_ResidMulch[Zone] = N15_C_FruitLoss[Zone]+N15_C_residlast[Zone]+N15_C_StLvMulch[Zone]
    zone_df$N15_ResidMulch <- zone_df$N15_C_FruitLoss + zone_df$N15_C_residlast + zone_df$N15_C_StLvMulch
    
    # N15_C_RtDec[Zone] = if ARRAYSUM(C_Root_N[Zone,*])>0 then ARRAYSUM(C_RtDecay_N[Zone,*])*N15_C_Root[Zone]/ARRAYSUM(C_Root_N[Zone,*]) else 0
    zone_df$C_Root_N <- aggregate(zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "N", "C_Root"], zonelayer_df["zone"], sum)[[2]]
    zone_df$N15_C_RtDec <- ifelse(
      zone_df$C_Root_N > 0 ,
      aggregate(zonelayerpcomp_df[zonelayerpcomp_df$PlantComp == "N", "C_RtDecay"], zonelayer_df["zone"], sum)[[2]] * zone_df$N15_C_Root /
        zone_df$C_Root_N,
      0
    )
    
    # N15_C_Resid[Zone] = if C_BiomStLv[Zone,N]>0 then C_Resid[Zone,N]*N15_C_StLv[Zone]/C_BiomStLv[Zone,N] else 0
    zone_df$N15_C_Resid <- ifelse(zp_N$C_BiomStLv > 0,
                                  zp_N$C_Resid * zone_df$N15_C_StLv / zp_N$C_BiomStLv,
                                  0)
    
    # N15_C_Yield[Zone] = if C_YieldCurr[Zone,N]>0 then C_Yield[Zone,N]*N15_C_YieldCurr[Zone]/C_YieldCurr[Zone,N] else 0
    zone_df$N15_C_Yield <- ifelse(zp_N$C_YieldCurr > 0,
                                  zp_N$C_Yield * zone_df$N15_C_YieldCurr / zp_N$C_YieldCurr,
                                  0)
    
    # N15_WeedSeedFall[Zone] = if C_YieldCurr[Zone,N]>0 then C_WeedSeedFall[Zone,N]*N15_C_YieldCurr[Zone]/C_YieldCurr[Zone,N] else 0
    zone_df$N15_WeedSeedFall <- ifelse(
      zp_N$C_YieldCurr > 0,
      zp_N$C_WeedSeedFall * zone_df$N15_C_YieldCurr / zp_N$C_YieldCurr,
      0
    )
    
    # N15_T1Upt1[Zone] = if N_Stock1[Zone,N]>0 then N_T1Upt1[Zone,N]*N15_Stock1[Zone]/N_Stock1[Zone,N] else 0
    # N15_T2Upt1[Zone] = if N_Stock1[Zone,N] then N_T2Upt1[Zone,N]*N15_Stock1[Zone]/N_Stock1[Zone,N] else 0
    # N15_T3Upt1[Zone] = if N_Stock1[Zone,N] then N_T3Upt1[Zone,N]*N15_Stock1[Zone]/N_Stock1[Zone,N] else 0
    # N15_T1Upt2[Zone] = if N_Stock2[Zone,N] then N_T1Upt2[Zone,N]*N15_Stock2[Zone]/N_Stock2[Zone,N] else 0
    # N15_T2Upt2[Zone] = if N_Stock2[Zone,N] then N_T2Upt2[Zone,N]*N15_Stock2[Zone]/N_Stock2[Zone,N] else 0
    # N15_T3Upt2[Zone] = if N_Stock2[Zone,N] then N_T3Upt2[Zone,N]*N15_Stock2[Zone]/N_Stock2[Zone,N] else 0
    # N15_T1Upt3[Zone] = if N_Stock3[Zone,N] then N_T1Upt3[Zone,N]*N15_Stock3[Zone]/N_Stock3[Zone,N] else 0
    # N15_T2Upt3[Zone] = if N_Stock3[Zone,N] then N_T2Upt3[Zone,N]*N15_Stock3[Zone]/N_Stock3[Zone,N] else 0
    # N15_T3Upt3[Zone] = if N_Stock3[Zone,N] then N_T3Upt3[Zone,N]*N15_Stock3[Zone]/N_Stock3[Zone,N] else 0
    # N15_T1Upt4[Zone] = if N_Stock4[Zone,N] then N_T1Upt4[Zone,N]*N15_Stock4[Zone]/N_Stock4[Zone,N] else 0
    # N15_T2Upt4[Zone] = if N_Stock4[Zone,N] then N_T2Upt4[Zone,N]*N15_Stock4[Zone]/N_Stock4[Zone,N] else 0
    # N15_T3Upt4[Zone] = if N_Stock4[Zone,N] then N_T3Upt4[Zone,N]*N15_Stock4[Zone]/N_Stock4[Zone,N] else 0
    zonelayertree_df$N15_Upt <- ifelse(
      rep(zln_N$N_Stock, ntree) > 0,
      zonelayertreenut_df[zonelayertreenut_df$SlNut == "N", ]$N_Upt * rep(zonelayer_df$N15_Stock, ntree) /
        rep(zln_N$N_Stock, ntree),
      0
    )
    
    # N15_T_CanIncr[Tree] = if T_GroRes[N,Tree]>0 then T_CanBiomInc[N,Tree]*N15_T_GroRes[Tree]/T_GroRes[N,Tree] else 0
    tp_N <- treepcomp_df[treepcomp_df$PlantComp == "N", ]
    tree_df$N15_T_CanIncr <- ifelse(tp_N$T_GroRes > 0,
                                    tp_N$T_CanBiomInc * tree_df$N15_T_GroRes / tp_N$T_GroRes,
                                    0)
    
    # N15_T_WdInc[Tree] = if T_LfTwig[N,Tree]>0 then T_WoodInc[N,Tree]*N15_T_Can[Tree]/T_LfTwig[N,Tree] else 0
    tree_df$N15_T_WdInc <- ifelse(tp_N$T_LfTwig > 0,
                                  tp_N$T_WoodInc * tree_df$N15_T_Can / tp_N$T_LfTwig,
                                  0)
    
    # N15_T_CanExp[Tree] = if T_LfTwig[N,Tree]>0 then (T_CanBiomSlashed[N,Tree]+T_CanBiomTimHarv[N,Tree]+T_Herbivory[N,Tree]+T_LifallInc[N,Tree]+T_Prun[N,Tree])*N15_T_Can[Tree]/T_LfTwig[N,Tree] else 0
    tree_df$N15_T_CanExp <- ifelse(
      tp_N$T_LfTwig > 0,
      (
        tp_N$T_CanBiomSlashed + tp_N$T_CanBiomTimHarv + tp_N$T_Herbivory + tp_N$T_LifallInc + tp_N$T_Prun
      ) * tree_df$N15_T_Can / tp_N$T_LfTwig,
      0
    )
    
    # N15_T_FruitIncr[Tree] = if T_GroRes[N,Tree]>0 then T_FruitInc[N,Tree]*N15_T_GroRes[Tree]/T_GroRes[N,Tree] else 0
    tree_df$N15_T_FruitIncr <- ifelse(tp_N$T_GroRes > 0,
                                      tp_N$T_FruitInc * tree_df$N15_T_GroRes / tp_N$T_GroRes,
                                      0)
    
    # N15_T_FrtExp[Tree] = if T_Fruit[N,Tree]>0 then (T_Frug_and_Littfall[N,Tree]+T_FruitSlashed[N,Tree]+T_PrunFruit[N,Tree]+T_RipeFruitHarvest[N,Tree])*N15_T_Fruit[Tree]/T_Fruit[N,Tree] else 0
    tree_df$N15_T_FrtExp <- ifelse(
      tp_N$T_Fruit > 0,
      (
        tp_N$T_Frug_and_Littfall + tp_N$T_FruitSlashed + tp_N$T_PrunFruit + tp_N$T_RipeFruitHarvest
      ) * tree_df$N15_T_Fruit / tp_N$T_Fruit,
      0
    )
    
    # N15_T1UptTot = AF_ZoneFrac[Zn1]*(N15_T1Upt1[Zn1]+N15_T1Upt2[Zn1]+N15_T1Upt3[Zn1]+N15_T1Upt4[Zn1])+AF_ZoneFrac[Zn2]*(N15_T1Upt1[Zn2]+N15_T1Upt2[Zn2]+N15_T1Upt3[Zn2]+N15_T1Upt4[Zn2])+AF_ZoneFrac[Zn3]*(N15_T1Upt1[Zn3]+N15_T1Upt2[Zn3]+N15_T1Upt3[Zn3]+N15_T1Upt4[Zn3])+AF_ZoneFrac[Zn4]*(N15_T1Upt1[Zn4]+N15_T1Upt2[Zn4]+N15_T1Upt3[Zn4]+N15_T1Upt4[Zn4])
    # N15_T2UptTot = AF_ZoneFrac[Zn1]*(N15_T2Upt2[Zn1]+N15_T2Upt2[Zn1]+N15_T2Upt3[Zn1]+N15_T2Upt4[Zn1])+AF_ZoneFrac[Zn2]*(N15_T2Upt1[Zn2]+N15_T2Upt2[Zn2]+N15_T2Upt3[Zn2]+N15_T2Upt4[Zn2])+AF_ZoneFrac[Zn3]*(N15_T2Upt1[Zn3]+N15_T2Upt2[Zn3]+N15_T2Upt3[Zn3]+N15_T2Upt4[Zn3])+AF_ZoneFrac[Zn4]*(N15_T2Upt1[Zn4]+N15_T2Upt2[Zn4]+N15_T2Upt3[Zn4]+N15_T2Upt4[Zn4])
    # N15_T3UptTot = AF_ZoneFrac[Zn1]*(N15_T3Upt1[Zn1]+N15_T3Upt2[Zn1]+N15_T3Upt3[Zn1]+N15_T3Upt4[Zn1])+AF_ZoneFrac[Zn2]*(N15_T3Upt1[Zn2]+N15_T3Upt2[Zn2]+N15_T3Upt3[Zn2]+N15_T3Upt4[Zn2])+AF_ZoneFrac[Zn3]*(N15_T3Upt1[Zn3]+N15_T3Upt2[Zn3]+N15_T3Upt3[Zn3]+N15_T3Upt4[Zn3])+AF_ZoneFrac[Zn4]*(N15_T3Upt1[Zn4]+N15_T3Upt2[Zn4]+N15_T3Upt3[Zn4]+N15_T3Upt4[Zn4])
    zonetree_df$N15_Upt_sum <- zonetree_df$AF_ZoneFrac *  aggregate(zonelayertree_df["N15_Upt"], zonelayertree_df[c("zone", "tree_id")], sum)$N15_Upt
    tree_df$N15_UptTot <- aggregate(zonetree_df$N15_Upt_sum, zonetree_df["tree_id"], sum)[[2]]
    
    # N15_T_UptTot[Sp1] = N15_T1UptTot+0*(N15_T2UptTot+N15_T3UptTot)
    # N15_T_UptTot[Sp2] = N15_T2UptTot+0*(N15_T1UptTot+N15_T3UptTot)
    # N15_T_UptTot[Sp3] = N15_T3UptTot+0*(N15_T2UptTot+N15_T1UptTot)
    tree_df$N15_T_UptTot <- tree_df$N15_UptTot
    
    # N15_T_RtInc[Tree] = if T_GroRes[N,Tree] > 0 then T_RootInc[N,Tree]*N15_T_GroRes[Tree]/T_GroRes[N,Tree] else 0
    tree_df$N15_T_RtInc <- ifelse(tp_N$T_GroRes > 0,
                                  tp_N$T_RootInc * tree_df$N15_T_GroRes / tp_N$T_GroRes,
                                  0)
    
    # N15_T_GroResLoss[Tree] = if T_GroRes[N,Tree]>0 then T_GroResLoss[N,Tree]*N15_T_GroRes[Tree]/T_GroRes[N,Tree] else 0
    tree_df$N15_T_GroResLoss <- ifelse(tp_N$T_GroRes > 0,
                                       tp_N$T_GroResLoss * tree_df$N15_T_GroRes / tp_N$T_GroRes,
                                       0)
    
    # T_RootNdecay[Sp1] = AF_ZoneFrac[Zn1]*(T_Root_T1_Ndecay[Zn1,1]+T_Root_T1_Ndecay[Zn1,2]+T_Root_T1_Ndecay[Zn1,3]+T_Root_T1_Ndecay[Zn1,4])+AF_ZoneFrac[Zn2]*(T_Root_T1_Ndecay[Zn2,1]+T_Root_T1_Ndecay[Zn2,2]+T_Root_T1_Ndecay[Zn2,3]+T_Root_T1_Ndecay[Zn2,4])+AF_ZoneFrac[Zn3]*(T_Root_T1_Ndecay[Zn3,1]+T_Root_T1_Ndecay[Zn3,2]+T_Root_T1_Ndecay[Zn3,3]+T_Root_T1_Ndecay[Zn3,4])+AF_ZoneFrac[Zn4]*(T_Root_T1_Ndecay[Zn4,1]+T_Root_T1_Ndecay[Zn4,2]+T_Root_T1_Ndecay[Zn4,3]+T_Root_T1_Ndecay[Zn4,4])+0*(T_Root_T1_Ndecay[Zn1,1]+T_Root_T2_Ndecay[Zn1,1]+T_Root_T3_Ndecay[Zn1,1])
    # T_RootNdecay[Sp2] = AF_ZoneFrac[Zn1]*(T_Root_T2_Ndecay[Zn1,1]+T_Root_T2_Ndecay[Zn1,2]+T_Root_T2_Ndecay[Zn1,3]+T_Root_T2_Ndecay[Zn1,4])+AF_ZoneFrac[Zn2]*(T_Root_T2_Ndecay[Zn2,1]+T_Root_T2_Ndecay[Zn2,2]+T_Root_T2_Ndecay[Zn2,3]+T_Root_T2_Ndecay[Zn2,4])+AF_ZoneFrac[Zn3]*(T_Root_T2_Ndecay[Zn3,1]+T_Root_T2_Ndecay[Zn3,2]+T_Root_T2_Ndecay[Zn3,3]+T_Root_T2_Ndecay[Zn3,4])+AF_ZoneFrac[Zn4]*(T_Root_T2_Ndecay[Zn4,1]+T_Root_T2_Ndecay[Zn4,2]+T_Root_T2_Ndecay[Zn4,3]+T_Root_T2_Ndecay[Zn4,4])+0*(T_Root_T1_Ndecay[Zn1,1]+T_Root_T2_Ndecay[Zn1,1]+T_Root_T3_Ndecay[Zn1,1])
    # T_RootNdecay[Sp3] = AF_ZoneFrac[Zn1]*(T_Root_T3_Ndecay[Zn1,1]+T_Root_T3_Ndecay[Zn1,2]+T_Root_T3_Ndecay[Zn1,3]+T_Root_T3_Ndecay[Zn1,4])+AF_ZoneFrac[Zn2]*(T_Root_T3_Ndecay[Zn2,1]+T_Root_T3_Ndecay[Zn2,2]+T_Root_T3_Ndecay[Zn2,3]+T_Root_T3_Ndecay[Zn2,4])+AF_ZoneFrac[Zn3]*(T_Root_T3_Ndecay[Zn3,1]+T_Root_T3_Ndecay[Zn3,2]+T_Root_T3_Ndecay[Zn3,3]+T_Root_T3_Ndecay[Zn3,4])+AF_ZoneFrac[Zn4]*(T_Root_T3_Ndecay[Zn4,1]+T_Root_T3_Ndecay[Zn4,2]+T_Root_T3_Ndecay[Zn4,3]+T_Root_T3_Ndecay[Zn4,4])+0*(T_Root_T1_Ndecay[Zn1,1]+T_Root_T2_Ndecay[Zn1,1]+T_Root_T3_Ndecay[Zn1,1])
    zonetree_df$T_Root_decay_N_sum <- zonetree_df$AF_ZoneFrac * aggregate(zonelayertreepcomp_df[zonelayertreepcomp_df$PlantComp == "N", "T_Root_decay"],
                                                                          zonelayertree_df[c("zone", "tree_id")],
                                                                          sum)[[3]]
    tree_df$T_RootNdecay <- aggregate(zonetree_df$T_Root_decay_N_sum, zonetree_df["tree_id"], sum)[[2]]
    
    # N15_T_RtDec[Tree] = if T_RootNtot[Tree]>0 then T_RootNdecay[Tree]*N15_T_Rt[Tree]/T_RootNtot[Tree] else 0
    tree_df$N15_T_RtDec <- ifelse(tp_N$T_RootTot > 0,
                                  tree_df$T_RootNdecay * tree_df$N15_T_Rt / tp_N$T_RootTot,
                                  0)
    
    # N15_T_WdExp[Tree] = if T_SapWood[N,Tree]>0 then (T_Lignovory[N,Tree]+T_WoodHarvest[N,Tree]+T_WoodSlashed[N,Tree])*N15_T_Wd[Tree]/T_SapWood[N,Tree] else 0
    tree_df$N15_T_WdExp <- ifelse(
      tp_N$T_SapWood > 0,
      (tp_N$T_Lignovory + tp_N$T_WoodHarvest + tp_N$T_WoodSlashed) * tree_df$N15_T_Wd /
        tp_N$T_SapWood,
      0
    )
    
    # P_CCostExtOrg[PriceType] = 10*CA_ExtOrg[1]*P_CostExtOrg[1,PriceType]+10*CA_ExtOrg[2]*P_CostExtOrg[2,PriceType]
    price_df$P_CCostExtOrg <- aggregate(rep(inp_df$CA_ExtOrg, nrow(price_df)) * inpprice_df$P_CostExtOrg,
                                        inpprice_df["PriceType"],
                                        sum)$x
    
    # P_CCostFert[PriceType] = 10*CA_FertN[N]*P_PriceFert[N,PriceType]+10*CA_FertN[P]*P_PriceFert[P,PriceType]
    nutprice_df$CA_FertN <- rep(nut_df$CA_FertN, nrow(price_df))
    price_df$P_CCostFert <- aggregate(10 * nutprice_df$CA_FertN * nutprice_df$P_PriceFert,
                                      nutprice_df["PriceType"],
                                      sum)$x
    
    # P_Weed&PestTime[Zone] = IF(CQ_Stage[Zone]=1)THEN(1)ELSE(0)
    zone_df$P_Weed_PestTime <- ifelse(zone_df$CQ_Stage == 1, 1, 0)
    
    # P_CCostPestWeedCont[PriceType] = P_CPestContPrice[PriceType]*(AF_ZoneFrac[Zn1]*P_Weed&PestTime[Zn1]+AF_ZoneFrac[Zn2]*P_Weed&PestTime[Zn2]+AF_ZoneFrac[Zn3]*P_Weed&PestTime[Zn3]+AF_ZoneFrac[Zn4]*P_Weed&PestTime[Zn4])
    price_df$P_CCostPestWeedCont <- price_df$P_CPestContPrice * sum(zone_df$AF_ZoneFrac *
                                                                      zone_df$P_Weed_PestTime)
    
    # P_CCostSeedZn[PriceType,Zone] = IF TIME=(int(CA_PlantTime[Zone])) and C_GrowsToday? = 1 and  P_PrevCropOK? = 1 then C_Init[Zone,DW]*P_PriceCSeed[PriceType,Zone]*10000 else 0
    zoneprice_df$CA_PlantTime <- rep(zone_df$CA_PlantTime, nrow(price_df))
    zoneprice_df$C_GrowsToday_is <- AF_Crop_is
    zoneprice_df$P_PrevCropOK_is <- P_PrevCropOK_is
    zoneprice_df$C_Init_DW <- rep(zonepcomp_df[zonepcomp_df$PlantComp == "DW", "C_Init"], nrow(price_df))
    zoneprice_df$P_CCostSeedZn <- ifelse(
      time == floor(zoneprice_df$CA_PlantTime) &
        zoneprice_df$C_GrowsToday_is == 1 &
        zoneprice_df$P_PrevCropOK_is == 1 ,
      zoneprice_df$C_Init_DW * zoneprice_df$P_PriceCSeed *
        10000,
      0
    )
    
    # P_CCostSeed[PriceType] = AF_ZoneFrac[Zn1]*P_CCostSeedZn[PriceType,Zn1]+AF_ZoneFrac[Zn2]*P_CCostSeedZn[PriceType,Zn2]+AF_ZoneFrac[Zn3]*P_CCostSeedZn[PriceType,Zn3]+AF_ZoneFrac[Zn4]*P_CCostSeedZn[PriceType,Zn4]
    zoneprice_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, nrow(price_df))
    price_df$P_CCostSeed <- aggregate(zoneprice_df$AF_ZoneFrac * zoneprice_df$P_CCostSeedZn,
                                      zoneprice_df["PriceType"],
                                      sum)$x
    
    # P_CCostInp[PriceType] = P_CCostExtOrg[PriceType]+P_CCostFert[PriceType]+P_CCostPestWeedCont[PriceType]+P_CCostSeed[PriceType]
    price_df$P_CCostInp <- price_df$P_CCostExtOrg + price_df$P_CCostFert + price_df$P_CCostPestWeedCont + price_df$P_CCostSeed
    
    # P_CPlantLabourZn[Zone] = IF(TIME=(int(CA_PlantTime[Zone]))) and  P_PrevCropOK? =  1 THEN P_CPlantLab[Zone] else 0
    zone_df$P_CPlantLabourZn <- ifelse(time == floor(zone_df$CA_PlantTime) &
                                         P_PrevCropOK_is ==  1,
                                       zone_df$P_CPlantLab,
                                       0)
    
    # P_CPlantLabour = (AF_ZoneFrac[Zn1]*P_CPlantLabourZn[Zn1]+AF_ZoneFrac[Zn2]*P_CPlantLabourZn[Zn2]+AF_ZoneFrac[Zn3]*P_CPlantLabourZn[Zn3]+AF_ZoneFrac[Zn4]*P_CPlantLabourZn[Zn4])
    P_CPlantLabour <- sum(zone_df$AF_ZoneFrac * zone_df$P_CPlantLabourZn)
    
    # P_CPestConLabZn[Zone] = if P_LabourforPestContrl? = 1 and P_Weed&PestTime[Zone] = 1 and  P_PrevCropOK? =  1 then P_CPestConLab[Zone] else 0
    zone_df$P_CPestConLabZn <- ifelse(
      P_LabourforPestContrl_is == 1 &
        zone_df$P_Weed_PestTime == 1 &
        P_PrevCropOK_is ==  1,
      zone_df$P_CPestConLab,
      0
    )
    
    # P_CPestConLabour = AF_ZoneFrac[Zn1]*P_CPestConLabZn[Zn1]+AF_ZoneFrac[Zn2]*P_CPestConLabZn[Zn2]+AF_ZoneFrac[Zn3]*P_CPestConLabZn[Zn3]+AF_ZoneFrac[Zn4]*P_CPestConLabZn[Zn4]
    P_CPestConLabour <- sum(zone_df$AF_ZoneFrac * zone_df$P_CPestConLabZn)
    
    # P_CWeedLabZn[Zone] = if P_LabourforWeed? = 1 and P_Weed&PestTime[Zone] =1 and  P_PrevCropOK? =  1 then P_CWeedLab[Zone] ELSE 0
    zone_df$P_CWeedLabZn <- ifelse(
      P_LabourforWeed_is == 1 &
        zone_df$P_Weed_PestTime == 1 &
        P_PrevCropOK_is ==  1,
      zone_df$P_CWeedLab,
      0
    )
    
    # P_CWeedLabour = AF_ZoneFrac[Zn1]*P_CWeedLabZn[Zn1]+AF_ZoneFrac[Zn2]*P_CWeedLabZn[Zn2]+AF_ZoneFrac[Zn3]*P_CWeedLabZn[Zn3]+AF_ZoneFrac[Zn4]*P_CWeedLabZn[Zn4]
    P_CWeedLabour <- sum(zone_df$AF_ZoneFrac * zone_df$P_CWeedLabZn)
    
    # P_CHarvLabourperType[Cr] = (C_AgYieldAcc[Zn1,Cr]*AF_ZoneFrac[Zn1]*P_CHarvLab[Zn1]+C_AgYieldAcc[Zn2,Cr]*AF_ZoneFrac[Zn2]*P_CHarvLab[Zn2]+C_AgYieldAcc[Zn3,Cr]*AF_ZoneFrac[Zn3]*P_CHarvLab[Zn3]+C_AgYieldAcc[Zn4,Cr]*AF_ZoneFrac[Zn4]*P_CHarvLab[Zn4])*10
    zonecrop_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, each = nrow(crop_df))
    zonecrop_df$P_CHarvLab <- rep(zone_df$P_CHarvLab, each = nrow(crop_df))
    crop_df$P_CHarvLabourperType <- aggregate(
      zonecrop_df$C_AgYieldAcc * zonecrop_df$AF_ZoneFrac * zonecrop_df$P_CHarvLab,
      zonecrop_df["crop_id"],
      sum
    )$x * 10
    
    # P_CHarvLabour = P_CHarvLabourperType[Type1]+P_CHarvLabourperType[Type2]+P_CHarvLabourperType[Type3]+P_CHarvLabourperType[Type4]+P_CHarvLabourperType[Type5]
    P_CHarvLabour <- sum(crop_df$P_CHarvLabourperType)
    
    # P_CFertLabourZn[Zone] = if CA_FertApp = 1 and  P_PrevCropOK? =  1 and C_GrowsToday? = 1 and C_PlantDiesToday?[Zone]=0 and CA_FertAmount[Zone] > 0 then P_CNuFertAppperCropSeason*P_CFertLab[Zone] else 0
    zone_df$P_CFertLabourZn <- ifelse(
      CA_FertApp == 1 &
        P_PrevCropOK_is ==  1 &
        AF_Crop_is == 1 &
        zone_df$C_PlantDiesToday_is == 0 &
        zone_df$CA_FertAmount > 0,
      P_CNuFertAppperCropSeason * zone_df$P_CFertLab[Zone],
      0
    )
    
    # P_CFertLabour = AF_ZoneFrac[Zn1]*P_CFertLabourZn[Zn1]+AF_ZoneFrac[Zn2]*P_CFertLabourZn[Zn2]+AF_ZoneFrac[Zn3]*P_CFertLabourZn[Zn3]+AF_ZoneFrac[Zn4]*P_CFertLabourZn[Zn4]
    P_CFertLabour <- sum(zone_df$AF_ZoneFrac * zone_df$P_CFertLabourZn)
    
    # P_CCostLab[PriceType] = P_UnitLabCost[PriceType]*(P_CPlantLabour+P_CPestConLabour+P_CWeedLabour+P_CHarvLabour+P_CFertLabour)*C_GrowsToday?
    price_df$P_CCostLab <- price_df$P_UnitLabCost * (P_CPlantLabour + P_CPestConLabour +
                                                       P_CWeedLabour + P_CHarvLabour + P_CFertLabour) * AF_Crop_is
    
    # P_CCosts[PriceType] = P_CCostInp[PriceType]+P_CCostLab[PriceType]
    price_df$P_CCosts <- price_df$P_CCostInp + price_df$P_CCostLab
    
    # P_CCostsInc[PriceType] = P_CCosts[PriceType]
    price_df$P_CCostsInc <- price_df$P_CCosts
    
    # P_CReturnperType[PriceType,Cr] = (C_AgYieldAcc[Zn1,Cr]*AF_ZoneFrac[Zn1]*P_CYieldPrice[PriceType,Zn1]+C_AgYieldAcc[Zn2,Cr]*AF_ZoneFrac[Zn2]*P_CYieldPrice[PriceType,Zn2]+C_AgYieldAcc[Zn3,Cr]*AF_ZoneFrac[Zn3]*P_CYieldPrice[PriceType,Zn3]+C_AgYieldAcc[Zn4,Cr]*AF_ZoneFrac[Zn4]*P_CYieldPrice[PriceType,Zn4])*10000
    zonecropprice_df$C_AgYieldAcc <- rep(zonecrop_df$C_AgYieldAcc, nrow(price_df))
    zonecropprice_df$AF_ZoneFrac <- rep(zone_df$AF_ZoneFrac, each = nrow(crop_df) * nrow(price_df))
    zonecropprice_df$P_CYieldPrice <- c(
      rep(zoneprice_df[zoneprice_df$PriceType == "Private", ]$P_CYieldPrice, each = nrow(crop_df)),
      rep(zoneprice_df[zoneprice_df$PriceType == "Social", ]$P_CYieldPrice, each = nrow(crop_df))
    )
    cropprice_df$P_CReturnperType <-  aggregate(
      zonecropprice_df$C_AgYieldAcc * zonecropprice_df$AF_ZoneFrac * zonecropprice_df$P_CYieldPrice,
      zonecropprice_df[c("crop_id", "PriceType")],
      sum
    )$x * 10000
    
    # P_CReturn[PriceType] = P_CReturnperType[PriceType,Type1]+P_CReturnperType[PriceType,Type2]+P_CReturnperType[PriceType,Type3]+P_CReturnperType[PriceType,Type4]+P_CReturnperType[PriceType,Type5]
    price_df$P_CReturn <- aggregate(cropprice_df$P_CReturnperType, cropprice_df["PriceType"], sum)$x
    
    # P_CReturnInc[PriceType] = P_CReturn[PriceType]
    price_df$P_CReturnInc <- price_df$P_CReturn
    
    # P_CropHarvest = if ARRAYSUM(CA_CropSequen[*]) >= 1 and ARRAYSUM(CQ_CropWeedSwitch[*]) <> 4*CQ_WeedType then 1 else 0
    P_CropHarvest <- ifelse(
      sum(zone_df$CA_CropSequen) >= 1 &
        sum(zone_df$CQ_CropWeedSwitch) != 4 * CQ_WeedType,
      1,
      0
    )
    
    # PD_FenceBuildDoY = GRAPH(PD_FencePast)
    PD_FenceBuildDoY <- get_y_df(PD_FencePast, "PD_FenceBuildDoY")
    
    # PD_FenceBuildY = GRAPH(PD_FencePast)
    PD_FenceBuildY <- get_y_df(PD_FencePast, "PD_FenceBuildY")
    
    # PD_FenceTime = PD_FenceBuildDoY+365*(PD_FenceBuildY)-CA_DOYStart
    PD_FenceTime <- PD_FenceBuildDoY + 365 * (PD_FenceBuildY) - CA_DOYStart
    
    # PD_FenceBuildLabSeq = GRAPH(PD_FencePast)
    PD_FenceBuildLabSeq <- get_y_df(PD_FencePast, "PD_FenceBuildLabSeq")
    
    # PD_FenceBuildLab = if PD_FenceMaint?= 1 and PD_FenceQ<PD_FenceQThresh and T_CropinField? = 1 then PD_FenceMUnit*PD_HalfFenceTime else if PD_FenceTime = 1 then PD_FenceBuildLabSeq else 0
    PD_FenceBuildLab <- ifelse(
      PD_FenceMaint_is == 1 &
        PD_FenceQ < PD_FenceQThresh &
        T_CropinField_is == 1,
      PD_FenceMUnit * PD_HalfFenceTime,
      ifelse(PD_FenceTime == 1, PD_FenceBuildLabSeq, 0)
    )
    
    # P_TPlantLabourTree[Tree] = if (INT(T_PlantTime[Tree])=TIME) then P_TPlantLab[Tree]*T_Treesperha[Tree]*T_GrowsToday?[Tree] else 0
    tree_df$P_TPlantLabourTree <- ifelse(
      floor(tree_df$T_PlantTime) == time,
      tree_df$P_TPlantLab * tree_df$T_Treesperha * tree_df$T_GrowsToday_is,
      0
    )
    
    # P_TPlantLabour = P_TPlantLabourTree[Sp1]+P_TPlantLabourTree[Sp2]+P_TPlantLabourTree[Sp3]
    P_TPlantLabour <- sum(tree_df$P_TPlantLabourTree)
    
    # T_FreshPrun[Tree] = (T_Prun[DW,Tree]/(1-T_PrunMoistFrac[Tree]))
    tree_df$T_FreshPrun <- tree_df$T_Prun_DW / (1 - tree_df$T_PrunMoistFrac)
    
    # P_TPrunLabourTree[Tree] = IF T_FreshPrun[Tree]>0 THEN P_TPrunLab[Tree]*T_FreshPrun[Tree]*10000 else 0
    tree_df$P_TPrunLabourTree <- ifelse(tree_df$T_FreshPrun > 0,
                                        tree_df$P_TPrunLab * tree_df$T_FreshPrun * 10000,
                                        0)
    
    # P_TPrunLabour = P_TPrunLabourTree[Sp1]+P_TPrunLabourTree[Sp2]+P_TPrunLabourTree[Sp3]
    P_TPrunLabour <- sum(tree_df$P_TPrunLabourTree)
    
    # T_FreshWoodHarv[Tree] = (T_WoodHarvest[DW,Tree]/(1-T_WoodMoistFrac[Tree]))
    tree_df$T_FreshWoodHarv <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_WoodHarvest"] /
      (1 - tree_df$T_WoodMoistFrac)
    
    # P_TWoodHarvLabourTree[Tree] = if T_FreshWoodHarv[Tree]>0 then P_TWoodHarvLab[Tree]*T_FreshWoodHarv[Tree]*T_GrowsToday?[Tree]*10000 else 0
    tree_df$P_TWoodHarvLabourTree <- ifelse(
      tree_df$T_FreshWoodHarv > 0,
      tree_df$P_TWoodHarvLab * tree_df$T_FreshWoodHarv * tree_df$T_GrowsToday_is *
        10000,
      0
    )
    
    # P_TWoodHarvLabour = P_TWoodHarvLabourTree[Sp1]+P_TWoodHarvLabourTree[Sp2]+P_TWoodHarvLabourTree[Sp3]
    P_TWoodHarvLabour <- sum(tree_df$P_TWoodHarvLabourTree)
    
    # T_FreshFruitHarv[Tree] = (T_FruitHarvInc[DW,Tree]/(1-T_FruitMoistFrac[Tree]))
    tree_df$T_FreshFruitHarv <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_FruitHarvInc"] /
      (1 - tree_df$T_FruitMoistFrac)
    
    # P_TFreshFruitLabourTree[Tree] = if T_FreshFruitHarv[Tree]>0 then T_FreshFruitHarv[Tree]*P_TFruitHarvLab[Tree]*T_GrowsToday?[Tree]*10000 else 0
    tree_df$P_TFreshFruitLabourTree <- ifelse(
      tree_df$T_FreshFruitHarv > 0,
      tree_df$T_FreshFruitHarv * tree_df$P_TFruitHarvLab * tree_df$T_GrowsToday_is *
        10000,
      0
    )
    
    # P_TFruitHarvLabour = P_TFreshFruitLabourTree[Sp1]+P_TFreshFruitLabourTree[Sp2]+P_TFreshFruitLabourTree[Sp3]
    P_TFruitHarvLabour <- sum(tree_df$P_TFreshFruitLabourTree)
    
    # T_SlashLabour = GRAPH(T_BiomassSlashed[DW])
    T_SlashLabour <- get_y_df(pcomp_df[pcomp_df$PlantComp == "DW", "T_BiomassSlashed"], "T_SlashLabour")
    
    # P_TFreshLatex[Tree] = (T_LatexFormation[DW,Tree]/(1-T_LatexMoistFrac[Tree]))
    tree_df$P_TFreshLatex <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_LatexFormation"] /
      (1 - tree_df$T_LatexMoistFrac)
    
    #TODO: check T_GrowsToday?[Sp1] is it supposed to be T_GrowsToday?[Tree]?
    # P_TLatexHarvLabourTree[Tree] = if P_TFreshLatex[Tree]>0 then P_TFreshLatex[Tree]*P_TLatexHarvLab[Tree]*T_GrowsToday?[Sp1]*10000 else 0
    tree_df$P_TLatexHarvLabourTree <- ifelse(
      tree_df$P_TFreshLatex > 0,
      tree_df$P_TFreshLatex * tree_df$P_TLatexHarvLab * tree_df$T_GrowsToday_is *
        10000,
      0
    )
    
    # P_TLatexHarvLabour = P_TLatexHarvLabourTree[Sp1]+P_TLatexHarvLabourTree[Sp2]+P_TLatexHarvLabourTree[Sp3]
    P_TLatexHarvLabour <- sum(tree_df$P_TLatexHarvLabourTree)
    
    # P_TFertLabourperTree[Tree] = if CA_FertApp = 1 then P_TNuFertAppperTreeAge[Tree]*P_TFertLab[Tree]*T_GrowsToday?[Tree] else 0
    tree_df$CA_FertApp <- CA_FertApp
    tree_df$P_TFertLabourperTree <- ifelse(
      tree_df$CA_FertApp == 1,
      tree_df$P_TNuFertAppperTreeAge * tree_df$P_TFertLab * tree_df$T_GrowsToday_is,
      0
    )
    
    # P_TFertLabour = P_TFertLabourperTree[Sp1]+P_TFertLabourperTree[Sp2]+P_TFertLabourperTree[Sp3]
    P_TFertLabour <- sum(tree_df$P_TFertLabourperTree)
    
    # P_DayLabUse = PD_FenceBuildLab+P_CPlantLabour+P_CPestConLabour+P_CWeedLabour+P_CHarvLabour+P_TPlantLabour+P_TPrunLabour+P_TWoodHarvLabour+P_TFruitHarvLabour+P_BurnLab*S&B_FireTime?+T_SlashLabour+P_TLatexHarvLabour+P_TFertLabour+P_CFertLabour
    P_DayLabUse <- PD_FenceBuildLab + P_CPlantLabour + P_CPestConLabour + P_CWeedLabour +
      P_CHarvLabour + P_TPlantLabour + P_TPrunLabour + P_TWoodHarvLabour + P_TFruitHarvLabour +
      P_BurnLab * SB_FireTime_is + T_SlashLabour + P_TLatexHarvLabour + P_TFertLabour + P_CFertLabour
    
    # P_CurrCropBenefitFlow = (-P_CCosts[Private]+P_CReturn[Private])/(1+P_DiscountRate/36500)^TIME
    pp <- price_df[price_df$PriceType == "Private", ]
    P_CurrCropBenefitFlow <- (-pp$P_CCosts + pp$P_CReturn) / (1 + P_DiscountRate /
                                                                36500)^time
    
    # P_ProfitRecCrop = if P_2DayAfterCropharv = 1 then P_CurrentCropCB/dt else 0
    P_ProfitRecCrop <- ifelse(P_2DayAfterCropharv == 1, P_CurrentCropCB, 0)
    
    # P_FlagCSet = if P_ProfitRecCrop  <> 0 then (if  P_ProfitRecCrop >P_CropProfThreshold then 0 else -1) else 0
    P_FlagCSet <- ifelse(P_ProfitRecCrop  != 0,
                         ifelse(P_ProfitRecCrop > P_CropProfThreshold, 0, -1),
                         0)
    
    # PD_FenceMatUsed[PriceType] = IF PD_HalfFenceTime>0 THEN PD_FenceBuildLab*P_FenceMatCost[PriceType]/PD_HalfFenceTime ELSE 0
    price_df$PD_FenceMatUsed <- ifelse(
      PD_HalfFenceTime > 0,
      PD_FenceBuildLab * price_df$P_FenceMatCost / PD_HalfFenceTime,
      0
    )
    
    # P_GenCosts[PriceType] = P_UnitLabCost[PriceType]*(PD_FenceBuildLab+S&B_FireTime?*P_BurnLab+T_SlashLabour)+PD_FenceMatUsed[PriceType]
    price_df$P_GenCosts <- price_df$P_UnitLabCost * (PD_FenceBuildLab + SB_FireTime_is * P_BurnLab +
                                                       T_SlashLabour) + price_df$PD_FenceMatUsed
    
    # P_GenCostsInc[PriceType] = P_GenCosts[PriceType]
    price_df$P_GenCostsInc <- price_df$P_GenCosts
    
    # P_TReturnFruit[PriceType] = P_TFruitPrice[PriceType,Sp1]*(T_FreshFruitHarv[Sp1])+P_TFruitPrice[PriceType,Sp2]*(T_FreshFruitHarv[Sp2])+P_TFruitPrice[PriceType,Sp3]*(T_FreshFruitHarv[Sp3])
    price_df$P_TReturnFruit <- aggregate(
      treeprice_df$P_TFruitPrice * rep(tree_df$T_FreshFruitHarv, nrow(price_df)),
      treeprice_df["PriceType"],
      sum
    )$x
    
    # P_TReturnLatex[PriceType] = P_TFreshLatex[Sp1]*P_TLatexPrice[PriceType,Sp1]+P_TFreshLatex[Sp2]*P_TLatexPrice[PriceType,Sp2]+P_TFreshLatex[Sp3]*P_TLatexPrice[PriceType,Sp3]
    price_df$P_TReturnLatex <- aggregate(
      treeprice_df$P_TLatexPrice * rep(tree_df$P_TFreshLatex, nrow(price_df)),
      treeprice_df["PriceType"],
      sum
    )$x
    
    # T_FreshPrunHarvInc[Tree] = (T_PrunHarvInc[DW,Tree]/(1-T_PrunMoistFrac[Tree]))
    tree_df$T_FreshPrunHarvInc <- treepcomp_df[treepcomp_df$PlantComp == "DW", "T_PrunHarvInc"] /
      (1 - tree_df$T_PrunMoistFrac)
    
    # P_TReturnPrun[PriceType] = P_TPrunPrice[PriceType,Sp1]*T_FreshPrunHarvInc[Sp1]+P_TPrunPrice[PriceType,Sp2]*T_FreshPrunHarvInc[Sp2]+P_TPrunPrice[PriceType,Sp3]*T_FreshPrunHarvInc[Sp3]
    price_df$P_TReturnPrun <- aggregate(
      treeprice_df$P_TPrunPrice * rep(tree_df$T_FreshPrunHarvInc, nrow(price_df)),
      treeprice_df["PriceType"],
      sum
    )$x
    
    # P_TReturnWood[PriceType] = P_TWoodPrice[PriceType,Sp1]*T_FreshWoodHarv[Sp1]+P_TWoodPrice[PriceType,Sp2]*T_FreshWoodHarv[Sp2]+P_TWoodPrice[PriceType,Sp3]*T_FreshWoodHarv[Sp3]
    price_df$P_TReturnWood <- aggregate(
      treeprice_df$P_TWoodPrice * rep(tree_df$T_FreshWoodHarv, nrow(price_df)),
      treeprice_df["PriceType"],
      sum
    )$x
    
    # P_TReturn[PriceType] = (P_TReturnFruit[PriceType]+P_TReturnLatex[PriceType]+P_TReturnPrun[PriceType]+P_TReturnWood[PriceType])*10000
    price_df$P_TReturn <- (
      price_df$P_TReturnFruit + price_df$P_TReturnLatex + price_df$P_TReturnPrun + price_df$P_TReturnWood
    ) * 10000
    
    # P_TSeedPriceInp[PriceType,Tree] = IF(INT(T_PlantTime[Tree]))=TIME then P_TSeedPrice[PriceType,Tree]*T_TreesperHa[Tree]*T_GrowsToday?[Tree] else 0
    treeprice_df$T_PlantTime <- rep(tree_df$T_PlantTime, nrow(price_df))
    treeprice_df$T_Treesperha <- rep(tree_df$T_Treesperha, nrow(price_df))
    treeprice_df$T_GrowsToday_is <- rep(tree_df$T_GrowsToday_is, nrow(price_df))
    treeprice_df$P_TSeedPriceInp <- ifelse(
      floor(treeprice_df$T_PlantTime) == time,
      treeprice_df$P_TSeedPrice * treeprice_df$T_Treesperha * treeprice_df$T_GrowsToday_is,
      0
    )
    
    # P_TCostInp[PriceType] = P_TSeedPriceInp[PriceType,Sp1]+P_TSeedPriceInp[PriceType,Sp2]+P_TSeedPriceInp[PriceType,Sp3]
    price_df$P_TCostInp <- aggregate(treeprice_df$P_TSeedPriceInp, treeprice_df["PriceType"], sum)$x
    
    # P_TCostLab[PriceType] = P_UnitLabCost[PriceType]*(P_TPlantLabour+P_TPrunLabour+P_TWoodHarvLabour+P_TFruitHarvLabour+P_TLatexHarvLabour+P_TFertLabour)
    price_df$P_TCostLab <- price_df$P_UnitLabCost * (
      P_TPlantLabour + P_TPrunLabour + P_TWoodHarvLabour + P_TFruitHarvLabour + P_TLatexHarvLabour + P_TFertLabour
    )
    
    # P_TCost[PriceType] = P_TCostInp[PriceType]+P_TCostLab[PriceType]
    price_df$P_TCost <- price_df$P_TCostInp + price_df$P_TCostLab
    
    # P_Costs&Benefits[PriceType] = -(P_CReturn[PriceType]+P_TReturn[PriceType]-P_GenCosts[PriceType]-P_TCost[PriceType]-P_CCosts[PriceType])/(1+P_DiscountRate/36500)^TIME
    price_df$P_CostsBenefits <- -(
      price_df$P_CReturn + price_df$P_TReturn - price_df$P_GenCosts - price_df$P_TCost - price_df$P_CCosts
    ) / (1 + P_DiscountRate / 36500)^time
    
    # P_TCostsInc[PriceType] = P_TCost[PriceType]
    price_df$P_TCostsInc <- price_df$P_TCost
    
    # P_TPrunNoInc[PlantComp,Tree] = IF(T_Prun[PlantComp,Tree]>0)THEN(1)ELSE(0)
    treepcomp_df$P_TPrunNoInc <- ifelse(treepcomp_df$T_Prun > 0, 1, 0)
    
    # P_TReturnInc[PriceType] = P_TReturn[PriceType]
    price_df$P_TReturnInc <- price_df$P_TReturn
    
    # PD_FenceBuildEvent = if time = int(PD_FenceTime) then +1 else
    PD_FenceBuildEvent <- ifelse(time == floor(PD_FenceTime), 1, 0)
    
    # PD_FenceBuilding = PD_FenceBuildLab*(PD_FenceFullQual - PD_FenceQ)^2/(PD_HalfFenceTime*PD_FenceFullQual+PD_FenceBuildLab*(PD_FenceFullQual-PD_FenceQ))
    PD_FenceBuilding <- PD_FenceBuildLab * (PD_FenceFullQual - PD_FenceQ)^2 / (
      PD_HalfFenceTime * PD_FenceFullQual + PD_FenceBuildLab * (PD_FenceFullQual - PD_FenceQ)
    )
    
    # PD_FenceDecay = PD_FenceQ*PD_FenceDecK
    PD_FenceDecay <- PD_FenceQ * PD_FenceDecK
    
    # RAIN_FracDayWet[Zn1] = RAIN_Inf1/S_SurfInfiltrAct[Zn1]+0*(RAIN_Inf1+RAIN_Inf2+RAIN_Inf3+RAIN_Inf4)
    # RAIN_FracDayWet[Zn2] = RAIN_Inf2/S_SurfInfiltrAct[Zn2]+0*(RAIN_Inf1+RAIN_Inf2+RAIN_Inf3+RAIN_Inf4)
    # RAIN_FracDayWet[Zn3] = RAIN_Inf3/S_SurfInfiltrAct[Zn3]+0*(RAIN_Inf1+RAIN_Inf2+RAIN_Inf3+RAIN_Inf4)
    # RAIN_FracDayWet[Zn4] = RAIN_Inf4/S_SurfInfiltrAct[Zn4]+0*(RAIN_Inf1+RAIN_Inf2+RAIN_Inf3+RAIN_Inf4)
    zone_df$RAIN_FracDayWet <- zone_df$RAIN_Infiltr / zone_df$S_SurfInfiltrAct
    
    # RAIN_AnaerIndCh[Zone] = (-RAIN_AnaerInd[Zone]+RAIN_FracDayWet[Zone])/RAIN_AnMemory
    zone_df$RAIN_AnaerIndCh <- (-zone_df$RAIN_AnaerInd + zone_df$RAIN_FracDayWet) /
      RAIN_AnMemory
    
    # S&B_HazeFromWood[Zone,PlantComp] = S&B_DW?[PlantComp]*S&B_DeadWood[Zone,PlantComp]*S&B_DeadWoodBurnFrac[Zone]*(S&B_AerosolFrac[Zone])
    zonepcomp_df$SB_HazeFromWood <- zonepcomp_df$SB_DW_is * zonepcomp_df$SB_DeadWood * zonepcomp_df$SB_DeadWoodBurnFrac * zonepcomp_df$SB_AerosolFrac
    
    # S&B_WoodFNutVolat[Zone,PlantComp] = (1-S&B_DW?[PlantComp])*S&B_DeadWoodBurnFrac[Zone]*S&B_NutVolatFrac[Zone,PlantComp]*S&B_DeadWood[Zone,PlantComp]
    zonepcomp_df$SB_WoodFNutVolat <- (1 - zonepcomp_df$SB_DW_is) * zonepcomp_df$SB_DeadWoodBurnFrac * zonepcomp_df$SB_NutVolatFrac * zonepcomp_df$SB_DeadWood
    
    # S&B_ScorchWoodRemTime? = DELAY(S&B_Fire?,S&B_TimeToWoodRemoval)
    SB_ScorchWoodRemTime_is <- delay(SB_Fire_is, SB_TimeToWoodRemoval, 0)
    
    # S&B_ScorchedWoodRem[Zone,PlantComp] = if S&B_ScorchWoodRemTime?=1 then S&B_ScorchWRemFra*S&B_DeadWood[Zone,PlantComp] else 0
    zonepcomp_df$SB_ScorchedWoodRem <- ifelse(SB_ScorchWoodRemTime_is == 1,
                                              SB_ScorchWRemFra * zonepcomp_df$SB_DeadWood,
                                              0)
    
    # S&B_WPileUp[Zone,PlantComp] = if S&B_PileUpT? = 1 then S&B_PileUpFrac*(S&B_DeadWood[Zone,PlantComp]-S&B_RelPileUp[Zone]*BC_DWDeadWood[PlantComp]) else 0
    zonepcomp_df$BC_DWDeadWood <- rep(pcomp_df$BC_DWDeadWood, each = nrow(zone_df))
    zonepcomp_df$SB_WPileUp <- ifelse(
      SB_PileUpT_is == 1,
      SB_PileUpFrac * (
        zonepcomp_df$SB_DeadWood - zonepcomp_df$SB_RelPileUp * zonepcomp_df$BC_DWDeadWood
      ),
      0
    )
    
    # S&B_SlashSequence[Tree] = if time = int(S&B_SlashTime[Tree]+S&B_MaxDryingPer+1) or S&B_Fire? = 1 then 1 else 0
    tree_df$SB_SlashSequence <- ifelse(time == floor(tree_df$SB_SlashTime + SB_MaxDryingPer + 1) |
                                         SB_Fire_is == 1,
                                       1,
                                       0)
    
    # S&B_FirImpPsorption[Zone] = GRAPH(S&B_FireTempIncTopSoil[Zone])
    zone_df$SB_FirImpPsorption <- get_y_df(zone_df$SB_FireTempIncTopSoil, "SB_FirImpPsorption")
    
    # S&B_PSorpCh[Zone] = if S&B_FirImpPsorption[Zone] <>1 then S&B_FirImpPsorption[Zone] - S&B_PsorpModifier[Zone] else -(S&B_PsorpModifier[Zone] - 1)*S&B_PsorpRecFrac
    zone_df$SB_PSorpCh <- ifelse(
      zone_df$SB_FirImpPsorption != 1,
      zone_df$SB_FirImpPsorption - zone_df$SB_PsorpModifier,
      -(zone_df$SB_PsorpModifier - 1) * SB_PsorpRecFrac
    )
    
    # S&B_FireImpWatRet[Zone] = min(1,0.03*max(0,S&B_FireTempIncTopSoil[Zone] - 300))
    zone_df$SB_FireImpWatRet <- pmin(1, 0.03 * pmax(0, zone_df$SB_FireTempIncTopSoil - 300))
    
    # S&B_FCch[Zone] = if S&B_WatRetentionMod[Zone] <>1 then S&B_FireImpWatRet[Zone] - S&B_WatRetentionMod[Zone] else  -(S&B_WatRetentionMod[Zone] - 1)*S&B_WatRetRecFrac
    zone_df$SB_FCch <- ifelse(
      zone_df$SB_WatRetentionMod != 1,
      zone_df$SB_FireImpWatRet - zone_df$SB_WatRetentionMod,
      -(zone_df$SB_WatRetentionMod - 1) * SB_WatRetRecFrac
    )
    
    # T_CurLimFac[Sp1,Water] = if T_Stage[Sp1,VegGen]>0 then if TW_Posgro[Sp1] <=MIN(T_NPosgro[N,Sp1],T_NPosgro[P,Sp1]) and TW_Posgro[Sp1]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp1,N]     = if T_Stage[Sp1,VegGen]>0 then if T_NPosgro[N,Sp1] <=MIN(TW_Posgro[Sp1],T_NPosgro[P,Sp1]) and T_NPosgro[N,Sp1]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp1,P]     = if T_Stage[Sp1,VegGen]>0 then if T_NPosgro[P,Sp1] <=MIN(TW_Posgro[Sp1],T_NPosgro[N,Sp1]) and T_NPosgro[P,Sp1]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp2,Water] = if T_Stage[Sp2,VegGen]>0 then if TW_Posgro[Sp2] <=MIN(T_NPosgro[N,Sp2],T_NPosgro[P,Sp2]) and TW_Posgro[Sp2]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp2,N]     = if T_Stage[Sp2,VegGen]>0 then if T_NPosgro[N,Sp2] <=MIN(TW_Posgro[Sp2],T_NPosgro[P,Sp2]) and T_NPosgro[N,Sp2]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp2,P]     = if T_Stage[Sp2,VegGen]>0 then if T_NPosgro[P,Sp2] <=MIN(TW_Posgro[Sp2],T_NPosgro[N,Sp2]) and T_NPosgro[P,Sp2]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp3,Water] = if T_Stage[Sp3,VegGen]>0 then if TW_Posgro[Sp3] <=MIN(T_NPosgro[N,Sp3],T_NPosgro[P,Sp3]) and TW_Posgro[Sp3]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp3,N]     = if T_Stage[Sp3,VegGen]>0 then if T_NPosgro[N,Sp3] <=MIN(TW_Posgro[Sp3],T_NPosgro[P,Sp3]) and T_NPosgro[N,Sp3]<T_StressAccLim then 1 else 0 else 0
    # T_CurLimFac[Sp3,P]     = if T_Stage[Sp3,VegGen]>0 then if T_NPosgro[P,Sp3] <=MIN(TW_Posgro[Sp3],T_NPosgro[N,Sp3]) and T_NPosgro[P,Sp3]<T_StressAccLim then 1 else 0 else 0
    treelimit_df$T_Stage_VG <- rep(treestage_df[treestage_df$Tree_Stage == "VegGen", "T_Stage"], length(Limiting_Factors))
    treelimit_df$T_Posgro <- c(tree_df$TW_Posgro,
                               tree_df$T_NPosgro_N,
                               tree_df$T_NPosgro_P)
    treelimit_df$T_Posgro_lim <- pmin(
      c(
        tree_df$T_NPosgro_N,
        tree_df$TW_Posgro,
        tree_df$TW_Posgro
      ),
      c(
        tree_df$T_NPosgro_P,
        tree_df$T_NPosgro_P,
        tree_df$T_NPosgro_N
      )
    )
    
    treelimit_df$T_CurLimFac <- ifelse(
      treelimit_df$T_Stage_VG > 0,
      ifelse(
        treelimit_df$T_Posgro <= treelimit_df$T_Posgro_lim &
          treelimit_df$T_Posgro < T_StressAccLim,
        1,
        0
      ),
      0
    )
    
    # T_DelWatStress[Tree] = (1-T_WatStressMem)*(1-TW_Posgro[Tree]-T_CumWatStress[Tree])
    tree_df$T_DelWatStress <- (1 - T_WatStressMem) * (1 - tree_df$TW_Posgro - tree_df$T_CumWatStress)
    
    # T_GrowDayAc[Tree] = if T_Stage[Tree,VegGen] = 0 then 0 else 1
    tree_df$T_GrowDayAc <- ifelse(treestage_df[treestage_df$Tree_Stage == "VegGen", "T_Stage"] == 0, 0, 1)
    
    # TW_HydFluxPosTot[Tree] = TW_PotFluxPos[Tree]*TW_ScalingFacPosFluxes[Tree]
    tree_df$TW_HydFluxPosTot <- tree_df$TW_PotFluxPos * tree_df$TW_ScalingFacPosFluxes
    
    # T_SetPanelInitiateFlag[Tree] = if T_PanelAlreadyInitiated?[Tree] = 0 and T_GirthMax[Tree] > T_GirthMinforTappingcm then 1 else 0
    tree_df$T_SetPanelInitiateFlag <- ifelse(
      tree_df$T_PanelAlreadyInitiated_is == 0 &
        tree_df$T_GirthMax > T_GirthMinforTappingcm,
      1,
      0
    )
    
    # T_InitiatePanel[Tree] = if T_GirthMax[Tree]>T_GirthMinforTappingcm and T_PanelAlreadyInitiated?[Tree] = 0 then T_TappableHeight*T_GirthMax[Tree] else 0
    tree_df$T_InitiatePanel <- ifelse(
      tree_df$T_GirthMax > T_GirthMinforTappingcm &
        tree_df$T_PanelAlreadyInitiated_is == 0,
      T_TappableHeight * tree_df$T_GirthMax,
      0
    )
    
    # T_SecTPanelInc[Tree] = T_TappingDay?[Tree]*T_TappingSlice*T_GirthMinforTappingcm*T_TapGirthFraction
    tree_df$T_SecTPanelInc <- tree_df$T_TappingDay_is * T_TappingSlice * T_GirthMinforTappingcm * T_TapGirthFraction
    
    # TODO: to be check for the term: -dt
    # T_PrunLapseInc[Tree] = IF(T_Prun[DW, Tree]>0) or time = int(S&B_SlashTime[Tree])  or S&B_Fire? =1 THEN(T_PrunLapse[Tree]/DT)ELSE(-dt)
    tree_df$T_PrunLapseInc <- ifelse(
      treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Prun"] > 0 |
        time == floor(tree_df$SB_SlashTime) |
        SB_Fire_is == 1,
      tree_df$T_PrunLapse,
      -1
    )
    
    # TRtRootDecZone[Zn1,DW] = (T_RtDec_DW[Zn1,1]   +T_RtDec_DW[Zn1,2]+T_RtDec_DW[Zn1,3]+T_RtDec_DW[Zn1,4]  + 0*T_RtDec_N[Zn1,1]+ 0*T_RtDec_P[Zn1,1])*AF_ZoneFrac[Zn1]
    # TRtRootDecZone[Zn1,N]  = (0*T_RtDec_DW[Zn1,1] +T_RtDec_N[Zn1,1]+T_RtDec_N[Zn1,2]+T_RtDec_N[Zn1,3]+T_RtDec_N[Zn1,4] + 0*T_RtDec_P[Zn1,1])*AF_ZoneFrac[Zn1]
    # TRtRootDecZone[Zn1,P]  = (0*T_RtDec_DW[Zn1,1] + 0*T_RtDec_N[Zn1,1]+T_RtDec_P[Zn1,1]+T_RtDec_P[Zn1,2]+T_RtDec_P[Zn1,3]+T_RtDec_P[Zn1,4])*AF_ZoneFrac[Zn1]
    # TRtRootDecZone[Zn2,DW] = (T_RtDec_DW[Zn2,1]+T_RtDec_DW[Zn2,2]+T_RtDec_DW[Zn2,3]+T_RtDec_DW[Zn2,4]  + 0*T_RtDec_N[Zn2,1]+ 0*T_RtDec_P[Zn2,1])*AF_ZoneFrac[Zn2]
    # TRtRootDecZone[Zn2,N]  = (0*T_RtDec_DW[Zn2,1]+T_RtDec_N[Zn2,1]+T_RtDec_N[Zn2,2]+T_RtDec_N[Zn2,3]+T_RtDec_N[Zn2,4] + 0*T_RtDec_P[Zn2,1])*AF_ZoneFrac[Zn2]
    # TRtRootDecZone[Zn2,P]  = (0*T_RtDec_DW[Zn2,1]+ 0*T_RtDec_N[Zn2,1]+T_RtDec_P[Zn2,1]+T_RtDec_P[Zn2,2]+T_RtDec_P[Zn2,3]+T_RtDec_P[Zn2,4])*AF_ZoneFrac[Zn2]
    # TRtRootDecZone[Zn3,DW] = (T_RtDec_DW[Zn3,1]+T_RtDec_DW[Zn3,2]+T_RtDec_DW[Zn3,3]+T_RtDec_DW[Zn3,4]  + 0*T_RtDec_N[Zn3,1]+ 0*T_RtDec_P[Zn3,1])*AF_ZoneFrac[Zn3]
    # TRtRootDecZone[Zn3,N]  = (0*T_RtDec_DW[Zn3,1]+T_RtDec_N[Zn3,1]+T_RtDec_N[Zn3,2]+T_RtDec_N[Zn3,3]+T_RtDec_N[Zn3,4] + 0*T_RtDec_P[Zn3,1])*AF_ZoneFrac[Zn3]
    # TRtRootDecZone[Zn3,P]  = (0*T_RtDec_DW[Zn3,1]+ 0*T_RtDec_N[Zn3,1]+T_RtDec_P[Zn3,1]+T_RtDec_P[Zn3,2]+T_RtDec_P[Zn3,3]+T_RtDec_P[Zn3,4])*AF_ZoneFrac[Zn3]
    # TRtRootDecZone[Zn4,DW] = (T_RtDec_DW[Zn4,1]+T_RtDec_DW[Zn4,2]+T_RtDec_DW[Zn4,3]+T_RtDec_DW[Zn4,4]  + 0*T_RtDec_N[Zn4,1]+ 0*T_RtDec_P[Zn4,1])*AF_ZoneFrac[Zn4]
    # TRtRootDecZone[Zn4,N]  = (0*T_RtDec_DW[Zn4,1]+ T_RtDec_N[Zn4,1]+T_RtDec_N[Zn4,2]+T_RtDec_N[Zn4,3]+T_RtDec_N[Zn4,4]}+ 0*T_RtDec_P[Zn4,1])*AF_ZoneFrac[Zn4]
    # TRtRootDecZone[Zn4,P]  = (0*T_RtDec_DW[Zn4,1]+ 0*T_RtDec_N[Zn4,1]+T_RtDec_P[Zn4,1]+T_RtDec_P[Zn4,2]+T_RtDec_P[Zn4,3]+T_RtDec_P[Zn4,4])*AF_ZoneFrac[Zn4]
    zonepcomp_df$TRtRootDecZone <- aggregate(zonelayerpcomp_df$T_RtDec, zonelayerpcomp_df[c("zone", "PlantComp")], sum)$x * zonepcomp_df$AF_ZoneFrac
    
    # T_RtDecDWAll[PlantComp] = ARRAYSUM(TRtRootDecZone[*,PlantComp])
    pcomp_df$T_RtDecDWAll <- aggregate(zonepcomp_df$TRtRootDecZone, zonepcomp_df["PlantComp"], sum)$x
    
    # T_RootDecAcc[PlantComp] = T_RtDecDWAll[PlantComp]
    pcomp_df$T_RootDecAcc <- pcomp_df$T_RtDecDWAll
    
    # T_TapDaysInc[Tree] = T_TappingDay?[Tree]
    tree_df$T_TapDaysInc <- tree_df$T_TappingDay_is
    
    # T_Tapping?[Tree] = if T_Tapping[DW,Tree]> 0 then 1 else 0
    tree_df$T_Tapping_is <- ifelse(treepcomp_df[treepcomp_df$PlantComp == "DW", "T_Tapping"] > 0, 1, 0)
    
    # TF_GenderPassOn[Sp1,Ripe] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe]+TF_BunchGender[Sp1,Ripe_1] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_1] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_1]+TF_BunchGender[Sp1,Ripe_2] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_2] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_2]+TF_BunchGender[Sp1,Ripe_3] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_3] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_3]+TF_BunchGender[Sp1,Ripe_4] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_4] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_4]+TF_BunchGender[Sp1,Ripe_5] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_5] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_5]+TF_BunchGender[Sp1,Ripe_6] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_6] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_6]+TF_BunchGender[Sp1,Ripe_7] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_7] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_7]+TF_BunchGender[Sp1,Ripe_8] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_8] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_8]+TF_BunchGender[Sp1,Ripe_9] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_9] = if TF_NewLeaf?[Sp1] = 1then -TF_BunchGender[Sp1,Ripe_9]+TF_BunchGender[Sp1,Ripe_10] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_10] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_10]+TF_BunchGender[Sp1,Ripe_11] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_11] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_11]+TF_BunchGender[Sp1,Ripe_12] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Ripe_12] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Ripe_12]+TF_BunchGender[Sp1,Early_fruit] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Early_fruit] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Early_fruit] + TF_BunchGender[Sp1,Pollinated] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Pollinated] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Pollinated] + TF_BunchGender[Sp1,Anthesis] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Anthesis] + TF_BunchGender[Sp1,Anthesis_1] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis_1] = if TF_NewLeaf?[Sp1] = 1 then  -TF_BunchGender[Sp1,Anthesis_1] + TF_BunchGender[Sp1,Anthesis_2] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis_2] = if TF_NewLeaf?[Sp1] = 1 then  -TF_BunchGender[Sp1,Anthesis_2] + TF_BunchGender[Sp1,Anthesis_3] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis_3] = if TF_NewLeaf?[Sp1] = 1 then  -TF_BunchGender[Sp1,Anthesis_3] + TF_BunchGender[Sp1,Anthesis_4] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis_4] = if TF_NewLeaf?[Sp1] = 1then  -TF_BunchGender[Sp1,Anthesis_4] + TF_BunchGender[Sp1,Anthesis_5] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis_5] = if TF_NewLeaf?[Sp1] = 1 then  -TF_BunchGender[Sp1,Anthesis_5] + TF_BunchGender[Sp1,Anthesis_6] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp1,Anthesis_6] = if TF_NewLeaf?[Sp1] = 1 then -TF_BunchGender[Sp1,Anthesis_6]+TF_Nextgender[Sp1] else 0
    
    # TF_GenderPassOn[Sp2,Ripe] = if TF_NewLeaf?[Sp2] = 1 then -TF_BunchGender[Sp2,Ripe]+TF_BunchGender[Sp2,Ripe_1] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_1] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_1]+TF_BunchGender[Sp2,Ripe_2] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_2] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_2]+TF_BunchGender[Sp2,Ripe_3] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_3] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_3]+TF_BunchGender[Sp2,Ripe_4] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_4] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_4]+TF_BunchGender[Sp2,Ripe_5] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_5] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_5]+TF_BunchGender[Sp2,Ripe_6] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_6] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_6]+TF_BunchGender[Sp2,Ripe_7] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_7] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_7]+TF_BunchGender[Sp2,Ripe_8] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_8] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_8]+TF_BunchGender[Sp2,Ripe_9] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_9] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_9]+TF_BunchGender[Sp2,Ripe_10] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_10] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_10]+TF_BunchGender[Sp2,Ripe_11] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_11] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_11]+TF_BunchGender[Sp2,Ripe_12] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Ripe_12] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Ripe_12]+TF_BunchGender[Sp2,Early_fruit] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Early_fruit] = if TF_NewLeaf?[Sp2] = 1 then -TF_BunchGender[Sp2,Early_fruit] + TF_BunchGender[Sp2,Pollinated] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Pollinated] = if TF_NewLeaf?[Sp2] = 1 then -TF_BunchGender[Sp2,Pollinated] + TF_BunchGender[Sp2,Anthesis] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis] = if TF_NewLeaf?[Sp2] = 1 then -TF_BunchGender[Sp2,Anthesis] + TF_BunchGender[Sp2,Anthesis_1] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis_1] = if TF_NewLeaf?[Sp2] = 1 then  -TF_BunchGender[Sp2,Anthesis_1] + TF_BunchGender[Sp2,Anthesis_2] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis_2] = if TF_NewLeaf?[Sp2] = 1 then  -TF_BunchGender[Sp2,Anthesis_2] + TF_BunchGender[Sp2,Anthesis_3] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis_3] = if TF_NewLeaf?[Sp2] = 1 then  -TF_BunchGender[Sp2,Anthesis_3] + TF_BunchGender[Sp2,Anthesis_4] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis_4] = if TF_NewLeaf?[Sp2] = 1 then  -TF_BunchGender[Sp2,Anthesis_4] + TF_BunchGender[Sp2,Anthesis_5] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis_5] = if TF_NewLeaf?[Sp2] = 1 then  -TF_BunchGender[Sp2,Anthesis_5] + TF_BunchGender[Sp2,Anthesis_6] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp2,Anthesis_6] = if TF_NewLeaf?[Sp2] = 1 then-TF_BunchGender[Sp2,Anthesis_6]+TF_Nextgender[Sp2] else 0
    
    # TF_GenderPassOn[Sp3,Ripe] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe]+TF_BunchGender[Sp3,Ripe_1] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_1] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_1]+TF_BunchGender[Sp3,Ripe_2] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_2] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_2]+TF_BunchGender[Sp3,Ripe_3] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_3] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_3]+TF_BunchGender[Sp3,Ripe_4] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_4] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_4]+TF_BunchGender[Sp3,Ripe_5] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_5] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_5]+TF_BunchGender[Sp3,Ripe_6] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_6] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_6]+TF_BunchGender[Sp3,Ripe_7] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_7] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_7]+TF_BunchGender[Sp3,Ripe_8] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_8] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_8]+TF_BunchGender[Sp3,Ripe_9] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_9] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_9]+TF_BunchGender[Sp3,Ripe_10] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_10] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_10]+TF_BunchGender[Sp3,Ripe_11] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_11] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_11]+TF_BunchGender[Sp3,Ripe_12] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Ripe_12] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Ripe_12]+TF_BunchGender[Sp3,Early_fruit] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Early_fruit] = if TF_NewLeaf?[Sp3] = 1 then -TF_BunchGender[Sp3,Early_fruit] + TF_BunchGender[Sp3,Pollinated] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Pollinated] = if TF_NewLeaf?[Sp3] = 1 then -TF_BunchGender[Sp3,Pollinated] + TF_BunchGender[Sp3,Anthesis] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis] = if TF_NewLeaf?[Sp3] = 1 then -TF_BunchGender[Sp3,Anthesis] + TF_BunchGender[Sp3,Anthesis_1] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis_1] = if TF_NewLeaf?[Sp3] = 1 then  -TF_BunchGender[Sp3,Anthesis_1] + TF_BunchGender[Sp3,Anthesis_2] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis_2] = if TF_NewLeaf?[Sp3] = 1 then -TF_BunchGender[Sp3,Anthesis_2] + TF_BunchGender[Sp3,Anthesis_3] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis_3] = if TF_NewLeaf?[Sp3] = 1 then -TF_BunchGender[Sp3,Anthesis_3] + TF_BunchGender[Sp3,Anthesis_4] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis_4] = if TF_NewLeaf?[Sp3] = 1 then  -TF_BunchGender[Sp3,Anthesis_4] + TF_BunchGender[Sp3,Anthesis_5] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis_5] = if TF_NewLeaf?[Sp3] = 1 then  -TF_BunchGender[Sp3,Anthesis_5] + TF_BunchGender[Sp3,Anthesis_6] else 0*TF_Nextgender[Sp1]
    # TF_GenderPassOn[Sp3,Anthesis_6] = if TF_NewLeaf?[Sp3] = 1 then-TF_BunchGender[Sp3,Anthesis_6]+TF_Nextgender[Sp3] else 0
    treefruit_df$TF_BunchGender_next <- c(treefruit_df[treefruit_df$Fruitbunch != "Ripe", c("tree_id", "Fruitbunch")]$TF_BunchGender, tree_df$TF_NextGender)
    treefruit_df$TF_GenderPassOn <- ifelse(
      treefruit_df$TF_NewLeaf_is == 1,
      -treefruit_df$TF_BunchGender + treefruit_df$TF_BunchGender_next,
      0
    )
    
    # TF_WeightPassOn[Sp1,Ripe] = if TF_yNewLeaf?[Sp1] = 1 then +TF_BunchWeight_kgpbunch[Sp1,Ripe_1] else 0
    # TF_WeightPassOn[Sp1,Ripe_1] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_1]+TF_BunchWeight_kgpbunch[Sp1,Ripe_2] else 0
    # TF_WeightPassOn[Sp1,Ripe_2] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_2]+TF_BunchWeight_kgpbunch[Sp1,Ripe_3] else 0
    # TF_WeightPassOn[Sp1,Ripe_3] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_3]+TF_BunchWeight_kgpbunch[Sp1,Ripe_4] else 0
    # TF_WeightPassOn[Sp1,Ripe_4] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_4]+TF_BunchWeight_kgpbunch[Sp1,Ripe_5] else 0
    # TF_WeightPassOn[Sp1,Ripe_5] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_5]+TF_BunchWeight_kgpbunch[Sp1,Ripe_6] else 0
    # TF_WeightPassOn[Sp1,Ripe_6] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_6]+TF_BunchWeight_kgpbunch[Sp1,Ripe_7] else 0
    # TF_WeightPassOn[Sp1,Ripe_7] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_7]+TF_BunchWeight_kgpbunch[Sp1,Ripe_8] else 0
    # TF_WeightPassOn[Sp1,Ripe_8] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_8]+TF_BunchWeight_kgpbunch[Sp1,Ripe_9] else 0
    # TF_WeightPassOn[Sp1,Ripe_9] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_9]+TF_BunchWeight_kgpbunch[Sp1,Ripe_10] else 0
    # TF_WeightPassOn[Sp1,Ripe_10] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_10]+TF_BunchWeight_kgpbunch[Sp1,Ripe_11] else 0
    # TF_WeightPassOn[Sp1,Ripe_11] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_11] + TF_BunchWeight_kgpbunch[Sp1,Ripe_12]else 0
    # TF_WeightPassOn[Sp1,Ripe_12] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Ripe_12] + TF_BunchWeight_kgpbunch[Sp1,Early_fruit] else 0
    # TF_WeightPassOn[Sp1,Early_fruit] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Early_fruit]+TF_BunchWeight_kgpbunch[Sp1,Pollinated] else 0
    # TF_WeightPassOn[Sp1,Pollinated] = if TF_yNewLeaf?[Sp1] = 1 then -TF_BunchWeight_kgpbunch[Sp1,Pollinated] + TF_BunchWeight_kgpbunch[Sp1,Anthesis] else 0
    # TF_WeightPassOn[Sp1,Anthesis] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis] + TF_BunchWeight_kgpbunch[Sp1,Anthesis_1] else 0
    # TF_WeightPassOn[Sp1,Anthesis_1] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis_1] + TF_BunchWeight_kgpbunch[Sp1,Anthesis_2] else 0
    # TF_WeightPassOn[Sp1,Anthesis_2] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis_2] + TF_BunchWeight_kgpbunch[Sp1,Anthesis_3] else 0
    # TF_WeightPassOn[Sp1,Anthesis_3] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis_3] + TF_BunchWeight_kgpbunch[Sp1,Anthesis_4] else 0
    # TF_WeightPassOn[Sp1,Anthesis_4] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis_4] + TF_BunchWeight_kgpbunch[Sp1,Anthesis_5] else 0
    # TF_WeightPassOn[Sp1,Anthesis_5] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis_5] + TF_BunchWeight_kgpbunch[Sp1,Anthesis_6] else 0
    # TF_WeightPassOn[Sp1,Anthesis_6] = if TF_yNewLeaf?[Sp1] = 1 then - TF_BunchWeight_kgpbunch[Sp1,Anthesis_6] else 0
    # TF_WeightPassOn[Sp2,Ripe] = if TF_yNewLeaf?[Sp2] = 1 then +TF_BunchWeight_kgpbunch[Sp2,Ripe_1] else 0
    # TF_WeightPassOn[Sp2,Ripe_1] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_1]+TF_BunchWeight_kgpbunch[Sp2,Ripe_2] else 0
    # TF_WeightPassOn[Sp2,Ripe_2] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_2]+TF_BunchWeight_kgpbunch[Sp2,Ripe_3] else 0
    # TF_WeightPassOn[Sp2,Ripe_3] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_3]+TF_BunchWeight_kgpbunch[Sp2,Ripe_4] else 0
    # TF_WeightPassOn[Sp2,Ripe_4] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_4]+TF_BunchWeight_kgpbunch[Sp2,Ripe_5] else 0
    # TF_WeightPassOn[Sp2,Ripe_5] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_5]+TF_BunchWeight_kgpbunch[Sp2,Ripe_6] else 0
    # TF_WeightPassOn[Sp2,Ripe_6] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_6]+TF_BunchWeight_kgpbunch[Sp2,Ripe_7] else 0
    # TF_WeightPassOn[Sp2,Ripe_7] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_7]+TF_BunchWeight_kgpbunch[Sp2,Ripe_8] else 0
    # TF_WeightPassOn[Sp2,Ripe_8] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_8]+TF_BunchWeight_kgpbunch[Sp2,Ripe_9] else 0
    # TF_WeightPassOn[Sp2,Ripe_9] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_9]+TF_BunchWeight_kgpbunch[Sp2,Ripe_10] else 0
    # TF_WeightPassOn[Sp2,Ripe_10] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_10]+TF_BunchWeight_kgpbunch[Sp2,Ripe_11] else 0
    # TF_WeightPassOn[Sp2,Ripe_11] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_11] + TF_BunchWeight_kgpbunch[Sp2,Ripe_12] else 0
    # TF_WeightPassOn[Sp2,Ripe_12] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Ripe_12] + TF_BunchWeight_kgpbunch[Sp2,Early_fruit] else 0
    # TF_WeightPassOn[Sp2,Early_fruit] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Early_fruit]+TF_BunchWeight_kgpbunch[Sp2,Pollinated] else 0
    # TF_WeightPassOn[Sp2,Pollinated] = if TF_yNewLeaf?[Sp2] = 1 then -TF_BunchWeight_kgpbunch[Sp2,Pollinated] + TF_BunchWeight_kgpbunch[Sp2,Anthesis] else 0
    # TF_WeightPassOn[Sp2,Anthesis] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis] + TF_BunchWeight_kgpbunch[Sp2,Anthesis_1] else 0
    # TF_WeightPassOn[Sp2,Anthesis_1] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis_1] + TF_BunchWeight_kgpbunch[Sp2,Anthesis_2] else 0
    # TF_WeightPassOn[Sp2,Anthesis_2] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis_2] + TF_BunchWeight_kgpbunch[Sp2,Anthesis_3] else 0
    # TF_WeightPassOn[Sp2,Anthesis_3] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis_3] + TF_BunchWeight_kgpbunch[Sp2,Anthesis_4] else 0
    # TF_WeightPassOn[Sp2,Anthesis_4] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis_4] + TF_BunchWeight_kgpbunch[Sp2,Anthesis_5] else 0
    # TF_WeightPassOn[Sp2,Anthesis_5] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis_5] + TF_BunchWeight_kgpbunch[Sp2,Anthesis_6] else 0
    # TF_WeightPassOn[Sp2,Anthesis_6] = if TF_yNewLeaf?[Sp2] = 1 then - TF_BunchWeight_kgpbunch[Sp2,Anthesis_6] else 0
    
    # TF_WeightPassOn[Sp3,Ripe] = if TF_yNewLeaf?[Sp3] = 1 then +TF_BunchWeight_kgpbunch[Sp3,Ripe_1] else 0
    # TF_WeightPassOn[Sp3,Ripe_1] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_1]+TF_BunchWeight_kgpbunch[Sp3,Ripe_2] else 0
    # TF_WeightPassOn[Sp3,Ripe_2] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_2]+TF_BunchWeight_kgpbunch[Sp3,Ripe_3] else 0
    # TF_WeightPassOn[Sp3,Ripe_3] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_3]+TF_BunchWeight_kgpbunch[Sp3,Ripe_4] else 0
    # TF_WeightPassOn[Sp3,Ripe_4] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_4]+TF_BunchWeight_kgpbunch[Sp3,Ripe_5] else 0
    # TF_WeightPassOn[Sp3,Ripe_5] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_5]+TF_BunchWeight_kgpbunch[Sp3,Ripe_6] else 0
    # TF_WeightPassOn[Sp3,Ripe_6] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_6]+TF_BunchWeight_kgpbunch[Sp3,Ripe_7] else 0
    # TF_WeightPassOn[Sp3,Ripe_7] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_7]+TF_BunchWeight_kgpbunch[Sp3,Ripe_8] else 0
    # TF_WeightPassOn[Sp3,Ripe_8] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_8]+TF_BunchWeight_kgpbunch[Sp3,Ripe_9] else 0
    # TF_WeightPassOn[Sp3,Ripe_9] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_9]+TF_BunchWeight_kgpbunch[Sp3,Ripe_10] else 0
    # TF_WeightPassOn[Sp3,Ripe_10] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Ripe_10]+TF_BunchWeight_kgpbunch[Sp3,Ripe_11] else 0
    # TF_WeightPassOn[Sp3,Ripe_11] = if TF_yNewLeaf?[Sp3] = 1 then  -TF_BunchWeight_kgpbunch[Sp3,Ripe_11] + TF_BunchWeight_kgpbunch[Sp3,Ripe_12] else 0
    # TF_WeightPassOn[Sp3,Ripe_12] = if TF_yNewLeaf?[Sp3] = 1 then  -TF_BunchWeight_kgpbunch[Sp3,Ripe_12] + TF_BunchWeight_kgpbunch[Sp3,Early_fruit] else 0
    # TF_WeightPassOn[Sp3,Early_fruit] = if TF_yNewLeaf?[Sp3] = 1 then -TF_BunchWeight_kgpbunch[Sp3,Early_fruit]+TF_BunchWeight_kgpbunch[Sp3,Pollinated] else 0
    # TF_WeightPassOn[Sp3,Pollinated] = if TF_yNewLeaf?[Sp3] = 1 then  -TF_BunchWeight_kgpbunch[Sp3,Pollinated] + TF_BunchWeight_kgpbunch[Sp3,Anthesis] else 0
    # TF_WeightPassOn[Sp3,Anthesis] = if TF_yNewLeaf?[Sp3] = 1 then  - TF_BunchWeight_kgpbunch[Sp3,Anthesis] + TF_BunchWeight_kgpbunch[Sp3,Anthesis_1] else 0
    # TF_WeightPassOn[Sp3,Anthesis_1] = if TF_yNewLeaf?[Sp3] = 1 then - TF_BunchWeight_kgpbunch[Sp3,Anthesis_1] + TF_BunchWeight_kgpbunch[Sp3,Anthesis_2] else 0
    # TF_WeightPassOn[Sp3,Anthesis_2] = if TF_yNewLeaf?[Sp3] = 1 then  - TF_BunchWeight_kgpbunch[Sp3,Anthesis_2] + TF_BunchWeight_kgpbunch[Sp3,Anthesis_3] else 0
    # TF_WeightPassOn[Sp3,Anthesis_3] = if TF_yNewLeaf?[Sp3] = 1 then  - TF_BunchWeight_kgpbunch[Sp3,Anthesis_3] + TF_BunchWeight_kgpbunch[Sp3,Anthesis_4] else 0
    # TF_WeightPassOn[Sp3,Anthesis_4] = if TF_yNewLeaf?[Sp3] = 1 then  - TF_BunchWeight_kgpbunch[Sp3,Anthesis_4] + TF_BunchWeight_kgpbunch[Sp3,Anthesis_5] else 0
    # TF_WeightPassOn[Sp3,Anthesis_5] = if TF_yNewLeaf?[Sp3] = 1 then - TF_BunchWeight_kgpbunch[Sp3,Anthesis_5] + TF_BunchWeight_kgpbunch[Sp3,Anthesis_6] else 0
    # TF_WeightPassOn[Sp3,Anthesis_6] = if TF_yNewLeaf?[Sp3] = 1 then - TF_BunchWeight_kgpbunch[Sp3,Anthesis_6] else 0
    treefruit_df$TF_BunchWeight_kgpbunch_a <- c(0, 0, 0, treefruit_df[treefruit_df$Fruitbunch != "Ripe", ]$TF_BunchWeight_kgpbunch)
    treefruit_df$TF_BunchWeight_kgpbunch_b <- c(treefruit_df[treefruit_df$Fruitbunch != "Ripe", ]$TF_BunchWeight_kgpbunch, 0, 0, 0)
    treefruit_df$TF_YNewLeaf_is <- rep(tree_df$TF_YNewLeaf_is, nrow(fruit_df))
    treefruit_df$TF_WeightPassOn <- ifelse(
      treefruit_df$TF_YNewLeaf_is == 1,
      -treefruit_df$TF_BunchWeight_kgpbunch_a + treefruit_df$TF_BunchWeight_kgpbunch_b,
      0
    )
    
    # TF_BunchWeightIncrAct[Tree,Fruitbunch] = if arraysum(TF_BunchweightIncrTarget[Tree,*] ) > 0 then T_FruitInc[DW,Tree]*(TF_BunchweightIncrTarget[Tree,Fruitbunch]/arraysum(TF_BunchweightIncrTarget[Tree,*]))* 10^4 /T_TreesperHa[Tree] else 0
    treefruit_df$TF_BunchweightIncrTarget_sum <- rep(tree_df$TF_BunchweightIncrTarget_sum, nrow(fruit_df))
    treefruit_df$T_FruitInc_DW <- rep(treepcomp_df[treepcomp_df$PlantComp == "DW", ]$T_FruitInc, nrow(fruit_df))
    treefruit_df$T_Treesperha <- rep(tree_df$T_Treesperha, nrow(fruit_df))
    treefruit_df$TF_BunchWeightIncrAct <- ifelse(
      treefruit_df$TF_BunchweightIncrTarget_sum > 0,
      treefruit_df$T_FruitInc_DW *
        (
          treefruit_df$TF_BunchweightIncrTarget / treefruit_df$TF_BunchweightIncrTarget_sum
        ) * 10^4 / treefruit_df$T_Treesperha,
      0
    )
    
    # TF_FruitLitterfall[Tree,Fruitbunch] = TF_FruitLitterFalloAm[Tree,Fruitbunch]
    treefruit_df$TF_FruitLitterfall <- treefruit_df$TF_FruitLitterFalloAm
    
    # TF_BunchNo?[Tree] = If TF_BunchWeightHarvest[Tree,Ripe]>0 then 1 else 0
    tree_df$TF_BunchNo_is <- ifelse(treefruit_df[treefruit_df$Fruitbunch == "Ripe", ]$TF_BunchWeightHarvest > 0, 1, 0)
    
    # TF_BunchNo[Tree] = TF_BunchNo?[Tree]
    tree_df$TF_BunchNo <- tree_df$TF_BunchNo_is
    
    # TF_TargetOilPrev[Sp1,Ripe] = TF_TargetOilperBunch[Sp1,Ripe_1]
    # TF_TargetOilPrev[Sp1,Ripe_1] = TF_TargetOilperBunch[Sp1,Ripe_2]
    # TF_TargetOilPrev[Sp1,Ripe_2] = TF_TargetOilperBunch[Sp1,Ripe_3]
    # TF_TargetOilPrev[Sp1,Ripe_3] = TF_TargetOilperBunch[Sp1,Ripe_4]
    # TF_TargetOilPrev[Sp1,Ripe_4] = TF_TargetOilperBunch[Sp1,Ripe_5]
    # TF_TargetOilPrev[Sp1,Ripe_5] = TF_TargetOilperBunch[Sp1,Ripe_6]
    # TF_TargetOilPrev[Sp1,Ripe_6] = TF_TargetOilperBunch[Sp1,Ripe_7]
    # TF_TargetOilPrev[Sp1,Ripe_7] = TF_TargetOilperBunch[Sp1,Ripe_8]
    # TF_TargetOilPrev[Sp1,Ripe_8] = TF_TargetOilperBunch[Sp1,Ripe_9]
    # TF_TargetOilPrev[Sp1,Ripe_9] = TF_TargetOilperBunch[Sp1,Ripe_10]
    # TF_TargetOilPrev[Sp1,Ripe_10] = TF_TargetOilperBunch[Sp1,Ripe_11]
    # TF_TargetOilPrev[Sp1,Ripe_11] = TF_TargetOilperBunch[Sp1,Ripe_12]
    # TF_TargetOilPrev[Sp1,Ripe_12] = TF_TargetOilperBunch[Sp1,Early_fruit]
    # TF_TargetOilPrev[Sp1,Early_fruit] = TF_TargetOilperBunch[Sp1,Pollinated]
    # TF_TargetOilPrev[Sp1,Pollinated] = TF_TargetOilperBunch[Sp1,Anthesis]
    # TF_TargetOilPrev[Sp1,Anthesis] = TF_TargetOilperBunch[Sp1,Anthesis_1]
    # TF_TargetOilPrev[Sp1,Anthesis_1] = TF_TargetOilperBunch[Sp1,Anthesis_2]
    # TF_TargetOilPrev[Sp1,Anthesis_2] = TF_TargetOilperBunch[Sp1,Anthesis_3]
    # TF_TargetOilPrev[Sp1,Anthesis_3] = TF_TargetOilperBunch[Sp1,Anthesis_4]
    # TF_TargetOilPrev[Sp1,Anthesis_4] = TF_TargetOilperBunch[Sp1,Anthesis_5]
    # TF_TargetOilPrev[Sp1,Anthesis_5] = TF_TargetOilperBunch[Sp1,Anthesis_6]
    # TF_TargetOilPrev[Sp1,Anthesis_6] = 0*TF_TargetOilperBunch[Sp1,Anthesis_6]
    # TF_TargetOilPrev[Sp2,Ripe] = TF_TargetOilperBunch[Sp2,Ripe_1]
    # TF_TargetOilPrev[Sp2,Ripe_1] = TF_TargetOilperBunch[Sp2,Ripe_2]
    # TF_TargetOilPrev[Sp2,Ripe_2] = TF_TargetOilperBunch[Sp2,Ripe_3]
    # TF_TargetOilPrev[Sp2,Ripe_3] = TF_TargetOilperBunch[Sp2,Ripe_4]
    # TF_TargetOilPrev[Sp2,Ripe_4] = TF_TargetOilperBunch[Sp2,Ripe_5]
    # TF_TargetOilPrev[Sp2,Ripe_5] = TF_TargetOilperBunch[Sp2,Ripe_6]
    # TF_TargetOilPrev[Sp2,Ripe_6] = TF_TargetOilperBunch[Sp2,Ripe_7]
    # TF_TargetOilPrev[Sp2,Ripe_7] = TF_TargetOilperBunch[Sp2,Ripe_8]
    # TF_TargetOilPrev[Sp2,Ripe_8] = TF_TargetOilperBunch[Sp2,Ripe_9]
    # TF_TargetOilPrev[Sp2,Ripe_9] = TF_TargetOilperBunch[Sp2,Ripe_10]
    # TF_TargetOilPrev[Sp2,Ripe_10] = TF_TargetOilperBunch[Sp2,Ripe_11]
    # TF_TargetOilPrev[Sp2,Ripe_11] = TF_TargetOilperBunch[Sp2,Ripe_12]
    # TF_TargetOilPrev[Sp2,Ripe_12] = TF_TargetOilperBunch[Sp2,Early_fruit]
    # TF_TargetOilPrev[Sp2,Early_fruit] = TF_TargetOilperBunch[Sp2,Pollinated]
    # TF_TargetOilPrev[Sp2,Pollinated] = TF_TargetOilperBunch[Sp2,Anthesis]
    # TF_TargetOilPrev[Sp2,Anthesis] = TF_TargetOilperBunch[Sp2,Anthesis_1]
    # TF_TargetOilPrev[Sp2,Anthesis_1] = TF_TargetOilperBunch[Sp2,Anthesis_2]
    # TF_TargetOilPrev[Sp2,Anthesis_2] = TF_TargetOilperBunch[Sp2,Anthesis_3]
    # TF_TargetOilPrev[Sp2,Anthesis_3] = TF_TargetOilperBunch[Sp2,Anthesis_4]
    # TF_TargetOilPrev[Sp2,Anthesis_4] = TF_TargetOilperBunch[Sp2,Anthesis_5]
    # TF_TargetOilPrev[Sp2,Anthesis_5] = TF_TargetOilperBunch[Sp2,Anthesis_6]
    # TF_TargetOilPrev[Sp2,Anthesis_6] = 0*TF_TargetOilperBunch[Sp1,Anthesis_6]
    # TF_TargetOilPrev[Sp3,Ripe] = TF_TargetOilperBunch[Sp3,Ripe_1]
    # TF_TargetOilPrev[Sp3,Ripe_1] = TF_TargetOilperBunch[Sp3,Ripe_2]
    # TF_TargetOilPrev[Sp3,Ripe_2] = TF_TargetOilperBunch[Sp3,Ripe_3]
    # TF_TargetOilPrev[Sp3,Ripe_3] = TF_TargetOilperBunch[Sp3,Ripe_4]
    # TF_TargetOilPrev[Sp3,Ripe_4] = TF_TargetOilperBunch[Sp3,Ripe_5]
    # TF_TargetOilPrev[Sp3,Ripe_5] = TF_TargetOilperBunch[Sp3,Ripe_6]
    # TF_TargetOilPrev[Sp3,Ripe_6] = TF_TargetOilperBunch[Sp3,Ripe_7]
    # TF_TargetOilPrev[Sp3,Ripe_7] = TF_TargetOilperBunch[Sp3,Ripe_8]
    # TF_TargetOilPrev[Sp3,Ripe_8] = TF_TargetOilperBunch[Sp3,Ripe_9]
    # TF_TargetOilPrev[Sp3,Ripe_9] = TF_TargetOilperBunch[Sp3,Ripe_10]
    # TF_TargetOilPrev[Sp3,Ripe_10] = TF_TargetOilperBunch[Sp3,Ripe_11]
    # TF_TargetOilPrev[Sp3,Ripe_11] = TF_TargetOilperBunch[Sp3,Ripe_12]
    # TF_TargetOilPrev[Sp3,Ripe_12] = TF_TargetOilperBunch[Sp3,Early_fruit]
    # TF_TargetOilPrev[Sp3,Early_fruit] = TF_TargetOilperBunch[Sp3,Pollinated]
    # TF_TargetOilPrev[Sp3,Pollinated] = TF_TargetOilperBunch[Sp3,Anthesis]
    # TF_TargetOilPrev[Sp3,Anthesis] = TF_TargetOilperBunch[Sp3,Anthesis_1]
    # TF_TargetOilPrev[Sp3,Anthesis_1] = TF_TargetOilperBunch[Sp3,Anthesis_2]
    # TF_TargetOilPrev[Sp3,Anthesis_2] = TF_TargetOilperBunch[Sp3,Anthesis_3]
    # TF_TargetOilPrev[Sp3,Anthesis_3] = TF_TargetOilperBunch[Sp3,Anthesis_4]
    # TF_TargetOilPrev[Sp3,Anthesis_4] = TF_TargetOilperBunch[Sp3,Anthesis_5]
    # TF_TargetOilPrev[Sp3,Anthesis_5] = TF_TargetOilperBunch[Sp3,Anthesis_6]
    # TF_TargetOilPrev[Sp3,Anthesis_6] = 0*TF_TargetOilperBunch[Sp1,Anthesis_6]
    treefruit_df$TF_TargetOilPrev <- c(treefruit_df[treefruit_df$Fruitbunch != "Ripe", ]$TF_TargetOilperBunch, 0, 0, 0)
    
    # TF_RelAgeNewLf[Tree] = if Simulation_Time <T_PlantTime[Tree] then 0 else if TF_PhyllochronTime[Tree] = 0 then 0 else (Time-TF_LeafTime[Tree])/TF_PhyllochronTime[Tree]
    tree_df$TF_RelAgeNewLf <- ifelse(
      time < tree_df$T_PlantTime,
      0,
      ifelse(
        tree_df$TF_PhyllochronTime == 0,
        0,
        (time - tree_df$TF_LeafTime) / tree_df$TF_PhyllochronTime
      )
    )
    
    # TF_TargetOilCurr[Tree,Fruitbunch] = TF_TargetOilPrev[Tree,Fruitbunch]+TF_RelAgeNewLf[Tree]*(TF_TargetOilperBunch[Tree,Fruitbunch]-TF_TargetOilPrev[Tree,Fruitbunch])
    treefruit_df$TF_TargetOilCurr <- treefruit_df$TF_TargetOilPrev + tree_df$TF_RelAgeNewLf * (treefruit_df$TF_TargetOilperBunch - treefruit_df$TF_TargetOilPrev)
    
    # TF_OilinFruits[Tree,Fruitbunch] = TF_BunchWeight_kgpbunch[Tree,Fruitbunch]*TF_TargetOilCurr[Tree,Fruitbunch]
    treefruit_df$TF_OilinFruits <- treefruit_df$TF_BunchWeight_kgpbunch * treefruit_df$TF_TargetOilCurr
    
    # TF_OilHarvest[Tree] = if TF_BunchWeightHarvest[Tree,Ripe] > 0 then TF_OilinFruits[Tree,Ripe] else 0
    tree_df$TF_OilHarvest <- ifelse(treefruit_df[treefruit_df$Fruitbunch == "Ripe", ]$TF_BunchWeightHarvest > 0,
                                    treefruit_df[treefruit_df$Fruitbunch == "Ripe", ]$TF_OilinFruits,
                                    0)
    
    # TF_OilProd[Tree] = ARRAYSUM(TF_OilinFruits[Tree,*])+TF_CumOilHarvest[Tree]-TF_CumOilProd[Tree]
    tree_df$TF_OilProd <- aggregate(treefruit_df$TF_OilinFruits, treefruit_df["tree_id"], sum)$x + tree_df$TF_CumOilHarvest - tree_df$TF_CumOilProd
    
    # TF_DMStressChange[Tree] = TF_StreesUpdateFraction*(TF_DWSufficiency[Tree]-TF_DW_Sufficiency_Yesterday[Tree])
    tree_df$TF_DMStressChange <- TF_StreesUpdateFraction * (tree_df$TF_DWSufficiency - tree_df$TF_DW_Sufficiency_Yesterday)
    
    # TF_LeavesTargetF[Tree] = TF_TargetLeafAlloc[Tree]
    tree_df$TF_LeavesTargetF <- tree_df$TF_TargetLeafAlloc
    
    # TF_SexDetermination[Tree] = if TF_CurrentLeafNo[Tree] < TF_FirstBudtoFlowerInit[Tree] then 0 else if TF_NewLeaf?[Tree] = 0 then 0 else if ((T_GroRes[DW,Tree]+T_GrowStor[DW,Tree])/T_BiomAG[DW,Tree]<TF_MaleThresh[Tree]) or (TF_WatNutSuff[Tree]<(TF_MThreshtoWatStress[Tree])) then 1-TF_NextGender[Tree] else 2-TF_NextGender[Tree]
    tp_DW <- treepcomp_df[treepcomp_df$PlantComp == "DW", ]
    tree_df$TF_SexDetermination <- ifelse(
      tree_df$TF_CurrentLeafNo < tree_df$TF_FirstBudtoFlowerInit,
      0,
      ifelse(
        tree_df$TF_NewLeaf_is == 0,
        0,
        ifelse ((tp_DW$T_GroRes + tp_DW$T_GrowStor) / tp_DW$T_BiomAG < tree_df$TF_MaleThresh
                |
                  tree_df$TF_WatNutSuff < tree_df$TF_MThreshtoWatStress,
                1 - tree_df$TF_NextGender ,
                2 - tree_df$TF_NextGender
        )
      )
    )
    
    # TF_Herbivory[Tree] = T_Herbivory[DW,Tree]
    tree_df$TF_Herbivory <- treepcomp_df[treepcomp_df$PlantComp == "DW", ]$T_Herbivory
    
    # TF_StressRec[Tree] = TF_ForgetStress[Tree]*(TW_Posgro[Tree]-TF_RecentTWPosgro[Tree])
    tree_df$TF_StressRec <- tree_df$TF_ForgetStress * (tree_df$TW_Posgro - tree_df$TF_RecentTWPosgro)
    
    # TF_TrunkTargetF[Tree] = TF_TrunkBiomass_GrowthAllocation[Tree]
    tree_df$TF_TrunkTargetF <- tree_df$TF_TrunkBiomass_GrowthAllocation
    
    
    # TF_YNewLeafF?[Tree] = -TF_YNewLeaf?[Tree]+TF_NewLeaf?[Tree]
    tree_df$TF_YNewLeafF_is <- -tree_df$TF_YNewLeaf_is + tree_df$TF_NewLeaf_is
    
    # TP_RelNutSupply[Tree] = if TP_Nutrient_Demand[Tree,N] = 0 then 0 else min(1,T_NUptTot[N,Tree]/TP_Nutrient_Demand[Tree,N],T_NUptTot[P,Tree]/TP_Nutrient_Demand[Tree,P])
    tn_N <- treenut_df[treenut_df$SlNut == "N", ]
    tn_P <- treenut_df[treenut_df$SlNut == "P", ]
    tree_df$TP_RelNutSupply <- ifelse(
      tn_N$TP_Nutrient_Demand == 0,
      0,
      pmin(
        1,
        tn_N$T_NUptTot / tn_N$TP_Nutrient_Demand,
        tn_P$T_NUptTot / tn_P$TP_Nutrient_Demand
      )
    )
    
    # TP_RelNutSupplChange[Tree] = TP_RelNutSupply[Tree]-TP_RelNutSupplyDelayed[Tree]
    tree_df$TP_RelNutSupplChange <- tree_df$TP_RelNutSupply - tree_df$TP_RelNutSupplyDelayed
    
    # RT_TAmount1[Zone,Tree] = RT_TLrv1[Zone,Tree]*AF_DepthAct1[Zone]*100
    # RT_TAmount2[Zone,Tree] = AF_Depth2[Zone]*RT_TLrv2[Zone,Tree]*100
    # RT_TAmount3[Zone,Tree] = AF_Depth3[Zone]*RT_TLrv3[Zone,Tree]*100
    # RT_TAmount4[Zone,Tree] = AF_Depth4[Zone]*RT_TLrv4[Zone,Tree]*100
    zonelayertree_df$RT_TAmount <- zonelayertree_df$AF_Depth * zonelayertree_df$RT_TLrv *
      100
    
    # RT_TAmount[Zone,Tree] = RT_TAmount1[Zone,Tree]+RT_TAmount2[Zone,Tree]+RT_TAmount3[Zone,Tree]+RT_TAmount4[Zone,Tree]
    zonetree_df$RT_TAmount <- aggregate(zonelayertree_df$RT_TAmount, zonelayertree_df[c("zone", "tree_id")], sum)$x
    
    # RT_TAmountPerTree[Tree] = AF_ZoneFrac[Zn1]*RT_TAmount[Zn1,Tree]+AF_ZoneFrac[Zn2]*RT_TAmount[Zn2,Tree]+AF_ZoneFrac[Zn3]*RT_TAmount[Zn3,Tree]+AF_ZoneFrac[Zn4]*RT_TAmount[Zn4,Tree]
    tree_df$RT_TAmountPerTree <- aggregate(zonetree_df$AF_ZoneFrac * zonetree_df$RT_TAmount,
                                           zonetree_df["tree_id"],
                                           sum)$x
    
    # TW_YDayUptChange[Tree] = if RT_TAmountPerTree[Tree] <> 0 then -TW_DemandPerRoot[Tree]+TW_DemandPot[Tree]/RT_TAmountPerTree[Tree] else 0
    tree_df$TW_YDayUptChange <- ifelse(
      tree_df$RT_TAmountPerTree != 0,
      -tree_df$TW_DemandPerRoot + tree_df$TW_DemandPot / tree_df$RT_TAmountPerTree,
      0
    )
    
    # W_V4DrainF[Zone] = W_V4Drain[Zone]
    zone_df$W_V4DrainF <- zone_df$W_V4Drain
    
    
    # BC_CO2fromBurn = (AF_ZoneFrac[Zn1]*(S&B_DWlossfromBurn[Zn1]+S&B_AerosolProd[Zn1])+AF_ZoneFrac[Zn2]*(S&B_DWlossfromBurn[Zn2]+S&B_AerosolProd[Zn2])+AF_ZoneFrac[Zn3]*(S&B_DWlossfromBurn[Zn3]+S&B_AerosolProd[Zn3])+AF_ZoneFrac[Zn4]*(S&B_DWlossfromBurn[Zn4]+S&B_AerosolProd[Zn4]))*1000*Mc_Carbon
    BC_CO2fromBurn <- sum(zone_df$AF_ZoneFrac * (zone_df$SB_DWlossfromBurn + zone_df$SB_AerosolProd)) *
      1000 * MC_Carbon
    
    # BC_TreeInitTot = BC_TPlantMatTot
    BC_TreeInitTot <- BC_TPlantMatTot
    
    # BC_CstocksInit = BC_SOMInit+BC_TreeInit+BC_TreeInitTot
    BC_CstocksInit <- BC_SOMInit + BC_TreeInit + BC_TreeInitTot
    
    # BC_ChangStock =  BC_CurrentCStock-BC_CstocksInit
    BC_ChangStock <-  BC_CurrentCStock - BC_CstocksInit
    
    # GHG_N2O_EmField = AF_ZoneFrac[Zn1]*GHG_Nitrous_Oxide_EmZn[Zn1]+AF_ZoneFrac[Zn2]*GHG_Nitrous_Oxide_EmZn[Zn2]+AF_ZoneFrac[Zn3]*GHG_Nitrous_Oxide_EmZn[Zn3]+AF_ZoneFrac[Zn4]*GHG_Nitrous_Oxide_EmZn[Zn4]
    GHG_N2O_EmField <-  sum(zone_df$AF_ZoneFrac * zone_df$GHG_Nitrous_Oxide_EmZn)
    
    # GHG_Cum_CH4_emission = AF_ZoneFrac[Zn1]*GHG_Net_CH4_Em[Zn1]+AF_ZoneFrac[Zn2]*GHG_Net_CH4_Em[Zn2]+AF_ZoneFrac[Zn3]*GHG_Net_CH4_Em[Zn3]+AF_ZoneFrac[Zn4]*GHG_Net_CH4_Em[Zn4]
    GHG_Cum_CH4_emission <-  sum(zone_df$AF_ZoneFrac * zone_df$GHG_Net_CH4_Em)
    
    # GHG_GWP_N2O&CH4 = GHG_GWP_N2O*GHG_N2O_EmField+GHG_Cum_CH4_emission*GHG_GWP_CH4
    GHG_GWP_N2O_CH4 <- GHG_GWP_N2O * GHG_N2O_EmField + GHG_Cum_CH4_emission *
      GHG_GWP_CH4
    
    # BC_GWeffect_CO2_eq_g_per_m2 = -BC_ChangStock*44/12 + GHG_GWP_N2O&CH4
    BC_GWeffect_CO2_eq_g_per_m2 <- -BC_ChangStock * 44 / 12 + GHG_GWP_N2O_CH4
    
    # C_FracLim[Limiting_Factors] = if ARRAYSUM(C_CropDays[*])>4 then ARRAYSUM(C_CumLim[*,Limiting_Factors])/(ARRAYSUM(C_CropDays[*])-4) else 0
    limit_df$C_CropDays <- rep(sum(zone_df$C_CropDays), nrow(limit_df))
    limit_df$C_FracLim <- ifelse(
      limit_df$C_CropDays > 4,
      aggregate(zonelimit_df$C_CumLim, zonelimit_df["Limiting_Factors"], sum)$x /
        (limit_df$C_CropDays - 4),
      0
    )
    
    # Cent2_BalPos[SlNut] = Cent2_SOMMetStrInit[SlNut]+Cent2_SOMPoolsInit[SlNut]+Cent2_SOMNinflow[SlNut]+Cent2_LitSomTransfAcc[SlNut]
    nut_df$CENT2_BalPos <- nut_df$CENT2_SOMMetStrInit + nut_df$CENT2_SOMPoolsInit +
      nut_df$CENT2_SOMNinflow + nut_df$CENT2_LitSomTransfAcc
    
    # BN_Som[N] = AF_ZoneFrac[Zn1]*(ARRAYSUM(MN2_Metab[Zn1,*])+ARRAYSUM(MN2_Struc[Zn1,*])+ARRAYSUM(MN2_Act[Zn1, *])+ARRAYSUM(MN2_Slw[Zn1,*])+ ARRAYSUM(MN2_Pass[Zn1, *]))+AF_ZoneFrac[Zn2]*(ARRAYSUM(MN2_Metab[Zn2,*])+ARRAYSUM(MN2_Struc[Zn2,*])+ARRAYSUM(MN2_Act[Zn2, *])+ARRAYSUM(MN2_Slw[Zn2,*])+ ARRAYSUM(MN2_Pass[Zn2, *]))+AF_ZoneFrac[Zn3]*(ARRAYSUM(MN2_Metab[Zn3,*])+ARRAYSUM(MN2_Struc[Zn3,*])+ARRAYSUM(MN2_Act[Zn3, *])+ARRAYSUM(MN2_Slw[Zn3,*])+ ARRAYSUM(MN2_Pass[Zn3, *]))+AF_ZoneFrac[Zn4]*(ARRAYSUM(MN2_Metab[Zn4,*])+ARRAYSUM(MN2_Struc[Zn4,*])+ARRAYSUM(MN2_Act[Zn4, *])+ARRAYSUM(MN2_Slw[Zn4,*])+ ARRAYSUM(MN2_Pass[Zn4, *]))+0*(MP2_Act[Zn1,1]+MP2_Metab[Zn1,1]+MP2_Pass[Zn1,1]+MP2_Slw[Zn1,1]+MP2_Struc[Zn1,1])
    # BN_Som[P] = AF_ZoneFrac[Zn1]*(ARRAYSUM(MP2_Metab[Zn1,*])+ARRAYSUM(MP2_Struc[Zn1,*])+ARRAYSUM(MP2_Act[Zn1, *])+ARRAYSUM(MP2_Slw[Zn1,*])+ ARRAYSUM(MP2_Pass[Zn1,*]))+AF_ZoneFrac[Zn2]*(ARRAYSUM(MP2_Metab[Zn2,*])+ARRAYSUM(MP2_Struc[Zn2,*])+ARRAYSUM(MP2_Act[Zn2, *])+ARRAYSUM(MP2_Slw[Zn2,*])+ ARRAYSUM(MP2_Pass[Zn2,*]))+AF_ZoneFrac[Zn3]*(ARRAYSUM(MP2_Metab[Zn3,*])+ARRAYSUM(MP2_Struc[Zn3,*])+ARRAYSUM(MP2_Act[Zn3, *])+ARRAYSUM(MP2_Slw[Zn3,*])+ ARRAYSUM(MP2_Pass[Zn3,*]))+AF_ZoneFrac[Zn4]*(ARRAYSUM(MP2_Metab[Zn4,*])+ARRAYSUM(MP2_Struc[Zn4,*])+ARRAYSUM(MP2_Act[Zn4,*])+ARRAYSUM(MP2_Slw[Zn4,*])+ ARRAYSUM(MP2_Pass[Zn4,*]))+0*(MN2_Act[Zn1,1]+MN2_Metab[Zn1,1]+MN2_Pass[Zn1,1]+MN2_Slw[Zn1,1]+MN2_Struc[Zn1,1])
    nut_df$BN_Som <- c(
      sum(
        zone_df$AF_ZoneFrac * aggregate(
          zonelayer_df$MN2_Metab + zonelayer_df$MN2_Struc + zonelayer_df$MN2_Act +
            zonelayer_df$MN2_Slw + zonelayer_df$MN2_Pass,
          zonelayer_df["zone"],
          sum
        )$x
      )
      ,
      sum(
        zone_df$AF_ZoneFrac * aggregate(
          zonelayer_df$MP2_Metab + zonelayer_df$MP2_Struc + zonelayer_df$MP2_Act +
            zonelayer_df$MP2_Slw + zonelayer_df$MP2_Pass,
          zonelayer_df["zone"],
          sum
        )$x
      )
    )
    
    # BN_OrgNP_leached[N] = AF_ZoneFrac[Zn1]*MN2_OrgNLeached[Zn1]+AF_ZoneFrac[Zn2]*MN2_OrgNLeached[Zn2]+AF_ZoneFrac[Zn3]*MN2_OrgNLeached[Zn3]+AF_ZoneFrac[Zn4]*MN2_OrgNLeached[Zn4]+0*MP2_OrgP_Leached[Zn1]
    # BN_OrgNP_leached[P] = AF_ZoneFrac[Zn1]*MP2_OrgP_Leached[Zn1]+AF_ZoneFrac[Zn2]*MP2_OrgP_Leached[Zn2]+AF_ZoneFrac[Zn3]*MP2_OrgP_Leached[Zn3]+AF_ZoneFrac[Zn4]*MP2_OrgP_Leached[Zn4]+0*MN2_OrgNLeached[Zn1]
    nut_df$BN_OrgNP_leached <- c(
      sum(zone_df$AF_ZoneFrac * zone_df$MN2_OrgNLeached),
      sum(zone_df$AF_ZoneFrac * zone_df$MP2_OrgP_Leached)
    )
    
    # MNP_MinNutPool[Zn1,N] = ARRAYSUM(MN2_MinNutpool[Zn1,*])+0*MP2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn1,P] = ARRAYSUM(MP2_MinNutpool[Zn1,*])+0*MN2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn2,N] = ARRAYSUM(MN2_MinNutpool[Zn2,*])+0*MP2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn2,P] = ARRAYSUM(MP2_MinNutpool[Zn2,*])+0*MN2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn3,N] = ARRAYSUM(MN2_MinNutpool[Zn3,*])+0*MP2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn3,P] = ARRAYSUM(MP2_MinNutpool[Zn3,*])+0*MN2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn4,N] = ARRAYSUM(MN2_MinNutpool[Zn4,*])+0*MP2_MinNutpool[Zn1,1]
    # MNP_MinNutPool[Zn4,P] = ARRAYSUM(MP2_MinNutpool[Zn4,*])+0*MN2_MinNutpool[Zn1,1]
    zonenut_df$MNP_MinNutPool <- c(
      aggregate(zonelayer_df$MN2_MinNutpool, zonelayer_df["zone"], sum)$x,
      aggregate(zonelayer_df$MP2_MinNutpool, zonelayer_df["zone"], sum)$x
    )
    
    # Cent2_BalNeg[SlNut] = Cent2_NOut[SlNut]+BN_Som[SlNut]+BN_OrgNP_leached[SlNut]+MNP_MinNutPool[Zn1,SlNut]*AF_ZoneFrac[Zn1]+MNP_MinNutPool[Zn2,SlNut]*AF_ZoneFrac[Zn2]+MNP_MinNutPool[Zn3,SlNut]*AF_ZoneFrac[Zn3]+MNP_MinNutPool[Zn4,SlNut]*AF_ZoneFrac[Zn4]
    nut_df$CENT2_BalNeg <- nut_df$CENT2_NOut + nut_df$BN_Som + nut_df$BN_OrgNP_leached +
      aggregate(zonenut_df$MNP_MinNutPool * zonenut_df$AF_ZoneFrac,
                zonenut_df["SlNut"],
                sum)$x
    
    # Cent2_Bal_SOM[SlNut] = Cent2_BalPos[SlNut]-Cent2_BalNeg[SlNut]
    nut_df$CENT2_Bal_SOM <- nut_df$CENT2_BalPos - nut_df$CENT2_BalNeg
    
    # Cent_BalPos[SlNut] = Cent2_LitMetStrInit[SlNut]+Cent2_LittPoolsInit[SlNut]+Cent_LitterNInflow[SlNut]+Cent_ExtOrgInputs[SlNut]
    nut_df$CENT_BalPos <- nut_df$CENT2_LitMetStrInit + nut_df$CENT2_LittPoolsInit +
      nut_df$CENT_LitterNInflow + nut_df$CENT_ExtOrgInputs
    
    # BN_Lit[SlNut] = AF_ZoneFrac[Zn1]*(Mn_Slw[Zn1,SlNut]+Mn_Pass[Zn1,SlNut]+Mn_Act[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(Mn_Slw[Zn2,SlNut]+Mn_Pass[Zn2,SlNut]+Mn_Act[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(Mn_Slw[Zn3,SlNut]+Mn_Pass[Zn3,SlNut]+Mn_Act[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(Mn_Slw[Zn4,SlNut]+Mn_Pass[Zn4,SlNut]+Mn_Act[Zn4,SlNut])+AF_ZoneFrac[Zn1]*(Mn_Metab[Zn1,SlNut]+Mn_Struc[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(Mn_Metab[Zn2,SlNut]+Mn_Struc[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(Mn_Metab[Zn3,SlNut]+Mn_Struc[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(Mn_Metab[Zn4,SlNut]+Mn_Struc[Zn4,SlNut])
    nut_df$BN_Lit <- aggregate(
      zonenut_df$AF_ZoneFrac * (
        zonenut_df$MN_Slw + zonenut_df$MN_Pass + zonenut_df$MN_Act + zonenut_df$MN_Metab +
          zonenut_df$MN_Struc
      ),
      zonenut_df["SlNut"],
      sum
    )$x
    
    # Mn_MinNutTot[SlNut] = AF_ZoneFrac[Zn1]*Mn_MinNutpool[Zn1,SlNut]+AF_ZoneFrac[Zn2]*Mn_MinNutpool[Zn2,SlNut]+AF_ZoneFrac[Zn3]*Mn_MinNutpool[Zn3,SlNut]+AF_ZoneFrac[Zn4]*Mn_MinNutpool[Zn4,SlNut]
    nut_df$MN_MinNutTot <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$MN_MinNutpool,
                                     zonenut_df["SlNut"],
                                     sum)$x
    
    # Cent_BalNeg[SlNut] = Cent_NOut[SlNut]+BN_Lit[SlNut]+Cent2_LitSomTransfAcc[SlNut]+Mn_MinNutTot[SlNut]
    nut_df$CENT_BalNeg <- nut_df$CENT_NOut + nut_df$BN_Lit + nut_df$CENT2_LitSomTransfAcc +
      nut_df$MN_MinNutTot
    
    # Cent_BalLitter[SlNut] = Cent_BalPos[SlNut]-Cent_BalNeg[SlNut]
    nut_df$CENT_BalLitter <- nut_df$CENT_BalPos - nut_df$CENT_BalNeg
    
    # Cent_Bal__NP_Total[SlNut] = Cent2_Bal_SOM[SlNut]+Cent_BalLitter[SlNut]
    nut_df$CENT_Bal_NP_Total <- nut_df$CENT2_Bal_SOM + nut_df$CENT_BalLitter
    
    # GHG_N2LossSubs[Zone] = N_N2LossCum2[Zone]+N_N2LossCum3[Zone]+N_N2LossCum4[Zone]
    zone_df$GHG_N2LossSubs <- aggregate(zonelayer_df[zonelayer_df$layer !=
                                                       1, "N_N2LossCum"], list(zone = zonelayer_df[zonelayer_df$layer != 1, "zone"]), sum)$x
    
    # GHG_NgasEmissionFCum =
    #   AF_ZoneFrac[Zn1]*(GHG_N2_EmZn[Zn1]+GHG_Nitric_Oxide_EmZn[Zn1]+GHG_Nitrous_Oxide_EmZn[Zn1]+GHG_N2LossSubs[Zn1])+
    #   AF_ZoneFrac[Zn2]*(GHG_N2_EmZn[Zn2]+GHG_Nitric_Oxide_EmZn[Zn2]+GHG_Nitrous_Oxide_EmZn[Zn2]+GHG_N2LossSubs[Zn2])+
    #   AF_ZoneFrac[Zn3]*(GHG_N2_EmZn[Zn3]+GHG_Nitric_Oxide_EmZn[Zn3]+GHG_Nitrous_Oxide_EmZn[Zn3]+GHG_N2LossSubs[Zn3])+
    #   AF_ZoneFrac[Zn4]*(GHG_N2_EmZn[Zn4]+GHG_Nitric_Oxide_EmZn[Zn4]+GHG_Nitrous_Oxide_EmZn[Zn4]+GHG_N2LossSubs[Zn4])
    GHG_NgasEmissionFCum <- sum(
      zone_df$AF_ZoneFrac * (
        zone_df$GHG_N2_EmZn + zone_df$GHG_Nitric_Oxide_EmZn + zone_df$GHG_Nitrous_Oxide_EmZn +
          zone_df$GHG_N2LossSubs
      )
    )
    
    # GHG_N2O_Fraction = if GHG_NgasEmissionFCum>0 then GHG_N2O_EmField/GHG_NgasEmissionFCum else 0
    GHG_N2O_Fraction <- ifelse(GHG_NgasEmissionFCum > 0 ,
                               GHG_N2O_EmField / GHG_NgasEmissionFCum,
                               0)
    
    # GHG_NO_EmField = AF_ZoneFrac[Zn1]*GHG_Nitric_Oxide_EmZn[Zn1]+AF_ZoneFrac[Zn2]*GHG_Nitric_Oxide_EmZn[Zn2]+AF_ZoneFrac[Zn3]*GHG_Nitric_Oxide_EmZn[Zn3]+AF_ZoneFrac[Zn4]*GHG_Nitric_Oxide_EmZn[Zn4]
    GHG_NO_EmField <- sum(zone_df$AF_ZoneFrac * zone_df$GHG_Nitric_Oxide_EmZn)
    
    # GHG_NO_Fraction = if GHG_NgasEmissionFCum>0 then GHG_NO_EmField/GHG_NgasEmissionFCum else 0
    GHG_NO_Fraction <- ifelse(GHG_NgasEmissionFCum > 0,
                              GHG_NO_EmField / GHG_NgasEmissionFCum,
                              0)
    
    # GHG_N2_Fraction = 1-GHG_N2O_Fraction-GHG_NO_Fraction
    GHG_N2_Fraction = 1 - GHG_N2O_Fraction - GHG_NO_Fraction
    
    # Light_CRelSupply[Zone] = if C_CropDays[Zone] = 0 then 0 else Light_CRefRelCapCum[Zone]/C_CropDays[Zone]
    zone_df$LIGHT_CRelSupply <- ifelse(zone_df$C_CropDays == 0,
                                       0,
                                       zone_df$LIGHT_CRefRelCapCum / zone_df$C_CropDays)
    
    # N_LossAcc1[Zone,SlNut] = N_VLeach1[Zone,SlNut]+N_HLeach1[Zone,SlNut]
    # N_LossAcc2[Zone,SlNut] = N_VLeach2[Zone,SlNut]+N_HLeach2[Zone,SlNut]
    # N_LossAcc3[Zone,SlNut] = N_VLeach3[Zone,SlNut]+N_HLeach3[Zone,SlNut]
    # N_LossAcc4[Zone,SlNut] = N_VLeach4[Zone,SlNut]+N_HLeach4[Zone,SlNut]
    zonelayernut_df$N_LossAcc <- zonelayernut_df$N_VLeach + zonelayernut_df$N_HLeach
    
    
    # N_TotUpt1i[Zone,SlNut] = N_UptCCum1[Zone,SlNut]+N_UptT1Cum1[Zone,SlNut]+N_UptT2Cum1[Zone,SlNut]+N_UptT3Cum1[Zone,SlNut]
    # N_TotUpt2i[Zone,SlNut] = N_UptCCum2[Zone,SlNut]+N_UptT1Cum2[Zone,SlNut]+N_UptT2Cum2[Zone,SlNut]+N_UptT3Cum2[Zone,SlNut]
    # N_TotUpt3i[Zone,SlNut] = N_UptCCum3[Zone,SlNut]+N_UptT1Cum3[Zone,SlNut]+N_UptT2Cum3[Zone,SlNut]+N_UptT3Cum3[Zone,SlNut]
    # N_TotUpt4i[Zone,SlNut] = N_UptCCum4[Zone,SlNut]+N_UptT1Cum4[Zone,SlNut]+N_UptT2Cum4[Zone,SlNut]+N_UptT3Cum4[Zone,SlNut]
    zonelayernut_df$N_TotUpti <- zonelayernut_df$N_UptCCum + zonelayertreenut_df[zonelayertreenut_df$tree_id == 1, ]$N_UptTCum +
      zonelayertreenut_df[zonelayertreenut_df$tree_id == 2, ]$N_UptTCum + zonelayertreenut_df[zonelayertreenut_df$tree_id == 3, ]$N_UptTCum
    
    # N_LocFF1i[Zone,SlNut] = if N_TotUpt1i[Zone,SlNut]+N_Loss1iCum[Zone,SlNut] > 0 then N_TotUpt1i[Zone,SlNut]/(N_Loss1iCum[Zone,SlNut]+N_TotUpt1i[Zone,SlNut]) else 0
    # N_LocFF2i[Zone,SlNut] = if N_TotUpt2i[Zone,SlNut]+N_Loss2iCum[Zone,SlNut]>0 then N_TotUpt2i[Zone,SlNut]/(N_TotUpt2i[Zone,SlNut]+N_Loss2iCum[Zone,SlNut]) else 0
    # N_LocFF3i[Zone,SlNut] = if N_Loss3iCum[Zone,SlNut]+N_TotUpt3i[Zone,SlNut] > 0 then N_TotUpt3i[Zone,SlNut]/(N_Loss3iCum[Zone,SlNut]+N_TotUpt3i[Zone,SlNut]) else 0
    # N_LocFF4i[Zone,SlNut] = if N_TotUpt4i[Zone,SlNut]+N_Loss4iCum[Zone,SlNut] > 0 then N_TotUpt4i[Zone,SlNut]/(N_TotUpt4i[Zone,SlNut]+N_Loss4iCum[Zone,SlNut]) else 0
    zonelayernut_df$N_LocFFi <- ifelse(
      zonelayernut_df$N_TotUpti + zonelayernut_df$N_LossiCum > 0,
      zonelayernut_df$N_TotUpti / (zonelayernut_df$N_LossiCum +
                                     zonelayernut_df$N_TotUpti),
      0
    )
    
    # W_TUpt1[Zone] = W_T1Upt1[Zone]+W_T2Upt1[Zone]+W_T3Upt1[Zone]
    # W_TUpt2[Zone] = W_T1Upt2[Zone]+W_T2Upt2[Zone]+W_T3Upt2[Zone]
    # W_TUpt3[Zone] = W_T1Upt3[Zone]+W_T2Upt3[Zone]+W_T3Upt3[Zone]
    # W_TUpt4[Zone] = W_T1Upt4[Zone]+W_T2Upt4[Zone]+W_T3Upt4[Zone]
    zonelayer_df$W_TUpt <- aggregate(zonelayertree_df$W_Upt, zonelayertree_df[c("zone", "layer")], sum)$x
    
    # E_TopSoilDepthAct[Zone] = BS_SoilCurrZn[Zone]/E_BulkDens
    zone_df$E_TopSoilDepthAct <- zone_df$BS_SoilCurrZn / E_BulkDens
    
    
    # C_NHarvestCum[Zn1,N] = C_HarvestCum[Zn1,N]
    # C_NHarvestCum[Zn1,P] = C_HarvestCum[Zn1,P]
    # C_NHarvestCum[Zn2,N] = C_HarvestCum[Zn2,N]
    # C_NHarvestCum[Zn2,P] = C_HarvestCum[Zn2,P]
    # C_NHarvestCum[Zn3,N] = C_HarvestCum[Zn3,N]
    # C_NHarvestCum[Zn3,P] = C_HarvestCum[Zn3,P]
    # C_NHarvestCum[Zn4,N] = C_HarvestCum[Zn4,N]
    # C_NHarvestCum[Zn4,P] = C_HarvestCum[Zn4,P]
    zonenut_df$C_NHarvestCum <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), ]$C_HarvestCum
    
    # BN_CHarvCum[SlNut] = C_NHarvestCum[Zn1,SlNut]*AF_ZoneFrac[Zn1]+C_NHarvestCum[Zn2,SlNut]*AF_ZoneFrac[Zn2]+C_NHarvestCum[Zn3,SlNut]*AF_ZoneFrac[Zn3]+C_NHarvestCum[Zn4,SlNut]*AF_ZoneFrac[Zn4]
    nut_df$BN_CHarvCum <- aggregate(zonenut_df$C_NHarvestCum * zonenut_df$AF_ZoneFrac,
                                    zonenut_df["SlNut"],
                                    sum)$x
    
    # BN_CNFixCum[SlNut] = C_NDfaTot[Zn1,SlNut]*AF_ZoneFrac[Zn1]+C_NDfaTot[Zn2,SlNut]*AF_ZoneFrac[Zn2]+C_NDfaTot[Zn3,SlNut]*AF_ZoneFrac[Zn3]+C_NDfaTot[Zn4,SlNut]*AF_ZoneFrac[Zn4]
    nut_df$BN_CNFixCum <- aggregate(zonenut_df$C_NDfaTot * zonenut_df$AF_ZoneFrac,
                                    zonenut_df["SlNut"],
                                    sum)$x
    
    # BN_CropBiom[SlNut] = AF_ZoneFrac[Zn1]*(C_NBiom[Zn1,SlNut]*(1-Cq_WeedZn?[Zn1]))+AF_ZoneFrac[Zn2]*(C_NBiom[Zn2,SlNut]*(1-Cq_WeedZn?[Zn2]))+AF_ZoneFrac[Zn3]*(C_NBiom[Zn3,SlNut]*(1-Cq_WeedZn?[Zn3]))+AF_ZoneFrac[Zn4]*(C_NBiom[Zn4,SlNut]*(1-Cq_WeedZn?[Zn4]))
    nut_df$BN_CropBiom <- aggregate(zonenut_df$AF_ZoneFrac * (zonenut_df$C_NBiom *
                                                                (1 - rep(
                                                                  zone_df$CQ_WeedZn_is, nrow(nut_df)
                                                                ))),
                                    zonenut_df["SlNut"],
                                    sum)$x
    
    # C_NResidRemoved[Zn1,N] = C_ResidRemoved[Zn1,N]
    # C_NResidRemoved[Zn1,P] = C_ResidRemoved[Zn1,P]
    # C_NResidRemoved[Zn2,N] = C_ResidRemoved[Zn2,N]
    # C_NResidRemoved[Zn2,P] = C_ResidRemoved[Zn2,P]
    # C_NResidRemoved[Zn3,N] = C_ResidRemoved[Zn3,N]
    # C_NResidRemoved[Zn3,P] = C_ResidRemoved[Zn3,P]
    # C_NResidRemoved[Zn4,N] = C_ResidRemoved[Zn4,N]
    # C_NResidRemoved[Zn4,P] = C_ResidRemoved[Zn4,P]
    zonenut_df$C_NResidRemoved <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_ResidRemoved"]
    
    # BN_CResidRemoved[SlNut] = AF_ZoneFrac[Zn1]*C_NResidRemoved[Zn1,SlNut]+AF_ZoneFrac[Zn2]*C_NResidRemoved[Zn2,SlNut]+AF_ZoneFrac[Zn3]*C_NResidRemoved[Zn3,SlNut]+AF_ZoneFrac[Zn4]*C_NResidRemoved[Zn4,SlNut]
    nut_df$BN_CResidRemoved <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$C_NResidRemoved,
                                         zonenut_df["SlNut"],
                                         sum)$x
    
    # BN_LatOutCum[SlNut] = (N_LatOutflowCum1[SlNut]+N_LatOutflowCum2[SlNut]+N_LatOutflowCum3[SlNut]+N_LatOutflowCum4[SlNut])*AF_ZoneFrac[Zn1]
    nut_df$BN_LatOutCum <- aggregate(layernut_df$N_LatOutflowCum, layernut_df["SlNut"], sum)$x *
      zone_df[zone_df$zone == 1, "AF_ZoneFrac"]
    
    # BN_LeachingTot[SlNut] = N_LeachCumV[Zn1,SlNut]*AF_ZoneFrac[Zn1]+N_LeachCumV[Zn2,SlNut]*AF_ZoneFrac[Zn2]+N_LeachCumV[Zn3,SlNut]*AF_ZoneFrac[Zn3]+N_LeachCumV[Zn4,SlNut]*AF_ZoneFrac[Zn4]
    nut_df$BN_LeachingTot <- aggregate(zonenut_df$N_LeachCumV * zonenut_df$AF_ZoneFrac,
                                       zonenut_df["SlNut"],
                                       sum)$x
    
    # BN_NutVolatCum[N] = AF_ZoneFrac[Zn1]*(S&B_Nutvolatilized[Zn1,N]+N_N2LossCum1[Zn1]+N_N2LossCum2[Zn1]+N_N2LossCum3[Zn1]+N_N2LossCum4[Zn1])+
    #   AF_ZoneFrac[Zn2]*(S&B_Nutvolatilized[Zn2,N]+N_N2LossCum1[Zn2]+N_N2LossCum2[Zn2]+N_N2LossCum3[Zn2]+N_N2LossCum4[Zn2])+
    #   AF_ZoneFrac[Zn3]*(S&B_Nutvolatilized[Zn3,N]+N_N2LossCum1[Zn3]+N_N2LossCum2[Zn3]+N_N2LossCum3[Zn3]+N_N2LossCum4[Zn3])+
    #   AF_ZoneFrac[Zn4]*(S&B_Nutvolatilized[Zn4,N]+N_N2LossCum1[Zn4]+N_N2LossCum2[Zn4]+N_N2LossCum3[Zn4]+N_N2LossCum4[Zn4])
    # BN_NutVolatCum[P] = AF_ZoneFrac[Zn1]*S&B_Nutvolatilized[Zn1,P]+AF_ZoneFrac[Zn2]*S&B_Nutvolatilized[Zn2,P]+
    #   AF_ZoneFrac[Zn3]*S&B_Nutvolatilized[Zn3,P]+AF_ZoneFrac[Zn4]*S&B_Nutvolatilized[Zn4,P]+ 0* (N_N2LossCum1[Zn1]+N_N2LossCum2[Zn1]+N_N2LossCum3[Zn1]+N_N2LossCum4[Zn1])
    zone_df$N_N2LossCum_sum <- aggregate(zonelayer_df$N_N2LossCum, zonelayer_df["zone"], sum)$x
    nut_df$BN_NutVolatCum <- aggregate(
      zonenut_df$AF_ZoneFrac * (
        zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "SB_Nutvolatilized"] + c(zone_df$N_N2LossCum_sum, rep(0, 4))
      ),
      zonenut_df["SlNut"],
      sum
    )$x
    
    # BN_SurfRO[SlNut] = BN_RunOffLoss[SlNut]*AF_ZoneFrac[Zn1]
    nut_df$BN_SurfRO <- nut_df$BN_RunOffLoss * zone_df[zone_df$zone == 1, "AF_ZoneFrac"]
    
    # BN_ScorchWRem[PlantComp] = AF_ZoneFrac[Zn1]*S&B_ScorchWoodRemoved[Zn1,PlantComp]+AF_ZoneFrac[Zn2]*S&B_ScorchWoodRemoved[Zn2,PlantComp]+AF_ZoneFrac[Zn3]*S&B_ScorchWoodRemoved[Zn3,PlantComp]+AF_ZoneFrac[Zn4]*S&B_ScorchWoodRemoved[Zn4,PlantComp]
    pcomp_df$BN_ScorchWRem <- aggregate(
      zonepcomp_df$AF_ZoneFrac * zonepcomp_df$SB_ScorchWoodRemoved,
      zonepcomp_df["PlantComp"],
      sum
    )$x
    
    # BN_THarvCumAll[PlantComp] = ARRAYSUM(T_PrunHarvCum[PlantComp,*])+ARRAYSUM(T_FruitCum[PlantComp,*])+ARRAYSUM(T_WoodHarvCum[PlantComp,*])+BN_ScorchWRem[PlantComp]+ARRAYSUM(T_CanBionTimCum[PlantComp,*])+Arraysum(T_GroResLossCum[PlantComp,*])
    pcomp_df$BN_THarvCumAll <-
      aggregate(treepcomp_df$T_PrunHarvCum, treepcomp_df["PlantComp"], sum)$x +
      aggregate(treepcomp_df$T_FruitCum, treepcomp_df["PlantComp"], sum)$x +
      aggregate(treepcomp_df$T_WoodHarvCum, treepcomp_df["PlantComp"], sum)$x +
      pcomp_df$BN_ScorchWRem +
      aggregate(treepcomp_df$T_CanBionTimCum, treepcomp_df["PlantComp"], sum)$x +
      aggregate(treepcomp_df$T_GroResLossCum, treepcomp_df["PlantComp"], sum)$x
    
    # BN_EffluxTot[N] = BN_CHarvCum[N]+BN_CResidRemoved[N]+BN_LatOutCum[N]+BN_LeachingTot[N]+BN_NutVolatCum[N]+BN_OrgNP_leached[N]+BN_SurfRO[N]+BN_THarvCumAll[N]
    # BN_EffluxTot[P] = BN_CHarvCum[P]+BN_CResidRemoved[P]+BN_LatOutCum[P]+BN_LeachingTot[P]+BN_NutVolatCum[P]+BN_OrgNP_leached[P]+BN_SurfRO[P]+BN_THarvCumAll[P]
    nut_df$BN_EffluxTot <- nut_df$BN_CHarvCum + nut_df$BN_CResidRemoved +
      nut_df$BN_LatOutCum + nut_df$BN_LeachingTot + nut_df$BN_NutVolatCum + nut_df$BN_OrgNP_leached +
      nut_df$BN_SurfRO + pcomp_df[pcomp_df$PlantComp %in% c("N", "P"), "BN_THarvCumAll"]
    
    # BN_Immob[SlNut] = AF_ZoneFrac[Zn1]*(N_ImmobileNut1[Zn1,SlNut]+N_ImmobileNut2[Zn1,SlNut]+N_ImmobileNut3[Zn1,SlNut]+N_ImmobileNut4[Zn1,SlNut])+AF_ZoneFrac[Zn2]*(N_ImmobileNut1[Zn2,SlNut]+N_ImmobileNut2[Zn2,SlNut]+N_ImmobileNut3[Zn2,SlNut]+N_ImmobileNut4[Zn2,SlNut])+AF_ZoneFrac[Zn3]*(N_ImmobileNut1[Zn3,SlNut]+N_ImmobileNut2[Zn3,SlNut]+N_ImmobileNut3[Zn3,SlNut]+N_ImmobileNut4[Zn3,SlNut])+AF_ZoneFrac[Zn4]*(N_ImmobileNut1[Zn4,SlNut]+N_ImmobileNut2[Zn4,SlNut]+N_ImmobileNut3[Zn4,SlNut]+N_ImmobileNut4[Zn4,SlNut])
    nut_df$BN_Immob <- aggregate(
      zonenut_df$AF_ZoneFrac * aggregate(zonelayernut_df$N_ImmobileNut, zonelayernut_df[c("zone", "SlNut")], sum)$x,
      zonenut_df["SlNut"],
      sum
    )$x
    
    # BN_CropInit[SlNut] = BN_CBiomInit[SlNut]+BN_WeedSeedInit[SlNut]
    nut_df$BN_CropInit <- nut_df$BN_CBiomInit + nut_df$BN_WeedSeedInit
    
    # BN_LatInCum[SlNut] = (N_LatInflowCum1[SlNut]+N_LatInflowCum2[SlNut]+N_LatInflowCum3[SlNut]+N_LatInFlowCum4[SlNut])*AF_ZoneFrac[Zn4]
    nut_df$BN_LatInCum <- aggregate(layernut_df$N_LatInflowCum, layernut_df["SlNut"], sum)$x * zone_df[zone_df$zone == 4, "AF_ZoneFrac"]
    
    # BN_RootBiomasNP[N] = ARRAYSUM(T_RtType0CumInput[N,*])
    # BN_RootBiomasNP[P] = ARRAYSUM(T_RtType0CumInput[P,*])
    nut_df$BN_RootBiomasNP <- aggregate(treepcomp_df[treepcomp_df$PlantComp %in% c("N", "P"), "T_RtType0CumInput"], treenut_df["SlNut"], sum)$x
    
    # BN_InfluxTot[SlNut] = BN_FertCum[SlNut]+ARRAYSUM(BN_TNFixAmountCum[SlNut,*])+BN_CNFixCum[SlNut]+BN_CropInit[SlNut]+BN_TreeInit[SlNut]+BN_LatInCum[SlNut]+BN_ExtOrgInputs[SlNut]+N_CumAtmInput[SlNut]+BN_RootBiomasNP[SlNut]
    nut_df$BN_InfluxTot <- nut_df$BN_FertCum + aggregate(treenut_df$BN_TNFixAmountCum, treenut_df["SlNut"], sum)$x +
      nut_df$BN_CNFixCum + nut_df$BN_CropInit + nut_df$BN_TreeInit + nut_df$BN_LatInCum +
      nut_df$BN_ExtOrgInputs + nut_df$N_CumAtmInput + nut_df$BN_RootBiomasNP
    
    # S&B_NecromasNP[Zn1,N] = S&B_DeadWood[Zn1,N]+S&B_FineNecromass[Zn1,N]
    # S&B_NecromasNP[Zn1,P] = S&B_DeadWood[Zn1,P]+S&B_FineNecromass[Zn1,P]
    # S&B_NecromasNP[Zn2,N] = S&B_FineNecromass[Zn2,N]+S&B_DeadWood[Zn2,N]
    # S&B_NecromasNP[Zn2,P] = S&B_FineNecromass[Zn2,P]+S&B_DeadWood[Zn2,P]
    # S&B_NecromasNP[Zn3,N] = S&B_FineNecromass[Zn3,N]+S&B_DeadWood[Zn3,N]
    # S&B_NecromasNP[Zn3,P] = S&B_FineNecromass[Zn3,P]+S&B_DeadWood[Zn3,P]
    # S&B_NecromasNP[Zn4,N] = S&B_FineNecromass[Zn4,N]+S&B_DeadWood[Zn4,N]
    # S&B_NecromasNP[Zn4,P] = S&B_FineNecromass[Zn4,P]+S&B_DeadWood[Zn4,P]
    zp_nut <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), c("SB_DeadWood", "SB_FineNecromass")]
    zonenut_df$SB_NecromasNP <- zp_nut$SB_DeadWood + zp_nut$SB_FineNecromass
    
    # BN_StockZone[Zone,SlNut] = N_Stock1[Zone,SlNut]+N_Stock2[Zone,SlNut]+N_Stock3[Zone,SlNut]+N_Stock4[Zone,SlNut]+S&B_NecromasNP[Zone,SlNut]+Mn_FertOnSoil[Zone,SlNut]+Mn_MinNutpool[Zone,SlNut]+MNP_MinNutPool[Zone,SlNut]
    zonenut_df$BN_StockZone <- aggregate(zonelayernut_df$N_Stock, zonelayernut_df[c("zone", "SlNut")], sum)$x +
      zonenut_df$SB_NecromasNP + zonenut_df$MN_FertOnSoil + zonenut_df$MN_MinNutpool +
      zonenut_df$MNP_MinNutPool
    
    # BN_SOMLit[SlNut] = BN_Som[SlNut]+BN_Lit[SlNut]
    nut_df$BN_SOMLit <- nut_df$BN_Som + nut_df$BN_Lit
    
    # BN_WeedBiom[SlNut] = AF_ZoneFrac[Zn1]*(C_NBiom[Zn1,SlNut]*(Cq_WeedZn?[Zn1]))+
    #   AF_ZoneFrac[Zn2]*(C_NBiom[Zn2,SlNut]*(Cq_WeedZn?[Zn2]))+
    #   AF_ZoneFrac[Zn3]*(C_NBiom[Zn3,SlNut]*(Cq_WeedZn?[Zn3]))+
    #   AF_ZoneFrac[Zn4]*(C_NBiom[Zn4,SlNut]*(Cq_WeedZn?[Zn4]))
    nut_df$BN_WeedBiom <- aggregate(
      zonenut_df$AF_ZoneFrac * zonenut_df$C_NBiom * rep(zone_df$CQ_WeedZn_is, nrow(nut_df)),
      zonenut_df["SlNut"],
      sum
    )$x
    
    # C_NWeedSeed[Zn1,N] = C_WeedSeedBank[Zn1,N]
    # C_NWeedSeed[Zn1,P] = C_WeedSeedBank[Zn1,P]
    # C_NWeedSeed[Zn2,N] = C_WeedSeedBank[Zn2,N]
    # C_NWeedSeed[Zn2,P] = C_WeedSeedBank[Zn2,P]
    # C_NWeedSeed[Zn3,N] = C_WeedSeedBank[Zn3,N]
    # C_NWeedSeed[Zn3,P] = C_WeedSeedBank[Zn3,P]
    # C_NWeedSeed[Zn4,N] = C_WeedSeedBank[Zn4,N]
    # C_NWeedSeed[Zn4,P] = C_WeedSeedBank[Zn4,P]
    zonenut_df$C_NWeedSeed <- zonepcomp_df[zonepcomp_df$PlantComp %in% c("N", "P"), "C_WeedSeedBank"]
    
    # BN_WeedSeedBank[SlNut] = AF_ZoneFrac[Zn1]*(C_NWeedSeed[Zn1,SlNut])+
    #   AF_ZoneFrac[Zn2]*(C_NWeedSeed[Zn2,SlNut])+
    #   AF_ZoneFrac[Zn3]*(C_NWeedSeed[Zn3,SlNut])+
    #   AF_ZoneFrac[Zn4]*(C_NWeedSeed[Zn4,SlNut])
    nut_df$BN_WeedSeedBank <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$C_NWeedSeed,
                                        zonenut_df["SlNut"],
                                        sum)$x
    
    # BN_Crop&Weed[SlNut] = BN_CropBiom[SlNut]+BN_WeedBiom[SlNut]+BN_WeedSeedBank[SlNut]
    nut_df$BN_CropWeed <- nut_df$BN_CropBiom + nut_df$BN_WeedBiom + nut_df$BN_WeedSeedBank
    
    # BN_StockTot[SlNut] = AF_ZoneFrac[Zn1]*BN_StockZone[Zn1,SlNut]+
    #   AF_ZoneFrac[Zn2]*BN_StockZone[Zn2,SlNut]+
    #   AF_ZoneFrac[Zn3]*BN_StockZone[Zn3,SlNut]+
    #   AF_ZoneFrac[Zn4]*BN_StockZone[Zn4,SlNut]+
    #   BN_SOMLit[SlNut]+BN_Crop&Weed[SlNut]+BN_Immob[SlNut]+ARRAYSUM(T_NBiom[SlNut,*])
    nut_df$BN_StockTot <- aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$BN_StockZone,
                                    zonenut_df["SlNut"],
                                    sum)$x + nut_df$BN_SOMLit + nut_df$BN_CropWeed + nut_df$BN_Immob + aggregate(treenut_df$T_NBiom, treenut_df["SlNut"], sum)$x
    
    # BN_ChangeStocks[SlNut] = BN_StockTot[SlNut]-BN_StocksTotInit[SlNut]
    nut_df$BN_ChangeStocks <- nut_df$BN_StockTot - nut_df$BN_StocksTotInit
    
    # BN_SumofFluxes[SlNut] = BN_InfluxTot[SlNut]-BN_EffluxTot[SlNut]
    nut_df$BN_SumofFluxes <- nut_df$BN_InfluxTot - nut_df$BN_EffluxTot
    
    # BN_NetBal[SlNut] = BN_ChangeStocks[SlNut]-BN_SumofFluxes[SlNut]
    nut_df$BN_NetBal <- nut_df$BN_ChangeStocks - nut_df$BN_SumofFluxes
    
    # N_TotUpt14H[SlNut] = if N_LatOutflowCum4[SlNut]>0 then N_TotUpt4i[Zn1,SlNut]*N_LatOutflowCum4[SlNut]/ (N_LeachCumV[Zn1,SlNut]+N_LatOutflowCum4[SlNut]) else 0
    N_LatOutflowCum4 <- layernut_df[layernut_df$layer == 4, "N_LatOutflowCum"]
    nut_df$N_TotUpt14H <- ifelse(
      N_LatOutflowCum4 > 0,
      zonelayernut_df[zonelayernut_df$zone == 1 &
                        zonelayernut_df$layer == 1, "N_TotUpti"] * N_LatOutflowCum4 / (zonenut_df[zonenut_df$zone == 1, "N_LeachCumV"] +
                                                                                        N_LatOutflowCum4),
      0
    )
    
    # N_UptEdgeH[SlNut] = AF_ZoneFrac[Zn1]*(N_TotUpt1i[Zn1,SlNut]+N_TotUpt2i[Zn1,SlNut]+N_TotUpt3i[Zn1,SlNut]+N_TotUpt14H[SlNut])
    z1l13n <- zonelayernut_df[zonelayernut_df$zone == 1 &
                                zonelayernut_df$layer %in% c(1:3), c("layer", "SlNut", "N_TotUpti")]
    nut_df$N_UptEdgeH <- zone_df[zone_df$zone == 1, "AF_ZoneFrac"] * (aggregate(z1l13n$N_TotUpti, z1l13n["SlNut"], sum)$x + nut_df$N_TotUpt14H)
    
    # N_UptEdgeV[SlNut] = AF_ZoneFrac[Zn1]*(N_TotUpt4i[Zn1,SlNut]-N_TotUpt14H[SlNut]) + AF_ZoneFrac[Zn2]*N_TotUpt4i[Zn2,SlNut]+AF_ZoneFrac[Zn3]*N_TotUpt4i[Zn3,SlNut]+AF_ZoneFrac[Zn4]*N_TotUpt4i[Zn4,SlNut]
    zonenut_df$N_TotUpti_bottom <- zonelayernut_df[zonelayernut_df$layer == 4, "N_TotUpti"]
    zonenut_df[zonenut_df$zone == 1, "N_TotUpti_bottom"] <- zonenut_df[zonenut_df$zone == 1, "N_TotUpti_bottom"] - nut_df$N_TotUpt14H
    nut_df$N_UptEdgeV <-  aggregate(zonenut_df$AF_ZoneFrac * zonenut_df$N_TotUpti_bottom,
                                    zonenut_df["SlNut"],
                                    sum)$x
    
    # N_EdgeFFH[SlNut] = if N_UptEdgeH[SlNut]>0 then N_UptEdgeH[SlNut]/(BN_LatOutCum[SlNut]+BN_LeachingTot[SlNut]+N_UptEdgeH[SlNut]+N_UptEdgeV[SlNut]) else 0
    nut_df$N_EdgeFFH <- ifelse(
      nut_df$N_UptEdgeH > 0,
      nut_df$N_UptEdgeH / (
        nut_df$BN_LatOutCum + nut_df$BN_LeachingTot + nut_df$N_UptEdgeH + nut_df$N_UptEdgeV
      ),
      0
    )
    
    # N_EdgeFFV[SlNut] = if N_UptEdgeV[SlNut]> 0 then N_UptEdgeV[SlNut]/(BN_LatOutCum[SlNut]+BN_LeachingTot[SlNut]+N_UptEdgeH[SlNut]+N_UptEdgeV[SlNut]) else 0
    nut_df$N_EdgeFFV <- ifelse(
      nut_df$N_UptEdgeV > 0,
      nut_df$N_UptEdgeV / (
        nut_df$BN_LatOutCum + nut_df$BN_LeachingTot + nut_df$N_UptEdgeH + nut_df$N_UptEdgeV
      ),
      0
    )
    
    # N_TotUpt&Loss[SlNut] = BN_LeachingTot[SlNut]+BN_LatOutCum[SlNut]+
    #   AF_ZoneFrac[Zn1]*(N_TotUpt1i[Zn1,SlNut]+N_TotUpt2i[Zn1,SlNut]+N_TotUpt3i[Zn1,SlNut]+N_TotUpt4i[Zn1,SlNut])+
    #   AF_ZoneFrac[Zn2]*(N_TotUpt1i[Zn2,SlNut]+N_TotUpt2i[Zn2,SlNut]+N_TotUpt3i[Zn2,SlNut]+N_TotUpt4i[Zn2,SlNut])+
    #   AF_ZoneFrac[Zn3]*(N_TotUpt1i[Zn3,SlNut]+N_TotUpt2i[Zn3,SlNut]+N_TotUpt3i[Zn3,SlNut]+N_TotUpt4i[Zn3,SlNut])+
    #   AF_ZoneFrac[Zn4]*(N_TotUpt1i[Zn4,SlNut]+N_TotUpt2i[Zn4,SlNut]+N_TotUpt3i[Zn4,SlNut]+N_TotUpt4i[Zn4,SlNut])
    nut_df$N_TotUptLoss <- nut_df$BN_LeachingTot + nut_df$BN_LatOutCum +
      aggregate(
        zonenut_df$AF_ZoneFrac * aggregate(zonelayernut_df$N_TotUpti, zonelayernut_df[c("zone", "SlNut")], sum)$x,
        zonenut_df["SlNut"],
        sum
      )$x
    
    # N_TotFF1i[Zone,SlNut] = if N_TotUpt&Loss[SlNut] > 0 then  AF_ZoneFrac[Zone]*N_TotUpt1i[Zone,SlNut]/(N_TotUpt&Loss[SlNut]) else 0
    # N_TotFF2i[Zone,SlNut] = if N_TotUpt&Loss[SlNut] > 0 then  AF_ZoneFrac[Zone]*N_TotUpt2i[Zone,SlNut]/(N_TotUpt&Loss[SlNut]) else 0
    # N_TotFF3i[Zone,SlNut] = if N_TotUpt&Loss[SlNut] > 0 then  AF_ZoneFrac[Zone]*N_TotUpt3i[Zone,SlNut]/(N_TotUpt&Loss[SlNut]) else 0
    # N_TotFF4i[Zone,SlNut] = if N_TotUpt&Loss[SlNut] > 0 then  AF_ZoneFrac[Zone]*N_TotUpt4i[Zone,SlNut]/(N_TotUpt&Loss[SlNut]) else 0
    zonelayernut_df$N_TotUptLoss <- rep(nut_df$N_TotUptLoss, each = nzone *
                                          nlayer)
    zonelayernut_df$N_TotFFi <- ifelse(
      zonelayernut_df$N_TotUptLoss > 0,
      zonelayernut_df$AF_ZoneFrac * zonelayernut_df$N_TotUpti / zonelayernut_df$N_TotUptLoss,
      0
    )
    
    # N_TotFFL1[SlNut] = ARRAYSUM(N_TotFF1i[*,SlNut])
    # N_TotFFL2[SlNut] = ARRAYSUM(N_TotFF2i[*,SlNut])
    # N_TotFFL3[SlNut] = ARRAYSUM(N_TotFF3i[*,SlNut])
    # N_TotFFL4[SlNut] = ARRAYSUM(N_TotFF4i[*,SlNut])
    layernut_df$N_TotFFL <- aggregate(zonelayernut_df$N_TotFFi, zonelayernut_df[c("layer", "SlNut")], sum)$x
    
    # N_TotFFTot[SlNut] = N_TotFFL1[SlNut]+N_TotFFL2[SlNut]+N_TotFFL3[SlNut]+N_TotFFL4[SlNut]
    nut_df$N_TotFFTot <- aggregate(layernut_df$N_TotFFL, layernut_df["SlNut"], sum)$x
    
    # BN_TNdfaFrac[Tree] = if (BN_TNFixAmountCum[N,Tree]+BN_TUptCum[N,Tree])> 0 then BN_TNFixAmountCum[N,Tree]/(BN_TNFixAmountCum[N,Tree]+BN_TUptCum[N,Tree]) else 0
    tree_df$BN_TNdfaFrac <- ifelse(
      (tn_N$BN_TNFixAmountCum + tn_N$BN_TUptCum) > 0,
      tn_N$BN_TNFixAmountCum / (tn_N$BN_TNFixAmountCum + tn_N$BN_TUptCum),
      0
    )
    
    # T_BiomCumTot[Tree] = T_Biom[DW,Tree]+T_LifallCum[DW,Tree]+T_CumRtType2Decay[DW,Tree]+T_PrunCum[DW,Tree]+T_WoodHarvCum[DW,Tree]
    tree_df$T_BiomCumTot <- tp_DW$T_Biom + tp_DW$T_LifallCum + tp_DW$T_CumRtType2Decay +
      tp_DW$T_PrunCum + tp_DW$T_WoodHarvCum
    
    # C_AgronYieldsCum[Cr] = AF_ZoneFrac[Zn1]*C_AgronYPerType[Zn1,Cr]+AF_ZoneFrac[Zn2]*C_AgronYPerType[Zn2,Cr]+AF_ZoneFrac[Zn3]*C_AgronYPerType[Zn3,Cr]+AF_ZoneFrac[Zn4]*C_AgronYPerType[Zn4,Cr]
    crop_df$C_AgronYieldsCum <- aggregate(zonecrop_df$AF_ZoneFrac * zonecrop_df$C_AgronYPerType,
                                          zonecrop_df["crop_id"],
                                          sum)$x
    
    # P_CCostsAvg[PriceType] = P_CCostsTot[PriceType]
    price_df$P_CCostsAvg <- price_df$P_CCostsTot
    
    # P_CReturnAvg[PriceType] = P_CReturnTot[PriceType]
    price_df$P_CReturnAvg <- price_df$P_CReturnTot
    
    # T_FracLim[Tree,Limiting_Factors] = if T_GrowDays[Tree]>0 then T_CumLim[Tree,Limiting_Factors]/T_GrowDays[Tree] else 0
    treelimit_df$T_GrowDays <- rep(tree_df$T_GrowDays, nrow(limit_df))
    treelimit_df$T_FracLim <- ifelse(treelimit_df$T_GrowDays > 0,
                                     treelimit_df$T_CumLim / treelimit_df$T_GrowDays,
                                     0)
    
    
    
    # BC_HarvestedC = Mc_Carbon*1000*(AF_ZoneFrac[Zn1]*(C_HarvestCum[Zn1,DW]+C_ResidRemoved[Zn1,DW])+AF_ZoneFrac[Zn2]*(C_HarvestCum[Zn2,DW]+C_ResidRemoved[Zn2,DW])+AF_ZoneFrac[Zn3]*(C_HarvestCum[Zn3,DW]+C_ResidRemoved[Zn3,DW])+AF_ZoneFrac[Zn4]*(C_HarvestCum[Zn4,DW]+C_ResidRemoved[Zn4,DW]))
    BC_HarvestedC <- MC_Carbon * 1000 * sum(zone_df$AF_ZoneFrac * (zp_DW$C_HarvestCum +
                                                                     zp_DW$C_ResidRemoved))
    
    # BN_ScorchWRem[PlantComp] = AF_ZoneFrac[Zn1]*S&B_ScorchWoodRemoved[Zn1,PlantComp]+AF_ZoneFrac[Zn2]*S&B_ScorchWoodRemoved[Zn2,PlantComp]+AF_ZoneFrac[Zn3]*S&B_ScorchWoodRemoved[Zn3,PlantComp]+AF_ZoneFrac[Zn4]*S&B_ScorchWoodRemoved[Zn4,PlantComp]
    pcomp_df$BN_ScorchWRem <- aggregate(
      zonepcomp_df$AF_ZoneFrac * zonepcomp_df$SB_ScorchWoodRemoved,
      zonepcomp_df["PlantComp"],
      sum
    )$x
    
    # BC_HarvestedT = Mc_Carbon*1000*(Arraysum(T_WoodHarvCum[DW,*])+Arraysum(T_PrunHarvCum[DW,*])+arraysum(T_FruitCum[DW,*])+BN_ScorchWRem[DW]+arraysum(T_CanBionTimCum[DW,*])+arraysum(T_GroResLossCum[DW,*])+ARRAYSUM(T_TappedLatex[DW,*]))
    BC_HarvestedT <- MC_Carbon * 1000 * (
      sum(tp_DW$T_WoodHarvCum) + sum(tp_DW$T_PrunHarvCum) + sum(tp_DW$T_FruitCum) +
        pcomp_df[pcomp_df$PlantComp == "DW", ]$BN_ScorchWRem + sum(tp_DW$T_CanBionTimCum) +
        sum(tp_DW$T_GroResLossCum) + sum(tp_DW$T_TappedLatex)
    )
    
    # BC_Inflows =  BC_ExtOrgInput+BC_CPhotosynth+BC_CropInit+BC_TPhotosynth+BC_WeedSeedIn+1000*Mc_Carbon*ARRAYSUM(T_RtType0CumInput[DW,*])
    BC_Inflows <-  BC_ExtOrgInput + BC_CPhotosynth + BC_CropInit + BC_TPhotosynth +
      BC_WeedSeedIn + 1000 * MC_Carbon * sum(tp_DW$T_RtType0CumInput)
    
    # BC_TotalHarvested = BC_HarvestedC+BC_HarvestedT
    BC_TotalHarvested <- BC_HarvestedC + BC_HarvestedT
    
    # Cent_InputCO2Tot =
    #   AF_ZoneFrac[Zn1]*(Mc_MetabCO2[Zn1]+Mc_StrucActCO2[Zn1]+Mc_StrucSlwCO2[Zn1]+Mc2_MetabCO2[Zn1]+ Mc2_StrucActCO2[Zn1]+ Mc2_StrucSlwCO2[Zn1])+
    #   AF_ZoneFrac[Zn2]*(Mc_MetabCO2[Zn2]+Mc_StrucActCO2[Zn2]+Mc_StrucSlwCO2[Zn2]+Mc2_MetabCO2[Zn2]+ Mc2_StrucActCO2[Zn2]+ Mc2_StrucSlwCO2[Zn2])+
    #   AF_ZoneFrac[Zn3]*(Mc_MetabCO2[Zn3]+Mc_StrucActCO2[Zn3]+Mc_StrucSlwCO2[Zn3]+Mc2_MetabCO2[Zn3]+ Mc2_StrucActCO2[Zn3]+ Mc2_StrucSlwCO2[Zn3])+
    #   AF_ZoneFrac[Zn4]*(Mc_MetabCO2[Zn4]+Mc_StrucActCO2[Zn4]+Mc_StrucSlwCO2[Zn4]+Mc2_MetabCO2[Zn4]+ Mc2_StrucActCO2[Zn4]+ Mc2_StrucSlwCO2[Zn4])
    CENT_InputCO2Tot <- sum(
      zone_df$AF_ZoneFrac * (
        zone_df$MC_MetabCO2 + zone_df$MC_StrucActCO2 + zone_df$MC_StrucSlwCO2 +
          zone_df$MC2_MetabCO2 + zone_df$MC2_StrucActCO2 + zone_df$MC2_StrucSlwCO2
      )
    )
    
    # Cent_SOMCO2Tot =
    #   AF_ZoneFrac[Zn1]*(Mc_PassCO2[Zn1]+Mc_SlwCO2[Zn1]+Mc_ActCO2[Zn1]+Mc2_PassCO2[Zn1]+Mc2_SlwCO2[Zn1]+Mc2_ActCO2[Zn1])+
    #   AF_ZoneFrac[Zn2]*(Mc_PassCO2[Zn2]+Mc_SlwCO2[Zn2]+Mc_ActCO2[Zn2]+Mc2_PassCO2[Zn2]+Mc2_SlwCO2[Zn2]+Mc2_ActCO2[Zn2])+
    #   AF_ZoneFrac[Zn3]*(Mc_PassCO2[Zn3]+Mc_SlwCO2[Zn3]+Mc_ActCO2[Zn3]+Mc2_PassCO2[Zn3]+Mc2_SlwCO2[Zn3]+Mc2_ActCO2[Zn3])+
    #   AF_ZoneFrac[Zn4]*(Mc_PassCO2[Zn4]+Mc_SlwCO2[Zn4]+Mc_ActCO2[Zn4]+Mc2_PassCO2[Zn4]+Mc2_SlwCO2[Zn4]+Mc2_ActCO2[Zn4])
    CENT_SOMCO2Tot <- sum(
      zone_df$AF_ZoneFrac * (
        zone_df$MC_PassCO2 + zone_df$MC_SlwCO2 + zone_df$MC_ActCO2 + zone_df$MC2_PassCO2 +
          zone_df$MC2_SlwCO2 + zone_df$MC2_ActCO2
      )
    )
    
    # Cent_CO2Tot = Cent_InputCO2Tot+Cent_SOMCO2Tot
    CENT_CO2Tot <- CENT_InputCO2Tot + CENT_SOMCO2Tot
    
    # BC_TotalRespired = BC_C_RespforFix+BC_TRespforFix+Cent_CO2Tot+BC_CO2fromBurn
    BC_TotalRespired <- BC_C_RespforFix + BC_TRespforFix + CENT_CO2Tot +
      BC_CO2fromBurn
    
    # BC_OrgC_leached = AF_ZoneFrac[Zn1]*MC2_OrgC_Leached[Zn1]+AF_ZoneFrac[Zn2]*MC2_OrgC_Leached[Zn2]+AF_ZoneFrac[Zn3]*MC2_OrgC_Leached[Zn3]+AF_ZoneFrac[Zn4]*MC2_OrgC_Leached[Zn4]
    BC_OrgC_leached <- sum(zone_df$AF_ZoneFrac * zone_df$MC2_OrgC_Leached)
    
    # BC_Outflows = BC_TotalHarvested+BC_TotalRespired+BC_OrgC_leached
    BC_Outflows <- BC_TotalHarvested + BC_TotalRespired + BC_OrgC_leached
    
    # BC_DiffFlows = BC_Inflows-BC_Outflows
    BC_DiffFlows <- BC_Inflows - BC_Outflows
    
    # BC_NetBal = BC_ChangStock-BC_DiffFlows
    BC_NetBal <- BC_ChangStock - BC_DiffFlows
    
    # BN_CNdfaFrac = if(BN_CUptCum[N]+BN_CNFixCum[N])> 0 then BN_CNFixCum[N]/(BN_CUptCum[N]+BN_CNFixCum[N]) else 0
    n_N <- nut_df[nut_df$SlNut == "N", ]
    BN_CNdfaFrac <- ifelse((n_N$BN_CUptCum + n_N$BN_CNFixCum) > 0,
                           n_N$BN_CNFixCum / (n_N$BN_CUptCum + n_N$BN_CNFixCum),
                           0
    )
    
    # BS_GrossErosionCum = E_SoilLossCumZn[Zn1]*AF_ZoneFrac[Zn1]+E_SoilLossCumZn[Zn2]*AF_ZoneFrac[Zn2]+E_SoilLossCumZn[Zn3]*AF_ZoneFrac[Zn3]+E_SoilLossCumZn[Zn4]*AF_ZoneFrac[Zn4]
    BS_GrossErosionCum <- sum(zone_df$E_SoilLossCumZn * zone_df$AF_ZoneFrac)
    
    # BS_SoilCurr = BS_SoilCurrZn[Zn1]*AF_ZoneFrac[Zn1]+BS_SoilCurrZn[Zn2]*AF_ZoneFrac[Zn2]+BS_SoilCurrZn[Zn3]*AF_ZoneFrac[Zn3]+BS_SoilCurrZn[Zn4]*AF_ZoneFrac[Zn4]
    BS_SoilCurr <- sum(zone_df$BS_SoilCurrZn * zone_df$AF_ZoneFrac)
    
    # BS_Pos = BS_GrossErosionCum+BS_SoilCurr
    BS_Pos <- BS_GrossErosionCum + BS_SoilCurr
    
    # BS_SoilInflowCum = E_CumSoilInflowZn[Zn1]*AF_ZoneFrac[Zn1]+E_CumSoilInflowZn[Zn2]*AF_ZoneFrac[Zn2]+E_CumSoilInflowZn[Zn3]*AF_ZoneFrac[Zn3]+E_CumSoilInflowZn[Zn4]*AF_ZoneFrac[Zn4]
    BS_SoilInflowCum <- sum(zone_df$E_CumSoilInflowZn * zone_df$AF_ZoneFrac)
    
    # BS_SoilInit = AF_ZoneFrac[Zn1]*BS_SoilInitZn[Zn1]+AF_ZoneFrac[Zn2]*BS_SoilInitZn[Zn2]+AF_ZoneFrac[Zn3]*BS_SoilInitZn[Zn3]+AF_ZoneFrac[Zn4]*BS_SoilInitZn[Zn4]
    BS_SoilInit <- sum(zone_df$AF_ZoneFrac * zone_df$BS_SoilInitZn)
    
    # BS_Neg = BS_SoilInflowCum+BS_SoilInit
    BS_Neg <- BS_SoilInflowCum + BS_SoilInit
    
    # BS_SoilDelta = BS_Pos-BS_Neg
    BS_SoilDelta <- BS_Pos - BS_Neg
    
    # BW_DrainCumV = AF_ZoneFrac[Zn1]*W_DrainCumV[Zn1]+AF_ZoneFrac[Zn2]*W_DrainCumV[Zn2]+AF_ZoneFrac[Zn3]*W_DrainCumV[Zn3]+AF_ZoneFrac[Zn4]*W_DrainCumV[Zn4]
    BW_DrainCumV <- sum(zone_df$AF_ZoneFrac * zone_df$W_DrainCumV)
    
    # BW_LatInCum = (LF_LatIn1Cum+LF_LatIn2Cum+LF_LatIn3Cum+LF_LatIn4Cum)/AF_ZoneTot
    BW_LatInCum <- sum(layer_df$LF_LatInCum) / AF_ZoneTot
    
    # BW_LatOutCum = (LF_H1Drain1Cum+LF_H2Drain1Cum+LF_H3Drain1Cum+LF_H4Drain1Cum)*AF_ZoneFrac[Zn1]
    BW_LatOutCum <- sum(layer_df$LF_HDrain1Cum) * zone_df[zone_df$zone == 1, "AF_ZoneFrac"]
    
    # BW_StockTot = (W_Stock1[Zn1]+W_Stock2[Zn1]+W_Stock3[Zn1]+W_Stock4[Zn1]+Rain_CanopyWater[Zn1])*AF_ZoneFrac[Zn1]+(W_Stock1[Zn2]+W_Stock2[Zn2]+W_Stock3[Zn2]+W_Stock4[Zn2]+Rain_CanopyWater[Zn2])*AF_ZoneFrac[Zn2]+(W_Stock1[Zn3]+W_Stock2[Zn3]+W_Stock3[Zn3]+W_Stock4[Zn3]+Rain_CanopyWater[Zn3])*AF_ZoneFrac[Zn3]+(W_Stock1[Zn4]+W_Stock2[Zn4]+W_Stock3[Zn4]+W_Stock4[Zn4]+Rain_CanopyWater[Zn4])*AF_ZoneFrac[Zn4]
    BW_StockTot <- sum(aggregate(zonelayer_df$W_Stock, zonelayer_df["zone"], sum)$x * zone_df$AF_ZoneFrac)
    
    # BW_StockChange = BW_StockTot-BW_StockInit
    BW_StockChange <- BW_StockTot - BW_StockInit
    
    # BW_InfluxTot = Rain_Cum+BW_RunOnCum+BW_LatInCum
    BW_InfluxTot <- RAIN_Cum + BW_RunOnCum + BW_LatInCum
    
    # BW_CumEvapoTrans = Rain_IntercEvapCum+BW_EvapCum+BW_UptCCum+ARRAYSUM(BW_UptTCum[*])+BW_UptWCum
    BW_CumEvapoTrans <- RAIN_IntercEvapCum + BW_EvapCum + BW_UptCCum + sum(tree_df$BW_UptTCum) +
      BW_UptWCum
    
    # BW_EffluxTot = BW_CumEvapoTrans+BW_DrainCumV+BW_RunOffCum+BW_LatOutCum
    BW_EffluxTot <- BW_CumEvapoTrans + BW_DrainCumV + BW_RunOffCum + BW_LatOutCum
    
    # BW_FluxDiff = BW_InfluxTot-BW_EffluxTot
    BW_FluxDiff <- BW_InfluxTot - BW_EffluxTot
    
    # BW_NetBal = BW_StockChange-BW_FluxDiff
    BW_NetBal <- BW_StockChange - BW_FluxDiff
    
    # T_NUptTotAll[N] = ARRAYSUM(T_NUptTot[N,*])
    # T_NUptTotAll[P] = ARRAYSUM(T_NUptTot[P,*])
    nut_df$T_NUptTotAll <- aggregate(treenut_df$T_NUptTot, treenut_df["SlNut"], sum)$x

    
    
    
    
    ### Stock vars ##########################
    
    
    
    
    
    # W_Stock1[Zone](t) = W_Stock1[Zone](t - dt) + (W_In1[Zone] - EVAP_Surf[Zone] - W_CUpt1[Zone] - W_T1Upt1[Zone] - W_T2Upt1[Zone] - W_T3Upt1[Zone]) * dt
    # W_Stock2[Zone](t) = W_Stock2[Zone](t - dt) + (W_In2[Zone] - W_CUpt2[Zone] - W_T1Upt2[Zone] - W_T2Upt2[Zone] - W_T3Upt2[Zone]) * dt
    # W_Stock3[Zone](t) = W_Stock3[Zone](t - dt) + (W_In3[Zone] - W_CUpt3[Zone] - W_T1Upt3[Zone] - W_T2Upt3[Zone] - W_T3Upt3[Zone]) * dt
    # W_Stock4[Zone](t) = W_Stock4[Zone](t - dt) + (W_In4[Zone] - W_CUpt4[Zone] - W_T1Upt4[Zone] - W_T2Upt4[Zone] - W_T3Upt4[Zone]) * dt
    zonelayer_df$W_Upt_sum <- aggregate(zonelayertree_df["W_Upt"], zonelayertree_df[c("zone", "layer")], sum)$W_Upt
    zonelayer_df$W_Stock <- zonelayer_df$W_Stock + zonelayer_df$W_In - zonelayer_df$W_CUpt - zonelayer_df$W_Upt_sum
    zonelayer_df[zonelayer_df$layer == 1, "W_Stock"] <- zonelayer_df[zonelayer_df$layer == 1, "W_Stock"] - zone_df$EVAP_Surf
    
    # S_BDActOverBDRefInfiltr[Zone](t) = S_BDActOverBDRefInfiltr[Zone](t - dt) + (S_BDModifierInfiltr[Zone]) * dt
    zone_df$S_BDActOverBDRefInfiltr <- zone_df$S_BDActOverBDRefInfiltr + zone_df$S_BDModifierInfiltr
    
    # C_BiomStLv[Zone,PlantComp](t) = C_BiomStLv[Zone,PlantComp](t - dt) + (C_StLeafInc[Zone,PlantComp] - C_Resid[Zone,PlantComp] - C_StLeaveMulch[Zone,PlantComp] - C_BiomHarvest[Zone,PlantComp]) * dt
    zonepcomp_df$C_BiomStLv <- zonepcomp_df$C_BiomStLv + (
      zonepcomp_df$C_StLeafInc - zonepcomp_df$C_Resid - zonepcomp_df$C_StLeaveMulch - zonepcomp_df$C_BiomHarvest
    )
    
    # T_LfTwig[PlantComp,Tree](t) = T_LfTwig[PlantComp,Tree](t - dt) + (T_CanBiomInc[PlantComp,Tree] + T_CanBiomIni[PlantComp,Tree] - T_Prun[PlantComp,Tree] - T_LifallInc[PlantComp,Tree] - T_WoodInc[PlantComp,Tree] - T_Herbivory[PlantComp,Tree] - T_CanBiomSlashed[PlantComp,Tree] - T_CanBiomTimHarv[PlantComp,Tree]) * dt
    treepcomp_df$T_LfTwig <- treepcomp_df$T_LfTwig + (
      treepcomp_df$T_CanBiomInc + treepcomp_df$T_CanBiomIni - treepcomp_df$T_Prun - treepcomp_df$T_LifallInc - treepcomp_df$T_WoodInc - treepcomp_df$T_Herbivory - treepcomp_df$T_CanBiomSlashed - treepcomp_df$T_CanBiomTimHarv
    )
    
    # TF_RecentFrondLength[Tree](t) = TF_RecentFrondLength[Tree](t - dt) + (TF_FrondGrowth[Tree]) * dt
    tree_df$TF_RecentFrondLength <- tree_df$TF_RecentFrondLength + tree_df$TF_FrondGrowth
    
    # TF_TrunkDiam[Tree](t) = TF_TrunkDiam[Tree](t - dt) + (TF_TrunkDiamGrowth[Tree]) * dt
    tree_df$TF_TrunkDiam <- tree_df$TF_TrunkDiam + (tree_df$TF_TrunkDiamGrowth)
    
    # T_HeartWoodDiam[Tree](t) = T_HeartWoodDiam[Tree](t - dt) + (T_HeartWoodDiamInc[Tree] - T_DiamHeartWoodTDies[Tree]) * dt
    tree_df$T_HeartWoodDiam <- tree_df$T_HeartWoodDiam + (tree_df$T_HeartWoodDiamInc - tree_df$T_DiamHeartWoodTDies)
    
    # T_SapWoodEqDiam[Tree](t) = T_SapWoodEqDiam[Tree](t - dt) + (T_StemDiamGrowth[Tree] - T_StemBefPruningInc[Tree] - T_DiamSapWoodTreeDies[Tree]) * dt
    tree_df$T_SapWoodEqDiam <- tree_df$T_SapWoodEqDiam + (
      tree_df$T_StemDiamGrowth - tree_df$T_StemBefPruningInc - tree_df$T_DiamSapWoodTreeDies
    )
    
    # S&B_FineNecromass[Zone,PlantComp](t) = S&B_FineNecromass[Zone,PlantComp](t - dt) + (S&B_SlashVegetation[Zone,PlantComp] - S&B_NecromassBurn[Zone,PlantComp] - S&B_NecroFNutVolat[Zone,PlantComp] - S&B_MinNutRele[Zone,PlantComp] - S&B_NecromLitTransf[Zone,PlantComp] - S&B_SPileUp[Zone,PlantComp] - S&B_HazeFromSlash[Zone,PlantComp]) * dt
    zonepcomp_df$SB_FineNecromass <- zonepcomp_df$SB_FineNecromass + (
      zonepcomp_df$SB_SlashVegetation - zonepcomp_df$SB_NecromassBurn - zonepcomp_df$SB_NecroFNutVolat -
        zonepcomp_df$SB_MinNutRele - zonepcomp_df$SB_NecromLitTransf - zonepcomp_df$SB_SPileUp - zonepcomp_df$SB_HazeFromSlash
    )
    
    # MC_LAIperNecmss[Zone](t) = MC_LAIperNecmss[Zone](t - dt) + (T_LAINecrCh[Zone]) * dt
    zone_df$MC_LAIperNecmss <- zone_df$MC_LAIperNecmss + (zone_df$T_LAINecrCh)
    
    # LF_UphillGWStore(t) = LF_UphillGWStore(t - dt) + (LF_UphillGWIncr - LF_UphillGWRelease) * dt
    LF_UphillGWStore <- LF_UphillGWStore + (LF_UphillGWIncr - LF_UphillGWRelease)
    
    # RT_L1FRLength[Zone,Tree](t) = RT_L1FRLength[Zone,Tree](t - dt) + (RT3_L1FRtGr[Zone,Tree] - RT3_L1FRtMort[Zone,Tree]) * dt
    # RT_L2FRLength[Zone,Tree](t) = RT_L2FRLength[Zone,Tree](t - dt) + (RT3_L2FRtGr[Zone,Tree] - RT3_L2FRtMort[Zone,Tree]) * dt
    # RT_L3FRLength[Zone,Tree](t) = RT_L3FRLength[Zone,Tree](t - dt) + (RT3_L3FRtGr[Zone,Tree] - RT3_L3FRtMort[Zone,Tree]) * dt
    # RT_L4FRLength[Zone,Tree](t) = RT_L4FRLength[Zone,Tree](t - dt) + (RT3_L4FRtGr[Zone,Tree] - RT3_L4FRtMort[Zone,Tree]) * dt
    zonelayertree_df$RT_FRLength <- zonelayertree_df$RT_FRLength + (zonelayertree_df$RT3_LFRtGr - zonelayertree_df$RT3_FRtMort)
    
    # RT_TLraCD[Tree](t) = RT_TLraCD[Tree](t - dt)
    
    # T_RootT1DW[Zone,SoilLayer](t) = T_RootT1DW[Zone,SoilLayer](t - dt) + (T_Root_T1_DWInc[Zone,SoilLayer] - T_Root_T1_DWdecay[Zone,SoilLayer]) * dt
    # T_RootT2DW[Zone,SoilLayer](t) = T_RootT2DW[Zone,SoilLayer](t - dt) + (T_Root_T2_DWInc[Zone,SoilLayer] - T_Root_T2_DWdecay[Zone,SoilLayer]) * dt
    # T_RootT3DW[Zone,SoilLayer](t) = T_RootT3DW[Zone,SoilLayer](t - dt) + (T_Root_T3_DWInc[Zone,SoilLayer] - T_Root_T3_DWdecay[Zone,SoilLayer]) * dt
    # T_RootT1N[Zone,SoilLayer](t) = T_RootT1N[Zone,SoilLayer](t - dt) + (T_Root_T1_NInc[Zone,SoilLayer] - T_Root_T1_Ndecay[Zone,SoilLayer]) * dt
    # T_RootT2N[Zone,SoilLayer](t) = T_RootT2N[Zone,SoilLayer](t - dt) + (T_Root_T2_NInc[Zone,SoilLayer] - T_Root_T2_Ndecay[Zone,SoilLayer]) * dt
    # T_RootT3N[Zone,SoilLayer](t) = T_RootT3N[Zone,SoilLayer](t - dt) + (T_Root_T3_NInc[Zone,SoilLayer] - T_Root_T3_Ndecay[Zone,SoilLayer]) * dt
    # T_RootT1P[Zone,SoilLayer](t) = T_RootT1P[Zone,SoilLayer](t - dt) + (T_Root_T1_PInc[Zone,SoilLayer] - T_Root_T1_Pdecay[Zone,SoilLayer]) * dt
    # T_RootT2P[Zone,SoilLayer](t) = T_RootT2P[Zone,SoilLayer](t - dt) + (T_Root_T2_PInc[Zone,SoilLayer] - T_Root_T2_Pdecay[Zone,SoilLayer]) * dt
    # T_RootT3P[Zone,SoilLayer](t) = T_RootT3P[Zone,SoilLayer](t - dt) + (T_Root_T3_PInc[Zone,SoilLayer] - T_Root_T3_Pdecay[Zone,SoilLayer]) * dt
    zonelayertreepcomp_df$T_Root <- zonelayertreepcomp_df$T_Root + (zonelayertreepcomp_df$T_Root_Inc - zonelayertreepcomp_df$T_Root_decay)
    
    # RT_TDistShapeAct[Tree](t) = RT_TDistShapeAct[Tree](t - dt) + (RT_TDistShapeInc[Tree] + RT_TDistShapeActInitPlantTime[Tree]) * dt
    tree_df$RT_TDistShapeAct <- tree_df$RT_TDistShapeAct + (tree_df$RT_TDistShapeInc + tree_df$RT_TDistShapeActInitPlantTime)
    
    # RT_TDecDepthAct[Tree](t) = RT_TDecDepthAct[Tree](t - dt) + (RT_TDecDepthInc[Tree] + RT_TDecDepthActInitPlantTree[Tree]) * dt
    tree_df$RT_TDecDepthAct <- tree_df$RT_TDecDepthAct + (tree_df$RT_TDecDepthInc + tree_df$RT_TDecDepthActInitPlantTree)
    
    # T_Compl[Tree](t) = T_Compl[Tree](t - dt) + (T_Sequen[Tree]) * dt
    tree_df$T_Compl <- tree_df$T_Compl + (tree_df$T_Sequen)
    
    # T_WoodH[Tree](t) = T_WoodH[Tree](t - dt) + (T_WoodHInc[Tree]) * dt
    tree_df$T_WoodH <- tree_df$T_WoodH + (tree_df$T_WoodHInc)
    
    # C_Height[Zone](t) = C_Height[Zone](t - dt) + (C_HeightInc[Zone] - C_HeightDec[Zone]) * dt
    zone_df$C_Height <- zone_df$C_Height + (zone_df$C_HeightInc - zone_df$C_HeightDec)
    
    # T_Stage[Tree,Tree_Stage](t) = T_Stage[Tree,Tree_Stage](t - dt) + (T_StageInc[Tree,Tree_Stage]) * dt
    treestage_df$T_Stage <- treestage_df$T_Stage + (treestage_df$T_StageInc)
    
    # TW_DryFactPower[Tree](t) = TW_DryFactPower[Tree](t - dt) + (TW_PDryFactRUpd[Tree]) * dt
    tree_df$TW_DryFactPower <- tree_df$TW_DryFactPower + (tree_df$TW_PDryFactRUpd)
    
    # CW_DryFactRangePower[Zone](t) = CW_DryFactRangePower[Zone](t - dt) + (CW_DryFactRangeUpdate[Zone]) * dt
    zone_df$CW_DryFactRangePower <- zone_df$CW_DryFactRangePower + (zone_df$CW_DryFactRangeUpdate)
    
    # CQ_CropWeedSwitch[Zone](t) = CQ_CropWeedSwitch[Zone](t - dt) + (CQ_CWswitch[Zone]) * dt
    zone_df$CQ_CropWeedSwitch <- zone_df$CQ_CropWeedSwitch + zone_df$CQ_CWswitch
    
    # CA_ComplCrop[Zone](t) = CA_ComplCrop[Zone](t - dt) + (CA_CropSequen[Zone]) * dt
    zone_df$CA_ComplCrop <- zone_df$CA_ComplCrop + (zone_df$CA_CropSequen)
    
    # MN_Struc[Zone,SlNut](t) = MN_Struc[Zone,SlNut](t - dt) + (MN_StrucIn[Zone,SlNut] - MN_StrucActF[Zone,SlNut] - MN_StrucSlwF[Zone,SlNut] - MN_Str_LitSomTrans[Zone,SlNut] - MN_StrucMinF[Zone,SlNut]) * dt
    zonenut_df$MN_Struc <- zonenut_df$MN_Struc + (
      zonenut_df$MN_StrucIn - zonenut_df$MN_StrucActF - zonenut_df$MN_StrucSlwF - zonenut_df$MN_Str_LitSomTrans - zonenut_df$MN_StrucMinF
    )
    
    # S&B_FineNecromass[Zone,PlantComp](t) = S&B_FineNecromass[Zone,PlantComp](t - dt) + (S&B_SlashVegetation[Zone,PlantComp] - S&B_NecromassBurn[Zone,PlantComp] - S&B_NecroFNutVolat[Zone,PlantComp] - S&B_MinNutRele[Zone,PlantComp] - S&B_NecromLitTransf[Zone,PlantComp] - S&B_SPileUp[Zone,PlantComp] - S&B_HazeFromSlash[Zone,PlantComp]) * dt
    zonepcomp_df$SB_FineNecromass <- zonepcomp_df$SB_FineNecromass + (
      zonepcomp_df$SB_SlashVegetation - zonepcomp_df$SB_NecromassBurn - zonepcomp_df$SB_NecroFNutVolat - zonepcomp_df$SB_MinNutRele -  zonepcomp_df$SB_NecromLitTransf -  zonepcomp_df$SB_SPileUp - zonepcomp_df$SB_HazeFromSlash
    )
    
    # MN_Metab[Zone,SlNut](t) = MN_Metab[Zone,SlNut](t - dt) + (MN_MetabIn[Zone,SlNut] - MN_MetabActF[Zone,SlNut] - MN_Met_LitSomTrans[Zone,SlNut] - MN_MetabMinF[Zone,SlNut]) * dt
    zonenut_df$MN_Metab <- zonenut_df$MN_Metab + (
      zonenut_df$MN_MetabIn - zonenut_df$MN_MetabActF - zonenut_df$MN_Met_LitSomTrans - zonenut_df$MN_MetabMinF
    )
    
    # MN_Act[Zone,SlNut](t) = MN_Act[Zone,SlNut](t - dt) + (MN_MetabActF[Zone,SlNut] + MN_StrucActF[Zone,SlNut] - MN_ActSlwF[Zone,SlNut] - MN_ActPassF[Zone,SlNut] - MN_ActMinF[Zone,SlNut] - MN_Act_LitSomTrans[Zone,SlNut]) * dt
    zonenut_df$MN_Act <- zonenut_df$MN_Act + (
      zonenut_df$MN_MetabActF + zonenut_df$MN_StrucActF - zonenut_df$MN_ActSlwF - zonenut_df$MN_ActPassF - zonenut_df$MN_ActMinF - zonenut_df$MN_Act_LitSomTrans
    )
    
    # MN_Slw[Zone,SlNut](t) = MN_Slw[Zone,SlNut](t - dt) + (MN_StrucSlwF[Zone,SlNut] + MN_ActSlwF[Zone,SlNut] - MN_SlwPassF[Zone,SlNut] - MN_SlwMinF[Zone,SlNut] - MN_Slw_LitSomTrans[Zone,SlNut]) * dt
    zonenut_df$MN_Slw <- zonenut_df$MN_Slw + (
      zonenut_df$MN_StrucSlwF + zonenut_df$MN_ActSlwF - zonenut_df$MN_SlwPassF - zonenut_df$MN_SlwMinF - zonenut_df$MN_Slw_LitSomTrans
    )
    
    # MN_Pass[Zone,SlNut](t) = MN_Pass[Zone,SlNut](t - dt) + (MN_SlwPassF[Zone,SlNut] + MN_ActPassF[Zone,SlNut] - MN_Pas_LitSomTrans[Zone,SlNut] - MN_PasMinF[Zone,SlNut]) * dt
    zonenut_df$MN_Pass <- zonenut_df$MN_Pass + (
      zonenut_df$MN_SlwPassF + zonenut_df$MN_ActPassF - zonenut_df$MN_Pas_LitSomTrans - zonenut_df$MN_PasMinF
    )
    
    # MN2_ActInit[Zone](t) = MN2_ActInit[Zone](t - dt) + (- MN2_ActInitF[Zone]) * dt
    zone_df$MN2_ActInit <- zone_df$MN2_ActInit + (-zone_df$MN2_ActInitF)
    
    # MN2_SlwInit[Zone](t) = MN2_SlwInit[Zone](t - dt) + (- MN2_SlwInitF[Zone]) * dt
    zone_df$MN2_SlwInit <- zone_df$MN2_SlwInit + (-zone_df$MN2_SlwInitF)
    
    # MN2_PassInit[Zone](t) = MN2_PassInit[Zone](t - dt) + (- MN2_PassInitF[Zone]) * dt
    zone_df$MN2_PassInit <- zone_df$MN2_PassInit + (-zone_df$MN2_PassInitF)
    
    # C_BiomHarvestPast(t) = C_BiomHarvestPast(t - dt) + (C_BiomHarvestEvent) * dt
    C_BiomHarvestPast <- C_BiomHarvestPast + (C_BiomHarvestEvent)
    
    # T_PrunPast(t) = T_PrunPast(t - dt) + (T_PrunEvent) * dt
    T_PrunPast <- T_PrunPast + (T_PrunEvent)
    
    # TF_CurrentLeafNo[Tree](t) = TF_CurrentLeafNo[Tree](t - dt) + (TF_NewLeaf?[Tree] - TF_NewLeaffall?[Tree]) * dt
    tree_df$TF_CurrentLeafNo <- tree_df$TF_CurrentLeafNo + (tree_df$TF_NewLeaf_is - tree_df$TF_NewLeaffall_is)
    
    # TF_LeaffallTime[Tree](t) = TF_LeaffallTime[Tree](t - dt) + (TF_LeaffallClockTicks?[Tree]) * dt
    tree_df$TF_LeaffallTime <- tree_df$TF_LeaffallTime + (tree_df$TF_LeaffallClockTicks_is)
    
    # T_CanBionTimCum[PlantComp,Tree](t) = T_CanBionTimCum[PlantComp,Tree](t - dt) + (T_CanBiomTimHarv[PlantComp,Tree]) * dt
    treepcomp_df$T_CanBionTimCum <- treepcomp_df$T_CanBionTimCum + (treepcomp_df$T_CanBiomTimHarv)
    
    # T_CBSlashCum[PlantComp,Tree](t) = T_CBSlashCum[PlantComp,Tree](t - dt) + (T_CanBiomSlashed[PlantComp,Tree]) * dt
    treepcomp_df$T_CBSlashCum <- treepcomp_df$T_CBSlashCum + (treepcomp_df$T_CanBiomSlashed)
    
    # T_CumRtType2Decay[PlantComp,Tree](t) = T_CumRtType2Decay[PlantComp,Tree](t - dt) + (T_RootDecay[PlantComp,Tree]) * dt
    treepcomp_df$T_CumRtType2Decay <- treepcomp_df$T_CumRtType2Decay + (treepcomp_df$T_RootDecay)
    
    # T_Fruit[PlantComp,Tree](t) = T_Fruit[PlantComp,Tree](t - dt) + (T_FruitInc[PlantComp,Tree] - T_Frug_and_Littfall[PlantComp,Tree] - T_PrunFruit[PlantComp,Tree] - T_RipeFruitHarvest[PlantComp,Tree] - T_FruitSlashed[PlantComp,Tree]) * dt
    treepcomp_df$T_Fruit <- treepcomp_df$T_Fruit + (
      treepcomp_df$T_FruitInc - treepcomp_df$T_Frug_and_Littfall -  treepcomp_df$T_PrunFruit - treepcomp_df$T_RipeFruitHarvest - treepcomp_df$T_FruitSlashed
    )
    
    # T_FruitCum[PlantComp,Tree](t) = T_FruitCum[PlantComp,Tree](t - dt) + (T_FruitHarvInc[PlantComp,Tree]) * dt
    treepcomp_df$T_FruitCum <- treepcomp_df$T_FruitCum + (treepcomp_df$T_FruitHarvInc)
    
    # T_GroRes[PlantComp,Tree](t) = T_GroRes[PlantComp,Tree](t - dt) + (T_GroResInc[PlantComp,Tree] - T_CanBiomInc[PlantComp,Tree] - T_FruitInc[PlantComp,Tree] - T_LatexFormation[PlantComp,Tree] - T_GroResLoss[PlantComp,Tree] - T_Respiration[PlantComp,Tree] - T_RootInc[PlantComp,Tree] - T_GroResStorInc[PlantComp,Tree]) * dt
    treepcomp_df$T_GroRes <- treepcomp_df$T_GroRes + (
      treepcomp_df$T_GroResInc - treepcomp_df$T_CanBiomInc - treepcomp_df$T_FruitInc - treepcomp_df$T_LatexFormation - treepcomp_df$T_GroResLoss - treepcomp_df$T_Respiration - treepcomp_df$T_RootInc - treepcomp_df$T_GroResStorInc
    )
    
    # T_GroResLossCum[PlantComp,Tree](t) = T_GroResLossCum[PlantComp,Tree](t - dt) + (T_GroResLoss[PlantComp,Tree]) * dt
    treepcomp_df$T_GroResLossCum <- treepcomp_df$T_GroResLossCum + (treepcomp_df$T_GroResLoss)
    
    # T_GrowStor[PlantComp,Tree](t) = T_GrowStor[PlantComp,Tree](t - dt) + (T_GroResStorInc[PlantComp,Tree]) * dt
    treepcomp_df$T_GrowStor <- treepcomp_df$T_GrowStor + (treepcomp_df$T_GroResStorInc)
    
    # T_HeartWood[PlantComp,Tree](t) = T_HeartWood[PlantComp,Tree](t - dt) + (T_HeartWoodInc[PlantComp,Tree]) * dt
    treepcomp_df$T_HeartWood <- treepcomp_df$T_HeartWood + (treepcomp_df$T_HeartWoodInc)
    
    # T_LatexStock[PlantComp,Tree](t) = T_LatexStock[PlantComp,Tree](t - dt) + (T_LatexFormation[PlantComp,Tree] - T_Tapping[PlantComp,Tree]) * dt
    treepcomp_df$T_LatexStock <- treepcomp_df$T_LatexStock + (treepcomp_df$T_LatexFormation - treepcomp_df$T_Tapping)
    
    # T_LifallCum[PlantComp,Tree](t) = T_LifallCum[PlantComp,Tree](t - dt) + (T_LifallInc[PlantComp,Tree] - T_LifallTreeDies[PlantComp,Tree]) * dt
    treepcomp_df$T_LifallCum <- treepcomp_df$T_LifallCum + (treepcomp_df$T_LifallInc - treepcomp_df$T_LifallTreeDies)
    
    # T_PrunCum[PlantComp,Tree](t) = T_PrunCum[PlantComp,Tree](t - dt) + (T_Prun[PlantComp,Tree] - T_PrunCumTreeDies[PlantComp,Tree]) * dt
    treepcomp_df$T_PrunCum <- treepcomp_df$T_PrunCum + (treepcomp_df$T_Prun - treepcomp_df$T_PrunCumTreeDies)
    
    # T_RtType0CumInput[PlantComp,Tree](t) = T_RtType0CumInput[PlantComp,Tree](t - dt) + (T_RtType0Input[PlantComp,Tree]) * dt
    treepcomp_df$T_RtType0CumInput <- treepcomp_df$T_RtType0CumInput + (treepcomp_df$T_RtType0Input)
    
    # T_RtType2Biomass[PlantComp,Tree](t) = T_RtType2Biomass[PlantComp,Tree](t - dt) + (T_RootInc[PlantComp,Tree] - T_RootDecay[PlantComp,Tree]) * dt
    treepcomp_df$T_RtType2Biomass <- treepcomp_df$T_RtType2Biomass + (treepcomp_df$T_RootInc - treepcomp_df$T_RootDecay)
    
    # T_SapWood[PlantComp,Tree](t) = T_SapWood[PlantComp,Tree](t - dt) + (T_WoodInc[PlantComp,Tree] + T_WoodIni[PlantComp,Tree] - T_WoodHarvest[PlantComp,Tree] - T_Lignovory[PlantComp,Tree] - T_WoodSlashed[PlantComp,Tree] - T_HeartWoodInc[PlantComp,Tree]) * dt
    treepcomp_df$T_SapWood <- treepcomp_df$T_SapWood +
      (
        treepcomp_df$T_WoodInc + treepcomp_df$T_WoodIni - treepcomp_df$T_WoodHarvest - treepcomp_df$T_Lignovory - treepcomp_df$T_WoodSlashed - treepcomp_df$T_HeartWoodInc
      )
    
    # T_TappedLatex[PlantComp,Tree](t) = T_TappedLatex[PlantComp,Tree](t - dt) + (T_Tapping[PlantComp,Tree]) * dt
    treepcomp_df$T_TappedLatex <- treepcomp_df$T_TappedLatex + (treepcomp_df$T_Tapping)
    
    # T_WoodHarvCum[PlantComp,Tree](t) = T_WoodHarvCum[PlantComp,Tree](t - dt) + (T_WoodHarvest[PlantComp,Tree]) * dt
    treepcomp_df$T_WoodHarvCum <- treepcomp_df$T_WoodHarvCum + (treepcomp_df$T_WoodHarvest)
    
    # TF_LeafTime[Tree](t) = TF_LeafTime[Tree](t - dt) + (TF_LeafClockTicks?[Tree]) * dt
    tree_df$TF_LeafTime <- tree_df$TF_LeafTime + (tree_df$TF_LeafClockTicks_is)
    
    # TF_FruitsperBunch[Tree,Fruitbunch](t) = TF_FruitsperBunch[Tree,Fruitbunch](t - dt) + (TF_FruitNoPassOn[Tree,Fruitbunch] - TF_FruitNumbLoss[Tree,Fruitbunch] - TF_FruitHarvNoperBunch[Tree,Fruitbunch]) * dt
    treefruit_df$TF_FruitsperBunch <- treefruit_df$TF_FruitsperBunch + (
      treefruit_df$TF_FruitNoPassOn - treefruit_df$TF_FruitNumbLoss - treefruit_df$TF_FruitHarvNoperBunch
    )
    
    # T_WoodHarvPast[Tree](t) = T_WoodHarvPast[Tree](t - dt) + (T_WoodHarvEvent[Tree]) * dt
    tree_df$T_WoodHarvPast <- tree_df$T_WoodHarvPast + (tree_df$T_WoodHarvEvent)
    
    # T_PrunWeighTot[Tree](t) = T_PrunWeighTot[Tree](t - dt)
    # tree_df$T_PrunWeighTot <- tree_df$T_PrunWeighTot
    
    # N_Stock1[Zone,SlNut](t) = N_Stock1[Zone,SlNut](t - dt) + (N_In1[Zone,SlNut] + N_NutMobil1[Zone,SlNut] + MN_Mineralization[Zone,SlNut] + N_SomMin1Exch[Zone,SlNut] - N_T1Upt1[Zone,SlNut] - N_CUpt1[Zone,SlNut] - N_T2Upt1[Zone,SlNut] - N_T3Upt1[Zone,SlNut] - N_LatOutFlow11[Zone,SlNut]) * dt
    # N_Stock2[Zone,SlNut](t) = N_Stock2[Zone,SlNut](t - dt) + (N_In2[Zone,SlNut] + N_NutMobil2[Zone,SlNut] + N_SomMin2Exch[Zone,SlNut] - N_T1Upt2[Zone,SlNut] - N_CUpt2[Zone,SlNut] - N_T2Upt2[Zone,SlNut] - N_T3Upt2[Zone,SlNut] - N_LatOutFlow21[Zone,SlNut]) * dt
    # N_Stock3[Zone,SlNut](t) = N_Stock3[Zone,SlNut](t - dt) + (N_In3[Zone,SlNut] + N_NutMobil3[Zone,SlNut] + N_SomMin3Exch[Zone,SlNut] - N_T1Upt3[Zone,SlNut] - N_CUpt3[Zone,SlNut] - N_T2Upt3[Zone,SlNut] - N_T3Upt3[Zone,SlNut] - N_LatOutFlow31[Zone,SlNut]) * dt
    # N_Stock4[Zone,SlNut](t) = N_Stock4[Zone,SlNut](t - dt) + (N_In4[Zone,SlNut] + N_NutMobil4[Zone,SlNut] + N_SomMin4Exch[Zone,SlNut] - N_T1Upt4[Zone,SlNut] - N_CUpt4[Zone,SlNut] - N_T2Upt4[Zone,SlNut] - N_T3Upt4[Zone,SlNut] - N_LatOutFlow41[Zone,SlNut] - N_LeachOutx4[Zone,SlNut]) * dt
    zonelayernut_df$N_Upt_Tsum <- aggregate(zonelayertreenut_df["N_Upt"], zonelayertreenut_df[c("zone", "layer", "SlNut")], sum)$N_Upt
    
    zonelayernut_df$N_Stock_inc <- zonelayernut_df$N_In + zonelayernut_df$N_NutMobil + zonelayernut_df$N_SomMinExch - zonelayernut_df$N_Upt_Tsum - zonelayernut_df$N_CUpt - zonelayernut_df$N_LatOutFlow_1
    zonelayernut_df[zonelayernut_df$layer == 1, "N_Stock_inc"] <- zonelayernut_df[zonelayernut_df$layer == 1, "N_Stock_inc"] + zonenut_df$MN_Mineralization
    zonelayernut_df[zonelayernut_df$layer == 4, "N_Stock_inc"] <- zonelayernut_df[zonelayernut_df$layer == 4, "N_Stock_inc"] - zonenut_df$N_LeachOutx4
    zonelayernut_df$N_Stock <- zonelayernut_df$N_Stock + zonelayernut_df$N_Stock_inc
    
    # S&B_Topsoil_pH[Zone](t) = S&B_Topsoil_pH[Zone](t - dt) + (S&B_pH_change[Zone]) * dt
    zone_df$SB_Topsoil_pH <- zone_df$SB_Topsoil_pH + (zone_df$SB_pH_change)
    
    # RT3_CoarseRt[Tree](t) = RT3_CoarseRt[Tree](t - dt) + (RT3_CRincr[Tree] - RT3_CRdecay[Tree]) * dt
    tree_df$RT3_CoarseRt <- tree_df$RT3_CoarseRt + (tree_df$RT3_CRincr - tree_df$RT3_CRdecay)
    
    # MN2_Act[Zone,SoilLayer](t) = MN2_Act[Zone,SoilLayer](t - dt) + (MN2_MetabActF[Zone,SoilLayer] + MN2_StrucActF[Zone,SoilLayer] + MN2_Act_SomTrans[Zone,SoilLayer] - MN2_ActMinF[Zone,SoilLayer] - MN2_ActSlwF[Zone,SoilLayer] - MN2_ActPassF[Zone,SoilLayer]) * dt
    zonelayer_df$MN2_Act <- zonelayer_df$MN2_Act + (
      zonelayer_df$MN2_MetabActF + zonelayer_df$MN2_StrucActF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Actv", "MN2_SomTrans"] - zonelayer_df$MN2_ActMinF - zonelayer_df$MN2_ActSlwF - zonelayer_df$MN2_ActPassF
    )
    
    # MN2_Metab[Zone,SoilLayer](t) = MN2_Metab[Zone,SoilLayer](t - dt) + (MN2_MetabIn[Zone,SoilLayer] + MN2_Met_SomTrans[Zone,SoilLayer] - MN2_MetabActF[Zone,SoilLayer] - MN2_MetabMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MN2_Metab <- zonelayer_df$MN2_Metab + (
      zonelayer_df$MN2_MetabIn + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Met", "MN2_SomTrans"] - zonelayer_df$MN2_MetabActF - zonelayer_df$MN2_MetabMinF
    )
    
    # MN2_Struc[Zone,SoilLayer](t) = MN2_Struc[Zone,SoilLayer](t - dt) + (MN2_StrucIn[Zone,SoilLayer] + MN2_Struc_SomTrans[Zone,SoilLayer] - MN2_StrucActF[Zone,SoilLayer] - MN2_StrucSlwF[Zone,SoilLayer] - MN2_StrucMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MN2_Struc = zonelayer_df$MN2_Struc + (
      zonelayer_df$MN2_StrucIn + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Str", "MN2_SomTrans"] - zonelayer_df$MN2_StrucActF - zonelayer_df$MN2_StrucSlwF - zonelayer_df$MN2_StrucMinF
    )
    
    # MN2_Slw[Zone,SoilLayer](t) = MN2_Slw[Zone,SoilLayer](t - dt) + (MN2_StrucSlwF[Zone,SoilLayer] + MN2_ActSlwF[Zone,SoilLayer] + MN2_Slw_SomTrans[Zone,SoilLayer] - MN2_SlwPassF[Zone,SoilLayer] - MN2_SlwMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MN2_Slw <- zonelayer_df$MN2_Slw + (
      zonelayer_df$MN2_StrucSlwF + zonelayer_df$MN2_ActSlwF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Slow", "MN2_SomTrans"] - zonelayer_df$MN2_SlwPassF - zonelayer_df$MN2_SlwMinF
    )
    
    # MN2_Pass[Zone,SoilLayer](t) = MN2_Pass[Zone,SoilLayer](t - dt) + (MN2_SlwPassF[Zone,SoilLayer] + MN2_ActPassF[Zone,SoilLayer] + MN2_Pas_SomTrans[Zone,SoilLayer] - MN2_PassMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MN2_Pass <- zonelayer_df$MN2_Pass + (
      zonelayer_df$MN2_SlwPassF + zonelayer_df$MN2_ActPassF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Pass", "MN2_SomTrans"] - zonelayer_df$MN2_PassMinF
    )
    
    # T_ExpRetToLab[Tree](t) = T_ExpRetToLab[Tree](t - dt) + (T_ChExpRettoLabour[Tree]) * dt
    tree_df$T_ExpRetToLab <- tree_df$T_ExpRetToLab + (tree_df$T_ChExpRettoLabour)
    
    # C_WeedSeedBank[Zone,PlantComp](t) = C_WeedSeedBank[Zone,PlantComp](t - dt) + (C_WeedSeedInflux[Zone,PlantComp] + C_WeedSeedFall[Zone,PlantComp] - C_WeedSeedDecay[Zone,PlantComp] - C_WeedGermin[Zone,PlantComp]) * dt
    zonepcomp_df$C_WeedSeedBank <- zonepcomp_df$C_WeedSeedBank + (
      zonepcomp_df$C_WeedSeedInflux + zonepcomp_df$C_WeedSeedFall - zonepcomp_df$C_WeedSeedDecay - zonepcomp_df$C_WeedGermin
    )
    
    # CA_PastImmInp[SlNut](t) = CA_PastImmInp[SlNut](t - dt) + (CA_ImmApp[SlNut]) * dt
    nut_df$CA_PastImmInp <- nut_df$CA_PastImmInp + (nut_df$CA_ImmApp)
    
    # CQ_Stage[Zone](t) = CQ_Stage[Zone](t - dt) + (CQ_StageInc[Zone]) * dt
    zone_df$CQ_Stage <- zone_df$CQ_Stage + zone_df$CQ_StageInc
    
    # MC_Act[Zone](t) = MC_Act[Zone](t - dt) + (MC_MetabActF[Zone] + MC_StrucActF[Zone] - MC_ActCO2In[Zone] - MC_ActSlwF[Zone] - MC_ActPassF[Zone] - MC_Act_LitSomTrans[Zone]) * dt
    zone_df$MC_Act <- zone_df$MC_Act + (
      zone_df$MC_MetabActF + zone_df$MC_StrucActF - zone_df$MC_ActCO2In - zone_df$MC_ActSlwF - zone_df$MC_ActPassF - zone_df$MC_Act_LitSomTrans
    )
    
    # MC_Metab[Zone](t) = MC_Metab[Zone](t - dt) + (MC_MetabIn[Zone] - MC_MetabActF[Zone] - MC_MetabCO2In[Zone] - MC_Met_LitSomTrans[Zone]) * dt
    zone_df$MC_Metab <- zone_df$MC_Metab + (
      zone_df$MC_MetabIn - zone_df$MC_MetabActF - zone_df$MC_MetabCO2In - zone_df$MC_Met_LitSomTrans
    )
    
    # MC_Pass[Zone](t) = MC_Pass[Zone](t - dt) + (MC_SlwPassF[Zone] + MC_ActPassF[Zone] - MC_PassCO2In[Zone] - MC_Pas_LitSomTrans[Zone]) * dt
    zone_df$MC_Pass <- zone_df$MC_Pass + (
      zone_df$MC_SlwPassF + zone_df$MC_ActPassF - zone_df$MC_PassCO2In - zone_df$MC_Pas_LitSomTrans
    )
    
    # MC_Slw[Zone](t) = MC_Slw[Zone](t - dt) + (MC_StrucSlwF[Zone] + MC_ActSlwF[Zone] - MC_SlwPassF[Zone] - MC_SlwCO2In[Zone] - MC_Slw_LitSomTrans[Zone]) * dt
    zone_df$MC_Slw <- zone_df$MC_Slw + (
      zone_df$MC_StrucSlwF + zone_df$MC_ActSlwF - zone_df$MC_SlwPassF - zone_df$MC_SlwCO2In - zone_df$MC_Slw_LitSomTrans
    )
    
    # MC_Struc[Zone](t) = MC_Struc[Zone](t - dt) + (MC_StrucIn[Zone] - MC_StrucActF[Zone] - MC_StrucSlwF[Zone] - MC_StrucSlwCO2In[Zone] - MC_StrucActCO2In[Zone] - MC_Str_LitSomTrans[Zone]) * dt
    zone_df$MC_Struc <- zone_df$MC_Struc + (
      zone_df$MC_StrucIn - zone_df$MC_StrucActF - zone_df$MC_StrucSlwF - zone_df$MC_StrucSlwCO2In - zone_df$MC_StrucActCO2In - zone_df$MC_Str_LitSomTrans
    )
    
    # MC2_Act[Zone,SoilLayer](t) = MC2_Act[Zone,SoilLayer](t - dt) + (MC2_MetabActF[Zone,SoilLayer] + MC2_StrucActF[Zone,SoilLayer] + MC2_Act_SomTrans[Zone,SoilLayer] - MC2_ActCO2In[Zone,SoilLayer] - MC2_ActSlwF[Zone,SoilLayer] - MC2_ActPassF[Zone,SoilLayer]) * dt
    zonelayer_df$MC2_Act <- zonelayer_df$MC2_Act + (
      zonelayer_df$MC2_MetabActF + zonelayer_df$MC2_StrucActF +
        zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Actv", ]$MC2_SomTrans - zonelayer_df$MC2_ActCO2In - zonelayer_df$MC2_ActSlwF - zonelayer_df$MC2_ActPassF
    )
    
    # MC2_Metab[Zone,SoilLayer](t) = MC2_Metab[Zone,SoilLayer](t - dt) + (MC2_MetabIn[Zone,SoilLayer] + MC2_Met_SomTrans[Zone,SoilLayer] - MC2_MetabActF[Zone,SoilLayer] - MC2_MetabCO2In[Zone,SoilLayer]) * dt
    zonelayer_df$MC2_Metab <- zonelayer_df$MC2_Metab + (
      zonelayer_df$MC2_MetabIn + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Met", ]$MC2_SomTrans - zonelayer_df$MC2_MetabActF - zonelayer_df$MC2_MetabCO2In
    )
    
    # MC2_Pass[Zone,SoilLayer](t) = MC2_Pass[Zone,SoilLayer](t - dt) + (MC2_SlwPassF[Zone,SoilLayer] + MC2_ActPassF[Zone,SoilLayer] + MC2_Pass_SomTrans[Zone,SoilLayer] - MC2_PassCO2In[Zone,SoilLayer]) * dt
    zonelayer_df$MC2_Pass <- zonelayer_df$MC2_Pass + (
      zonelayer_df$MC2_SlwPassF + zonelayer_df$MC2_ActPassF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Pass", ]$MC2_SomTrans - zonelayer_df$MC2_PassCO2In
    )
    
    # MC2_Slw[Zone,SoilLayer](t) = MC2_Slw[Zone,SoilLayer](t - dt) + (MC2_StrucSlwF[Zone,SoilLayer] + MC2_ActSlwF[Zone,SoilLayer] + MC2_Slw_SomTrans[Zone,SoilLayer] - MC2_SlwPassF[Zone,SoilLayer] - MC2_SlwCO2In[Zone,SoilLayer]) * dt
    zonelayer_df$MC2_Slw <- zonelayer_df$MC2_Slw + (
      zonelayer_df$MC2_StrucSlwF + zonelayer_df$MC2_ActSlwF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Slow", ]$MC2_SomTrans -
        zonelayer_df$MC2_SlwPassF - zonelayer_df$MC2_SlwCO2In
    )
    
    # MC2_Struc[Zone,SoilLayer](t) = MC2_Struc[Zone,SoilLayer](t - dt) + (MC2_StrucIn[Zone,SoilLayer] + MC2_Struc_SomT[Zone,SoilLayer] - MC2_StrucActF[Zone,SoilLayer] - MC2_StrucSlwF[Zone,SoilLayer] - MC_StrucSlwCO2In_SOM[Zone,SoilLayer] - MC2_StrucActCO2In[Zone,SoilLayer]) * dt
    zonelayer_df$MC2_Struc <- zonelayer_df$MC2_Struc + (
      zonelayer_df$MC2_StrucIn + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Str", ]$MC2_SomTrans -
        zonelayer_df$MC2_StrucActF - zonelayer_df$MC2_StrucSlwF - zonelayer_df$MC_StrucSlwCO2In_SOM - zonelayer_df$MC2_StrucActCO2In
    )
    
    # BC_C_RespforFix(t) = BC_C_RespforFix(t - dt) + (BC_CdailyRespforFix) * dt
    BC_C_RespforFix <- BC_C_RespforFix + (BC_CdailyRespforFix)
    
    # BC_CPhotosynth(t) = BC_CPhotosynth(t - dt) + (BC_CPhotoInc) * dt
    BC_CPhotosynth <- BC_CPhotosynth + (BC_CPhotoInc)
    
    # BC_CropInit(t) = BC_CropInit(t - dt) + (BC_SeedInc) * dt
    BC_CropInit <- BC_CropInit + (BC_SeedInc)
    
    # BC_ExtOrgInput(t) = BC_ExtOrgInput(t - dt) + (BC_ExtOrgAcc) * dt
    BC_ExtOrgInput <- BC_ExtOrgInput + (BC_ExtOrgAcc)
    
    # BC_TimeAvg_CStock(t) = BC_TimeAvg_CStock(t - dt) + (BC_CstockChange) * dt
    BC_TimeAvg_CStock <- BC_TimeAvg_CStock + (BC_CstockChange)
    
    # BC_TPhotosynth(t) = BC_TPhotosynth(t - dt) + (BC_TPhotoInc) * dt
    BC_TPhotosynth <- BC_TPhotosynth + (BC_TPhotoInc)
    
    # BC_TPlantMatTot(t) = BC_TPlantMatTot(t - dt) + (BC_TSeedInc) * dt
    BC_TPlantMatTot <- BC_TPlantMatTot + (BC_TSeedInc)
    
    # BC_TRespforFix(t) = BC_TRespforFix(t - dt) + (T_RespforFixF) * dt
    BC_TRespforFix <- BC_TRespforFix + (T_RespforFixF)
    
    # BC_WeedSeedIn(t) = BC_WeedSeedIn(t - dt) + (BC_WeedCInflux) * dt
    BC_WeedSeedIn <- BC_WeedSeedIn + (BC_WeedCInflux)
    
    # BN_CUptCum[SlNut](t) = BN_CUptCum[SlNut](t - dt) + (BN_CUptInc[SlNut]) * dt
    nut_df$BN_CUptCum <- nut_df$BN_CUptCum + (nut_df$BN_CUptInc)
    
    # BN_ExtOrgInputs[SlNut](t) = BN_ExtOrgInputs[SlNut](t - dt) + (BN_ExtOrgAcc[SlNut]) * dt
    nut_df$BN_ExtOrgInputs <- nut_df$BN_ExtOrgInputs + (nut_df$BN_ExtOrgAcc)
    
    # BN_FertCum[SlNut](t) = BN_FertCum[SlNut](t - dt) + (BN_Fert[SlNut]) * dt
    nut_df$BN_FertCum <- nut_df$BN_FertCum + (nut_df$BN_Fert)
    
    # BN_ImmPool[SlNut](t) = BN_ImmPool[SlNut](t - dt) + (BN_ImmInputF[SlNut]) * dt
    nut_df$BN_ImmPool <- nut_df$BN_ImmPool + (nut_df$BN_ImmInputF[SlNut])
    
    # BN_RunOffLoss[SlNut](t) = BN_RunOffLoss[SlNut](t - dt) + (BN_RunOff[SlNut]) * dt
    nut_df$BN_RunOffLoss <- nut_df$BN_RunOffLoss + (nut_df$BN_RunOff)
    
    # BN_TNFixAmountCum[SlNut,Tree](t) = BN_TNFixAmountCum[SlNut,Tree](t - dt) + (T_NFix[SlNut,Tree]) * dt
    treenut_df$BN_TNFixAmountCum <- treenut_df$BN_TNFixAmountCum + (treenut_df$T_NFix)
    
    # BN_TreeInit[SlNut](t) = BN_TreeInit[SlNut](t - dt) + (BN_TreeInc[SlNut]) * dt
    nut_df$BN_TreeInit <- nut_df$BN_TreeInit + (nut_df$BN_TreeInc)
    
    # BN_TUptCum[SlNut,Tree](t) = BN_TUptCum[SlNut,Tree](t - dt) + (BN_TUptInc[SlNut,Tree]) * dt
    treenut_df$BN_TUptCum <- treenut_df$BN_TUptCum + (treenut_df$BN_TUptInc)
    
    # BS_SoilCurrZn[Zone](t) = BS_SoilCurrZn[Zone](t - dt) + (BS_SoilIncr[Zone]) * dt
    zone_df$BS_SoilCurrZn <- zone_df$BS_SoilCurrZn + (zone_df$BS_SoilIncr)
    
    # BW_EvapCum(t) = BW_EvapCum(t - dt) + (BW_Evap) * dt
    BW_EvapCum <- BW_EvapCum + (BW_Evap)
    
    # BW_RunOffCum(t) = BW_RunOffCum(t - dt) + (BW_RunOff) * dt
    BW_RunOffCum <- BW_RunOffCum + (BW_RunOff)
    
    # BW_RunOnCum(t) = BW_RunOnCum(t - dt) + (BW_RunOn) * dt
    BW_RunOnCum <- BW_RunOnCum + (BW_RunOn)
    
    # BW_UptCCum(t) = BW_UptCCum(t - dt) + (BW_UptC) * dt
    BW_UptCCum <- BW_UptCCum + (BW_UptC)
    
    # BW_UptTCum[Tree](t) = BW_UptTCum[Tree](t - dt) + (BW_UptT[Tree]) * dt
    tree_df$BW_UptTCum <- tree_df$BW_UptTCum + (tree_df$BW_UptT)
    
    # BW_UptWCum(t) = BW_UptWCum(t - dt) + (BW_WeedEvap) * dt
    BW_UptWCum <- BW_UptWCum + (BW_WeedEvap)
    
    # C_AgronYPerType[Zone,Cr](t) = C_AgronYPerType[Zone,Cr](t - dt) + (C_AgYieldAcc[Zone,Cr]) * dt
    zonecrop_df$C_AgronYPerType <- zonecrop_df$C_AgronYPerType + (zonecrop_df$C_AgYieldAcc)
    
    # C_BiomHarvestCum[Zone,PlantComp](t) = C_BiomHarvestCum[Zone,PlantComp](t - dt) + (C_BiomHarvest[Zone,PlantComp]) * dt
    zonepcomp_df$C_BiomHarvestCum <- zonepcomp_df$C_BiomHarvestCum + (zonepcomp_df$C_BiomHarvest)
    
    # C_CropDays[Zone](t) = C_CropDays[Zone](t - dt) + (C_CropDayAc[Zone]) * dt
    zone_df$C_CropDays <- zone_df$C_CropDays + (zone_df$C_CropDayAc)
    
    # C_CumLim[Zone,Limiting_Factors](t) = C_CumLim[Zone,Limiting_Factors](t - dt) + (C_CurLimFac[Zone,Limiting_Factors]) * dt
    zonelimit_df$C_CumLim <- zonelimit_df$C_CumLim + (zonelimit_df$C_CurLimFac)
    
    # C_YieldCurr[Zone,PlantComp](t) = C_YieldCurr[Zone,PlantComp](t - dt) + (C_YieldInc[Zone,PlantComp] - C_Yield[Zone,PlantComp] - C_FruitLoss[Zone,PlantComp] - C_WeedSeedFall[Zone,PlantComp]) * dt
    zonepcomp_df$C_YieldCurr <- zonepcomp_df$C_YieldCurr + (
      zonepcomp_df$C_YieldInc - zonepcomp_df$C_Yield - zonepcomp_df$C_FruitLoss - zonepcomp_df$C_WeedSeedFall
    )
    
    # C_GroRes[Zone,PlantComp](t) = C_GroRes[Zone,PlantComp](t - dt) + (C_BiomInc[Zone,PlantComp] + C_WeedGermin[Zone,PlantComp] - C_StLeafInc[Zone,PlantComp] - C_YieldInc[Zone,PlantComp] - C_ResidLast[Zone,PlantComp] - C_Respiration[Zone,PlantComp] - C_RootGrowth[Zone,PlantComp]) * dt
    zonepcomp_df$C_GroRes <- zonepcomp_df$C_GroRes +
      (
        zonepcomp_df$C_BiomInc + zonepcomp_df$C_WeedGermin - zonepcomp_df$C_StLeafInc - zonepcomp_df$C_YieldInc - zonepcomp_df$C_ResidLast - zonepcomp_df$C_Respiration - zonepcomp_df$C_RootGrowth
      )
    
    # C_HarvestCum[Zone,PlantComp](t) = C_HarvestCum[Zone,PlantComp](t - dt) + (C_Yield[Zone,PlantComp]) * dt
    zonepcomp_df$C_HarvestCum <- zonepcomp_df$C_HarvestCum + (zonepcomp_df$C_Yield)
    
    # C_HydEqFluxes[Zone](t) = C_HydEqFluxes[Zone](t - dt) + (CW_HydFluxPosTot[Zone]) * dt
    zone_df$C_HydEqFluxes <- zone_df$C_HydEqFluxes + (zone_df$CW_HydFluxPosTot)
    
    # C_NDfaTot[Zone,SlNut](t) = C_NDfaTot[Zone,SlNut](t - dt) + (C_NFIX[Zone,SlNut]) * dt
    zonenut_df$C_NDfaTot <- zonenut_df$C_NDfaTot + (zonenut_df$C_NFIX)
    
    # C_ResidRecycle[Zone,PlantComp](t) = C_ResidRecycle[Zone,PlantComp](t - dt) + (C_ResidMulch[Zone,PlantComp]) * dt
    zonepcomp_df$C_ResidRecycle <- zonepcomp_df$C_ResidRecycle + (zonepcomp_df$C_ResidMulch)
    
    # C_ResidRemoved[Zone,PlantComp](t) = C_ResidRemoved[Zone,PlantComp](t - dt) + (C_Resid[Zone,PlantComp]) * dt
    zonepcomp_df$C_ResidRemoved <- zonepcomp_df$C_ResidRemoved + (zonepcomp_df$C_Resid)
    
    # CENT_ExtOrgInputs[SlNut](t) = CENT_ExtOrgInputs[SlNut](t - dt) + (CENT_ExtInpNInc[SlNut]) * dt
    nut_df$CENT_ExtOrgInputs <- nut_df$CENT_ExtOrgInputs + (nut_df$CENT_ExtInpNInc)
    
    # CENT_LitterNInflow[SlNut](t) = CENT_LitterNInflow[SlNut](t - dt) + (CENT_LitterNInc[SlNut]) * dt
    nut_df$CENT_LitterNInflow <- nut_df$CENT_LitterNInflow + (nut_df$CENT_LitterNInc)
    
    # CENT_NOut[SlNut](t) = CENT_NOut[SlNut](t - dt) + (CENT_NInc[SlNut]) * dt
    nut_df$CENT_NOut <- nut_df$CENT_NOut + (nut_df$CENT_NInc)
    
    # CENT2_LitSomTransfAcc[SlNut](t) = CENT2_LitSomTransfAcc[SlNut](t - dt) + (Cent2LitSomAcc[SlNut]) * dt
    nut_df$CENT2_LitSomTransfAcc <- nut_df$CENT2_LitSomTransfAcc + (nut_df$Cent2LitSomAcc)
    
    # CENT2_NOut[SlNut](t) = CENT2_NOut[SlNut](t - dt) + (CENT2_Ninc[SlNut]) * dt
    nut_df$CENT2_NOut <- nut_df$CENT2_NOut + (nut_df$CENT2_Ninc)
    
    # CENT2_SOMNinflow[SlNut](t) = CENT2_SOMNinflow[SlNut](t - dt) + (CENT2_SOMNInc[SlNut]) * dt
    nut_df$CENT2_SOMNinflow <- nut_df$CENT2_SOMNinflow + (nut_df$CENT2_SOMNInc)
    
    # CW_DemandPerRoot[Zone](t) = CW_DemandPerRoot[Zone](t - dt) + (CW_YDayWUotChange[Zone]) * dt
    zone_df$CW_DemandPerRoot <- zone_df$CW_DemandPerRoot + (zone_df$CW_YDayWUotChange)
    
    # E_CumSoilInflowZn[Zone](t) = E_CumSoilInflowZn[Zone](t - dt) + (E_SoilInflow[Zone]) * dt
    zone_df$E_CumSoilInflowZn <- zone_df$E_CumSoilInflowZn + (zone_df$E_SoilInflow)
    
    # E_PloughPast(t) = E_PloughPast(t - dt) + (E_PloughEvent) * dt
    E_PloughPast <- E_PloughPast + (E_PloughEvent)
    
    # E_SoilLossCumZn[Zone](t) = E_SoilLossCumZn[Zone](t - dt) + (E_SoilLoss[Zone]) * dt
    zone_df$E_SoilLossCumZn <- zone_df$E_SoilLossCumZn + (zone_df$E_SoilLoss)
    
    # EVAP_SlashWater[Zone](t) = EVAP_SlashWater[Zone](t - dt) + (EVAP_SlashInit[Zone] - EVAP_SlashEvap[Zone]) * dt
    zone_df$EVAP_SlashWater <- zone_df$EVAP_SlashWater + (zone_df$EVAP_SlashInit - zone_df$EVAP_SlashEvap)
    
    # EVAP_SurfCum[Zone](t) = EVAP_SurfCum[Zone](t - dt) + (EVAP_Surf[Zone]) * dt
    zone_df$EVAP_SurfCum <- zone_df$EVAP_SurfCum + (zone_df$EVAP_Surf)
    
    # EVAP_WoodMoist[Zone](t) = EVAP_WoodMoist[Zone](t - dt) + (EVAP_InitWoodMoist[Zone] - EVAP_FromDeadWood[Zone]) * dt
    zone_df$EVAP_WoodMoist <- zone_df$EVAP_WoodMoist + (zone_df$EVAP_InitWoodMoist - zone_df$EVAP_FromDeadWood)
    
    # EVAP_YesterdayTTransp(t) = EVAP_YesterdayTTransp(t - dt) + (EVAP_TTranspHist) * dt
    EVAP_YesterdayTTransp <- EVAP_YesterdayTTransp + (EVAP_TTranspHist)
    
    # G_CumFeedSufficiency[PlantComp](t) = G_CumFeedSufficiency[PlantComp](t - dt) + (G_Feed_Sufficiency[PlantComp]) * dt
    pcomp_df$G_CumFeedSufficiency <- pcomp_df$G_CumFeedSufficiency + (pcomp_df$G_Feed_Sufficiency)
    
    # G_Grazed_Manure_Output[PlantComp](t) = G_Grazed_Manure_Output[PlantComp](t - dt) + (G_ManureProd[PlantComp]) * dt
    pcomp_df$G_Grazed_Manure_Output <- pcomp_df$G_Grazed_Manure_Output + (pcomp_df$G_ManureProd)
    
    # G_Grazed_Respired[PlantComp](t) = G_Grazed_Respired[PlantComp](t - dt) + (G_GrazeResp[PlantComp]) * dt
    pcomp_df$G_Grazed_Respired <- pcomp_df$G_Grazed_Respired + (pcomp_df$G_GrazeResp)
    
    # G_GrazedBiomCum[PlantComp](t) = G_GrazedBiomCum[PlantComp](t - dt) + (G_BiomassGrazed[PlantComp]) * dt
    pcomp_df$G_GrazedBiomCum <- pcomp_df$G_GrazedBiomCum + (pcomp_df$G_BiomassGrazed)
    
    # G_LivestWeightGain[PlantComp](t) = G_LivestWeightGain[PlantComp](t - dt) + (G_Animal_Weight_Gain[PlantComp]) * dt
    pcomp_df$G_LivestWeightGain <- pcomp_df$G_LivestWeightGain + (pcomp_df$G_Animal_Weight_Gain)
    
    # GHG_AnaerobIndic[Zone](t) = GHG_AnaerobIndic[Zone](t - dt) + (- GHG_AnaerobIndicCh[Zone]) * dt
    zone_df$GHG_AnaerobIndic <- zone_df$GHG_AnaerobIndic + (-zone_df$GHG_AnaerobIndicCh)
    
    # GHG_N2_EmZn[Zone](t) = GHG_N2_EmZn[Zone](t - dt) + (GHG_N2_Em[Zone]) * dt
    zone_df$GHG_N2_EmZn <- zone_df$GHG_N2_EmZn + (zone_df$GHG_N2_Em)
    
    # GHG_Net_CH4_Em[Zone](t) = GHG_Net_CH4_Em[Zone](t - dt) + (GHG_CH4FluxZn[Zone]) * dt
    zone_df$GHG_Net_CH4_Em <- zone_df$GHG_Net_CH4_Em + (zone_df$GHG_CH4FluxZn)
    
    # GHG_Nitric_Oxide_EmZn[Zone](t) = GHG_Nitric_Oxide_EmZn[Zone](t - dt) + (GHG_NO_Em[Zone]) * dt
    zone_df$GHG_Nitric_Oxide_EmZn <- zone_df$GHG_Nitric_Oxide_EmZn + (zone_df$GHG_NO_Em)
    
    # GHG_Nitrous_Oxide_EmZn[Zone](t) = GHG_Nitrous_Oxide_EmZn[Zone](t - dt) + (GHG_N2O_Em[Zone]) * dt
    zone_df$GHG_Nitrous_Oxide_EmZn <- zone_df$GHG_Nitrous_Oxide_EmZn + (zone_df$GHG_N2O_Em)
    
    # LF_H1Drain1Cum(t) = LF_H1Drain1Cum(t - dt) + (W_H1DrainF) * dt
    # LF_H2Drain1Cum(t) = LF_H2Drain1Cum(t - dt) + (W_H2DrainF) * dt
    # LF_H3Drain1Cum(t) = LF_H3Drain1Cum(t - dt) + (W_H3DrainF) * dt
    # LF_H4Drain1Cum(t) = LF_H4Drain1Cum(t - dt) + (W_H4DrainF) * dt
    layer_df$LF_HDrain1Cum <- layer_df$LF_HDrain1Cum + (layer_df$W_HDrainF)
    
    # LF_LatIn1Cum(t) = LF_LatIn1Cum(t - dt) + (LF_LatAc1) * dt
    # LF_LatIn2Cum(t) = LF_LatIn2Cum(t - dt) + (LF_LatAc2) * dt
    # LF_LatIn3Cum(t) = LF_LatIn3Cum(t - dt) + (LF_LatAc3) * dt
    # LF_LatIn4Cum(t) = LF_LatIn4Cum(t - dt) + (LF_LatAc4) * dt
    layer_df$LF_LatInCum <- layer_df$LF_LatInCum + (layer_df$LF_LatAc)
    
    # LIGHT_CRefRelCapCum[Zone](t) = LIGHT_CRefRelCapCum[Zone](t - dt) + (LIGHT_CCapRelInc[Zone]) * dt
    zone_df$LIGHT_CRefRelCapCum <- zone_df$LIGHT_CRefRelCapCum + (zone_df$LIGHT_CCapRelInc)
    
    # MC_ActCO2[Zone](t) = MC_ActCO2[Zone](t - dt) + (MC_ActCO2In[Zone]) * dt
    zone_df$MC_ActCO2 <- zone_df$MC_ActCO2 + (zone_df$MC_ActCO2In)
    
    # MC_MetabCO2[Zone](t) = MC_MetabCO2[Zone](t - dt) + (MC_MetabCO2In[Zone]) * dt
    zone_df$MC_MetabCO2 <- zone_df$MC_MetabCO2 + (zone_df$MC_MetabCO2In)
    
    # MC_PassCO2[Zone](t) = MC_PassCO2[Zone](t - dt) + (MC_PassCO2In[Zone]) * dt
    zone_df$MC_PassCO2 <- zone_df$MC_PassCO2 + (zone_df$MC_PassCO2In)
    
    # MC_SlwCO2[Zone](t) = MC_SlwCO2[Zone](t - dt) + (MC_SlwCO2In[Zone]) * dt
    zone_df$MC_SlwCO2 <- zone_df$MC_SlwCO2 + (zone_df$MC_SlwCO2In)
    
    # MC_StrucActCO2[Zone](t) = MC_StrucActCO2[Zone](t - dt) + (MC_StrucActCO2In[Zone]) * dt
    zone_df$MC_StrucActCO2 <- zone_df$MC_StrucActCO2 + (zone_df$MC_StrucActCO2In)
    
    # MC_StrucSlwCO2[Zone](t) = MC_StrucSlwCO2[Zone](t - dt) + (MC_StrucSlwCO2In[Zone]) * dt
    zone_df$MC_StrucSlwCO2 <- zone_df$MC_StrucSlwCO2 + (zone_df$MC_StrucSlwCO2In)
    
    # MC2_OrgC_Leached[Zone](t) = MC2_OrgC_Leached[Zone](t - dt) + (MC2_OrgC_Leaching[Zone]) * dt
    zone_df$MC2_OrgC_Leached <- zone_df$MC2_OrgC_Leached + (zone_df$MC2_OrgC_Leaching)
    
    #TODO:Script below is error. Unbalanced array dimension. to be confirmed
    # sum by zone (whole layers)
    
    # MC2_ActCO2[Zone](t) = MC2_ActCO2[Zone](t - dt) + (MC2_ActCO2In[Zone,SoilLayer]) * dt
    zone_df$MC2_ActCO2 <- zone_df$MC2_ActCO2 + aggregate(zonelayer_df$MC2_ActCO2In, zonelayer_df["zone"], sum)$x
    
    # MC2_MetabCO2[Zone](t) = MC2_MetabCO2[Zone](t - dt) + (MC2_MetabCO2In[Zone,SoilLayer]) * dt
    zone_df$MC2_MetabCO2 <- zone_df$MC2_MetabCO2 + aggregate(zonelayer_df$MC2_MetabCO2In, zonelayer_df["zone"], sum)$x
    
    # MC2_PassCO2[Zone](t) = MC2_PassCO2[Zone](t - dt) + (MC2_PassCO2In[Zone,SoilLayer]) * dt
    zone_df$MC2_PassCO2 <- zone_df$MC2_PassCO2 + aggregate(zonelayer_df$MC2_PassCO2In, zonelayer_df["zone"], sum)$x
    
    # MC2_SlwCO2[Zone](t) = MC2_SlwCO2[Zone](t - dt) + (MC2_SlwCO2In[Zone,SoilLayer]) * dt
    zone_df$MC2_SlwCO2 <- zone_df$MC2_SlwCO2 + aggregate(zonelayer_df$MC2_SlwCO2In, zonelayer_df["zone"], sum)$x
    
    # MC2_StrucActCO2[Zone](t) = MC2_StrucActCO2[Zone](t - dt) + (MC2_StrucActCO2In[Zone,SoilLayer]) * dt
    zone_df$MC2_StrucActCO2 <- zone_df$MC2_StrucActCO2 + aggregate(zonelayer_df$MC2_StrucActCO2In, zonelayer_df["zone"], sum)$x
    
    # MC2_StrucSlwCO2[Zone](t) = MC2_StrucSlwCO2[Zone](t - dt) + (MC_StrucSlwCO2In_SOM[Zone,SoilLayer]) * dt
    zone_df$MC2_StrucSlwCO2 <- zone_df$MC2_StrucSlwCO2 + aggregate(zonelayer_df$MC_StrucSlwCO2In_SOM, zonelayer_df["zone"], sum)$x
    
    # MN_FertOnSoil[Zone,SlNut](t) = MN_FertOnSoil[Zone,SlNut](t - dt) + (MN_FertNZn[Zone,SlNut] - MN_FertDissF[Zone,SlNut] - MN_LatFlowFert[Zone,SlNut]) * dt
    zonenut_df$MN_FertOnSoil <- zonenut_df$MN_FertOnSoil + (zonenut_df$MN_FertNZn - zonenut_df$MN_FertDissF - zonenut_df$MN_LatFlowFert)
    
    # MN_MinNutpool[Zone,SlNut](t) = MN_MinNutpool[Zone,SlNut](t - dt) + (MN_SlwMinF[Zone,SlNut] + MN_ActMinF[Zone,SlNut] + MN_MetabMinF[Zone,SlNut] + MN_StrucMinF[Zone,SlNut] + MN_PasMinF[Zone,SlNut] - MN_Mineralization[Zone,SlNut]) * dt
    zonenut_df$MN_MinNutpool <- zonenut_df$MN_MinNutpool +
      (
        zonenut_df$MN_SlwMinF + zonenut_df$MN_ActMinF + zonenut_df$MN_MetabMinF + zonenut_df$MN_StrucMinF + zonenut_df$MN_PasMinF - zonenut_df$MN_Mineralization
      )
    
    # MN2_MinNutpool[Zone,SoilLayer](t) = MN2_MinNutpool[Zone,SoilLayer](t - dt) + (MN2_ActMinF[Zone,SoilLayer] + MN2_SlwMinF[Zone,SoilLayer] + MN2_StrucMinF[Zone,SoilLayer] + MN2_MetabMinF[Zone,SoilLayer] + MN2_PassMinF[Zone,SoilLayer] - MN2_SomMinExch[Zone,SoilLayer]) * dt
    zonelayer_df$MN2_MinNutpool <- zonelayer_df$MN2_MinNutpool +
      (
        zonelayer_df$MN2_ActMinF + zonelayer_df$MN2_SlwMinF + zonelayer_df$MN2_StrucMinF + zonelayer_df$MN2_MetabMinF + zonelayer_df$MN2_PassMinF - zonelayer_df$MN2_SomMinExch
      )
    
    # MN2_OrgNLeached[Zone](t) = MN2_OrgNLeached[Zone](t - dt) + (MN2_OrgN_leaching[Zone]) * dt
    zone_df$MN2_OrgNLeached <- zone_df$MN2_OrgNLeached + (zone_df$MN2_OrgN_leaching)
    
    # MP2_Act[Zone,SoilLayer](t) = MP2_Act[Zone,SoilLayer](t - dt) + (MP2_MetabActF[Zone,SoilLayer] + MP2_StrucActF[Zone,SoilLayer] + MP2_Act_SomTrans[Zone,SoilLayer] - MP2_ActMinF[Zone,SoilLayer] - MP2_ActSlwF[Zone,SoilLayer] - MP2_ActPassF[Zone,SoilLayer]) * dt
    zonelayer_df$MP2_Act <- zonelayer_df$MP2_Act +
      (
        zonelayer_df$MP2_MetabActF + zonelayer_df$MP2_StrucActF + zonelayer_df$MP2_Act_SomTrans - zonelayer_df$MP2_ActMinF - zonelayer_df$MP2_ActSlwF - zonelayer_df$MP2_ActPassF
      )
    
    # MP2_Metab[Zone,SoilLayer](t) = MP2_Metab[Zone,SoilLayer](t - dt) + (MP2_MetabIn[Zone,SoilLayer] + MP2_Met_SomTrans[Zone,SoilLayer] - MP2_MetabActF[Zone,SoilLayer] - MP_MetabMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MP2_Metab <- zonelayer_df$MP2_Metab + (
      zonelayer_df$MP2_MetabIn + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Met", "MP2_SomTrans"] - zonelayer_df$MP2_MetabActF - zonelayer_df$Mp_MetabMinF
    )
    
    # MP2_MinNutpool[Zone,SoilLayer](t) = MP2_MinNutpool[Zone,SoilLayer](t - dt) + (MP2_ActMinF[Zone,SoilLayer] + MP2_SlwMinF[Zone,SoilLayer] + MP2_PassMinF[Zone,SoilLayer] + MP_MetabMinF[Zone,SoilLayer] + MP2_StrucMinF[Zone,SoilLayer] - MP2_SomMinExch[Zone,SoilLayer]) * dt
    zonelayer_df$MP2_MinNutpool <- zonelayer_df$MP2_MinNutpool + (
      zonelayer_df$MP2_ActMinF + zonelayer_df$MP2_SlwMinF + zonelayer_df$MP2_PassMinF + zonelayer_df$Mp_MetabMinF + zonelayer_df$MP2_StrucMinF - zonelayer_df$MP2_SomMinExch
    )
    
    # MP2_OrgP_Leached[Zone](t) = MP2_OrgP_Leached[Zone](t - dt) + (MP2_OrgP_Leaching[Zone]) * dt
    zone_df$MP2_OrgP_Leached <- zone_df$MP2_OrgP_Leached + (zone_df$MP2_OrgP_Leaching)
    
    # MP2_Pass[Zone,SoilLayer](t) = MP2_Pass[Zone,SoilLayer](t - dt) + (MP2_SlwPassF[Zone,SoilLayer] + MP2_ActPassF[Zone,SoilLayer] + MP2_Pas_SomTrans[Zone,SoilLayer] - MP2_PassMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MP2_Pass <- zonelayer_df$MP2_Pass + (
      zonelayer_df$MP2_SlwPassF + zonelayer_df$MP2_ActPassF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Pass", "MP2_SomTrans"] - zonelayer_df$MP2_PassMinF
    )
    
    # MP2_Slw[Zone,SoilLayer](t) = MP2_Slw[Zone,SoilLayer](t - dt) + (MP2_StrucSlwF[Zone,SoilLayer] + MP2_ActSlwF[Zone,SoilLayer] + MP2_Slw_SomTrans[Zone,SoilLayer] - MP2_SlwPassF[Zone,SoilLayer] - MP2_SlwMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MP2_Slw <- zonelayer_df$MP2_Slw + (
      zonelayer_df$MP2_StrucSlwF + zonelayer_df$MP2_ActSlwF + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Slow", "MP2_SomTrans"] - zonelayer_df$MP2_SlwPassF  - zonelayer_df$MP2_SlwMinF
    )
    
    # MP2_Struc[Zone,SoilLayer](t) = MP2_Struc[Zone,SoilLayer](t - dt) + (MP2_StrucIn[Zone,SoilLayer] + MP2_Str_SomTrans[Zone,SoilLayer] - MP2_StrucActF[Zone,SoilLayer] - MP2_StrucSlwF[Zone,SoilLayer] - MP2_StrucMinF[Zone,SoilLayer]) * dt
    zonelayer_df$MP2_Struc <- zonelayer_df$MP2_Struc + (
      zonelayer_df$MP2_StrucIn + zonelayercpools_df[zonelayercpools_df$CENT_Pools == "Str", "MP2_SomTrans"] - zonelayer_df$MP2_StrucActF - zonelayer_df$MP2_StrucSlwF - zonelayer_df$MP2_StrucMinF
    )
    
    # N_CumAtmInput[SlNut](t) = N_CumAtmInput[SlNut](t - dt) + (N_AtmInp[SlNut]) * dt
    nut_df$N_CumAtmInput <- nut_df$N_CumAtmInput + (nut_df$N_AtmInp)
    
    # N_LatInflowCum1[SlNut](t) = N_LatInflowCum1[SlNut](t - dt) + (N_LatInFlow1[SlNut]) * dt
    # N_LatInflowCum2[SlNut](t) = N_LatInflowCum2[SlNut](t - dt) + (N_LatInFlow2[SlNut]) * dt
    # N_LatInflowCum3[SlNut](t) = N_LatInflowCum3[SlNut](t - dt) + (N_LatInFlow3[SlNut]) * dt
    # N_LatInFlowCum4[SlNut](t) = N_LatInFlowCum4[SlNut](t - dt) + (N_LatInFlow4[SlNut]) * dt
    layernut_df$N_LatInflowCum <- layernut_df$N_LatInflowCum + (layernut_df$N_LatInFlow)
    
    # N_LatOutflowCum1[SlNut](t) = N_LatOutflowCum1[SlNut](t - dt) + (N_LatOutFlow11[Zone,SlNut]) * dt
    # N_LatOutflowCum2[SlNut](t) = N_LatOutflowCum2[SlNut](t - dt) + (N_LatOutFlow21[Zone,SlNut]) * dt
    # N_LatOutflowCum3[SlNut](t) = N_LatOutflowCum3[SlNut](t - dt) + (N_LatOutFlow31[Zone,SlNut]) * dt
    # N_LatOutflowCum4[SlNut](t) = N_LatOutflowCum4[SlNut](t - dt) + (N_LatOutFlow41[Zone,SlNut]) * dt
    layernut_df$N_LatOutflowCum <- layernut_df$N_LatOutflowCum + (aggregate(zonelayernut_df$N_LatOutFlow_1, zonelayernut_df[c("layer", "SlNut")], sum)[[3]])
    
    # N_LeachCumV[Zone,SlNut](t) = N_LeachCumV[Zone,SlNut](t - dt) + (N_LeachOutx4[Zone,SlNut]) * dt
    zonenut_df$N_LeachCumV <- zonenut_df$N_LeachCumV + (zonenut_df$N_LeachOutx4)
    
    # N_N2LossCum1[Zone](t) = N_N2LossCum1[Zone](t - dt) + (N_NGassLoss1[Zone]) * dt
    # N_N2LossCum2[Zone](t) = N_N2LossCum2[Zone](t - dt) + (N_NgassLoss2[Zone]) * dt
    # N_N2LossCum3[Zone](t) = N_N2LossCum3[Zone](t - dt) + (N_NgassLoss3[Zone]) * dt
    # N_N2LossCum4[Zone](t) = N_N2LossCum4[Zone](t - dt) + (N_NgassLoss4[Zone]) * dt
    zonelayer_df$N_N2LossCum <- zonelayer_df$N_N2LossCum + (zonelayer_df$N_NGassLoss)
    
    # N_UptCCum1[Zone,SlNut](t) = N_UptCCum1[Zone,SlNut](t - dt) + (N_CUpt1[Zone,SlNut]) * dt
    # N_UptCCum2[Zone,SlNut](t) = N_UptCCum2[Zone,SlNut](t - dt) + (N_CUpt2[Zone,SlNut]) * dt
    # N_UptCCum3[Zone,SlNut](t) = N_UptCCum3[Zone,SlNut](t - dt) + (N_CUpt3[Zone,SlNut]) * dt
    # N_UptCCum4[Zone,SlNut](t) = N_UptCCum4[Zone,SlNut](t - dt) + (N_CUpt4[Zone,SlNut]) * dt
    zonelayernut_df$N_UptCCum <- zonelayernut_df$N_UptCCum + (zonelayernut_df$N_CUpt)
    
    # N_UptT1Cum1[Zone,SlNut](t) = N_UptT1Cum1[Zone,SlNut](t - dt) + (N_T1Upt1[Zone,SlNut]) * dt
    # N_UptT1Cum2[Zone,SlNut](t) = N_UptT1Cum2[Zone,SlNut](t - dt) + (N_T1Upt2[Zone,SlNut]) * dt
    # N_UptT1Cum3[Zone,SlNut](t) = N_UptT1Cum3[Zone,SlNut](t - dt) + (N_T1Upt3[Zone,SlNut]) * dt
    # N_UptT1Cum4[Zone,SlNut](t) = N_UptT1Cum4[Zone,SlNut](t - dt) + (N_T1Upt4[Zone,SlNut]) * dt
    # N_UptT2Cum1[Zone,SlNut](t) = N_UptT2Cum1[Zone,SlNut](t - dt) + (N_T2Upt1[Zone,SlNut]) * dt
    # N_UptT2Cum2[Zone,SlNut](t) = N_UptT2Cum2[Zone,SlNut](t - dt) + (N_T2Upt2[Zone,SlNut]) * dt
    # N_UptT2Cum3[Zone,SlNut](t) = N_UptT2Cum3[Zone,SlNut](t - dt) + (N_T2Upt3[Zone,SlNut]) * dt
    # N_UptT2Cum4[Zone,SlNut](t) = N_UptT2Cum4[Zone,SlNut](t - dt) + (N_T2Upt4[Zone,SlNut]) * dt
    # N_UptT3Cum1[Zone,SlNut](t) = N_UptT3Cum1[Zone,SlNut](t - dt) + (N_T3Upt1[Zone,SlNut]) * dt
    # N_UptT3Cum2[Zone,SlNut](t) = N_UptT3Cum2[Zone,SlNut](t - dt) + (N_T3Upt2[Zone,SlNut]) * dt
    # N_UptT3Cum3[Zone,SlNut](t) = N_UptT3Cum3[Zone,SlNut](t - dt) + (N_T3Upt3[Zone,SlNut]) * dt
    # N_UptT3Cum4[Zone,SlNut](t) = N_UptT3Cum4[Zone,SlNut](t - dt) + (N_T3Upt4[Zone,SlNut]) * dt
    zonelayertreenut_df$N_UptTCum <- zonelayertreenut_df$N_UptTCum + (zonelayertreenut_df$N_Upt)
    
    # N15_C_GroRes[Zone](t) = N15_C_GroRes[Zone](t - dt) + (N15_C_Incr[Zone] - N15_C_StLvIncr[Zone] - N15_C_RtIncr[Zone] - N15_C_FrtInc[Zone] - N15_C_residlast[Zone]) * dt
    zone_df$N15_C_GroRes <- zone_df$N15_C_GroRes + (
      zone_df$N15_C_Incr - zone_df$N15_C_StLvIncr - zone_df$N15_C_RtIncr - zone_df$N15_C_FrtInc - zone_df$N15_C_residlast
    )
    
    # N15_C_ResidCum[Zone](t) = N15_C_ResidCum[Zone](t - dt) + (N15_ResidMulch[Zone]) * dt
    zone_df$N15_C_ResidCum <- zone_df$N15_C_ResidCum + (zone_df$N15_ResidMulch)
    
    
    # N15_C_Root[Zone](t) = N15_C_Root[Zone](t - dt) + (N15_C_RtIncr[Zone] - N15_C_RtDec[Zone]) * dt
    zone_df$N15_C_Root <- zone_df$N15_C_Root + (zone_df$N15_C_RtIncr - zone_df$N15_C_RtDec)
    
    # N15_C_StLv[Zone](t) = N15_C_StLv[Zone](t - dt) + (N15_C_StLvIncr[Zone] - N15_C_Resid[Zone] - N15_C_StLvMulch[Zone]) * dt
    zone_df$N15_C_StLv <- zone_df$N15_C_StLv + (zone_df$N15_C_StLvIncr - zone_df$N15_C_Resid - zone_df$N15_C_StLvMulch)
    
    # N15_C_YieldCurr[Zone](t) = N15_C_YieldCurr[Zone](t - dt) + (N15_C_FrtInc[Zone] - N15_C_Yield[Zone] - N15_C_FruitLoss[Zone] - N15_WeedSeedFall[Zone]) * dt
    zone_df$N15_C_YieldCurr <- zone_df$N15_C_YieldCurr + (
      zone_df$N15_C_FrtInc - zone_df$N15_C_Yield - zone_df$N15_C_FruitLoss - zone_df$N15_WeedSeedFall
    )
    
    # N15_Stock1[Zone](t) = N15_Stock1[Zone](t - dt) + (N15_Add1[Zone] - N15_Cupt1[Zone] - N15_T1Upt1[Zone] - N15_T2Upt1[Zone] - N15_T3Upt1[Zone]) * dt
    # N15_Stock2[Zone](t) = N15_Stock2[Zone](t - dt) + (N15_Add2[Zone] - N15_Cupt2[Zone] - N15_T1Upt2[Zone] - N15_T2Upt2[Zone] - N15_T3Upt2[Zone]) * dt
    # N15_Stock3[Zone](t) = N15_Stock3[Zone](t - dt) + (N15_Add3[Zone] - N15_Cupt3[Zone] - N15_T1Upt3[Zone] - N15_T2Upt3[Zone] - N15_T3Upt3[Zone]) * dt
    # N15_Stock4[Zone](t) = N15_Stock4[Zone](t - dt) + (N15_Add4[Zone] - N15_Cupt4[Zone] - N15_T1Upt4[Zone] - N15_T2Upt4[Zone] - N15_T3Upt4[Zone]) * dt
    zonelayer_df$N15_Upt_sum <- aggregate(zonelayertree_df["N15_Upt"], zonelayertree_df[c("zone", "layer")], sum)$N15_Upt
    zonelayer_df$N15_Stock <- zonelayer_df$N15_Stock + (zonelayer_df$N15_Add - zonelayer_df$N15_Cupt - zonelayer_df$N15_Upt_sum)
    
    # N15_T_Can[Tree](t) = N15_T_Can[Tree](t - dt) + (N15_T_CanIncr[Tree] - N15_T_WdInc[Tree] - N15_T_CanExp[Tree]) * dt
    tree_df$N15_T_Can <- tree_df$N15_T_Can + (tree_df$N15_T_CanIncr - tree_df$N15_T_WdInc - tree_df$N15_T_CanExp)
    
    # N15_T_Fruit[Tree](t) = N15_T_Fruit[Tree](t - dt) + (N15_T_FruitIncr[Tree] - N15_T_FrtExp[Tree]) * dt
    tree_df$N15_T_Fruit <- tree_df$N15_T_Fruit + (tree_df$N15_T_FruitIncr - tree_df$N15_T_FrtExp)
    
    # N15_T_GroRes[Tree](t) = N15_T_GroRes[Tree](t - dt) + (N15_T_UptTot[Tree] - N15_T_RtInc[Tree] - N15_T_FruitIncr[Tree] - N15_T_CanIncr[Tree] - N15_T_GroResLoss[Tree]) * dt
    tree_df$N15_T_GroRes <- tree_df$N15_T_GroRes + (
      tree_df$N15_T_UptTot - tree_df$N15_T_RtInc - tree_df$N15_T_FruitIncr - tree_df$N15_T_CanIncr - tree_df$N15_T_GroResLoss
    )
    
    # N15_T_Rt[Tree](t) = N15_T_Rt[Tree](t - dt) + (N15_T_RtInc[Tree] - N15_T_RtDec[Tree]) * dt
    tree_df$N15_T_Rt <- tree_df$N15_T_Rt + (tree_df$N15_T_RtInc - tree_df$N15_T_RtDec)
    
    # N15_T_Wd[Tree](t) = N15_T_Wd[Tree](t - dt) + (N15_T_WdInc[Tree] - N15_T_WdExp[Tree]) * dt
    tree_df$N15_T_Wd <- tree_df$N15_T_Wd + (tree_df$N15_T_WdInc - tree_df$N15_T_WdExp)
    
    # P_CCostsTot[PriceType](t) = P_CCostsTot[PriceType](t - dt) + (P_CCostsInc[PriceType]) * dt
    price_df$P_CCostsTot <- price_df$P_CCostsTot + (price_df$P_CCostsInc)
    
    # P_CReturnTot[PriceType](t) = P_CReturnTot[PriceType](t - dt) + (P_CReturnInc[PriceType]) * dt
    price_df$P_CReturnTot <- price_df$P_CReturnTot + (price_df$P_CReturnInc)
    
    # P_CropHarvMarker(t) = P_CropHarvMarker(t - dt) + (P_CropHarvest - P_2DayAfterCropharv) * dt
    # INIT P_CropHarvMarker = 0
    # TRANSIT TIME = 2
    # INFLOW LIMIT = INF
    # CAPACITY = INF
    # INFLOWS:
    #   P_CropHarvest = if ARRAYSUM(CA_CropSequen[*]) >= 1 and ARRAYSUM(CQ_CropWeedSwitch[*]) <> 4*CQ_WeedType then 1 else 0
    # OUTFLOWS:
    # P_2DayAfterCropharv = CONVEYOR OUTFLOW
    P_CropHarvMarker <- P_CropHarvMarker + (P_CropHarvest - P_2DayAfterCropharv)
    P_2DayAfterCropharv <- delay(P_CropHarvMarker, 2, 0)
    
    # P_CumLabUse(t) = P_CumLabUse(t - dt) + (P_DayLabUse) * dt
    P_CumLabUse <- P_CumLabUse + (P_DayLabUse)
    
    # P_CurrentCropCB(t) = P_CurrentCropCB(t - dt) + (P_CurrCropBenefitFlow - P_ProfitRecCrop) * dt
    P_CurrentCropCB <- P_CurrentCropCB + (P_CurrCropBenefitFlow - P_ProfitRecCrop)
    
    # P_FlagPrevCropOK?(t) = P_FlagPrevCropOK?(t - dt) + (P_FlagCSet) * dt
    P_FlagPrevCropOK_is <- P_FlagPrevCropOK_is + (P_FlagCSet)
    
    # P_GeneralCosts[PriceType](t) = P_GeneralCosts[PriceType](t - dt) + (P_GenCostsInc[PriceType]) * dt
    price_df$P_GeneralCosts <- price_df$P_GeneralCosts + (price_df$P_GenCostsInc)
    
    # P_NPV[PriceType](t) = P_NPV[PriceType](t - dt) + (- P_Costs&Benefits[PriceType]) * dt
    price_df$P_NPV <- price_df$P_NPV + (-price_df$P_CostsBenefits)
    
    # P_TCostsTot[PriceType](t) = P_TCostsTot[PriceType](t - dt) + (P_TCostsInc[PriceType]) * dt
    price_df$P_TCostsTot <- price_df$P_TCostsTot + (price_df$P_TCostsInc)
    
    # P_TPrunNo[PlantComp,Tree](t) = P_TPrunNo[PlantComp,Tree](t - dt) + (P_TPrunNoInc[PlantComp,Tree]) * dt
    treepcomp_df$P_TPrunNo <- treepcomp_df$P_TPrunNo + (treepcomp_df$P_TPrunNoInc)
    
    # P_TReturnTot[PriceType](t) = P_TReturnTot[PriceType](t - dt) + (P_TReturnInc[PriceType]) * dt
    price_df$P_TReturnTot <- price_df$P_TReturnTot + (price_df$P_TReturnInc)
    
    # PD_FencePast(t) = PD_FencePast(t - dt) + (PD_FenceBuildEvent) * dt
    PD_FencePast <- PD_FencePast + (PD_FenceBuildEvent)
    
    # PD_FenceQ(t) = PD_FenceQ(t - dt) + (PD_FenceBuilding - PD_FenceDecay) * dt
    PD_FenceQ <- PD_FenceQ + (PD_FenceBuilding - PD_FenceDecay)
    
    # PD_NastiesinPlot[Animals](t) = PD_NastiesinPlot[Animals](t - dt) + (PD_ChangeAnPop[Animals]) * dt
    animal_df$PD_NastiesinPlot <- animal_df$PD_NastiesinPlot + (animal_df$PD_ChangeAnPop)
    
    # RAIN_AnaerInd[Zone](t) = RAIN_AnaerInd[Zone](t - dt) + (RAIN_AnaerIndCh[Zone]) * dt
    zone_df$RAIN_AnaerInd <- zone_df$RAIN_AnaerInd + (zone_df$RAIN_AnaerIndCh)
    
    # RAIN_CanopyWater[Zone](t) = RAIN_CanopyWater[Zone](t - dt) + (RAIN_Interception[Zone] - RAIN_InterceptEvap[Zone]) * dt
    zone_df$RAIN_CanopyWater <- zone_df$RAIN_CanopyWater + (zone_df$RAIN_Interception - zone_df$RAIN_InterceptEvap)
    
    # RAIN_Cum(t) = RAIN_Cum(t - dt) + (Rain) * dt
    RAIN_Cum <- RAIN_Cum + (Rain)
    
    # RAIN_IntercEvapCum(t) = RAIN_IntercEvapCum(t - dt) + (RAIN_InterceptEvapAvg) * dt
    RAIN_IntercEvapCum <- RAIN_IntercEvapCum + (RAIN_InterceptEvapAvg)
    
    # RAIN_Yesterday?(t) = RAIN_Yesterday?(t - dt) + (RAIN_YesterdayF) * dt
    # RAIN_Yesterday_is <- RAIN_Yesterday_is + (RAIN_YesterdayF)
    
    # RT_CDecDepthAct[Zone](t) = RT_CDecDepthAct[Zone](t - dt) + (RT_CDecDepthInc[Zone] + RT_CDecDepth_ActInitSeason[Zone]) * dt
    zone_df$RT_CDecDepthAct <- zone_df$RT_CDecDepthAct + (zone_df$RT_CDecDepthInc + zone_df$RT_CDecDepth_ActInitSeason)
    
    # S&B_AerosolProd[Zone](t) = S&B_AerosolProd[Zone](t - dt) + (S&B_HazeFromWood[Zone,PlantComp] + S&B_HazeFromSlash[Zone,PlantComp]) * dt
    zone_df$SB_AerosolProd <- zone_df$SB_AerosolProd + aggregate(
      zonepcomp_df$SB_HazeFromWood + zonepcomp_df$SB_HazeFromSlash,
      zonepcomp_df["zone"],
      sum
    )$x
    
    # S&B_DeadWood[Zone,PlantComp](t) = S&B_DeadWood[Zone,PlantComp](t - dt) + (S&B_DeadWoodIncr[Zone,PlantComp] - S&B_DeadWoodLitTransfer[Zone,PlantComp] - S&B_BurntWood[Zone,PlantComp] - S&B_WoodFNutVolat[Zone,PlantComp] - S&B_WoodFNutMin[Zone,PlantComp] - S&B_ScorchedWoodRem[Zone,PlantComp] - S&B_WPileUp[Zone,PlantComp] - S&B_HazeFromWood[Zone,PlantComp]) * dt
    zonepcomp_df$SB_DeadWood <- zonepcomp_df$SB_DeadWood + (
      zonepcomp_df$SB_DeadWoodIncr - zonepcomp_df$SB_DeadWoodLitTransfer - zonepcomp_df$SB_BurntWood - zonepcomp_df$SB_WoodFNutVolat - zonepcomp_df$SB_WoodFNutMin - zonepcomp_df$SB_ScorchedWoodRem - zonepcomp_df$SB_WPileUp - zonepcomp_df$SB_HazeFromWood
    )
    
    # S&B_DWlossfromBurn[Zone](t) = S&B_DWlossfromBurn[Zone](t - dt) + (S&B_NecromassBurn[Zone,PlantComp] + S&B_BurntWood[Zone,PlantComp]) * dt
    zone_df$SB_DWlossfromBurn <- zone_df$SB_DWlossfromBurn + aggregate(zonepcomp_df$SB_NecromassBurn + zonepcomp_df$SB_BurntWood,
                                                                       zonepcomp_df["zone"],
                                                                       sum)$x
    
    # S&B_Nutvolatilized[Zone,PlantComp](t) = S&B_Nutvolatilized[Zone,PlantComp](t - dt) + (S&B_NecroFNutVolat[Zone,PlantComp] + S&B_WoodFNutVolat[Zone,PlantComp]) * dt
    zonepcomp_df$SB_Nutvolatilized <- zonepcomp_df$SB_Nutvolatilized + (zonepcomp_df$SB_NecroFNutVolat + zonepcomp_df$SB_WoodFNutVolat)
    
    # S&B_PastSlashEvents[Tree](t) = S&B_PastSlashEvents[Tree](t - dt) + (S&B_SlashSequence[Tree]) * dt
    tree_df$SB_PastSlashEvents <- tree_df$SB_PastSlashEvents + tree_df$SB_SlashSequence
    
    # S&B_PsorpModifier[Zone](t) = S&B_PsorpModifier[Zone](t - dt) + (S&B_PSorpCh[Zone]) * dt
    zone_df$SB_PsorpModifier <- zone_df$SB_PsorpModifier + zone_df$SB_PSorpCh
    
    # S&B_ScorchWoodRemoved[Zone,PlantComp](t) = S&B_ScorchWoodRemoved[Zone,PlantComp](t - dt) + (S&B_ScorchedWoodRem[Zone,PlantComp]) * dt
    zonepcomp_df$SB_ScorchWoodRemoved <- zonepcomp_df$SB_ScorchWoodRemoved + zonepcomp_df$SB_ScorchedWoodRem
    
    # S&B_WatRetentionMod[Zone](t) = S&B_WatRetentionMod[Zone](t - dt) + (S&B_FCch[Zone]) * dt
    zone_df$SB_WatRetentionMod <- zone_df$SB_WatRetentionMod + zone_df$SB_FCch
    
    # S_BDActOverBDRefKsatV1[Zone](t) = S_BDActOverBDRefKsatV1[Zone](t - dt) + (S_BDModifierKsatV1[Zone]) * dt
    # S_BDActOverBDRefKsatV2[Zone](t) = S_BDActOverBDRefKsatV2[Zone](t - dt) + (S_BDModifierKsatV2[Zone]) * dt
    # S_BDActOverBDRefKsatV3[Zone](t) = S_BDActOverBDRefKsatV3[Zone](t - dt) + (S_BDModifierKsatV3[Zone]) * dt
    # S_BDActOverBDRefKsatV4[Zone](t) = S_BDActOverBDRefKsatV4[Zone](t - dt) + (S_BDModifierKsatV4[Zone]) * dt
    zonelayer_df$S_BDActOverBDRefKsatV <- zonelayer_df$S_BDActOverBDRefKsatV + (zonelayer_df$S_BDModifierKsatV)
    
    # T_CumLim[Tree,Limiting_Factors](t) = T_CumLim[Tree,Limiting_Factors](t - dt) + (T_CurLimFac[Tree,Limiting_Factors]) * dt
    treelimit_df$T_CumLim <- treelimit_df$T_CumLim + (treelimit_df$T_CurLimFac)
    
    # T_CumWatStress[Tree](t) = T_CumWatStress[Tree](t - dt) + (T_DelWatStress[Tree]) * dt
    tree_df$T_CumWatStress <- tree_df$T_CumWatStress + (tree_df$T_DelWatStress)
    
    # T_GrowDays[Tree](t) = T_GrowDays[Tree](t - dt) + (T_GrowDayAc[Tree]) * dt
    tree_df$T_GrowDays <- tree_df$T_GrowDays + (tree_df$T_GrowDayAc)
    
    # T_HydEqFluxes[Tree](t) = T_HydEqFluxes[Tree](t - dt) + (TW_HydFluxPosTot[Tree]) * dt
    tree_df$T_HydEqFluxes <- tree_df$T_HydEqFluxes + (tree_df$TW_HydFluxPosTot)
    
    # T_PanelAlreadyInitiated?[Tree](t) = T_PanelAlreadyInitiated?[Tree](t - dt) + (T_SetPanelInitiateFlag[Tree]) * dt
    tree_df$T_PanelAlreadyInitiated_is <- tree_df$T_PanelAlreadyInitiated_is + (tree_df$T_SetPanelInitiateFlag)
    
    # T_PanelAvailable[Tree](t) = T_PanelAvailable[Tree](t - dt) + (T_InitiatePanel[Tree] - T_SecTPanelInc[Tree]) * dt
    tree_df$T_PanelAvailable <- tree_df$T_PanelAvailable + (tree_df$T_InitiatePanel - tree_df$T_SecTPanelInc)
    
    # T_PrunHarvCum[PlantComp,Tree](t) = T_PrunHarvCum[PlantComp,Tree](t - dt) + (T_PrunHarvInc[PlantComp,Tree]) * dt
    treepcomp_df$T_PrunHarvCum <- treepcomp_df$T_PrunHarvCum + (treepcomp_df$T_PrunHarvInc)
    
    # T_PrunLapse[Tree](t) = T_PrunLapse[Tree](t - dt) + (- T_PrunLapseInc[Tree]) * dt
    tree_df$T_PrunLapse <- tree_df$T_PrunLapse + (-tree_df$T_PrunLapseInc)
    
    # T_RespCum[PlantComp,Tree](t) = T_RespCum[PlantComp,Tree](t - dt) + (T_Respiration[PlantComp,Tree]) * dt
    treepcomp_df$T_RespCum <- treepcomp_df$T_RespCum + (treepcomp_df$T_Respiration)
    
    # T_RootDecCum[PlantComp](t) = T_RootDecCum[PlantComp](t - dt) + (T_RootDecAcc[PlantComp]) * dt
    pcomp_df$T_RootDecCum <- pcomp_df$T_RootDecCum + (pcomp_df$T_RootDecAcc)
    
    # T_SecTimePanelAvailable[Tree](t) = T_SecTimePanelAvailable[Tree](t - dt) + (T_SecTPanelInc[Tree] - T_SecTPanelDec[Tree]) * dt
    # INIT T_SecTimePanelAvailable[Tree] = 0
    # INFLOWS:
    #   T_SecTPanelInc[Tree] = T_TappingDay?[Tree]*T_TappingSlice*T_GirthMinforTappingcm*T_TapGirthFraction
    # OUTFLOWS:
    #   T_SecTPanelDec[Tree] = CONVEYOR OUTFLOW
    # TRANSIT TIME = T_PanelRecoveryTime*T_TappingDay?[Tree]
    tree_df$recover_time <- T_PanelRecoveryTime * tree_df$T_TappingDay_is
    tree_df$T_SecTPanelDec <- NA
    tree_df$T_SecTPanelDec[1] <- delay(tree_df$T_SecTimePanelAvailable[1],
                                       tree_df$recover_time[1],
                                       0)
    tree_df$T_SecTPanelDec[2] <- delay(tree_df$T_SecTimePanelAvailable[2],
                                       tree_df$recover_time[2],
                                       0)
    tree_df$T_SecTPanelDec[3] <- delay(tree_df$T_SecTimePanelAvailable[3],
                                       tree_df$recover_time[3],
                                       0)
    tree_df$T_SecTimePanelAvailable <- tree_df$T_SecTimePanelAvailable + (tree_df$T_SecTPanelInc - tree_df$T_SecTPanelDec)
    
    # T_StemBefPruning[Tree](t) = T_StemBefPruning[Tree](t - dt) + (T_StemBefPruningInc[Tree]) * dt
    tree_df$T_StemBefPruning <- tree_df$T_StemBefPruning + (tree_df$T_StemBefPruningInc)
    
    # T_TapDaysCum[Tree](t) = T_TapDaysCum[Tree](t - dt) + (T_TapDaysInc[Tree]) * dt
    tree_df$T_TapDaysCum <- tree_df$T_TapDaysCum + (tree_df$T_TapDaysInc)
    
    # T_TappedLatex[PlantComp,Tree](t) = T_TappedLatex[PlantComp,Tree](t - dt) + (T_Tapping[PlantComp,Tree]) * dt
    treepcomp_df$T_TappedLatex <- treepcomp_df$T_TappedLatex + (treepcomp_df$T_Tapping)
    
    # T_TotTappingDays[Tree](t) = T_TotTappingDays[Tree](t - dt) + (T_Tapping?[Tree]) * dt
    tree_df$T_TotTappingDays <- tree_df$T_TotTappingDays + (tree_df$T_Tapping_is)
    
    # TF_BunchGender[Tree,Fruitbunch](t) = TF_BunchGender[Tree,Fruitbunch](t - dt) + (TF_GenderPassOn[Tree,Fruitbunch]) * dt
    treefruit_df$TF_BunchGender <- treefruit_df$TF_BunchGender + (treefruit_df$TF_GenderPassOn)
    
    # TF_BunchWeight_kgpbunch[Tree,Fruitbunch](t) = TF_BunchWeight_kgpbunch[Tree,Fruitbunch](t - dt) + (TF_WeightPassOn[Tree,Fruitbunch] + TF_BunchWeightIncrAct[Tree,Fruitbunch] - TF_BunchWeightHarvest[Tree,Fruitbunch] - TF_FruitLitterfall[Tree,Fruitbunch]) * dt
    treefruit_df$TF_BunchWeight_kgpbunch <- treefruit_df$TF_BunchWeight_kgpbunch + (
      treefruit_df$TF_WeightPassOn +
        treefruit_df$TF_BunchWeightIncrAct -
        treefruit_df$TF_BunchWeightHarvest -
        treefruit_df$TF_FruitLitterfall
    )
    
    # TF_CumBunchNo[Tree](t) = TF_CumBunchNo[Tree](t - dt) + (TF_BunchNo[Tree]) * dt
    tree_df$TF_CumBunchNo <- tree_df$TF_CumBunchNo + (tree_df$TF_BunchNo)
    
    # TF_CumBunchWeightHarvest[Tree](t) = TF_CumBunchWeightHarvest[Tree](t - dt) + (TF_BunchWeightHarvest[Tree,Fruitbunch]) * dt
    tree_df$TF_CumBunchWeightHarvest <- tree_df$TF_CumBunchWeightHarvest + aggregate(treefruit_df$TF_BunchWeightHarvest, treefruit_df["tree_id"], sum)$x
    
    # TF_CumFruitsHarvNo[Tree](t) = TF_CumFruitsHarvNo[Tree](t - dt) + (TF_FruitHarvNoperBunch[Tree,Fruitbunch]) * dt
    tree_df$TF_CumFruitsHarvNo <- tree_df$TF_CumFruitsHarvNo + aggregate(treefruit_df$TF_FruitHarvNoperBunch, treefruit_df["tree_id"], sum)$x
    
    # TF_CumOilHarvest[Tree](t) = TF_CumOilHarvest[Tree](t - dt) + (TF_OilHarvest[Tree]) * dt
    tree_df$TF_CumOilHarvest <- tree_df$TF_CumOilHarvest + (tree_df$TF_OilHarvest)
    
    # TF_CumOilProd[Tree](t) = TF_CumOilProd[Tree](t - dt) + (TF_OilProd[Tree]) * dt
    tree_df$TF_CumOilProd <- tree_df$TF_CumOilProd + (tree_df$TF_OilProd)
    
    # TF_DelayedFrond_BiomassTarget[Tree](t) = TF_DelayedFrond_BiomassTarget[Tree](t - dt) + (TF_OldFrondChange1[Tree] - TF_OldFrondBiom[Tree]) * dt
    # INIT TF_DelayedFrond_BiomassTarget[Tree] = 0
    # INFLOWS:
    #   TF_OldFrondChange1[Tree] = if TF_AgeofPalm[Tree]>0 then T_CanBiomInc[DW,Tree] else 0
    # OUTFLOWS:
    #   TF_OldFrondBiom[Tree] = CONVEYOR OUTFLOW
    # TRANSIT TIME = TF_Full_canopy_no_of_leaves[Tree]*TF_PhyllochronTime[Tree]
    tree_df$TF_OldFrondChange1 <- ifelse(tree_df$TF_AgeofPalm > 0, treepcomp_df[treepcomp_df$PlantComp == "DW", ]$T_CanBiomInc, 0)
    transit_time <- tree_df$TF_Full_canopy_no_of_leaves * tree_df$TF_PhyllochronTime
    if(any(is.na(transit_time))) {
      print(paste("time:",time))
      print(tree_df[c("TF_Full_canopy_no_of_leaves", "TF_PhyllochronTime")])
    }
    tree_df$TF_OldFrondBiom <- NA
    tree_df$TF_OldFrondBiom[1] <- delay(tree_df$TF_DelayedFrond_BiomassTarget[1], transit_time[1], 0)
    tree_df$TF_OldFrondBiom[2] <- delay(tree_df$TF_DelayedFrond_BiomassTarget[2], transit_time[2], 0)
    tree_df$TF_OldFrondBiom[3] <- delay(tree_df$TF_DelayedFrond_BiomassTarget[3], transit_time[3], 0)
    tree_df$TF_DelayedFrond_BiomassTarget <- tree_df$TF_DelayedFrond_BiomassTarget + (tree_df$TF_OldFrondChange1 - tree_df$TF_OldFrondBiom)
    
    # TF_DW_Sufficiency_Yesterday[Tree](t) = TF_DW_Sufficiency_Yesterday[Tree](t - dt) + (TF_DMStressChange[Tree]) * dt
    tree_df$TF_DW_Sufficiency_Yesterday <- tree_df$TF_DW_Sufficiency_Yesterday + (tree_df$TF_DMStressChange)
    
    # TF_LeaffallCumNo[Tree](t) = TF_LeaffallCumNo[Tree](t - dt) + (TF_NewLeaffall?[Tree]) * dt
    tree_df$TF_LeaffallCumNo <- tree_df$TF_LeaffallCumNo + (tree_df$TF_NewLeaffall_is)
    
    # TF_LeavesTargetCum[Tree](t) = TF_LeavesTargetCum[Tree](t - dt) + (TF_LeavesTargetF[Tree]) * dt
    tree_df$TF_LeavesTargetCum <- tree_df$TF_LeavesTargetCum + (tree_df$TF_LeavesTargetF)
    
    # TF_NextGender[Tree](t) = TF_NextGender[Tree](t - dt) + (TF_SexDetermination[Tree]) * dt
    tree_df$TF_NextGender <- tree_df$TF_NextGender + (tree_df$TF_SexDetermination)
    
    # TF_OldFrontBiomass[Tree](t) = TF_OldFrontBiomass[Tree](t - dt) + (TF_OldFrondBiom[Tree] - TF_OldFrondChange2[Tree] - TF_Herbivory[Tree]) * dt
    tree_df$TF_OldFrontBiomass <- tree_df$TF_OldFrontBiomass + (tree_df$TF_OldFrondBiom - tree_df$TF_OldFrondChange2 - tree_df$TF_Herbivory)
    
    # TF_PalmTrunkHeight[Tree](t) = TF_PalmTrunkHeight[Tree](t - dt) + (TF_TrunkHIncr[Tree]) * dt
    tree_df$TF_PalmTrunkHeight <- tree_df$TF_PalmTrunkHeight + (tree_df$TF_TrunkHIncr)
    
    # TF_RecentTWPosgro[Tree](t) = TF_RecentTWPosgro[Tree](t - dt) + (TF_StressRec[Tree]) * dt
    tree_df$TF_RecentTWPosgro <- tree_df$TF_RecentTWPosgro + (tree_df$TF_StressRec)
    
    # TF_TrunkTargetCum[Tree](t) = TF_TrunkTargetCum[Tree](t - dt) + (TF_TrunkTargetF[Tree]) * dt
    tree_df$TF_TrunkTargetCum <- tree_df$TF_TrunkTargetCum + (tree_df$TF_TrunkTargetF)
    
    # TF_YNewLeaf?[Tree](t) = TF_YNewLeaf?[Tree](t - dt) + (TF_YNewLeafF?[Tree]) * dt
    tree_df$TF_YNewLeaf_is <- tree_df$TF_YNewLeaf_is + (tree_df$TF_YNewLeafF_is)
    
    # TP_ParasiteBiomass[Tree,PlantComp](t) = TP_ParasiteBiomass[Tree,PlantComp](t - dt) + (TP_ParasiteGrowth[Tree,PlantComp] - TP_ParasiteRemoval[Tree,PlantComp]) * dt
    treepcomp_df$TP_ParasiteBiomass <- treepcomp_df$TP_ParasiteBiomass + (treepcomp_df$TP_ParasiteGrowth - treepcomp_df$TP_ParasiteRemoval)
    
    # TP_RelNutSupplyDelayed[Tree](t) = TP_RelNutSupplyDelayed[Tree](t - dt) + (TP_RelNutSupplChange[Tree]) * dt
    tree_df$TP_RelNutSupplyDelayed <- tree_df$TP_RelNutSupplyDelayed + (tree_df$TP_RelNutSupplChange)
    
    # TW_DemandPerRoot[Tree](t) = TW_DemandPerRoot[Tree](t - dt) + (TW_YDayUptChange[Tree]) * dt
    tree_df$TW_DemandPerRoot <- tree_df$TW_DemandPerRoot + (tree_df$TW_YDayUptChange)
    
    # W_DrainCumV[Zone](t) = W_DrainCumV[Zone](t - dt) + (W_V4DrainF[Zone]) * dt
    zone_df$W_DrainCumV <- zone_df$W_DrainCumV + (zone_df$W_V4DrainF)
    
    # W_UptCCum1[Zone](t) = W_UptCCum1[Zone](t - dt) + (W_CUpt1[Zone]) * dt
    # W_UptCCum2[Zone](t) = W_UptCCum2[Zone](t - dt) + (W_CUpt2[Zone]) * dt
    # W_UptCCum3[Zone](t) = W_UptCCum3[Zone](t - dt) + (W_CUpt3[Zone]) * dt
    # W_UptCCum4[Zone](t) = W_UptCCum4[Zone](t - dt) + (W_CUpt4[Zone]) * dt
    zonelayer_df$W_UptCCum <- zonelayer_df$W_UptCCum + (zonelayer_df$W_CUpt)
    
    # W_UptT1Cum1[Zone](t) = W_UptT1Cum1[Zone](t - dt) + (W_T1Upt1[Zone]) * dt
    # W_UptT1Cum2[Zone](t) = W_UptT1Cum2[Zone](t - dt) + (W_T1Upt2[Zone]) * dt
    # W_UptT1Cum3[Zone](t) = W_UptT1Cum3[Zone](t - dt) + (W_T1Upt3[Zone]) * dt
    # W_UptT1Cum4[Zone](t) = W_UptT1Cum4[Zone](t - dt) + (W_T1Upt4[Zone]) * dt
    # W_UptT2Cum1[Zone](t) = W_UptT2Cum1[Zone](t - dt) + (W_T2Upt1[Zone]) * dt
    # W_UptT2Cum2[Zone](t) = W_UptT2Cum2[Zone](t - dt) + (W_T2Upt2[Zone]) * dt
    # W_UptT2Cum3[Zone](t) = W_UptT2Cum3[Zone](t - dt) + (W_T2Upt3[Zone]) * dt
    # W_UptT2Cum4[Zone](t) = W_UptT2Cum4[Zone](t - dt) + (W_T2Upt4[Zone]) * dt
    # W_UptT3Cum1[Zone](t) = W_UptT3Cum1[Zone](t - dt) + (W_T3Upt1[Zone]) * dt
    # W_UptT3Cum2[Zone](t) = W_UptT3Cum2[Zone](t - dt) + (W_T3Upt2[Zone]) * dt
    # W_UptT3Cum3[Zone](t) = W_UptT3Cum3[Zone](t - dt) + (W_T3Upt3[Zone]) * dt
    # W_UptT3Cum4[Zone](t) = W_UptT3Cum4[Zone](t - dt) + (W_T3Upt4[Zone]) * dt
    zonelayertree_df$W_UptCum <- zonelayertree_df$W_UptCum + (zonelayertree_df$W_Upt)
    
    # N_Loss1iCum[Zone,SlNut](t) = N_Loss1iCum[Zone,SlNut](t - dt) + (N_LossAcc1[Zone,SlNut]) * dt
    # N_Loss2iCum[Zone,SlNut](t) = N_Loss2iCum[Zone,SlNut](t - dt) + (N_LossAcc2[Zone,SlNut]) * dt
    # N_Loss3iCum[Zone,SlNut](t) = N_Loss3iCum[Zone,SlNut](t - dt) + (N_LossAcc3[Zone,SlNut]) * dt
    # N_Loss4iCum[Zone,SlNut](t) = N_Loss4iCum[Zone,SlNut](t - dt) + (N_LossAcc4[Zone,SlNut]) * dt
    zonelayernut_df$N_LossiCum <- zonelayernut_df$N_LossiCum + (zonelayernut_df$N_LossAcc)
    
    
    
    
    
    
    
    ### STORE OUTPUT DATA #################
    arr_out <- unique(ov_df$arr)
    output <- lapply(arr_out, function(x) {
      v <- ov_df[ov_df$arr == x, "var"]
      out_df <- arr_init[[x]]
      out_df$time <- time
      if (x == "single_df") {
        val <- sapply(v, get, envir = sys.frame(sys.parent(0)))
        out_df <- cbind(out_df, t(val))
      } else {
        sim_df <- get(x)
        
        #TODO: check this before running the sim
        tryCatch({
          out_df <- cbind(out_df, sim_df[v])
        }, error = function(e) {
          print("ERROR:")
          print(x)
          s <- names(sim_df)
          print(v[!v %in% s])
        })
      }
      
      df <- output[[x]]
      if (is.null(df)) {
        df <- out_df
      } else {
        #TODO: put all on the list firs, then combine at once
        df <- rbindlist(list(df, out_df))
      }
      return(df)
    })
    names(output) <- arr_out

}
  return(output)
}
